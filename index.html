<script>
  const $ = (id) => document.getElementById(id);
  
  const PST_TZ = "America/Los_Angeles";
  const pad2 = (n) => String(n).padStart(2, "0");
  const TZ = "America/Los_Angeles";

  // --- CLOUD RUN BRIDGE START ---
  // This object "fakes" the Google Apps Script environment so your UI works in Cloud Run.
  
  // --- CLOUD RUN BRIDGE START ---
  // --- CLOUD RUN BRIDGE START ---
  const google = {
    script: {
      // We return a proxy to handle 'run' so we can create a fresh chain for every request
      run: {
        withSuccessHandler: function(success) {
          // Create a NEW object for this specific request chain
          const chain = {
            _success: success,
            _fail: null,
            
            withFailureHandler: function(failure) {
              this._fail = failure;
              return this;
            },

            // --- 1. AUTO-GEN ---
            checkAndAutoGenerate: function() {
               console.log("Bridge: Auto-gen check.");
               setTimeout(() => { if(this._success) this._success({ generated: false }); }, 10);
            },

            // --- 3. MASTER SCHEDULE ---
            uiGetBaseData: async function() {
                try {
                    const res = await fetch('./?action=base-schedule');
                    if(!res.ok) throw new Error("Failed to load master");
                    const json = await res.json();
                    if(this._success) this._success(json);
                } catch(err) { 
                    if(this._fail) this._fail(err); 
                }
            },

            // --- 4. CONFIGURATION ---
            uiGetConfig: function() {
               setTimeout(() => {
                 if(this._success) this._success({
                   isManager: true, role: 'MASTER', automationEnabled: true,
                   allManagers: [{name: "Admin", email: "admin@musely.com"}],
                   currentUser: "Admin", matchedPerson: "Admin"
                 });
               }, 50);
            },

            uiReplaceAssignment: async function(payload) {
  try {
    console.log("uiReplaceAssignment payload:", payload);

    if (!payload?.docId || !payload?.assignmentId || !payload?.newPerson) {
      throw new Error("Missing docId, assignmentId, or newPerson (client)");
    }

    const res = await fetch("./?action=assignment/replace", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let json = {};
    try { json = JSON.parse(text); } catch {}

    if (!res.ok) {
      throw new Error(json.error || json.message || text || `HTTP ${res.status}`);
    }

    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(String(e.message || e));
  }
},


            // --- 5. SYSTEM DATA (TEAMS & PEOPLE) ---
            uiGetManagerData: async function() {
               console.log("Bridge: Fetching People & Teams...");
               try {
                 const ts = Date.now();
                 // 1. Teams
                 const tReq = await fetch(`./?action=teams&_t=${ts}`);
                 const tRes = await tReq.json();
                 const teams = (tRes.teams || []).map(t => t.id);

                 // 2. People
                 const pReq = await fetch(`./?action=people&_t=${ts}`);
                 const pRes = await pReq.json();
                 const peopleList = (pRes.people || []).map(p => p.name || p.id);

                 console.log(`Bridge: Loaded ${peopleList.length} people.`);
                 if(this._success) this._success({ people: peopleList, teams: teams, timeOff: [] });
               } catch(e) {
                 console.error("Bridge Error (System Data):", e);
                 const fallback = ["Adam", "Baylie", "Brandi", "Elizabeth", "Gisenia", "Kelsey"];
                 if(this._success) this._success({ people: fallback, teams: [], timeOff: [] });
               }
            },

            // --- 6. ZENDESK ---
            uiGetZendeskMetricsSnapshot: function() {
               setTimeout(() => { if(this._success) this._success([]); }, 50);
            },

            // --- 8. OTHER WRITE OPERATIONS ---
            uiSetTimeOff: async function(docId, assignmentId, enforce) {
  try {
    const res = await fetch(`./?action=assignment/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        docId,
        assignmentId,
        patch: { notes: "[OFF]" },
        enforce: !!enforce
      })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || json.message || "Update failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},

uiRestoreAssignment: async function(docId, assignmentId) {
  try {
    const res = await fetch(`./?action=assignment/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        docId,
        assignmentId,
        patch: { notes: "" }
      })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || json.message || "Restore failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},

uiGetAuditLogs: async function() {
  try {
    const res = await fetch("./?action=audit/logs");
    const json = await res.json().catch(() => ([]));
    if (this._success) this._success(json);
  } catch (e) {
    if (this._success) this._success([]); // fail soft
  }
},

uiGetStaffingRules: async function() {
  try {
    const res = await fetch("./?action=staffing/rules");
    const json = await res.json().catch(() => ([]));
    if (this._success) this._success(json);
  } catch (e) {
    if (this._success) this._success([]);
  }
},

uiSaveStaffingRule: async function(rule) {
  try {
    const res = await fetch("./?action=staffing/rules", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(rule || {})
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || "Save failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},

uiDeleteStaffingRule: async function(idx) {
  try {
    const res = await fetch("./?action=staffing/rules/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ idx })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || "Delete failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},

runGenerate: async function() {
  try {
    const res = await fetch("./?action=generate", { method: "POST" });
    const json = await res.json().catch(() => ({}));
    if (this._success) this._success(json);
  } catch (e) { if (this._fail) this._fail(e.message || String(e)); }
},
runArchive: async function() {
  try {
    const res = await fetch("./?action=archive", { method: "POST" });
    const json = await res.json().catch(() => ({}));
    if (this._success) this._success(json);
  } catch (e) { if (this._fail) this._fail(e.message || String(e)); }
},
runBoth: async function() {
  try {
    const res = await fetch("./?action=sync", { method: "POST" });
    const json = await res.json().catch(() => ({}));
    if (this._success) this._success(json);
  } catch (e) { if (this._fail) this._fail(e.message || String(e)); }
},


uiRestoreAssignment: async function(id) {
                console.log("Bridge: Restore", id);
                if(this._success) this._success({ ok: true });
            },

            handleMasterScheduleEdit: async function(payload) {
                console.log("Bridge: Master Edit Request", payload);
                try {
                    const res = await fetch('./?action=update-master-schedule', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    if (!res.ok) throw new Error("Network request failed");
                    
                    const json = await res.json();
                    if (json.status === "error") throw new Error(json.message);
                    
                    if(this._success) this._success(json);
                } catch(err) {
                    console.error("Bridge Error:", err);
                    if(this._fail) this._fail(err.message);
                }
            }, // <--- COMMA HERE IS IMPORTANT

            // --- 10. ZENDESK PROFILE ---
            getZendeskProfile: async function(name) {
                console.log("Bridge: Fetching Zendesk Profile for", name);
                try {
                    const res = await fetch('./?action=agent-profile', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name: name })
                    });

                    if (!res.ok) throw new Error("Network request failed");
                    const json = await res.json();
                    
                    if(this._success) this._success(json);
                } catch(err) {
                    console.error("Profile Fetch Error:", err);
                    if(this._fail) this._fail(err.message);
                }
            }
          }; 

          return chain;
        }
      },
      
      // Group B: URL handling
      url: {
          getLocation: function(cb) { cb({ hash: window.location.hash || "" }); }
      }
    }
  };
  // --- CLOUD RUN BRIDGE END ---

  

  function fatal_(title, detail) {
    console.error("FATAL:", title, detail);
    if ($("skeletonView")) $("skeletonView").style.display = "none";
    if ($("loader")) $("loader").classList.add("hidden");
    const host = $("listView") || document.body;
    host.innerHTML = `<div style="padding:20px; color:red; font-weight:bold;">${title}<br><span style="font-weight:normal; font-size:12px; color:#333;">${detail}</span></div>`;
  }

  // --- 2. GLOBAL VARIABLES ---
  let _allData=[], _filteredData=[], _people=[], _teams=[], _roles=[], _timeOff=new Set();
  let _view="list", _mode="quick", _activeTeam="", _selectedPeople=new Set(), _teamSelected=new Set();
  let _editing=null, _dragPerson=null, _drawerOpen=false, _lastUndo=null, _notifQueue=[];
  let _zendeskMetricsList = [], _zendeskMetricsByName = new Map(), _zendeskSnapshotLoaded = false;
  let _selectedManagerEmail = "", _currentManagerName = "";
  let _isMasterMode = false;
  let _activeProfileRequest = "";
  let _activeMetricsRequest = "";
  
  // NEW: To track the logged in user's Real Name (not just email)
  let _myName = ""; 
  let _masterSelected=new Set(), _masterRawData=[]; // Moved here for safety
  let _lastSelectedPerson = null;

  // --- 3. HELPERS (FORMATTING) ---
  function formatCsatDisplay(val) {
    if (val === null || val === undefined || val === "" || val === "--") return "--";
    if (String(val).includes("%")) return val;
    const n = Number(val);
    if (isNaN(n)) return "--";
    if (n <= 1 && n !== 0) return Math.round(n * 100) + "%";
    return Math.round(n) + "%";
  }

  function getTeamClass(t) { 
    const l = (t || "").toLowerCase(); 
    if (l.includes("live")) return "t-livechat";
    if (l.includes("email")) return "t-emailfloater";
    if (l.includes("phone")) return "t-phonesupport";
    if (l.includes("dispute")) return "t-disputes";
    if (l.includes("md") || l.includes("medical")) return "t-mdsupport";
    if (l.includes("social")) return "t-socials";
    return "t-other"; 
  }

  function _formatTime(val) { 
    if(!val) return ""; 
    if (val instanceof Date) { return val.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); } 
    return val; 
  }

  // --- 4. LOAD SEQUENCE ---
  window.onload = function() {
    try { load(); } catch (e) { fatal_("Boot Crash", e.message); }
  };

  function load(force, targetEmail) {
    // 1. Gatekeeper: Stop if no identity is present yet
    if (!window._myName && !window._myEmail) {
      console.log("No identity found. Skipping data load until sign-in.");
      if ($("skeletonView")) $("skeletonView").style.display = "none";
      return; 
    }

    // 2. Show loading state
    if ($("skeletonView")) $("skeletonView").style.display = "flex";
    if ($("listView")) $("listView").style.display = "none";
    if ($("calViewWrapper")) $("calViewWrapper").style.display = "none";
    if (targetEmail) _selectedManagerEmail = targetEmail;

    const isManager = window._isManager;
    const myName = window._myName;

    // 3. UI Adjustments based on Role
    if (isManager) {
       if($("btnAdmin")) $("btnAdmin").style.display = "flex";
       if($("btnAgentToggle")) $("btnAgentToggle").style.display = "none";
       document.body.classList.remove("agent-mode");
    } else {
       if($("btnAdmin")) $("btnAdmin").style.display = "none";
       document.body.classList.add("agent-mode");
       if($("btnAgentToggle")) $("btnAgentToggle").style.display = "block";
       
       if (myName) {
          _selectedPeople.clear(); 
          _selectedPeople.add(myName);
       }
    }

    // 4. Trigger fetch
    loadSystemData();
    checkUrlNotifs();
  }

  // If value is a pure YYYY-MM-DD (date-only), do NOT convert timezones.
function dayKeyPST(value) {
  if (!value) return "";

  // 1) If backend already sends YYYY-MM-DD, keep it as-is
  if (typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
    return value;
  }

  // 2) If it's a Date (or parseable), decide if it‚Äôs "date-only" at UTC midnight
  const d = (value instanceof Date) ? value : new Date(value);
  if (isNaN(d)) return "";

  // If it looks like a date-only stored at 00:00:00Z, keep its UTC day
  if (d.getUTCHours() === 0 && d.getUTCMinutes() === 0 && d.getUTCSeconds() === 0) {
    return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth() + 1)}-${pad2(d.getUTCDate())}`;
  }

  // Otherwise it's a real timestamp -> format by PST
  return formatDatePST(d); // uses Intl + America/Los_Angeles
}

function displayDayLabel(dayKey) {
  if (!dayKey) return "";
  // Defensive: if it's already a label, just return it
  if (typeof dayKey !== "string" || !/^\d{4}-\d{2}-\d{2}$/.test(dayKey)) return String(dayKey);

  const [y, m, d] = dayKey.split("-").map(Number);
  const anchor = new Date(Date.UTC(y, m - 1, d, 12, 0, 0)); // noon UTC anchor

  return new Intl.DateTimeFormat("en-US", {
    timeZone: PST_TZ,
    weekday: "short",
    month: "short",
    day: "numeric",
  }).format(anchor); // -> "Tue, Dec 30"
}

function pstParts(d) {
  const dt = (d instanceof Date) ? d : new Date(d);
  if (isNaN(dt)) return null;

  const parts = new Intl.DateTimeFormat("en-CA", {
    timeZone: PST_TZ,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false,
  }).formatToParts(dt);

  const out = {};
  for (const p of parts) if (p.type !== "literal") out[p.type] = p.value;
  return out;
}

// YYYY-MM-DD in Pacific Time (best for keys/grouping)
function formatDatePST(d) {
  const p = pstParts(d);
  if (!p) return "";
  return `${p.year}-${p.month}-${p.day}`;
}

// HH:MM in Pacific Time (useful for display)
function formatTimePST(d) {
  const p = pstParts(d);
  if (!p) return "";
  return `${p.hour}:${p.minute}`;
}

// If anything calls these from inline handlers, ensure global:
window.formatDatePST = formatDatePST;
window.formatTimePST = formatTimePST;

  async function loadSystemData() {
    console.log("Fetching system data from Cloud Run...");

    try {
      // 1. Fetch Metrics & Metadata (Zendesk, People, Teams)
      const metaRes = await fetch('/getmetadata', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isManager: window._isManager, action: 'getMetadata' })
      });
      const meta = await metaRes.json();

      // Update local variables
      _people = (meta.people || []).map(p => p.name || p.id).filter(Boolean);
    _teams  = (meta.teams || []).map(t => t.id || t.name).filter(Boolean);
      _zendeskMetricsList = meta.zendeskMetrics || [];
      _zendeskMetricsByName = new Map();
      _zendeskMetricsList.forEach(r => { if(r && r.agentName) _zendeskMetricsByName.set(String(r.agentName), r); });
      
      _timeOff.clear(); 
      (meta.timeOff || []).forEach(t => _timeOff.add(`${t.person}|${t.dateISO}`));

      // Update UI elements
      renderTeamChips(); 
      fillSelect("tpPerson", _people); 
      fillSelect("mNewPerson", _people); 
      renderQuickRail(); 
      initFilters();

      // 2. Fetch the actual Shifts (Assignments)
      const payload = {
        daysForward: 14,
        targetEmail: _selectedManagerEmail,
        isManager: window._isManager, // Tells backend whether to filter or show all
        agentName: window._myName      // Used by backend for "Agent View" filtering
      };

      // Explicitly send the current date in the query string
      const today = pstISODate();
const shiftRes = await fetch(`/initdashboard?start=${today}`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ ...payload, action: "initdashboard" })
});
      
      const shifts = await shiftRes.json();
      if (shifts && shifts.schedule && shifts.schedule.results) {
          _allData = [];
          shifts.schedule.results.forEach(day => {
              if (day.assignments) {
                  day.assignments.forEach(a => {
  const docId = String(day.id || "");
  const teamName = (docId.includes("__") ? docId.split("__")[1] : "") || day.team || "General";

  // ‚úÖ normalize assignmentId from any possible backend key
  const assignmentId =
    a.assignmentId ?? a.id ?? a.assignment_id ?? a.assignmentID ?? "";

  const dayKey = dayKeyPST(day.date); // "YYYY-MM-DD"

  _allData.push({
    ...a,

    // ‚úÖ REQUIRED for replace endpoint
    docId,
    assignmentId,

    // ‚úÖ Dates
    date: day.date,
    dateISO: dayKey,       // <-- use the dayKey consistently
    dayKey,                // optional but nice to have
    dateLabel: dayKey,     // your grouping key

    // ‚úÖ Display/other
    team: teamName,
    startLabel: a.startLabel,
    endLabel: a.endLabel,
  });
});
              }
          });
      }

      // 3. Finalize View
      applyLocalFilters();
      if ($("skeletonView")) $("skeletonView").style.display = "none";
      if (_allData.length > 0) renderView();

    } catch (e) {
      console.error("System Data Load Failed:", e);
      fatal_("Data Load Failed", e);
    }
  }

  // --- 5. VIEW RENDERING ---
  function setView(v) {
    _view = v;
    $("btnList").className = v === "list" ? "segBtn active" : "segBtn";
    $("btnCal").className = v === "calendar" ? "segBtn active" : "segBtn";
    $("btnMetrics").className = v === "metrics" ? "segBtn active" : "segBtn";
    renderView();
  }

  

  async function handleSignIn(response) {
    const loginBox = document.getElementById("loginContainer");
    toast("Verifying identity...");

    try {
      const res = await fetch('/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ credential: response.credential })
      });
      
      // FIX: Check if the response is actually JSON before parsing
      const contentType = res.headers.get("content-type");
      if (!contentType || !contentType.includes("application/json")) {
          const text = await res.text();
          console.error("Server returned non-JSON:", text);
          throw new Error("Server error: Check Cloud Run Logs");
      }

      const config = await res.json();
      
      if (config.error) {
          toast(config.error);
          return;
      }

      window._currentUser = config.userEmail;
      window._myName = config.matchedPerson;
      window._isManager = config.isManager;

      if (loginBox) loginBox.style.display = "none";
      toast(`Welcome, ${window._myName}`);
      load(); 

    } catch (e) {
      console.error("Login process failed:", e);
      toast("Login failed. Check console for details.");
    }
  }

  function renderView() {
    if (_view === "list") renderListView();
    else if (_view === "calendar") renderCalView();
    else renderMetricsView();
  }

  function saveShift() {
    const person = document.getElementById("modalEmployee").value;
    const day = document.getElementById("modalDay").value;
    const newStart = document.getElementById("modalStart").value;
    const newEnd = document.getElementById("modalEnd").value;
    const newTeam = document.getElementById("modalTeam").value;
    const origStart = document.getElementById("modalOrigStart").value;
    const origEnd = document.getElementById("modalOrigEnd").value;
    const isAdding = origStart === "NEW";
    const actionType = isAdding ? "ADD" : "EDIT";

    if(!newStart || !newEnd) {
        alert("Please enter both start and end times.");
        return;
    }

    // --- 1. UPDATE LOCAL DATA (Immediate UI Refresh) ---
    const dayData = _masterRawData[day] || [];
    if (isAdding) {
        dayData.push({ person, start: newStart, end: newEnd, team: newTeam });
        _masterRawData[day] = dayData;
    } else {
        const shiftToUpdate = dayData.find(s => s.person === person && s.start === origStart && s.end === origEnd);
        if (shiftToUpdate) {
            shiftToUpdate.start = newStart;
            shiftToUpdate.end = newEnd;
            shiftToUpdate.team = newTeam;
        }
    }

    renderMasterView(_masterRawData);
    closeModal();
    toast(isAdding ? "Adding new shift..." : "Saving changes...");
    
    // VISUAL CUE: Tell user we are working on it
    toast("Saving changes...");

    // --- 2. SEND TO BACKEND ---
    const payload = {
        action: actionType,
        person: person,
        day: day,
        oldStart: isAdding ? "" : origStart, 
        oldEnd: isAdding ? "" : origEnd,
        newStart: newStart,
        newEnd: newEnd,
        newTeam: newTeam
    };

    google.script.run
        .withSuccessHandler(() => {
            console.log("Saved to database successfully");
            // VISUAL CUE: Confirm success
            toast("Success! Schedule updated.");
        })
        .withFailureHandler((err) => {
            console.error(err);
            alert("Error saving to database: " + err);
        })
        .handleMasterScheduleEdit(payload); 
}

function deleteShift() {
    const person = document.getElementById("modalEmployee").value;
    const day = document.getElementById("modalDay").value;
    const origStart = document.getElementById("modalOrigStart").value;
    const origEnd = document.getElementById("modalOrigEnd").value;
    
    if(!confirm("Are you sure you want to remove this shift?")) return;

    // --- 1. REMOVE FROM LOCAL DATA ---
    const dayData = _masterRawData[day];
    if (dayData) {
        // Filter out the shift we want to delete
        const index = dayData.findIndex(s => s.person === person && s.start === origStart && s.end === origEnd);
        if (index > -1) {
            dayData.splice(index, 1); // Remove it from the array
        }
    }

    renderMasterView(_masterRawData);
    closeModal();

    // --- 2. SEND TO BACKEND ---
    const payload = {
        action: "DELETE",
        person: person,
        day: day,
        oldStart: origStart,
        oldEnd: origEnd
    };

    google.script.run
        .withFailureHandler((err) => alert("Error deleting from database: " + err))
        .handleMasterScheduleEdit(payload);
}

function checkTimeMatch(targetTime, compareTime) {
  const normalize = (t) => {
    if (!t) return "";
    // Standard JS way to handle Date objects instead of Apps Script
    if (t instanceof Date) {
      return t.getHours().toString().padStart(2, '0') + ":" + 
             t.getMinutes().toString().padStart(2, '0');
    }
    return String(t).trim().substring(0, 5);
  };
  return normalize(targetTime) === normalize(compareTime);
}

  function renderListView() {
    $("listView").style.display = "flex"; $("calViewWrapper").style.display = "none"; $("metricsView").style.display = "none";
    const host = $("listView"); host.innerHTML = "";
    const groups = groupShifts(_filteredData);
    if (groups.size === 0) { host.innerHTML = `<div style="padding:40px; text-align:center; color:#94a3b8;">No shifts found.</div>`; return; }
    
    for (const [dateLabel, rows] of groups) {
  const group = mkDiv("listGroup");

  const pretty = displayDayLabel(dateLabel); // ‚úÖ use dateLabel (it‚Äôs your YYYY-MM-DD key)

  group.innerHTML = `
    <div class="listHead">
      <span>${pretty}</span>
      <span style="font-weight:400;color:#64748b;">${rows.length} shifts</span>
    </div>
  `;

  const rowDiv = mkDiv("listRow");
  rows.forEach(it => rowDiv.appendChild(renderShiftCard(it, "list")));
  group.appendChild(rowDiv);
  host.appendChild(group);
}
  }

  function toAmPm(timeString) {
    if (!timeString) return "";
    // Handle "07:00:00" or "07:00"
    const parts = timeString.split(":");
    let hours = parseInt(parts[0], 10);
    const minutes = parts[1];
    
    const suffix = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12; // Convert "0" or "12" to 12
    
    return `${hours}:${minutes} ${suffix}`;
}

  function renderCalView() {
    $("listView").style.display = "none"; $("calViewWrapper").style.display = "block"; $("metricsView").style.display = "none";
    const host = $("calView"); host.innerHTML = "";
    const groups = groupShifts(_filteredData);
    const todayISO = pstISODate();

    for (const [dateLabel, rows] of groups) {
       const isToday = dayKeyPST(rows[0]?.dateISO || rows[0]?.date) === todayISO;
       const col = mkDiv(isToday ? "dayCol today" : "dayCol");
       const pretty = displayDayLabel(dateLabel);
col.innerHTML = `<div class="dayHead"><span>${pretty}</span></div>`;
       const body = mkDiv("dayBody");
       
       const teamMap = new Map();
       rows.forEach(r => { const t = r.team || "Other"; if(!teamMap.has(t)) teamMap.set(t,[]); teamMap.get(t).push(r); });

       Array.from(teamMap.keys()).sort().forEach(tName => {
           const grp = mkDiv("tGroup");
           const head = mkDiv("tGroupHeader");
           head.innerHTML = `<span>${tName}</span> <span class="tCount">${teamMap.get(tName).length}</span>`;
           head.onclick = () => grp.classList.toggle("collapsed");
           const gBody = mkDiv("tGroupBody");
           teamMap.get(tName).sort((a,b) => a.startMinutes - b.startMinutes).forEach(it => gBody.appendChild(renderShiftCard(it, "cal")));
           grp.append(head, gBody);
           body.appendChild(grp);
       });
       col.appendChild(body);
       host.appendChild(col);
    }
  }

  function renderMetricsView() {
    $("listView").style.display = "none"; $("calViewWrapper").style.display = "none"; $("metricsView").style.display = "block";
    renderMetricsList();
  }

  function renderShiftCard(it, mode) {
    const card = mkDiv(`shift ${getTeamClass(it.team)}`);
    
    // Check selection
    if (_teamSelected.has(String(it.assignmentId))) card.classList.add("selected");
    
    // Check Time Off logic
    if (_timeOff.has(`${it.person}|${it.dateISO}`) || (it.notes && it.notes.includes("[OFF]"))) { 
        card.style.border = "2px solid #f87171"; 
        card.style.background = "#fef2f2"; 
        card.style.opacity = "0.9";
    }
    
    let metaIcon = "";
    if (it.notes && it.notes.length > 0) metaIcon = `<span style="font-size:10px; margin-left:6px; cursor:help;" title="Notes: ${it.notes}">üìù</span>`;

    card.innerHTML = `
        <div class="sRow" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
            <span class="sTime" style="font-weight:800; font-size:11px;">${it.startLabel}-${it.endLabel}</span>
            <span style="font-size:10px; background:rgba(0,0,0,0.05); padding:2px 4px; border-radius:4px; font-weight:700; color:#475569;">${it.team}</span>
            ${metaIcon}
        </div>
        <div class="sName" title="${it.person}" style="font-weight:600;">${it.person}</div>
    `;
    
    const sel = mkDiv("selBox"); sel.textContent = "‚úì"; card.appendChild(sel);
    if (mode === "list") card.style.width = "220px";
    
    // --- UPDATED CLICK LOGIC ---
    // Fix: We now check against the stored NAME (window._myName) if available, otherwise check email as fallback
    const isMe = (window._myName && it.person === window._myName) || (it.person === window._currentUser);
    
    if (window._isManager || isMe) {
       card.style.cursor = "pointer";
       
       card.onclick = (e) => { 
           // If Manager: Standard logic
           if (window._isManager) {
               if(_mode==="team" || _teamSelected.size > 0 || e.shiftKey) { 
                   toggleTeamSelect(it, card); 
               } else { 
                   openReplaceModal(it); 
               } 
           } 
           // If Agent: Open Agent Actions
           else if (isMe) {
               console.log("Clicked own shift:", it); // Debug Log
               openAgentActionModal(it);
           }
       };

       // Only Managers can drag/drop
       if (window._isManager) {
           card.draggable = true;
           card.ondragstart = (e) => { e.preventDefault(); }; 
           card.ondragover = (e) => { if(_mode==="quick") { e.preventDefault(); card.classList.add("dropTarget"); } };
           card.ondragleave = () => card.classList.remove("dropTarget");
           card.ondrop = (e) => { e.preventDefault(); card.classList.remove("dropTarget"); if(_dragPerson && _dragPerson !== it.person) { _editing = it; openReplaceModal(it); setTimeout(() => $("mNewPerson").value = _dragPerson, 50); } };
       }
    }
    return card;
  }

  // --- 6. AGENT ACTIONS (MOVED TO GLOBAL SCOPE) ---
  // These functions are now accessible by the HTML buttons

  function openAgentActionModal(it) {
    _editing = it; 
    
    const title = `${it.dateLabel} ‚Ä¢ ${it.startLabel} - ${it.endLabel}`;
    if($("agShiftDetails")) $("agShiftDetails").innerText = title;
    
    resetAgentModal();
    fillSelect("agSwapPerson", _people.filter(p => p !== window._myName), false);
    
    if($("agentOverlay")) $("agentOverlay").style.display = "flex";
    else console.error("ERROR: agentOverlay HTML is missing!");
  }

  function closeAgentModal() {
    if($("agentOverlay")) $("agentOverlay").style.display = "none";
  }

  function showAgentForm(type) {
    if($("agActionSelect")) $("agActionSelect").style.display = "none";
    if (type === 'timeoff') {
        if($("agFormTimeOff")) $("agFormTimeOff").style.display = "block";
        if($("agToReason")) {
            $("agToReason").value = "";
            $("agToReason").focus();
        }
    } else {
        if($("agFormSwap")) $("agFormSwap").style.display = "block";
        if($("agSwapNote")) $("agSwapNote").value = "";
    }
  }

  function resetAgentModal() {
    if($("agActionSelect")) $("agActionSelect").style.display = "block";
    if($("agFormTimeOff")) $("agFormTimeOff").style.display = "none";
    if($("agFormSwap")) $("agFormSwap").style.display = "none";
  }

  function submitTimeOff() {
    const reason = $("agToReason") ? $("agToReason").value : "";
    if (!reason) return toast("Please enter a reason");
    
    closeAgentModal();
    toast("Request Sent to Manager");
    // Connect to backend here if needed
  }

  function submitSwap() {
    const targetPerson = $("agSwapPerson") ? $("agSwapPerson").value : "";
    const note = $("agSwapNote") ? $("agSwapNote").value : "";
    if (!targetPerson) return toast("Select a co-worker");

    closeAgentModal();
    toast(`Swap request sent to ${targetPerson}`);
    // Connect to backend here if needed
  }


  // --- 7. INTERACTIONS (Manager) ---
  function openReplaceModal(it) {
      _editing = it;
      $("mSub").textContent = `${it.dateLabel} ‚Ä¢ ${it.startLabel} ‚Ä¢ ${it.person}`;
      $("mNotes").value = it.notes || "";
      
      // Check for current "OFF" status
      const isOff = it.notes && it.notes.includes("[OFF]");
      const btn = $("actionBtn");

      if (isOff) { 
          // VISUAL: Green "Restore" state
          btn.innerHTML = "‚ôªÔ∏è Restore Shift"; 
          btn.style.color = "#15803d"; 
          btn.style.borderColor = "#bbf7d0"; 
          btn.style.background = "#f0fdf4";
          // Change the function it calls
          btn.onclick = restoreShift; 
      } else { 
          // VISUAL: Red "Mark Off" state
          btn.innerHTML = "‚õî Mark Off"; 
          btn.style.color = "#ef4444"; 
          btn.style.borderColor = "#fecaca"; 
          btn.style.background = "#fef2f2";
          // Change the function it calls
          btn.onclick = markTimeOff; 
      }

      $("modalOverlay").style.display = "flex";
      fillSelect("mNewPerson", _people.filter(p => p !== it.person), false);
  }

  function saveReplace() {
  if (!_editing) return;

  const newP = document.getElementById("mNewPerson").value;
  if (!newP) return toast("Select person");

  const notes = document.getElementById("mNotes").value;
  const notifyMode = document.getElementById("mNotify").value;
  const originalPerson = _editing.person;
  const originalNotes = _editing.notes || "";

  // Find the real local record (sometimes _editing is a filtered copy)
  const local = _allData.find(x =>
    String(x.assignmentId) === String(_editing.assignmentId) &&
    String(x.docId) === String(_editing.docId)
  ) || _editing;

  // Close modal + optimistic UI update
  document.getElementById("modalOverlay").style.display = "none";
  toast("Updating...");

  local.person = newP;
  local.notes = notes;
  renderView();

  const payload = {
    docId: _editing.docId,
    assignmentId: _editing.assignmentId,
    newPerson: newP,
    notes: notes,
    notifyMode: notifyMode
  };

  google.script.run
    .withSuccessHandler(res => {
      // ‚úÖ only queue notifs if the server actually succeeded
      if (res?.notifyStatus === "Pending" || notifyMode === "defer") {
        playNotificationSound();
        _notifQueue.push({
          person: newP,
          message: `Change: ${newP} replaced ${originalPerson} (${local.dateLabel} ${local.startLabel})`,
          undoData: {
            docId: _editing.docId,
            assignmentId: _editing.assignmentId,
            newPerson: originalPerson,
            notes: originalNotes
          }
        });
        renderNotifList();
        toast("Added to Send Queue");
      } else {
        playSendSound();
        toast("Saved");
      }
    })
    .withFailureHandler(err => {
      // üî• rollback UI so you can trust what you see
      local.person = originalPerson;
      local.notes = originalNotes;
      renderView();
      toast(`Replace failed: ${err}`);
      console.error("Replace failed:", err, payload);
    })
    .uiReplaceAssignment(payload);
}


  function checkUrlNotifs() {
    google.script.url.getLocation(function(location) {
        const hash = location.hash;
        if (hash && hash.includes("notif=")) {
            const rawMsg = hash.split("notif=")[1];
            const msg = decodeURIComponent(rawMsg);
            Swal.fire({
                title: 'Schedule Update',
                html: msg,
                icon: 'info',
                confirmButtonText: 'Got it',
                confirmButtonColor: '#1e293b'
            });
            try { history.replaceState(null, null, ' '); } catch(e) {}
        }
    });
  }

  function handleSaveClick() {
     if(!_editing) return;
     const isOff = _editing.notes && _editing.notes.includes("[OFF]");
     if(isOff) restoreShift(); else markTimeOff();
  }

  function markTimeOff(force) {
  if(!_editing) return;

  const doIt = () => {
    // optimistic UI
    _timeOff.add(`${_editing.person}|${_editing.dateISO}`);
    _editing.notes = ((_editing.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim() + " [OFF]").trim();
    renderView();
    closeModal();
    toast("Marking person OFF...");

    google.script.run
      .withSuccessHandler(res => {
        // optional: staffing rule confirm
        if (res && res.requireConfirm && !force) {
          Swal.fire({
            title: "Staffing Alert",
            text: res.message,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Mark Off Anyway",
            confirmButtonColor: "#ef4444"
          }).then((r) => { if (r.isConfirmed) markTimeOff(true); });
          return;
        }
        toast("Success: Marked OFF");
      })
      .withFailureHandler(err => {
        toast(`Failed: ${err}`);
        console.error("uiSetTimeOff failed:", err);
        // rollback UI
        _timeOff.delete(`${_editing.person}|${_editing.dateISO}`);
        _editing.notes = (_editing.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim();
        renderView();
      })
      .uiSetTimeOff(_editing.docId, _editing.assignmentId, true); // 3rd arg can be "enforce" on backend
  };

  if (force) return doIt();

  Swal.fire({
    title: "Mark OFF?",
    text: `Are you sure you want to mark ${_editing.person} OFF for this shift?`,
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, Mark OFF",
    confirmButtonColor: "#ef4444",
    cancelButtonColor: "#cbd5e1"
  }).then((r) => { if (r.isConfirmed) doIt(); });
}

  function restoreShift() {
  if (!_editing) return;

  const doIt = () => {
    // optimistic UI
    _timeOff.delete(`${_editing.person}|${_editing.dateISO}`);
    _editing.notes = (_editing.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim();
    renderView();
    closeModal();
    toast("Restoring shift...");

    google.script.run
      .withSuccessHandler(() => toast("Success: Shift Restored"))
      .withFailureHandler((e) => {
        toast(`Restore failed: ${e}`);
        console.error("uiRestoreAssignment failed:", e);
      })
      .uiRestoreAssignment(_editing.docId, _editing.assignmentId);
  };

  Swal.fire({
    title: "Restore Shift?",
    text: `Remove the OFF status and restore ${_editing.person}'s shift?`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Yes, Restore",
    confirmButtonColor: "#15803d",
    cancelButtonColor: "#cbd5e1"
  }).then((r) => { if (r.isConfirmed) doIt(); });
}

  
  function runUndo() { if(_lastUndo) google.script.run.withSuccessHandler(()=>{ _lastUndo=null; loadSystemData(); }).uiReplaceAssignment({ assignmentId:_lastUndo.id, newPerson:_lastUndo.oldP, notes:_lastUndo.notes }); }
  function closeModal() {
    // Hide the Master Schedule Edit modal
    const editModal = document.getElementById("editShiftModal");
    if (editModal) editModal.style.display = "none";

    // Hide the Replace Coverage modal
    const replaceModal = document.getElementById("modalOverlay");
    if (replaceModal) replaceModal.style.display = "none";
    
    // Clear the editing reference
    _editing = null;
  }

  // --- 8. PROFILES & METRICS ---
  function openProfile(name) {
     _activeProfileRequest = name;
     $("profileOverlay").style.display = "flex"; $("profContent").style.display = "none"; $("profLoader").style.display = "block";
     $("pName").innerText = name; $("profLoader").innerText = "Loading...";
     const cached = _zendeskMetricsByName.get(String(name));
     if(cached) { renderProfileCached(cached); }
     google.script.run.withSuccessHandler(data => {
         if(data.name !== _activeProfileRequest) return;
         renderProfileData(data);
     }).getZendeskProfile(name);
  }

  function renderProfileData(data) {
     $("profLoader").style.display = "none";
     if(data.error) { $("profLoader").style.display = "block"; $("profLoader").innerText = data.error; return; }
     $("profContent").style.display = "block";
     
     $("pName").innerText = data.name; $("pEmail").innerText = data.email; $("pRole").innerText = data.role;
     $("pSolved").innerText = data.solvedWeek ?? "--"; 
     $("pCSAT").innerText = formatCsatDisplay(data.csatScore);
     
     const q = "type:ticket status<solved assignee:\"" + data.name + "\"";
     const url = "https://musely.zendesk.com/agent/search/1?query=" + encodeURIComponent(q);
     const el = $("pTickets"); el.innerHTML = "";
     const a = document.createElement("a"); a.href = url; a.target = "_blank"; a.innerText = (data.openTickets ?? "--") + " üîó";
     el.appendChild(a);
     
     $("pAvatar").src = data.avatar || "https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y";
     $("pLogin").innerText = data.lastLogin ? new Date(data.lastLogin).toLocaleDateString() : "Never";
  }

  function renderProfileCached(c) {
     $("profContent").style.display = "block";
     $("pName").innerText = c.agentName; $("pEmail").innerText = c.email; 
     $("pSolved").innerText = c.solvedWeek ?? "--"; 
     $("pCSAT").innerText = formatCsatDisplay(c.csatPct);
     
     $("pTickets").innerText = c.openTickets ?? "--";
     $("pLogin").innerText = "Cached";
     if(c.zendeskUserId) {
        const url = "https://musely.zendesk.com/agent/search/1?query=" + encodeURIComponent("assignee_id:"+c.zendeskUserId);
        const el = $("pTickets"); el.innerHTML = "";
        const a = document.createElement("a"); a.href = url; a.target = "_blank"; a.innerText = (c.openTickets ?? "--") + " üîó";
        el.appendChild(a);
     }
  }

  function renderMetricsList() {
     const host = $("metricsList"); host.innerHTML = "";
     const q = ($("metricsSearch").value || "").toLowerCase();
     _people.filter(p => !q || p.toLowerCase().includes(q)).forEach(p => {
         const row = mkDiv("metricsRow");
         row.innerHTML = `<div class="left"><div class="avatar">${p.substring(0,2)}</div><div class="name">${p}</div></div>`;
         row.onclick = () => openMetricsProfile(p);
         host.appendChild(row);
     });
  }

  function openMetricsProfile(name) {
    _activeMetricsRequest = name;
    
    const d = document.getElementById("metricsDrawer"); 
    d.classList.add("open");
    
    const loader = document.getElementById("mProfLoader");
    const content = document.getElementById("mProfContent");
    
    loader.style.display = "block";
    loader.innerHTML = `<div style="text-align:center; padding:20px;">
                          <div class="spinner-border" style="width:20px; height:20px; border:3px solid #cbd5e1; border-top:3px solid #3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px;"></div>
                          <div>Fetching data for <b>${name}</b>...</div>
                          <div style="font-size:10px; color:#94a3b8; margin-top:5px;">This may take a moment...</div>
                        </div>`;
    
    content.style.display = "none";

    google.script.run
        .withSuccessHandler(renderMetricsProfileData)
        .withFailureHandler(err => {
             loader.innerHTML = `<div style="color:red;">System Error: ${err.message}</div>`;
        })
        .getZendeskProfile(name);

    setTimeout(() => {
        if (loader.style.display !== "none" && !loader.innerHTML.includes("Error") && !loader.innerHTML.includes("System Error")) {
             loader.innerHTML = `<div style="color:#f59e0b; background:#fffbeb; padding:10px; border-radius:8px; border:1px solid #fcd34d;">
                                  <strong>Taking longer than usual...</strong><br>
                                  The server is still processing. Please wait or try again.<br>
                                  <button class="btn ghost" style="margin-top:8px; font-size:11px;" onclick="openMetricsProfile('${name}')">Retry</button>
                                </div>`;
        }
    }, 30000);
  }

  function renderMetricsProfileData(data) {
    const loader = document.getElementById("mProfLoader");
    const content = document.getElementById("mProfContent");

    if (!data || data.error) {
        const errorMsg = data ? data.error : "Unknown error from server";
        loader.style.display = "block";
        loader.innerHTML = `<div style="color:#ef4444; background:#fef2f2; padding:10px; border-radius:8px; border:1px solid #fecaca;">
                              <strong>Error:</strong> ${errorMsg}
                            </div>`;
        content.style.display = "none";
        return;
    }

    loader.style.display = "none";
    content.style.display = "block";

    if(document.getElementById("mName")) document.getElementById("mName").innerText = data.name || "--";
    if(document.getElementById("mEmail")) document.getElementById("mEmail").innerText = data.email || "--";
    if(document.getElementById("mRole")) document.getElementById("mRole").innerText = data.role || "--";
    
    if(document.getElementById("mSolved")) document.getElementById("mSolved").innerText = data.solvedWeek ?? "--";
    if(document.getElementById("mCSAT")) document.getElementById("mCSAT").innerText = formatCsatDisplay(data.csatScore);
    if(document.getElementById("mOpen")) document.getElementById("mOpen").innerText = data.openTickets ?? "--";
    
    if(document.getElementById("mAvatar")) {
        document.getElementById("mAvatar").src = data.avatar || "https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y";
    }

    if(document.getElementById("mLogin")) {
        if (data.lastLogin) {
            const dateObj = new Date(data.lastLogin);
            const nice = dateObj.toLocaleDateString('en-US', { month:'short', day:'numeric' }) + ", " + dateObj.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
            document.getElementById("mLogin").innerText = nice;
        } else {
            document.getElementById("mLogin").innerText = "Never";
        }
    }

    updateMetricLinks(data);
  }

  function updateMetricLinks(data) {
     let openQ = "", badCsatQ = "";

     if (data.zendeskUserId) {
         openQ = "type:ticket status<solved assignee_id:" + data.zendeskUserId;
         badCsatQ = "type:ticket satisfaction_rating:bad assignee_id:" + data.zendeskUserId;
     } else if (data.email) {
         openQ = "type:ticket status<solved assignee:" + data.email;
         badCsatQ = "type:ticket satisfaction_rating:bad assignee:" + data.email;
     } else {
         openQ = "type:ticket status<solved assignee:\"" + data.name + "\"";
         badCsatQ = "type:ticket satisfaction_rating:bad assignee:\"" + data.name + "\"";
     }

     const openUrl = "https://musely.zendesk.com/agent/search/1?query=" + encodeURIComponent(openQ);
     const badUrl  = "https://musely.zendesk.com/agent/search/1?query=" + encodeURIComponent(badCsatQ);

     const openA = document.getElementById("mOpenTicketsLink"); if (openA) openA.href = openUrl;
     const badA = document.getElementById("mBadCsatLink"); if (badA) badA.href = badUrl;
  }

  function closeMetricsDrawer() { $("metricsDrawer").classList.remove("open"); }
  function closeProfile() { $("profileOverlay").style.display = "none"; }

  // --- 9. AUDIT & MASTER MODES ---
  function openAuditLog() {
    $("auditOverlay").style.display = "flex";
    $("auditList").innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">Fetching logs from server...</td></tr>`;
    google.script.run.withSuccessHandler(renderAuditLog).uiGetAuditLogs();
  }

  function closeAuditModal() { $("auditOverlay").style.display = "none"; }

  function renderAuditLog(data) {
    const list = $("auditList");
    list.innerHTML = "";
    if (!data || data.length === 0) {
        list.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">No history found.</td></tr>`;
        return;
    }
    data.forEach(row => {
        const tr = document.createElement("tr");
        let badgeClass = "ab-blue";
        if(String(row.action).includes("OFF")) badgeClass = "ab-red";
        
        let niceTime = row.timestamp;
        try { niceTime = new Date(row.timestamp).toLocaleString(); } catch(e){}
        
        tr.innerHTML = `
            <td>${niceTime}</td>
            <td style="font-weight:600;">${row.manager}</td>
            <td><span class="audit-badge ${badgeClass}">${row.action}</span></td>
            <td>${row.target}<br><span style="font-size:9px;color:#94a3b8;">${row.date}</span></td>
            <td>${row.details}</td>
        `;
        list.appendChild(tr);
    });
  }

  function toggleMasterMode() {
    _isMasterMode = !_isMasterMode;
    const btn = document.getElementById("btnMasterMode");
    const title = document.querySelector(".hTitle"); 
    const contextPill = document.getElementById("managerContextPill");

    if (_isMasterMode) {
        if(btn) { btn.innerText = "Exit Template Editor"; btn.style.backgroundColor = "#7e22ce"; btn.style.color = "white"; }
        if(title) title.innerText = "MASTER TEMPLATE";
        if(contextPill) { contextPill.style.display="flex"; contextPill.innerText="EDITING GLOBAL RULES"; contextPill.style.backgroundColor="#ef4444"; contextPill.style.borderColor="#b91c1c"; }

        $("calViewWrapper").style.display = "none";
        $("listView").style.display = "flex"; 
        $("listView").innerHTML = "<div style='padding:20px; text-align:center;'><div class='spinner-border text-primary'></div><br>Loading Master Template...</div>";
        
        google.script.run
            .withSuccessHandler(renderMasterView)
            .withFailureHandler(err => {
                $("listView").innerHTML = `<div style="color:red;padding:20px;">Error loading template: ${err.message}</div>`;
            })
            .uiGetBaseData();
    } else {
        if(btn) { btn.innerText = "Edit Master Schedule"; btn.style.backgroundColor = ""; btn.style.color = ""; }
        if(title) title.innerText = "Scheduling Manager";
        if(contextPill) {
            if(_currentManagerName) { contextPill.innerText="Viewing: "+_currentManagerName; contextPill.style.backgroundColor="#7e22ce"; contextPill.style.borderColor="#6b21a8"; }
            else { contextPill.style.display="none"; }
        }
        loadSystemData(); 
    }
  }

  function pstISODate(d = new Date()) {
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: TZ,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(d);
}

  function formatDate(iso) {
  return dayKeyPST(iso);
}

  // --- 10. UTILS ---
  function mkDiv(cls) { const d = document.createElement("div"); d.className = cls; return d; }

function groupShifts(data) {
  const m = new Map();
  if (!data) return m;

  data.forEach(d => {
    // Use the fixed global formatDate
    const label = d.dateLabel || formatDate(d.date || d.dateISO);
    if (!m.has(label)) m.set(label, []);
    m.get(label).push(d);
  });
  return m;
}
  
  function fillSelect(id, list, bl=true) { const s=$(id); if(!s)return; s.innerHTML=""; if(bl)s.appendChild(new Option("- Select -","")); list.forEach(x=>s.appendChild(new Option(x,x))); }
  
  function toggleTeamSelect(it, cardElement) {
    const id = String(it.assignmentId);
    if (_teamSelected.has(id)) {
      _teamSelected.delete(id);
      if (cardElement) cardElement.classList.remove("selected");
    } else {
      _teamSelected.add(id);
      if (cardElement) cardElement.classList.add("selected");
      _lastSelectedPerson = it.person; 
    }
    updateSelectionBar();
  }

  function updateSelectionBar() {
    const bar = document.getElementById("selectionBar");
    const countSpan = document.getElementById("sbCount");
    const similarBtn = document.getElementById("btnSelectSimilar");
    
    const count = _teamSelected.size;
    countSpan.innerText = count;
    
    if (count > 0) {
      bar.classList.add("visible");
      if (_lastSelectedPerson) {
        similarBtn.style.display = "inline-block";
        similarBtn.innerText = `Select All "${_lastSelectedPerson}"`;
      } else {
        similarBtn.style.display = "none";
      }
    } else {
      bar.classList.remove("visible");
    }
    if(document.getElementById("tpCount")) document.getElementById("tpCount").innerText = count;
  }

  function selectSimilarVisible() {
    if (!_lastSelectedPerson) return;
    _filteredData.forEach(item => {
      if (item.person === _lastSelectedPerson) {
        _teamSelected.add(String(item.assignmentId));
      }
    });
    document.querySelectorAll('.shift').forEach(card => {
      const nameDiv = card.querySelector('.sName');
      if (nameDiv && nameDiv.innerText === _lastSelectedPerson) {
        card.classList.add('selected');
      }
    });
    updateSelectionBar();
    toast(`Selected all shifts for ${_lastSelectedPerson}`);
  }

  async function batchMarkOff() {
  const ids = Array.from(_teamSelected);
  if (ids.length === 0) return toast("No shifts selected.");

  const result = await Swal.fire({
    title: `Mark ${ids.length} shifts as OFF?`,
    text: "This will highlight them red.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, Mark OFF",
    confirmButtonColor: "#ef4444",
    cancelButtonColor: "#cbd5e1"
  });
  if (!result.isConfirmed) return;

  toast(`Processing ${ids.length} cancellations...`);

  for (const id of ids) {
    const item = _allData.find(x => String(x.assignmentId) === String(id));
    if (!item) continue;

    // optimistic UI
    _timeOff.add(`${item.person}|${item.dateISO}`);
    item.notes = ((item.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim() + " [OFF]").trim();

    google.script.run
      .withFailureHandler((e) => console.error("Batch OFF failed:", e, item))
      .uiSetTimeOff(item.docId, item.assignmentId, true);
  }

  clearTeamSelection();
  renderView();
  toast(`Success: ${ids.length} shifts marked OFF.`);
}


  function clearTeamSelection() {
    _teamSelected.clear();
    _lastSelectedPerson = null;
    document.querySelectorAll('.shift.selected').forEach(el => el.classList.remove('selected'));
    updateSelectionBar();
  }
  
  async function applyBatch() {
    const newPerson = document.getElementById("tpPerson").value;
    const ids = Array.from(_teamSelected);

    if (!newPerson) return toast("Please select a person first.");
    if (ids.length === 0) return toast("No shifts selected.");

    const result = await Swal.fire({
        title: `Assign ${ids.length} shifts to ${newPerson}?`,
        text: "Choose how to notify the team.",
        icon: 'question',
        showCancelButton: true,
        showDenyButton: true,
        confirmButtonText: '‚ö° Send Bot Now',
        denyButtonText: '‚è≥ Add to Pending',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#1e293b', 
        denyButtonColor: '#f59e0b',    
    });

    if (!result.isConfirmed && !result.isDenied) return; 

    const notifyMode = result.isConfirmed ? 'send' : 'defer';
    toast("Processing batch...");

    // Loop through every selected ID and update locally + server-side
    for (const id of ids) {
        const item = _allData.find(x => String(x.assignmentId) === String(id));
        if (item) {
            const oldPerson = item.person;
            
            // 1. Update the local data immediately
            item.person = newPerson;
            
            // 2. Add to the Pending Notification List if requested
            if (notifyMode === 'defer') {
                _notifQueue.push({
                    person: newPerson,
                    message: `Change: ${newPerson} replaced ${oldPerson} (${item.dateLabel} ${item.startLabel})`,
                    undoData: { docId: item.docId, assignmentId: id, newPerson: oldPerson, notes: item.notes }
                });
            }

            // 3. Send the save request to the server
            google.script.run.withSuccessHandler(() => {
                console.log(`Saved shift ${id}`);
            }).uiReplaceAssignment({
                docId: item.docId,
                assignmentId: item.assignmentId,
                newPerson: newPerson,
                notes: item.notes || "Batch Update",
                notifyMode: notifyMode
            });
        }
    }

    // Update the Pending Queue in browser storage
    if (notifyMode === 'defer') {
        playNotificationSound(); 
        localStorage.setItem("musely_notif_queue", JSON.stringify(_notifQueue));
        renderNotifList(); 
        toast(`${ids.length} shifts added to Pending Queue`);
    } else {
        playSendSound(); 
        toast(`Success! ${ids.length} shifts updated.`);
    }

    clearTeamSelection(); 
    renderView(); // Refresh the UI to show new names       
  }

  // Admin & Context
  function promptMasterSelection(list) { $("masterContextOverlay").style.display="flex"; const s=$("masterManagerDropdown"); s.innerHTML=""; list.forEach(m=>s.appendChild(new Option(m.name,m.email))); }
  function confirmManagerSelection() { _selectedManagerEmail=$("masterManagerDropdown").value; $("masterContextOverlay").style.display="none"; load(true, _selectedManagerEmail); }
  function openAdminModal() { $("adminOverlay").style.display="flex"; loadRules(); }
  function closeAdminModal() { $("adminOverlay").style.display="none"; }
  function loadRules() { google.script.run.withSuccessHandler(r => { $("ruleList").innerHTML=""; r.forEach(x => $("ruleList").innerHTML += `<div>${x.team} | ${x.day} | ${x.min}</div>`); }).uiGetStaffingRules(); }
  // Helper: show toast notification
function toast(message, type = "info") {
  const host = $("toastHost");
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.innerHTML = message;
  
  if (type === "success") toast.style.background = "#16a34a";
  if (type === "error") toast.style.background = "#ef4444";
  
  host.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = "0";
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}
  function applyLocalFilters() { _filteredData = _allData.filter(x => (!_activeTeam || x.team===_activeTeam) && (!_selectedPeople.size || _selectedPeople.has(x.person))); renderView(); }
  function renderTeamChips() { const c=$("teamChips"); if(c) { c.innerHTML=""; _teams.forEach(t=>{ const d=mkDiv("chip"); d.innerText=t; d.onclick=()=>filterTeam(t); c.appendChild(d); }); } }
  function filterTeam(t) { _activeTeam=t; applyLocalFilters(); }
  function initFilters() { fillSelect("teamDropdown", _teams); }
  function renderQuickRail() { 
    const list = $("qrList");
    list.innerHTML = ""; 
    const q = ($("qrSearch").value || "").toLowerCase();
    _people.filter(p => !q || p.toLowerCase().includes(q)).forEach(p => { 
        const d = mkDiv("qrItem"); 
        d.innerText = p; 
        d.draggable = true; 
        d.ondragstart = (e) => { 
           _dragPerson = p; 
           e.dataTransfer.effectAllowed = "copy";
        };
        d.onclick = () => {
           _selectedPeople.clear();
           _selectedPeople.add(p);
           applyLocalFilters();
        };
        list.appendChild(d); 
    }); 
  }
  function addRule() { const team = $("ruleTeam").value, day = $("ruleDay").value, min = $("ruleMin").value; if (!team || !min) return toast("Select Team/Min"); $("ruleList").innerHTML += "<div>Saving...</div>"; google.script.run.withSuccessHandler(loadRules).uiSaveStaffingRule({ team, day, min }); $("ruleMin").value = ""; }
  function deleteRule(idx) { if(!confirm("Delete rule?")) return; google.script.run.withSuccessHandler(loadRules).uiDeleteStaffingRule(idx); }

  // Master Template Logic
  function renderMasterView(data) {
    if(!data || data.error) { 
        $("listView").innerHTML = "<div style='color:red;padding:20px;'>Failed to load master template</div>"; 
        return; 
    }
    
    _masterRawData = data; 

    const list = document.getElementById("listView");
    list.innerHTML = "";
    
    // --- NEW: Inject specific styles for hover effects dynamically ---
    const style = document.createElement('style');
    style.innerHTML = `
        .mst-person-row:hover { background-color: #fff8e1 !important; transition: background 0.2s; }
        .shift-chip:hover { background-color: #d2e3fc !important; border-color: #1967d2 !important; }
        .mst-day-cell:hover { background-color: rgba(0,0,0,0.02); }
        .add-btn { opacity: 0; transition: opacity 0.2s; }
        .mst-day-cell:hover .add-btn { opacity: 1; }
    `;
    list.appendChild(style);
    
    // 1. Pivot Data
    const roster = {};
    const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    
    days.forEach(day => {
        const dayItems = data[day] || [];
        dayItems.forEach(item => {
            const pName = item.person;
            if (!roster[pName]) roster[pName] = {};
            if (!roster[pName][day]) roster[pName][day] = [];
            roster[pName][day].push(item);
        });
    });

    list.style.display = "block"; 
    list.style.overflowX = "auto";
    list.style.fontFamily = "sans-serif"; 

    // 2. The Header
    const headerRow = mkDiv("mst-header-row");
    headerRow.style.display = "grid";
    headerRow.style.gridTemplateColumns = "180px repeat(7, 1fr)"; 
    headerRow.style.backgroundColor = "#2c3e50"; 
    headerRow.style.color = "#ffffff";
    headerRow.style.fontWeight = "bold";
    headerRow.style.borderBottom = "2px solid #ddd";

    let headerHtml = `<div style="padding:12px; border-right:1px solid #4a6278;">Employee</div>`;
    days.forEach((d, i) => { 
        const borderStyle = i < 6 ? "border-right:1px solid #4a6278;" : ""; 
        headerHtml += `<div style="padding:12px; text-align:center; ${borderStyle}">${d}</div>`; 
    });
    headerRow.innerHTML = headerHtml;
    list.appendChild(headerRow);

    // 3. The Body
    const sortedPersons = Object.keys(roster).sort();
    
    sortedPersons.forEach((person, index) => {
        const row = mkDiv("mst-person-row");
        const bg = index % 2 === 0 ? "#ffffff" : "#f8f9fa"; 
        row.style.backgroundColor = bg;
        row.style.display = "grid";
        row.style.gridTemplateColumns = "180px repeat(7, 1fr)";
        row.style.borderBottom = "1px solid #e0e0e0";
        row.style.alignItems = "stretch"; 

        // Name Column
        let html = `
            <div class="mst-person-info" style="
                padding:12px; font-weight:600; color:#333; 
                border-right:2px solid #e0e0e0; display:flex; align-items:center;">
                ${person}
            </div>`;

        // Day Columns
        days.forEach((day, i) => {
            const shifts = roster[person][day] || [];
            const borderStyle = i < 6 ? "border-right:1px solid #eee;" : "";

            // We add an onclick to the CELL itself to allow adding a new shift
            html += `<div class="mst-day-cell" 
                        onclick="handleCellClick('${person}', '${day}')"
                        style="padding:8px; display:flex; flex-direction:column; gap:4px; align-items:center; justify-content:flex-start; cursor:pointer; position:relative; ${borderStyle}">`;
            
            if (shifts.length === 0) {
                 // Show a subtle "+" when hovering empty cells
                html += `<span class="add-btn" style="color:#ccc; font-size:20px; font-weight:bold;">+</span>`;
            } else {
                shifts.forEach(shift => {
                    // 1. Keep raw values for the logic (Editing needs military time)
                    const rawStart = shift.start; 
                    const rawEnd = shift.end;

                    // 2. Create pretty values for the Human Eyes
                    const displayStart = toAmPm(rawStart);
                    const displayEnd = toAmPm(rawEnd);
                    
                    html += `<div class="shift-chip" 
                                onclick="event.stopPropagation(); handleShiftEdit('${person}', '${day}', '${rawStart}', '${rawEnd}')"
                                style="
                                font-size:11px; padding:4px 8px; 
                                background:#e8f0fe; color:#1967d2; 
                                border: 1px solid #d2e3fc;
                                border-radius:12px; font-weight:500;
                                white-space:nowrap; cursor:pointer;
                                box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                ${displayStart} - ${displayEnd}
                             </div>`;
                });
            }
            html += `</div>`;
        });

        row.innerHTML = html;
        list.appendChild(row);
    });
}

// Triggered when clicking an existing blue chip
function handleShiftEdit(person, day, start, end, team) {
    // Populate the inputs
    document.getElementById("modalEmployee").value = person;
    document.getElementById("modalDay").value = day;
    
    // Ensure format HH:MM for the time inputs
    document.getElementById("modalStart").value = start.substring(0,5);
    document.getElementById("modalEnd").value = end.substring(0,5);

    // Store original times so we know which shift to update later
    document.getElementById("modalOrigStart").value = start;
    document.getElementById("modalOrigEnd").value = end;

    // FIX: Populate and Select Team
    fillSelect("modalTeam", _teams); // Reuse your existing helper
    document.getElementById("modalTeam").value = team;

    // Show the modal
    const modal = document.getElementById("editShiftModal");
    modal.style.display = "flex";
}


function handleCellClick(person, day) {
    // 1. Prepare the Modal for a New Entry
    document.getElementById("modalEmployee").value = person;
    document.getElementById("modalDay").value = day;
    
    // Default times for a new shift
    document.getElementById("modalStart").value = "08:00";
    document.getElementById("modalEnd").value = "17:00";

    // Clear original times (since this shift doesn't exist yet)
    document.getElementById("modalOrigStart").value = "NEW";
    document.getElementById("modalOrigEnd").value = "NEW";

    // Populate and default the Team
    fillSelect("modalTeam", _teams);
    
    // Change UI header to indicate "Adding"
    document.querySelector("#editShiftModal h3").innerText = "Add New Shift";

    const modal = document.getElementById("editShiftModal");
    modal.style.display = "flex";
}

  function toggleMasterPerson(key, dayName) {
    if (_masterSelected.has(key)) {
        _masterSelected.delete(key);
    } else {
        _masterSelected.add(key);
    }
    renderMasterView(JSON.stringify(_masterRawData));
    updateMasterSelectionBar(); 
  }

  function openMasterModal(p,d,s,e,t,r) { 
    fillSelect("mstTeam", _teams); 
    fillSelect("mstRole", _roles); 
    
    $("mstSub").innerText = s ? `Editing ${p} on ${d}` : `Adding Shift for ${p} on ${d}`;
    $("mstPerson").value = p; 
    $("mstDay").value = d; 
    
    $("mstStart").value = s || ""; 
    $("mstEnd").value = e || ""; 
    $("mstTeam").value = t || ""; 
    $("mstRole").value = r || ""; 
    
    $("masterOverlay").style.display = "flex"; 
  }
  
  function updateMasterSelectionBar() {
    const count = _masterSelected.size;
    const bar = document.getElementById("selectionBar");
    const countSpan = document.getElementById("sbCount");
    
    if (count > 0) {
        bar.classList.add("visible");
        countSpan.innerText = count;
    } else {
        bar.classList.remove("visible");
    }
  }
// ============================================
// NOTIFICATION SYSTEM
// ============================================

let pendingNotifications = [];

// Toggle notification panel open/closed
function toggleNotifPanel() {
  const panel = $("notifPanel");
  panel.classList.toggle("open");
  
  if (panel.classList.contains("open")) {
    loadPendingNotifications();
  }
}
// Load pending notifications from backend
async function loadPendingNotifications() {
  const listEl = $("notifList");
  listEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">Loading... </div>';
  
  try {
    const res = await fetch(". /? action=notifications/pending");
    const data = await res.json();
    
    if (! data.ok) throw new Error(data.error || "Failed to load");
    
    pendingNotifications = data.notifications || [];
    renderNotifications();
    updateNotifBadge();
    
  } catch (err) {
    console.error("Load notifications error:", err);
    listEl.innerHTML = `<div style="text-align: center; color:#ef4444; padding:20px;">Error:  ${err.message}</div>`;
  }
}

// Render notifications in the panel
function renderNotifications() {
  const listEl = $("notifList");
  
  if (pendingNotifications. length === 0) {
    listEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">No pending notifications üéâ</div>';
    return;
  }
  
  let html = "";
  
  pendingNotifications.forEach((n, idx) => {
    html += `
      <div class="notif-item" data-idx="${idx}" style="
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius:  10px;
        padding: 12px;
        margin-bottom:  10px;
      ">
        <div style="display: flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
          <div>
            <div style="font-weight:700; color:#0f172a; font-size:14px;">${escapeHtml(n.person)}</div>
            <div style="font-size:11px; color:#64748b;">${escapeHtml(n. date)} ‚Ä¢ ${escapeHtml(n.team)}</div>
          </div>
          <span style="background:#fef3c7; color:#92400e; font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px;">PENDING</span>
        </div>
        <div style="font-size:12px; color:#334155; margin-bottom:10px;">
          üïê ${escapeHtml(n.start)} ‚Äì ${escapeHtml(n. end)}<br>
          üìã ${escapeHtml(n.role || "No role specified")}
        </div>
        ${n.notes ? `<div style="font-size:11px; color:#64748b; font-style:italic; margin-bottom:10px;">"${escapeHtml(n. notes)}"</div>` : ""}
        <div style="display:flex; gap:8px;">
          <button onclick="sendSingleNotification(${idx})" style="
            flex: 1; background:#3b82f6; color:#fff; border:none; padding:6px 10px; 
            border-radius:6px; font-size:11px; font-weight:600; cursor:pointer;
          ">üì§ Send Now</button>
          <button onclick="dismissNotification(${idx})" style="
            flex:1; background:#fff; color:#64748b; border:1px solid #e2e8f0; padding:6px 10px; 
            border-radius:6px; font-size:11px; font-weight:600; cursor: pointer;
          ">‚úï Dismiss</button>
        </div>
      </div>
    `;
  });
  
  listEl.innerHTML = html;
}

// Update the red badge count
function updateNotifBadge() {
  const badge = $("notifCount");
  const count = pendingNotifications.length;
  
  if (count > 0) {
    badge.textContent = count > 99 ? "99+" : count;
    badge.classList.remove("hidden");
  } else {
    badge.classList.add("hidden");
  }
}

/ Update the red badge count
function updateNotifBadge() {
  const badge = $("notifCount");
  const count = pendingNotifications.length;
  
  if (count > 0) {
    badge.textContent = count > 99 ? "99+" : count;
    badge.classList.remove("hidden");
  } else {
    badge.classList.add("hidden");
  }
}

// Send a single notification
async function sendSingleNotification(idx) {
  const n = pendingNotifications[idx];
  if (!n) return;
  
  try {
    const res = await fetch("./?action=notifications/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        notifications: [{ docId: n.docId, assignmentId: n.assignmentId }]
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.sent > 0) {
      toast(`‚úÖ Notification sent to ${n.person}!`, "success");
      pendingNotifications.splice(idx, 1);
      renderNotifications();
      updateNotifBadge();
    } else {
      const errMsg = data.results? .[0]?.error || "Failed to send";
      toast(`‚ùå Failed:  ${errMsg}`, "error");
    }
    
  } catch (err) {
    console.error("Send notification error:", err);
    toast(`‚ùå Error: ${err.message}`, "error");
  }
}

// Dismiss a notification (don't send, just clear it)
async function dismissNotification(idx) {
  const n = pendingNotifications[idx];
  if (!n) return;
  
  try {
    const res = await fetch("./?action=notifications/dismiss", {
      method: "POST",
      headers:  { "Content-Type": "application/json" },
      body:  JSON.stringify({
        docId: n.docId,
        assignmentId: n.assignmentId
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`Notification dismissed`, "info");
      pendingNotifications. splice(idx, 1);
      renderNotifications();
      updateNotifBadge();
    } else {
      toast(`‚ùå Failed to dismiss`, "error");
    }
    
  } catch (err) {
    console.error("Dismiss error:", err);
    toast(`‚ùå Error: ${err. message}`, "error");
  }
}

// Send ALL pending notifications
async function sendAllPending() {
  if (pendingNotifications.length === 0) {
    toast("No pending notifications to send", "info");
    return;
  }
  
  const confirmed = await Swal.fire({
    title: "Send All Notifications?",
    text: `This will send ${pendingNotifications.length} notification(s) via Google Chat. `,
    icon: "question",
    showCancelButton:  true,
    confirmButtonText:  "Yes, Send All",
    cancelButtonText: "Cancel"
  });
  
  if (!confirmed. isConfirmed) return;
  
  try {
    const payload = pendingNotifications.map(n => ({
      docId: n. docId,
      assignmentId: n.assignmentId
    }));
    
    const res = await fetch("./?action=notifications/send", {
      method:  "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ notifications: payload })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`‚úÖ Sent ${data.sent} of ${data.total} notifications`, "success");
      await loadPendingNotifications(); // Refresh the list
    } else {
      toast(`‚ùå Error sending notifications`, "error");
    }
    
  } catch (err) {
    console.error("Send all error:", err);
    toast(`‚ùå Error: ${err.message}`, "error");
  }
}


  function undoNotification(index) {
    const notif = _notifQueue[index];
    if (!notif || !notif.undoData) return;

    Swal.fire({
        title: 'Undo Change?',
        text: `This will revert the schedule for ${notif.undoData.newPerson} immediately.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#1e293b', 
        cancelButtonColor: '#cbd5e1',  
        confirmButtonText: 'Yes, Undo it',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            executeUndo(index, notif);
        }
    });
  }

  function executeUndo(index, notif) {
    toast("Reverting...");
    const data = notif.undoData; // Alias for cleaner code

    google.script.run.withSuccessHandler(() => {
        const local = _allData.find(x => x.assignmentId === data.assignmentId);
        if(local) { 
            local.person = data.newPerson; 
            local.notes = data.notes; 
        }
        renderView();
        _notifQueue.splice(index, 1);
        renderNotifList();
        Swal.fire({ title: 'Reverted!', icon: 'success', timer: 1000, showConfirmButton: false });
    }).uiReplaceAssignment({
        docId: data.docId, // <--- Ensure this is passed
        assignmentId: data.assignmentId,
        newPerson: data.newPerson,
        notes: data.notes,
        notifyMode: "silent"
    });
  }

  function toggleDrawer() {
    const drawer = document.getElementById("rightDrawer");
    const notifPanel = document.getElementById("notifPanel");
    if (notifPanel && notifPanel.style.display === "block") {
        notifPanel.style.display = "none";
    }
    if (drawer) {
        drawer.classList.toggle("open");
    }
  }

  function setMode(mode) {
    _mode = mode; 
    document.getElementById("btnModeQuick").className = mode === "quick" ? "segBtn active" : "segBtn";
    document.getElementById("btnModeTeam").className = mode === "team" ? "segBtn active" : "segBtn";
    const quickDiv = document.getElementById("drawerQuick");
    const teamDiv = document.getElementById("drawerTeam");
    if (mode === "quick") {
      quickDiv.classList.remove("hidden");
      teamDiv.classList.add("hidden");
    } else {
      quickDiv.classList.add("hidden");
      teamDiv.classList.remove("hidden");
    }
  }

  // Clear all notifications (dismiss all)
async function clearNotifications() {
  if (pendingNotifications.length === 0) {
    toast("No notifications to clear", "info");
    return;
  }
  
  const confirmed = await Swal.fire({
    title: "Clear All Notifications?",
    text: "This will dismiss all pending notifications without sending them.",
    icon: "warning",
    showCancelButton:  true,
    confirmButtonText:  "Yes, Clear All",
    confirmButtonColor: "#ef4444",
    cancelButtonText: "Cancel"
  });
  
  if (!confirmed.isConfirmed) return;
  
  // Dismiss each one
  for (const n of pendingNotifications) {
    try {
      await fetch("./?action=notifications/dismiss", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ docId: n.docId, assignmentId: n.assignmentId })
      });
    } catch (e) {
      console.error("Clear error:", e);
    }
  }
  
  pendingNotifications = [];
  renderNotifications();
  updateNotifBadge();
  toast("All notifications cleared", "info");
}

  function renderNotifList() {
  const el = document.getElementById("notifList"); // make sure this ID exists in your HTML
  if (!el) return;

  if (!_notifQueue || !_notifQueue.length) {
    el.innerHTML = `<div class="notif-empty">No notifications</div>`;
    return;
  }

  el.innerHTML = _notifQueue.map((n) => `
    <div class="notif-item">
      <div class="notif-title">${escapeHtml(n.title || "Notification")}</div>
      <div class="notif-msg">${escapeHtml(n.msg || "")}</div>
      ${n.ts ? `<div class="notif-time">${escapeHtml(new Date(n.ts).toLocaleString())}</div>` : ""}
    </div>
  `).join("");
}

// If your script is type="module" (or you want to be extra safe):
window.renderNotifList = renderNotifList;

  function sendAllPending() {
    if (!_notifQueue || _notifQueue.length === 0) return toast("Nothing to send");
    playSendSound();
    toast("Sending updates...");
    setTimeout(() => {
        _notifQueue = [];
        localStorage.removeItem("musely_notif_queue"); 
        renderNotifList();
        toggleNotifPanel(); 
        toast("All notifications sent!");
    }, 1000);
  }

  // Master helper stubs
  function toggleMasterCheck(k,d){ if(_masterSelected.has(k)) _masterSelected.delete(k); else _masterSelected.add(k); renderMasterView(JSON.stringify(_masterRawData)); }
  function saveMasterEdit() { closeMasterModal(); toast("Saving...",false); const p={person:$("mstPerson").value,dayName:$("mstDay").value,newStart:$("mstStart").value,newEnd:$("mstEnd").value,newTeam:$("mstTeam").value,newRole:$("mstRole").value,applyDate:$("mstSync").checked?new Date().toISOString():null}; google.script.run.withSuccessHandler(r=>{toast("Saved!"); toggleMasterMode(); toggleMasterMode();}).uiSaveBaseAndPropagate(p); }
  function closeMasterModal() { $("masterOverlay").style.display="none"; }
  
  function updateTeamAgentList() { 
    const t = $("teamDropdown").value; 
    $("teamAgentList").innerHTML = ""; 

    // FIX: Update the global active team filter so the calendar reacts
    _activeTeam = t; 
    applyLocalFilters(); 

    if (t) {
        toast(`Filtering calendar to ${t}`);
    }

    _allData.filter(x => x.team === t)
      .map(x => x.person)
      .filter((v, i, a) => a.indexOf(v) === i)
      .forEach(p => { 
        const b = document.createElement("button"); 
        b.className = "btn-pill"; 
        b.innerText = p; 
        b.onclick = () => {
           _selectedPeople.clear();
           _selectedPeople.add(p);
           applyLocalFilters();
           toast(`Filtered to ${p}`);
        };
        $("teamAgentList").appendChild(b); 
    }); 
  }

  // Helper:  escape HTML to prevent XSS
function escapeHtml(str) {
  if (!str) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

  function filterToday() {
    const today = pstISODate();
    _filteredData = _allData.filter(x => x.dateISO === today);
    if (_activeTeam) {
        _filteredData = _filteredData.filter(x => x.team === _activeTeam);
    }
    if (_selectedPeople.size > 0) {
        _filteredData = _filteredData.filter(x => _selectedPeople.has(x.person));
    }
    renderView();
    toast("Showing Today Only");
    if (_view === 'calendar') {
        setView('list');
    }
  }

  function resetAllFilters() {
    _activeTeam = "";
    _selectedPeople.clear();
    const teamDrop = document.getElementById("teamDropdown");
    if (teamDrop) teamDrop.value = ""; 
    const teamList = document.getElementById("teamAgentList");
    if (teamList) teamList.innerHTML = ""; 
    const search = document.getElementById("qrSearch");
    if (search) search.value = "";
    applyLocalFilters();
    toast("Filters Reset");
  }

  function handleDateJump(val) { toast("Jump to date not active in this view"); }
  function scrollCal(px) { const el=$("calView"); if(el) el.scrollBy({left:px,behavior:"smooth"}); }

  // --- NOTIFICATION SOUND ---
  function playNotificationSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const osc1 = audioCtx.createOscillator();
    const gain1 = audioCtx.createGain();
    osc1.connect(gain1);
    gain1.connect(audioCtx.destination);
    osc1.type = "sine";
    osc1.frequency.setValueAtTime(800, now); 
    gain1.gain.setValueAtTime(0.1, now);
    gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
    osc1.start(now);
    osc1.stop(now + 0.3);
    const osc2 = audioCtx.createOscillator();
    const gain2 = audioCtx.createGain();
    osc2.connect(gain2);
    gain2.connect(audioCtx.destination);
    osc2.type = "sine";
    osc2.frequency.setValueAtTime(600, now + 0.1); 
    gain2.gain.setValueAtTime(0.1, now + 0.1);
    gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.6); 
    osc2.start(now + 0.1);
    osc2.stop(now + 0.6);
  }

  function playSendSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const playTone = (freq, delay) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = "triangle"; 
        osc.frequency.setValueAtTime(freq, now + delay);
        osc.frequency.exponentialRampToValueAtTime(freq * 1.5, now + delay + 0.4);
        gain.gain.setValueAtTime(0, now + delay);
        gain.gain.linearRampToValueAtTime(0.15, now + delay + 0.05); 
        gain.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.4); 
        osc.start(now + delay);
        osc.stop(now + delay + 0.5);
    };
    playTone(440, 0);   
    playTone(659, 0.05); 
  }

  // Final check to ensure listeners don't trap functions
  document.addEventListener('DOMContentLoaded', function() {
       console.log("Musely Scheduler: Loaded");
  });

  document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("btnNotif");
  if (btn) {
    btn.style.pointerEvents = "auto";
    btn.style.cursor = "pointer";
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleNotifPanel();
    });
  }

  (function initNotifUI(){
  function ready(fn){
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
    else fn();
  }

  ready(() => {
    const btn = document.getElementById("btnNotif");
    const panel = document.getElementById("notifPanel");

    if (!btn) { console.warn("btnNotif not found"); return; }
    if (!panel) { console.warn("notifPanel not found"); return; }

    // Force notifPanel to be a direct child of <body> so it cannot be trapped under layouts
    if (panel.parentElement !== document.body) document.body.appendChild(panel);

    // Ensure hidden by default
    panel.style.display = "none";

    // Reliable click binding
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleNotifPanel();
    }, true);

    // Click-away close
    document.addEventListener("click", (e) => {
      if (panel.style.display !== "block") return;
      if (e.target.closest("#btnNotif") || e.target.closest("#notifPanel")) return;
      toggleNotifPanel(false);
    }, true);
  });
})();

});
</script>
