
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* --- RESET & BASICS --- */
  /* --- RESET & BASICS --- */
  * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
  body { margin: 0; padding: 0; background: #f3f4f6; color: #1e293b; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  
  /* --- HEADER --- */
  .header { 
    height: 64px; 
    background: #ffffff; /* White background */
    border-bottom: 1px solid #e2e8f0; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 0 24px; 
    flex: 0 0 64px; 
    box-shadow: none; 
    z-index: 600; 
    position: relative; 
  }
  .hLeft { display: flex; align-items: center; gap: 16px; }
  .hTitle { 
    font-size: 18px; 
    font-weight: 800; 
    color: #0f172a; /* Dark text */
    letter-spacing: -0.5px; 
  }
  .metaGroup { display: flex; gap: 8px; align-items: center; }
  .pill { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .pill.off { background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
  .pill.on { background: rgba(34,197,94,0.2); color: #86efac; border: 1px solid rgba(34,197,94,0.3); }
  .pill.balance {
  background: rgba(255, 255, 255, 0.9);
  color: #166534; /* Dark Green text */
  border: 1px solid #bbf7d0;
  font-weight: 800;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.1s;
}
.pill.balance:hover {
  transform: scale(1.05);
  background: #ffffff;
}
  .pill.tz { background: rgba(255,255,255,0.1); color: #94a3b8; }
  .hRight { display: flex; align-items: center; gap: 16px; }
  .seg { 
    background: #f1f5f9; 
    padding: 4px; 
    border-radius: 8px; 
    display: flex; 
    gap: 2px; 
  }
  .segBtn { 
    background: transparent; 
    border: none; 
    color: #64748b; 
    padding: 6px 14px; 
    font-size: 13px; 
    font-weight: 600; 
    border-radius: 6px; 
    cursor: pointer; 
    transition: all 0.2s; 
  }
  .segBtn:hover { color: #0f172a; }
  .segBtn.active { 
    background: #ffffff; 
    color: #0f172a; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
    border: 1px solid #e2e8f0;
  }
  .iconBtn { 
    width: 38px; 
    height: 38px; 
    border-radius: 8px; 
    border: 1px solid #e2e8f0; 
    background: rgba(15, 23, 42, 0.04); 
    color: #334155; /* Slate-500 */
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s; 
  
    position: relative;
}
  .iconBtn:hover { 
    background: #f1f5f9; 
    color: #0f172a; 
  }
  .iconBtn svg { width: 20px; height: 20px; fill: currentColor; }
  .close {
  color: rgba(255,255,255,0.7);
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  padding: 0 5px;
}
.tool-grid {
  display: grid;
  grid-template-columns: 1fr 1fr; /* 2 Columns */
  gap: 16px;
  margin-bottom: 24px;
}
.tool-card {
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: flex-start;
  position: relative;
}
.tool-card:hover {
  border-color: #cbd5e1;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.tool-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  margin-bottom: 4px;
}
.tool-title { font-size: 14px; font-weight: 700; color: #0f172a; }
.tool-desc { font-size: 11px; color: #64748b; line-height: 1.4; }
/* Danger Zone remains distinct but cleaner */
.danger-section {
  border-top: 1px dashed #e2e8f0;
  padding-top: 20px;
  margin-top: 10px;
}
.close:hover {
  color: #fff;
}
#agFormTimeOff input[type="radio"]:checked + div {
  font-weight: 700;
}
/* Smooth transitions for the type selection cards */
#agFormTimeOff label {
  transition: all 0.2s ease;
}
  #notifCount {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ef4444;
    color: #fff;
    font-size: 10px;
    font-weight: 800;
    padding: 2px 6px;
    border-radius: 10px;
    border: 2px solid #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    pointer-events: none; /* ‚úÖ badge won't block clicking */
  }
  /* ‚úÖ Missing style in your file (you use class="action-btn") */
  .action-btn{
    background: #ffffff;
    color: #0f172a;
    border: 1px solid rgba(255,255,255,0.15);
    border-color: #cbd5e1;
    padding: 8px 14px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .action-btn:hover{
    background: #f8fafc;
    border-color: #94a3b8;
  }
  /* --- FILTER STYLES --- */
  .filter-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
  .filter-header { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #94a3b8; font-weight: 800; margin-bottom: 8px; }
  .btn-pill { background: #f8fafc; border: 1px solid #e2e8f0; padding: 5px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
  .btn-pill:hover { border-color: #cbd5e1; background: #f1f5f9; }
  .navGroup { display: flex; align-items: center; gap: 4px; margin-right: 16px; border-right: 1px solid #e2e8f0; padding-right: 16px; }
  .navBtn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
  .navBtn:hover { background: #f1f5f9; color: #1e293b; border-color: #cbd5e1; }
  .navBtn svg { width: 18px; height: 18px; fill: currentColor; }
  .pickerList { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-content: start; }
  .pRow { display: flex; align-items: center; gap: 12px; padding: 8px 12px; border-radius: 8px; border: 1px solid #f1f5f9; cursor: pointer; transition: all 0.1s; justify-content: flex-start; }
  .pRow:hover { background: #f8fafc; border-color: #e2e8f0; }
  .pRow input { margin: 0; width: 16px; height: 16px; cursor: pointer; }
  .chip { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #475569; background: #f1f5f9; border: 1px solid transparent; cursor: pointer; transition: all 0.15s; }
  .chip:hover { background: #e2e8f0; }
  .chip.active { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
  .skel-wrapper { display: flex; gap: 16px; height: 100%; overflow: hidden; padding-bottom: 8px; }
  .skel-col { min-width: 320px; background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .skel-anim { background: #f1f5f9; background-image: linear-gradient(to right, #f1f5f9 0%, #e2e8f0 20%, #f1f5f9 40%, #f1f5f9 100%); background-repeat: no-repeat; background-size: 800px 100%; animation: shimmer 1.5s infinite linear forwards; border-radius: 8px; }
  @keyframes shimmer { 0% { background-position: -400px 0; } 100% { background-position: 400px 0; } }
  .skel-head { height: 30px; width: 60%; margin-bottom: 10px; }
  .skel-card { height: 80px; width: 100%; }
  .main { flex: 1; display: flex; overflow: hidden; position: relative; }
  .content { flex: 1; overflow: hidden; padding: 20px; position: relative; display: flex; flex-direction: column; }
  /* === CALENDAR WRAPPER === */
  #calViewWrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    height: 100%;
  }
  /* === CALENDAR GRID - DEFAULT (horizontal scroll) === */
  .calGrid { 
    display: flex; 
    gap: 16px; 
    flex: 1;
    min-height: 0;
    overflow-x: auto; 
    overflow-y: hidden;
    padding-bottom: 8px; 
    scrollbar-width: none; 
  }
  .calGrid::-webkit-scrollbar { display: none; }
  /* === DAY COLUMNS - DEFAULT === */
  .dayCol { 
    min-width: 320px; 
    max-width: 320px; 
    background: #f8fafc; 
    border: 1px solid #e2e8f0; 
    border-radius: 16px; 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
    overflow: hidden;
    flex-shrink: 0;
  }
  /* === CHANNEL FILTERED MODE - Columns expand to fill screen === */
  .calGrid.channel-filtered {
    overflow-x: hidden;
  }
  
  .calGrid.channel-filtered .dayCol {
    flex: 1 1 0;
    min-width: 180px;
    max-width: none;
  }
.dayHead { 
    padding: 16px; 
    border-bottom: 1px solid #e2e8f0; 
    display: flex; 
    justify-content: space-between; 
    font-weight: 800; 
    font-size: 15px; 
    color: #0f172a; 
    background: #fff; 
    border-radius: 16px 16px 0 0;
    flex-shrink: 0;
  }
.dayCol.today .dayHead { background: #3b82f6; color: #fff; border-color: #3b82f6; }
.dayCol.today { border-color: #93c5fd; box-shadow: 0 4px 12px rgba(59,130,246,0.15); }
.dayBody { 
    padding: 10px; 
    flex: 1; 
    overflow-y: auto; 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    scrollbar-width: none; 
  }
  .dayBody::-webkit-scrollbar { display: none; }
  /* --- NEW SCHEDULE VIEW STYLES --- */
.schedule-container {
  display: flex;
  gap: 20px;
  height: 100%;
  overflow: hidden; /* inner parts scroll */
}
/* LEFT SIDEBAR (Day Tabs) */
.day-tabs {
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 160px;
  flex-shrink: 0;
  overflow-y: auto;
  padding-right: 4px; /* room for scrollbar */
}
.day-tab {
  padding: 14px;
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}
.day-tab:hover {
  border-color: #3b82f6;
  background: #eff6ff;
}
.day-tab.active {
  background: #3b82f6;
  border-color: #3b82f6;
  color: white;
  box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
}
.day-tab .day-name { font-weight: 800; font-size: 15px; }
.day-tab .day-date { font-size: 11px; opacity: 0.8; margin-top: 2px; text-transform:uppercase; letter-spacing:0.5px; }
/* MAIN CONTENT (Right Side) */
.day-content {
  flex: 1;
  background: white;
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}
.day-content-header {
  padding: 20px 24px;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #334155;
}
.day-content-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  background: #f8fafc;
}
/* CHANNEL SECTIONS */
.channel-section { margin-bottom: 30px; }
.channel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid #e2e8f0;
}
.channel-title { font-size: 14px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
/* SHIFT GRID */
.shifts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 12px;
}
/* NEW CARD STYLE */
.shift-card-b {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 14px;
  transition: all 0.2s;
  border-left: 4px solid #cbd5e1; /* Default Color */
  position: relative;
  cursor: pointer;
}
.shift-card-b:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
  border-color: #cbd5e1; /* Hover border */
}
.sc-time { font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; display:flex; justify-content:space-between;}
.sc-name { font-size: 16px; font-weight: 800; color: #0f172a; }
.sc-role { font-size: 11px; display: inline-block; padding: 2px 8px; border-radius: 10px; background: #f1f5f9; color: #475569; font-weight: 600; margin-top: 6px; }
/* Context colors for border-left */
.bd-livechat { border-left-color: #b3a6d5; }
.bd-phone { border-left-color: #a1c3c8; }
.bd-email { border-left-color: #fee498; }
.bd-social { border-left-color: #f8ca9b; }
  .listGrid { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; height: 100%; padding-right: 8px; }
  .listGroup { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
  .listHead { font-weight: 700; font-size: 15px; margin-bottom: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; display: flex; justify-content: space-between; }
  .listRow { display: flex; flex-wrap: wrap; gap: 12px; }
  .shift { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 14px; cursor: pointer; transition: all 0.15s; position: relative; min-width: 240px; display: flex; flex-direction: column; gap: 4px; }
  .shift:hover { transform: translateY(-2px); box-shadow: 0 4px 12px -2px rgba(0,0,0,0.08); z-index: 5; border-color: #cbd5e1; }
  .sRow { display: flex; justify-content: space-between; align-items: center; }
  .sTime { font-size: 13px; font-weight: 800; color: #334155; }
  .sName { font-size: 13px; font-weight: 600; color: #0f172a; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .sRole { font-size: 11px; color: #64748b; font-weight: 500; }
  /* Team/Channel Color Classes - Consolidated */
  .t-other { 
    background: #f8fafc; 
    border-color: #e2e8f0; 
  }
  .t-other .sTime, .t-other .sName { color: #475569; }
  
  .t-11meeting, .t-1-1meetings, .t-11meetings { 
    background: #adbaf1 !important; 
    border-color: #8e9de0 !important; 
  } 
  .t-1-1meetings .sTime, .t-1-1meetings .sName,
  .t-11meetings .sTime, .t-11meetings .sName { color: #20175c !important; }
  
  .t-lunch { 
    background: #fee498 !important; 
    border-color: #c8d4a0 !important; 
  } 
  .t-lunch .sTime, .t-lunch .sName { color: #2b4e2e !important; }
  
  .t-projects, .t-reportingprojects { 
    background: #e9d0db !important; 
    border-color: #d4b0c0 !important; 
  } 
  .t-projects .sTime, .t-projects .sName,
  .t-reportingprojects .sTime, .t-reportingprojects .sName { color: #8c1b47 !important; }
  
  .t-livechat { 
    background: #b3a6d5 !important; 
    border-color: #9688c2 !important; 
  } 
  .t-livechat .sTime, .t-livechat .sName { color: #351d77 !important; }
  
  .t-floater, .t-emailfloater { 
    background: #fee498 !important; 
    border-color: #ecd07a !important; 
  } 
  .t-floater .sTime, .t-floater .sName,
  .t-emailfloater .sTime, .t-emailfloater .sName { color: #7f692a !important; }
  
  .t-phone, .t-phonesupport { 
    background: #a1c3c8 !important; 
    border-color: #7ea9b0 !important; 
  } 
  .t-phone .sTime, .t-phone .sName,
  .t-phonesupport .sTime, .t-phonesupport .sName { color: #135062 !important; }
  
  .t-socials { 
    background: #f8ca9b !important; 
    border-color: #e5b078 !important; 
  } 
  .t-socials .sTime, .t-socials .sName { color: #b35f16 !important; }
  
  .t-disputes { 
    background: #d0b0ad !important; 
    border-color: #b89490 !important; 
  } 
  .t-disputes .sTime, .t-disputes .sName { color: #4c1130 !important; }
  
  .t-mdsupport, .t-md { 
    background: #a3c1f3 !important; 
    border-color: #7ba3e8 !important; 
  } 
  .t-mdsupport .sTime, .t-mdsupport .sName,
  .t-md .sTime, .t-md .sName { color: #2655cb !important; }
  
  .shift.selected { outline: 2px solid #3b82f6; z-index: 10; }
  .shift.dropTarget { background: #f0f9ff; border: 2px dashed #3b82f6; }
  .selBox { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; background: #fff; border: 1px solid #cbd5e1; border-radius: 5px; display: none; align-items: center; justify-content: center; font-size: 14px; color: #0f172a; }
  .shift.selected .selBox { display: flex; background: #3b82f6; border-color: #3b82f6; color: #fff; }
 .drawer { 
  position: fixed; 
  top: 64px; 
  right: -320px; 
  bottom: 0; 
  width: 320px; 
  background: #fff; 
  border-left: 1px solid #e2e8f0; 
  box-shadow: -4px 0 24px rgba(0,0,0,0.05); 
  transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
  z-index: 40; 
  display: flex; 
  flex-direction: column; /* Stack header and body vertically */
}
.drawer.open { right: 0; }
.drawerHead { 
  padding: 20px; 
  border-bottom: 1px solid #e2e8f0; 
  font-weight: 700; 
  font-size: 15px; 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  background: #f8fafc; 
  flex-shrink: 0; /* üö® Critical: Prevents header from shrinking when scrolling */
}
.drawerBody { 
  flex: 1; 
  min-height: 0; /* üö® Critical: Tells browser to allow scrolling inside flex item */
  overflow-y: auto; 
  padding: 20px; 
}
  .qrSearch { width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 16px; background: #f8fafc; font-size: 13px; }
  .qrItem { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 10px; cursor: grab; transition: background 0.1s; border: 1px solid transparent; }
  .qrItem:hover { background: #f1f5f9; border-color: #e2e8f0; }
  .qrAvatar { width: 32px; height: 32px; border-radius: 50%; background: #cbd5e1; color: #fff; font-size: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
  .qrPerson.unavailable { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
  .metricsWrap { display:flex; gap:16px; height:100%; }
  .metricsLeft { flex: 1; background:#fff; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; }
  .metricsTop { padding:14px 16px; border-bottom:1px solid #e2e8f0; background:#f8fafc; display:flex; gap:12px; align-items:center; justify-content:space-between; }
  .metricsTop input { max-width: 260px; margin:0; }
  .metricsList { padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; flex:1; min-height:0; }
  .metricsRow { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border:1px solid #e2e8f0; border-radius:12px; cursor:pointer; transition: all 0.15s; }
  .metricsRow:hover { background:#f8fafc; border-color:#cbd5e1; }
  .metricsRow .left { display:flex; align-items:center; gap:10px; min-width:0; }
  .metricsRow .avatar { width:34px; height:34px; border-radius:50%; background:#cbd5e1; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:12px; flex: 0 0 auto; }
  .metricsRow .name { font-weight:800; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .metricsRow .sub { font-size:11px; color:#64748b; }
  .metricsDrawer { width: 0; overflow:hidden; background:#fff; border:1px solid #e2e8f0; border-radius:16px; transition: width 0.25s ease; }
  .metricsDrawer.open { width: 420px; }
  .metricsDrawerHead { padding:14px 16px; border-bottom:1px solid #e2e8f0; background:#f8fafc; display:flex; align-items:center; justify-content:space-between; }
  .metricsDrawerBody { padding:16px; overflow-y:auto; height: calc(100% - 56px); }
  .tGroup { margin-bottom: 12px; background: transparent; }
  .tGroupHeader { padding: 4px 0; background: transparent; font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; border-bottom: 1px solid #e2e8f0; margin-bottom: 6px; }
  .tGroupHeader:hover { background: #e2e8f0; color: #1e293b; }
  .tGroupBody { display: flex; flex-direction: column; gap: 6px; max-height: 250px; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
  .tGroupBody::-webkit-scrollbar { display: none; }
  .tGroup.collapsed .tGroupBody { display: none; }
  .tCount { background: #cbd5e1; color: #fff; border-radius: 10px; padding: 2px 6px; font-size: 10px; }
  .overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal { background: #fff; width: 440px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); overflow: hidden; animation: popIn 0.2s; }
  @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .mHead { padding: 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .mTitle { font-weight: 800; font-size: 16px; color: #0f172a; }
  .mBody { padding: 24px; }
  .mFoot { padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 10px; }
  label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  textarea, select, input { width: 100%; border: 1px solid #cbd5e1; border-radius: 10px; padding: 10px; font-size: 14px; outline: none; background: #fff; }
  textarea:focus, select:focus, input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; } /* ‚úÖ valid ring */
  .btn { padding: 10px 16px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; border: none; transition: all 0.2s; }
  .btn.primary { background: #1e293b; color: #fff; } .btn.primary:hover { background: #0f172a; }
  .btn.ghost { background: #fff; border: 1px solid #e2e8f0; color: #334155; } .btn.ghost:hover { background: #f1f5f9; border-color: #cbd5e1; }
  #toastHost { 
    position: fixed; 
    bottom: 24px; 
    right: 24px; 
    z-index: 10040;
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    transition: bottom 0.3s; 
  }
  /* ============================================
   AGENT MODAL STYLES
   ============================================ */
#agentOverlay .modal {
  width: 420px;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
}
#agentOverlay .mHead {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
  padding: 16px 20px;
  border-bottom: none;
}
#agentOverlay .mHead .mTitle {
  color: white;
  font-weight: 700;
  font-size: 16px;
}
#agentOverlay .mHead .btn.ghost {
  color: white;
  border-color: rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.1);
}
#agentOverlay .mHead .btn.ghost:hover {
  background: rgba(255,255,255,0.2);
}
#agentOverlay .mBody {
  padding: 20px;
}
/* Shift Details Box */
#agentOverlay #agShiftDetails {
  background: #f0f9ff;
  border: 2px solid #3b82f6;
  border-radius: 10px;
  padding: 16px;
  font-size: 15px;
  font-weight: 700;
  color: #1e40af;
  text-align: center;
  margin-bottom: 20px;
}
/* Action Buttons Container */
#agentOverlay #agActionSelect {
  display:  flex;
  flex-direction: column;
  gap: 12px;
}
/* Swap Button */
#agentOverlay .agBtn-swap {
  width: 100%;
  padding:  16px;
  border: 2px solid #3b82f6;
  border-radius:  10px;
  background: #eff6ff;
  color:  #1d4ed8;
  font-size: 15px;
  font-weight:  600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: all 0.2s ease;
}
#agentOverlay .agBtn-swap:hover {
  background: #dbeafe;
  transform: translateY(-1px);
}
/* Time Off Button */
#agentOverlay .agBtn-timeoff {
  width: 100%;
  padding: 16px;
  border: 2px solid #f87171;
  border-radius:  10px;
  background:  #fef2f2;
  color: #dc2626;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: all 0.2s ease;
}
#agentOverlay .agBtn-timeoff:hover {
  background: #fee2e2;
  transform:  translateY(-1px);
}
/* Form Labels */
#agentOverlay .agLabel {
  display: block;
  font-size: 11px;
  font-weight: 700;
  color: #64748b;
  margin-bottom:  8px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
/* Form Inputs */
#agentOverlay .agInput {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #e2e8f0;
  border-radius:  8px;
  font-size: 14px;
  transition: border-color 0.2s ease;
}
#agentOverlay .agInput:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
/* Form Action Buttons */
#agentOverlay .agFormActions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}
#agentOverlay .agFormActions .btn {
  flex: 1;
  padding: 12px;
  font-weight: 600;
}
#agentOverlay .agBtn-submit {
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 12px;
  font-weight: 600;
  cursor:  pointer;
}
#agentOverlay .agBtn-submit:hover {
  background: #2563eb;
}
#agentOverlay .agBtn-danger {
  background: #dc2626;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 12px;
  font-weight: 600;
  cursor: pointer;
}
#agentOverlay .agBtn-danger:hover {
  background: #b91c1c;
}
  /* When the selection bar is open, push toasts up (note: only works if toastHost is after selection bar) */
  .selection-bar.visible ~ #toastHost { bottom: 80px; }
  .toast { background: #1e293b; color: #fff; padding: 14px 18px; border-radius: 12px; font-size: 13px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 16px; min-width: 320px; justify-content: space-between; }
  .hidden { display: none !important; }
 /* ============================================
   AUTH PENDING - Hide app until signed in
   ============================================ */
body.auth-pending .header,
body.auth-pending .navGroup,
body.auth-pending .main,
body.auth-pending #loadMoreControls,
body.auth-pending #rightDrawer,
body.auth-pending #coverageBanner,
body.auth-pending #selectionBar {
  display: none !important;
}
body.auth-pending #authOverlay {
  display: flex !important;
}
/* When authenticated, hide the overlay */
body:not(.auth-pending) #authOverlay {
  display: none !important;
}
 /* ============================================
   AGENT VIEW - Full Lockdown
   ============================================ */
/* Hide manager-only header elements */
body.agent-mode #btnAdmin,
body.agent-mode #btnMasterMode,
body.agent-mode #drawerToggle,
body.agent-mode #teamChips,
body.agent-mode #btnNotif {
  display: none !important;
}
/* Hide load history/future buttons for agents - show simpler version */
body.agent-mode #loadMoreControls {
  display: none !important;
}
/* Agent-specific schedule controls */
body.agent-mode #agentScheduleControls {
  display: flex !important;
}
/* Hide view toggle (List/Calendar/Metrics) - or keep if you want agents to switch views */
body.agent-mode .hRight .seg {
  display: none;
}
/* Hide the right drawer entirely */
body.agent-mode #rightDrawer {
  display: none !important;
}
/* Adjust content without drawer */
body.agent-mode .content {
  padding:  20px;
}
/* Hide team group collapse functionality */
body.agent-mode .tGroupHeader {
  pointer-events: none;
  border-bottom: 2px solid #e2e8f0;
}
/* Hide selection checkboxes */
body.agent-mode .selBox {
  display: none !important;
}
/* Hide selection bar */
body.agent-mode #selectionBar {
  display: none !important;
}
/* Make shift cards read-only - BUT allow clicking for agent actions (swap/time-off) */
body.agent-mode .shiftCard {
  cursor: pointer;
}
/* ‚úÖ FIX: Show the group so Agents can see the PTO Pill */
body.agent-mode .metaGroup {
  display: flex !important;
}
/* Hide specific Admin items from Agents */
body.agent-mode #autoPill,
body.agent-mode #managerContextPill {
  display: none !important;
}
/* Navigation should still work */
body.agent-mode .navGroup {
  display: flex;
}
/* Style the header differently for agents */
body.agent-mode .header {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}
/* Fix agent header icons to be visible on blue background */
body.agent-mode .header .iconBtn {
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.25);
}
body.agent-mode .header .iconBtn svg {
  fill: white;
}
body.agent-mode .header .iconBtn:hover {
  background: rgba(255,255,255,0.25);
}
/* Agent notification badge styling */
body.agent-mode #agentNotifBadge {
  background: #fbbf24 !important;
  color: #1e293b !important;
}
/* Agent header title */
body.agent-mode .hTitle {
  color: white;
}
/* Balance pill styling for agent view */
body.agent-mode .pill.balance {
  background: rgba(255,255,255,0.2);
  color: white;
  border-color: rgba(255,255,255,0.3);
}
  /* --- NEW SELECTION BAR STYLES --- */
  .selection-bar {
    position: fixed;
    bottom: -100px;
    left: 0;
    right: 0;
    background: #1e293b;
    color: white;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 999;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
  }
  .selection-bar.visible { bottom: 0; }
  .sb-left { display: flex; align-items: center; gap: 16px; }
  .sb-count { font-weight: 800; font-size: 16px; color: #fff; }
  .sb-actions { display: flex; gap: 10px; }
  .sb-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .sb-btn:hover { background: rgba(255,255,255,0.2); }
  .sb-btn.primary { background: #3b82f6; border-color: #3b82f6; }
  .sb-btn.primary:hover { background: #2563eb; }
  .sb-btn.danger { background: #ef4444; border-color: #ef4444; }
  .sb-btn.danger:hover { background: #dc2626; }
  /* New Styles for Audit Table */
  .audit-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .audit-table th { text-align: left; padding: 8px; background: #f1f5f9; color: #64748b; font-weight: 700; border-bottom: 1px solid #e2e8f0; }
  .audit-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: top; }
  .audit-table tr:hover { background: #f8fafc; }
  .audit-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size: 9px; text-transform: uppercase; }
  .ab-red { background: #fee2e2; color: #991b1b; }
  .ab-blue { background: #dbeafe; color: #1e40af; }
  /* --- NEW MASTER VIEW STYLES --- */
  .mst-day-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
  }
  .mst-day-header {
    background: #f8fafc;
    padding: 12px 16px;
    font-weight: 800;
    color: #334155;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .mst-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #f1f5f9;
    gap: 16px;
    transition: background 0.1s;
  }
  .mst-row:hover { background: #f8fafc; }
  .mst-row.selected { background: #eff6ff; }
  .mst-person-info { width: 200px; flex-shrink: 0; }
  .mst-name { font-weight: 700; color: #0f172a; font-size: 14px; }
  .mst-role { font-size: 11px; color: #64748b; font-weight: 500; }
  .mst-shifts-area { flex: 1; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
  .shift-chip {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 600;
    color: #334155;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .shift-chip:hover {
    border-color: #3b82f6;
    color: #3b82f6;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  }
  .shift-chip.add-btn {
    border-style: dashed;
    color: #94a3b8;
    background: transparent;
    box-shadow: none;
  }
  .shift-chip.add-btn:hover {
    border-color: #3b82f6;
    background: #eff6ff;
    color: #3b82f6;
  }
  /* SweetAlert2 Overrides to match your theme */
  div:where(.swal2-container) { z-index: 12000 !important; }
  div:where(.swal2-popup) { border-radius: 16px !important; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important; }
  div:where(.swal2-title) { font-weight: 800 !important; color: #0f172a !important; }
  .hClose { cursor: pointer; font-size: 20px; color: #64748b; padding: 5px; }
  .hClose:hover { color: #ef4444; }
  
  /* ===========================
     ‚úÖ NOTIFICATION PANEL FIXES
     =========================== */
  #notifPanel {
  position: fixed !important;
  top: 70px !important;
  right:  20px !important;
  width:  360px !important;
  display: none;
  background: #fff !important;
  border: 1px solid #e2e8f0 !important;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
  border-radius: 16px !important;
  z-index: 10050 !important;
  overflow: hidden !important;
  pointer-events: auto !important;
}
#notifPanel.open {
  display: block;
}
/* ============================================
   HOLIDAY THEMES - Calendar View
   ============================================ */
/* Base holiday styling */
.dayCol[class*="holiday-"] .dayHead {
  position: relative;
}
.dayCol[class*="holiday-"] .holidayBadge {
  font-size: 0.75rem;
  opacity: 0.9;
  margin-left: 8px;
}
/* üéÑ Christmas Theme */
.dayCol.holiday-christmas {
  border: 3px solid transparent;
  border-image: repeating-linear-gradient(
    90deg,
    #e53e3e 0px, #e53e3e 8px,
    #38a169 8px, #38a169 16px,
    #ecc94b 16px, #ecc94b 24px
  ) 1;
  border-radius: 0;
}
.dayCol.holiday-christmas .dayHead {
  background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%) !important;
}
/* üéÜ New Year Theme */
.dayCol.holiday-newyear {
  border:  3px solid #d4af37;
  box-shadow: 0 0 15px rgba(212, 175, 55, 0.25);
}
.dayCol.holiday-newyear .dayHead {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
  color: #ffd700 !important;
}
.dayCol.holiday-newyear .dayHead span {
  color: #ffd700 !important;
}
/* üá∫üá∏ July 4th Theme */
.dayCol.holiday-july4th {
  border: 3px solid;
  border-image: repeating-linear-gradient(
    90deg,
    #bf0a30 0px, #bf0a30 8px,
    #ffffff 8px, #ffffff 16px,
    #002868 16px, #002868 24px
  ) 1;
}
.dayCol.holiday-july4th .dayHead {
  background: linear-gradient(135deg, #002868 0%, #bf0a30 100%) !important;
}
/* üéÉ Halloween Theme */
.dayCol.holiday-halloween {
  border: 3px solid #ff6b00;
  background: linear-gradient(180deg, #fff 0%, #fff8f0 100%);
}
.dayCol.holiday-halloween .dayHead {
  background: linear-gradient(135deg, #1a1a2e 0%, #4a1a6b 100%) !important;
  color: #ff9500 !important;
}
.dayCol.holiday-halloween .dayHead span {
  color:  #ff9500 !important;
}
/* ü¶É Thanksgiving Theme */
.dayCol.holiday-thanksgiving {
  border: 3px solid #d97706;
  background: linear-gradient(180deg, #fff 0%, #fef3c7 100%);
}
.dayCol.holiday-thanksgiving .dayHead {
  background: linear-gradient(135deg, #92400e 0%, #b45309 100%) !important;
}
/* üíñ Valentine's Day Theme */
.dayCol.holiday-valentines {
  border: 3px solid #ec4899;
  background: linear-gradient(180deg, #fff 0%, #fdf2f8 100%);
}
.dayCol.holiday-valentines .dayHead {
  background: linear-gradient(135deg, #be185d 0%, #ec4899 100%) !important;
}
/* üíö St. Patrick's Day Theme */
.dayCol.holiday-stpatricks {
  border: 3px solid #22c55e;
  background:  linear-gradient(180deg, #fff 0%, #f0fdf4 100%);
}
.dayCol.holiday-stpatricks .dayHead {
  background: linear-gradient(135deg, #166534 0%, #22c55e 100%) !important;
}
/* üê£ Easter Theme */
.dayCol.holiday-easter {
  border: 3px solid #a78bfa;
  background: linear-gradient(180deg, #fff 0%, #faf5ff 100%);
}
.dayCol.holiday-easter .dayHead {
  background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%) !important;
}
/* ‚≠ê Default/Generic Holiday Theme */
.dayCol.holiday-default {
  border: 3px solid #8b5cf6;
}
.dayCol.holiday-default .dayHead {
  background: linear-gradient(135deg, #5b21b6 0%, #8b5cf6 100%) !important;
}
/* ============================================
   HOLIDAY MANAGEMENT MODAL
   ============================================ */
.holidayList {
  max-height: 300px;
  overflow-y:  auto;
  margin-top: 16px;
}
.holidayItem {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f8fafc;
  border-radius:  8px;
  margin-bottom: 8px;
}
.holidayItem:hover {
  background: #f1f5f9;
}
.holidayInfo {
  display: flex;
  align-items: center;
  gap: 12px;
}
.holidayEmoji {
  font-size:  1.5rem;
}
.holidayDate {
  font-size: 0.85rem;
  color: #64748b;
}
.holidayName {
  font-weight: 600;
  color:  #1e293b;
}
.deleteHolidayBtn {
  background: #fee2e2;
  color:  #dc2626;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 0.85rem;
}
.deleteHolidayBtn:hover {
  background: #fecaca;
}
.addHolidayForm {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap:  12px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 8px;
  margin-bottom: 16px;
}
.addHolidayForm label {
  font-size: 0.85rem;
  color: #64748b;
  margin-bottom: 4px;
  display: block;
}
.addHolidayForm input,
.addHolidayForm select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  font-size:  0.9rem;
}
.addHolidayForm .fullWidth {
  grid-column:  1 / -1;
}
.addHolidayBtn {
  grid-column: 1 / -1;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px;
  cursor: pointer;
  font-weight: 600;
}
.addHolidayBtn:hover {
  background: #2563eb;
}
.shift.backup-shift {
  animation: pulse-red 2s ease-in-out infinite;
}
@keyframes pulse-red {
  0%, 100% {
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
  }
  50% {
    box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
  }
}
/* ============================================
   COVERAGE SUMMARY BANNER
   ============================================ */
.coverage-banner {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px 20px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid #e2e8f0;
  border-radius: 14px;
  margin-bottom: 16px;
  box-shadow:  0 2px 8px rgba(0,0,0,0.04);
  overflow-x: auto;
  scrollbar-width: none;
}
.coverage-banner::-webkit-scrollbar {
  display: none;
}
.coverage-banner-title:: before {
  content: "üìä";
  font-size:  16px;
}
.coverage-banner.critical-state {
  background: #fef2f2;
  border: 2px solid #ef4444;
  animation: intense-shake 0.8s ease-in-out; /* Shakes on load/update */
  box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25);
}
.coverage-banner.critical-state .coverage-banner-title {
  color: #b91c1c;
  border-right-color: #fca5a5;
}
.coverage-chip.gap-alert .status-dot {
  background: white;
  box-shadow: 0 0 4px rgba(255,255,255,0.8);
  animation: pulse-white 1.5s infinite;
}
@keyframes pulse-white {
  0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
  70% { box-shadow: 0 0 0 6px rgba(255, 255, 255, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
}
.coverage-chip.gap-alert {
  background: #dc2626; 
  color: white; 
  border: 1px solid #b91c1c;
  font-weight: 800;
  animation: none; /* The banner shakes, chips stay solid */
}
.coverage-banner-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 800;
  color: #475569;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  padding-right: 16px;
  border-right: 2px solid #e2e8f0;
}
.coverage-chips {
  display: flex;
  gap: 10px;
  flex-wrap: nowrap;
  align-items: center;
}
.coverage-chip:hover {
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
.coverage-chip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border-radius: 10px;
  font-size:  13px;
  font-weight:  700;
  white-space: nowrap;
  transition: all 0.2s ease;
  cursor: default;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.coverage-chip.good {
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  color: #15803d;
  border: 1px solid #86efac;
}
.coverage-chip.warning {
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  color: #b45309;
  border: 1px solid #fcd34d;
}
.coverage-chip.critical {
  background: #fef2f2;
  color: #dc2626;
  border: 1px solid #fca5a5;
  animation: pulse-critical 2s ease-in-out infinite;
}
@keyframes pulse-critical {
  0%, 100% { box-shadow: 0 1px 3px rgba(220, 38, 38, 0.1); }
  50% { box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.15); }
}
@keyframes intense-shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
  20%, 40%, 60%, 80% { transform: translateX(4px); }
}
.coverage-chip .status-dot {
  width: 10px;
  height: 10px;
  border-radius:  50%;
  flex-shrink: 0;
}
.coverage-chip.good .status-dot { 
  background: linear-gradient(135deg, #22c55e, #16a34a);
  box-shadow: 0 0 6px rgba(34, 197, 94, 0.4);
}
.coverage-chip. warning .status-dot { 
  background: linear-gradient(135deg, #f59e0b, #d97706);
  box-shadow: 0 0 6px rgba(245, 158, 11, 0.4);
}
.coverage-chip.critical .status-dot { 
  background: linear-gradient(135deg, #ef4444, #dc2626);
  box-shadow: 0 0 6px rgba(239, 68, 68, 0.4);
}
.coverage-chip .channel-abbrev {
  font-weight: 800;
  font-size: 12px;
  letter-spacing: 0.3px;
}
.coverage-chip .coverage-count {
  font-weight: 600;
  opacity: 0.85;
  font-size: 13px;
}
/* Hidden state */
.coverage-banner.hidden {
  display: none;
}
/* All Good State */
.coverage-all-good {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #15803d;
  font-weight: 700;
  font-size: 14px;
  padding: 6px 14px;
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  border-radius: 10px;
  border: 1px solid #86efac;
}
.coverage-all-good:: before {
  content: "‚úì";
  font-weight: 900;
  font-size: 16px;
}
.coverage-all-good svg {
  width: 16px;
  height: 16px;
  fill: currentColor;
}
/* Captain shift styling */
.shift.captain-shift {
  position: relative;
}
.shift.captain-shift::before {
  content: "üëë";
  position: absolute;
  top: -8px;
  right: -8px;
  font-size: 14px;
}

/* ============================================
   MOBILE RESPONSIVENESS
   ============================================ */
@media (max-width: 768px) {
  /* Header adjustments */
  .header {
    padding: 0 12px;
    height: 56px;
    flex: 0 0 56px;
  }
  
  .hTitle {
    font-size: 14px;
  }
  
  .metaGroup {
    gap: 4px;
  }
  
  .pill {
    font-size: 9px;
    padding: 3px 6px;
  }
  
  .iconBtn {
    width: 32px;
    height: 32px;
  }
  
  .iconBtn svg {
    width: 16px;
    height: 16px;
  }
  
  /* Hide less important buttons on mobile */
  .seg, #btnMasterMode, #drawerToggle {
    display: none !important;
  }
  
  /* Navigation adjustments */
  .navGroup {
    padding: 8px 12px;
  }
  
  .navBtn {
    width: 28px;
    height: 28px;
  }
  
  /* Content area */
  .content {
    padding: 12px;
  }
  
  /* Calendar view - stack vertically */
  .calGrid {
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
  }
  
  .dayCol {
    min-width: 100%;
    max-width: 100%;
    margin-bottom: 12px;
  }
  
  /* Schedule view adjustments */
  .schedule-container {
    flex-direction: column;
  }
  
  .day-tabs {
    width: 100%;
    flex-direction: row;
    overflow-x: auto;
    overflow-y: hidden;
    gap: 4px;
    padding: 0 0 8px 0;
  }
  
  .day-tab {
    min-width: 100px;
    padding: 10px;
  }
  
  .day-tab .day-name {
    font-size: 13px;
  }
  
  .day-tab .day-date {
    font-size: 10px;
  }
  
  /* Shift cards - make them stack */
  .shifts-grid {
    grid-template-columns: 1fr;
  }
  
  .shift-card-b {
    padding: 12px;
  }
  
  /* Modals - full width on mobile */
  .modal {
    width: 95% !important;
    max-width: 95% !important;
    margin: 10px;
  }
  
  .overlay {
    padding: 0;
  }
  
  /* Drawer - full width on mobile */
  .drawer {
    width: 100%;
    right: -100%;
  }
  
  .drawer.open {
    right: 0;
  }
  
  /* Toast positioning */
  #toastHost {
    bottom: 12px;
    right: 12px;
    left: 12px;
  }
  
  .toast {
    min-width: 100%;
  }
  
  /* Selection bar */
  .selection-bar {
    flex-direction: column;
    gap: 8px;
    padding: 12px;
  }
  
  .sb-left, .sb-actions {
    width: 100%;
    justify-content: center;
  }
  
  .sb-actions {
    flex-wrap: wrap;
  }
  
  /* Coverage banner */
  .coverage-banner {
    flex-wrap: wrap;
    padding: 8px 12px;
  }
  
  .coverage-banner-title {
    font-size: 10px;
    margin-bottom: 4px;
    border-right: none;
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 4px;
    width: 100%;
  }
  
  .coverage-chips {
    flex-wrap: wrap;
    width: 100%;
  }
}

@media (max-width: 480px) {
  /* Extra small screens */
  .hTitle {
    display: none;
  }
  
  .dayCol {
    min-width: 100%;
  }
  
  .sc-time {
    font-size: 11px;
  }
  
  .sc-name {
    font-size: 14px;
  }
}
  
</style>
</head>
<!-- ‚úÖ COPY/PASTE: Replace your entire current <body> ... </body> says with this cleaned version.
     It keeps all your IDs/structure, fixes the broken nesting + removes the duplicate adminOverlay,
     and puts notifPanel in the right place (not trapped inside another div/overlay). -->
<body class="auth-pending">
  <!-- AUTH OVERLAY - Blocks all interaction until signed in -->
  <div id="authOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    z-index: 99999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 24px;
  ">
    <div style="width:64px; height:64px; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius:16px; display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:32px; box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);">M</div>
    <div style="font-size: 24px; font-weight: 700; color: #0f172a;">Scheduling Manager</div>
    <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">Sign in to continue</div>
    <div id="authLoginContainer">
      <div id="g_id_onload"
           data-client_id="63798769550-6hfbo9bodtej1i6k00ch0i4n523v02v0.apps.googleusercontent.com"
           data-callback="handleSignIn"
           data-auto_prompt="false"></div>
      <div class="g_id_signin" data-type="standard" data-size="large"></div>
    </div>
    <div style="margin-top: 32px; font-size: 11px; color: #94a3b8;">Musely Support Team</div>
  </div>
  <!-- HEADER -->
  <div class="header">
    <div class="hLeft">
      <div style="width:32px; height:32px; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:18px; margin-right:12px;">M</div>
      
      <div class="hTitle">Musely Scheduler</div>
      
      <div class="metaGroup" style="margin-left: 16px;">
        <div id="balancePill" class="pill balance" style="display:none;" onclick="openBalanceModal()">
            <span id="balanceText">PTO: --</span>
        </div>
        <div id="managerContextPill" class="pill" style="display:none; background:#7e22ce; color:#fff; border-color:#6b21a8;">Loading...</div>
      </div>
    </div>
    <div class="hRight">
      <div class="seg">
        <button class="segBtn active" id="btnSchedule" onclick="setView('schedule')">Schedule</button>
        <button class="segBtn" id="btnMetrics" onclick="setView('metrics')">Metrics</button>
      </div>
<div style="width: 1px; height: 24px; background: #e2e8f0;"></div>
      <!-- Agent Notifications Button (visible for agents) -->
      <button id="btnAgentNotif" class="iconBtn" type="button" title="My Notifications" onclick="openAgentNotifications()" style="position:relative; display:none;">
        <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
        <span id="agentNotifBadge" style="position:absolute; top:-4px; right:-4px; background:#ef4444; color:white; font-size:10px; font-weight:700; min-width:18px; height:18px; border-radius:9px; display:none; align-items:center; justify-content:center;">0</span>
      </button>
      <button id="btnNotif" class="iconBtn" type="button" title="Notifications">
        <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
        <span id="notifCount" class="hidden">0</span>
      </button>
<button id="btnAgentToggle" class="btn ghost" style="display:none; font-size:12px; border:1px solid #cbd5e1; margin-right:10px;" onclick="toggleAgentView()">Show Team</button>
      <button id="btnExport" type="button" class="iconBtn" title="Export Schedule to CSV" onclick="openExportModal()">
        <svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/></svg>
      </button>
      <button id="btnAdmin" type="button" class="iconBtn" title="Admin Settings" onclick="openAdminModal()">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      </button>
<button type="button" class="iconBtn" title="Refresh (clears cache)" onclick="forceRefresh()">
        <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
      </button>
      <button class="iconBtn" id="drawerToggle" title="Tools" onclick="toggleDrawer()">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5v-6h14v6zm0-8H5V5h14v6z"/></svg>
      </button>
      
      <button id="btnMasterMode" class="action-btn" onclick="toggleMasterMode()">Edit Master Schedule</button>
    </div>
  </div>
  <!-- NAV (below header like your UI) -->
  <div class="navGroup">
    <button class="navBtn" onclick="changeDay(-1)">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <div style="position:relative; overflow:hidden; width:32px; height:32px;">
      <input type="date" id="navDatePicker" style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0; cursor:pointer;" onchange="handleDateJump(this.value)">
      <button class="navBtn" style="pointer-events:none;">
          <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5z"/></svg>
      </button>
    </div>
    <button class="navBtn" onclick="changeDay(1)">
        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
    </button>
</div>
<div id="loadMoreControls" style="display:flex; gap:12px; align-items:center; padding:8px 16px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
  <button id="btnLoadPast" onclick="loadPastSchedule()" style="
    font-size:12px; 
    padding:8px 14px; 
    background:white; 
    border:1px solid #e2e8f0; 
    border-radius:6px; 
    cursor:pointer; 
    font-weight:600; 
    color:#475569;
    transition: all 0.2s;
  " onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6';" 
     onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#475569';">
    ‚Üê Load History
  </button>
  <span id="loadedRangeLabel" style="font-size:12px; color:#64748b; font-weight:500; padding:0 8px;">
    Today ‚Üí 14 days
  </span>
  <button id="btnLoadFuture" onclick="loadExtendedFuture()" style="
    font-size:12px; 
    padding:8px 14px; 
    background:white; 
    border:1px solid #e2e8f0; 
    border-radius:6px; 
    cursor:pointer; 
    font-weight:600; 
    color:#475569;
    transition: all 0.2s;
  " onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6';" 
     onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#475569';">
    Load Future ‚Üí
  </button>
</div>
<!-- Agent Quick Actions (shown only for agents) -->
<div id="agentQuickActions" style="display:none; gap:12px; align-items:center; padding:12px 16px; background:linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border-radius:10px; border:1px solid #bfdbfe; flex-wrap:wrap;">
  <!-- Schedule Range Info -->
  <div style="display:flex; align-items:center; gap:8px; padding:6px 12px; background:white; border-radius:6px; border:1px solid #e2e8f0;">
    <span style="font-size:20px;">üìÖ</span>
    <div>
      <div style="font-size:11px; color:#64748b; font-weight:500;">Viewing</div>
      <div id="agentRangeLabel" style="font-size:13px; color:#1e293b; font-weight:700;">Today ‚Üí 14 days</div>
    </div>
  </div>
  
  <!-- Load More Button for Agents -->
  <button id="btnAgentLoadMore" onclick="agentLoadMoreSchedule()" style="
    display:flex;
    align-items:center;
    gap:6px;
    font-size:12px; 
    padding:8px 14px; 
    background:white;
    color:#475569;
    border:1px solid #e2e8f0; 
    border-radius:6px; 
    cursor:pointer; 
    font-weight:600;
    transition: all 0.2s;
  " onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6';" 
     onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#475569';">
    üìÜ Load 30 Days
  </button>
  
  <!-- Divider -->
  <div style="width:1px; height:24px; background:#cbd5e1;"></div>
  
  <!-- Future Time Off Request -->
  <button onclick="openFutureTimeOffModal()" style="
    display:flex;
    align-items:center;
    gap:8px;
    font-size:13px; 
    padding:10px 16px; 
    background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color:white;
    border:none; 
    border-radius:8px; 
    cursor:pointer; 
    font-weight:600;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(59,130,246,0.3);
  " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.4)';" 
     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59,130,246,0.3)';">
    ‚úã Request Time Off
  </button>
</div>
  <!-- MAIN -->
  <div class="main">
    <div class="content">
        <div id="coverageBanner" class="coverage-banner hidden">
  <div class="coverage-banner-title">üìä Coverage</div>
  <div id="coverageChips" class="coverage-chips"></div>
</div>
      <div id="scheduleView" class="schedule-container">
  <div class="day-tabs" id="dayTabs"></div>
  <div class="day-content">
    <div class="day-content-header">
      <div>
        <h2 id="viewDayTitle" style="margin:0; font-size:20px; font-weight:800;"></h2>
        <div id="viewDayStats" style="font-size:12px; opacity:0.7; margin-top:4px;"></div>
      </div>
    </div>
    <div id="dayContentBody" class="day-content-body">
      <div id="loadingPlaceholder" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#94a3b8;">
        <div style="width:40px; height:40px; border:3px solid #e2e8f0; border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <div style="margin-top:16px; font-size:14px;">Loading schedule...</div>
      </div>
    </div>
  </div>
</div>
<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
<div id="masterView" style="display:none; height:100%; overflow-y:auto;"></div>
      <div id="metricsView" style="display:none; height:100%;">
        <div class="metricsWrap">
          <div class="metricsLeft">
            <div class="metricsTop">
              <div style="font-weight:800; color:#0f172a;">Agent Metrics</div>
              <input id="metricsSearch" class="qrSearch" placeholder="Search agent..." oninput="renderMetricsList()" />
            </div>
            <div id="metricsList" class="metricsList"></div>
          </div>
          <div id="metricsDrawer" class="metricsDrawer">
            <div class="metricsDrawerHead">
              <div style="font-weight:800;">Profile</div>
              <button type="button" class="btn ghost" style="padding:6px 10px;" onclick="closeMetricsDrawer()">‚úï</button>
            </div>
            <div class="metricsDrawerBody">
              <div id="mProfLoader" style="color:#64748b; font-size:13px; padding:10px 0;">Select an agent to load metrics.</div>
              <div id="mProfContent" style="display:none; text-align:center;">
                <img id="mAvatar" src="" style="width:72px; height:72px; border-radius:50%; background:#e2e8f0; margin:10px auto 10px; border:3px solid #fff; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                <div id="mName" style="font-size:18px; font-weight:900; color:#0f172a;"></div>
                <div id="mEmail" style="font-size:12px; color:#64748b; margin-bottom:14px;"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; text-align:left; margin: 0 auto; max-width: 360px;">
                  <div style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd;">
                    <div style="font-size:10px; font-weight:800; color:#0369a1;">OPEN</div>
                    <div id="mOpen" style="font-size:18px; font-weight:900; color:#0284c7;">--</div>
                  </div>
                  <div style="background:#f0fdf4; padding:10px; border-radius:8px; border:1px solid #bbf7d0;">
                    <div style="font-size:10px; font-weight:800; color:#15803d;">SOLVED (7d)</div>
                    <div id="mSolved" style="font-size:18px; font-weight:900; color:#16a34a;">--</div>
                  </div>
                  <div style="background:#fff7ed; padding:10px; border-radius:8px; border:1px solid #fed7aa;">
                    <div style="font-size:10px; font-weight:800; color:#c2410c;">CSAT (7d)</div>
                    <div id="mCSAT" style="font-size:18px; font-weight:900; color:#ea580c;">--</div>
                    <div id="mCSATDetail" style="font-size:9px; color:#9a3412; margin-top:2px;"></div>
                  </div>
                </div>
                <div style="margin:14px auto 0; max-width: 360px; text-align:left;">
                  <div style="background:#fdf2f8; padding:12px; border-radius:12px; border:1px solid #fbcfe8;">
                    <div style="font-size:10px; font-weight:900; color:#be185d; text-transform:uppercase;">Role</div>
                    <div id="mRole" style="font-size:14px; font-weight:800; color:#db2777; margin-top:6px;">--</div>
                  </div>
                  <div style="margin-top:10px; font-size:11px; color:#94a3b8;">Last Login: <span id="mLogin">--</span></div>
                  <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">
                    <a id="mOpenTicketsLink" class="btn ghost" target="_blank" style="text-decoration:none;">View Open Tickets</a>
                    <a id="mBadCsatLink" class="btn ghost" target="_blank" style="text-decoration:none;">Find Bad CSAT Tickets</a>
                  </div>
                  <div style="margin-top:10px; font-size:11px; color:#64748b;">Tip: use ‚ÄúFind Bad CSAT Tickets‚Äù to send examples to the agent for review.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Old skeleton view - replaced with inline loading spinner -->
      <div id="skeletonView" class="skel-wrapper" style="display:none !important;">
        <div class="skel-col"><div class="skel-anim skel-head"></div><div class="skel-anim skel-card"></div><div class="skel-anim skel-card"></div></div>
        <div class="skel-col"><div class="skel-anim skel-head"></div><div class="skel-anim skel-card"></div><div class="skel-anim skel-card"></div></div>
        <div class="skel-col"><div class="skel-anim skel-head"></div><div class="skel-anim skel-card"></div><div class="skel-anim skel-card"></div></div>
        <div class="skel-col"><div class="skel-anim skel-head"></div><div class="skel-anim skel-card"></div><div class="skel-anim skel-card"></div></div>
      </div>
    </div>
    <!-- RIGHT DRAWER -->
    <div id="rightDrawer" class="drawer">
      <div class="drawerHead" style="height: auto; flex-direction: column; gap: 10px; padding-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
          <span>Tools</span>
          <div class="seg">
            <button class="segBtn active" id="btnModeQuick" onclick="setMode('quick')">Quick</button>
            <button class="segBtn" id="btnModeTeam" onclick="setMode('team')">Channel</button>
          </div>
        </div>
      </div>
      <div class="drawerBody" id="drawerQuick">
        <div class="filter-card">
          <div class="filter-header">‚ö° Quick Filters</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn-pill" onclick="filterToday()">Today</button>
            <button class="btn-pill" style="background:#fef2f2; color:#ef4444;" onclick="resetAllFilters()">Reset</button>
          </div>
        </div>
        <div class="filter-card" style="border-left: 4px solid #3b82f6;">
          <div class="filter-header">üë• Channel View</div>
          <select id="teamDropdown" onchange="updateTeamAgentList()" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:12px;">
            <option value="">Select Team...</option>
          </select>
          <div id="teamAgentList" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
        </div>
        <div style="margin-top:20px; border-top:1px solid #f1f5f9; padding-top:16px;">
          <label style="font-size:11px; color:#94a3b8; font-weight:700;">SEARCH ALL PEOPLE</label>
          <input class="qrSearch" id="qrSearch" placeholder="Search name..." oninput="renderQuickRail()" />
          <div id="qrList" style="display:flex; flex-direction:column; gap:6px;"></div>
        </div>
      </div>
      <div class="drawerBody hidden" id="drawerTeam">
        <p style="font-size:13px; color:#64748b; margin-bottom:16px;">Select shifts in the calendar, then apply bulk changes.</p>
        <div style="margin-bottom:8px; font-size:12px; font-weight:700; color:#0f172a;">SELECTED: <span id="tpCount" style="color:#3b82f6;">0</span></div>
        <div style="margin-bottom:16px;">
          <label>Assign To</label>
          <select id="tpPerson"></select>
        </div>
        <button class="btn primary" style="width:100%;" onclick="applyBatch()">Apply Changes</button>
        <button class="btn ghost" style="width:100%; margin-top:12px;" onclick="clearTeamSelection()">Clear Selection</button>
      </div>
    </div>
  </div>
  <!-- SELECTION BAR -->
  <div id="selectionBar" class="selection-bar">
    <div class="sb-left">
      <div class="sb-count"><span id="sbCount">0</span> selected</div>
      <div style="height: 20px; width: 1px; background: rgba(255,255,255,0.2);"></div>
      <button class="sb-btn" id="btnSelectSimilar" onclick="selectSimilarVisible()">Select All Visible for this Person</button>
    </div>
    <div class="sb-actions">
      <button class="sb-btn" onclick="clearTeamSelection()">Cancel</button>
      <button class="sb-btn primary" onclick="openBatchEditModal()">Edit / Move</button>
      <button class="sb-btn danger" onclick="batchMarkOff()">Mark OFF</button>
    </div>
  </div>
  <!-- EDIT SHIFT MODAL -->
  <div id="editShiftModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:8px; width:300px; box-shadow:0 4px 10px rgba(0,0,0,0.2);">
      <h3 style="margin-top:0; color:#333;">Edit Shift</h3>
      <div style="margin-bottom:15px;">
        <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Employee</label>
        <input type="text" id="modalEmployee" disabled style="width:100%; padding:8px; border:1px solid #eee; background:#f9f9f9; border-radius:4px;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Day</label>
        <input type="text" id="modalDay" disabled style="width:100%; padding:8px; border:1px solid #eee; background:#f9f9f9; border-radius:4px;">
      </div>
      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <div style="flex:1;">
          <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Start</label>
          <input type="time" id="modalStart" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="flex:1;">
          <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">End</label>
          <input type="time" id="modalEnd" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
      </div>
      <input type="hidden" id="modalOrigStart">
      <input type="hidden" id="modalOrigEnd">
      <div style="margin-bottom:15px; margin-top:10px;">
        <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Team</label>
        <select id="modalTeam" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; background:#fff;"></select>
      </div>
      <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <button type="button" onclick="deleteShift()" style="background:#ffebee; color:#c62828; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">Delete</button>
        <div style="display:flex; gap:10px;">
          <button type="button" onclick="closeModal()" style="background:#f5f5f5; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">Cancel</button>
          <button type="button" onclick="saveShift()" style="background:#1967d2; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">Save</button>
        </div>
      </div>
    </div>
  </div>
  <!-- OVERLAYS -->
  <div id="modalOverlay" class="overlay" onclick="if(event.target===this) closeModal()">
    <div class="modal" style="width: 440px; border-radius: 16px;">
      <div class="mHead" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0;">
        <span class="mTitle" style="color: white;">üîÑ Replace Coverage</span>
        <button type="button" class="btn ghost" style="padding:6px 12px; color:white; border-color:rgba(255,255,255,0.3);" onclick="closeModal()">‚úï</button>
      </div>
      <div class="mBody" style="padding: 20px;">
        <div style="margin-bottom:16px; padding:12px; background:#f0f9ff; border-radius:10px; border:1px solid #bae6fd;" id="mSub"></div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase;">Replace With</label>
          <select id="mNewPerson" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:10px; font-size:14px;"></select>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase;">Notification</label>
          <select id="mNotify" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:10px; font-size:14px;">
            <option value="defer">üìã Add to Pending (Send Later)</option>
            <option value="send">üì≤ Send Notification Now</option>
          </select>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase;">Notes (Optional)</label>
          <textarea id="mNotes" placeholder="Add any notes about this coverage change..." style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:10px; font-size:14px; min-height:70px; resize:vertical;"></textarea>
        </div>
      </div>
      <div class="mFoot" style="justify-content: space-between; padding:16px 20px; background:#f8fafc; border-radius:0 0 16px 16px;">
        <button id="actionBtn" class="btn ghost" style="color:#ef4444; border-color:#fecaca; background:#fef2f2;" onclick="handleSaveClick()">‚õî Mark Off</button>
        <div style="display:flex; gap:10px;">
          <button class="btn ghost" onclick="closeModal()">Cancel</button>
          <button class="btn primary" id="mSave" onclick="saveReplace()">üíæ Save Changes</button>
        </div>
      </div>
    </div>
  </div>
<!-- Holiday Management Modal -->
<div id="holidayModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeHolidayModal()">
  <div class="modal" style="width: 500px;">
    <div class="mHead">
      <span class="mTitle">üéÑ Manage Holidays</span>
      <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closeHolidayModal()">‚úï</button>
    </div>
    
    <div class="mBody">
      <!-- Add Holiday Form -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:16px; background:#f8fafc; border-radius:10px; margin-bottom:20px;">
        <div>
          <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">DATE</label>
          <input type="date" id="holidayDate" style="width:100%; padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;" />
        </div>
        <div>
          <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">HOLIDAY NAME</label>
          <input type="text" id="holidayName" placeholder="e.g., Christmas Day" style="width:100%; padding:8px 12px; border:1px solid #e2e8f0; border-radius: 6px; font-size:14px;" />
        </div>
        <div>
          <label style="font-size:11px; font-weight:600; color:#64748b; display: block; margin-bottom:4px;">THEME</label>
          <select id="holidayTheme" style="width:100%; padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
            <option value="christmas">üéÑ Christmas</option>
            <option value="newyear">üéÜ New Year</option>
            <option value="july4th">üá∫üá∏ July 4th</option>
            <option value="halloween">üéÉ Halloween</option>
            <option value="thanksgiving">ü¶É Thanksgiving</option>
            <option value="valentines">üíñ Valentine's</option>
            <option value="stpatricks">üíö St. Patrick's</option>
            <option value="easter">üê£ Easter</option>
            <option value="default">‚≠ê Generic</option>
          </select>
        </div>
        <div>
          <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">EMOJI</label>
          <select id="holidayEmoji" style="width:100%; padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
            <option value="üéÑ">üéÑ</option>
            <option value="üéÜ">üéÜ</option>
            <option value="üá∫üá∏">üá∫üá∏</option>
            <option value="üéÉ">üéÉ</option>
            <option value="ü¶É">ü¶É</option>
            <option value="üíñ">üíñ</option>
            <option value="üíö">üíö</option>
            <option value="üê£">üê£</option>
            <option value="‚≠ê">‚≠ê</option>
          </select>
        </div>
        <button onclick="addHoliday()" style="grid-column: 1 / -1; background:#3b82f6; color: white; border:none; border-radius:8px; padding:12px; font-weight:600; cursor: pointer; font-size:14px;">
          + Add Holiday
        </button>
      </div>
      
      <!-- Holiday List -->
      <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:12px;">SCHEDULED HOLIDAYS</label>
      <div id="holidayList" style="max-height:250px; overflow-y:auto;">
        <div style="text-align:center; color:#94a3b8; padding:20px;">Loading... </div>
      </div>
    </div>
  </div>
</div>
  <div id="profileOverlay" class="overlay" onclick="if(event.target===this) closeProfile()">
    <div class="modal" style="width: 400px;">
      <div class="mHead" style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
        <span class="mTitle">Agent Profile</span>
        <button type="button" class="btn ghost" style="padding:4px 8px;" onclick="closeProfile()">‚úï</button>
      </div>
      <div class="mBody" style="text-align: center; padding: 30px;">
        <div id="profLoader" style="color: #64748b; font-size: 13px;"><div>Fetching live metrics from Zendesk...</div></div>
        <div id="profContent" style="display:none;">
          <img id="pAvatar" src="" style="width: 80px; height: 80px; border-radius: 50%; background: #e2e8f0; margin-bottom: 15px; border: 3px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          <h2 id="pName" style="margin: 0 0 5px 0; font-size: 20px; color: #0f172a;">Name</h2>
          <div id="pEmail" style="font-size: 12px; color: #64748b; margin-bottom: 20px;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c7a2aaa6aeab87a2bfa6aab7aba2e9a4a8aa">[email&#160;protected]</a></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: left;">
            <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; border: 1px solid #bae6fd;">
              <div style="font-size: 10px; font-weight: 700; color: #0369a1;">OPEN</div>
              <div id="pTickets" style="font-size: 20px; font-weight: 800; color: #0284c7;">--</div>
            </div>
            <div style="background: #f0fdf4; padding: 10px; border-radius: 8px; border: 1px solid #bbf7d0;">
              <div style="font-size: 10px; font-weight: 700; color: #15803d;">SOLVED (7d)</div>
              <div id="pSolved" style="font-size: 20px; font-weight: 800; color: #16a34a;">--</div>
            </div>
            <div style="background: #fff7ed; padding: 10px; border-radius: 8px; border: 1px solid #fed7aa;">
              <div style="font-size: 10px; font-weight: 700; color: #c2410c;">CSAT (7d)</div>
              <div id="pCSAT" style="font-size: 20px; font-weight: 800; color: #ea580c;">--</div>
            </div>
          </div>
          <div style="margin-top: 20px; font-size: 11px; color: #94a3b8;">Last Login: <span id="pLogin">--</span></div>
        </div>
      </div>
    </div>
  </div>
  <div id="masterOverlay" class="overlay" onclick="if(event.target===this) closeMasterModal()">
    <div class="modal">
      <div class="mHead">
        <span class="mTitle">Edit Master Template</span>
        <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closeMasterModal()">‚úï</button>
      </div>
      <div class="mBody">
        <div style="margin-bottom:16px; font-size:13px; color:#64748b;" id="mstSub"></div>
        <input type="hidden" id="mstPerson">
        <input type="hidden" id="mstDay">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
          <div><label>Start Time (PST)</label><input id="mstStart" placeholder="e.g. 8:00 AM"></div>
          <div><label>End Time (PST)</label><input id="mstEnd" placeholder="e.g. 5:00 PM"></div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
          <div><label>Team</label><select id="mstTeam"></select></div>
          <div><label>Role</label><select id="mstRole"></select></div>
        </div>
        <div style="background:#f0f9ff; padding:12px; border-radius:8px; border:1px solid #bae6fd; font-size:12px; color:#0369a1; display:flex; gap:10px; align-items:start;">
          <input type="checkbox" id="mstSync" style="width:auto; margin-top:2px;">
          <span><b>Sync to LIVE Schedule?</b><br>Check this to update all future shifts starting <b>tomorrow</b>. Leave unchecked to only update the template for new generations.</span>
        </div>
      </div>
      <div class="mFoot">
        <button class="btn ghost" onclick="closeMasterModal()">Cancel</button>
        <button class="btn primary" onclick="saveMasterEdit()">Save Changes</button>
      </div>
    </div>
  </div>
  <div id="pickerOverlay" class="overlay" onclick="if(event.target===this) closePicker()">
    <div class="modal" style="width: 500px; height: 600px; display:flex; flex-direction:column;">
      <div class="mHead">
        <span class="mTitle">Filter People</span>
        <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closePicker()">‚úï</button>
      </div>
      <div style="padding:16px; border-bottom:1px solid #e2e8f0; display:flex; gap:12px;">
        <input id="pickerSearch" placeholder="Search..." oninput="renderPickerList()" style="flex:1;">
        <button class="btn ghost" onclick="pickerToggleAll(true)">All</button>
        <button class="btn ghost" onclick="pickerToggleAll(false)">None</button>
      </div>
      <div id="pickerList" class="pickerList" style="flex:1; overflow-y:auto; padding:8px;"></div>
      <div class="mFoot"><button class="btn primary" onclick="applyPicker()">Apply Filter</button></div>
    </div>
  </div>
  <!-- ‚úÖ Admin Overlay (ONLY ONCE) -->
  <div id="adminOverlay" class="overlay" style="display:none;" onclick="if(event.target===this) closeAdminModal()">
    <div class="modal" style="width: 500px;">
      <div class="mHead">
        <span class="mTitle">Admin Tools</span>
        <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closeAdminModal()">‚úï</button>
      </div>
      <div class="mBody" style="background: #f8fafc;">
  
  <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
    <div style="display:flex; align-items:center; gap:16px;">
      <div class="tool-icon" style="background:#f1f5f9; color:#475569;">üìú</div>
      <div>
        <div class="tool-title">Audit Log</div>
        <div class="tool-desc">View history & EOD reports</div>
      </div>
    </div>
    <div style="display:flex; gap:8px;">
        <button class="btn ghost" style="font-size:11px; padding:6px 12px;" onclick="logEndOfDaySummary()">üìù Log EOD</button>
        <button class="btn ghost" style="font-size:11px; padding:6px 12px;" onclick="openAuditLog()">View</button>
    </div>
  </div>
  <div class="tool-grid">
    <div class="tool-card">
      <div style="display:flex; justify-content:space-between; width:100%;">
          <div class="tool-icon" style="background:#ffedd5; color:#c2410c;">‚è≥</div>
          <button id="btnReviewQueue" onclick="openTimeOffQueue()" class="btn primary" style="font-size:11px; padding:4px 10px; height:24px;">Queue</button>
      </div>
      <div>
        <div class="tool-title">Time Off Requests</div>
        <div class="tool-desc">Approve or deny agent time off requests.</div>
      </div>
    </div>
    <div class="tool-card">
      <div style="display:flex; justify-content:space-between; width:100%;">
          <div class="tool-icon" style="background:#dcfce7; color:#15803d;">üí∞</div>
          <button onclick="openBalanceModal()" class="btn ghost" style="font-size:11px; padding:4px 10px; height:24px;">Manage</button>
      </div>
      <div>
        <div class="tool-title">Accrued Hours</div>
        <div class="tool-desc">Adjust PTO balances for agents.</div>
      </div>
    </div>
    <div class="tool-card">
      <div style="display:flex; justify-content:space-between; width:100%;">
          <div class="tool-icon" style="background:#dbeafe; color:#1e40af;">üéÑ</div>
          <button onclick="openHolidayModal()" class="btn ghost" style="font-size:11px; padding:4px 10px; height:24px;">Edit</button>
      </div>
      <div>
        <div class="tool-title">Company Holidays</div>
        <div class="tool-desc">Set holidays to highlight them on the schedule.</div>
      </div>
    </div>
    <div class="tool-card">
      <div style="display:flex; justify-content:space-between; width:100%;">
          <div class="tool-icon" style="background:#f3e8ff; color:#7e22ce;">üõ°Ô∏è</div>
          <button onclick="openStaffingModal()" class="btn ghost" style="font-size:11px; padding:4px 10px; height:24px;">Rules</button>
      </div>
      <div>
        <div class="tool-title">Staffing Rules</div>
        <div class="tool-desc">Set minimum agents per channel.</div>
      </div>
    </div>
  </div>
  <div class="danger-section">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <div style="font-size:12px; font-weight:700; color:#ef4444;">Danger Zone</div>
            <div style="font-size:11px; color:#94a3b8;">Bulk delete or regenerate schedule.</div>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn" style="font-size:11px; color:#ef4444; background:#fff; border:1px solid #fecaca;" onclick="wipeFutureSchedule()">Wipe Future</button>
            <button class="btn" style="font-size:11px; color:#ef4444; background:#fff; border:1px solid #fecaca;" onclick="regenerateAllSchedule()">Regenerate</button>
        </div>
    </div>
  </div>
</div>
        <label style="font-size:10px; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:12px; display:block;">Generation Tools</label>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button type="button" class="btn ghost" style="border-color:#3b82f6; color:#3b82f6; padding:10px;" onclick="runGenerate()">üìÖ Generate 14 Days</button>
            <button type="button" class="btn ghost" style="padding:10px;" onclick="runArchive()">üì¶ Archive Old Data</button>
          </div>
          <button type="button" class="btn primary" style="width:100%; padding:12px;" onclick="runBoth()">‚ö° Full Sync (Generate + Archive)</button>
        </div>
      </div>
      <div id="staffingModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeStaffingModal()">
  <div class="modal" style="width: 520px; border-radius: 16px;">
    <div class="mHead" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; border-radius: 16px 16px 0 0;">
      <span class="mTitle" style="color: white;">üõ°Ô∏è Staffing Requirements</span>
      <button type="button" class="btn ghost" style="color:white; border-color:rgba(255,255,255,0.3);" onclick="closeStaffingModal()">‚úï</button>
    </div>
    <div class="mBody" style="padding: 20px;">
      <div style="background:#f8fafc; padding:16px; border-radius:12px; margin-bottom:16px; border:1px solid #e2e8f0;">
        <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:10px; display:block;">Add New Rule</label>
        <div style="display:grid; grid-template-columns:2fr 1fr 1fr; gap:8px; margin-bottom:10px;">
          <select id="ruleTeam" style="padding:10px; border:2px solid #e2e8f0; border-radius:8px;"><option value="">Select Channel...</option></select>
          <select id="ruleDay" style="padding:10px; border:2px solid #e2e8f0; border-radius:8px;">
            <option value="All">Every Day</option>
            <option value="Weekday">Mon-Fri</option>
            <option value="Weekend">Sat-Sun</option>
            <option value="Mon">Mon</option><option value="Tue">Tue</option><option value="Wed">Wed</option>
            <option value="Thu">Thu</option><option value="Fri">Fri</option><option value="Sat">Sat</option><option value="Sun">Sun</option>
          </select>
          <input id="ruleMin" type="number" placeholder="Min #" style="padding:10px; border:2px solid #e2e8f0; border-radius:8px; text-align:center;">
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:12px;">
          <select id="ruleTimeBlock" style="padding:10px; border:2px solid #e2e8f0; border-radius:8px;" onchange="toggleCustomHours()">
            <option value="all">All Hours</option>
            <option value="morning">Morning (6a-12p)</option>
            <option value="afternoon">Afternoon (12p-6p)</option>
            <option value="evening">Evening (6p-10p)</option>
            <option value="custom">Custom Hours</option>
          </select>
          <input id="ruleStartHour" type="number" min="0" max="23" placeholder="Start Hr" style="padding:10px; border:2px solid #e2e8f0; border-radius:8px; display:none; text-align:center;">
          <input id="ruleEndHour" type="number" min="0" max="23" placeholder="End Hr" style="padding:10px; border:2px solid #e2e8f0; border-radius:8px; display:none; text-align:center;">
        </div>
        <button class="btn primary" style="width:100%; padding:12px;" onclick="addRule()">+ Add Requirement</button>
      </div>
      
      <div style="background:#f0fdf4; padding:12px; border-radius:10px; margin-bottom:16px; border:1px solid #86efac;">
        <div style="font-size:11px; font-weight:700; color:#15803d; margin-bottom:8px;">‚ö° Quick Add</div>
        <div style="display:flex; flex-wrap:wrap; gap:6px;">
          <button class="btn ghost" style="font-size:11px; padding:6px 10px; background:#fff;" onclick="addQuickRule('Live Chat', 3, 'morning')">LC 3+ (AM)</button>
          <button class="btn ghost" style="font-size:11px; padding:6px 10px; background:#fff;" onclick="addQuickRule('Phone', 2, 'all')">Phone 2+</button>
          <button class="btn ghost" style="font-size:11px; padding:6px 10px; background:#fff;" onclick="addQuickRule('MD Support', 1, 'all')">MD 1+</button>
        </div>
      </div>
      
      <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:8px; display:block;">Active Rules</label>
      <div id="ruleList" style="max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:8px;"></div>
    </div>
  </div>
</div>
  <!-- ‚úÖ Audit Overlay (sibling, not nested) -->
  <div id="auditOverlay" class="overlay" style="display:none;" onclick="if(event.target===this) closeAuditModal()">
    <div class="modal" style="width: 750px; max-width: 90vw; height: 80vh; display:flex; flex-direction:column; border-radius: 16px;">
      <div class="mHead" style="background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); color: white; border-radius: 16px 16px 0 0;">
        <span class="mTitle" style="color: white;">üìã Audit History</span>
        <button type="button" class="btn ghost" style="padding:6px 12px; color:white; border-color:rgba(255,255,255,0.3);" onclick="closeAuditModal()">‚úï</button>
      </div>
      <div class="mBody" style="flex:1; overflow:hidden; padding:0; display:flex; flex-direction:column;">
        <div style="background:#f0f9ff; border-bottom:1px solid #bae6fd; padding:12px 16px; font-size:12px; color:#0369a1; display:flex; justify-content:space-between; align-items:center;">
          <span>üìä Showing last 50 actions (newest first)</span>
          <button class="btn ghost" style="font-size:11px; padding:4px 10px;" onclick="openAuditLog()">üîÑ Refresh</button>
        </div>
        <div style="flex:1; overflow-y:auto;">
          <table class="audit-table">
            <thead>
              <tr>
                <th style="width:130px;">Time</th>
                <th style="width:110px;">Manager</th>
                <th style="width:90px;">Action</th>
                <th style="width:110px;">Target</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="auditList">
              <tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">Loading history...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Master Context -->
  <div id="masterContextOverlay" class="overlay" style="display:none; z-index:200;">
    <div class="modal" style="width: 400px;">
      <div class="mHead"><span class="mTitle">Select Manager Context</span></div>
      <div class="mBody">
        <p style="font-size:13px; color:#64748b; margin-bottom:12px;">
          You are logged in as <b>Master Admin</b>.<br>
          Please select which Manager's schedule you wish to view/manage.
        </p>
        <label>Available Managers</label>
        <select id="masterManagerDropdown" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
          <option value="" disabled selected>Loading...</option>
        </select>
      </div>
      <div class="mFoot" style="justify-content:flex-end;">
        <button type="button" class="btn primary" id="btnConfirmManager" onclick="confirmManagerSelection()">Load Dashboard</button>
      </div>
    </div>
  </div>
  <!-- ‚úÖ Notifications Panel (NOT inside any overlay/div) -->
  <div id="notifPanel"
       style="display:none; position:fixed; top:74px; right:20px; width:360px; background:#fff; border:1px solid #e2e8f0; box-shadow:0 10px 25px rgba(0,0,0,0.1); border-radius:16px; z-index:3001; overflow:hidden;"
       onclick="event.stopPropagation()">
    <div class="mHead">
      <span class="mTitle">Notifications</span>
      <div style="display:flex; gap:8px;">
        <button type="button" class="btn ghost" style="padding:4px 8px; font-size:11px;" onclick="clearNotifications()">Clear</button>
        <button type="button" class="btn primary" style="padding:4px 8px; font-size:11px;" onclick="sendAllPending()">Send</button>
      </div>
    </div>
    <div id="notifList" style="max-height:300px; overflow-y:auto; padding:10px;"></div>
  </div>
  <div id="toastHost"></div>
  <div id="loader" class="hidden"></div>
  <!-- Accrued Hours Modal -->
<div id="balanceModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeBalanceModal()">
  <div class="modal" style="width: 500px;">
    <div class="mHead">
      <span class="mTitle">‚è∞ PTO Balance</span>
      <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closeBalanceModal()">‚úï</button>
    </div>
    
    <div class="mBody">
      <!-- Agent View -->
      <div id="agentBalanceView" style="display:none;">
        <div style="text-align: center; margin-bottom: 24px;">
          <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #86efac; border-radius: 20px; padding: 32px 40px; display: inline-block; box-shadow: 0 4px 16px rgba(34, 197, 94, 0.15);">
            <div style="font-size: 11px; font-weight: 700; color: #15803d; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
              Available PTO
            </div>
            <div id="agentPtoBalance" style="font-size: 56px; font-weight: 900; color: #16a34a; line-height: 1;">
              --
            </div>
            <div style="font-size: 14px; color: #22c55e; margin-top: 8px; font-weight: 600;">hours</div>
          </div>
        </div>
        
        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; font-size: 13px; color: #64748b;">
          <div style="font-weight: 700; color: #334155; margin-bottom: 10px;">üìä How PTO Works</div>
          <ul style="margin: 0; padding-left: 18px; line-height: 1.8;">
            <li><strong>Weekly Accrual:</strong> Earn 1.5 hours per week worked</li>
            <li><strong>Holiday Bonus:</strong> Work on a company holiday = earn 50% bonus hours added to PTO</li>
            <li><strong>Usage:</strong> Deducted when time-off requests are approved</li>
          </ul>
        </div>
      </div>
      
      <!-- Manager View -->
      <div id="managerBalanceView" style="display:none;">
        <div style="margin-bottom: 16px;">
          <input type="text" id="balanceSearch" placeholder="Search agents..." oninput="filterBalanceList()" style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
        </div>
        
        <div id="balanceList" style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;">
          <!-- Will be populated by JS -->
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Agent Overlay - REDESIGNED -->
<div id="agentOverlay" class="overlay" style="display:none;" onclick="if(event.target===this) closeAgentModal()">
  <div class="modal" style="width: 460px; border-radius: 20px;">
    <!-- Gradient Header -->
    <div class="mHead" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom: none;">
      <span class="mTitle" style="color: white;">üìÖ Manage Your Shift</span>
      <span class="close" onclick="closeAgentModal()">&times;</span>
    </div>
    <div class="mBody" style="padding: 24px;">
      <!-- Shift Details Card -->
      <div id="agShiftDetails" style="
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #3b82f6;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        margin-bottom: 24px;
        font-size: 16px;
        font-weight: 700;
        color: #1e40af;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      "></div>
      <!-- Action Selection Buttons -->
      <div id="agActionSelect" style="display: flex; flex-direction: column; gap: 16px;">
        
        <!-- Swap/Give Away Button -->
        <button class="action-card" onclick="showAgentForm('swap')" style="
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 20px;
          border: 2px solid #e2e8f0;
          border-radius: 16px;
          background: white;
          cursor: pointer;
          transition: all 0.3s ease;
          text-align: left;
        " onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(102, 126, 234, 0.15)';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
          <div style="
            width: 56px;
            height: 56px;
            border-radius: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
          ">üîÑ</div>
          <div style="flex: 1;">
            <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">
              Swap or Give Away
            </div>
            <div style="font-size: 13px; color: #64748b;">
              Trade this shift with a coworker or give it away
            </div>
          </div>
        </button>
        <!-- Time Off Button -->
        <button class="action-card" onclick="showAgentForm('timeoff')" style="
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 20px;
          border: 2px solid #e2e8f0;
          border-radius: 16px;
          background: white;
          cursor: pointer;
          transition: all 0.3s ease;
          text-align: left;
        " onmouseover="this.style.borderColor='#f87171'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(248, 113, 113, 0.15)';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
          <div style="
            width: 56px;
            height: 56px;
            border-radius: 14px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
          ">‚õî</div>
          <div style="flex: 1;">
            <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">
              Request Time Off
            </div>
            <div style="font-size: 13px; color: #64748b;">
              Request time off or personal time
            </div>
          </div>
        </button>
      </div>
      <!-- Swap Form (Hidden by Default) -->
      <div id="agFormSwap" style="display:none; animation: slideIn 0.3s ease;">
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
            Swap with / Give to
          </label>
          <select id="agSwapPerson" style="
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.2s;
          " onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';"></select>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
            Note (Optional)
          </label>
          <input type="text" id="agSwapNote" placeholder="e.g., I owe you one!" style="
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.2s;
          " onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
        </div>
        <div style="display: flex; gap: 12px;">
          <button class="btn ghost" onclick="resetAgentModal()" style="flex: 1; padding: 14px;">
            ‚Üê Back
          </button>
          <button onclick="submitSwap()" style="
            flex: 2;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
          " onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='translateY(0)';">
            Send Request ‚Üí
          </button>
        </div>
      </div>
    
      <!-- Time Off Form (Hidden by Default) -->
      <div id="agFormTimeOff" style="display:none; animation: slideIn 0.3s ease;">
        
        <!-- PTO Balance Display -->
        <div style="text-align:center; padding:16px; background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius:12px; border:2px solid #86efac; margin-bottom:16px;">
          <div style="font-size:11px; font-weight:700; color:#15803d; text-transform:uppercase; letter-spacing:0.5px;">Your PTO Balance</div>
          <div id="agPtoHours" style="font-size:32px; font-weight:900; color:#16a34a; margin:4px 0;">--</div>
          <div style="font-size:11px; color:#22c55e;">hours available</div>
        </div>
        
        <!-- Type Selection - Compact Cards -->
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">Request Type</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <label class="type-card" onclick="this.querySelector('input').checked=true; updateTypeSelection();" style="display:flex; align-items:center; gap:10px; padding:12px; border:2px solid #e2e8f0; border-radius:10px; cursor:pointer; background:#fff; transition:all 0.2s;">
              <input type="radio" name="timeOffType" value="Make Up" checked style="width:16px; height:16px; accent-color:#3b82f6;" onchange="updateTypeSelection()">
              <div>
                <div style="font-size:13px; font-weight:600; color:#1e293b;">üîÑ Make Up</div>
                <div style="font-size:10px; color:#64748b;">Work another day</div>
              </div>
            </label>
            <label class="type-card" onclick="this.querySelector('input').checked=true; updateTypeSelection();" style="display:flex; align-items:center; gap:10px; padding:12px; border:2px solid #e2e8f0; border-radius:10px; cursor:pointer; background:#fff; transition:all 0.2s;">
              <input type="radio" name="timeOffType" value="PTO" style="width:16px; height:16px; accent-color:#16a34a;" onchange="updateTypeSelection()">
              <div>
                <div style="font-size:13px; font-weight:600; color:#1e293b;">üí∞ Use PTO</div>
                <div style="font-size:10px; color:#64748b;">Deduct from balance</div>
              </div>
            </label>
          </div>
        </div>
        <!-- Make Up Date (conditional) -->
        <div id="agMakeUpWrap" style="display:none; margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase;">Make Up Date</label>
          <input type="date" id="agMakeUpDate" style="width:100%; padding:10px 12px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px;">
        </div>
        <!-- Reason -->
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase;">Reason</label>
          <input type="text" id="agToReason" placeholder="e.g., Appointment, Personal..." style="width:100%; padding:10px 12px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px; box-sizing:border-box;">
        </div>
        <!-- Actions -->
        <div style="display:flex; gap:10px;">
          <button class="btn ghost" onclick="resetAgentModal()" style="flex:1; padding:12px;">‚Üê Back</button>
          <button onclick="submitTimeOff()" style="flex:2; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; border:none; border-radius:10px; padding:12px; font-weight:700; cursor:pointer;">
            Submit Request ‚Üí
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</div>
<script>
const CHANNEL_CONFIG = {
  // hours: [StartHour, EndHour] in 24h format (e.g., 8am-4pm is [8, 16])
  // minStaff: Default minimum staff, statusInterval: Hours between status updates
  "Live Chat":       { abbrev: "LC",    color: "#b3a6d5", border: "#9688c2", text: "#351d77", hours: [8, 16], minStaff: 3, statusInterval: 2 },
  "LiveChat":        { abbrev: "LC",    color: "#b3a6d5", border: "#9688c2", text: "#351d77", hours: [8, 16], minStaff: 3, statusInterval: 2 },
  
  "Phone":           { abbrev: "Phone", color: "#a1c3c8", border: "#7ea9b0", text: "#135062", hours: [6, 20], minStaff: 2, statusInterval: 2 },
  "Phone Support":   { abbrev: "Phone", color: "#a1c3c8", border: "#7ea9b0", text: "#135062", hours: [6, 20], minStaff: 2, statusInterval: 2 },
  "PhoneSupport":    { abbrev: "Phone", color: "#a1c3c8", border: "#7ea9b0", text: "#135062", hours: [6, 20], minStaff: 2, statusInterval: 2 },
  "Socials":         { abbrev: "SS",    color: "#f8ca9b", border: "#e5b078", text: "#b35f16", hours: [8, 17], minStaff: 1, statusInterval: 3 },
  "Disputes":        { abbrev: "Dis",   color: "#d0b0ad", border: "#b89490", text: "#4c1130", hours: [8, 17], minStaff: 1, statusInterval: 2 },
  "MD Support":      { abbrev: "MD",    color: "#a3c1f3", border: "#7ba3e8", text: "#2655cb", hours: [8, 17], minStaff: 1, statusInterval: 3 },
  "MDSupport":       { abbrev: "MD",    color: "#a3c1f3", border: "#7ba3e8", text: "#2655cb", hours: [8, 17], minStaff: 1, statusInterval: 3 },
  "Defcon":          { abbrev: "DEF",   color: "#fca5a5", border: "#f87171", text: "#991b1b", hours: [8, 17], minStaff: 1, statusInterval: 2 },
  
  // Default others to 8-5 if unsure
  "Floater":         { abbrev: "Float", color: "#fee498", border: "#ecd07a", text: "#7f692a", hours: [8, 17], minStaff: 1, statusInterval: 2 },
  "Email/Floater":   { abbrev: "Float", color: "#fee498", border: "#ecd07a", text: "#7f692a", hours: [8, 17], minStaff: 1, statusInterval: 2 },
  "Lunch":           { abbrev: "üçΩÔ∏è",   color: "#dcfce7", border: "#86efac", text: "#166534", hours: [0, 24], minStaff: 0, statusInterval: 0, isBreak: true },
  "Projects":        { abbrev: "Proj",  color: "#e9d0db", border: "#d4b0c0", text: "#8c1b47", hours: [8, 17], minStaff: 1, statusInterval: 3 },
  "1:1 Meeting":     { abbrev: "1:1",   color: "#adbaf1", border: "#8e9de0", text: "#20175c", hours: [8, 17], minStaff: 0, statusInterval: 0, isBreak: true },
  "1:1 Meetings":    { abbrev: "1:1",   color: "#adbaf1", border: "#8e9de0", text: "#20175c", hours: [8, 17], minStaff: 0, statusInterval: 0, isBreak: true }
};
const CHANNEL_ABBREV = {
  "Live Chat": "LC",
  "LiveChat": "LC",
  "Phone": "Phone",
  "Phone Support": "Phone",
  "PhoneSupport": "Phone",
  "Socials": "SS",
  "MD Support": "MD",
  "MDSupport": "MD",
  "Disputes": "Dis",
  "Floater": "Float",
  "EmailFloater": "Float",
  "Email/Floater": "Float",
  "Lunch": "Lunch",
  "Projects": "Proj",
  "ReportingProjects": "Proj",
  "1: 1 Meetings": "1:1",
  "1:1s Meetings": "1:1",
  "11Meetings": "1:1"
};
  const $ = (id) => document.getElementById(id);
  
  // ============================================
  // SESSION PERSISTENCE (15 minutes)
  // ============================================
  const SESSION_KEY = 'musely_session';
  const SESSION_TTL = 15 * 60 * 1000; // 15 minutes
  
  function saveSession(data) {
    const session = {
      email: data.userEmail,
      name: data.matchedPerson,
      isManager: data.isManager,
      timestamp: Date.now()
    };
    localStorage.setItem(SESSION_KEY, JSON.stringify(session));
  }
  
  function loadSession() {
    try {
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      
      const session = JSON.parse(raw);
      const age = Date.now() - session.timestamp;
      
      // Check if session is still valid (15 minutes)
      if (age > SESSION_TTL) {
        localStorage.removeItem(SESSION_KEY);
        return null;
      }
      
      return session;
    } catch (e) {
      localStorage.removeItem(SESSION_KEY);
      return null;
    }
  }
  
  function clearSession() {
    localStorage.removeItem(SESSION_KEY);
  }
  
  // Check for existing session on page load
  function restoreSession() {
    const session = loadSession();
    if (session) {
      console.log("üîê Restoring session for:", session.name);
      window._myEmail = session.email;
      window._myName = session.name;
      window._isManager = session.isManager;
      window._currentUser = session.name;
      
      // Refresh the session timestamp (extend expiry)
      saveSession({ userEmail: session.email, matchedPerson: session.name, isManager: session.isManager });
      
      return true;
    }
    return false;
  }
  
  async function handleSignIn(response) {
  console.log("Sign-in response received");
  
  try {
    const res = await fetch('/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ credential: response.credential })
    });
    
    const data = await res.json();
    
    if (data.error) {
      console.error("Auth error:", data.error);
      toast("Access Denied: " + data.error, "error");
      return;
    }
    
    // Save session to localStorage (15 min persistence)
    saveSession(data);
    
    // Set global identity
    window._myEmail = data.userEmail;
    window._myName = data.matchedPerson;
    window._isManager = data.isManager;
    window._currentUser = data.matchedPerson;
    
    console.log(`Signed in as: ${window._myName}, Manager: ${window._isManager}`);
    
    // ‚úÖ Remove auth-pending to reveal the app
    document.body.classList.remove("auth-pending");
    
    // Hide the login button after successful sign-in
    const loginContainer = document.getElementById("loginContainer");
    if (loginContainer) loginContainer.style.display = "none";
    
    // Now load the dashboard
    load();
    
  } catch (err) {
    console.error("Sign-in failed:", err);
    toast("Sign-in failed", "error");
  }
}
// Expose to global scope IMMEDIATELY
window.handleSignIn = handleSignIn;
  // ============================================
// CLIENT-SIDE CACHE CONFIGURATION
// ============================================
const CACHE_CONFIG = {
  SCHEDULE_KEY: 'musely_schedule_cache',
  METADATA_KEY: 'musely_metadata_cache',
  TTL: 5 * 60 * 1000,  // 5 minutes in milliseconds
  VERSION: '1.0'       // Increment to invalidate old caches
};
  
  const PST_TZ = "America/Los_Angeles";
  const pad2 = (n) => String(n).padStart(2, "0");
  const TZ = "America/Los_Angeles";
  // --- CLOUD RUN BRIDGE START ---
  // This object "fakes" the Google Apps Script environment so your UI works in Cloud Run.
  
  // --- CLOUD RUN BRIDGE START ---
  // --- CLOUD RUN BRIDGE START ---
  const google = {
    script: {
      // We return a proxy to handle 'run' so we can create a fresh chain for every request
      run: {
        withSuccessHandler: function(success) {
          // Create a NEW object for this specific request chain
          const chain = {
            _success: success,
            _fail: null,
            
            withFailureHandler: function(failure) {
              this._fail = failure;
              return this;
            },
            // --- 1. AUTO-GEN ---
            checkAndAutoGenerate: function() {
               console.log("Bridge: Auto-gen check.");
               setTimeout(() => { if(this._success) this._success({ generated: false }); }, 10);
            },
            // --- 3. MASTER SCHEDULE ---
            uiGetBaseData: async function() {
                try {
                    const res = await fetch('./?action=base-schedule');
                    if(!res.ok) throw new Error("Failed to load master");
                    const json = await res.json();
                    if(this._success) this._success(json);
                } catch(err) { 
                    if(this._fail) this._fail(err); 
                }
            },
            // --- 4. CONFIGURATION ---
            uiGetConfig: function() {
               setTimeout(() => {
                 if(this._success) this._success({
                   isManager: true, role: 'MASTER', automationEnabled: true,
                   allManagers: [{name: "Admin", email: "admin@musely.com"}],
                   currentUser: "Admin", matchedPerson: "Admin"
                 });
               }, 50);
            },
            uiReplaceAssignment: async function(payload) {
  try {
    console.log("uiReplaceAssignment payload:", payload);
    if (!payload?.docId || !payload?.assignmentId || !payload?.newPerson) {
      throw new Error("Missing docId, assignmentId, or newPerson (client)");
    }
    const res = await fetch("./?action=assignment/replace", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    let json = {};
    try { json = JSON.parse(text); } catch {}
    if (!res.ok) {
      throw new Error(json.error || json.message || text || `HTTP ${res.status}`);
    }
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(String(e.message || e));
  }
},
            // --- 5. SYSTEM DATA (TEAMS & PEOPLE) ---
            uiGetManagerData: async function() {
               console.log("Bridge: Fetching People & Teams...");
               try {
                 const ts = Date.now();
                 // 1. Teams
                 const tReq = await fetch(`./?action=teams&_t=${ts}`);
                 const tRes = await tReq.json();
                 const teams = (tRes.teams || []).map(t => t.id);
                 // 2. People
                 const pReq = await fetch(`./?action=people&_t=${ts}`);
                 const pRes = await pReq.json();
                 const peopleList = (pRes.people || []).map(p => p.name || p.id);
                 console.log(`Bridge: Loaded ${peopleList.length} people.`);
                 if(this._success) this._success({ people: peopleList, teams: teams, timeOff: [] });
               } catch(e) {
                 console.error("Bridge Error (System Data):", e);
                 const fallback = ["Adam", "Baylie", "Brandi", "Elizabeth", "Gisenia", "Kelsey"];
                 if(this._success) this._success({ people: fallback, teams: [], timeOff: [] });
               }
            },
            // --- 6. ZENDESK ---
            uiGetZendeskMetricsSnapshot: function() {
               setTimeout(() => { if(this._success) this._success([]); }, 50);
            },
            // --- 8. OTHER WRITE OPERATIONS ---
            uiSetTimeOff: async function(docId, assignmentId, enforce) {
  try {
    const res = await fetch(`./?action=assignment/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        docId,
        assignmentId,
        patch: { notes: "[OFF]" },
        enforce: !!enforce
      })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || json.message || "Update failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},
uiRestoreAssignment: async function(docId, assignmentId) {
  try {
    const res = await fetch(`./?action=assignment/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        docId,
        assignmentId,
        patch: { notes: "" }
      })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || json.message || "Restore failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},
uiGetAuditLogs: async function() {
  try {
    const res = await fetch("./?action=audit/logs");
    const json = await res.json().catch(() => ([]));
    if (this._success) this._success(json);
  } catch (e) {
    if (this._success) this._success([]); // fail soft
  }
},
uiGetStaffingRules: async function() {
  try {
    const res = await fetch("./?action=staffing/rules");
    const json = await res.json().catch(() => ([]));
    if (this._success) this._success(json);
  } catch (e) {
    if (this._success) this._success([]);
  }
},
uiSaveStaffingRule: async function(rule) {
  try {
    const res = await fetch("./?action=staffing/rules", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(rule || {})
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || "Save failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},
uiDeleteStaffingRule: async function(idx) {
  try {
    const res = await fetch("./?action=staffing/rules/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ idx })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || "Delete failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},
runGenerate: async function() {
  try {
    const res = await fetch("./?action=generate", { method: "POST" });
    const json = await res.json().catch(() => ({}));
    if (this._success) this._success(json);
  } catch (e) { if (this._fail) this._fail(e.message || String(e)); }
},
runArchive: async function() {
  try {
    const res = await fetch("./?action=archive", { method: "POST" });
    const json = await res.json().catch(() => ({}));
    if (this._success) this._success(json);
  } catch (e) { if (this._fail) this._fail(e.message || String(e)); }
},
runBoth: async function() {
  try {
    const res = await fetch("./?action=sync", { method: "POST" });
    const json = await res.json().catch(() => ({}));
    if (this._success) this._success(json);
  } catch (e) { if (this._fail) this._fail(e.message || String(e)); }
},
uiRestoreAssignment: async function(id) {
                console.log("Bridge: Restore", id);
                if(this._success) this._success({ ok: true });
            },
            handleMasterScheduleEdit: async function(payload) {
                console.log("Bridge: Master Edit Request", payload);
                try {
                    const res = await fetch('./?action=update-master-schedule', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    if (!res.ok) throw new Error("Network request failed");
                    
                    const json = await res.json();
                    if (json.status === "error") throw new Error(json.message);
                    
                    if(this._success) this._success(json);
                } catch(err) {
                    console.error("Bridge Error:", err);
                    if(this._fail) this._fail(err.message);
                }
            }, // <--- COMMA HERE IS IMPORTANT
            // --- 10. ZENDESK PROFILE ---
            getZendeskProfile: async function(name) {
                console.log("Bridge: Fetching Zendesk Profile for", name);
                try {
                    const res = await fetch('./?action=agent-profile', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name: name })
                    });
                    if (!res.ok) throw new Error("Network request failed");
                    const json = await res.json();
                    
                    if(this._success) this._success(json);
                } catch(err) {
                    console.error("Profile Fetch Error:", err);
                    if(this._fail) this._fail(err.message);
                }
            }
          }; 
          return chain;
        }
      },
      
      // Group B: URL handling
      url: {
          getLocation: function(cb) { cb({ hash: window.location.hash || "" }); }
      }
    }
  };
  // --- CLOUD RUN BRIDGE END ---
  
  function fatal_(title, detail) {
    console.error("FATAL:", title, detail);
    if ($("skeletonView")) $("skeletonView").style.display = "none";
    if ($("loader")) $("loader").classList.add("hidden");
    const host = $("listView") || document.body;
    host.innerHTML = `<div style="padding:20px; color:red; font-weight:bold;">${title}<br><span style="font-weight:normal; font-size:12px; color:#333;">${detail}</span></div>`;
  }
  // --- 2. GLOBAL VARIABLES ---
  let _allData=[], _filteredData=[], _people=[], _teams=[], _roles=[], _timeOff=new Set();
  let _view="schedule", _mode="quick", _activeTeam="", _selectedPeople=new Set(), _teamSelected=new Set();
  let _editing=null, _dragPerson=null, _drawerOpen=false, _lastUndo=null, _notifQueue=[];
  let _zendeskMetricsList = [], _zendeskMetricsByName = new Map(), _zendeskSnapshotLoaded = false;
  let _selectedManagerEmail = "", _currentManagerName = "";
  let _isMasterMode = false;
  let _activeProfileRequest = "";
  let _activeMetricsRequest = "";
// Schedule date range tracking
  let _scheduleLoadedPast = 0;      // How many past days are loaded
  let _scheduleLoadedFuture = 14;   // How many future days are loaded
  let _isLoadingMore = false;       // Prevent duplicate loads
  let _agentScheduleDays = 14;      // Track agent's loaded days (separate from manager controls)
  
  // NEW: To track the logged in user's Real Name (not just email)
  let _myName = ""; 
  let _masterSelected=new Set(), _masterRawData=[]; // Moved here for safety
  let _lastSelectedPerson = null;
  // --- 3. HELPERS (FORMATTING) ---
  function formatCsatDisplay(val) {
    if (val === null || val === undefined || val === "" || val === "--") return "--";
    if (String(val).includes("%")) return val;
    const n = Number(val);
    if (isNaN(n)) return "--";
    if (n <= 1 && n !== 0) return Math.round(n * 100) + "%";
    return Math.round(n) + "%";
  }
  function getTeamClass(t) { 
    const l = (t || "").toLowerCase().replace(/[\s\/]+/g, ''); 
    
    if (l.includes("social")) return "t-socials";
    if (l.includes("phone")) return "t-phone";
    if (l.includes("livechat") || l === "lc") return "t-livechat";
    if (l.includes("md") || l.includes("medical")) return "t-mdsupport";
    if (l.includes("dispute") || l === "dis") return "t-disputes";
    if (l.includes("float") || l.includes("email")) return "t-floater";
    if (l.includes("project") || l === "proj") return "t-projects";
    if (l.includes("lunch")) return "t-lunch";
    if (l.includes("1:1") || (l.includes("11") && l.includes("meeting"))) return "t-11meeting";
    
    return "t-other"; 
}
function getChannelDisplayName(dbName) {
    const map = {
        "livechat": "Live Chat",
        "phonesupport": "Phone",
        "mdsupport":  "MD Support",
        "emailfloater": "Floater",
        "reportingprojects": "Projects",
        "11meeting": "1:1 Meetings",
        "socials": "Socials",
        "disputes": "Disputes",
        "lunch": "Lunch"
    };
    const key = String(dbName || "").toLowerCase().replace(/[\s\/]+/g, '');
    return map[key] || dbName;
}
function getChannelConfig(teamName) {
  if (!teamName) return { abbrev: "‚Äî", color: "#f8fafc", border: "#e2e8f0", text: "#475569" };
  
  const teamStr = String(teamName).trim();
  
  // Try exact match first
  if (CHANNEL_CONFIG[teamStr]) return CHANNEL_CONFIG[teamStr];
  
  // Try normalized match (remove spaces, lowercase)
  const normalized = teamStr.toLowerCase().replace(/[\s_\-\/]/g, '');
  for (const [key, val] of Object.entries(CHANNEL_CONFIG)) {
    const keyNorm = key.toLowerCase().replace(/[\s_\-\/]/g, '');
    if (keyNorm === normalized) return val;
  }
  
  // Partial matching for common patterns
  if (normalized.includes('livechat') || normalized.includes('chat')) {
    return CHANNEL_CONFIG["LiveChat"];
  }
  if (normalized.includes('phone')) {
    return CHANNEL_CONFIG["Phone"];
  }
  if (normalized.includes('dispute')) {
    return CHANNEL_CONFIG["Disputes"];
  }
  if (normalized.includes('social')) {
    return CHANNEL_CONFIG["Socials"];
  }
  if (normalized.includes('floater') || normalized.includes('email')) {
    return CHANNEL_CONFIG["Floater"];
  }
  if (normalized.includes('md') || normalized.includes('medical')) {
    return CHANNEL_CONFIG["MD Support"];
  }
  if (normalized.includes('lunch')) {
    return CHANNEL_CONFIG["Lunch"];
  }
  if (normalized.includes('project')) {
    return CHANNEL_CONFIG["Projects"];
  }
  if (normalized.includes('1:1') || normalized.includes('meeting')) {
    return CHANNEL_CONFIG["1:1 Meeting"];
  }
  
  // Ultimate fallback - use first 3-4 chars
  return { 
    abbrev: teamStr.substring(0, 4).toUpperCase(), 
    color: "#f8fafc", 
    border: "#e2e8f0", 
    text: "#475569" 
  };
}
function getChannelAbbrev(channelName) {
    const config = getChannelConfig(channelName);
    return config.abbrev;
}
  function _formatTime(val) { 
    if(!val) return ""; 
    if (val instanceof Date) { return val.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); } 
    return val; 
  }
  // Cache helper functions
function getCachedData(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    
    const cached = JSON.parse(raw);
    const now = Date.now();
    
    // Check if cache is still valid
    if (cached.version !== CACHE_CONFIG.VERSION) {
      console.log(`üóëÔ∏è Cache version mismatch for ${key}`);
      localStorage.removeItem(key);
      return null;
    }
    
    if (now - cached.timestamp > CACHE_CONFIG.TTL) {
      console.log(`‚è∞ Cache expired for ${key}`);
      localStorage.removeItem(key);
      return null;
    }
    
    console.log(`‚úÖ Cache HIT for ${key} (${Math.round((CACHE_CONFIG.TTL - (now - cached.timestamp)) / 1000)}s remaining)`);
    return cached.data;
  } catch (e) {
    console.error('Cache read error:', e);
    return null;
  }
}

function setCachedData(key, data) {
  try {
    // ‚úÖ Trim payload to only needed fields for agents
    let trimmedData = data;
    if (!window._isManager && key === CACHE_CONFIG.SCHEDULE_KEY && Array.isArray(data)) {
      // For agents, only keep essential fields to reduce cache size
      trimmedData = data.map(item => ({
        // Core schedule fields
        docId: item.docId,
        dateISO: item.dateISO,
        dateLabel: item.dateLabel,
        dayKey: item.dayKey,
        team: item.team,
        person: item.person,
        start: item.start,
        end: item.end,
        startLabel: item.startLabel,
        endLabel: item.endLabel,
        role: item.role,
        notes: item.notes,
        assignmentId: item.assignmentId,
        notifyStatus: item.notifyStatus,
        // Omit large fields like full assignments array, metadata, etc.
      }));
      // Only log size difference in development
      if (window.location.hostname === 'localhost') {
        console.log(`üì¶ Trimmed cache payload from ${JSON.stringify(data).length} to ${JSON.stringify(trimmedData).length} bytes`);
      }
    }

    const cacheEntry = {
      version: CACHE_CONFIG.VERSION,
      timestamp: Date.now(),
      data: trimmedData
    };
    localStorage.setItem(key, JSON.stringify(cacheEntry));
    console.log(`üíæ Cache SET for ${key}`);
  } catch (e) {
    console.error('Cache write error:', e);
    // If localStorage is full, clear old caches
    if (e.name === 'QuotaExceededError') {
      localStorage.removeItem(CACHE_CONFIG.SCHEDULE_KEY);
      localStorage.removeItem(CACHE_CONFIG.METADATA_KEY);
    }
  }
}
function clearScheduleCache() {
  localStorage.removeItem(CACHE_CONFIG.SCHEDULE_KEY);
  localStorage.removeItem(CACHE_CONFIG.METADATA_KEY);
  console.log('üßπ Schedule cache cleared');
}
  // --- 4. LOAD SEQUENCE ---
  window.onload = function() {
    try {
      // Try to restore session first (15 min persistence)
      if (restoreSession()) {
        console.log("‚úÖ Session restored, loading app...");
        document.body.classList.remove("auth-pending");
        const loginContainer = document.getElementById("loginContainer");
        if (loginContainer) loginContainer.style.display = "none";
      }
      load();
    } catch (e) { fatal_("Boot Crash", e.message); }
  };
  function load(force, targetEmail) {
  // ‚úÖ Show/hide login button based on auth state
  const loginContainer = document.getElementById("loginContainer");
  if (loginContainer) {
    loginContainer.style.display = (window._myName && window._myEmail) ? "none" : "flex";
  }
  
  // 1. Gatekeeper: Stop if no identity is present yet
  if (!window._myName && !window._myEmail) {
    console.log("No identity found. Skipping data load until sign-in.");
    return; 
  }
  // 2. Show loading state
  const loadingPlaceholder = $("loadingPlaceholder");
  if (loadingPlaceholder) loadingPlaceholder.style.display = "flex";
  if ($("dayTabs")) $("dayTabs").innerHTML = "";
  if ($("viewDayTitle")) $("viewDayTitle").textContent = "";
  if ($("viewDayStats")) $("viewDayStats").textContent = "";
  
  setView('schedule');
  if ($("calViewWrapper")) $("calViewWrapper").style.display = "none";
  if (targetEmail) _selectedManagerEmail = targetEmail;
  const isManager = window._isManager;
  const myName = window._myName;
  // 3. UI Adjustments based on Role
  if (isManager) {
    // === MANAGER VIEW ===
    document.body.classList.remove("agent-mode");
    document.body.classList.add("manager-mode");
    
    // Show manager-only elements
    if ($("btnAdmin")) $("btnAdmin").style.display = "flex";
    if ($("btnMasterMode")) $("btnMasterMode").style.display = "";
    if ($("drawerToggle")) $("drawerToggle").style.display = "";
    if ($("btnAgentToggle")) $("btnAgentToggle").style.display = "none";
    
    // ‚úÖ MANAGER: Ensure Metrics button is VISIBLE
    if ($("btnMetrics")) $("btnMetrics").style.display = ""; 
    
    // Update header title
    const headerTitle = document.querySelector(".hTitle");
    if (headerTitle) headerTitle.textContent = "Scheduling Manager";
    
  } else {
    // === AGENT VIEW ===
    document.body.classList.add("agent-mode");
    document.body.classList.remove("manager-mode");
    
    // Hide manager-only elements
    if ($("btnAdmin")) $("btnAdmin").style.display = "none";
    if ($("btnMasterMode")) $("btnMasterMode").style.display = "none";
    if ($("drawerToggle")) $("drawerToggle").style.display = "none";
    if ($("btnAgentToggle")) $("btnAgentToggle").style.display = "none";
    
    // ‚úÖ AGENT: FORCE HIDE METRICS BUTTON
    if ($("btnMetrics")) $("btnMetrics").style.display = "none"; 
    // Update header title
    const headerTitle = document.querySelector(".hTitle");
    if (headerTitle) headerTitle.textContent = "My Schedule";
    
    // Filter to only show agent's own shifts
    if (myName) {
      _selectedPeople.clear(); 
      _selectedPeople.add(myName);
    }
  }
  // 4. Trigger fetch
  loadSystemData();
  checkUrlNotifs();
  
  // ‚úÖ 5. Trigger Balance Load (so pill/modal works immediately)
  loadBalances();
  
  // ‚úÖ 6. Load agent notifications and show agent UI (for non-managers)
  if (!isManager) {
    if ($("btnAgentNotif")) $("btnAgentNotif").style.display = "flex";
    if ($("agentQuickActions")) $("agentQuickActions").style.display = "flex";
    loadAgentNotifications();
    loadPendingSwaps();
  } else {
    if ($("btnAgentNotif")) $("btnAgentNotif").style.display = "none";
    if ($("agentQuickActions")) $("agentQuickActions").style.display = "none";
  }
}
  // If value is a pure YYYY-MM-DD (date-only), do NOT convert timezones.
function dayKeyPST(value) {
  if (!value) return "";
  // 1) If backend already sends YYYY-MM-DD, keep it as-is
  if (typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
    return value;
  }
  // 2) If it's a Date (or parseable), decide if it‚Äôs "date-only" at UTC midnight
  const d = (value instanceof Date) ? value : new Date(value);
  if (isNaN(d)) return "";
  // If it looks like a date-only stored at 00:00:00Z, keep its UTC day
  if (d.getUTCHours() === 0 && d.getUTCMinutes() === 0 && d.getUTCSeconds() === 0) {
    return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth() + 1)}-${pad2(d.getUTCDate())}`;
  }
  // Otherwise it's a real timestamp -> format by PST
  return formatDatePST(d); // uses Intl + America/Los_Angeles
}
function displayDayLabel(dayKey) {
  if (!dayKey) return "";
  // Defensive: if it's already a label, just return it
  if (typeof dayKey !== "string" || !/^\d{4}-\d{2}-\d{2}$/.test(dayKey)) return String(dayKey);
  const [y, m, d] = dayKey.split("-").map(Number);
  const anchor = new Date(Date.UTC(y, m - 1, d, 12, 0, 0)); // noon UTC anchor
  return new Intl.DateTimeFormat("en-US", {
    timeZone: PST_TZ,
    weekday: "short",
    month: "short",
    day: "numeric",
  }).format(anchor); // -> "Tue, Dec 30"
}
function pstParts(d) {
  const dt = (d instanceof Date) ? d : new Date(d);
  if (isNaN(dt)) return null;
  const parts = new Intl.DateTimeFormat("en-CA", {
    timeZone: PST_TZ,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false,
  }).formatToParts(dt);
  const out = {};
  for (const p of parts) if (p.type !== "literal") out[p.type] = p.value;
  return out;
}
// YYYY-MM-DD in Pacific Time (best for keys/grouping)
function formatDatePST(d) {
  const p = pstParts(d);
  if (!p) return "";
  return `${p.year}-${p.month}-${p.day}`;
}
// HH:MM in Pacific Time (useful for display)
function formatTimePST(d) {
  const p = pstParts(d);
  if (!p) return "";
  return `${p.hour}:${p.minute}`;
}
// If anything calls these from inline handlers, ensure global:
window.formatDatePST = formatDatePST;
window.formatTimePST = formatTimePST;
  async function loadSystemData() {
  console.log("Loading system data...");
  
  const isManager = window._isManager;
  const myName = window._myName;
  // ‚úÖ Ensure a rolling 14-day horizon is always generated
  try {
    const today = pstISODate(); // you already have this helper
    await fetch('./?action=schedule/future', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        daysForward: 14,   // desired horizon
        startFrom: today   // anchor at today
      })
    });
  } catch (e) {
    console.warn("Rolling generate (14d) failed; continuing without auto-topup:", e);
  }
  
  // ============================================
  // AGENT CACHING LOGIC
  // ============================================
  if (!isManager && myName) {
    const cacheKey = `${CACHE_CONFIG.SCHEDULE_KEY}_${myName}`;
    const cachedSchedule = getCachedData(cacheKey);
    
    if (cachedSchedule) {
      console.log("üì¶ Loading schedule from cache for agent:", myName);
      
      // Use cached data
      _people = cachedSchedule.people || [];
      _teams = cachedSchedule.teams || [];
      _allData = cachedSchedule.allData || [];
      
      // Update UI with cached data
      renderTeamChips();
      fillSelect("tpPerson", _people);
      fillSelect("mNewPerson", _people);
      renderQuickRail();
      initFilters();
      
      // Update cache indicator
      updateCacheIndicator(true);
      await loadGlobalRules();
      await loadHolidays();
      
      applyLocalFilters();
      if ($("loadingPlaceholder")) $("loadingPlaceholder").style.display = "none";
      if (_allData.length > 0) renderView();
      
      return; // Skip network fetch
    }
  }
  
  // ============================================
  // FRESH FETCH (Manager or cache miss)
  // ============================================
  try {
    updateCacheIndicator(false);
    
    // 1. Fetch Metadata
    const metaRes = await fetch('/getmetadata', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ isManager: isManager, action: 'getMetadata' })
    });
    const meta = await metaRes.json();
    _people = (meta.people || []).map(p => p.name || p.id).filter(Boolean);
    _teams = (meta.teams || []).map(t => t.id || t.name).filter(Boolean);
    if (!_teams.includes("Lunch")) _teams.push("Lunch");
      if (!_teams.includes("1:1 Meeting")) _teams.push("1:1 Meeting");
    _zendeskMetricsList = meta.zendeskMetrics || [];
    _zendeskMetricsByName = new Map();
    _zendeskMetricsList.forEach(r => { 
      if(r && r.agentName) _zendeskMetricsByName.set(String(r.agentName), r); 
    });
    
    _timeOff.clear(); 
    (meta.timeOff || []).forEach(t => _timeOff.add(`${t.person}|${t.dateISO}`));
    renderTeamChips(); 
    fillSelect("tpPerson", _people); 
    fillSelect("mNewPerson", _people); 
    renderQuickRail(); 
    initFilters();
    // 2. Fetch Schedule
    const payload = {
      daysForward: 14,
      targetEmail: _selectedManagerEmail,
      isManager: isManager,
      agentName: myName  // Backend uses this to filter for agents
    };
    const today = pstISODate();
    const shiftRes = await fetch(`/initdashboard?start=${today}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ...payload, action: "initdashboard" })
    });
    
    const shifts = await shiftRes.json();
    if (shifts && shifts.schedule && shifts.schedule.results) {
      _allData = [];
      shifts.schedule.results.forEach(day => {
        if (day.assignments) {
          day.assignments.forEach(a => {
            const docId = String(day.id || "");
            const teamName = (docId.includes("__") ? docId.split("__")[1] : "") || day.team || "General";
            const assignmentId = a.assignmentId ?? a.id ?? a.assignment_id ?? a.assignmentID ?? "";
            const dayKey = dayKeyPST(day.date);
            _allData.push({
              ...a,
              docId,
              assignmentId,
              date: day.date,
              dateISO: dayKey,
              dayKey,
              dateLabel: dayKey,
              team: teamName,
              startLabel: a.startLabel,
              endLabel: a.endLabel,
            });
          });
        }
      });
    }
    // ============================================
    // CACHE THE DATA FOR AGENTS
    // ============================================
    if (!isManager && myName) {
      const cacheKey = `${CACHE_CONFIG.SCHEDULE_KEY}_${myName}`;
      setCachedData(cacheKey, {
        people: _people,
        teams: _teams,
        allData: _allData
      });
    }
// Check for pending requests
fetch('./?action=timeoff/count')
      .then(r => r.json())
      .then(data => {
          // 1. Badge on Main Header Button
          const btnAdmin = document.getElementById("btnAdmin");
          if(btnAdmin && !btnAdmin.querySelector('.badge')) {
              // Only add if count > 0
              if (data.count > 0) {
                  btnAdmin.innerHTML += `<span class="badge" style="position:absolute; top:-2px; right:-2px; width:10px; height:10px; background:#ef4444; border-radius:50%; border:2px solid #1e293b;"></span>`;
              }
          }
          
          // 2. Badge on Modal Button (The fix you asked for)
          const btnQueue = document.getElementById("btnReviewQueue");
          if(btnQueue) {
               if(data.count > 0) { // ‚úÖ Fixed: using 'data' instead of 'd'
                   btnQueue.innerHTML = `Review Queue <span style="background:white; color:#c2410c; padding:2px 6px; border-radius:10px; font-size:11px; font-weight:800; margin-left:6px;">${data.count}</span>`;
               } else {
                   btnQueue.innerHTML = `Review Queue`; 
               }
           }
      })
      .catch(e => console.log("Silent error checking queue"));
    // 3. Finalize View
    await loadGlobalRules();
    await loadHolidays();
    _scheduleLoadedPast = 0;
  _scheduleLoadedFuture = 14;
  _agentScheduleDays = 14; // Reset agent days tracking
  updateLoadedRangeLabel();
  updateAgentRangeLabel();  
    applyLocalFilters();
    if ($("loadingPlaceholder")) $("loadingPlaceholder").style.display = "none";
    if (_allData.length > 0) renderView();
  } catch (e) {
    console.error("System Data Load Failed:", e);
    if ($("loadingPlaceholder")) $("loadingPlaceholder").style.display = "none";
    fatal_("Data Load Failed", e);
  }
}
let _staffingRules = []; // Global variable to store rules
async function loadGlobalRules() {
  try {
    const res = await fetch('./?action=staffing/rules');
    if (res.ok) _staffingRules = await res.json();
  } catch (e) { console.error("Rules load error", e); }
}
function updateCacheIndicator(fromCache) {
  let indicator = document.getElementById('cacheIndicator');
  
  if (!indicator) {
    // Create the indicator if it doesn't exist
    indicator = document.createElement('div');
    indicator.id = 'cacheIndicator';
    indicator.className = 'pill cache';
    indicator.style.display = 'none';
    indicator.style.cursor = 'pointer';
    indicator.style.transition = 'all 0.2s';

    // Add click handler to refresh
    indicator.onclick = function() {
      clearScheduleCache();
      load(); // Reload fresh data
      toast('‚ôªÔ∏è Refreshing data...', 'info');
    };

    // Add hover effect
    indicator.onmouseenter = function() {
      this.style.transform = 'scale(1.05)';
      this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
    };
    indicator.onmouseleave = function() {
      this.style.transform = 'scale(1)';
      this.style.boxShadow = 'none';
    };

    const metaGroup = document.querySelector('.metaGroup');
    if (metaGroup) {
      metaGroup.appendChild(indicator);
    }
  }

  if (fromCache && !window._isManager) {
    indicator.textContent = 'üì¶ CACHED - Click to Refresh';
    indicator.title = 'Showing cached data. Click to reload latest schedule.';
    indicator.style.display = 'inline-block';
    indicator.style.background = 'rgba(251, 191, 36, 0.2)';
    indicator.style.color = '#f59e0b';
    indicator.style.border = '1px solid #fbbf24';
    indicator.style.fontWeight = '700';
  } else {
    indicator.style.display = 'none';
  }
}
  function renderView() {
  // If we are in metrics view, show that
  if (_view === "metrics") {
    $("scheduleView").style.display = "none";
    $("metricsView").style.display = "block";
    renderMetricsList();
    return; // Stop here
  }
  // Otherwise, default to the new SCHEDULE view
  $("scheduleView").style.display = "flex";
  $("metricsView").style.display = "none";
  
  // Render the new Single Day view
  renderScheduleView();
  
  // Update the coverage banner (Managers only)
  if (window._isManager) {
    renderCoverageBanner();
  }
}
  async function wipeFutureSchedule() {
  const result = await Swal.fire({
    title: '‚ö†Ô∏è Wipe Future Schedule?',
    html: `
      <div style="text-align:left; padding:10px;">
        <p style="color:#ef4444; font-weight:600;">This will DELETE all scheduled shifts from today onwards!</p>
        <ul style="font-size:13px; color:#64748b; margin-top:10px;">
          <li>All future schedule days will be removed</li>
          <li>This action cannot be undone</li>
          <li>You'll need to regenerate the schedule after</li>
        </ul>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'üóëÔ∏è Yes, Wipe Everything',
    cancelButtonText: 'Cancel'
  });
  if (!result.isConfirmed) return;
  // Show loading
  Swal.fire({
    title: 'Wiping Schedule...',
    html: 'Deleting all future schedule days...',
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => Swal.showLoading()
  });
  try {
    const res = await fetch('./?action=admin/wipe-future', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ confirm: true })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      Swal.fire({
        icon: 'success',
        title: 'Schedule Wiped!',
        html: `<div>Deleted <strong>${data.deleted}</strong> schedule days.</div>
               <div style="margin-top:10px; font-size:13px; color:#64748b;">
                 Now use "Generate 14 Days" to create the new schedule.
               </div>`,
        confirmButtonColor: '#16a34a'
      });
      
      // Refresh the view
      loadSystemData();
    } else {
      throw new Error(data.error || 'Wipe failed');
    }
  } catch (err) {
    Swal.fire({
      icon: 'error',
      title: 'Wipe Failed',
      text: err.message,
      confirmButtonColor: '#ef4444'
    });
  }
}
function renderQuickStats() {
  // Only show for managers
  if (!window._isManager) return;
  
  const todayISO = pstISODate();
  const todayShifts = _allData.filter(s => s.dateISO === todayISO || dayKeyPST(s.date) === todayISO);
  
  // Count by channel
  const channelCounts = {};
  let offCount = 0;
  
  todayShifts.forEach(s => {
    const channel = s.team || 'Other';
    channelCounts[channel] = (channelCounts[channel] || 0) + 1;
    
    const notes = String(s.notes || '').toLowerCase();
    if (notes.includes('[off]')) offCount++;
  });
  
  // Remove existing stats bar
  const existing = document.getElementById('quickStatsBar');
  if (existing) existing.remove();
  
  // Create stats bar
  const bar = document.createElement('div');
  bar.id = 'quickStatsBar';
  bar.style.cssText = `
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 12px 20px;
    margin:  0 20px 16px 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
  `;
  
  let statsHtml = `
    <div style="font-weight:800; color:#0f172a; font-size: 14px;">
      üìä Today's Coverage
    </div>
    <div style="height:20px; width:1px; background:#e2e8f0;"></div>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
  `;
  
  // Add channel counts
  Object.entries(channelCounts).sort((a, b) => b[1] - a[1]).slice(0, 6).forEach(([channel, count]) => {
    const config = CHANNEL_CONFIG[channel] || { abbrev: channel.substring(0, 2), color: '#f1f5f9', text: '#475569' };
    statsHtml += `
      <div style="
        background: ${config.color};
        color: ${config.text};
        padding: 4px 10px;
        border-radius:  6px;
        font-size:  12px;
        font-weight: 700;
      ">
        ${config.abbrev}:  ${count}
      </div>
    `;
  });
  
  // Add off count if any
  if (offCount > 0) {
    statsHtml += `
      <div style="
        background: #fef2f2;
        color: #dc2626;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight:  700;
      ">
        ‚õî ${offCount} OFF
      </div>
    `;
  }
  
  statsHtml += `
    </div>
    <div style="margin-left:auto; font-size:11px; color:#94a3b8;">
      ${todayShifts.length} total shifts
    </div>
  `;
  
  bar.innerHTML = statsHtml;
  
  // Insert at top of content area
  const content = document.querySelector('.content');
  if (content) {
    content.insertBefore(bar, content.firstChild);
  }
}
function calculateCoverageForToday() {
  // Get today's date in PST
  const todayISO = pstISODate();
  
  // Filter shifts for today only
  const todayShifts = _filteredData.filter(s => {
    const shiftDate = s.dateISO || dayKeyPST(s.date);
    return shiftDate === todayISO;
  });
  
  // Count shifts per channel
  const channelCounts = new Map();
  todayShifts.forEach(s => {
    const channel = s.team || "Other";
    const notes = String(s.notes || "").toLowerCase();
    const isOff = notes.includes("[off]");
    
    if (!isOff) {
      channelCounts.set(channel, (channelCounts.get(channel) || 0) + 1);
    }
  });
  
  // Compare against staffing rules
  const coverage = [];
  
  // Get day of week for rule matching
  const today = new Date();
  const dayOfWeek = today.toLocaleDateString("en-US", { 
    weekday: 'short', 
    timeZone: PST_TZ 
  }); // "Mon", "Tue", etc.
  
  _staffingRules.forEach(rule => {
    // Check if rule applies to today
    if (rule.day !== "All" && rule.day !== dayOfWeek) return;
    
    const channel = rule.team;
    const min = parseInt(rule.min) || 0;
    const current = channelCounts.get(channel) || 0;
    const config = CHANNEL_CONFIG[channel] || {};
    const abbrev = config.abbrev || channel.substring(0, 3).toUpperCase();
    
    let status = "good";
    if (current < min) {
      status = current < (min * 0.5) ? "critical" : "warning";
    }
    
    coverage.push({
      channel,
      abbrev,
      current,
      min,
      status,
      diff: current - min
    });
  });
  
  return coverage;
}
function renderCoverageBanner() {
  const banner = document.getElementById('coverageBanner');
  const chipsContainer = document.getElementById('coverageChips');
  
  if (!banner || !chipsContainer || !window._isManager) {
    if (banner) banner.classList.add('hidden');
    return;
  }
  
  const todayKey = pstISODate();
  const todayShifts = _filteredData.filter(s => 
    s.dayKey === todayKey && !(s.notes || '').includes('[OFF]')
  );
  const blocks = [
    { label: "6a-8a", start: 6, end: 8 },
    { label: "8a-10a", start: 8, end: 10 },
    { label: "10a-12p", start: 10, end: 12 },
    { label: "12p-2p", start: 12, end: 14 },
    { label: "2p-4p", start: 14, end: 16 },
    { label: "4p-6p", start: 16, end: 18 },
    { label: "6p-8p", start: 18, end: 20 }
  ];
  const nowPST = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
  const currentHour = nowPST.getHours(); 
  let chipsHTML = '';
  let globalCritical = false;
  let hasActiveRules = false;
  const coversBlock = (shift, blockStart, blockEnd) => {
    if (!shift.start || !shift.end) return false; 
    const s = parseTimeDecimal(shift.start);
    const e = parseTimeDecimal(shift.end);
    return s <= blockStart && e >= blockEnd;
  };
  if (_staffingRules && _staffingRules.length > 0) {
    const todayDOW = new Date().toLocaleDateString('en-US', { weekday: 'short' });
    _staffingRules.forEach(rule => {
      if (rule.day !== 'All' && rule.day !== todayDOW) return;
      hasActiveRules = true;
      const min = parseInt(rule.min) || 0;
      const channel = rule.team;
      const config = getChannelConfig(channel);
      
      // ‚úÖ GET HOURS FROM CONFIG
      const [openHour, closeHour] = config.hours || [8, 17];
      
      const gaps = [];
      
      blocks.forEach(blk => {
        // 1. Skip if block is in the past
        if (blk.end <= currentHour) return;
        
        // 2. ‚úÖ LOGIC FIX: Skip if channel is closed during this block
        if (blk.start < openHour || blk.end > closeHour) return;
        const count = todayShifts.filter(s => 
          (s.team === channel) && coversBlock(s, blk.start, blk.end)
        ).length;
        if (count < min) {
          gaps.push(`${blk.label} (${count}/${min})`);
        }
      });
      if (gaps.length > 0) {
        globalCritical = true;
        const gapText = gaps.length > 2 ? `${gaps.length} Time Gaps` : gaps.join(", ");

        chipsHTML += `
          <div class="coverage-chip gap-alert" title="Missing coverage: ${gaps.join(', ')}. Required: ${min} agents minimum. Hours: ${openHour}:00-${closeHour}:00">
            <span class="status-dot"></span>
            <span class="channel-abbrev">${config.abbrev}</span>
            <span class="coverage-count">‚ö†Ô∏è Low: ${gapText}</span>
            <span class="coverage-count">‚ö†Ô∏è Low: ${gapText} (min: ${min})</span>
          </div>
        `;
      } 
      // Only show "Safe" if channel is actually OPEN right now (or will be)
      else if (currentHour < closeHour) { 
        const totalAgents = todayShifts.filter(s => s.team === channel).length;
        chipsHTML += `
          <div class="coverage-chip good" title="Coverage meets requirement. Min: ${min} agents. Hours: ${openHour}:00-${closeHour}:00">
            <span class="status-dot"></span>
            <span class="channel-abbrev">${config.abbrev}</span>
            <span class="coverage-count">Safe (${totalAgents})</span>
            <span class="coverage-count">Safe (${totalAgents}, min: ${min})</span>
          </div>
        `;
      }
    });
  }
  // Adjust "Day Complete" to be dynamic based on the latest closing time (Phone = 20/8pm)
  if (!hasActiveRules) {
     chipsHTML = `<div style="font-size:12px; color:#64748b; font-style:italic;">No rules for today.</div>`;
  } else if (currentHour >= 20 && !globalCritical) {
     chipsHTML = `<div class="coverage-all-good" style="background:#f1f5f9; border-color:#e2e8f0; color:#64748b;">Day Complete üåô</div>`;
  } else if (chipsHTML === '') {
     chipsHTML = `<div class="coverage-all-good">All Systems Go</div>`;
  }
  chipsContainer.innerHTML = chipsHTML;
  banner.classList.remove('hidden');
  if (globalCritical) {
    banner.classList.add('critical-state');
    banner.style.animation = 'none';
    banner.offsetHeight; 
    banner.style.animation = null; 
  } else {
    banner.classList.remove('critical-state');
  }
}
function normalizeChannelName(name) {
  if (!name) return 'other';
  const n = name.toLowerCase().replace(/[\s\-_]/g, '');
  
  if (n.includes('livechat') || n === 'lc') return 'livechat';
  if (n.includes('phone') || n === 'ph') return 'phone';
  if (n.includes('email') || n.includes('floater') || n === 'float') return 'floater';
  if (n.includes('social') || n === 'ss' || n === 'soc') return 'socials';
  if (n.includes('dispute') || n === 'dis') return 'disputes';
  if (n.includes('md') || n.includes('medical')) return 'mdsupport';
  if (n.includes('project') || n === 'proj') return 'projects';
  if (n.includes('lunch')) return 'lunch';
  if (n.includes('1:1') || n.includes('11') || n.includes('meeting')) return '1:1meetings';
  
  return n;
}
async function logEndOfDaySummary() {
  const result = await Swal.fire({
    title: 'Log End-of-Day Report?',
    text: "This will analyze today's staffing and save a summary to the Audit Log.",
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Yes, Save Log',
    confirmButtonColor: '#1e293b'
  });
  if (!result.isConfirmed) return;
  // 1. Setup Data
  const todayKey = pstISODate();
  const todayShifts = _allData.filter(s => 
    (s.dateISO === todayKey || dayKeyPST(s.date) === todayKey) && 
    !(s.notes || '').includes('[OFF]')
  );
  const blocks = [
    { label: "6a-8a", start: 6, end: 8 },
    { label: "8a-10a", start: 8, end: 10 },
    { label: "10a-12p", start: 10, end: 12 },
    { label: "12p-2p", start: 12, end: 14 },
    { label: "2p-4p", start: 14, end: 16 },
    { label: "4p-6p", start: 16, end: 18 },
    { label: "6p-8p", start: 18, end: 20 }
  ];
  let report = [];
  
  if (!_staffingRules || _staffingRules.length === 0) {
    return toast("No staffing rules to check against", "warning");
  }
  const todayDOW = new Date().toLocaleDateString('en-US', { weekday: 'short' });
  
  _staffingRules.forEach(rule => {
    if (rule.day !== 'All' && rule.day !== todayDOW) return;
    const channel = rule.team;
    const min = parseInt(rule.min) || 0;
    
    // ‚úÖ GET CONFIG HOURS (Default to 8am-5pm if missing)
    const config = getChannelConfig(channel);
    const [openHour, closeHour] = config.hours || [8, 17];
    const teamGaps = [];
    blocks.forEach(blk => {
      // ‚úÖ LOGIC FIX: Skip this block if the channel is closed
      // e.g. If LC opens at 8, skip 6a-8a. If LC closes at 16, skip 16-18.
      if (blk.start < openHour || blk.end > closeHour) return;
      const count = todayShifts.filter(s => {
        if (s.team !== channel) return false;
        if (!s.start || !s.end) return false;
        
        const start = parseTimeDecimal(s.start);
        const end = parseTimeDecimal(s.end);
        
        // Strict Check: Shift must cover this block
        return start <= blk.start && end >= blk.end;
      }).length;
      if (count < min) {
        teamGaps.push(`${blk.label} (${count}/${min})`);
      }
    });
    if (teamGaps.length > 0) {
      report.push(`${config.abbrev}: ${teamGaps.join(', ')}`);
    }
  });
  // 3. Create Log Message
  let summary = "";
  let actionType = "EOD REPORT";
  
  if (report.length === 0) {
    summary = "‚úÖ All staffing targets met for the day.";
    actionType = "EOD SUCCESS";
  } else {
    summary = "‚ö†Ô∏è Gaps: " + report.join(" | ");
    actionType = "EOD ALERT";
  }
  // 4. Send to Backend
  logAuditEntry({
    action: actionType,
    manager: window._myName || "System",
    target: "Daily Schedule",
    date: todayKey,
    details: summary
  });
  toast("Daily summary logged to Audit History", "success");
}
function parseTimeDecimal(t) {
  if (!t) return 0;
  const [h, m] = t.split(':').map(Number);
  return h + (m || 0) / 60;
}
// Helper function if not already defined
function pstISODate() {
  const now = new Date();
  return new Intl.DateTimeFormat('en-CA', {
    timeZone: 'America/Los_Angeles',
    year: 'numeric',
    month: '2-digit',
    day:  '2-digit'
  }).format(now);
}
async function regenerateAllSchedule() {
  const result = await Swal.fire({
    title: 'üîÑ Regenerate Entire Schedule?',
    html: `
      <div style="text-align:left; padding:10px;">
        <p style="font-weight:600; color:#1e293b;">This will:</p>
        <ol style="font-size:13px; color:#64748b; margin-top:10px;">
          <li style="margin-bottom:8px;"><span style="color:#ef4444; font-weight:600;">DELETE</span> all scheduled shifts from today onwards</li>
          <li style="margin-bottom:8px;"><span style="color:#16a34a; font-weight:600;">GENERATE</span> fresh shifts from the Master Schedule template</li>
        </ol>
        <div style="margin-top:15px; padding:10px; background:#fef3c7; border-radius:8px; border:1px solid #fcd34d;">
          <strong style="color:#92400e;">‚ö†Ô∏è Warning:</strong>
          <span style="color:#92400e; font-size:12px;">Any manual changes made to existing shifts will be lost!</span>
        </div>
      </div>
      <div style="margin-top:15px;">
        <label style="font-size:12px; font-weight:600; color:#64748b;">Days to Generate:</label>
        <input type="number" id="regenDays" value="14" min="1" max="31" 
               style="width:80px; padding:8px; border:1px solid #cbd5e1; border-radius:6px; margin-left:10px;">
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3b82f6',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'üîÑ Yes, Regenerate',
    cancelButtonText: 'Cancel',
    preConfirm: () => {
      const days = document.getElementById('regenDays').value;
      return { days: parseInt(days) || 14 };
    }
  });
  if (!result.isConfirmed) return;
  const daysToGen = result.value.days;
  // Show loading
  Swal.fire({
    title: 'Regenerating Schedule...',
    html: `
      <div style="margin-bottom:10px;">Step 1: Wiping old schedule...</div>
      <div style="font-size:12px; color:#64748b;">This may take a moment...</div>
    `,
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => Swal.showLoading()
  });
  try {
    const res = await fetch('./?action=admin/regenerate-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ confirm: true, days: daysToGen })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      Swal.fire({
        icon: 'success',
        title: '‚úÖ Schedule Regenerated!',
        html: `
          <div style="text-align:left; padding:10px; background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0;">
            <div style="margin-bottom:8px;">üóëÔ∏è <strong>Deleted:</strong> ${data.deleted} old schedule days</div>
            <div style="margin-bottom:8px;">‚ú® <strong>Generated:</strong> ${data.generated} new schedule days</div>
            <div style="margin-bottom:8px;">üìÖ <strong>Days Forward:</strong> ${data.daysForward}</div>
            <div>üë• <strong>Teams:</strong> ${data.teams?.join(', ') || 'All'}</div>
          </div>
        `,
        confirmButtonColor: '#16a34a',
        confirmButtonText: 'Refresh Dashboard'
      }).then(() => {
        // Clear cache and reload
        clearScheduleCache();
        load(true);
      });
    } else {
      throw new Error(data.error || 'Regeneration failed');
    }
  } catch (err) {
    Swal.fire({
      icon: 'error',
      title: 'Regeneration Failed',
      text: err.message,
      confirmButtonColor: '#ef4444'
    });
  }
}
  async function saveShift() {
    const person = document.getElementById("modalEmployee").value;
    const day = document.getElementById("modalDay").value;
    const newStart = document.getElementById("modalStart").value;
    const newEnd = document.getElementById("modalEnd").value;
    const newTeam = document.getElementById("modalTeam").value;
    const origStart = document.getElementById("modalOrigStart").value;
    const origEnd = document.getElementById("modalOrigEnd").value;
    const isAdding = origStart === "NEW";
    const actionType = isAdding ? "ADD" : "EDIT";
    if(!newStart || !newEnd) {
        Swal.fire({
            icon: 'warning',
            title: 'Missing Times',
            text: 'Please enter both start and end times.',
            confirmButtonColor: '#3b82f6'
        });
        return;
    }
    // --- 1. UPDATE LOCAL DATA (Immediate UI Refresh) ---
    const dayData = _masterRawData[day] || [];
    if (isAdding) {
        dayData.push({ person, start: newStart, end: newEnd, team: newTeam });
        _masterRawData[day] = dayData;
    } else {
        const shiftToUpdate = dayData.find(s => s.person === person && s.start === origStart && s.end === origEnd);
        if (shiftToUpdate) {
            shiftToUpdate.start = newStart;
            shiftToUpdate.end = newEnd;
            shiftToUpdate.team = newTeam;
        }
    }
    renderMasterView(_masterRawData);
    closeModal();
    // --- 2. SHOW LOADING STATE ---
    Swal.fire({
        title: isAdding ? 'Adding Shift...' : 'Saving Changes...',
        html: `<div style="font-size:14px; color:#64748b;">Updating ${person}'s schedule for ${day}</div>`,
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    // --- 3. SEND TO BACKEND ---
    const payload = {
        action: actionType,
        person: person,
        day: day,
        oldStart: isAdding ? "" : origStart, 
        oldEnd: isAdding ? "" : origEnd,
        newStart: newStart,
        newEnd: newEnd,
        newTeam: newTeam
    };
    
    try {
      const response = await fetch('./?action=update-master-schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      const result = await response.json();
      
      if (result.status === "success" || result.ok) {
        console.log("Saved to database successfully", result);
        
        Swal.fire({
            icon: 'success',
            title: isAdding ? 'Shift Added!' : 'Changes Saved!',
            html: `
                <div style="text-align:left; padding:10px; background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0;">
                    <div style="margin-bottom:8px;"><strong>üë§ Employee:</strong> ${person}</div>
                    <div style="margin-bottom:8px;"><strong>üìÖ Day:</strong> ${day}</div>
                    <div style="margin-bottom:8px;"><strong>üïê Time:</strong> ${toAmPm(newStart)} - ${toAmPm(newEnd)}</div>
                    <div><strong>üë• Team:</strong> ${newTeam || 'Not specified'}</div>
                </div>
            `,
            confirmButtonColor: '#16a34a',
            confirmButtonText: 'Great!',
            timer: 4000,
            timerProgressBar: true
        });
      } else {
        throw new Error(result.message || result.error || 'Unknown error');
      }
    } catch (err) {
      console.error("Save failed:", err);
      
      Swal.fire({
          icon: 'error',
          title: 'Save Failed',
          html: `
              <div style="color:#ef4444; font-size:14px; margin-bottom:10px;">
                  ${err.message || err || 'Unknown error occurred'}
              </div>
              <div style="font-size:12px; color:#64748b;">
                  The local view has been updated, but the database may not have saved.
                  Try refreshing and making the change again.
              </div>
          `,
          confirmButtonColor: '#ef4444',
          confirmButtonText: 'OK'
      });
    }
}
function getChannelAbbrev(channel) {
  const abbrevMap = {
    'livechat': 'LC',
    'phone': 'Phone',
    'floater': 'Float',
    'socials': 'SS',
    'disputes': 'Dis',
    'mdsupport': 'MD',
    'projects': 'Proj',
    'lunch': 'Lunch',
    '1:1meetings': '1:1',
    'other': 'Other'
  };
  
  const normalized = normalizeChannelName(channel);
  return abbrevMap[normalized] || channel.substring(0, 4);
}
// 1. Open the Queue (uses SweetAlert for simplicity)
async function openTimeOffQueue() {
  closeAdminModal();
  Swal.fire({ title: 'Loading...', didOpen: () => Swal.showLoading() });
  try {
    const res = await fetch('./?action=timeoff/list');
    const data = await res.json();
    
    if (!data.ok) throw new Error(data.error);
    if (!data.requests || data.requests.length === 0) {
      Swal.fire("All caught up!", "No pending time off requests.", "success");
      return;
    }
    let html = `<div style="text-align:left; max-height:400px; overflow-y:auto;">`;
    
    // Helper to calculate hours for UI (handles AM/PM)
    const calcHours = (s, e) => {
        if(!s || !e) return 4;
        const parse = (t) => {
           const match = t.match(/(\d+):(\d+)\s?(AM|PM)?/i);
           if(!match) return 0;
           let h = parseInt(match[1]);
           let ampm = match[3] ? match[3].toUpperCase() : null;
           if (ampm === "PM" && h < 12) h += 12;
           if (ampm === "AM" && h === 12) h = 0;
           return h + (parseInt(match[2])/60);
        };
        let diff = parse(e) - parse(s);
        if(diff < 0) diff += 24;
        return Math.round(diff * 100) / 100;
    };
    data.requests.forEach(req => {
      // 1. Date & Team Label
      let dateDisplay = req.date || "Date Pending";
      let teamLabel = req.team ? `<span style="font-size:10px; background:#e0e7ff; color:#4338ca; padding:2px 5px; border-radius:4px; margin-left:6px; font-weight:700;">${req.team}</span>` : "";
      const reqType = (req.type || "PTO").toString();
      const isMakeUp = reqType.toLowerCase().includes("make");
      const typePill = isMakeUp
        ? `<span style="font-size:10px; background:#dbeafe; color:#1d4ed8; padding:2px 6px; border-radius:999px; margin-left:8px; font-weight:800;">MAKE UP</span>`
        : `<span style="font-size:10px; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:999px; margin-left:8px; font-weight:800;">PTO</span>`;
      const makeUpLine = isMakeUp
        ? (req.makeUpDate
            ? `<div style="margin-top:6px; font-size:12px; color:#475569;"><strong>Make Up Date:</strong> ${req.makeUpDate}</div>`
            : `<div style="margin-top:6px; font-size:12px; color:#ef4444;"><strong>Make Up Date:</strong> Not provided</div>`)
        : "";
      // 2. Calculate Deduction Logic
      let deductAmount = 0;
      let timeDisplay = "";
      
      if (req.duration === 'full_day') {
          deductAmount = 8;
      } else if (req.shiftStart && req.shiftEnd) {
          deductAmount = calcHours(req.shiftStart, req.shiftEnd);
          // Only use fallback if math returns 0
          if (deductAmount === 0) deductAmount = 4; 
          timeDisplay = `<div style="font-size:11px; color:#64748b; margin-top:2px;">${req.shiftStart} - ${req.shiftEnd} (${deductAmount} hrs)</div>`;
      } else {
          deductAmount = 4; 
      }
      const bal = req.currentBalance !== undefined ? req.currentBalance : 0;
      const typeBadge = req.duration === 'full_day' 
          ? `<span style="background:#dbeafe; color:#1e40af; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:700; margin-right:6px;">FULL DAY</span>`
          : `<span style="background:#f3f4f6; color:#374151; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:700; margin-right:6px;">SHIFT</span>`;
      const actionButtons = isMakeUp
        ? `<button onclick="resolveTimeOff('${req.id}', 'approved', { deduct: false })" 
                  style="padding:8px 16px; background:#1d4ed8; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;">Approve (No Deduct)</button>`
        : `<button onclick="animateDeduction('bal-${req.id}', ${bal}, ${deductAmount}); resolveTimeOff('${req.id}', 'approved', { deduct: true, amount: ${deductAmount} })" 
                  style="padding:8px 16px; background:#1e293b; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;">Approve & Deduct</button>`;
      html += `
        <div id="req-${req.id}" style="border:1px solid #e2e8f0; padding:16px; margin-bottom:12px; border-radius:12px; background:#fff;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:800; color:#0f172a; font-size:15px;">
                ${req.person} ${teamLabel} ${typePill}
            </div>
            <div style="font-size:11px; background:#f0fdf4; color:#166534; padding:4px 10px; border-radius:20px; border:1px solid #bbf7d0; font-weight:700;">
               Balance: <span id="bal-${req.id}">${bal}</span> hrs
            </div>
          </div>
          <div style="font-size:13px; color:#334155; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #f1f5f9;">
             <div style="margin-bottom:4px;">${typeBadge} <strong>${dateDisplay}</strong> ${timeDisplay}</div>
             <div style="color:#64748b; font-style:italic;">"${req.reason || 'No reason provided'}"</div>
             ${makeUpLine}
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button onclick="resolveTimeOff('${req.id}', 'rejected')" style="padding:8px 16px; background:#fff; color:#ef4444; border:1px solid #fee2e2; border-radius:8px; cursor:pointer; font-weight:600;">Deny</button>
            ${actionButtons}
          </div>
        </div>
      `;
    });
    html += `</div>`;
    Swal.fire({ title: 'Time Off Requests', html: html, width: 600, showConfirmButton: false, showCloseButton: true });
  } catch (err) {
    Swal.fire("Error", err.message, "error");
  }
}
// 2. Handle Decision
async function resolveTimeOff(id, decision, opts = {}) {
  // Optimistic UI: Remove the card immediately to feel "snappy"
  const card = document.getElementById(`req-${id}`);
  if(card) card.style.opacity = "0.5";
  
  toast(decision === 'approved' ? "Approving..." : "Denying...");
  try {
    // CLOUD RUN FETCH CALL
    const res = await fetch('./?action=timeoff/resolve', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        id: id,
        decision: decision,
        manager: window._myName, // Send who made the decision
        // If caller passes deduct, use it. Otherwise:
// - deny => never deduct
// - approve => leave undefined so backend can decide (or your caller can decide)
deduct: (opts && typeof opts.deduct === "boolean")
  ? opts.deduct
  : (decision === "approved" ? undefined : false),
// allow 0 as a valid amount (your old check would drop it)
amount: (opts && opts.amount != null) ? opts.amount : null,
      })
    });
    const text = await res.text(); 
    let data;
    try {
        data = JSON.parse(text);
    } catch (e) {
        console.error("CRITICAL SERVER ERROR:", text);
        throw new Error("Server returned HTML. Check Console (F12) for the real error.");
    }
    
    if (data.ok) {
      toast(`Request ${decision}!`, "success");
      if(card) card.remove(); // Remove from UI
      // 1. Reload balances so Admin Tools shows the new numbers
      loadBalances();
      // 2. Refresh the "Review Queue" Badge Count (THIS WAS MISSING)
      fetch('./?action=timeoff/count')
        .then(r => r.json())
        .then(d => {
           const btnQueue = document.getElementById("btnReviewQueue");
           // Try to find the red dot on the main Admin icon
           const btnAdmin = document.getElementById("btnAdmin");
           const badgeAdmin = btnAdmin ? btnAdmin.querySelector('.badge') : null;
           
           // Update the "Review Queue" button text
           if(btnQueue) {
               if(d.count > 0) {
                   btnQueue.innerHTML = `Review Queue <span style="background:white; color:#c2410c; padding:2px 6px; border-radius:10px; font-size:11px; font-weight:800; margin-left:6px;">${d.count}</span>`;
               } else {
                   btnQueue.innerHTML = `Review Queue`; // Remove badge if 0
               }
           }
           
           // If count is 0, remove the red dot from the top header
           if(badgeAdmin && d.count === 0) badgeAdmin.remove();
        });
      
      // If there are no more requests, refresh the list to show "All caught up"
      const remaining = document.querySelectorAll('[id^="req-"]').length;
      if(remaining === 0) setTimeout(openTimeOffQueue, 500);
      
    } else {
      if(card) card.style.opacity = "1"; // Revert UI on failure
      toast(data.error || "Error saving decision", "error");
    }
  } catch (err) {
    if(card) card.style.opacity = "1";
    console.error(err);
    toast(err.message, "error");
  }
}
function animateDeduction(elementId, startVal, amountToDeduct) {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    let start = parseFloat(startVal) || 0;
    let end = start - amountToDeduct;
    let duration = 800; // Animation speed in ms
    let startTime = null;
    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        let progress = Math.min((timestamp - startTime) / duration, 1);
        
        // Easing function for smooth look
        let current = start - (amountToDeduct * progress);
        
        el.innerHTML = current.toFixed(1);
        el.style.color = "#ef4444"; // Flash red
        
        if (progress < 1) {
            window.requestAnimationFrame(step);
        } else {
            el.innerHTML = end.toFixed(1); // Ensure exact end value
            el.style.color = "#166534"; // Return to green
        }
    }
    window.requestAnimationFrame(step);
}
function deleteShift() {
    const person = document.getElementById("modalEmployee").value;
    const day = document.getElementById("modalDay").value;
    const origStart = document.getElementById("modalOrigStart").value;
    const origEnd = document.getElementById("modalOrigEnd").value;
    
    // Use SweetAlert for confirmation instead of basic confirm()
    Swal.fire({
        title: 'Delete This Shift?',
        html: `
            <div style="text-align:left; padding:12px; background:#fef2f2; border-radius:8px; border:1px solid #fecaca;">
                <div style="margin-bottom:8px;"><strong>üë§ Employee:</strong> ${person}</div>
                <div style="margin-bottom:8px;"><strong>üìÖ Day:</strong> ${day}</div>
                <div><strong>üïê Time:</strong> ${toAmPm(origStart)} - ${toAmPm(origEnd)}</div>
            </div>
            <div style="margin-top:12px; font-size:13px; color:#64748b;">
                This will permanently remove the shift from the master template.
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'üóëÔ∏è Yes, Delete It',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            executeDeleteShift(person, day, origStart, origEnd);
        }
    });
}
async function executeDeleteShift(person, day, origStart, origEnd) {
    // --- 1. REMOVE FROM LOCAL DATA ---
    const dayData = _masterRawData[day];
    if (dayData) {
        const index = dayData.findIndex(s => s.person === person && s.start === origStart && s.end === origEnd);
        if (index > -1) {
            dayData.splice(index, 1);
        }
    }
    renderMasterView(_masterRawData);
    closeModal();
    // --- 2. SHOW LOADING STATE ---
    Swal.fire({
        title: 'Deleting Shift...',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    // --- 3. SEND TO BACKEND ---
    const payload = {
        action: "DELETE",
        person: person,
        day: day,
        oldStart: origStart,
        oldEnd: origEnd
    };
    
    try {
      const response = await fetch('./?action=update-master-schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      const result = await response.json();
      
      if (result.status === "success" || result.ok) {
        console.log("Deleted from database successfully", result);
        
        Swal.fire({
            icon: 'success',
            title: 'Shift Deleted!',
            html: `<div style="color:#16a34a;">Removed ${person}'s shift on ${day}</div>`,
            confirmButtonColor: '#16a34a',
            timer: 2500,
            timerProgressBar: true
        });
      } else {
        throw new Error(result.message || result.error || 'Unknown error');
      }
    } catch (err) {
      console.error("Delete failed:", err);
      
      Swal.fire({
          icon: 'error',
          title: 'Delete Failed',
          text: err.message || err || 'Could not delete from database',
          confirmButtonColor: '#ef4444'
      });
    }
}
function checkTimeMatch(targetTime, compareTime) {
  const normalize = (t) => {
    if (!t) return "";
    // Standard JS way to handle Date objects instead of Apps Script
    if (t instanceof Date) {
      return t.getHours().toString().padStart(2, '0') + ":" + 
             t.getMinutes().toString().padStart(2, '0');
    }
    return String(t).trim().substring(0, 5);
  };
  return normalize(targetTime) === normalize(compareTime);
}
  function toAmPm(timeString) {
    if (!timeString) return "";
    // Handle "07:00:00" or "07:00"
    const parts = timeString.split(":");
    let hours = parseInt(parts[0], 10);
    const minutes = parts[1];
    
    const suffix = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12; // Convert "0" or "12" to 12
    
    return `${hours}:${minutes} ${suffix}`;
}
function renderMetricsView() {
    $("listView").style.display = "none"; $("calViewWrapper").style.display = "none"; $("metricsView").style.display = "block";
    renderMetricsList();
  }
  // ============================================
// AUDIT LOGGING
// ============================================
async function logAuditEntry(entry) {
  try {
    await fetch('/?action=audit/log', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        ...entry,
        timestamp: new Date().toISOString()
      })
    });
  } catch (err) {
    console.error("Audit log failed:", err);
  }
}
  function renderShiftCard(it, mode) {
  const card = mkDiv(`shift ${getTeamClass(it.team)}`);
  
  // Check selection
  if (_teamSelected.has(String(it.assignmentId))) card.classList.add("selected");
  
  // ============================================
  // SHIFT STATUS DETECTION
  // ============================================
  const notes = String(it.notes || "").toLowerCase();
  const isOff = _timeOff.has(`${it.person}|${it.dateISO}`) || notes.includes("[off]");
  const isBackup = notes.includes("back up") || 
                   notes.includes("backup") || 
                   notes.includes("coverage") ||
                   notes.includes("temp") ||
                   notes.includes("replacing") ||
                   notes.includes("replaced");
  const isCaptain = notes.includes("captain");
  
  // ============================================
  // GET CHANNEL CONFIG FOR COLORS - WITH FALLBACK
  // ============================================
  const config = getChannelConfig(it.team) || {
    abbrev: "‚Äî",
    color: "#f8fafc",
    border: "#e2e8f0",
    text: "#475569"
  };
  
  // Ensure all properties exist with fallbacks
  const channelAbbrev = config.abbrev || "‚Äî";
  const channelColor = config.color || "#f8fafc";
  const channelBorder = config.border || "#e2e8f0";
  const channelText = config.text || "#475569";
  const channelDisplay = getChannelDisplayName ?  getChannelDisplayName(it.team) : (it.team || "Unknown");
  
  // ============================================
  // APPLY VISUAL STYLES BASED ON STATUS
  // ============================================
  
  // Priority 1: OFF status
  if (isOff) { 
    card.style.border = "2px solid #f87171"; 
    card.style.background = "#fef2f2"; 
    card.style.opacity = "0.7";
  }
  // Priority 2: Backup/Coverage shift
  else if (isBackup) {
    card.style.border = "2px solid #ef4444";
    card.style.background = "linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)";
    card.style.boxShadow = "0 2px 8px rgba(239, 68, 68, 0.25)";
    card.classList.add("backup-shift");
  }
  // Priority 3: Captain
  else if (isCaptain) {
    card.style.border = "2px solid #f59e0b";
    card.style.background = "linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)";
    card.style.boxShadow = "0 2px 8px rgba(245, 158, 11, 0.25)";
  }
  
  // ============================================
  // BUILD CARD CONTENT
  // ============================================
  let metaIcon = "";
  if (window._isManager && it.notes && it.notes.length > 0) {
    metaIcon = `<span style="font-size: 10px; margin-left: 6px; cursor:help;" title="Notes: ${it.notes}">üìù</span>`;
  }
  // Role badge
  const roleDisplay = it.role 
    ? `<span style="font-size:9px; background:#e0e7ff; color:#4c51bf; padding:2px 6px; border-radius:4px; font-weight:700; margin-left: 4px;">${it.role}</span>` 
    : "";
  
  // Status badge for backup shifts
  let statusBadge = "";
  if (isBackup && ! isOff) {
    statusBadge = `<span style="font-size:8px; background:#ef4444; color:#fff; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:4px;">COVERAGE</span>`;
  } else if (isCaptain) {
    statusBadge = `<span style="font-size: 8px; background:#f59e0b; color:#fff; padding:2px 6px; border-radius:4px; font-weight:700; margin-left: 4px;">CAPTAIN</span>`;
  }
  
  // ============================================
  // CHECK FOR REPLACEMENT INFO IN NOTES
  // ============================================
  let replacementDisplay = "";
  const notesStr = String(it.notes || "");
  const replacedMatch = notesStr.match(/(?:replaced|covering for|was)\s+([A-Za-z]+(?:\s+[A-Za-z]+)?)/i);
  if (replacedMatch && replacedMatch[1] && window._isManager) {
    const originalPerson = replacedMatch[1].trim();
    if (originalPerson.toLowerCase() !== (it.person || "").toLowerCase()) {
      replacementDisplay = `<span style="font-size:9px; color:#6b7280; text-decoration:line-through; margin-right:4px;">${escapeHtml(originalPerson)}</span>‚Üí `;
      statusBadge = `<span style="font-size:8px; background:#8b5cf6; color:#fff; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:4px;">SWAP</span>`;
    }
  }
  
  // ============================================
  // SPECIAL STYLING FOR LUNCH/1:1 (Break types)
  // ============================================
  const isBreakType = config.isBreak === true;
  if (isBreakType && !isOff) {
    card.style.opacity = "0.85";
    card.style.background = channelColor;
    card.style.borderStyle = "dashed";
  }
  
  // Build the HTML with color-coded channel badge
  card.innerHTML = `
    <div class="sRow" style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 4px;">
      <span class="sTime" style="font-weight:800; font-size: 11px;">${it.startLabel || ''}-${it.endLabel || ''}</span>
      <span style="font-size:10px; background: ${channelColor}; color: ${channelText}; padding: 2px 6px; border-radius:4px; font-weight: 700; border:1px solid ${channelBorder};" title="${channelDisplay}">${channelAbbrev}</span>
      ${metaIcon}
    </div>
    <div class="sName" title="${it.person || ''}" style="font-weight: 600;">
      ${replacementDisplay}${it.person || 'Unassigned'}${roleDisplay}${statusBadge}
    </div>
    ${isBackup && it.notes ?  `<div style="font-size:9px; color:#dc2626; margin-top:4px; font-weight:600;">${escapeHtml(it.notes)}</div>` : ''}
  `;
  
  const sel = mkDiv("selBox"); 
  sel.textContent = "‚úì"; 
  card.appendChild(sel);
  
  if (mode === "list") card.style.width = "220px";
  
  // ============================================
  // CLICK HANDLING
  // ============================================
  const currentName = String(window._myName || "").trim().toLowerCase();
  const shiftPerson = String(it.person || "").trim().toLowerCase();
  const isMe = currentName && shiftPerson === currentName;
  const isManager = window._isManager === true;
  if (isManager || isMe) {
    card.style.cursor = "pointer";
    
    card.onclick = (e) => { 
      if (isManager) {
        if(_mode === "team" || _teamSelected.size > 0 || e.shiftKey) { 
          toggleTeamSelect(it, card); 
        } else { 
          openReplaceModal(it); 
        } 
      } 
      else if (isMe) {
        openAgentActionModal(it);
      }
    };
    if (isManager) {
      card.draggable = true;
      card.ondragstart = (e) => { e.preventDefault(); }; 
      card.ondragover = (e) => { if(_mode === "quick") { e.preventDefault(); card.classList.add("dropTarget"); } };
      card.ondragleave = () => card.classList.remove("dropTarget");
      card.ondrop = (e) => { 
        e.preventDefault(); 
        card.classList.remove("dropTarget"); 
        if(_dragPerson && _dragPerson !== it.person) { 
          _editing = it; 
          openReplaceModal(it); 
          setTimeout(() => $("mNewPerson").value = _dragPerson, 50); 
        } 
      };
    }
  }
  
  return card;
}
  // --- 6. AGENT ACTIONS (MOVED TO GLOBAL SCOPE) ---
  // These functions are now accessible by the HTML buttons
 function openAgentActionModal(it) {
  console.log("Opening Agent Modal for:", it);
  _editing = it; 
  // Update shift time display
  if($("agShiftTimeDisplay")) {
    $("agShiftTimeDisplay").innerText = `${it.startLabel} - ${it.endLabel}`;
  }
  
  // Update title card
  const title = `${it.dateLabel} ‚Ä¢ ${it.startLabel} - ${it.endLabel}`;
  const titleEl = document.getElementById("agShiftDetails");
  if(titleEl) titleEl.innerText = title;
  
  // Reset modal view
  resetAgentModal();
  
  // Fill coworker dropdown
  try {
    const peopleList = Array.isArray(_people) ? _people : [];
    const currentName = window._myName || "";
    const coworkers = peopleList.filter(p => p !== currentName);
    if (typeof fillSelect === "function") {
      fillSelect("agSwapPerson", coworkers, false);
    }
  } catch (err) {
    console.error("Error filling swap list (non-fatal):", err);
  }
  
  // ‚úÖ NEW: Load and display PTO balance
  loadAgentPtoDisplay();
  
  // Show overlay
  const overlay = document.getElementById("agentOverlay");
  if(overlay) {
    if (overlay.parentElement !== document.body) {
      document.body.appendChild(overlay);
    }
    overlay.style.display = "flex";
    overlay.style.visibility = "visible"; 
    overlay.style.opacity = "1";
    overlay.style.zIndex = "20000";
  } else {
    alert("Error: The 'agentOverlay' HTML is missing.");
  }
}
// ‚úÖ Function to load and display agent's PTO in the modal
function loadAgentPtoDisplay() {
  const ptoEl = document.getElementById("agPtoHours");
  if (!ptoEl) return;
  
  // Get balance from cached data
  const balance = _balanceData.get(window._myName) || { pto: 0 };
  
  ptoEl.textContent = balance.pto || 0;
  
  // Color code based on balance
  if (balance.pto <= 0) {
    ptoEl.style.color = "#ef4444"; // Red if zero
  } else if (balance.pto < 8) {
    ptoEl.style.color = "#f59e0b"; // Orange if low
  } else {
    ptoEl.style.color = "#16a34a"; // Green if good
  }
}
// Helper to update visual selection on type radio buttons
function updateTypeSelection() {
  const radios = document.querySelectorAll('input[name="timeOffType"]');
  radios.forEach(radio => {
    const label = radio.closest('label');
    if (radio.checked) {
      if (radio.value === 'Make Up') {
        label.style.borderColor = '#3b82f6';
        label.style.background = '#eff6ff';
      } else {
        label.style.borderColor = '#16a34a';
        label.style.background = '#f0fdf4';
      }
    } else {
      label.style.borderColor = '#e2e8f0';
      label.style.background = '#fff';
    }
  });
  // Toggle Make Up Date field
  const selected = document.querySelector('input[name="timeOffType"]:checked');
  const isMakeUp = selected && selected.value === "Make Up";
  const wrap = document.getElementById("agMakeUpWrap");
  const dateEl = document.getElementById("agMakeUpDate");
  if (wrap) wrap.style.display = isMakeUp ? "block" : "none";
  if (!isMakeUp && dateEl) dateEl.value = "";

  // ‚úÖ Show PTO balance warnings based on selection
  if (!isMakeUp) {
    const balance = _balanceData.get(window._myName) || { pto: 0 };
    const currentPto = parseFloat(balance.pto) || 0;

    // Update PTO display with warning color
    const ptoEl = document.getElementById("agPtoHours");
    if (ptoEl) {
      if (currentPto <= 0) {
        ptoEl.style.color = "#ef4444"; // Red if zero
        ptoEl.parentElement.style.borderColor = "#fca5a5";
        ptoEl.parentElement.style.background = "#fee2e2";
      } else if (currentPto < 8) {
        ptoEl.style.color = "#f59e0b"; // Orange if low
        ptoEl.parentElement.style.borderColor = "#fbbf24";
        ptoEl.parentElement.style.background = "#fef3c7";
      }
    }
  }
}

function showToast(message, type = 'info') {
    // Basic toast implementation
    const toastContainer = document.getElementById('toast-container') || document.body;
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0 show position-fixed bottom-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
  function showAgentForm(type) {
    if($("agActionSelect")) $("agActionSelect").style.display = "none";
    if (type === 'timeoff') {
        if($("agFormTimeOff")) $("agFormTimeOff").style.display = "block";
        updateTypeSelection();
        if($("agToReason")) {
            $("agToReason").value = "";
            $("agToReason").focus();
        }
    } else {
        if($("agFormSwap")) $("agFormSwap").style.display = "block";
        if($("agSwapNote")) $("agSwapNote").value = "";
    }
  }
  function resetAgentModal() {
    if($("agActionSelect")) $("agActionSelect").style.display = "block";
    if($("agFormTimeOff")) $("agFormTimeOff").style.display = "none";
    if($("agFormSwap")) $("agFormSwap").style.display = "none";
  }
  function openStaffingModal() {
  
  const modal = $("staffingModal");
  if(!modal) return console.error("Staffing modal div not found!");
  // Ensure it sits on top of the Admin modal (z-index)
  modal.style.zIndex = "10010"; 
  modal.style.display = "flex";
  
  // Fill the dropdown immediately using cached data (prevents "loading" delay)
  const sel = $("ruleTeam");
  sel.innerHTML = '<option value="">Select Team...</option>';
  if (_teams && _teams.length > 0) {
    _teams.forEach(t => sel.appendChild(new Option(t, t)));
  }
  
  // Load the list
  loadRules();
}
function closeStaffingModal() {
  $("staffingModal").style.display = "none";
}
  async function submitTimeOff() {
    const reason = $("agToReason") ? $("agToReason").value : "";
    if (!reason) return toast("Please enter a reason", "error");
    const dateStr = _editing ? _editing.dateISO : new Date().toISOString().split("T")[0];
    
    // NEW: Grab shift times from the global _editing variable
    const sStart = _editing ? _editing.startLabel : "";
    const sEnd = _editing ? _editing.endLabel : "";
    const teamName = _editing ? _editing.team : "";
    const radioSelected = document.querySelector('input[name="timeOffType"]:checked');
    const timeOffType = radioSelected ? radioSelected.value : "Make Up";
    const makeUpDate = $("agMakeUpDate") ? $("agMakeUpDate").value : "";
    if (timeOffType === "Make Up" && !makeUpDate) return toast("Please select a Make Up date", "error"); 
    
    // NEW: Grab duration from radio
    const durationSelected = document.querySelector('input[name="timeOffDuration"]:checked');
    const durationVal = durationSelected ? durationSelected.value : "shift";

    // ‚úÖ VALIDATE PTO BALANCE
    if (timeOffType === "PTO") {
      const balance = _balanceData.get(window._myName) || { pto: 0 };
      const currentPto = parseFloat(balance.pto) || 0;

      // Calculate hours needed (rough estimate)
      let hoursNeeded = durationVal === "full_day" ? 8 : 4;

      if (currentPto < hoursNeeded) {
        const result = await Swal.fire({
          title: '‚ö†Ô∏è Insufficient PTO Balance',
          html: `
            <div style="text-align: left; font-size: 14px; line-height: 1.6;">
              <p><strong>Current PTO Balance:</strong> ${currentPto} hours</p>
              <p><strong>Estimated Needed:</strong> ${hoursNeeded} hours</p>
              <p style="color: #dc2626; font-weight: 600;">You do not have enough PTO for this request.</p>
              <p style="margin-top: 12px; padding: 12px; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px;">
                üí° <strong>Consider using "Make Up" instead:</strong> Work at another time without using PTO hours.
              </p>
            </div>
          `,
          icon: 'warning',
          showCancelButton: false,
          confirmButtonText: 'OK',
          confirmButtonColor: '#dc2626'
        });
        return; // Block the request
      } else if (currentPto < hoursNeeded + 4) {
        // Warn if balance would be low after request
        const result = await Swal.fire({
          title: '‚ö†Ô∏è Low PTO Balance Warning',
          html: `
            <div style="text-align: left; font-size: 14px; line-height: 1.6;">
              <p><strong>Current PTO Balance:</strong> ${currentPto} hours</p>
              <p><strong>Estimated After Request:</strong> ~${Math.max(0, currentPto - hoursNeeded)} hours</p>
              <p style="color: #f59e0b; font-weight: 600;">Your PTO balance will be low after this request.</p>
              <p style="margin-top: 12px;">Do you want to continue?</p>
            </div>
          `,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, Continue',
          cancelButtonText: 'Cancel',
          confirmButtonColor: '#f59e0b'
        });
        if (!result.isConfirmed) return;
      }
    }

    const btn = event.currentTarget;
    const originalText = btn.innerText;
    btn.innerText = "Sending...";
    btn.disabled = true;
    try {
      const res = await fetch('./?action=timeoff/request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          person: window._myName,
          type: timeOffType,
          makeUpDate: makeUpDate,
          reason: reason,
          date: dateStr,
          shiftStart: sStart,
          shiftEnd: sEnd,
          team: teamName, // <--- Sending Team Name
          duration: durationVal,
          category: "pto"
        })
      });
    const data = await res.json();

    if (data.ok) {
      closeAgentModal(); // This calls the function to close the window

      // Show different messages for Make Up vs PTO
      if (timeOffType === "Make Up") {
        Swal.fire({
          title: 'Make-Up Request Sent!',
          html: `
            <div style="text-align: left; font-size: 14px; line-height: 1.6;">
              <p>Your manager has been notified.</p>
              <p style="margin-top: 12px; padding: 12px; background: #dbeafe; border-left: 3px solid #3b82f6; border-radius: 4px;">
                üìå <strong>Remember:</strong> You must work on <strong>${makeUpDate}</strong> to make up this time.
              </p>
            </div>
          `,
          icon: 'success',
          confirmButtonColor: '#3b82f6'
        });
      } else {
        Swal.fire({
          title: 'PTO Request Sent!',
          text: 'Your manager has been notified.',
          icon: 'success',
          confirmButtonColor: '#3b82f6'
        });
      }
      $("agToReason").value = "";
    } else {
      throw new Error(data.error || "Server rejected request");
    }
  } catch (err) {
    console.error(err);
    toast(`Error: ${err.message}`, "error");
  } finally {
    btn.innerText = originalText;
    btn.disabled = false;
  }
}
function closeAgentModal() {
  const modal = document.getElementById('agentOverlay'); // Note: Your HTML ID is 'agentOverlay', not 'agentModal'
  if (modal) {
    modal.style.display = "none";
  } else {
    console.error("Agent modal not found!");
  }
}
  async function submitSwap() {
    const targetPerson = $("agSwapPerson") ? $("agSwapPerson").value : "";
    const note = $("agSwapNote") ? $("agSwapNote").value : "";
    if (!targetPerson) return toast("Select a co-worker");
    if (!_editing) return toast("No shift selected");
    try {
      const res = await fetch('./?action=swap/request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          fromPerson: window._myName,
          toPerson: targetPerson,
          shiftDate: _editing.dateISO || _editing.date,
          shiftStart: _editing.startLabel || _editing.start,
          shiftEnd: _editing.endLabel || _editing.end,
          team: _editing.team,
          docId: _editing.docId,
          assignmentId: _editing.assignmentId,
          note: note
        })
      });
      
      const data = await res.json();
      
      if (data.ok) {
        closeAgentModal();
        toast(`‚úÖ Swap request sent to ${targetPerson}`, "success");
      } else {
        toast("Failed to send swap request: " + (data.error || "Unknown error"), "error");
      }
    } catch (err) {
      console.error("Swap request error:", err);
      toast("Failed to send swap request", "error");
    }
  }
  // --- 7. INTERACTIONS (Manager) ---
  function openReplaceModal(it) {
      _editing = it;
      $("mSub").textContent = `${it.dateLabel} ‚Ä¢ ${it.startLabel} ‚Ä¢ ${it.person}`;
      $("mNotes").value = it.notes || "";
      
      // Check for current "OFF" status
      const isOff = it.notes && it.notes.includes("[OFF]");
      const btn = $("actionBtn");
      if (isOff) { 
          // VISUAL: Green "Restore" state
          btn.innerHTML = "‚ôªÔ∏è Restore Shift"; 
          btn.style.color = "#15803d"; 
          btn.style.borderColor = "#bbf7d0"; 
          btn.style.background = "#f0fdf4";
          // Change the function it calls
          btn.onclick = restoreShift; 
      } else { 
          // VISUAL: Red "Mark Off" state
          btn.innerHTML = "‚õî Mark Off"; 
          btn.style.color = "#ef4444"; 
          btn.style.borderColor = "#fecaca"; 
          btn.style.background = "#fef2f2";
          // Change the function it calls
          btn.onclick = markTimeOff; 
      }
      $("modalOverlay").style.display = "flex";
      fillSelect("mNewPerson", _people.filter(p => p !== it.person), false);
  }
  async function saveReplace() {
  if (! _editing) return;
  const newP = document.getElementById("mNewPerson").value;
  if (! newP) return toast("Select person");
  const notes = document.getElementById("mNotes").value;
  const notifyMode = document.getElementById("mNotify").value;
  const originalPerson = _editing.person;
  const originalNotes = _editing.notes || "";
  
  // ============================================
  // CHECK FOR DOUBLE BOOKING BEFORE REPLACING
  // ============================================
  try {
    const conflictRes = await fetch('./?action=schedule/check-conflict', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        personName: newP,
        date: _editing.dateISO || _editing.date,
        startTime: _editing.start || _editing.startLabel,
        endTime: _editing.end || _editing.endLabel,
        excludeAssignmentId: _editing.assignmentId
      })
    });
    const conflictData = await conflictRes.json();
    
    if (conflictData.ok && conflictData.hasConflict && conflictData.conflicts.length > 0) {
      // Check if any conflicts are lunch-related
      const hasLunchConflict = conflictData.conflicts.some(c => c.isLunchConflict);
      
      // Show double booking warning with special lunch styling
      const conflictsList = conflictData.conflicts.map(c => {
        const icon = c.isLunchConflict ? 'üçΩÔ∏è' : '‚ö†Ô∏è';
        const style = c.isLunchConflict ? 'color:#dc2626; font-weight:700;' : '';
        return `<div style="${style}">${icon} ${c.team}: ${c.start}-${c.end}${c.isLunchConflict ? ' <b>(LUNCH!)</b>' : ''}</div>`;
      }).join('');
      
      const result = await Swal.fire({
        title: hasLunchConflict ? 'üçΩÔ∏è Lunch Conflict!' : '‚ö†Ô∏è Double Booking Detected',
        html: `
          <div style="text-align:left; padding:12px; background:${hasLunchConflict ? '#fef2f2' : '#fef3c7'}; border-radius:8px; border:1px solid ${hasLunchConflict ? '#fecaca' : '#fcd34d'};">
            <p style="margin:0 0 8px 0; font-weight:600;">${newP} is already scheduled:</p>
            ${conflictsList}
          </div>
          ${hasLunchConflict ? 
            '<p style="margin-top:12px; font-size:13px; color:#dc2626; font-weight:600;">‚ö†Ô∏è This would schedule during their lunch break!</p>' :
            '<p style="margin-top:12px; font-size:13px; color:#64748b;">Do you want to continue anyway?</p>'
          }
        `,
        icon: hasLunchConflict ? 'error' : 'warning',
        showCancelButton: true,
        confirmButtonColor: hasLunchConflict ? '#dc2626' : '#f59e0b',
        cancelButtonColor: '#64748b',
        confirmButtonText: hasLunchConflict ? 'Override Lunch' : 'Yes, Assign Anyway',
        cancelButtonText: 'Cancel'
      });
      
      if (!result.isConfirmed) {
        return; // User cancelled
      }
    }
  } catch (err) {
    console.warn("Conflict check failed, continuing:", err);
  }
  // Find the real local record
  const local = _allData.find(x =>
    String(x.assignmentId) === String(_editing.assignmentId) &&
    String(x.docId) === String(_editing.docId)
  ) || _editing;
  
  // ============================================
  // AUTO-ADD REPLACEMENT INFO TO NOTES
  // ============================================
  let enhancedNotes = notes;
  if (originalPerson && originalPerson !== newP && originalPerson !== "Unassigned") {
    // Check if notes already contains replacement info
    if (!notes.toLowerCase().includes("replaced") && !notes.toLowerCase().includes("covering")) {
      enhancedNotes = notes ? `${notes} [Replaced ${originalPerson}]` : `[Replaced ${originalPerson}]`;
    }
  }
  
  // Close modal + optimistic UI update
  document.getElementById("modalOverlay").style.display = "none";
  toast("Updating...");
  local.person = newP;
  local.notes = enhancedNotes;
  local.originalPerson = originalPerson; // Store for UI display
  renderView();
  const payload = {
    docId: _editing.docId,
    assignmentId: _editing.assignmentId,
    newPerson: newP,
    notes: enhancedNotes,
    notifyMode: notifyMode,
    originalPerson: originalPerson // Send to backend for tracking
  };
  
  try {
    const response = await fetch('./?action=assignment/replace', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const res = await response.json();
    
    if (res.ok || res.status === "success") {
      // Clear cache if agent
      if (! window._isManager && window._myName) {
        clearScheduleCache();
      }
      // Log to audit
      logAuditEntry({
        action: "REPLACE",
        manager: window._myName || window._myEmail,
        target: newP,
        date: local.dateLabel,
        details: `Replaced ${originalPerson} with ${newP} (${local.startLabel})`
      });
      // Handle Notifications
      if (res?.notifyStatus === "Pending" || notifyMode === "defer") {
        playNotificationSound();
        
        // ‚úÖ FIX: Add to local queue WITH undoData
        _notifQueue.push({
          person: newP,
          dateLabel: local.dateLabel || _editing.dateLabel,
          date: local.dateISO || _editing.dateISO,
          startLabel: local.startLabel || _editing.startLabel,
          endLabel: local.endLabel || _editing.endLabel,
          team: local.team || _editing.team,
          message: `${newP} replaced ${originalPerson} (${local.dateLabel} ${local.startLabel})`,
          // ‚úÖ This is what enables the Undo button! 
          undoData: { 
            docId: _editing.docId, 
            assignmentId: _editing.assignmentId, 
            newPerson: originalPerson,  // The ORIGINAL person to restore
            notes: originalNotes 
          }
        });
        
        localStorage.setItem("musely_notif_queue", JSON.stringify(_notifQueue));
        renderNotifications();
        updateNotifBadge();
        
        toast("Added to Pending Queue");
        // Open the panel briefly
        const panel = document.getElementById("notifPanel");
        if (panel) {
          panel.style.display = "block";
          panel.classList.add("open");
          loadPendingNotifications();
        }
      } else {
        playSendSound();
        toast("Saved & Sent");
      }
    } else {
      throw new Error(res.error || res.message || "Unknown error");
    }
  } catch (err) {
    // Rollback UI on failure
    local.person = originalPerson;
    local.notes = originalNotes;
    renderView();
    toast(`Replace failed: ${err.message || err}`);
    console.error("Replace failed:", err, payload);
  }
}
  function checkUrlNotifs() {
    // Use standard URL API instead of google.script.url
    try {
      const hash = window.location.hash;
      if (hash && hash.includes("notif=")) {
        const rawMsg = hash.split("notif=")[1];
        const msg = decodeURIComponent(rawMsg);
        Swal.fire({
            title: 'Schedule Update',
            html: msg,
            icon: 'info',
            confirmButtonText: 'Got it',
            confirmButtonColor: '#1e293b'
        });
        try { history.replaceState(null, null, ' '); } catch(e) {}
      }
    } catch(e) {
      console.log("URL check error:", e);
    }
  }
  function isBackupShift(shift) {
  const notes = String(shift.notes || "").toLowerCase();
  const patterns = [
    "back up",
    "backup", 
    "coverage",
    "covering",
    "temp",
    "temporary",
    "replacing",
    "replaced",
    "fill in",
    "fill-in",
    "fillin"
  ];
  
  return patterns.some(p => notes.includes(p));
}
function isCaptainShift(shift) {
  const notes = String(shift.notes || "").toLowerCase();
  return notes.includes("captain") || notes.includes("lead") || notes.includes("supervisor");
}
  function handleSaveClick() {
     if(!_editing) return;
     const isOff = _editing.notes && _editing.notes.includes("[OFF]");
     if(isOff) restoreShift(); else markTimeOff();
  }
  function markTimeOff(force) {
  if(!_editing) return;
  const doIt = async () => {
    // optimistic UI
    _timeOff.add(`${_editing.person}|${_editing.dateISO}`);
    _editing.notes = ((_editing.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim() + " [OFF]").trim();
    renderView();
    closeModal();
    toast("Marking person OFF...");
    
    try {
      const response = await fetch('./?action=assignment/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          docId: _editing.docId,
          assignmentId: _editing.assignmentId,
          markOff: true
        })
      });
      
      const res = await response.json();
      
      if (res.ok || res.status === "success") {
        if (!window._isManager && window._myName) {
          clearScheduleCache();
        }
        logAuditEntry({
          action: "MARK OFF",
          manager: window._myName || window._myEmail,
          target: _editing.person,
          date: _editing.dateLabel,
          details: `Marked ${_editing.person} as OFF (${_editing.startLabel})`
        });
        if (res && res.requireConfirm && !force) {
          Swal.fire({
            title: "Staffing Alert",
            text: res.message,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Mark Off Anyway",
            confirmButtonColor: "#ef4444"
          }).then((r) => { if (r.isConfirmed) markTimeOff(true); });
          return;
        }
        toast("Success: Marked OFF");
      } else {
        throw new Error(res.error || res.message || "Unknown error");
      }
    } catch (err) {
      toast(`Failed: ${err.message || err}`);
      console.error("markTimeOff failed:", err);
      // rollback UI
      _timeOff.delete(`${_editing.person}|${_editing.dateISO}`);
      _editing.notes = (_editing.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim();
      renderView();
    }
  };
  if (force) return doIt();
  Swal.fire({
    title: "Mark OFF?",
    text: `Are you sure you want to mark ${_editing.person} OFF for this shift?`,
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, Mark OFF",
    confirmButtonColor: "#ef4444",
    cancelButtonColor: "#cbd5e1"
  }).then((r) => { if (r.isConfirmed) doIt(); });
}
  function restoreShift() {
  if (!_editing) return;
  const doIt = async () => {
    // optimistic UI
    _timeOff.delete(`${_editing.person}|${_editing.dateISO}`);
    _editing.notes = (_editing.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim();
    renderView();
    closeModal();
    toast("Restoring shift...");
    
    try {
      const response = await fetch('./?action=assignment/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          docId: _editing.docId,
          assignmentId: _editing.assignmentId,
          markOff: false
        })
      });
      
      const res = await response.json();
      
      if (res.ok || res.status === "success") {
        if (!window._isManager && window._myName) {
          clearScheduleCache();
        }
        logAuditEntry({
          action: "RESTORE",
          manager: window._myName || window._myEmail,
          target: _editing.person,
          date: _editing.dateLabel,
          details: `Restored ${_editing.person}'s shift (${_editing.startLabel})`
        });
        toast("Success: Shift Restored");
      } else {
        throw new Error(res.error || res.message || "Unknown error");
      }
    } catch (e) {
      toast(`Restore failed: ${e.message || e}`);
      console.error("restoreShift failed:", e);
    }
  };
  
  Swal.fire({
    title: "Restore Shift?",
    text: `Remove the OFF status and restore ${_editing.person}'s shift?`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Yes, Restore",
    confirmButtonColor: "#15803d",
    cancelButtonColor: "#cbd5e1"
  }).then((r) => { if (r.isConfirmed) doIt(); });
}
// ============================================
// HOLIDAYS MANAGEMENT
// ============================================
let _holidays = new Map(); // date -> { name, theme, emoji }
// Fetch holidays from backend
async function loadHolidays() {
  try {
    const res = await fetch("/?action=holidays/list");
    const data = await res.json();
    
    if (data.ok && data.holidays) {
      _holidays.clear();
      data.holidays.forEach(h => {
        _holidays.set(h.date, {
          name: h.name,
          theme: h.theme || "default",
          emoji: h.emoji || "‚≠ê"
        });
      });
    }
  } catch (err) {
    console.error("Failed to load holidays:", err);
  }
}
// Check if a date is a holiday
function getHoliday(dateStr) {
  return _holidays.get(dateStr) || null;
}
// Open holiday modal
function openHolidayModal() {
  closeAdminModal();
  $("holidayModal").style.display = "flex";
  renderHolidayListWithAccruals();
}
// Close holiday modal
function closeHolidayModal() {
  $("holidayModal").style.display = "none";
}
// Render holiday list in modal (wrapper for enhanced version)
function renderHolidayList() {
  renderHolidayListWithAccruals();
}
// Add a new holiday
async function addHoliday() {
  const date = $("holidayDate").value;
  const name = $("holidayName").value.trim();
  const theme = $("holidayTheme").value;
  const emoji = $("holidayEmoji").value;
  
  if (!date || !name) {
    showToast("Please enter date and name", "error");
    return;
  }
  
  try {
    const res = await fetch("/?action=holidays/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ date, name, theme, emoji })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      showToast("Holiday added!", "success");
      
      // Update local cache
      _holidays.set(date, { name, theme, emoji });
      
      // Clear form
      $("holidayDate").value = "";
      $("holidayName").value = "";
      
      // Refresh list and calendar
      renderHolidayListWithAccruals();
      renderView();
    } else {
      showToast(data.error || "Failed to add holiday", "error");
    }
  } catch (err) {
    showToast("Error adding holiday", "error");
    console.error(err);
  }
}
// Delete a holiday
async function deleteHoliday(date) {
  if (!confirm("Delete this holiday?")) return;
  
  try {
    const res = await fetch("/?action=holidays/delete", {
      method: "POST",
      headers: { "Content-Type":  "application/json" },
      body: JSON.stringify({ date })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      showToast("Holiday deleted", "success");
      
      // Update local cache
      _holidays.delete(date);
      
      // Refresh list and calendar
      renderHolidayListWithAccruals();
      renderView();
    } else {
      showToast(data.error || "Failed to delete", "error");
    }
  } catch (err) {
    showToast("Error deleting holiday", "error");
    console.error(err);
  }
}

// ============================================
// HOLIDAY HOURS ACCRUAL SYSTEM
// ============================================

// Accrue holiday hours for an agent who worked on a holiday
async function accrueHolidayHours(person, date, hoursWorked = 8) {
  try {
    const res = await fetch('/?action=holiday/accrue', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ person, date, hoursWorked })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`üéÑ ${data.message}`, "success");
      // Refresh balances
      loadBalances();
      return true;
    } else {
      toast(data.error || "Failed to accrue hours", "error");
      return false;
    }
  } catch (err) {
    console.error("Holiday accrue error:", err);
    toast("Error accruing holiday hours", "error");
    return false;
  }
}

// Process holiday accruals for all agents who worked on a specific holiday
async function processHolidayAccruals(holidayDate) {
  const holiday = _holidays.get(holidayDate);
  if (!holiday) {
    toast("Holiday not found", "error");
    return;
  }
  
  // Find all shifts on this date
  const holidayShifts = _allData.filter(s => 
    s.dayKey === holidayDate && 
    s.person && 
    !(s.notes || "").includes("[OFF]")
  );
  
  if (holidayShifts.length === 0) {
    toast("No agents worked on this holiday", "warning");
    return;
  }
  
  // Group by person to avoid duplicate accruals
  const peopleWorked = new Map();
  holidayShifts.forEach(shift => {
    if (!peopleWorked.has(shift.person)) {
      // Calculate hours from shift times
      const startHour = parseTimeDecimal(shift.start || shift.startLabel);
      const endHour = parseTimeDecimal(shift.end || shift.endLabel);
      const hours = endHour > startHour ? endHour - startHour : 8;
      peopleWorked.set(shift.person, hours);
    } else {
      // Add hours if multiple shifts
      const startHour = parseTimeDecimal(shift.start || shift.startLabel);
      const endHour = parseTimeDecimal(shift.end || shift.endLabel);
      const hours = endHour > startHour ? endHour - startHour : 0;
      peopleWorked.set(shift.person, peopleWorked.get(shift.person) + hours);
    }
  });
  
  // Confirm with manager
  const result = await Swal.fire({
    title: `üéÑ Process ${holiday.name} Bonus?`,
    html: `
      <div style="text-align:left; padding:12px; background:#f0fdf4; border-radius:8px; border:1px solid #86efac; margin-bottom:12px;">
        <p style="margin:0 0 8px 0; font-weight:600; color:#15803d;">${peopleWorked.size} agents worked on ${holiday.name}:</p>
        ${Array.from(peopleWorked.entries()).map(([person, hours]) => 
          `<div style="font-size:13px; padding:4px 0; color:#166534;">‚Ä¢ ${person}: ${hours}h worked ‚Üí <strong>+${(hours * 0.5).toFixed(1)}h PTO</strong></div>`
        ).join('')}
      </div>
      <p style="font-size:13px; color:#64748b;">This will add holiday bonus hours (50% of hours worked) directly to each agent's PTO balance.</p>
    `,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#16a34a',
    cancelButtonColor: '#64748b',
    confirmButtonText: '‚úÖ Add to PTO',
    cancelButtonText: 'Cancel'
  });
  
  if (!result.isConfirmed) return;
  
  // Process each person
  let success = 0;
  let failed = 0;
  
  for (const [person, hours] of peopleWorked) {
    const ok = await accrueHolidayHours(person, holidayDate, hours);
    if (ok) success++;
    else failed++;
  }
  
  if (failed === 0) {
    toast(`‚úÖ Processed holiday hours for ${success} agents`, "success");
  } else {
    toast(`Processed ${success} of ${success + failed} agents`, "warning");
  }
}

// Add button to holiday list items for processing accruals
function renderHolidayListWithAccruals() {
  const container = $("holidayList");
  
  if (_holidays.size === 0) {
    container.innerHTML = `<div style="text-align:center; color:#94a3b8; padding:20px;">No holidays scheduled</div>`;
    return;
  }
  
  const today = pstISODate();
  const sorted = Array.from(_holidays.entries()).sort((a, b) => a[0].localeCompare(b[0]));
  
  container.innerHTML = sorted.map(([date, h]) => {
    const displayDate = new Date(date + "T00:00:00").toLocaleDateString("en-US", {
      weekday: "short",
      month: "short",
      day:  "numeric",
      year: "numeric"
    });
    
    const isPast = date < today;
    const isToday = date === today;
    
    // Show "Add PTO Bonus" button for past holidays
    const accrueBtn = isPast ? 
      `<button class="btn ghost" style="font-size:10px; padding:4px 8px; background:#f0fdf4; border-color:#86efac; color:#15803d;" onclick="processHolidayAccruals('${date}')">üí∞ Add PTO</button>` : 
      (isToday ? `<span style="font-size:10px; color:#3b82f6; font-weight:600;">Today!</span>` : '');
    
    return `
      <div class="holidayItem" style="${isPast ? 'opacity:0.7;' : ''}">
        <div class="holidayInfo">
          <span class="holidayEmoji">${h.emoji}</span>
          <div>
            <div class="holidayName">${h.name}</div>
            <div class="holidayDate">${displayDate}</div>
          </div>
        </div>
        <div style="display:flex; gap:6px; align-items:center;">
          ${accrueBtn}
          <button class="deleteHolidayBtn" onclick="deleteHoliday('${date}')" title="Delete holiday">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }).join("");
}

// Load 30 days of past schedule
async function loadPastSchedule() {
  if (_isLoadingMore) return;
  if (_scheduleLoadedPast >= 30) {
    toast("Past 30 days already loaded");
    return;
  }
  
  _isLoadingMore = true;
  const btn = document.getElementById("btnLoadPast");
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Loading...";
  }
  toast("Loading past schedule...", "info");
  
  try {
    const res = await fetch('./?action=schedule/past', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        daysBack: 30,
        isManager: window._isManager,
        agentName: window._myName
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.results) {
      // Process and merge past data into _allData
      const pastShifts = [];
      data.results.forEach(day => {
        if (day.assignments) {
          day.assignments.forEach(a => {
            const docId = String(day.id || "");
            const teamName = (docId.includes("__") ? docId.split("__")[1] : "") || day.team || "General";
            const assignmentId = a.assignmentId ?? a.id ?? "";
            
            // Extract date from docId (format: "2025-01-01__TeamName")
            const dateFromId = docId.includes("__") ? docId.split("__")[0] : "";
            const dateValue = day.date || dateFromId || "";
            const dayKey = dayKeyPST(dateValue) || dateValue;
            
            // Check if this shift already exists
            const exists = _allData.some(x => 
              x.docId === docId && x.assignmentId === assignmentId
            );
            
            if (!exists && dayKey) {
              pastShifts.push({
                ...a,
                docId,
                assignmentId,
                date: dateValue,
                dateISO: dayKey,
                dateLabel: displayDayLabel(dayKey),
                team: teamName,
                startLabel: toAmPm(a.start) || a.start,
                endLabel: toAmPm(a.end) || a.end
              });
            }
          });
        }
      });
      
      // Merge with existing data
      _allData = [...pastShifts, ..._allData];
      
      // Sort by date
      _allData.sort((a, b) => (a.dateISO || "").localeCompare(b.dateISO || ""));
      
      _scheduleLoadedPast = 30;
      updateLoadedRangeLabel();
      
      // Re-apply filters and render
      applyLocalFilters();
      renderView();
      
      toast(`‚úÖ Loaded ${pastShifts.length} past shifts`, "success");
    }
    
  } catch (err) {
    console.error("Error loading past schedule:", err);
    toast("Failed to load past schedule", "error");
  } finally {
    _isLoadingMore = false;
    if (btn) {
      btn.disabled = false;
      btn.textContent = "‚Üê Load 30 Days History";
    }
  }
}
// Update the label showing current loaded range
function updateLoadedRangeLabel() {
  const label = document.getElementById("loadedRangeLabel");
  if (!label) return;
  
  let text = "";
  if (_scheduleLoadedPast > 0) {
    text += `${_scheduleLoadedPast}d ago`;
  } else {
    text += "Today";
  }
  text += ` ‚Üí ${_scheduleLoadedFuture}d ahead`;
  
  label.textContent = text;
  
  // Update button states
  const btnPast = document.getElementById("btnLoadPast");
  const btnFuture = document.getElementById("btnLoadFuture");
  
  if (btnPast) {
    if (_scheduleLoadedPast >= 30) {
      btnPast.style.display = "none";
    } else {
      btnPast.style.display = "";
      btnPast.textContent = "‚Üê Load History";
    }
  }
  if (btnFuture) {
    if (_scheduleLoadedFuture >= 60) {
      btnFuture.style.display = "none";
    } else {
      btnFuture.style.display = "";
      btnFuture.textContent = "Load Future ‚Üí";
    }
  }
}
// Load extended future schedule (up to 60 days)
async function loadExtendedFuture() {
  if (_isLoadingMore) return;
  if (_scheduleLoadedFuture >= 60) {
    toast("60 days future already loaded");
    return;
  }
  
  _isLoadingMore = true;
  const btn = document.getElementById("btnLoadFuture");
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Generating...";
  }
  toast("Loading & generating future schedule...", "info");
  
  try {
    // Start from where we left off
    const today = new Date();
    const startFrom = new Date(today);
    startFrom.setDate(startFrom.getDate() + _scheduleLoadedFuture);
    const startISO = startFrom.toISOString().split("T")[0];
    
    const daysToLoad = 60 - _scheduleLoadedFuture;
    
    const res = await fetch('./?action=schedule/future', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        daysForward: daysToLoad,
        startFrom: startISO,
        isManager: window._isManager,
        agentName: window._myName
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.results) {
      // Process and merge future data into _allData
      const futureShifts = [];
      data.results.forEach(day => {
        if (day.assignments) {
          day.assignments.forEach(a => {
            const docId = String(day.id || "");
            const teamName = (docId.includes("__") ? docId.split("__")[1] : "") || day.team || "General";
            const assignmentId = a.assignmentId ?? a.id ?? "";
            
            // Extract date from docId (format: "2025-01-01__TeamName")
            const dateFromId = docId.includes("__") ? docId.split("__")[0] : "";
            const dateValue = day.date || dateFromId || "";
            const dayKey = dayKeyPST(dateValue) || dateValue;
            
            // Check if this shift already exists
            const exists = _allData.some(x => 
              x.docId === docId && x.assignmentId === assignmentId
            );
            
            if (!exists && dayKey) {
              futureShifts.push({
                ...a,
                docId,
                assignmentId,
                date: dateValue,
                dateISO: dayKey,
                dateLabel: displayDayLabel(dayKey),
                team: teamName,
                startLabel: toAmPm(a.start) || a.start,
                endLabel: toAmPm(a.end) || a.end
              });
            }
          });
        }
      });
      
      // Merge with existing data
      _allData = [..._allData, ...futureShifts];
      
      // Sort by date
      _allData.sort((a, b) => (a.dateISO || "").localeCompare(b.dateISO || ""));
      
      _scheduleLoadedFuture = 60;
      updateLoadedRangeLabel();
      
      // Re-apply filters and render
      applyLocalFilters();
      renderView();
      
      // Show detailed toast with generated count
      const generated = data.meta?.generatedDays || 0;
      if (generated > 0) {
        toast(`‚úÖ Loaded ${futureShifts.length} shifts (${generated} new days generated)`, "success");
      } else {
        toast(`‚úÖ Loaded ${futureShifts.length} future shifts`, "success");
      }
    }
    
  } catch (err) {
    console.error("Error loading future schedule:", err);
    toast("Failed to load future schedule", "error");
  } finally {
    _isLoadingMore = false;
    if (btn) {
      btn.disabled = false;
      btn.textContent = "Load Future ‚Üí";
    }
  }
}

// Agent-specific schedule loader (simplified - loads 30 days total)
async function agentLoadMoreSchedule() {
  if (_isLoadingMore) return;
  if (_agentScheduleDays >= 30) {
    toast("30 days already loaded");
    return;
  }
  
  _isLoadingMore = true;
  const btn = document.getElementById("btnAgentLoadMore");
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = "‚è≥ Loading...";
  }
  
  toast("Loading more schedule...", "info");
  
  try {
    // Load from day 15 to day 30
    const today = new Date();
    const startFrom = new Date(today);
    startFrom.setDate(startFrom.getDate() + _agentScheduleDays);
    const startISO = startFrom.toISOString().split("T")[0];
    
    const daysToLoad = 30 - _agentScheduleDays;
    
    const res = await fetch('./?action=schedule/future', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        daysForward: daysToLoad,
        startFrom: startISO,
        isManager: false,
        agentName: window._myName
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.results) {
      const newShifts = [];
      data.results.forEach(day => {
        if (day.assignments) {
          day.assignments.forEach(a => {
            const docId = String(day.id || "");
            const teamName = (docId.includes("__") ? docId.split("__")[1] : "") || day.team || "General";
            const assignmentId = a.assignmentId ?? a.id ?? "";
            const dateFromId = docId.includes("__") ? docId.split("__")[0] : "";
            const dateValue = day.date || dateFromId || "";
            const dayKey = dayKeyPST(dateValue) || dateValue;
            
            const exists = _allData.some(x => 
              x.docId === docId && x.assignmentId === assignmentId
            );
            
            if (!exists && dayKey) {
              newShifts.push({
                ...a,
                docId,
                assignmentId,
                date: dateValue,
                dateISO: dayKey,
                dateLabel: displayDayLabel(dayKey),
                team: teamName,
                startLabel: toAmPm(a.start) || a.start,
                endLabel: toAmPm(a.end) || a.end
              });
            }
          });
        }
      });
      
      _allData = [..._allData, ...newShifts];
      _allData.sort((a, b) => (a.dateISO || "").localeCompare(b.dateISO || ""));
      
      _agentScheduleDays = 30;
      updateAgentRangeLabel();
      
      // Clear cache since we have new data
      clearScheduleCache();
      
      applyLocalFilters();
      renderView();
      
      toast(`‚úÖ Loaded ${newShifts.length} more shifts`, "success");
    }
  } catch (err) {
    console.error("Error loading agent schedule:", err);
    toast("Failed to load schedule", "error");
  } finally {
    _isLoadingMore = false;
    if (btn) {
      btn.disabled = _agentScheduleDays >= 30;
      btn.innerHTML = _agentScheduleDays >= 30 ? "‚úÖ 30 Days Loaded" : "üìÜ Load 30 Days";
      if (_agentScheduleDays >= 30) {
        btn.style.background = "#f0fdf4";
        btn.style.borderColor = "#86efac";
        btn.style.color = "#15803d";
      }
    }
  }
}

function updateAgentRangeLabel() {
  const label = document.getElementById("agentRangeLabel");
  if (label) {
    label.textContent = `Today ‚Üí ${_agentScheduleDays} days`;
  }
}
  
  async function runUndo() { 
    if (!_lastUndo) return;
    try {
      const res = await fetch('./?action=assignment/replace', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          docId: _lastUndo.docId,
          assignmentId: _lastUndo.id, 
          newPerson: _lastUndo.oldP, 
          notes: _lastUndo.notes || "",
          notifyMode: "defer"
        })
      });
      const data = await res.json();
      if (data.ok) {
        _lastUndo = null;
        loadSystemData();
        toast("‚úÖ Undo successful", "success");
      } else {
        toast("Undo failed: " + (data.error || "Unknown error"), "error");
      }
    } catch (err) {
      console.error("Undo error:", err);
      toast("Undo failed", "error");
    }
  }
  function closeModal() {
    // Hide the Master Schedule Edit modal
    const editModal = document.getElementById("editShiftModal");
    if (editModal) editModal.style.display = "none";
    // Hide the Replace Coverage modal
    const replaceModal = document.getElementById("modalOverlay");
    if (replaceModal) replaceModal.style.display = "none";
    
    // Clear the editing reference
    _editing = null;
  }
  // --- 8. PROFILES & METRICS ---
  function openProfile(name) {
     _activeProfileRequest = name;
     $("profileOverlay").style.display = "flex"; $("profContent").style.display = "none"; $("profLoader").style.display = "block";
     $("pName").innerText = name; $("profLoader").innerText = "Loading...";
     const cached = _zendeskMetricsByName.get(String(name));
     if(cached) { renderProfileCached(cached); }
     
     // Use fetch instead of google.script.run
     fetch('./?action=agent-profile', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ name: name })
     })
     .then(res => res.json())
     .then(data => {
       if(data.name !== _activeProfileRequest) return;
       if(data.error) {
         $("profLoader").innerText = "Error: " + data.error;
         return;
       }
       renderProfileData(data);
     })
     .catch(err => {
       console.error("Profile fetch error:", err);
       $("profLoader").innerText = "Failed to load profile";
     });
  }
  // Switch day by offset (-1 or +1)
function changeDay(offset) {
    if (!_selectedDateISO) return;
    
    const current = new Date(_selectedDateISO + "T12:00:00");
    current.setDate(current.getDate() + offset);
    
    // Convert back to YYYY-MM-DD
    const newDateISO = current.toLocaleDateString("en-CA", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
    });
    
    // Update and render
    _selectedDateISO = newDateISO;
    renderScheduleView();
    
    // Scroll the tab into view
    setTimeout(() => {
        const activeTab = document.querySelector('.day-tab.active');
        if(activeTab) activeTab.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}
// Jump to specific date from picker
function handleDateJump(val) {
    if (!val) return;
    _selectedDateISO = val;
    renderScheduleView();
    toast(`Jumped to ${val}`);
}
  function renderProfileData(data) {
     $("profLoader").style.display = "none";
     if(data.error) { $("profLoader").style.display = "block"; $("profLoader").innerText = data.error; return; }
     $("profContent").style.display = "block";
     
     $("pName").innerText = data.name; $("pEmail").innerText = data.email; $("pRole").innerText = data.role;
     $("pSolved").innerText = data.solvedWeek ?? "--"; 
     $("pCSAT").innerText = formatCsatDisplay(data.csatScore);
     
     const q = "type:ticket status<solved assignee:\"" + data.name + "\"";
     const url = "https://musely.zendesk.com/agent/search/1?query=" + encodeURIComponent(q);
     const el = $("pTickets"); el.innerHTML = "";
     const a = document.createElement("a"); a.href = url; a.target = "_blank"; a.innerText = (data.openTickets ?? "--") + " üîó";
     el.appendChild(a);
     
     $("pAvatar").src = data.avatar || "https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y";
     $("pLogin").innerText = data.lastLogin ? new Date(data.lastLogin).toLocaleDateString() : "Never";
  }
  function renderProfileCached(c) {
     $("profContent").style.display = "block";
     $("pName").innerText = c.agentName; $("pEmail").innerText = c.email; 
     $("pSolved").innerText = c.solvedWeek ?? "--"; 
     $("pCSAT").innerText = formatCsatDisplay(c.csatPct);
     
     $("pTickets").innerText = c.openTickets ?? "--";
     $("pLogin").innerText = "Cached";
     if(c.zendeskUserId) {
        const url = "https://musely.zendesk.com/agent/search/1?query=" + encodeURIComponent("assignee_id:"+c.zendeskUserId);
        const el = $("pTickets"); el.innerHTML = "";
        const a = document.createElement("a"); a.href = url; a.target = "_blank"; a.innerText = (c.openTickets ?? "--") + " üîó";
        el.appendChild(a);
     }
  }
  function renderMetricsList() {
     const host = $("metricsList"); host.innerHTML = "";
     const q = ($("metricsSearch").value || "").toLowerCase();
     _people.filter(p => !q || p.toLowerCase().includes(q)).forEach(p => {
         const row = mkDiv("metricsRow");
         row.innerHTML = `<div class="left"><div class="avatar">${p.substring(0,2)}</div><div class="name">${p}</div></div>`;
         row.onclick = () => openMetricsProfile(p);
         host.appendChild(row);
     });
  }
  function openMetricsProfile(name) {
    _activeMetricsRequest = name;
    
    const d = document.getElementById("metricsDrawer"); 
    d.classList.add("open");
    
    const loader = document.getElementById("mProfLoader");
    const content = document.getElementById("mProfContent");
    
    loader.style.display = "block";
    loader.innerHTML = `<div style="text-align:center; padding:20px;">
                          <div class="spinner-border" style="width:20px; height:20px; border:3px solid #cbd5e1; border-top:3px solid #3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px;"></div>
                          <div>Fetching data for <b>${name}</b>...</div>
                          <div style="font-size:10px; color:#94a3b8; margin-top:5px;">This may take a moment...</div>
                        </div>`;
    
    content.style.display = "none";
    
    // Use fetch instead of google.script.run
    fetch('./?action=agent-profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name })
    })
    .then(res => res.json())
    .then(data => renderMetricsProfileData(data))
    .catch(err => {
      loader.innerHTML = `<div style="color:red;">System Error: ${err.message || err}</div>`;
    });
    
    setTimeout(() => {
        if (loader.style.display !== "none" && !loader.innerHTML.includes("Error") && !loader.innerHTML.includes("System Error")) {
             loader.innerHTML = `<div style="color:#f59e0b; background:#fffbeb; padding:10px; border-radius:8px; border:1px solid #fcd34d;">
                                  <strong>Taking longer than usual...</strong><br>
                                  The server is still processing. Please wait or try again.<br>
                                  <button class="btn ghost" style="margin-top:8px; font-size:11px;" onclick="openMetricsProfile('${name}')">Retry</button>
                                </div>`;
        }
    }, 30000);
  }
  function renderMetricsProfileData(data) {
    const loader = document.getElementById("mProfLoader");
    const content = document.getElementById("mProfContent");
    if (!data || data.error) {
        const errorMsg = data ? data.error : "Unknown error from server";
        loader.style.display = "block";
        loader.innerHTML = `<div style="color:#ef4444; background:#fef2f2; padding:10px; border-radius:8px; border:1px solid #fecaca;">
                              <strong>Error:</strong> ${errorMsg}
                            </div>`;
        content.style.display = "none";
        return;
    }
    loader.style.display = "none";
    content.style.display = "block";
    if(document.getElementById("mName")) document.getElementById("mName").innerText = data.name || "--";
    if(document.getElementById("mEmail")) document.getElementById("mEmail").innerText = data.email || "--";
    if(document.getElementById("mRole")) document.getElementById("mRole").innerText = data.role || "--";
    
    if(document.getElementById("mSolved")) document.getElementById("mSolved").innerText = data.solvedWeek ?? "--";
    if(document.getElementById("mCSAT")) document.getElementById("mCSAT").innerText = formatCsatDisplay(data.csatScore);
    if(document.getElementById("mOpen")) document.getElementById("mOpen").innerText = data.openTickets ?? "--";
    
    // Show CSAT breakdown (good/bad counts)
    if(document.getElementById("mCSATDetail")) {
        const good = data.csatGood || 0;
        const bad = data.csatBad || 0;
        const total = good + bad;
        if (total > 0) {
            document.getElementById("mCSATDetail").innerText = `${good} good, ${bad} bad`;
        } else {
            document.getElementById("mCSATDetail").innerText = "No ratings";
        }
    }
    
    if(document.getElementById("mAvatar")) {
        document.getElementById("mAvatar").src = data.avatar || "https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y";
    }
    if(document.getElementById("mLogin")) {
        if (data.lastLogin) {
            const dateObj = new Date(data.lastLogin);
            const nice = dateObj.toLocaleDateString('en-US', { month:'short', day:'numeric' }) + ", " + dateObj.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
            document.getElementById("mLogin").innerText = nice;
        } else {
            document.getElementById("mLogin").innerText = "Never";
        }
    }
    updateMetricLinks(data);
  }
  // Force refresh - clears cache and reloads data
function forceRefresh() {
  console.log("üîÑ Force refresh triggered");
  
  // Clear the local storage cache
  if (typeof clearScheduleCache === 'function') {
    clearScheduleCache();
  } else {
    // Fallback: manually clear cache keys
    localStorage.removeItem('musely_schedule_cache');
    localStorage.removeItem('musely_metadata_cache');
    try {
      // Clear any agent-specific cache
      const myName = window._myName || '';
      if (myName) {
        localStorage.removeItem(`musely_schedule_cache_${myName}`);
      }
    } catch(e) {}
  }
  
  // Show feedback
  toast("üîÑ Refreshing...", "info");
  
  // Reload data
  if (typeof load === 'function') {
    load(true); // true = force refresh
  } else if (typeof loadSystemData === 'function') {
    loadSystemData();
  } else {
    // Fallback: reload the page
    window.location.reload();
  }
}
// Make it globally accessible
window.forceRefresh = forceRefresh;
  function updateMetricLinks(data) {
     const openA = document.getElementById("mOpenTicketsLink");
     const badA = document.getElementById("mBadCsatLink");
     
     if (!openA || !badA) return;
     
     const userId = data.zendeskUserId || data.id;
     const agentEmail = data.email;
     const agentName = data.name;
     
     if (!userId && !agentEmail) {
         openA.style.opacity = "0.5";
         badA.style.opacity = "0.5";
         openA.onclick = (e) => { e.preventDefault(); toast("‚ö†Ô∏è No agent info available", "error"); };
         badA.onclick = (e) => { e.preventDefault(); toast("‚ö†Ô∏è No agent info available", "error"); };
         return;
     }
     
     // Build Zendesk search URLs
     // Per Zendesk docs: assignee can be ID, name, or email
     // For satisfaction: use "satisfaction:good" or "satisfaction:bad" (not satisfaction_rating)
     const assigneeFilter = agentEmail ? `assignee:${agentEmail}` : `assignee_id:${userId}`;
     
     // Open tickets = status less than solved
     const openQuery = `${assigneeFilter} status<solved`;
     const openUrl = `https://musely.zendesk.com/agent/search/1?query=${encodeURIComponent(openQuery)}`;
     
     // Bad CSAT tickets - use "satisfaction:bad" per Zendesk search reference
     // Note: This searches tickets where satisfaction IS bad (includes bad and bad_with_comment)
     const badQuery = `${assigneeFilter} satisfaction:bad`;
     const badUrl = `https://musely.zendesk.com/agent/search/1?query=${encodeURIComponent(badQuery)}`;
     
     // Set as direct links
     openA.href = openUrl;
     openA.target = "_blank";
     openA.onclick = null;
     
     badA.href = badUrl;
     badA.target = "_blank";
     badA.onclick = null;
     
     // Make sure links are visible and clickable
     openA.style.pointerEvents = "auto";
     badA.style.pointerEvents = "auto";
     openA.style.opacity = "1";
     badA.style.opacity = "1";
  }
  function closeMetricsDrawer() { $("metricsDrawer").classList.remove("open"); }
  function closeProfile() { $("profileOverlay").style.display = "none"; }
  // --- 9. AUDIT & MASTER MODES ---
  function openAuditLog() {
  $("auditOverlay").style.display = "flex";
  $("auditList").innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">Fetching logs from server...</td></tr>`;
  
  fetch("/?action=audit/logs")
    .then(res => res.json())
    .then(data => {
      if (data.ok && data.logs) {
        renderAuditLog(data.logs);
      } else {
        $("auditList").innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#ef4444;">Failed to load audit logs</td></tr>`;
      }
    })
    .catch(err => {
      console.error("Audit fetch error:", err);
      $("auditList").innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#ef4444;">Error: ${err.message}</td></tr>`;
    });
}
  function closeAuditModal() { $("auditOverlay").style.display = "none"; }
  function renderAuditLog(logs) {
  const list = $("auditList");
  list.innerHTML = "";
  
  if (!logs || logs.length === 0) {
    list.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">No history found.</td></tr>`;
    return;
  }
  
  logs.forEach(row => {
    const tr = document.createElement("tr");
    let badgeClass = "ab-blue";
    if (String(row.action || "").includes("OFF") || String(row.action || "").includes("DELETE")) {
      badgeClass = "ab-red";
    }
    
    let niceTime = row.timestamp;
    try {
      const d = new Date(row.timestamp);
      niceTime = d.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    } catch (e) {}
    
    tr.innerHTML = `
      <td>${niceTime}</td>
      <td style="font-weight:600;">${row.manager || row.user || "System"}</td>
      <td><span class="audit-badge ${badgeClass}">${row.action || "CHANGE"}</span></td>
      <td>${row.target || row.person || "‚Äî"}<br><span style="font-size:9px;color:#94a3b8;">${row.date || ""}</span></td>
      <td>${row.details || row.message || "‚Äî"}</td>
    `;
    list.appendChild(tr);
  });
}
  function toggleMasterMode() {
    _isMasterMode = !_isMasterMode;
    const btn = document.getElementById("btnMasterMode");
    const title = document.querySelector(".hTitle");
    const contextPill = document.getElementById("managerContextPill");
    // Toggle Views
    if (_isMasterMode) {
        // UI Updates
        if(btn) { btn.innerText = "Exit Template Editor"; btn.style.backgroundColor = "#7e22ce"; btn.style.color = "white"; }
        if(title) title.innerText = "MASTER TEMPLATE";
        if(contextPill) { contextPill.style.display="flex"; contextPill.innerText="EDITING GLOBAL RULES"; contextPill.style.backgroundColor="#ef4444"; contextPill.style.borderColor="#b91c1c"; }
        // HIDE Schedule, SHOW Master
        $("scheduleView").style.display = "none";
        $("metricsView").style.display = "none";
        $("masterView").style.display = "block"; 
        
        $("masterView").innerHTML = "<div style='padding:20px; text-align:center;'><div class='spinner-border text-primary'></div><br>Loading Master Template...</div>";
        
        // Fetch Data using fetch API
        fetch('./?action=base-schedule')
          .then(res => res.json())
          .then(data => {
            if (data.error) {
              $("masterView").innerHTML = `<div style="color:red;padding:20px;">Error loading template: ${data.error}</div>`;
              return;
            }
            renderMasterView(data);
          })
          .catch(err => {
            $("masterView").innerHTML = `<div style="color:red;padding:20px;">Error loading template: ${err.message || err}</div>`;
          });
    } else {
        exitMasterMode();
        // Return to default view
        setView('schedule');
    }
}
  function pstISODate(d = new Date()) {
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: TZ,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(d);
}
  function formatDate(iso) {
  return dayKeyPST(iso);
}
  // --- 10. UTILS ---
  function mkDiv(cls) { const d = document.createElement("div"); d.className = cls; return d; }
function groupShifts(data) {
  const m = new Map();
  if (!data) return m;
  data.forEach(d => {
    // Use dateISO (YYYY-MM-DD format) for grouping, NOT dateLabel
    const key = d.dateISO || d.dayKey || d.date || "";
    if (!key) return; // Skip if no valid date key
    if (!m.has(key)) m.set(key, []);
    m.get(key).push(d);
  });
  return m;
}
  
  function fillSelect(id, list, bl=true) { const s=$(id); if(!s)return; s.innerHTML=""; if(bl)s.appendChild(new Option("- Select -","")); list.forEach(x=>s.appendChild(new Option(x,x))); }
  
  function toggleTeamSelect(it, cardElement) {
    const id = String(it.assignmentId);
    if (_teamSelected.has(id)) {
      _teamSelected.delete(id);
      if (cardElement) cardElement.classList.remove("selected");
    } else {
      _teamSelected.add(id);
      if (cardElement) cardElement.classList.add("selected");
      _lastSelectedPerson = it.person; 
    }
    updateSelectionBar();
  }
  function updateSelectionBar() {
    const bar = document.getElementById("selectionBar");
    const countSpan = document.getElementById("sbCount");
    const similarBtn = document.getElementById("btnSelectSimilar");
    
    const count = _teamSelected.size;
    countSpan.innerText = count;
    
    if (count > 0) {
      bar.classList.add("visible");
      if (_lastSelectedPerson) {
        similarBtn.style.display = "inline-block";
        similarBtn.innerText = `Select All "${_lastSelectedPerson}"`;
      } else {
        similarBtn.style.display = "none";
      }
    } else {
      bar.classList.remove("visible");
    }
    if(document.getElementById("tpCount")) document.getElementById("tpCount").innerText = count;
  }
  function selectSimilarVisible() {
    if (!_lastSelectedPerson) return;
    _filteredData.forEach(item => {
      if (item.person === _lastSelectedPerson) {
        _teamSelected.add(String(item.assignmentId));
      }
    });
    document.querySelectorAll('.shift').forEach(card => {
      const nameDiv = card.querySelector('.sName');
      if (nameDiv && nameDiv.innerText === _lastSelectedPerson) {
        card.classList.add('selected');
      }
    });
    updateSelectionBar();
    toast(`Selected all shifts for ${_lastSelectedPerson}`);
  }
  async function batchMarkOff() {
  const ids = Array.from(_teamSelected);
  if (ids.length === 0) return toast("No shifts selected.");
  const result = await Swal.fire({
    title: `Mark ${ids.length} shifts as OFF?`,
    text: "This will highlight them red.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, Mark OFF",
    confirmButtonColor: "#ef4444",
    cancelButtonColor: "#cbd5e1"
  });
  if (!result.isConfirmed) return;
  toast(`Processing ${ids.length} cancellations...`);
  for (const id of ids) {
    const item = _allData.find(x => String(x.assignmentId) === String(id));
    if (!item) continue;
    // optimistic UI
    _timeOff.add(`${item.person}|${item.dateISO}`);
    item.notes = ((item.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim() + " [OFF]").trim();
    
    // Use fetch instead of google.script.run
    fetch('./?action=assignment/status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        docId: item.docId,
        assignmentId: item.assignmentId,
        markOff: true
      })
    }).catch(e => console.error("Batch OFF failed:", e, item));
  }
  logAuditEntry({
  action: "BATCH OFF",
  manager: window._myName || window._myEmail,
  target: `${ids.length} shifts`,
  date: "Multiple",
  details: `Marked ${ids.length} shifts as OFF in batch operation`
});
  clearTeamSelection();
  renderView();
  toast(`Success: ${ids.length} shifts marked OFF.`);
}
  function clearTeamSelection() {
    _teamSelected.clear();
    _lastSelectedPerson = null;
    document.querySelectorAll('.shift.selected').forEach(el => el.classList.remove('selected'));
    updateSelectionBar();
  }
  
  async function applyBatch() {
    const newPerson = document.getElementById("tpPerson").value;
    const ids = Array.from(_teamSelected);
    if (!newPerson) return toast("Please select a person first.");
    if (ids.length === 0) return toast("No shifts selected.");
    const result = await Swal.fire({
        title: `Assign ${ids.length} shifts to ${newPerson}?`,
        text: "Choose how to notify the team.",
        icon: 'question',
        showCancelButton: true,
        showDenyButton: true,
        confirmButtonText: '‚ö° Send Bot Now',
        denyButtonText: '‚è≥ Add to Pending',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#1e293b', 
        denyButtonColor: '#f59e0b',    
    });
    if (!result.isConfirmed && !result.isDenied) return; 
    const notifyMode = result.isConfirmed ? 'send' : 'defer';
    toast("Processing batch...");
    // Loop through every selected ID and update locally + server-side
    for (const id of ids) {
        const item = _allData.find(x => String(x.assignmentId) === String(id));
        if (item) {
            const oldPerson = item.person;
            
            // 1. Update the local data immediately
            item.person = newPerson;
            
            // 2. Add to the Pending Notification List if requested
            if (notifyMode === 'defer') {
                _notifQueue.push({
                    person: newPerson,
                    message: `Change: ${newPerson} replaced ${oldPerson} (${item.dateLabel} ${item.startLabel})`,
                    undoData: { docId: item.docId, assignmentId: id, newPerson: oldPerson, notes: item.notes }
                });
            }
            // 3. Send the save request to the server using fetch
            fetch('./?action=assignment/replace', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                docId: item.docId,
                assignmentId: item.assignmentId,
                newPerson: newPerson,
                notes: item.notes || "Batch Update",
                notifyMode: notifyMode
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.ok) console.log(`Saved shift ${id}`);
            })
            .catch(err => console.error(`Failed to save shift ${id}:`, err));
        }
    }
    // Update the Pending Queue in browser storage
    if (notifyMode === 'defer') {
        playNotificationSound(); 
        localStorage.setItem("musely_notif_queue", JSON.stringify(_notifQueue));
        renderNotifList(); 
        toast(`${ids.length} shifts added to Pending Queue`);
    } else {
        playSendSound(); 
        toast(`Success! ${ids.length} shifts updated.`);
    }
if (!window._isManager && window._myName) {
  clearScheduleCache();
}
    clearTeamSelection(); 
    renderView(); // Refresh the UI to show new names       
  }
  // Admin & Context
  function promptMasterSelection(list) { $("masterContextOverlay").style.display="flex"; const s=$("masterManagerDropdown"); s.innerHTML=""; list.forEach(m=>s.appendChild(new Option(m.name,m.email))); }
  function confirmManagerSelection() { _selectedManagerEmail=$("masterManagerDropdown").value; $("masterContextOverlay").style.display="none"; load(true, _selectedManagerEmail); }
  function openAdminModal() { $("adminOverlay").style.display="flex"; loadRules(); }
  function closeAdminModal() { $("adminOverlay").style.display="none"; }
  function loadRules() {
  const list = $("ruleList");
  list.innerHTML = '<div style="padding:10px; color:#94a3b8;">Loading...</div>';
  // ‚úÖ Use fetch instead of google.script.run
  fetch('./?action=staffing/rules')
    .then(res => res.json())
    .then(rules => {
      list.innerHTML = "";
      if (!rules || rules.length === 0) {
        list.innerHTML = '<div style="padding:10px; color:#94a3b8; text-align:center;">No rules set yet.</div>';
        return;
      }
      rules.forEach(r => {
        const row = document.createElement("div");
        row.className = "metricsRow";
        row.innerHTML = `
          <div class="left">
            <div style="font-weight:700; color:#1e3a8a;">${r.team}</div>
            <div style="font-size:11px; background:#dbeafe; padding:2px 6px; border-radius:4px; color:#1e40af;">${r.day}</div>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
            <div style="font-weight:800; font-size:14px;">Min: ${r.min}</div>
            <button onclick="deleteRule('${r.id}')" style="color:#ef4444; background:none; border:none; cursor:pointer;">üóëÔ∏è</button>
          </div>
        `;
        list.appendChild(row);
      });
    })
    .catch(err => {
      console.error(err);
      list.innerHTML = '<div style="color:red; padding:10px;">Error loading rules</div>';
    });
}
async function addRule() {
  const team = $("ruleTeam").value;
  const day = $("ruleDay").value;
  const min = $("ruleMin").value;
  const timeBlock = $("ruleTimeBlock")?.value || "all";
  
  if (!team || !min) return toast("Please select Team and Minimum count", "error");
  
  // Calculate hours based on time block
  let startHour = 0, endHour = 24;
  if (timeBlock === "morning") { startHour = 6; endHour = 12; }
  else if (timeBlock === "afternoon") { startHour = 12; endHour = 18; }
  else if (timeBlock === "evening") { startHour = 18; endHour = 22; }
  else if (timeBlock === "custom") {
    startHour = parseInt($("ruleStartHour")?.value) || 0;
    endHour = parseInt($("ruleEndHour")?.value) || 24;
  }
  
  $("ruleList").innerHTML = "Saving...";
  try {
    await fetch('./?action=staffing/rules', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ team, day, min, startHour, endHour, timeBlock })
    });
    
    toast("Rule Saved", "success");
    $("ruleMin").value = "";
    loadRules();
  } catch (err) {
    console.error(err);
    toast("Error saving rule", "error");
  }
}

// Quick add common rules
async function addQuickRule(team, min, timeBlock) {
  let startHour = 0, endHour = 24;
  if (timeBlock === "morning") { startHour = 6; endHour = 12; }
  else if (timeBlock === "afternoon") { startHour = 12; endHour = 18; }
  
  try {
    await fetch('./?action=staffing/rules', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ team, day: "Weekday", min, startHour, endHour, timeBlock })
    });
    toast(`Added: ${team} min ${min}`, "success");
    loadRules();
  } catch (err) {
    toast("Error adding rule", "error");
  }
}

// Toggle custom hour inputs
document.addEventListener('DOMContentLoaded', () => {
  const timeBlockSelect = $("ruleTimeBlock");
  if (timeBlockSelect) {
    timeBlockSelect.addEventListener('change', (e) => {
      const isCustom = e.target.value === "custom";
      if ($("ruleStartHour")) $("ruleStartHour").style.display = isCustom ? "block" : "none";
      if ($("ruleEndHour")) $("ruleEndHour").style.display = isCustom ? "block" : "none";
    });
  }
});

async function deleteRule(id) {
  if (!confirm("Delete this rule?")) return;
  try {
    await fetch('./?action=staffing/rules/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ idx: id })
    });
    toast("Rule Deleted", "success");
    loadRules();
  } catch (err) {
    console.error(err);
    toast("Error deleting rule", "error");
  }
}
  // Helper: show toast notification
function toast(msg, type = "info") {
  const host = document.getElementById("toastHost");
  if (! host) {
    console.log("Toast:", msg);
    return;
  }
  
  const t = document.createElement("div");
  t.className = "toast";
  
  // Color based on type
  if (type === "success") t.style.background = "#16a34a";
  else if (type === "error") t.style.background = "#dc2626";
  else if (type === "warning") t.style.background = "#d97706";
  
  t.innerHTML = `
    <span>${msg}</span>
    <button onclick="this.parentElement.remove()" style="background: rgba(255,255,255,0.2); border:none; color:#fff; padding:4px 8px; border-radius:4px; cursor:pointer;">‚úï</button>
  `;
  
  host.appendChild(t);
  setTimeout(() => t.remove(), 5000);
}
// Make it globally available
window.toast = toast;
  function applyLocalFilters() { _filteredData = _allData.filter(x => (!_activeTeam || x.team===_activeTeam) && (!_selectedPeople.size || _selectedPeople.has(x.person))); renderView(); }
  function renderTeamChips() { const c=$("teamChips"); if(c) { c.innerHTML=""; _teams.forEach(t=>{ const d=mkDiv("chip"); d.innerText=t; d.onclick=()=>filterTeam(t); c.appendChild(d); }); } }
  function filterTeam(t) { _activeTeam=t; applyLocalFilters(); }
  function showActiveFilterIndicator(channelName) {
  // Remove existing indicator
  const existing = document.getElementById('activeFilterIndicator');
  if (existing) existing.remove();
  
  if (! channelName) return;
  
  const indicator = document.createElement('div');
  indicator.id = 'activeFilterIndicator';
  indicator.style.cssText = `
    position: fixed;
    top: 74px;
    left: 50%;
    transform:  translateX(-50%);
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size:  13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    z-index: 500;
    animation: slideDown 0.3s ease;
  `;
  
  indicator.innerHTML = `
    <span>üì∫ Viewing: ${channelName}</span>
    <button onclick="resetAllFilters()" style="
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius:  50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    ">‚úï</button>
  `;
  
  document.body.appendChild(indicator);
  
  // Also add class to calendar grid for CSS
  const calGrid = document.getElementById('calView');
  if (calGrid) calGrid.classList.add('channel-filtered');
}
  function initFilters() { fillSelect("teamDropdown", _teams); }
  function renderQuickRail() { 
    const list = $("qrList");
    list.innerHTML = ""; 
    const q = ($("qrSearch").value || "").toLowerCase();
    _people.filter(p => !q || p.toLowerCase().includes(q)).forEach(p => { 
        const d = mkDiv("qrItem"); 
        d.innerText = p; 
        d.draggable = true; 
        d.ondragstart = (e) => { 
           _dragPerson = p; 
           e.dataTransfer.effectAllowed = "copy";
        };
        d.onclick = () => {
           _selectedPeople.clear();
           _selectedPeople.add(p);
           applyLocalFilters();
        };
        list.appendChild(d); 
    }); 
  }
 
  async function deleteRule(idx) { 
    if (!confirm("Delete rule?")) return; 
    try {
      await fetch('./?action=staffing/rules/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idx: idx })
      });
      toast("Rule deleted");
      loadRules();
    } catch (err) {
      console.error("Delete rule error:", err);
      toast("Failed to delete rule", "error");
    }
  }
  // Master Template Logic
  function renderMasterView(data) {
    if(!data || data.error) { 
        $("masterView").innerHTML = "<div style='color:red;padding:20px;'>Failed to load master template</div>"; 
        return; 
    }
    _masterRawData = data; 
    // CHANGE: Target 'masterView' instead of 'listView'
    const list = document.getElementById("masterView"); 
    list.innerHTML = "";
    
    // Inject styles
    const style = document.createElement('style');
    style.innerHTML = `
        .mst-person-row: hover { background-color: #f8fafc !important; transition: background 0.2s; }
        .mst-shift-chip: hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .mst-day-cell:hover { background-color: rgba(0,0,0,0.02); }
        .add-btn { opacity: 0; transition: opacity 0.2s; }
        .mst-day-cell:hover . add-btn { opacity: 1; }
    `;
    list.appendChild(style);
    
    // 1.  Pivot Data
    const roster = {};
    const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    
    days.forEach(day => {
        const dayItems = data[day] || [];
        dayItems.forEach(item => {
            const pName = item.person;
            if (!roster[pName]) roster[pName] = {};
            if (!roster[pName][day]) roster[pName][day] = [];
            roster[pName][day].push(item);
        });
    });
    list.style.display = "block"; 
    list.style.overflowX = "auto";
    list.style.fontFamily = "sans-serif"; 
    // 2. The Header
    const headerRow = mkDiv("mst-header-row");
    headerRow.style.display = "grid";
    headerRow.style.gridTemplateColumns = "180px repeat(7, 1fr)"; 
    headerRow.style.backgroundColor = "#1e293b"; 
    headerRow.style.color = "#ffffff";
    headerRow.style.fontWeight = "bold";
    headerRow.style.borderBottom = "2px solid #ddd";
    headerRow.style.position = "sticky";
    headerRow.style.top = "0";
    headerRow.style.zIndex = "10";
    let headerHtml = `<div style="padding:12px; border-right:1px solid #4a6278;">Employee</div>`;
    days.forEach((d, i) => { 
        const borderStyle = i < 6 ? "border-right:1px solid #4a6278;" : ""; 
        headerHtml += `<div style="padding:12px; text-align:center; ${borderStyle}">${d}</div>`; 
    });
    headerRow.innerHTML = headerHtml;
    list.appendChild(headerRow);
    // 3. The Body
    const sortedPersons = Object.keys(roster).sort();
    
    sortedPersons.forEach((person, index) => {
        const row = mkDiv("mst-person-row");
        const bg = index % 2 === 0 ? "#ffffff" : "#f8f9fa"; 
        row.style.backgroundColor = bg;
        row.style.display = "grid";
        row.style.gridTemplateColumns = "180px repeat(7, 1fr)";
        row.style.borderBottom = "1px solid #e0e0e0";
        row.style.alignItems = "stretch"; 
        // Name Column
        let html = `
            <div class="mst-person-info" style="
                padding:12px; font-weight:600; color:#333; 
                border-right:2px solid #e0e0e0; display:flex; align-items:center;">
                ${person}
            </div>`;
        // Day Columns
        days.forEach((day, i) => {
            const shifts = roster[person][day] || [];
            const borderStyle = i < 6 ?  "border-right:1px solid #eee;" : "";
            html += `<div class="mst-day-cell" 
                        onclick="handleCellClick('${person}', '${day}')"
                        style="padding:8px; display:flex; flex-direction:column; gap:4px; align-items:center; justify-content:flex-start; cursor:pointer; position:relative; ${borderStyle}">`;
            
            if (shifts.length === 0) {
                html += `<span class="add-btn" style="color:#ccc; font-size:20px; font-weight:bold;">+</span>`;
            } else {
                shifts.forEach(shift => {
                    const rawStart = shift.start; 
                    const rawEnd = shift.end;
                    const displayStart = toAmPm(rawStart);
                    const displayEnd = toAmPm(rawEnd);
                    
                    // ‚úÖ NEW: Get channel config for color coding
                    const channelName = shift.team || "Other";
                    const config = getChannelConfig(channelName);
                    const abbrev = config.abbrev;
                    
                    html += `<div class="mst-shift-chip" 
                                onclick="event.stopPropagation(); handleShiftEdit('${person}', '${day}', '${rawStart}', '${rawEnd}', '${shift.team || ''}')"
                                style="
                                font-size:10px; padding:4px 8px; 
                                background:${config.color}; 
                                color:${config.text}; 
                                border:  1px solid ${config.border};
                                border-radius: 8px; 
                                font-weight:600;
                                white-space:nowrap; 
                                cursor:pointer;
                                transition:  all 0.2s;
                                display:flex;
                                flex-direction:column;
                                align-items:center;
                                gap:2px;
                                min-width:70px;
                                box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                <span style="font-weight:700;">${abbrev}</span>
                                <span style="font-size:9px; opacity:0.8;">${displayStart}-${displayEnd}</span>
                             </div>`;
                });
            }
            html += `</div>`;
        });
        row.innerHTML = html;
        list.appendChild(row);
    });
}
// Triggered when clicking an existing blue chip
function handleShiftEdit(person, day, start, end, team) {
    // Populate the inputs
    document.getElementById("modalEmployee").value = person;
    document.getElementById("modalDay").value = day;
    
    // Ensure format HH:MM for the time inputs
    document.getElementById("modalStart").value = start.substring(0,5);
    document.getElementById("modalEnd").value = end.substring(0,5);
    // Store original times so we know which shift to update later
    document.getElementById("modalOrigStart").value = start;
    document.getElementById("modalOrigEnd").value = end;
    // Populate Team dropdown and select the current team
    fillSelect("modalTeam", _teams, false); // false = no blank option
    if (team) {
        document.getElementById("modalTeam").value = team;
    }
    // Update modal title for editing
    const modalTitle = document.querySelector("#editShiftModal h3");
    if (modalTitle) modalTitle.innerText = "Edit Shift";
    // Show the modal
    document.getElementById("editShiftModal").style.display = "flex";
}
function handleCellClick(person, day) {
    // 1. Prepare the Modal for a New Entry
    document.getElementById("modalEmployee").value = person;
    document.getElementById("modalDay").value = day;
    
    // Default times for a new shift
    document.getElementById("modalStart").value = "08:00";
    document.getElementById("modalEnd").value = "17:00";
    // Clear original times (since this shift doesn't exist yet)
    document.getElementById("modalOrigStart").value = "NEW";
    document.getElementById("modalOrigEnd").value = "NEW";
    // Populate and default the Team
    fillSelect("modalTeam", _teams);
    
    // Change UI header to indicate "Adding"
    document.querySelector("#editShiftModal h3").innerText = "Add New Shift";
    const modal = document.getElementById("editShiftModal");
    modal.style.display = "flex";
}
  function toggleMasterPerson(key, dayName) {
    if (_masterSelected.has(key)) {
        _masterSelected.delete(key);
    } else {
        _masterSelected.add(key);
    }
    renderMasterView(JSON.stringify(_masterRawData));
    updateMasterSelectionBar(); 
  }
  function openMasterModal(p,d,s,e,t,r) { 
    fillSelect("mstTeam", _teams); 
    fillSelect("mstRole", _roles); 
    
    $("mstSub").innerText = s ? `Editing ${p} on ${d}` : `Adding Shift for ${p} on ${d}`;
    $("mstPerson").value = p; 
    $("mstDay").value = d; 
    
    $("mstStart").value = s || ""; 
    $("mstEnd").value = e || ""; 
    $("mstTeam").value = t || ""; 
    $("mstRole").value = r || ""; 
    
    $("masterOverlay").style.display = "flex"; 
  }
  
  function updateMasterSelectionBar() {
    const count = _masterSelected.size;
    const bar = document.getElementById("selectionBar");
    const countSpan = document.getElementById("sbCount");
    
    if (count > 0) {
        bar.classList.add("visible");
        countSpan.innerText = count;
    } else {
        bar.classList.remove("visible");
    }
  }
// ============================================
// NOTIFICATION SYSTEM
// ============================================
let pendingNotifications = [];
// Toggle notification panel open/closed
function toggleNotifPanel(forceClose) {
  const panel = $("notifPanel");
  if (!panel) {
    console.error("notifPanel element not found!");
    return;
  }
  
  // If forceClose is true, just close it
  if (forceClose === false) {
    panel.style.display = "none";
    panel.classList.remove("open");
    return;
  }
  
  // Toggle visibility
  const isCurrentlyOpen = panel.style.display === "block" || panel.classList.contains("open");
  
  if (isCurrentlyOpen) {
    panel.style.display = "none";
    panel.classList.remove("open");
  } else {
    panel.style.display = "block";
    panel.classList.add("open");
    loadPendingNotifications();
  }
  
  console.log("Panel toggled, now:", panel.style.display); // Debug
}
// Load pending notifications from backend
async function loadPendingNotifications() {
  const listEl = $("notifList");
  listEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">Loading... </div>';
  
  try {
    const res = await fetch("./?action=notifications/pending");
    const data = await res.json();
    
    if (! data.ok) throw new Error(data.error || "Failed to load");
    
    pendingNotifications = data.notifications || [];
    renderNotifications();
    updateNotifBadge();
    
  } catch (err) {
    console.error("Load notifications error:", err);
    listEl.innerHTML = `<div style="text-align: center; color:#ef4444; padding:20px;">Error:  ${err.message}</div>`;
  }
}
// Render notifications in the panel
function renderNotifications() {
  const listEl = $("notifList");
  
  // Combine backend pending notifications with local queue
  const allNotifications = [
    ...pendingNotifications.map((n, idx) => ({ ...n, source: 'backend', idx })),
    ..._notifQueue.map((n, idx) => ({ ...n, source: 'local', idx }))
  ];
  
  if (allNotifications.length === 0) {
    listEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">No pending notifications üéâ</div>';
    return;
  }
  
  let html = "";
  
  allNotifications.forEach((n, displayIdx) => {
    const isLocal = n.source === 'local';
    const hasUndo = isLocal && n.undoData && n.undoData.newPerson;
    const originalIdx = n.idx;
    const hasError = n.notifyError || n.error;

    // Determine what info to show
    const personName = n.person || n.undoData?.newPerson || 'Unknown';
    const dateStr = n.date || n.dateLabel || '';
    const teamStr = n.team || '';
    const startStr = n.start || n.startLabel || '';
    const endStr = n.end || n.endLabel || '';
    const notesStr = n.notes || n.message || '';
    
    // Get channel styling
    const channelDisplay = getChannelDisplayName(teamStr);
    const channelConfig = getChannelConfig(teamStr);

    html += `
      <div class="notif-item" data-idx="${displayIdx}" style="
        background: ${hasError ? '#fef2f2' : (isLocal ? '#fffbeb' : '#f8fafc')};
        border: 1px solid ${hasError ? '#fca5a5' : (isLocal ? '#fcd34d' : '#e2e8f0')};
        border-radius: 10px;
        padding: 12px;
        margin-bottom:  10px;
      ">
        <div style="display: flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
          <div>
            <div style="font-weight:700; color:#0f172a; font-size: 14px;">${escapeHtml(personName)}</div>
            <div style="font-size:11px; color:#64748b;">
              ${escapeHtml(dateStr)}
              ${teamStr ? `<span style="background: ${channelConfig.color}; color: ${channelConfig.text}; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600; margin-left:4px;">${escapeHtml(channelDisplay)}</span>` : ''}
            </div>
          </div>
          <span style="background:${hasError ? '#fee2e2' : (isLocal ? '#fef3c7' : '#dbeafe')}; color: ${hasError ? '#dc2626' : (isLocal ? '#92400e' : '#1e40af')}; font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px;">
            ${hasError ? 'FAILED' : (isLocal ? 'QUEUED' : 'PENDING')}
          </span>
        </div>
        
        ${startStr ?  `
        <div style="font-size: 12px; color:#334155; margin-bottom:8px;">
          üïê ${escapeHtml(startStr)}${endStr ? ' ‚Äì ' + escapeHtml(endStr) : ''}
        </div>
        ` : ''}
        
        ${notesStr ? `<div style="font-size:11px; color:#64748b; font-style:italic; margin-bottom:10px; padding:8px; background:rgba(0,0,0,0.03); border-radius:6px;">"${escapeHtml(notesStr)}"</div>` : ''}
        
        ${hasError ? `
        <div style="font-size:11px; color:#dc2626; background:#fee2e2; padding:8px; border-radius:6px; margin-bottom:10px; font-weight:500;">
          ‚ö†Ô∏è Error: ${escapeHtml(hasError)}
        </div>
        ` : ''}
        
        <div style="display: flex; gap:6px; flex-wrap:wrap;">
          ${isLocal ?  `
            <!-- Local queue buttons -->
            <button onclick="sendQueuedNotification(${originalIdx})" style="
              flex: 1; min-width:70px; background:#3b82f6; color:#fff; border:none; padding:8px 10px; 
              border-radius:6px; font-size:11px; font-weight:600; cursor:pointer;
            ">üì§ Send</button>
            
            ${hasUndo ? `
            <button onclick="undoNotification(${originalIdx})" style="
              flex:1; min-width:70px; background:#f59e0b; color:#fff; border:none; padding:8px 10px; 
              border-radius:6px; font-size:11px; font-weight:600; cursor:pointer;
            ">‚Ü©Ô∏è Undo</button>
            ` : ''}
            
            <button onclick="removeFromQueue(${originalIdx})" style="
              flex:1; min-width:60px; background:#fff; color:#64748b; border:1px solid #e2e8f0; padding:8px 10px; 
              border-radius:6px; font-size:11px; font-weight:600; cursor: pointer;
            ">‚úï</button>
          ` : `
            <!-- Backend pending buttons -->
            ${hasError ? `
            <button onclick="sendSingleNotification(${originalIdx})" style="
              flex:1; min-width:80px; background:#f59e0b; color:#fff; border: none; padding:8px 10px; 
              border-radius:6px; font-size: 11px; font-weight:600; cursor:pointer;
            ">üîÑ Retry</button>
            ` : `
            <button onclick="sendSingleNotification(${originalIdx})" style="
              flex:1; min-width:80px; background:#3b82f6; color:#fff; border: none; padding:8px 10px; 
              border-radius:6px; font-size: 11px; font-weight:600; cursor:pointer;
            ">üì§ Send</button>
            `}
            
            <button onclick="dismissNotification(${originalIdx})" style="
              flex:1; min-width:60px; background:#fff; color:#64748b; border:1px solid #e2e8f0; padding:8px 10px; 
              border-radius:6px; font-size:11px; font-weight:600; cursor:pointer;
            ">‚úï Dismiss</button>
          `}
        </div>
      </div>
    `;
  });
  
  listEl.innerHTML = html;
}
async function sendQueuedNotification(idx) {
  const notif = _notifQueue[idx];
  if (!notif) return;
  
  toast("Sending notification...");
  
  // For now, just remove from queue and show success
  // In a real implementation, you'd call the backend
  _notifQueue.splice(idx, 1);
  localStorage.setItem("musely_notif_queue", JSON.stringify(_notifQueue));
  renderNotifications();
  updateNotifBadge();
  toast("‚úÖ Notification sent!", "success");
}
function removeFromQueue(idx) {
  Swal.fire({
    title: 'Remove from Queue?',
    text: 'This notification will be removed without sending.',
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#64748b',
    cancelButtonColor: '#3b82f6',
    confirmButtonText: 'Yes, Remove',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      _notifQueue.splice(idx, 1);
      localStorage.setItem("musely_notif_queue", JSON.stringify(_notifQueue));
      renderNotifications();
      updateNotifBadge();
      toast("Notification removed");
    }
  });
}
// Update the red badge count
function updateNotifBadge() {
  const badge = $("notifCount");
  if (!badge) return;
  
  // Count from both backend pending AND local queue
  const backendCount = pendingNotifications?.length || 0;
  const localCount = _notifQueue?.length || 0;
  const totalCount = backendCount + localCount;
  
  if (totalCount > 0) {
    badge.textContent = totalCount > 99 ? "99+" : totalCount;
    badge.classList.remove("hidden");
  } else {
    badge.textContent = "0";
    badge.classList.add("hidden");
  }
}
// Send a single notification
async function sendSingleNotification(idx) {
  const n = pendingNotifications[idx];
  if (!n) return;
  
  try {
    const res = await fetch("./?action=notifications/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        notifications: [{ docId: n.docId, assignmentId: n.assignmentId }]
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.sent > 0) {
      toast(`‚úÖ Notification sent to ${n.person}!`, "success");
      pendingNotifications.splice(idx, 1);
      renderNotifications();
      updateNotifBadge();
    } else {
      const errMsg = data.results?.[0]?.error || "Failed to send";
      toast(`‚ùå Failed:  ${errMsg}`, "error");
    }
    
  } catch (err) {
    console.error("Send notification error:", err);
    toast(`‚ùå Error: ${err.message}`, "error");
  }
}
// Dismiss a notification (don't send, just clear it)
async function dismissNotification(idx) {
  const n = pendingNotifications[idx];
  if (!n) return;
  
  try {
    const res = await fetch("./?action=notifications/dismiss", {
      method: "POST",
      headers:  { "Content-Type": "application/json" },
      body:  JSON.stringify({
        docId: n.docId,
        assignmentId: n.assignmentId
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`Notification dismissed`, "info");
      pendingNotifications.splice(idx, 1);
      renderNotifications();
      updateNotifBadge();
    } else {
      toast(`‚ùå Failed to dismiss`, "error");
    }
    
  } catch (err) {
    console.error("Dismiss error:", err);
    toast(`‚ùå Error: ${err.message}`, "error");
  }
}
// Send ALL pending notifications
async function sendAllPending() {
  if (pendingNotifications.length === 0) {
    toast("No pending notifications to send", "info");
    return;
  }
  
  const confirmed = await Swal.fire({
    title: "Send All Notifications?",
    text: `This will send ${pendingNotifications.length} notification(s) via Google Chat. `,
    icon: "question",
    showCancelButton:  true,
    confirmButtonText:  "Yes, Send All",
    cancelButtonText: "Cancel"
  });
  
  if (!confirmed.isConfirmed) return;
  
  try {
    const payload = pendingNotifications.map(n => ({
      docId: n.docId,
      assignmentId: n.assignmentId
    }));
    
    const res = await fetch("./?action=notifications/send", {
      method:  "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ notifications: payload })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`‚úÖ Sent ${data.sent} of ${data.total} notifications`, "success");
      await loadPendingNotifications(); // Refresh the list
    } else {
      toast(`‚ùå Error sending notifications`, "error");
    }
    
  } catch (err) {
    console.error("Send all error:", err);
    toast(`‚ùå Error: ${err.message}`, "error");
  }
}
  function undoNotification(index) {
  const notif = _notifQueue[index];
  if (!notif || !notif.undoData) {
    toast("Cannot undo - no undo data available", "error");
    return;
  }
  Swal.fire({
    title: '‚Ü©Ô∏è Undo This Change?',
    html: `
      <div style="text-align:left; padding:10px; background:#fef3c7; border-radius:8px; border:1px solid #fcd34d;">
        <p style="margin:0 0 10px 0; color:#92400e;">This will revert the schedule change:</p>
        <div style="font-size:13px; color:#78350f;">
          <strong>Restore:</strong> ${escapeHtml(notif.undoData.newPerson || 'Original person')}<br>
          <strong>Shift:</strong> ${escapeHtml(notif.dateLabel || notif.date || 'Unknown date')}
        </div>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#f59e0b',
    cancelButtonColor: '#64748b',
    confirmButtonText: '‚Ü©Ô∏è Yes, Undo',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      executeUndo(index, notif);
    }
  });
}
  async function executeUndo(index, notif) {
  toast("Reverting change...");
  const data = notif.undoData;
  
  try {
    const response = await fetch('./?action=assignment/replace', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        docId: data.docId,
        assignmentId: data.assignmentId,
        newPerson: data.newPerson,
        notes: data.notes || '',
        notifyMode: "silent"
      })
    });
    
    const res = await response.json();
    
    if (res.ok || res.status === "success") {
      // Update local data
      const local = _allData.find(x => x.assignmentId === data.assignmentId);
      if(local) { 
        local.person = data.newPerson; 
        local.notes = data.notes || ''; 
      }
      
      // Remove from queue
      _notifQueue.splice(index, 1);
      localStorage.setItem("musely_notif_queue", JSON.stringify(_notifQueue));
      
      // Refresh UI
      renderView();
      renderNotifications();
      updateNotifBadge();
      
      Swal.fire({
        title: '‚úÖ Reverted!',
        text: 'The schedule change has been undone.',
        icon: 'success',
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      throw new Error(res.error || res.message || "Unknown error");
    }
  } catch (err) {
    toast(`Undo failed: ${err.message || err}`, "error");
  }
}
  function toggleDrawer() {
    const drawer = document.getElementById("rightDrawer");
    const notifPanel = document.getElementById("notifPanel");
    if (notifPanel && notifPanel.style.display === "block") {
        notifPanel.style.display = "none";
    }
    if (drawer) {
        drawer.classList.toggle("open");
    }
  }
  function setMode(mode) {
    _mode = mode; 
    document.getElementById("btnModeQuick").className = mode === "quick" ? "segBtn active" : "segBtn";
    document.getElementById("btnModeTeam").className = mode === "team" ? "segBtn active" : "segBtn";
    const quickDiv = document.getElementById("drawerQuick");
    const teamDiv = document.getElementById("drawerTeam");
    if (mode === "quick") {
      quickDiv.classList.remove("hidden");
      teamDiv.classList.add("hidden");
    } else {
      quickDiv.classList.add("hidden");
      teamDiv.classList.remove("hidden");
    }
  }
  // Clear all notifications (dismiss all)
async function clearNotifications() {
  if (pendingNotifications.length === 0) {
    toast("No notifications to clear", "info");
    return;
  }
  
  const confirmed = await Swal.fire({
    title: "Clear All Notifications?",
    text: "This will dismiss all pending notifications without sending them.",
    icon: "warning",
    showCancelButton:  true,
    confirmButtonText:  "Yes, Clear All",
    confirmButtonColor: "#ef4444",
    cancelButtonText: "Cancel"
  });
  
  if (!confirmed.isConfirmed) return;
  
  // Dismiss each one
  for (const n of pendingNotifications) {
    try {
      await fetch("./?action=notifications/dismiss", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ docId: n.docId, assignmentId: n.assignmentId })
      });
    } catch (e) {
      console.error("Clear error:", e);
    }
  }
  
  pendingNotifications = [];
  renderNotifications();
  updateNotifBadge();
  toast("All notifications cleared", "info");
}
  function renderNotifList() {
  const el = document.getElementById("notifList"); // make sure this ID exists in your HTML
  if (!el) return;
  if (!_notifQueue || !_notifQueue.length) {
    el.innerHTML = `<div class="notif-empty">No notifications</div>`;
    return;
  }
  el.innerHTML = _notifQueue.map((n) => `
    <div class="notif-item">
      <div class="notif-title">${escapeHtml(n.title || "Notification")}</div>
      <div class="notif-msg">${escapeHtml(n.msg || "")}</div>
      ${n.ts ? `<div class="notif-time">${escapeHtml(new Date(n.ts).toLocaleString())}</div>` : ""}
    </div>
  `).join("");
}
// If your script is type="module" (or you want to be extra safe):
window.renderNotifList = renderNotifList;
  // Master helper stubs
  function toggleMasterCheck(k,d){ if(_masterSelected.has(k)) _masterSelected.delete(k); else _masterSelected.add(k); renderMasterView(JSON.stringify(_masterRawData)); }
  async function saveMasterEdit() { 
    closeMasterModal(); 
    toast("Saving...", false); 
    const p = {
      person: $("mstPerson").value,
      dayName: $("mstDay").value,
      newStart: $("mstStart").value,
      newEnd: $("mstEnd").value,
      newTeam: $("mstTeam").value,
      newRole: $("mstRole").value,
      applyDate: $("mstSync").checked ? new Date().toISOString() : null
    }; 
    
    try {
      const res = await fetch('./?action=update-master-schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: "EDIT",
          person: p.person,
          day: p.dayName,
          oldStart: p.newStart,
          oldEnd: p.newEnd,
          newStart: p.newStart,
          newEnd: p.newEnd,
          newTeam: p.newTeam,
          newRole: p.newRole
        })
      });
      
      const data = await res.json();
      if (data.status === "success" || data.ok) {
        toast("Saved!"); 
        toggleMasterMode(); 
        toggleMasterMode();
      } else {
        toast("Save failed: " + (data.message || data.error), "error");
      }
    } catch (err) {
      console.error("Save master edit error:", err);
      toast("Save failed", "error");
    }
  }
  function closeMasterModal() { $("masterOverlay").style.display="none"; }
  // ============================================
// AGENT NOTIFICATIONS SYSTEM
// ============================================
let _agentNotifications = [];
let _agentNotifUnreadCount = 0;
async function loadAgentNotifications() {
  if (!window._myName) return;
  
  try {
    const res = await fetch('./?action=agent/notifications', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentName: window._myName })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      _agentNotifications = data.notifications || [];
      _agentNotifUnreadCount = data.unreadCount || 0;
      updateAgentNotifBadge();
    }
  } catch (err) {
    console.error("Load agent notifications error:", err);
  }
}
function updateAgentNotifBadge() {
  const badge = $("agentNotifBadge");
  if (!badge) return;
  
  if (_agentNotifUnreadCount > 0) {
    badge.textContent = _agentNotifUnreadCount > 9 ? "9+" : _agentNotifUnreadCount;
    badge.style.display = "flex";
  } else {
    badge.style.display = "none";
  }
}
// ============================================
// FUTURE TIME OFF REQUEST (Calendar-based)
// ============================================
function openFutureTimeOffModal() {
  const modal = $("futureTimeOffModal");
  if (!modal) return;
  
  // Set default date to tomorrow
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const dateInput = $("futureToDate");
  if (dateInput) {
    dateInput.value = tomorrow.toISOString().split("T")[0];
    dateInput.min = tomorrow.toISOString().split("T")[0]; // Can't request past dates
  }
  
  // Clear reason
  if ($("futureToReason")) $("futureToReason").value = "";
  
  modal.style.display = "flex";
}
function closeFutureTimeOffModal() {
  const modal = $("futureTimeOffModal");
  if (modal) modal.style.display = "none";
}
async function submitFutureTimeOff() {
  const date = $("futureToDate")?.value;
  const typeRadio = document.querySelector('input[name="futureToType"]:checked');
  const type = typeRadio ? typeRadio.value : "PTO";
  const reason = $("futureToReason")?.value || "";
  
  if (!date) {
    toast("Please select a date", "error");
    return;
  }
  
  if (!reason.trim()) {
    toast("Please provide a reason", "error");
    return;
  }
  
  try {
    const res = await fetch('./?action=timeoff/request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        person: window._myName,
        date: date,
        typeKey: type.toLowerCase().replace(" ", "_"),
        duration: "full_day",
        reason: reason,
        shiftStart: null,
        shiftEnd: null,
        team: null
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      closeFutureTimeOffModal();
      toast("‚úÖ Time off request submitted!", "success");
    } else {
      toast("Failed to submit: " + (data.error || "Unknown error"), "error");
    }
  } catch (err) {
    console.error("Submit future time off error:", err);
    toast("Failed to submit request", "error");
  }
}
function openAgentNotifications() {
  const panel = $("agentNotifPanel");
  if (!panel) return;
  
  renderAgentNotifications();
  panel.style.display = "flex";
}
function closeAgentNotifications() {
  const panel = $("agentNotifPanel");
  if (panel) panel.style.display = "none";
}
function renderAgentNotifications() {
  const list = $("agentNotifList");
  if (!list) return;
  
  if (_agentNotifications.length === 0) {
    list.innerHTML = `<div style="text-align:center; color:#94a3b8; padding:40px;">No notifications</div>`;
    return;
  }
  
  list.innerHTML = _agentNotifications.map(n => {
    const isUnread = !n.read;
    const icon = getNotifIcon(n.type, n.decision);
    const timeAgo = getTimeAgo(n.createdAt);
    
    return `
      <div class="agent-notif-item ${isUnread ? 'unread' : ''}" onclick="markNotifRead('${n.id}')">
        <div class="agent-notif-icon">${icon}</div>
        <div class="agent-notif-content">
          <div class="agent-notif-message">${escapeHtml(n.message)}</div>
          <div class="agent-notif-time">${timeAgo}</div>
        </div>
        ${isUnread ? '<div class="agent-notif-dot"></div>' : ''}
      </div>
    `;
  }).join("");
}
function getNotifIcon(type, decision) {
  if (type === "timeoff_decision") {
    return decision === "approved" ? "‚úÖ" : "‚ùå";
  }
  if (type === "swap_request") return "üîÑ";
  if (type === "swap_response") {
    return decision === "accepted" ? "‚úÖ" : "‚ùå";
  }
  if (type === "shift_change") return "üìÖ";
  return "üîî";
}
function getTimeAgo(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return "Just now";
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}
async function markNotifRead(notifId) {
  try {
    await fetch('./?action=agent/notifications/read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ notifId })
    });
    
    // Update local state
    const notif = _agentNotifications.find(n => n.id === notifId);
    if (notif && !notif.read) {
      notif.read = true;
      _agentNotifUnreadCount = Math.max(0, _agentNotifUnreadCount - 1);
      updateAgentNotifBadge();
      renderAgentNotifications();
    }
  } catch (err) {
    console.error("Mark notif read error:", err);
  }
}
// Load pending swap requests
async function loadPendingSwaps() {
  if (!window._myName) return;
  
  try {
    const res = await fetch('./?action=swap/pending', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentName: window._myName })
    });
    
    const data = await res.json();
    
    if (data.ok && data.incoming && data.incoming.length > 0) {
      // Show swap requests in notifications
      data.incoming.forEach(swap => {
        toast(`üîÑ ${swap.fromPerson} wants to swap a shift with you`, "info");
      });
    }
  } catch (err) {
    console.error("Load pending swaps error:", err);
  }
}

// Helper: Check for scheduling conflicts
async function checkSchedulingConflicts(personName, date, startTime, endTime, excludeAssignmentId = null) {
  try {
    const res = await fetch('./?action=schedule/check-conflict', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        personName,
        date,
        startTime,
        endTime,
        excludeAssignmentId
      })
    });

    const data = await res.json();

    if (data.ok) {
      return {
        hasConflict: data.hasConflict,
        conflicts: data.conflicts || []
      };
    }

    return { hasConflict: false, conflicts: [] };
  } catch (err) {
    console.error('Conflict check error:', err);
    return { hasConflict: false, conflicts: [] };
  }
}

async function respondToSwap(swapId, response) {
  if (response === 'accepted') {
    // Show confirmation with swap details
    const swapRequest = _agentNotifications?.find(n => n.swapRequestId === swapId);

    if (swapRequest) {
      // Check for conflicts before accepting
      try {
        const conflictRes = await fetch('./?action=schedule/check-conflict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            personName: window._myName,
            date: swapRequest.shiftDate || swapRequest.date,
            startTime: swapRequest.shiftStart || swapRequest.start,
            endTime: swapRequest.shiftEnd || swapRequest.end
          })
        });

        const conflictData = await conflictRes.json();

        if (conflictData.ok && conflictData.hasConflict && conflictData.conflicts.length > 0) {
          // Show conflicts and block acceptance
          const conflictsList = conflictData.conflicts.map(c => 
            `‚Ä¢ ${escapeHtml(c.team)}: ${escapeHtml(c.start)} - ${escapeHtml(c.end)}`
          ).join('<br>');

          Swal.fire({
            title: '‚ö†Ô∏è Scheduling Conflict Detected',
            html: `
              <div style="text-align: left; font-size: 14px; line-height: 1.6;">
                <p style="color: #dc2626; font-weight: 600; margin-bottom: 12px;">
                  You are already scheduled during this time:
                </p>
                <div style="padding: 12px; background: #fee2e2; border-left: 3px solid #dc2626; border-radius: 4px; margin-bottom: 12px;">
                  ${conflictsList}
                </div>
                <p>You cannot accept this swap request due to the conflict.</p>
              </div>
            `,
            icon: 'error',
            confirmButtonColor: '#dc2626',
            confirmButtonText: 'OK'
          });
          return; // Block the acceptance
        }
      } catch (err) {
        console.error('Conflict check error:', err);
        // Continue with acceptance if conflict check fails
      }

      // Confirm acceptance
      const result = await Swal.fire({
        title: 'üîÑ Accept Swap Request?',
        html: `
          <div style="text-align: left; font-size: 14px;">
            <p><strong>From:</strong> ${swapRequest.fromPerson || 'Unknown'}</p>
            <p><strong>Date:</strong> ${swapRequest.shiftDate || swapRequest.date}</p>
            <p><strong>Time:</strong> ${swapRequest.shiftStart || swapRequest.start} - ${swapRequest.shiftEnd || swapRequest.end}</p>
            ${swapRequest.team ? `<p><strong>Team:</strong> ${swapRequest.team}</p>` : ''}
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Accept',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#16a34a'
      });

      if (!result.isConfirmed) return;
    }
  }

  try {
    const res = await fetch('./?action=swap/respond', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        swapId, 
        response, 
        responderName: window._myName 
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`‚úÖ Swap ${response}`, "success");
      loadAgentNotifications();
      loadSystemData(); // Refresh schedule
    } else {
      toast("Failed to respond: " + (data.error || "Unknown error"), "error");
    }
  } catch (err) {
    console.error("Swap respond error:", err);
    toast("Failed to respond to swap", "error");
  }
}
  // ============================================
// ACCRUED HOURS SYSTEM (PTO Only)
// ============================================
let _balanceData = new Map(); // person -> {pto}
async function loadBalances() {
  try {
    const res = await fetch('/?action=balances/list');
    const data = await res.json();
    
    if (data.ok) {
      _balanceData.clear();
      (data.balances || []).forEach(b => {
        _balanceData.set(b.person, { pto: b.pto || 0 });
      });
      
      updateBalancePill();
    }
  } catch (err) {
    console.error("Load balances error:", err);
  }
}
function updateBalancePill() {
  const pill = $("balancePill");
  if (!pill) return;
  
  if (window._isManager) {
    pill.style.display = "none"; // Managers see all in modal
  } else if (window._myName) {
    const balance = _balanceData.get(window._myName);
    if (balance) {
      $("balanceText").textContent = `PTO: ${balance.pto}h`;
      pill.style.display = "flex";
    }
  }
}
function openBalanceModal() {
  const agentView = $("agentBalanceView");
  const managerView = $("managerBalanceView");
  
  if (window._isManager) {
    agentView.style.display = "none";
    managerView.style.display = "block";
    renderBalanceList();
  } else {
    managerView.style.display = "none";
    agentView.style.display = "block";
    
    const balance = _balanceData.get(window._myName) || {pto: 0};
    $("agentPtoBalance").textContent = balance.pto;
  }
  
  $("balanceModal").style.display = "flex";
}
function closeBalanceModal() {
  $("balanceModal").style.display = "none";
}
function renderBalanceList() {
  const list = $("balanceList");
  const search = ($("balanceSearch").value || "").toLowerCase();
  
  list.innerHTML = "";
  
  _people
    .filter(p => !search || p.toLowerCase().includes(search))
    .forEach(person => {
      const balance = _balanceData.get(person) || {pto: 0};
      
      const item = document.createElement("div");
      item.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 10px; transition: all 0.2s;";
      item.onmouseover = () => { item.style.borderColor = "#86efac"; item.style.background = "#f0fdf4"; };
      item.onmouseout = () => { item.style.borderColor = "#e2e8f0"; item.style.background = "#f8fafc"; };
      
      item.innerHTML = `
        <div style="flex: 1; min-width: 0;">
          <div style="font-weight: 700; color: #1e293b;">${person}</div>
          <div style="font-size: 12px; color: #16a34a; font-weight: 600; margin-top: 2px;">
            ${balance.pto} hours available
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
          <div style="text-align: center;">
            <div style="font-size: 9px; color: #16a34a; font-weight: 700;">PTO</div>
            <input type="number" value="${balance.pto}" min="0" step="0.5" 
                   onchange="updateBalance('${person}', 'pto', this.value)"
                   style="width: 70px; padding: 8px; border: 2px solid #86efac; border-radius: 8px; text-align: center; font-size: 14px; font-weight: 700; background: #f0fdf4; color: #16a34a;">
          <span style="font-size: 12px; color: #64748b; margin-left: 4px;">hrs</span>
        </div>
      `;
      
      list.appendChild(item);
    });
}
function filterBalanceList() {
  renderBalanceList();
}
async function updateBalance(person, type, value) {
  try {
    const hours = parseFloat(value) || 0;
    
    const res = await fetch('/?action=balances/update', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        person: person,
        type: 'pto',
        hours: hours
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      // Update local cache
      if (!_balanceData.has(person)) {
        _balanceData.set(person, {pto: 0});
      }
      _balanceData.get(person).pto = hours;
      
      toast(`Updated ${person}'s PTO to ${hours}h`, "success");
    } else {
      toast(`Failed to update balance`, "error");
    }
  } catch (err) {
    console.error("Update balance error:", err);
    toast(`Error: ${err.message}`, "error");
  }
}
// Load balances when page loads
window.addEventListener('DOMContentLoaded', () => {
  loadBalances();
});
  
  function updateTeamAgentList() { 
  const t = $("teamDropdown").value; 
  const agentList = $("teamAgentList");
  agentList.innerHTML = ""; 
  // Update global active team
  _activeTeam = t;
  _selectedPeople.clear();
  
  // Apply the filters to the data
  applyLocalFilters(); 
  // Create the "Quick Filter" chips in the sidebar
  if (t) {
    const agentsInChannel = [... new Set(
      _allData.filter(x => x.team === t).map(x => x.person)
    )].sort();
    
    agentsInChannel.forEach(p => { 
      const b = document.createElement("button"); 
      b.className = "btn-pill"; 
      b.innerText = p; 
      b.onclick = () => {
        _selectedPeople.clear();
        _selectedPeople.add(p);
        applyLocalFilters();
        showToast(`Filtered to ${p}`);
      };
      agentList.appendChild(b); 
    }); 
  }
  
  // Re-render the view
  renderView();
}
  // Helper:  escape HTML to prevent XSS
function escapeHtml(str) {
  if (!str) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}
  function filterToday() {
    const today = pstISODate();
    _filteredData = _allData.filter(x => x.dateISO === today);
    if (_activeTeam) {
        _filteredData = _filteredData.filter(x => x.team === _activeTeam);
    }
    if (_selectedPeople.size > 0) {
        _filteredData = _filteredData.filter(x => _selectedPeople.has(x.person));
    }
    renderView();
    toast("Showing Today Only");
    if (_view === 'calendar') {
        setView('list');
    }
  }
  function setView(v) {
  // 1. üö® AUTO-EXIT MASTER MODE
  // If we are currently editing the template, force an exit before switching views
  if (typeof _isMasterMode !== 'undefined' && _isMasterMode) {
    exitMasterMode();
  }
  _view = v;
  
  // Toggle Buttons
  const btnSched = document.getElementById("btnSchedule");
  const btnMet = document.getElementById("btnMetrics");
  if(btnSched) btnSched.className = v === "schedule" ? "segBtn active" : "segBtn";
  if(btnMet) btnMet.className = v === "metrics" ? "segBtn active" : "segBtn";
  // Toggle Views
  const schedView = document.getElementById("scheduleView");
  const metView = document.getElementById("metricsView");
  const masterView = document.getElementById("masterView");
  if(schedView) schedView.style.display = v === "schedule" ? "flex" : "none";
  if(metView) metView.style.display = v === "metrics" ? "block" : "none";
  
  // Ensure Master View is hidden
  if(masterView) masterView.style.display = "none";
  if (v === "schedule") {
    renderScheduleView();
  } else if (v === "metrics") {
    renderMetricsList();
  }
}
let _selectedDateISO = null;
function renderScheduleView() {
  // Hide loading placeholder since we're rendering
  if ($("loadingPlaceholder")) $("loadingPlaceholder").style.display = "none";
  
  // 1. Get unique days from data
  const groups = groupShifts(_filteredData); // Reuse your existing grouper
  const sortedDates = Array.from(groups.keys()).sort(); // ["2025-01-06", "2025-01-07"...]
  if (sortedDates.length === 0) {
    document.getElementById("dayTabs").innerHTML = "";
    document.getElementById("viewDayTitle").textContent = "No Schedule";
    document.getElementById("viewDayStats").textContent = "";
    document.getElementById("dayContentBody").innerHTML = `
      <div style="text-align:center; color:#94a3b8; margin-top:50px;">
        <svg style="width:48px; height:48px; margin-bottom:12px; opacity:0.5;" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/>
        </svg>
        <div style="font-size:15px; font-weight:600;">No shifts found</div>
        <div style="font-size:13px; margin-top:4px;">Try adjusting your filters or loading more days</div>
      </div>`;
    return;
  }
  // Default to first day if none selected
  if (!_selectedDateISO || !groups.has(_selectedDateISO)) {
    _selectedDateISO = sortedDates[0];
  }
  // 2. Render Tabs (Left Sidebar)
  const tabsContainer = document.getElementById("dayTabs");
  tabsContainer.innerHTML = sortedDates.map(dateKey => {
    const d = new Date(dateKey + "T12:00:00"); // Safe parsing
    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
    const dayDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const isActive = dateKey === _selectedDateISO ? 'active' : '';
    return `
      <div class="day-tab ${isActive}" onclick="_selectedDateISO = '${dateKey}'; renderScheduleView();">
        <div class="day-name">${dayName}</div>
        <div class="day-date">${dayDate}</div>
      </div>
    `;
  }).join("");
  // 3. Render Main Content (Right Side)
  renderDayDetail(_selectedDateISO, groups.get(_selectedDateISO));
}
function renderDayDetail(dateKey, shifts) {
  // 1. Setup Date & Holiday Logic
  const d = new Date(dateKey + "T12:00:00");
  const dayOfWeek = d.toLocaleDateString("en-US", { weekday: 'short' });
  const holiday = getHoliday(dateKey); 
  
  // Title
  let titleHtml = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  if (holiday) {
    titleHtml += ` <span style="font-size:14px; background:${holiday.theme === 'christmas' ? '#dcfce7' : '#fef3c7'}; color:${holiday.theme === 'christmas' ? '#166534' : '#b45309'}; padding:4px 10px; border-radius:12px; border:1px solid rgba(0,0,0,0.1); margin-left:10px;">${holiday.emoji} ${holiday.name}</span>`;
  }
  document.getElementById("viewDayTitle").innerHTML = titleHtml;
  document.getElementById("viewDayStats").textContent = `${shifts.length} shifts scheduled`;
  const container = document.getElementById("dayContentBody");
  container.innerHTML = "";
  // 2. Group by Channel
  const byTeam = {};
  shifts.forEach(s => {
    const t = s.team || "Other";
    if (!byTeam[t]) byTeam[t] = [];
    byTeam[t].push(s);
  });
  // 3. Render Sections
  Object.keys(byTeam).sort().forEach(team => {
    const teamShifts = byTeam[team];
    const count = teamShifts.length;
    
    // Alert Logic
    const rule = _staffingRules.find(r => r.team === team && (r.day === "All" || r.day === dayOfWeek));
    const config = getChannelConfig(team);
    let countBadge = "";
    
    if (rule) {
      const min = parseInt(rule.min);
      countBadge = (count < min) 
        ? `<span style="font-size:12px; font-weight:700; background:#ef4444; color:white; padding:3px 10px; border-radius:12px; box-shadow:0 2px 5px rgba(239,68,68,0.3);">‚ö†Ô∏è ${count}/${min}</span>`
        : `<span style="font-size:12px; font-weight:700; background:#22c55e; color:white; padding:3px 10px; border-radius:12px;">‚úì ${count}/${min}</span>`;
    } else {
      countBadge = `<span style="font-size:11px; font-weight:700; background:${config.color}; color:${config.text}; padding:2px 8px; border-radius:10px; border:1px solid ${config.border};">${count} Agents</span>`;
    }
    // Sort shifts
    teamShifts.sort((a, b) => (a.start || "").localeCompare(b.start || ""));
    const section = document.createElement("div");
    section.className = "channel-section";
    section.innerHTML = `
      <div class="channel-header" style="border-color:${config.border}; display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #f1f5f9;">
        <span class="channel-title" style="color:${config.text}; font-weight:800; text-transform:uppercase; letter-spacing:0.5px;">${team}</span>
        ${countBadge}
      </div>
      <div class="shifts-grid"></div>
    `;
    const grid = section.querySelector(".shifts-grid");
    
    teamShifts.forEach(shift => {
      const isOff = (shift.notes || "").toLowerCase().includes("[off]");
      
      const card = document.createElement("div");
      card.className = "shift-card-b";
      
      // Check if selected (for bulk actions)
      if (_teamSelected.has(String(shift.assignmentId))) {
        card.style.outline = "2px solid #3b82f6";
        card.style.zIndex = "10";
      }
      // Styling
      card.style.borderLeftColor = isOff ? "#ef4444" : (config.border || "#cbd5e1");
      if (isOff) {
        card.style.background = "#fef2f2";
        card.style.opacity = "0.8";
      }
      card.innerHTML = `
        <div class="sc-time">
          <span>${shift.startLabel} - ${shift.endLabel}</span>
          ${isOff ? '<span style="color:#ef4444; font-weight:800; font-size:10px;">OFF</span>' : ''}
        </div>
        <div class="sc-name">${shift.person}</div>
        ${shift.role ? `<div class="sc-role">${shift.role}</div>` : ''}
        ${shift.notes && !isOff ? `<div style="font-size:11px; color:#64748b; margin-top:6px; font-style:italic;">${shift.notes}</div>` : ''}
      `;
      // --- üö® RESTORED INTERACTIONS ---
      
      // 1. Click Handler (Smart switching between Edit vs. Select)
      card.onclick = (e) => {
        if (window._isManager) {
          // If in "Channel" mode OR holding Shift key OR already selecting items -> Toggle Selection
          if (_mode === "team" || _teamSelected.size > 0 || e.shiftKey) {
            // We reuse your existing toggle logic, but adapt UI manually since 'selected' class works differently here
            const id = String(shift.assignmentId);
            if (_teamSelected.has(id)) {
                _teamSelected.delete(id);
                card.style.outline = "none";
            } else {
                _teamSelected.add(id);
                card.style.outline = "2px solid #3b82f6";
                _lastSelectedPerson = shift.person;
            }
            updateSelectionBar();
          } else {
            // Otherwise -> Open Edit Modal
            openReplaceModal(shift);
          }
        } else if (shift.person === window._myName) {
          openAgentActionModal(shift);
        }
      };
      // 2. Drag and Drop (Managers Only)
      if (window._isManager) {
          card.draggable = true;
          
          card.ondragstart = (e) => { 
             // Prevent dragging purely for visual noise, we only want drag *into* cards usually
             // But if you want to drag shifts, keep this. 
             e.preventDefault(); 
          }; 
          
          // Allow dropping names from the Quick Sidebar onto this card
          card.ondragover = (e) => { 
             if(_mode === "quick" && _dragPerson) { 
                 e.preventDefault(); 
                 card.style.background = "#eff6ff"; // Highlight on hover
                 card.style.borderColor = "#3b82f6";
             } 
          };
          
          card.ondragleave = () => { 
             // Reset styles on leave
             card.style.background = isOff ? "#fef2f2" : "white";
             card.style.borderColor = "#e2e8f0";
             card.style.borderLeftColor = isOff ? "#ef4444" : (config.border || "#cbd5e1");
          };
          
          card.ondrop = (e) => { 
             e.preventDefault(); 
             // Reset styles
             card.style.background = isOff ? "#fef2f2" : "white";
             card.style.borderColor = "#e2e8f0";
             card.style.borderLeftColor = isOff ? "#ef4444" : (config.border || "#cbd5e1");
             if(_dragPerson && _dragPerson !== shift.person) { 
                 // Open modal pre-filled with dragged name
                 _editing = shift; 
                 openReplaceModal(shift); 
                 setTimeout(() => {
                     const select = document.getElementById("mNewPerson");
                     if(select) select.value = _dragPerson;
                 }, 50); 
             } 
          };
      }
      // --------------------------------
      grid.appendChild(card);
    });
    container.appendChild(section);
  });
}
function exitMasterMode() {
    _isMasterMode = false;
    const btn = document.getElementById("btnMasterMode");
    const title = document.querySelector(".hTitle");
    const contextPill = document.getElementById("managerContextPill");
    
    if (btn) {
        btn.innerText = "Edit Master Schedule";
        btn.style.backgroundColor = "";
        btn.style.color = "";
    }
    if (title) title.innerText = "Scheduling Manager";
    if (contextPill) {
        if (_currentManagerName) {
            contextPill.innerText = "Viewing: " + _currentManagerName;
            contextPill.style.backgroundColor = "#7e22ce";
            contextPill.style.borderColor = "#6b21a8";
        } else {
            contextPill.style.display = "none";
        }
    }
}
  function resetAllFilters() {
    _activeTeam = '';
    _selectedPeople.clear();
    const teamDropdown = document.getElementById('teamDropdown');
    if (teamDropdown) teamDropdown.value = '';
    
    const calWrapper = document.getElementById('calViewWrapper');
    if (calWrapper) {
        const calGrid = $("calView");
        if (calGrid) calGrid.classList.remove('channel-filtered');
    }
    
    applyLocalFilters();
}
  function scrollCal(px) { const el=$("calView"); if(el) el.scrollBy({left:px,behavior:"smooth"}); }
  // --- NOTIFICATION SOUND ---
  function playNotificationSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const osc1 = audioCtx.createOscillator();
    const gain1 = audioCtx.createGain();
    osc1.connect(gain1);
    gain1.connect(audioCtx.destination);
    osc1.type = "sine";
    osc1.frequency.setValueAtTime(800, now); 
    gain1.gain.setValueAtTime(0.1, now);
    gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
    osc1.start(now);
    osc1.stop(now + 0.3);
    const osc2 = audioCtx.createOscillator();
    const gain2 = audioCtx.createGain();
    osc2.connect(gain2);
    gain2.connect(audioCtx.destination);
    osc2.type = "sine";
    osc2.frequency.setValueAtTime(600, now + 0.1); 
    gain2.gain.setValueAtTime(0.1, now + 0.1);
    gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.6); 
    osc2.start(now + 0.1);
    osc2.stop(now + 0.6);
  }
  function playSendSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const playTone = (freq, delay) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = "triangle"; 
        osc.frequency.setValueAtTime(freq, now + delay);
        osc.frequency.exponentialRampToValueAtTime(freq * 1.5, now + delay + 0.4);
        gain.gain.setValueAtTime(0, now + delay);
        gain.gain.linearRampToValueAtTime(0.15, now + delay + 0.05); 
        gain.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.4); 
        osc.start(now + delay);
        osc.stop(now + delay + 0.5);
    };
    playTone(440, 0);   
    playTone(659, 0.05); 
  }
  // ============================================
// INITIALIZATION - Runs when page loads
// ============================================
document.addEventListener("DOMContentLoaded", function() {
  console.log("Musely Scheduler: Loaded");
  // 1. Initialize notification badge as hidden
  const badge = document.getElementById("notifCount");
  if (badge) {
    badge.classList.add("hidden");
    badge.textContent = "0";
  }
  // 2. Setup notification button
  const btn = document.getElementById("btnNotif");
  const panel = document.getElementById("notifPanel");
  if (!btn) {
    console.warn("btnNotif not found");
    return;
  }
  if (!panel) {
    console.warn("notifPanel not found");
    return;
  }
  // Move panel to body to prevent z-index issues
  if (panel.parentElement !== document.body) {
    document.body.appendChild(panel);
  }
  // Ensure hidden by default
  panel.style.display = "none";
  // Style the button to be clickable
  btn.style.pointerEvents = "auto";
  btn.style.cursor = "pointer";
  // Single click handler for notification button
  btn.addEventListener("click", function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log("Notification button clicked!");
    toggleNotifPanel();
  }, true);
  // Click-away to close panel
  document.addEventListener("click", function(e) {
    if (panel.style.display !== "block") return;
    if (e.target.closest("#btnNotif") || e.target.closest("#notifPanel")) return;
    toggleNotifPanel(false);
  }, true);

  // ============================================
  // MANAGER PRESENCE TRACKING
  // ============================================

  // Send heartbeat if user is a manager
  function sendManagerHeartbeat() {
    if (!window._isManager || !window._myName) return;

    // Determine current view and area
    let view = "Daily Schedule";
    let area = "";

    if (_view === "metrics") {
      view = "Metrics";
    } else if (_view === "schedule") {
      if (_masterMode) {
        view = "Master Template";
      } else {
        view = "Daily Schedule";
        area = _selectedTeam || "";
      }
    }

    fetch('./?action=manager/heartbeat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        managerName: window._myName,
        view: view,
        area: area
      })
    }).catch(err => console.error('Heartbeat error:', err));
  }

  // Poll for active managers
  async function fetchManagerPresence() {
    if (!window._isManager) return;

    try {
      const res = await fetch('./?action=manager/presence');
      const data = await res.json();

      if (data.ok && data.activeManagers) {
        displayManagerPresence(data.activeManagers);
      }
    } catch (err) {
      console.error('Manager presence fetch error:', err);
    }
  }

  // Display manager presence in UI
  function displayManagerPresence(managers) {
    if (!managers || managers.length === 0) return;

    // Filter out current user
    const otherManagers = managers.filter(m => m.managerName !== window._myName);

    if (otherManagers.length === 0) return;

    // Create or update presence indicator
    let presenceEl = document.getElementById('managerPresenceIndicator');

    if (!presenceEl) {
      presenceEl = document.createElement('div');
      presenceEl.id = 'managerPresenceIndicator';
      presenceEl.className = 'pill';
      presenceEl.style.background = 'rgba(139, 92, 246, 0.2)';
      presenceEl.style.color = '#7c3aed';
      presenceEl.style.border = '1px solid #a78bfa';
      presenceEl.style.cursor = 'pointer';
      presenceEl.style.display = 'inline-block';

      const metaGroup = document.querySelector('.metaGroup');
      if (metaGroup) {
        metaGroup.appendChild(presenceEl);
      }
    }

    // Build display text
    if (otherManagers.length === 1) {
      const m = otherManagers[0];
      presenceEl.textContent = `üë§ ${m.managerName} ‚Ä¢ ${m.view}`;
      presenceEl.title = `${m.managerName} is viewing ${m.view}${m.area ? ` (${m.area})` : ''}`;
    } else {
      presenceEl.textContent = `üë• ${otherManagers.length} managers active`;
      presenceEl.title = otherManagers.map(m => 
        `${m.managerName}: ${m.view}${m.area ? ` (${m.area})` : ''}`
      ).join('\n');
    }

    // Add click to show details
    presenceEl.onclick = function() {
      Swal.fire({
        title: 'üë• Active Managers',
        html: `
          <div style="text-align: left; font-size: 14px;">
            ${otherManagers.map(m => `
              <div style="padding: 12px; margin-bottom: 8px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #8b5cf6;">
                <div style="font-weight: 600; color: #0f172a;">${m.managerName}</div>
                <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                  üìç ${m.view}${m.area ? ` ‚Ä¢ ${m.area}` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `,
        icon: 'info',
        confirmButtonColor: '#8b5cf6'
      });
    };

    presenceEl.style.display = 'inline-block';
  }

  // Start heartbeat and presence polling if manager
  if (window._isManager) {
    // Send initial heartbeat
    setTimeout(sendManagerHeartbeat, 1000);

    // Send heartbeat every 60 seconds
    setInterval(sendManagerHeartbeat, 60000);

    // Poll for other managers every 30 seconds
    setInterval(fetchManagerPresence, 30000);
    setTimeout(fetchManagerPresence, 2000);
  }
});
</script>

<!-- Future Time Off Request Modal (for agents) -->
<div id="futureTimeOffModal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 15000;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: white;
    border-radius: 16px;
    width: 400px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  ">
    <div style="padding:20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
      <div style="font-weight:700; font-size:18px; color:#0f172a;">üìÖ Request Time Off</div>
      <button onclick="closeFutureTimeOffModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">&times;</button>
    </div>
    
    <div style="padding:20px;">
      <!-- Date Selection -->
      <div style="margin-bottom:20px;">
        <label style="display:block; font-size:12px; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">Select Date</label>
        <input type="date" id="futureToDate" style="
          width:100%; 
          padding:14px; 
          border:2px solid #e2e8f0; 
          border-radius:10px; 
          font-size:16px;
          box-sizing:border-box;
        ">
      </div>
      
      <!-- Type Selection -->
      <div style="margin-bottom:20px;">
        <label style="display:block; font-size:12px; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">Type</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <label style="display:flex; align-items:center; gap:10px; padding:12px; border:2px solid #e2e8f0; border-radius:10px; cursor:pointer;">
            <input type="radio" name="futureToType" value="Make Up" checked style="width:16px; height:16px;">
            <span style="font-size:14px; font-weight:600;">üîÑ Make Up</span>
          </label>
          <label style="display:flex; align-items:center; gap:10px; padding:12px; border:2px solid #e2e8f0; border-radius:10px; cursor:pointer;">
            <input type="radio" name="futureToType" value="PTO" style="width:16px; height:16px;">
            <span style="font-size:14px; font-weight:600;">üí∞ Use PTO</span>
          </label>
        </div>
      </div>
      
      <!-- Reason -->
      <div style="margin-bottom:20px;">
        <label style="display:block; font-size:12px; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">Reason</label>
        <input type="text" id="futureToReason" placeholder="e.g., Vacation, Appointment..." style="
          width:100%; 
          padding:12px; 
          border:2px solid #e2e8f0; 
          border-radius:10px; 
          font-size:14px;
          box-sizing:border-box;
        ">
      </div>
      
      <!-- Submit -->
      <button onclick="submitFutureTimeOff()" style="
        width:100%;
        padding:14px;
        background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color:white;
        border:none;
        border-radius:10px;
        font-size:15px;
        font-weight:700;
        cursor:pointer;
      ">
        Submit Request ‚Üí
      </button>
    </div>
  </div>
</div>
<!-- Agent Notification Panel -->
<div id="agentNotifPanel" style="
  display: none;
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: 380px;
  max-width: 100%;
  background: white;
  box-shadow: -4px 0 20px rgba(0,0,0,0.15);
  z-index: 10000;
  flex-direction: column;
">
  <div style="display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid #e2e8f0;">
    <div style="font-weight:700; font-size:18px; color:#0f172a;">My Notifications</div>
    <button onclick="closeAgentNotifications()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">&times;</button>
  </div>
  <div id="agentNotifList" style="flex:1; overflow-y:auto; padding:12px;"></div>
</div>
<style>
.agent-notif-item {
  display: flex;
  gap: 12px;
  padding: 14px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s;
  position: relative;
  margin-bottom: 8px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
}
.agent-notif-item:hover {
  background: #f1f5f9;
}
.agent-notif-item.unread {
  background: #eff6ff;
  border-color: #bfdbfe;
}
.agent-notif-icon {
  font-size: 20px;
  flex-shrink: 0;
}
.agent-notif-content {
  flex: 1;
  min-width: 0;
}
.agent-notif-message {
  font-size: 13px;
  color: #0f172a;
  line-height: 1.4;
}
.agent-notif-time {
  font-size: 11px;
  color: #94a3b8;
  margin-top: 4px;
}
.agent-notif-dot {
  position: absolute;
  top: 14px;
  right: 14px;
  width: 8px;
  height: 8px;
  background: #3b82f6;
  border-radius: 50%;
}
</style>

<!-- Export Modal -->
<div id="exportOverlay" class="overlay" style="display:none;" onclick="if(event.target===this) closeExportModal()">
  <div class="modal" style="width: 420px;">
    <div class="mHead">
      <span class="mTitle">üì• Export Schedule to CSV</span>
      <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closeExportModal()">‚úï</button>
    </div>
    <div class="mBody">
      <div style="margin-bottom:20px;">
        <label>Start Date</label>
        <input type="date" id="exportStartDate" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
      </div>
      <div style="margin-bottom:20px;">
        <label>Number of Days</label>
        <input type="number" id="exportDays" value="14" min="1" max="90" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
      </div>
      <div style="margin-bottom:20px;">
        <label>Team (Optional - leave blank for all)</label>
        <select id="exportTeam" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
          <option value="">All Teams</option>
        </select>
      </div>
    </div>
    <div class="mFoot">
      <button class="btn ghost" onclick="closeExportModal()">Cancel</button>
      <button class="btn primary" onclick="performExport()">üì• Export CSV</button>
    </div>
  </div>
</div>

<script>
// Export Modal Functions
function openExportModal() {
  const modal = document.getElementById('exportOverlay');
  if (!modal) return;
  
  // Set default start date to today
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('exportStartDate');
  if (dateInput) dateInput.value = today;
  
  // Populate team dropdown
  const teamSelect = document.getElementById('exportTeam');
  if (teamSelect && window._teams) {
    teamSelect.innerHTML = '<option value="">All Teams</option>';
    window._teams.forEach(team => {
      const opt = document.createElement('option');
      opt.value = team;
      opt.textContent = team;
      teamSelect.appendChild(opt);
    });
  }
  
  modal.style.display = 'flex';
}

function closeExportModal() {
  const modal = document.getElementById('exportOverlay');
  if (modal) modal.style.display = 'none';
}

async function performExport() {
  const startDate = document.getElementById('exportStartDate')?.value;
  const days = parseInt(document.getElementById('exportDays')?.value || '14');
  const teamKey = document.getElementById('exportTeam')?.value || '';
  
  if (!startDate) {
    toast('Please select a start date', 'error');
    return;
  }
  
  try {
    const res = await fetch('./?action=schedule/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ startDate, days, teamKey })
    });
    
    if (!res.ok) {
      const data = await res.json();
      throw new Error(data.error || 'Export failed');
    }
    
    // Download the CSV file
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `schedule_${startDate}_${days}days${teamKey ? '_' + teamKey : ''}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    closeExportModal();
    toast('‚úÖ Schedule exported successfully!', 'success');
    
  } catch (err) {
    console.error('Export error:', err);
    toast('Export failed: ' + err.message, 'error');
  }
}
</script>

</body>
</html>
