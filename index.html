<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Musely Scheduler</title>
  <!-- âœ… Early session check to prevent login screen flash -->
  <script>
    (function() {
      try {
        var raw = localStorage.getItem('musely_auth_session');
        if (raw) {
          var data = JSON.parse(raw);
          var age = Date.now() - (data.lastActivity || data.timestamp || 0);
          var TTL = 8 * 60 * 60 * 1000; // 8 hours
          if (data.email && data.name && age < TTL) {
            // Valid session exists - set flag for CSS to use
            document.documentElement.setAttribute('data-authenticated', 'true');
            window._hasValidSession = true;
          }
        }
      } catch(e) { console.warn('Early session check failed:', e); }
    })();
  </script>
  <style>
    /* âœ… Hide auth overlay immediately if authenticated (prevents flash) */
    html[data-authenticated="true"] #authOverlay {
      display: none !important;
    }
    html[data-authenticated="true"] .header,
    html[data-authenticated="true"] .main {
      opacity: 1 !important;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  /* --- RESET & BASICS --- */
  * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
  
  /* --- DARK MODE VARIABLES --- */
  :root {
    --bg-primary: #f7f2f1;
  --bg-secondary: #ffffff;
  --bg-tertiary: #fbf6f5;
  --border-color: #eadfdd;
    --text-primary: #1a0e0d;
  --text-secondary: #6f5a57;
  --text-tertiary: #a38b87;
    --header-bg: #b37e78;
  --card-bg: #f7f2f1;
  --input-bg: #ffffff;
    --shadow-sm: rgba(0,0,0,0.04);
    --shadow-md: rgba(0,0,0,0.1);
    --shadow-lg: rgba(0,0,0,0.15);
   --shift-card-bg: #f7f2f1;
    --day-content-bg: #f7f2f1;
    --day-body-bg: #f7f2f1;
    --day-tab-bg: #b37e78;            /* calendar tabs */
  --day-tab-hover-bg: #c7928b;  
    --channel-header-color: #64748b;
    --chip-bg: #f1f5f9;
    --chip-color: #475569;
    --seg-bg: #f7f2f1;
    --seg-btn-color: #6f5a57;
    --seg-btn-active-bg: #ecd0b0;     /* selected tab vibe */
  --seg-btn-active-color: #1a0e0d;
    --load-controls-bg: #f7f2f1;
    --icon-btn-bg: rgba(15, 23, 42, 0.04);
    --icon-btn-color: #334155;
    --icon-btn-border: #e2e8f0;
    --coverage-title-color: #475569;
    --accent-primary: #d8636b;        /* request time off */
  --accent-selected: #ecd0b0;       /* selected calendar tab */
  --accent-header: #b37e78;  
    --day-header-bg: #b37e78;
    /* Modal accent colors */
    --modal-gradient-start: #b37e78;
    --modal-gradient-end: #8f5f5a;
    --modal-btn-shadow: rgba(179, 126, 120, 0.3);
    --modal-btn-hover-shadow: rgba(179, 126, 120, 0.4);
    --accent-secondary: #d8636b;
    --presence-pill-bg: rgba(255,255,255,0.16);
  --presence-pill-border: rgba(255,255,255,0.22);
  --presence-pill-text: rgba(255,255,255,0.95);
  --presence-pill-muted: rgba(255,255,255,0.72);
  --presence-dot: #34d399;
  }
  
  body.dark-mode {
    --bg-primary: #1f1f1f;
  --bg-secondary: #242424;
  --bg-tertiary: #2b2b2b;
  --border-color: #3a3a3a;
     --text-primary: #f3f3f3;
  --text-secondary: #cfcfcf;
  --text-tertiary: #a9a9a9;
    --header-bg: #1a0e0d;
  --card-bg: #242424;
  --input-bg: #1f1f1f;
    --shadow-sm: rgba(0,0,0,0.2);
    --shadow-md: rgba(0,0,0,0.3);
    --shadow-lg: rgba(0,0,0,0.4);
    --shift-card-bg: #232323;
    --day-content-bg: #232323;
    --day-body-bg: #1f1f1f;
    --day-tab-bg: #242424;  
    --day-tab-hover-bg: #2d2d2d;
    --channel-header-color: #e2e8f0;
    --chip-bg: #3a2a28;
    --chip-color: #e2e8f0;
    --seg-bg: #3a2a28;
    --seg-btn-color: #94a3b8;
   --seg-btn-active-bg: #a45953; 
     --seg-btn-active-color: #ffffff;
    --load-controls-bg: #1a0e0d;
    --icon-btn-bg: rgba(255, 255, 255, 0.1);
    --icon-btn-color: #cbd5e1;
    --icon-btn-border: #475569;
    --coverage-title-color: #94a3b8;
    --accent-header: #1a0e0d; 
    --day-header-bg: #3c1c1a;
    /* Modal accent colors - dark mode */
    --modal-gradient-start: #a45953;
    --modal-gradient-end: #7d3f3a;
    --modal-btn-shadow: rgba(164, 89, 83, 0.3);
    --modal-btn-hover-shadow: rgba(164, 89, 83, 0.5);
    --accent-primary: #a45953;
    --accent-secondary: #a45953;
    --presence-pill-bg: rgba(255,255,255,0.10);
  --presence-pill-border: rgba(255,255,255,0.16);
  --presence-pill-text: rgba(255,255,255,0.95);
  --presence-pill-muted: rgba(255,255,255,0.70);
  --presence-dot: #34d399;
  }
  
  body { 
    margin: 0; 
    padding: 0; 
    background: radial-gradient(circle at 20% 20%, rgba(179,126,120,0.12), transparent 35%), 
                radial-gradient(circle at 80% 0%, rgba(236,208,176,0.15), transparent 32%), 
                var(--bg-primary);
    color: var(--text-primary); 
    height: 100vh; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
    transition: background-color 0.2s, color 0.2s; 
    position: relative;
  }
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(to right, rgba(255,255,255,0.08) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,0.08) 1px, transparent 1px);
    background-size: 120px 120px;
    opacity: 0.35;
    pointer-events: none;
    z-index: 0;
  }
  body.dark-mode { 
    background: radial-gradient(circle at 20% 20%, rgba(164,89,83,0.18), transparent 38%), 
                radial-gradient(circle at 80% 0%, rgba(88,70,64,0.26), transparent 34%), 
                var(--bg-primary);
  }
  body.dark-mode::before {
    opacity: 0.06;
    background-image:
      linear-gradient(to right, rgba(255,255,255,0.06) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,0.06) 1px, transparent 1px);
  }
  
  /* --- HEADER --- */
.header { 
    height: 68px; 
    background: linear-gradient(135deg, var(--header-bg) 0%, color-mix(in srgb, var(--header-bg) 75%, #fff 10%));
    border-bottom: 1px solid color-mix(in srgb, var(--header-bg) 60%, #000 15%);
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 0 28px; 
    flex: 0 0 68px; 
    box-shadow: 0 12px 30px -18px rgba(0,0,0,0.45); 
    z-index: 600; 
    position: relative;
    transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
    backdrop-filter: blur(6px);
  }
  .hLeft { display: flex; align-items: center; gap: 16px; }
  .hTitle { 
    font-size: 18px; 
    font-weight: 800; 
    color: #fff;
    letter-spacing: -0.5px;
    transition: color 0.2s;
  }
  .metaGroup { display: flex; gap: 8px; align-items: center; }
  .pill { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .pill.off { background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
  .pill.on { background: rgba(34,197,94,0.2); color: #86efac; border: 1px solid rgba(34,197,94,0.3); }
  .pill.balance {
  background: rgba(255, 255, 255, 0.9);
  color: #166534; /* Dark Green text */
  border: 1px solid #bbf7d0;
  font-weight: 800;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.1s;
}
.pill.balance:hover {
  transform: scale(1.05);
  background: #ffffff;
}
.manager-presence-pill{
  background: var(--presence-pill-bg);
  border: 1px solid var(--presence-pill-border);
  color: var(--presence-pill-text);
}

.manager-presence-pill .presence-dot{
  background: var(--presence-dot) !important;
}

.manager-presence-pill .presence-view{
  color: var(--presence-pill-muted);
  border-left: 1px solid rgba(255,255,255,0.18);
}

  /* Profile Pill for Agents */
  .pill.profile-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: none;
    letter-spacing: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.18);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .pill.profile-pill:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }
  .profile-pill-icon {
    font-size: 14px;
  }
  .profile-pill-badge {
    background: rgba(255,255,255,0.25);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 800;
  }
  body.dark-mode .pill.profile-pill {
    background: linear-gradient(135deg, var(--accent-primary) 0%, color-mix(in srgb, var(--accent-primary) 70%, #000 30%) 100%);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
  }
  
  /* Sign Out Pill (Manager header) - Better contrast for light mode */
  .pill.sign-out-pill {
    background: rgba(255, 255, 255, 0.85);
    color: #5d3a36;
    border: 1px solid rgba(0, 0, 0, 0.12);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 11px;
    font-weight: 700;
    padding: 6px 14px;
    border-radius: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .pill.sign-out-pill:hover {
    background: rgba(255, 255, 255, 0.95);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  body.dark-mode .pill.sign-out-pill {
    background: rgba(255, 255, 255, 0.12);
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: none;
  }
  body.dark-mode .pill.sign-out-pill:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .pill.tz { background: rgba(255,255,255,0.1); color: #94a3b8; }
  
  /* Manager Presence Indicator - Better contrast for light mode */
  .manager-presence-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.85);
    border: 1px solid rgba(0, 0, 0, 0.12);
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .manager-presence-pill:hover {
  transform: translateY(-1px);
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
  .presence-dot {
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 50%;
    animation: presence-pulse 2s ease-in-out infinite;
  }
  @keyframes presence-pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(0.9); }
  }
  .presence-name {
  color: #5d3a36;
  font-weight: 700;
}
  .presence-view {
    color: #7a5652;
    font-size: 10px;
    padding-left: 6px;
    border-left: 1px solid rgba(0, 0, 0, 0.15);
  }
  .presence-count {
  color: #5d3a36;
  font-weight: 700;
}
  body.dark-mode .manager-presence-pill {
    background: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: none;
  }
  body.dark-mode .presence-name,
body.dark-mode .presence-count {
  color: rgba(255, 255, 255, 0.9);
}
  body.dark-mode .presence-view {
  color: rgba(255, 255, 255, 0.65);
  border-left-color: rgba(255, 255, 255, 0.15);
}
  
  .hRight { display: flex; align-items: center; gap: 16px; }
  .seg { 
    background-color:#f7f2f1 !important;
    padding: 4px; 
    border-radius: 8px; 
    display: flex; 
    gap: 2px;
    transition: background-color 0.2s;
  }
  .segBtn { 
    background: transparent; 
    border: none; 
    color: var(--seg-btn-color); 
    padding: 6px 14px; 
    font-size: 13px; 
    font-weight: 600; 
    border-radius: 6px; 
    cursor: pointer; 
    transition: all 0.2s; 
  }
  .segBtn:hover { color: var(--text-primary); }
  .segBtn.active { 
  background: var(--seg-btn-active-bg); 
  color: var(--seg-btn-active-color); 
  border: 1px solid rgba(179, 126, 120, 0.35); /* warmer */
  box-shadow: none; /* key change */
}
  .iconBtn { 
    width: 38px; 
    height: 38px; 
    border-radius: 8px; 
    border: 1px solid var(--icon-btn-border); 
    background: var(--icon-btn-bg); 
    color: var(--icon-btn-color);
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s; 
  
    position: relative;
}
  .iconBtn:hover { 
    background: var(--bg-tertiary); 
    color: var(--text-primary); 
  }
  .iconBtn svg { width: 20px; height: 20px; fill: currentColor; }
  .close {
  color: rgba(255,255,255,0.7);
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  padding: 0 5px;
}
.tool-grid {
  display: grid;
  grid-template-columns: 1fr 1fr; /* 2 Columns */
  gap: 16px;
  margin-bottom: 24px;
}
.tool-card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 20px;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: flex-start;
  position: relative;
}
.tool-card:hover {
  border-color: var(--text-tertiary);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--shadow-sm);
}
.tool-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  margin-bottom: 4px;
}
.tool-title { font-size: 14px; font-weight: 700; color: var(--text-primary); transition: color 0.2s; }
.tool-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.4; transition: color 0.2s; }

/* Admin Tools Modal Styles */
.admin-tools-body {
  background: var(--bg-secondary, #f8fafc);
}
.admin-audit-card,
.admin-agents-card {
  background: var(--card-bg, #fff);
  border: 1px solid var(--border-color, #e2e8f0);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
}
.admin-audit-card:hover,
.admin-agents-card:hover {
  border-color: var(--text-tertiary, #94a3b8);
}
.danger-btn {
  font-size: 11px;
  color: #ef4444 !important;
  background: var(--card-bg, #fff) !important;
  border: 1px solid #fecaca !important;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}
.danger-btn:hover {
  background: #fef2f2 !important;
  border-color: #ef4444 !important;
}

/* Danger Zone remains distinct but cleaner */
.danger-section {
  border-top: 1px dashed var(--border-color, #e2e8f0);
  padding-top: 20px;
  margin-top: 10px;
}
.close:hover {
  color: #fff;
}
#agFormTimeOff input[type="radio"]:checked + div {
  font-weight: 700;
}
/* Smooth transitions for the type selection cards */
#agFormTimeOff label {
  transition: all 0.2s ease;
}
  #notifCount {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ef4444;
    color: #fff;
    font-size: 10px;
    font-weight: 800;
    padding: 2px 6px;
    border-radius: 10px;
    border: 2px solid #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    pointer-events: none; /* âœ… badge won't block clicking */
  }
  /* Action button - glass style for header */
  .action-btn{
    background: rgba(255, 255, 255, 0.12);
    color: rgba(255, 255, 255, 0.9);
    border: none;
    padding: 8px 16px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .action-btn:hover{
    background: rgba(255, 255, 255, 0.22);
    transform: translateY(-1px);
  }
  body.dark-mode .action-btn{
    background: rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.85);
  }
  body.dark-mode .action-btn:hover{
    background: rgba(255, 255, 255, 0.15);
  }
  /* --- FILTER STYLES --- */
  .filter-card { 
    background: var(--card-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 10px; 
    padding: 12px; 
    margin-bottom: 15px; 
    box-shadow: 0 4px 6px -1px var(--shadow-sm);
    transition: all 0.2s;
  }
  .filter-header { 
    font-size: 10px; 
    text-transform: uppercase; 
    letter-spacing: 0.1em; 
    color: var(--text-tertiary); 
    font-weight: 800; 
    margin-bottom: 8px;
    transition: color 0.2s;
  }
  .btn-pill { 
    background: var(--bg-tertiary); 
    border: 1px solid var(--border-color); 
    padding: 5px 12px; 
    border-radius: 15px; 
    font-size: 12px; 
    cursor: pointer; 
    transition: all 0.2s;
    color: var(--text-primary);
  }
  .btn-pill:hover { 
    border-color: var(--text-tertiary); 
    background: var(--bg-secondary); 
  }
  .navGroup { 
    display: flex; 
    align-items: center; 
    gap: 4px; 
    margin-right: 16px; 
    border-right: 1px solid var(--border-color); 
    padding-right: 16px;
    transition: border-color 0.2s;
  }
  .navBtn { 
    width: 32px; 
    height: 32px; 
    border-radius: 8px; 
    border: 1px solid var(--border-color); 
    background: var(--card-bg); 
    color: var(--text-secondary); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    transition: all 0.2s; 
  }
  .navBtn:hover { 
    background: var(--bg-tertiary); 
    color: var(--text-primary); 
    border-color: var(--text-tertiary); 
  }
  .navBtn svg { width: 18px; height: 18px; fill: currentColor; }
  .pickerList { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-content: start; }
  .pRow { display: flex; align-items: center; gap: 12px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.1s; justify-content: flex-start; color: var(--text-primary); }
  .pRow:hover { background: var(--bg-tertiary); border-color: var(--text-tertiary); }
  .pRow input { margin: 0; width: 16px; height: 16px; cursor: pointer; }
  .chip { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--chip-color); background: var(--chip-bg); border: 1px solid transparent; cursor: pointer; transition: all 0.15s; }
  .chip:hover { background: var(--bg-tertiary); }
  .chip.active{
  background: var(--accent-selected);
  color: #1a0e0d;
  border-color: color-mix(in srgb, var(--accent-selected) 70%, #000 30%);
}
body.dark-mode .chip.active{
  background: var(--accent-selected);
  color: #fff;
  border-color: var(--accent-selected);
}
  .skel-wrapper { display: flex; gap: 16px; height: 100%; overflow: hidden; padding-bottom: 8px; }
  .skel-col { 
    min-width: 320px; 
    background: var(--card-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 16px; 
    padding: 16px; 
    display: flex; 
    flex-direction: column; 
    gap: 12px;
    transition: all 0.2s;
  }
  .skel-anim { 
    background: var(--bg-tertiary); 
    background-image: linear-gradient(to right, var(--bg-tertiary) 0%, var(--border-color) 20%, var(--bg-tertiary) 40%, var(--bg-tertiary) 100%); 
    background-repeat: no-repeat; 
    background-size: 800px 100%; 
    animation: shimmer 1.5s infinite linear forwards; 
    border-radius: 8px; 
  }
  @keyframes shimmer { 0% { background-position: -400px 0; } 100% { background-position: 400px 0; } }
  .skel-head { height: 30px; width: 60%; margin-bottom: 10px; }
  .skel-card { height: 80px; width: 100%; }
  .main { flex: 1; display: flex; overflow: hidden; position: relative; }
.content { 
    flex: 1; 
    overflow: hidden; 
    padding: 24px; 
    position: relative; 
    display: flex; 
    flex-direction: column; 
    gap: 16px;
    min-height: 0; /* Critical for nested flex scrolling */
  }
  /* === CALENDAR WRAPPER === */
  #calViewWrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    height: 100%;
  }
  .coverage-empty,
.coverage-empty-sub{
  font-size:12px;
  color: var(--text-secondary);
  font-style: italic;
}
  /* === CALENDAR GRID - DEFAULT (horizontal scroll) === */
  .calGrid { 
    display: flex; 
    gap: 16px; 
    flex: 1;
    min-height: 0;
    overflow-x: auto; 
    overflow-y: hidden;
    padding-bottom: 8px; 
    scrollbar-width: none; 
  }
  .calGrid::-webkit-scrollbar { display: none; }
  /* === DAY COLUMNS - DEFAULT === */
  .dayCol { 
    min-width: 320px; 
    max-width: 320px; 
    background: var(--day-body-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 16px; 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 2px 4px var(--shadow-sm); 
    overflow: hidden;
    flex-shrink: 0;
    transition: background-color 0.2s, border-color 0.2s;
  }
  /* === CHANNEL FILTERED MODE - Columns expand to fill screen === */
  .calGrid.channel-filtered {
    overflow-x: hidden;
  }
  
  .calGrid.channel-filtered .dayCol {
    flex: 1 1 0;
    min-width: 180px;
    max-width: none;
  }
.dayHead { 
    padding: 16px; 
    border-bottom: 1px solid var(--border-color); 
    display: flex; 
    justify-content: space-between; 
    font-weight: 800; 
    font-size: 15px; 
    color: var(--text-primary); 
    background: var(--card-bg); 
    border-radius: 16px 16px 0 0;
    flex-shrink: 0;
    transition: background-color 0.2s, border-color 0.2s, color 0.2s;
  }
.dayCol.today .dayHead{
  background: var(--accent-header);
  border-color: var(--accent-header);
  color: #fff;
}
.dayCol.today { 
  border-color: var(--accent-header);
  box-shadow: 0 6px 18px rgba(180,126,120,0.18);
}
body.dark-mode .dayCol.today{
  border-color: var(--accent-selected); /* a45953 */
  box-shadow: 0 6px 18px rgba(164,89,83,0.18);
}
.dayBody { 
    padding: 10px; 
    flex: 1; 
    overflow-y: auto; 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    scrollbar-width: none; 
  }
  .dayBody::-webkit-scrollbar { display: none; }
  /* --- NEW SCHEDULE VIEW STYLES --- */
.schedule-container {
  display: grid;
  grid-template-columns: 180px 1fr;
  gap: 20px;
  height: 100%;
  min-height: 0; /* Critical for flexbox children to scroll properly */
  overflow: hidden; /* inner parts scroll */
}
/* LEFT SIDEBAR (Day Tabs) */
  .day-tabs {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 180px;
  flex-shrink: 0;
  overflow-y: auto;
  padding: 8px 4px 8px 0;
  max-height: 100%;
  padding-right: 8px;
}
.day-tab {
  padding: 14px;
  background: var(--day-tab-bg);
  border: 2px solid var(--border-color);
  border-radius: 14px;
  cursor: pointer;
  text-align: left;
  transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s, color 0.2s;
  color: #fff;
  border-color: color-mix(in srgb, var(--day-tab-bg) 70%, #000 30%);
  box-shadow: 0 10px 24px -18px rgba(0,0,0,0.35);
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 8px;
  align-items: center;
  backdrop-filter: blur(4px);
}
  .day-tab .dot{
    width:10px;
    height:10px;
    border-radius:50%;
    background: rgba(255,255,255,0.85);
    display:inline-block;
    box-shadow: 0 0 0 4px rgba(255,255,255,0.12);
  }
  .day-tab:hover {
  background: var(--day-tab-hover-bg);
  border-color: var(--accent-header);
  transform: translateY(-2px);
  box-shadow: 0 16px 28px -22px rgba(0,0,0,0.55);
}
.day-tab:hover,
body.dark-mode .shift-chip:hover,
body.dark-mode #loadMoreControls button:hover{
  border-color: var(--accent-primary) !important;
  color: var(--accent-primary) !important;
}
  .day-tab.active{
  background: var(--accent-selected);
  border-color: var(--accent-selected);
  color: #1a0e0d;
  box-shadow: 0 16px 32px -18px rgba(0,0,0,0.35);
  transform: translateY(-1px);
}
body.dark-mode .day-tab.active{
  background: var(--accent-selected);
  border-color: var(--accent-selected);
  color: #fff;
}
.day-tab .day-name { font-weight: 800; font-size: 15px; }
.day-tab .day-date { font-size: 11px; opacity: 0.8; margin-top: 2px; text-transform:uppercase; letter-spacing:0.5px; }
/* MAIN CONTENT (Right Side) */
.day-content {
  flex: 1;
  background: linear-gradient(160deg, rgba(255,255,255,0.9), var(--day-content-bg));
  border-radius: 20px;
  border: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0; /* Critical for scroll to work */
  max-height: 100%; /* Constrain to container height */
  box-shadow: 0 12px 34px -18px rgba(0,0,0,0.25);
  transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
  position: relative;
}
.day-content::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background: radial-gradient(circle at 80% 20%, rgba(236,208,176,0.16), transparent 35%);
}
.day-content-header {
  padding: 20px 24px 14px 24px;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #334155;
  border-bottom-color: color-mix(in srgb, var(--accent-header) 60%, #000 40%);
  position: sticky;
  top: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.94), var(--day-content-bg));
  color: var(--text-primary);
  backdrop-filter: blur(6px);
  z-index: 2;
}
.day-content-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  background: var(--day-body-bg);
  transition: background-color 0.2s;
}
/* CHANNEL SECTIONS */
.channel-section { margin-bottom: 30px; }
.channel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--border-color);
  transition: border-color 0.2s;
}
.channel-title {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--ch-accent, var(--border-color));
  background: var(--ch-accent-bg, rgba(148,163,184,0.12));
  color: var(--text-primary);
  font-size: 12px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 0.10em;
}
.countBadge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  border:1px solid var(--border-color);
  background: var(--bg-tertiary);
  color: var(--text-primary);
}
.countBadge.neutral{
  border-color: var(--ch-accent, var(--border-color));
  background: var(--ch-accent-bg, rgba(148,163,184,0.10));
}
.countBadge.agent{
  background: transparent;
  border-color: transparent;
  color: var(--text-secondary);
  font-weight:700;
}
.countBadge.warn{
  background: rgba(239,68,68,0.14);
  border-color: rgba(239,68,68,0.35);
  color: #ef4444;
}
body.dark-mode .countBadge.warn{ color:#fca5a5; }
.countBadge.ok{
  background: rgba(34,197,94,0.14);
  border-color: rgba(34,197,94,0.35);
  color: #16a34a;
}
body.dark-mode .countBadge.ok{ color:#86efac; }
/* SHIFT GRID */
  .shifts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 14px;
}
/* List (vertical) view mode */
.shifts-grid.view-list {
  grid-template-columns: 1fr;
  gap: 8px;
}
.shifts-grid.view-list .shift-card-b {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 10px 14px;
}
.shifts-grid.view-list .sc-time {
  min-width: 110px;
  margin-bottom: 0;
}
.shifts-grid.view-list .sc-name {
  min-width: 130px;
  font-size: 14px;
}
.shifts-grid.view-list .sc-role {
  margin-top: 0;
}
/* Light mode */
.manager-presence-pill.mp-solo { background: rgba(255,255,255,0.35); border: 1px solid rgba(0,0,0,0.10); }
.manager-presence-pill.mp-one  { background: linear-gradient(135deg, rgba(179,126,120,0.40), rgba(143,95,90,0.35)); border: 1px solid rgba(179,126,120,0.35); }
.manager-presence-pill.mp-many { background: linear-gradient(135deg, rgba(164,89,83,0.40),  rgba(143,74,69,0.35)); border: 1px solid rgba(164,89,83,0.35); }
.manager-presence-pill.mp-editing { background: linear-gradient(135deg, rgba(245,158,11,0.40), rgba(217,119,6,0.35)); border: 1px solid rgba(245,158,11,0.45); }
.manager-presence-pill.mp-conflict { background: linear-gradient(135deg, rgba(239,68,68,0.50), rgba(220,38,38,0.45)); border: 1px solid rgba(239,68,68,0.6); animation: conflict-pulse 1.5s ease-in-out infinite; }
@keyframes conflict-pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
  50% { box-shadow: 0 0 12px 4px rgba(239,68,68,0.3); }
}

/* Presence editing indicators */
.presence-dot.editing { background: #f59e0b !important; animation: editing-pulse 1s ease-in-out infinite; }
.presence-dot.conflict { background: #ef4444 !important; animation: editing-pulse 0.8s ease-in-out infinite; }
@keyframes editing-pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.7; }
}
.presence-editing-badge {
  font-size: 10px;
  padding: 2px 6px;
  background: rgba(245,158,11,0.2);
  border: 1px solid rgba(245,158,11,0.4);
  border-radius: 4px;
  color: #b45309;
  font-weight: 600;
}
.presence-conflict-text {
  color: #dc2626;
  font-weight: 700;
  font-size: 11px;
}
body.dark-mode .presence-editing-badge {
  background: rgba(245,158,11,0.15);
  border-color: rgba(245,158,11,0.35);
  color: #fbbf24;
}
body.dark-mode .presence-conflict-text {
  color: #fca5a5;
}

/* Dark mode */
body.dark-mode .manager-presence-pill.mp-solo { background: rgba(255,255,255,0.14); border: 1px solid rgba(255,255,255,0.22); }
body.dark-mode .manager-presence-pill.mp-one  { background: linear-gradient(135deg, rgba(168,115,109,0.22), rgba(110,71,67,0.18)); border: 1px solid rgba(168,115,109,0.35); }
body.dark-mode .manager-presence-pill.mp-many { background: linear-gradient(135deg, rgba(196,112,106,0.22), rgba(164,89,83,0.18)); border: 1px solid rgba(196,112,106,0.35); }
body.dark-mode .manager-presence-pill.mp-editing { background: linear-gradient(135deg, rgba(245,158,11,0.25), rgba(217,119,6,0.20)); border: 1px solid rgba(245,158,11,0.35); }
body.dark-mode .manager-presence-pill.mp-conflict { background: linear-gradient(135deg, rgba(239,68,68,0.35), rgba(220,38,38,0.30)); border: 1px solid rgba(239,68,68,0.5); }

/* NEW CARD STYLE */
.shift-card-b {
  background: var(--shift-card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 16px;
  transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.2s, background-color 0.2s;
  border-left: 4px solid #cbd5e1; /* Default Color */
  position: relative;
  cursor: pointer;
  box-shadow: 0 10px 30px -22px rgba(0,0,0,0.45);
  backdrop-filter: blur(2px);
}
.shift-card-b:hover {
  transform: translateY(-2px);
  box-shadow: 0 18px 32px -18px rgba(0,0,0,0.35);
  border-color: var(--text-tertiary); /* Hover border */
}
.sc-time { font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; display:flex; justify-content:space-between;}
.sc-name { font-size: 16px; font-weight: 800; color: var(--text-primary); }
.sc-role { font-size: 11px; display: inline-block; padding: 2px 8px; border-radius: 10px; background: var(--chip-bg); color: var(--chip-color); font-weight: 600; margin-top: 6px; transition: background-color 0.2s, color 0.2s; }
/* Context colors for border-left */
.bd-livechat { border-left-color: #b3a6d5; }
.bd-phone { border-left-color: #a1c3c8; }
.bd-email { border-left-color: #fee498; }
.bd-social { border-left-color: #f8ca9b; }
  .listGrid { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; height: 100%; padding-right: 8px; }
  .listGroup { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px var(--shadow-sm); transition: background-color 0.2s, border-color 0.2s; }
  .listHead { font-weight: 700; font-size: 15px; margin-bottom: 14px; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; justify-content: space-between; transition: color 0.2s, border-color 0.2s; }
  .listRow { display: flex; flex-wrap: wrap; gap: 12px; }
  .shift { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 10px 14px; cursor: pointer; transition: all 0.15s; position: relative; min-width: 240px; display: flex; flex-direction: column; gap: 4px; }
  .shift:hover { transform: translateY(-2px); box-shadow: 0 4px 12px -2px var(--shadow-md); z-index: 5; border-color: var(--text-tertiary); }
  .sRow { display: flex; justify-content: space-between; align-items: center; }
  .sTime { font-size: 13px; font-weight: 800; color: var(--text-secondary); }
  .sName { font-size: 13px; font-weight: 600; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .sRole { font-size: 11px; color: var(--text-secondary); font-weight: 500; }
.t-other { 
  background:  #f8fafc; 
  border-color: #e2e8f0; 
}
.t-other .sTime, .t-other .sName { color: #475569; }
.t-11meeting, .t-1-1meetings, .t-11meetings { 
  background: #adbaf1 !important; 
  border-color: #8e9de0 !important; 
} 
.t-1-1meetings .sTime, .t-1-1meetings .sName,
.t-11meetings .sTime, .t-11meetings .sName { color: #20175c !important; }
  .t-lunch { 
  background: #fee498 !important; 
  border-color: #c8d4a0 !important; 
} 
.t-lunch .sTime, .t-lunch .sName { color: #2b4e2e !important; }
.t-projects, .t-reportingprojects { 
  background: #e9d0db !important; 
  border-color: #d4b0c0 !important; 
} 
.t-projects .sTime, .t-projects .sName,
.t-reportingprojects .sTime, .t-reportingprojects .sName { color: #8c1b47 !important; }
  .t-livechat { 
  background:  #b3a6d5 !important; 
  border-color: #9688c2 !important; 
} 
.t-livechat .sTime, .t-livechat .sName { color: #351d77 !important; }
  .t-floater, .t-emailfloater { 
  background:  #fee498 !important; 
  border-color: #ecd07a !important; 
} 
.t-floater .sTime, .t-floater .sName,
.t-emailfloater .sTime, .t-emailfloater .sName { color: #7f692a !important; }
  .t-phone, .t-phonesupport { 
    background: #fff3e0 !important; 
    border-color: #ffb74d !important; 
  } 
  .t-phone, .t-phonesupport { 
  background: #a1c3c8 !important; 
  border-color:  #7ea9b0 !important; 
} 
.t-phone .sTime, .t-phone .sName,
.t-phonesupport .sTime, .t-phonesupport .sName { color: #135062 !important; }
  .t-socials { 
  background: #f8ca9b !important; 
  border-color: #e5b078 !important; 
} 
.t-socials .sTime, .t-socials .sName { color: #b35f16 !important; }
  .t-disputes { 
  background: #d0b0ad !important; 
  border-color: #b89490 !important; 
} 
.t-disputes .sTime, .t-disputes .sName { color: #4c1130 !important; }
  .t-mdsupport, .t-md { 
  background: #a3c1f3 !important; 
  border-color: #7ba3e8 !important; 
} 
.t-mdsupport .sTime, .t-mdsupport .sName,
.t-md .sTime, .t-md .sName { color: #2655cb !important; }
  
  /* NEW CHANNELS */
  .t-lunch { background: #f3f4f6; border-color: #d1d5db; } .t-lunch .sTime, .t-lunch .sName { color: #374151; }
  .t-11meeting { background: #fdf2f8; border-color: #fbcfe8; } .t-11meeting .sTime, .t-11meeting .sName { color: #be185d; }
  .t-other { background: #f8fafc; border-color: #e2e8f0; }
  .shift.selected { outline: 2px solid #b37e78; z-index: 10; }
  .shift.dropTarget { background: #f0f9ff; border: 2px dashed #b37e78; }
  .selBox { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; background: #fff; border: 1px solid #cbd5e1; border-radius: 5px; display: none; align-items: center; justify-content: center; font-size: 14px; color: #0f172a; }
  .shift.selected .selBox { display: flex; background: #b37e78; border-color: #b37e78; color: #fff; }
 .drawer { 
  position: fixed; 
  top: 64px; 
  right: -320px; 
  bottom: 0; 
  width: 320px; 
  background: var(--card-bg); 
  border-left: 1px solid var(--border-color); 
  box-shadow: -4px 0 24px var(--shadow-sm); 
  transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.2s, border-color 0.2s; 
  z-index: 40; 
  display: flex; 
  flex-direction: column; /* Stack header and body vertically */
}
.drawer.open { right: 0; }
.drawerHead { 
  padding: 20px; 
  border-bottom: 1px solid var(--border-color); 
  font-weight: 700; 
  font-size: 15px; 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  background: var(--bg-tertiary); 
  flex-shrink: 0; /* ðŸš¨ Critical: Prevents header from shrinking when scrolling */
  color: var(--text-primary);
  transition: all 0.2s;
}
.drawerBody { 
  flex: 1; 
  min-height: 0; /* ðŸš¨ Critical: Tells browser to allow scrolling inside flex item */
  overflow-y: auto; 
  padding: 20px; 
}
  .qrSearch { 
    width: 100%; 
    padding: 10px 14px; 
    border: 1px solid var(--border-color); 
    border-radius: 10px; 
    margin-bottom: 16px; 
    background: var(--bg-tertiary); 
    font-size: 13px;
    color: var(--text-primary);
    transition: all 0.2s;
  }
  .qrItem { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    padding: 10px; 
    border-radius: 10px; 
    cursor: grab; 
    transition: background 0.1s; 
    border: 1px solid transparent; 
  }
  .qrItem:hover { 
    background: var(--bg-tertiary); 
    border-color: var(--border-color); 
  }
  .qrAvatar { 
    width: 32px; 
    height: 32px; 
    border-radius: 50%; 
    background: #cbd5e1; 
    color: #fff; 
    font-size: 12px; 
    font-weight: 700; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
  }
  .qrPerson.unavailable { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
  .metricsWrap { display:flex; gap:16px; height:100%; overflow: hidden; }
  .metricsLeft { 
    flex: 1; 
    background: var(--card-bg); 
    border: 1px solid var(--border-color); 
    border-radius:16px; 
    overflow:hidden; 
    display:flex; 
    flex-direction:column;
    transition: all 0.2s;
    min-height: 0;
    max-height: 100%;
  }
  .metricsTop { 
    padding:14px 16px; 
    border-bottom:1px solid var(--border-color); 
    background: var(--bg-tertiary); 
    display:flex; 
    gap:12px; 
    align-items:center; 
    justify-content:space-between;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .metricsTop input { max-width: 260px; margin:0; }
  .metricsList { padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; flex:1; min-height:0; max-height: 100%; }
  .metricsRow { 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    gap:12px; 
    padding:8px 10px; 
    border:1px solid var(--border-color); 
    border-radius:12px; 
    cursor:pointer; 
    transition: all 0.15s; 
  }
  .metricsRow:hover { 
    background: var(--bg-tertiary); 
    border-color: var(--text-tertiary); 
  }
  .metricsRow .left { display:flex; align-items:center; gap:10px; min-width:0; }
  .metricsRow .avatar { width:28px; height:28px; border-radius:50%; background:#cbd5e1; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:11px; flex: 0 0 auto; }
  .metricsRow .name { 
    font-weight:800; 
    color: var(--text-primary); 
    font-size:13px;
    white-space:nowrap; 
    overflow:hidden; 
    text-overflow:ellipsis;
    transition: color 0.2s;
  }
  .metricsRow .sub { 
    font-size:11px; 
    color: var(--text-secondary);
    transition: color 0.2s;
  }
  .metricsDrawer { 
    width: 0; 
    overflow:hidden; 
    background: var(--card-bg); 
    border:1px solid var(--border-color); 
    border-radius:16px; 
    transition: width 0.25s ease, background-color 0.2s, border-color 0.2s;
    display: flex;
    flex-direction: column;
    max-height: 100%;
  }
  .metricsDrawer.open { width: 420px; }
  .metricsDrawerHead { 
    padding:14px 16px; 
    border-bottom:1px solid var(--border-color); 
    background: var(--bg-tertiary); 
    display:flex; 
    align-items:center; 
    justify-content:space-between;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .metricsDrawerBody { padding:16px; overflow-y:auto; flex: 1; min-height: 0; }
  .tGroup { margin-bottom: 12px; background: transparent; }
  .tGroupHeader { 
    padding: 4px 0; 
    background: transparent; 
    font-size: 10px; 
    font-weight: 700; 
    color: var(--text-tertiary); 
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
    display: flex; 
    justify-content: space-between; 
    border-bottom: 1px solid var(--border-color); 
    margin-bottom: 6px;
    transition: all 0.2s;
  }
  .tGroupHeader:hover { 
    background: var(--border-color); 
    color: var(--text-primary); 
  }
  .tGroupBody { display: flex; flex-direction: column; gap: 6px; max-height: 250px; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
  .tGroupBody::-webkit-scrollbar { display: none; }
  .tGroup.collapsed .tGroupBody { display: none; }
  .tCount { background: #cbd5e1; color: #fff; border-radius: 10px; padding: 2px 6px; font-size: 10px; }
  .overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(15,23,42,0.5); 
    z-index: 10000; 
    display: none; 
    align-items: center; 
    justify-content: center; 
    backdrop-filter: blur(4px);
  }
  /* OPEN shift: loud + obvious */
.shift-card-b.is-open{
  position: relative;
  border-left-color: #f59e0b !important;
  box-shadow: 0 10px 30px rgba(245, 158, 11, .18);
  transform: translateZ(0);
  overflow: hidden;
}
/* diagonal warning stripes overlay */
.shift-card-b.is-open::before{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background:
    repeating-linear-gradient(
      135deg,
      rgba(245,158,11,.18) 0px,
      rgba(245,158,11,.18) 10px,
      rgba(245,158,11,.06) 10px,
      rgba(245,158,11,.06) 20px
    );
  opacity: .85;
  mix-blend-mode: multiply;
}
/* dark mode: keep it punchy but readable */
body.dark-mode .shift-card-b.is-open::before{
  opacity: .55;
  mix-blend-mode: screen;
}
/* bigger badge */
.sc-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  letter-spacing:.4px;
  line-height:1;
}
.sc-badge-open{
  background: rgba(245,158,11,.18);
  border: 1px solid rgba(245,158,11,.45);
  color: #b45309;
}
/* make the badge pop even more in dark mode */
body.dark-mode .sc-badge-open{
  background: rgba(245,158,11,.16);
  border-color: rgba(245,158,11,.55);
  color: #fbbf24;
}
/* subtle pulse ring so your eye catches it */
.shift-card-b.is-open{
  animation: openPulse 1.6s ease-in-out infinite;
}
@keyframes openPulse{
  0%, 100%{ box-shadow: 0 10px 30px rgba(245,158,11,.18); }
  50%{ box-shadow: 0 14px 44px rgba(245,158,11,.30); }
}

body.dark-mode .overlay {
    background: rgba(0,0,0,0.7);
  }
  
  /* --- COMPREHENSIVE DARK MODE OVERRIDES --- */
body.dark-mode .tool-card {
    background: var(--card-bg);
    border-color: var(--border-color);
  }
body.dark-mode .tool-title { color: var(--text-primary); }
body.dark-mode .tool-desc { color: var(--text-secondary); }
  
body.dark-mode #notifPanel {
    background: var(--card-bg) !important;
    border-color: var(--border-color) !important;
  }
body.dark-mode #notifPanel .mHead {
    background: var(--bg-secondary) !important;
    border-color: var(--border-color) !important;
  }
body.dark-mode #notifPanel .mTitle {
    color: var(--text-primary) !important;
  }
body.dark-mode #notifList .notif-item {
    background: var(--bg-secondary) !important;
    border-color: var(--border-color) !important;
  }
body.dark-mode #notifList .notif-item.timeoff-request {
    background: linear-gradient(135deg, #78350f 0%, #451a03 100%) !important;
    border-color: #92400e !important;
  }
body.dark-mode #notifList .notif-item.timeoff-request div[style*="color:#92400e"],
  body.dark-mode #notifList .notif-item.timeoff-request div[style*="color:#b45309"],
  body.dark-mode #notifList .notif-item.timeoff-request div[style*="color:#78350f"] {
    color: #fbbf24 !important;
  }
body.dark-mode #notifList .notif-item div[style*="color:#0f172a"],
body.dark-mode #notifList .notif-item div[style*="color:#334155"] {
    color: var(--text-primary) !important;
  }
body.dark-mode #notifList .notif-item div[style*="color:#64748b"] {
    color: var(--text-secondary) !important;
  }
  
body.dark-mode #loadMoreControls {
    background: var(--load-controls-bg);
    border-color: var(--border-color);
  }
body.dark-mode #loadMoreControls button {
    background: var(--card-bg);
    border-color: var(--border-color);
    color: var(--text-secondary);
  }
  body.dark-mode #loadMoreControls button:hover {
    border-color: #b37e78;
    color: #b37e78;
  }
  body.dark-mode #loadedRangeLabel {
    color: var(--text-secondary);
  }
  
  body.dark-mode .mst-day-card {
    background: var(--card-bg);
    border-color: var(--border-color);
  }
  body.dark-mode .mst-day-header {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-color);
  }
  body.dark-mode .mst-row {
    border-color: var(--border-color);
  }
  body.dark-mode .mst-row:hover {
    background: var(--bg-tertiary);
  }
  body.dark-mode .mst-name { color: var(--text-primary); }
  body.dark-mode .mst-role { color: var(--text-secondary); }
  
  body.dark-mode .shift-chip {
    background: var(--card-bg);
    border-color: var(--border-color);
    color: var(--text-primary);
  }
  body.dark-mode .shift-chip:hover {
    border-color: #b37e78;
    color: #b37e78;
  }
  body.dark-mode .shift-chip.add-btn {
    background: transparent;
    color: var(--text-tertiary);
  }
  
  body.dark-mode .audit-table th {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border-color: var(--border-color);
  }
  body.dark-mode .audit-table td {
    border-color: var(--border-color);
    color: var(--text-primary);
  }
  body.dark-mode .audit-table tr:hover {
    background: var(--bg-tertiary);
  }
  
  body.dark-mode .holidayItem {
    background: var(--bg-tertiary);
  }
  body.dark-mode .holidayItem:hover {
    background: var(--card-bg);
  }
  body.dark-mode .holidayName { color: var(--text-primary); }
  body.dark-mode .holidayDate { color: var(--text-secondary); }
  
  body.dark-mode .addHolidayForm {
    background: var(--bg-tertiary);
  }
  body.dark-mode .addHolidayForm label {
    color: var(--text-secondary);
  }
  
  body.dark-mode #agentQuickActions {
    background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(179,126,120,0.1) 100%);
    border-color: #b37e78;
  }
  body.dark-mode #agentQuickActions > div {
    background: var(--card-bg);
    border-color: var(--border-color);
  }
  body.dark-mode #agentRangeLabel {
    color: var(--text-primary);
  }
  
  body.dark-mode #agentNotifPanel {
    background: var(--card-bg);
    border-color: var(--border-color);
  }
  body.dark-mode .agent-notif-item {
    background: var(--bg-tertiary);
    border-color: var(--border-color);
  }
  body.dark-mode .agent-notif-item:hover {
    background: var(--card-bg);
  }
  body.dark-mode .agent-notif-item.unread {
    background: rgba(59,130,246,0.15);
    border-color: #b37e78;
  }
  body.dark-mode .agent-notif-message {
    color: var(--text-primary);
  }
  
  body.dark-mode #futureTimeOffModal > div > div:last-child {
    background: var(--card-bg);
  }
  body.dark-mode #futureTimeOffModal label {
    color: var(--text-secondary) !important;
  }
  body.dark-mode #futureTimeOffModal input,
  body.dark-mode #futureTimeOffModal select {
    background: var(--input-bg);
    border-color: var(--border-color);
    color: var(--text-primary);
  }
  body.dark-mode #futureTimeOffModal #futureTypeMakeUp,
  body.dark-mode #futureTimeOffModal #futureTypePTO {
    background: var(--card-bg);
    border-color: var(--border-color);
  }
  body.dark-mode #futureTimeOffPtoDisplay {
    background: linear-gradient(135deg, rgba(34,197,94,0.2) 0%, rgba(22,163,74,0.2) 100%) !important;
    border-color: rgba(134,239,172,0.5) !important;
  }
  
  body.dark-mode .metricsTop {
    color: var(--text-primary);
  }
  body.dark-mode .metricsTop > div {
    color: var(--text-primary) !important;
  }
  
  /* SweetAlert2 Dark Mode */
  body.dark-mode div.swal2-popup {
    background: var(--card-bg) !important;
  }
  body.dark-mode div.swal2-title {
    color: var(--text-primary) !important;
  }
  body.dark-mode div.swal2-html-container {
    color: var(--text-secondary) !important;
  }
  body.dark-mode .swal2-input,
  body.dark-mode .swal2-textarea {
    background: var(--input-bg) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  
  /* Coverage chips dark mode */
  body.dark-mode .coverage-chip.good {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.25) 100%);
    color: #86efac;
    border-color: #22c55e;
  }
  body.dark-mode .coverage-chip.warning {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.25) 100%);
    color: #fcd34d;
    border-color: #f59e0b;
  }
  body.dark-mode .coverage-chip.critical {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
    border-color: #ef4444;
  }
  body.dark-mode .coverage-all-good {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.25) 100%);
    color: #86efac;
    border-color: #22c55e;
  }
  body.dark-mode .coverage-banner.critical-state {
    background: rgba(239, 68, 68, 0.15);
    border-color: #ef4444;
  }
  body.dark-mode .coverage-banner.critical-state .coverage-banner-title {
    color: #fca5a5;
  }
  
  /* Profile modal dark mode */
  body.dark-mode #profileOverlay .modal .mHead {
    background: var(--bg-tertiary);
    border-color: var(--border-color);
  }
  body.dark-mode #pName,
  body.dark-mode #mName { color: var(--text-primary) !important; }
  body.dark-mode #pEmail,
  body.dark-mode #mEmail { color: var(--text-secondary) !important; }
  
  /* Admin modal dark mode */
  body.dark-mode #adminOverlay .modal {
    background: var(--card-bg);
  }
  
  /* ============================================ */
  /* COMPREHENSIVE DARK MODE ADDITIONS            */
  /* ============================================ */
  
  /* Edit Shift Modal - Complete Dark Mode */
  body.dark-mode #editShiftModal > div {
    background: var(--card-bg) !important;
    border: 1px solid var(--border-color);
  }
  body.dark-mode #editShiftModal h3 {
    color: var(--text-primary) !important;
  }
  body.dark-mode #editShiftModal label {
    color: var(--text-secondary) !important;
  }
  body.dark-mode #editShiftModal input[type="text"],
  body.dark-mode #editShiftModal input[type="time"],
  body.dark-mode #editShiftModal select {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  body.dark-mode #editShiftModal input:disabled {
    background: var(--bg-secondary) !important;
    color: var(--text-secondary) !important;
  }
  body.dark-mode #editShiftModal button {
    transition: all 0.2s;
  }
  body.dark-mode #editShiftModal button[onclick="closeModal()"] {
    background: var(--bg-tertiary) !important;
    color: var(--text-secondary) !important;
  }
  
  /* Admin Tools Modal - Full Dark Mode */
  body.dark-mode #adminOverlay .mBody {
    background: var(--bg-secondary) !important;
  }
  body.dark-mode #adminOverlay .tool-card {
    background: var(--card-bg) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode #adminOverlay .tool-title {
    color: var(--text-primary) !important;
  }
  body.dark-mode #adminOverlay .tool-desc {
    color: var(--text-secondary) !important;
  }
  body.dark-mode #adminOverlay .danger-section {
    background: rgba(239, 68, 68, 0.1) !important;
    border-color: rgba(239, 68, 68, 0.3) !important;
  }
  body.dark-mode #adminOverlay .admin-tools-body {
    background: var(--bg-secondary) !important;
  }
  body.dark-mode #adminOverlay .admin-audit-card,
  body.dark-mode #adminOverlay .admin-agents-card {
    background: var(--card-bg) !important;
    border-color: var(--border-color) !important;
  }
  /* Admin Tools - Bulk PTO Card Dark Mode */
  body.dark-mode #adminOverlay div[style*="background:linear-gradient(135deg, #f0fdf4"] {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.1) 100%) !important;
    border-color: rgba(34, 197, 94, 0.3) !important;
  }
  body.dark-mode #adminOverlay div[style*="color:#15803d"] {
    color: #4ade80 !important;
  }
  body.dark-mode #adminOverlay div[style*="color:#16a34a"] {
    color: #22c55e !important;
  }
  body.dark-mode .danger-btn {
    background: var(--card-bg) !important;
    border-color: rgba(239, 68, 68, 0.5) !important;
  }
  body.dark-mode .danger-btn:hover {
    background: rgba(239, 68, 68, 0.15) !important;
  }
  /* Danger Zone - Regenerate button dark mode */
  body.dark-mode #adminOverlay .danger-btn[style*="background:#dc2626"] {
    background: #dc2626 !important;
    color: white !important;
  }
  
  /* Staffing Modal Dark Mode */
  body.dark-mode #staffingModal .modal {
    background: var(--card-bg);
  }
  body.dark-mode #staffingModal .mBody {
    background: var(--bg-secondary);
  }
  body.dark-mode #staffingModal div[style*="background:#f8fafc"],
  body.dark-mode #staffingModal div[style*="background:#fbf6f5"] {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode #staffingModal label {
    color: var(--text-secondary);
  }
  body.dark-mode #staffingModal select,
  body.dark-mode #staffingModal input {
    background: var(--bg-secondary) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  
  /* Holiday Modal Dark Mode */
  body.dark-mode #holidayModal .modal {
    background: var(--card-bg);
  }
  body.dark-mode #holidayModal .mBody {
    background: var(--bg-secondary);
  }
  body.dark-mode #holidayModal .addHolidayForm {
    background: var(--bg-tertiary) !important;
  }
  body.dark-mode #holidayModal .holidayItem {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode #holidayModal .holidayName {
    color: var(--text-primary) !important;
  }
  body.dark-mode #holidayModal .holidayDate {
    color: var(--text-secondary) !important;
  }
  body.dark-mode #holidayModal input {
    background: var(--bg-secondary) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  
  /* Balance/Accrued Hours Modal Dark Mode */
  body.dark-mode #balanceModal .modal {
    background: var(--card-bg);
  }
  body.dark-mode #balanceModal .mBody {
    background: var(--bg-secondary);
  }
  body.dark-mode #balanceModal table th {
    background: var(--bg-tertiary) !important;
    color: var(--text-secondary) !important;
  }
  body.dark-mode #balanceModal table td {
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode #balanceModal input {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  body.dark-mode #balanceModal div[style*="background: linear-gradient"],
  body.dark-mode #balanceModal div[style*="background:#f0fdf4"],
  body.dark-mode #balanceModal div[style*="background:#f8fafc"] {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode #balanceModal div[style*="color:#15803d"],
  body.dark-mode #balanceModal div[style*="color: #15803d"] {
    color: #4ade80 !important;
  }
  
  /* Bulk PTO Modal Dark Mode */
  body.dark-mode #bulkPtoModal .modal {
    background: var(--card-bg);
  }
  body.dark-mode #bulkPtoModal .mBody {
    background: var(--bg-secondary);
  }
  body.dark-mode #bulkPtoModal div[style*="background:#f0fdf4"] {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode #bulkPtoModal div[style*="color:#15803d"],
  body.dark-mode #bulkPtoModal div[style*="color:#16a34a"] {
    color: #4ade80 !important;
  }
  body.dark-mode #bulkPtoModal label {
    color: var(--text-secondary) !important;
  }
  body.dark-mode #bulkPtoModal input {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  body.dark-mode #bulkPtoModal #bulkPtoPreview {
    background: var(--bg-tertiary) !important;
    color: var(--text-secondary) !important;
  }
  
  /* Time Off Queue Modal Dark Mode */
  body.dark-mode #timeOffQueueModal .modal {
    background: var(--card-bg);
  }
  body.dark-mode #timeOffQueueModal .mBody {
    background: var(--bg-secondary);
  }
  
  /* Audit Log Modal Dark Mode */
  body.dark-mode #auditOverlay .modal {
    background: var(--card-bg);
  }
  body.dark-mode #auditOverlay .mBody {
    background: var(--bg-secondary);
  }
  body.dark-mode .audit-table {
    background: var(--card-bg);
  }
  body.dark-mode .audit-table th {
    background: var(--bg-tertiary) !important;
    color: var(--text-secondary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode .audit-table td {
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode .audit-table tr:hover td {
    background: var(--bg-tertiary) !important;
  }
  
  /* Master Schedule View Dark Mode */
  body.dark-mode #masterSchedule {
    background: var(--bg-secondary);
  }
  body.dark-mode .mst-day-card {
    background: var(--card-bg) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode .mst-day-title {
    color: var(--text-primary) !important;
  }
  body.dark-mode .mst-row {
    border-color: var(--border-color) !important;
  }
  body.dark-mode .mst-row:hover {
    background: var(--bg-tertiary) !important;
  }
  body.dark-mode .mst-name {
    color: var(--text-primary) !important;
  }
  body.dark-mode .shift-chip {
    background: var(--bg-tertiary) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode .shift-chip:hover {
    background: var(--bg-secondary) !important;
    border-color: #b37e78 !important;
  }
  body.dark-mode #masterSchedule button {
    background: var(--card-bg) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  body.dark-mode #masterSchedule button:hover {
    border-color: #b37e78 !important;
    color: #b37e78 !important;
  }
  body.dark-mode #btnMasterAddAgent {
    background: #16a34a !important;
    border-color: #16a34a !important;
    color: white !important;
  }
  
  /* Replace Coverage Modal Dark Mode */
  body.dark-mode #modalOverlay .modal {
    background: var(--card-bg);
  }
  body.dark-mode #modalOverlay .mBody {
    background: var(--bg-secondary);
  }
  body.dark-mode #modalOverlay label {
    color: var(--text-secondary);
  }
  body.dark-mode #modalOverlay select,
  body.dark-mode #modalOverlay textarea {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  body.dark-mode #mSub {
    color: var(--text-secondary) !important;
  }
  
  /* Profile Overlay Dark Mode - Enhanced */
  body.dark-mode #profileOverlay .modal {
    background: var(--card-bg);
  }
  body.dark-mode #profileOverlay .mBody {
    background: var(--bg-secondary);
  }
  body.dark-mode #profileOverlay .metricCard {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode #profileOverlay .metricCard .metricValue {
    color: var(--text-primary) !important;
  }
  body.dark-mode #profileOverlay .metricCard .metricLabel {
    color: var(--text-secondary) !important;
  }
  
  /* Agent View Section Dark Mode */
  body.dark-mode .agentViewCard {
    background: var(--card-bg) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode .agentShiftItem {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode .agentShiftItem:hover {
    background: var(--bg-secondary) !important;
  }
  
  /* Agent PTO Dashboard Dark Mode */
  body.dark-mode .agent-pto-hero {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%);
    border-color: rgba(34, 197, 94, 0.3);
  }
  body.dark-mode .pto-hero-title {
    color: var(--text-primary);
  }
  body.dark-mode .pto-hero-subtitle {
    color: var(--text-secondary);
  }
  body.dark-mode .pto-ring-bg {
    stroke: var(--bg-tertiary);
  }
  body.dark-mode .pto-value {
    color: #86efac;
  }
  body.dark-mode .agent-stat-card {
    background: var(--bg-tertiary);
    border-color: var(--border-color);
  }
  body.dark-mode .agent-stat-value {
    color: var(--text-primary);
  }
  body.dark-mode .agent-stat-label {
    color: var(--text-secondary);
  }
  body.dark-mode .agent-info-card {
    background: var(--bg-tertiary);
    border-color: var(--border-color);
  }
  body.dark-mode .agent-info-title {
    color: var(--text-primary);
  }
  body.dark-mode .agent-info-item {
    color: var(--text-secondary);
  }
  
  /* SweetAlert2 Dark Mode - Enhanced */
  body.dark-mode .swal2-popup {
    background: var(--card-bg) !important;
    border: 1px solid var(--border-color);
  }
  body.dark-mode .swal2-title {
    color: var(--text-primary) !important;
  }
  body.dark-mode .swal2-html-container {
    color: var(--text-secondary) !important;
  }
  body.dark-mode .swal2-html-container table {
    color: var(--text-primary);
  }
  body.dark-mode .swal2-html-container table th {
    background: var(--bg-tertiary) !important;
    color: var(--text-secondary) !important;
  }
  body.dark-mode .swal2-html-container table td {
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
  }
  body.dark-mode .swal2-html-container table tr {
    border-color: var(--border-color) !important;
  }
  body.dark-mode .swal2-input,
  body.dark-mode .swal2-select,
  body.dark-mode .swal2-textarea {
    background: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  body.dark-mode .swal2-input::placeholder {
    color: var(--text-secondary) !important;
  }
  body.dark-mode .swal2-validation-message {
    background: rgba(239, 68, 68, 0.2) !important;
    color: #fca5a5 !important;
  }
  body.dark-mode .swal2-footer {
    border-color: var(--border-color) !important;
  }
  body.dark-mode .swal2-footer button {
    background: #16a34a !important;
  }
  body.dark-mode .swal2-close {
    color: var(--text-secondary) !important;
  }
  body.dark-mode .swal2-close:hover {
    color: var(--text-primary) !important;
  }
  
  /* Dropdown/Select Dark Mode */
  body.dark-mode select option {
    background: var(--card-bg);
    color: var(--text-primary);
  }
  
  /* Animation for cache indicator */
  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  /* --- LOAD CONTROLS --- */
  .load-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 8px 16px;
    background: var(--load-controls-bg);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    transition: background-color 0.2s, border-color 0.2s;
  }
  .load-btn {
    font-size: 12px;
    padding: 8px 14px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: var(--text-secondary);
    transition: all 0.2s;
  }
  .load-btn:hover {
    border-color: #b37e78;
    color: #b37e78;
  }
  .load-label {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
    padding: 0 8px;
    transition: color 0.2s;
  }
  
  /* Header divider dark mode */
  .header-divider {
    width: 1px;
    height: 24px;
    background: var(--border-color);
    transition: background-color 0.2s;
  }
  .modal { 
    background: var(--card-bg); 
    width: 440px; 
    border-radius: 20px; 
    box-shadow: 0 25px 50px -12px var(--shadow-lg); 
    overflow: hidden; 
    animation: popIn 0.2s;
    transition: background-color 0.2s;
  }
  @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .mHead { 
    padding: 20px; 
    background: var(--bg-tertiary); 
    border-bottom: 1px solid var(--border-color); 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    transition: background-color 0.2s, border-color 0.2s;
  }
  .mTitle { 
    font-weight: 800; 
    font-size: 16px; 
    color: var(--text-primary);
    transition: color 0.2s;
  }
  .mBody { 
    padding: 24px; 
  }
  .mFoot { 
    padding: 16px 24px; 
    background: var(--bg-tertiary); 
    border-top: 1px solid var(--border-color); 
    display: flex; 
    justify-content: flex-end; 
    gap: 10px;
    transition: background-color 0.2s, border-color 0.2s;
  }
  label { 
    display: block; 
    font-size: 12px; 
    font-weight: 700; 
    color: var(--text-secondary); 
    margin-bottom: 8px; 
    text-transform: uppercase; 
    letter-spacing: 0.5px;
    transition: color 0.2s;
  }
  textarea, select, input { 
    width: 100%; 
    border: 1px solid var(--border-color); 
    border-radius: 10px; 
    padding: 10px; 
    font-size: 14px; 
    outline: none; 
    background: var(--input-bg);
    color: var(--text-primary);
    transition: all 0.2s;
  }
  textarea:focus, select:focus, input:focus { 
    border-color: #b37e78; 
    box-shadow: 0 0 0 2px #bfdbfe; 
  }
  .btn { 
    padding: 10px 16px; 
    border-radius: 10px; 
    font-weight: 600; 
    font-size: 13px; 
    cursor: pointer; 
    border: none; 
    transition: all 0.2s; 
  }
  .btn.primary { 
    background: #1e293b; 
    color: #fff; 
  } 
  .btn.primary:hover { 
    background: #0f172a; 
  }
  .btn.ghost { 
    background: var(--card-bg); 
    border: 1px solid var(--border-color); 
    color: var(--text-secondary); 
  } 
  .btn.ghost:hover { 
    background: var(--bg-tertiary); 
    border-color: var(--text-tertiary); 
  }
  #toastHost { 
    position: fixed; 
    bottom: 24px; 
    right: 24px; 
    z-index: 10040;
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    transition: bottom 0.3s; 
  }
  /* ============================================
   AGENT MODAL STYLES
   ============================================ */
/* Agent Shift Modal - Modern Design */
.agent-shift-modal {
  width: 440px;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
  background: var(--card-bg, #ffffff);
}
.agent-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
  color: white;
}
.agent-modal-header-content {
  display: flex;
  align-items: center;
  gap: 14px;
}
.agent-modal-icon {
  font-size: 28px;
}
.agent-modal-title {
  font-size: 18px;
  font-weight: 800;
}
.agent-modal-subtitle {
  font-size: 12px;
  opacity: 0.85;
  margin-top: 2px;
}
.agent-modal-close {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.25);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}
.agent-modal-close svg {
  width: 18px;
  height: 18px;
  color: white;
}
.agent-modal-close:hover {
  background: rgba(255,255,255,0.25);
}
.agent-modal-body {
  padding: 24px;
}
/* Shift Info Card */
.shift-info-card {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 1px solid #e2e8f0;
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  margin-bottom: 24px;
}
.shift-info-date {
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.shift-info-time {
  font-size: 24px;
  font-weight: 900;
  color: #1e293b;
  margin-bottom: 8px;
}
.shift-info-team {
  display: inline-block;
  padding: 6px 14px;
  background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
  color: white;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
}
/* Agent Action List */
.agent-action-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.agent-shift-action {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  background: var(--card-bg, #ffffff);
  border: 2px solid #e2e8f0;
  border-radius: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: left;
}
.agent-shift-action:hover {
  border-color: #b37e78;
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(179, 126, 120, 0.15);
}
.action-icon-wrapper {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.action-icon-wrapper.swap {
  background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
}
.action-icon-wrapper.timeoff {
  background: linear-gradient(135deg, #d8636b 0%, #b54f56 100%);
}
.action-icon-wrapper svg {
  width: 24px;
  height: 24px;
  color: white;
}
.action-content {
  flex: 1;
}
.action-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary, #1e293b);
  margin-bottom: 2px;
}
.action-desc {
  font-size: 12px;
  color: var(--text-secondary, #64748b);
}
.action-arrow {
  width: 20px;
  height: 20px;
  color: #94a3b8;
  flex-shrink: 0;
}
/* Agent Form Section */
.agent-form-section {
  animation: slideIn 0.3s ease;
}
.form-group {
  margin-bottom: 16px;
}
.form-label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary, #64748b);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.form-select,
.form-input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 14px;
  background: var(--card-bg, #ffffff);
  color: var(--text-primary, #1e293b);
  transition: all 0.2s;
}
.form-select:focus,
.form-input:focus {
  outline: none;
  border-color: #b37e78;
  box-shadow: 0 0 0 4px rgba(179, 126, 120, 0.1);
}
.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}
.btn-back {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px;
  background: #f1f5f9;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  color: #475569;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-back:hover {
  background: #e2e8f0;
}
.btn-submit {
  flex: 2;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px;
  background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
  border: none;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-submit:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(179, 126, 120, 0.4);
}

/* Dark Mode for Agent Modal */
body.dark-mode .agent-shift-modal {
  background: var(--card-bg);
}
body.dark-mode .shift-info-card {
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  border-color: var(--border-color);
}
body.dark-mode .shift-info-time {
  color: var(--text-primary);
}
body.dark-mode .shift-info-date {
  color: var(--text-secondary);
}
body.dark-mode .agent-shift-action {
  background: var(--card-bg);
  border-color: var(--border-color);
}
body.dark-mode .agent-shift-action:hover {
  border-color: #b37e78;
}
body.dark-mode .form-select,
body.dark-mode .form-input {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
  color: var(--text-primary);
}
body.dark-mode .btn-back {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
  color: var(--text-primary);
}

/* Legacy support for old styles */
#agentOverlay .modal {
  width: 440px;
  border-radius: 20px;
}
#agentOverlay .agBtn-submit {
  background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 14px;
  font-weight: 700;
  cursor: pointer;
}
  /* When the selection bar is open, push toasts up (note: only works if toastHost is after selection bar) */
  .selection-bar.visible ~ #toastHost { bottom: 80px; }
  .toast { background: #1e293b; color: #fff; padding: 14px 18px; border-radius: 12px; font-size: 13px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 16px; min-width: 320px; justify-content: space-between; }
  .hidden { display: none !important; }
 /* ============================================
   AUTH PENDING - Hide app until signed in
   ============================================ */
body.auth-pending .header,
body.auth-pending .navGroup,
body.auth-pending .main,
body.auth-pending #loadMoreControls,
body.auth-pending #rightDrawer,
body.auth-pending #coverageBanner,
body.auth-pending #selectionBar {
  display: none !important;
}
body.auth-pending #authOverlay {
  display: flex !important;
}
/* When authenticated, hide the overlay */
body:not(.auth-pending) #authOverlay {
  display: none !important;
}
 /* ============================================
   AGENT VIEW - Full Lockdown
   ============================================ */
/* Hide manager-only header elements */
body.agent-mode #btnAdmin,
body.agent-mode #btnMasterMode,
body.agent-mode #drawerToggle,
body.agent-mode #teamChips,
body.agent-mode #btnNotif,
body.agent-mode #btnTimezone {
  display: none !important;
}
/* Hide load history/future buttons for agents - show simpler version */
body.agent-mode #loadMoreControls {
  display: none !important;
}
/* Agent-specific schedule controls */
body.agent-mode #agentScheduleControls {
  display: flex !important;
}
/* Hide view toggle (List/Calendar/Metrics) - or keep if you want agents to switch views */
body.agent-mode .hRight .seg {
  display: none;
}
/* Hide the right drawer entirely */
body.agent-mode #rightDrawer {
  display: none !important;
}
/* Adjust content without drawer */
body.agent-mode .content {
  padding:  20px;
}
/* Hide team group collapse functionality */
body.agent-mode .tGroupHeader {
  pointer-events: none;
  border-bottom: 2px solid #e2e8f0;
}
/* Hide selection checkboxes */
body.agent-mode .selBox {
  display: none !important;
}
/* Hide selection bar */
body.agent-mode #selectionBar {
  display: none !important;
}
/* Make shift cards read-only - BUT allow clicking for agent actions (swap/time-off) */
body.agent-mode .shiftCard {
  cursor: pointer;
}
/* âœ… FIX: Show the group so Agents can see the PTO Pill */
body.agent-mode .metaGroup {
  display: flex !important;
}
/* Hide specific Admin items from Agents */
body.agent-mode #autoPill,
body.agent-mode #managerContextPill {
  display: none !important;
}
/* Navigation should still work */
body.agent-mode .navGroup {
  display: flex;
}
/* Style the header differently for agents */
body.agent-mode .header {
  background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
}
/* Fix agent header icons to be visible on blue background */
body.agent-mode .header .iconBtn {
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.25);
}
body.agent-mode .header .iconBtn svg {
  fill: white;
}
body.agent-mode .header .iconBtn:hover {
  background: rgba(255,255,255,0.25);
}
/* Agent notification badge styling */
body.agent-mode #agentNotifBadge {
  background: #fbbf24 !important;
  color: #1e293b !important;
}
/* Agent header title */
body.agent-mode .hTitle {
  color: white;
}
/* Balance pill styling for agent view */
body.agent-mode .pill.balance {
  background: rgba(255,255,255,0.2);
  color: white;
  border-color: rgba(255,255,255,0.3);
}
/* Profile pill in agent mode header */
body.agent-mode .pill.profile-pill {
  background: rgba(255,255,255,0.2);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
body.agent-mode .pill.profile-pill:hover {
  background: rgba(255,255,255,0.3);
}
body.agent-mode .profile-pill-badge {
  background: rgba(255,255,255,0.3);
}

/* Agent Toolbar Styles */
.agent-toolbar {
  display: none;
  align-items: center;
  gap: 12px;
  padding: 14px 20px;
  background: var(--card-bg, #ffffff);
  border-bottom: 1px solid var(--border-color, #e2e8f0);
  flex-wrap: wrap;
}
body.agent-mode .agent-toolbar {
  display: flex !important;
}
.agent-toolbar-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 14px;
  background: var(--bg-tertiary, #f8fafc);
  border-radius: 10px;
  border: 1px solid var(--border-color, #e2e8f0);
}
.agent-toolbar-item .toolbar-icon {
  font-size: 18px;
}
.agent-toolbar-item .toolbar-text {
  display: flex;
  flex-direction: column;
}
.agent-toolbar-item .toolbar-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--text-secondary, #64748b);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.agent-toolbar-item .toolbar-value {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-primary, #1e293b);
}
.agent-toolbar-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
}
.agent-toolbar-btn.secondary {
  background: var(--bg-tertiary, #f8fafc);
  color: var(--text-primary, #475569);
  border: 1px solid var(--border-color, #e2e8f0);
}
.agent-toolbar-btn.secondary:hover {
  background: var(--bg-secondary, #f1f5f9);
  border-color: #b37e78;
  color: #b37e78;
}
.agent-toolbar-btn.primary {
  background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
  color: white;
  box-shadow: 0 2px 8px rgba(179,126,120,0.3);
}
.agent-toolbar-btn.primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(179,126,120,0.4);
}

/* Agent Schedule Banner */
.agent-schedule-banner {
  display: none;
  gap: 16px;
  padding: 16px 20px;
  background: var(--bg-secondary, #f8fafc);
  border-bottom: 1px solid var(--border-color, #e2e8f0);
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
}
body.agent-mode .agent-schedule-banner {
  display: grid;
}
.agent-schedule-card {
  background: var(--card-bg, #ffffff);
  border: 1px solid var(--border-color, #e2e8f0);
  border-radius: 14px;
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  box-shadow: 0 6px 12px rgba(15, 23, 42, 0.06);
}
.agent-schedule-card-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.agent-schedule-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-secondary, #64748b);
  text-transform: uppercase;
  letter-spacing: 0.6px;
}
.agent-schedule-pill {
  font-size: 11px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 999px;
  background: #e2e8f0;
  color: #475569;
}
.agent-schedule-pill.active {
  background: #dcfce7;
  color: #166534;
}
.agent-schedule-pill.off {
  background: #fee2e2;
  color: #b91c1c;
}
.agent-schedule-time {
  font-size: 18px;
  font-weight: 800;
  color: var(--text-primary, #1e293b);
}
.agent-schedule-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--text-secondary, #64748b);
  font-weight: 600;
}
.agent-schedule-team {
  padding: 2px 8px;
  border-radius: 999px;
  background: var(--bg-tertiary, #f1f5f9);
  border: 1px solid var(--border-color, #e2e8f0);
  color: var(--text-primary, #1e293b);
}
.agent-schedule-progress {
  height: 6px;
  border-radius: 999px;
  background: var(--bg-tertiary, #f1f5f9);
  overflow: hidden;
}
.agent-schedule-progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #b37e78 0%, #8f5f5a 100%);
  transition: width 0.3s ease;
}
.agent-schedule-date {
  font-size: 12px;
  color: var(--text-secondary, #64748b);
  font-weight: 600;
}

/* Dark mode agent toolbar */
body.dark-mode .agent-toolbar {
  background: #1a0e0d;
  border-color: var(--border-color);
}
body.dark-mode .agent-toolbar-item {
  background: #1a0e0d;
  border-color: var(--border-color);
}

body.dark-mode .agent-toolbar-btn.secondary {
  background: var(--bg-secondary);
  border-color: var(--border-color);
  color: var(--text-primary);
}

body.dark-mode .agent-toolbar-btn.secondary:hover {
  background: var(--bg-tertiary);
}

body.dark-mode .agent-schedule-banner {
  background: var(--bg-secondary);
  border-color: var(--border-color);
}
body.dark-mode .agent-schedule-card {
  background: var(--card-bg);
  border-color: var(--border-color);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}
body.dark-mode .agent-schedule-pill {
  background: rgba(148, 163, 184, 0.2);
  color: var(--text-secondary);
}
body.dark-mode .agent-schedule-pill.active {
  background: rgba(34, 197, 94, 0.2);
  color: #86efac;
}
body.dark-mode .agent-schedule-pill.off {
  background: rgba(239, 68, 68, 0.2);
  color: #fca5a5;
}
body.dark-mode .agent-schedule-team {
  background: rgba(148, 163, 184, 0.12);
  border-color: var(--border-color);
  color: var(--text-primary);
}
body.dark-mode .agent-schedule-progress {
  background: var(--bg-tertiary);
}

  /* --- NEW SELECTION BAR STYLES --- */
  .selection-bar {
    position: fixed;
    bottom: -100px;
    left: 0;
    right: 0;
    background: #1e293b;
    color: white;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 999;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
  }
  .selection-bar.visible { bottom: 0; }
  .sb-left { display: flex; align-items: center; gap: 16px; }
  .sb-count { font-weight: 800; font-size: 16px; color: #fff; }
  .sb-actions { display: flex; gap: 10px; }
  .sb-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .sb-btn:hover { background: rgba(255,255,255,0.2); }
  .sb-btn.primary { 
  background: var(--accent-primary);
  border-color: var(--accent-primary); }
  .sb-btn.primary:hover { background: #8f5f5a; filter: brightness(0.95); }
  .sb-btn.danger { background: #ef4444; border-color: #ef4444; }
  .sb-btn.danger:hover { background: #dc2626; }
  /* New Styles for Audit Table */
  .audit-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .audit-table th { text-align: left; padding: 8px; background: var(--bg-tertiary); color: var(--text-secondary); font-weight: 700; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
  .audit-table td { padding: 8px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); vertical-align: top; transition: color 0.2s, border-color 0.2s; }
  .audit-table tr:hover { background: var(--bg-tertiary); }
  .audit-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size: 9px; text-transform: uppercase; }
  .ab-red { background: #fee2e2; color: #991b1b; }
  .ab-blue { background: #dbeafe; color: #8f5f5a; }
  /* --- NEW MASTER VIEW STYLES --- */
  .mst-day-card {
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 2px 5px var(--shadow-sm);
    margin-bottom: 20px;
    overflow: hidden;
    border: 1px solid var(--border-color);
    transition: background-color 0.2s, border-color 0.2s;
  }
  .mst-day-header {
    background: var(--bg-tertiary);
    padding: 12px 16px;
    font-weight: 800;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s, color 0.2s, border-color 0.2s;
  }
  .mst-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    gap: 16px;
    transition: background 0.1s, border-color 0.2s;
  }
  .mst-row:hover { background: var(--bg-tertiary); }
  .mst-row.selected { background: #fbf6f5; }
  .mst-person-info { width: 200px; flex-shrink: 0; }
  .mst-name { font-weight: 700; color: var(--text-primary); font-size: 14px; transition: color 0.2s; }
  .mst-role { font-size: 11px; color: var(--text-secondary); font-weight: 500; transition: color 0.2s; }
  .mst-shifts-area { flex: 1; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
  .shift-chip {
    display: flex;
    align-items: center;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 2px var(--shadow-sm);
  }
  .shift-chip:hover {
    border-color: #b37e78;
    color: #b37e78;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px var(--shadow-md);
  }
  .shift-chip.add-btn {
    border-style: dashed;
    color: var(--text-tertiary);
    background: transparent;
    box-shadow: none;
  }
  .shift-chip.add-btn:hover {
    border-color: #b37e78;
    background: #fbf6f5;
    color: #b37e78;
  }
  /* SweetAlert2 Overrides to match your theme */
  div:where(.swal2-container) { z-index: 12000 !important; }
  div:where(.swal2-popup) { border-radius: 16px !important; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important; }
  div:where(.swal2-title) { font-weight: 800 !important; color: #0f172a !important; }
  .hClose { cursor: pointer; font-size: 20px; color: #64748b; padding: 5px; }
  .hClose:hover { color: #ef4444; }
  
  /* ===========================
     âœ… NOTIFICATION PANEL FIXES
     =========================== */
  #notifPanel {
  position: fixed !important;
  top: 70px !important;
  right:  20px !important;
  width:  360px !important;
  display: none;
  background: var(--card-bg) !important;
  border: 1px solid var(--border-color) !important;
  box-shadow: 0 10px 25px var(--shadow-md) !important;
  border-radius: 16px !important;
  z-index: 10050 !important;
  overflow: hidden !important;
  pointer-events: auto !important;
  transition: background-color 0.2s, border-color 0.2s;
}
#notifPanel.open {
  display: block;
}
/* ============================================
   HOLIDAY THEMES - Calendar View
   ============================================ */
/* Base holiday styling */
.dayCol[class*="holiday-"] .dayHead {
  position: relative;
}
.dayCol[class*="holiday-"] .holidayBadge {
  font-size: 0.75rem;
  opacity: 0.9;
  margin-left: 8px;
}
/* ðŸŽ„ Christmas Theme */
.dayCol.holiday-christmas {
  border: 3px solid transparent;
  border-image: repeating-linear-gradient(
    90deg,
    #e53e3e 0px, #e53e3e 8px,
    #38a169 8px, #38a169 16px,
    #ecc94b 16px, #ecc94b 24px
  ) 1;
  border-radius: 0;
}
.dayCol.holiday-christmas .dayHead {
  background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%) !important;
}
/* ðŸŽ† New Year Theme */
.dayCol.holiday-newyear {
  border:  3px solid #d4af37;
  box-shadow: 0 0 15px rgba(212, 175, 55, 0.25);
}
.dayCol.holiday-newyear .dayHead {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
  color: #ffd700 !important;
}
.dayCol.holiday-newyear .dayHead span {
  color: #ffd700 !important;
}
/* ðŸ‡ºðŸ‡¸ July 4th Theme */
.dayCol.holiday-july4th {
  border: 3px solid;
  border-image: repeating-linear-gradient(
    90deg,
    #bf0a30 0px, #bf0a30 8px,
    #ffffff 8px, #ffffff 16px,
    #002868 16px, #002868 24px
  ) 1;
}
.dayCol.holiday-july4th .dayHead {
  background: linear-gradient(135deg, #002868 0%, #bf0a30 100%) !important;
}
/* ðŸŽƒ Halloween Theme */
.dayCol.holiday-halloween {
  border: 3px solid #ff6b00;
  background: linear-gradient(180deg, #fff 0%, #fff8f0 100%);
}
.dayCol.holiday-halloween .dayHead {
  background: linear-gradient(135deg, #1a1a2e 0%, #4a1a6b 100%) !important;
  color: #ff9500 !important;
}
.dayCol.holiday-halloween .dayHead span {
  color:  #ff9500 !important;
}
/* ðŸ¦ƒ Thanksgiving Theme */
.dayCol.holiday-thanksgiving {
  border: 3px solid #d97706;
  background: linear-gradient(180deg, #fff 0%, #fef3c7 100%);
}
.dayCol.holiday-thanksgiving .dayHead {
  background: linear-gradient(135deg, #92400e 0%, #b45309 100%) !important;
}
/* ðŸ’– Valentine's Day Theme */
.dayCol.holiday-valentines {
  border: 3px solid #ec4899;
  background: linear-gradient(180deg, #fff 0%, #fdf2f8 100%);
}
.dayCol.holiday-valentines .dayHead {
  background: linear-gradient(135deg, #be185d 0%, #ec4899 100%) !important;
}
/* ðŸ’š St. Patrick's Day Theme */
.dayCol.holiday-stpatricks {
  border: 3px solid #22c55e;
  background:  linear-gradient(180deg, #fff 0%, #f0fdf4 100%);
}
.dayCol.holiday-stpatricks .dayHead {
  background: linear-gradient(135deg, #166534 0%, #22c55e 100%) !important;
}
/* ðŸ£ Easter Theme */
.dayCol.holiday-easter {
  border: 3px solid #a78bfa;
  background: linear-gradient(180deg, #fff 0%, #faf5ff 100%);
}
.dayCol.holiday-easter .dayHead {
  background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%) !important;
}
/* â­ Default/Generic Holiday Theme */
.dayCol.holiday-default {
  border: 3px solid #8b5cf6;
}
.dayCol.holiday-default .dayHead {
  background: linear-gradient(135deg, #5b21b6 0%, #8b5cf6 100%) !important;
}
/* ============================================
   HOLIDAY MANAGEMENT MODAL
   ============================================ */
.holidayList {
  max-height: 300px;
  overflow-y:  auto;
  margin-top: 16px;
}
.holidayItem {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: var(--bg-tertiary);
  border-radius:  8px;
  margin-bottom: 8px;
  transition: background-color 0.2s;
}
.holidayItem:hover {
  background: var(--card-bg);
}
.holidayInfo {
  display: flex;
  align-items: center;
  gap: 12px;
}
.holidayEmoji {
  font-size:  1.5rem;
}
.holidayDate {
  font-size: 0.85rem;
  color: var(--text-secondary);
  transition: color 0.2s;
}
.holidayName {
  font-weight: 600;
  color: var(--text-primary);
  transition: color 0.2s;
}
.deleteHolidayBtn {
  background: #fee2e2;
  color:  #dc2626;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 0.85rem;
}
.deleteHolidayBtn:hover {
  background: #fecaca;
}
.addHolidayForm {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap:  12px;
  padding: 16px;
  background: var(--bg-tertiary);
  border-radius: 8px;
  margin-bottom: 16px;
  transition: background-color 0.2s;
}
.addHolidayForm label {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 4px;
  display: block;
  transition: color 0.2s;
}
.addHolidayForm input,
.addHolidayForm select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size:  0.9rem;
  background: var(--input-bg);
  color: var(--text-primary);
  transition: all 0.2s;
}
.addHolidayForm .fullWidth {
  grid-column:  1 / -1;
}
.addHolidayBtn {
  grid-column: 1 / -1;
  background: #b37e78;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px;
  cursor: pointer;
  font-weight: 600;
}
.addHolidayBtn:hover {
  background: #8f5f5a;
}
.shift.backup-shift {
  animation: pulse-red 2s ease-in-out infinite;
}
@keyframes pulse-red {
  0%, 100% {
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
  }
  50% {
    box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
  }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* ============================================
   COVERAGE SUMMARY BANNER
   ============================================ */
.coverage-banner {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 14px 20px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid #e2e8f0;
  border-radius: 16px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  overflow: visible;
  transition: all 0.3s ease;
}

.coverage-banner:hover {
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}

.coverage-banner-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  user-select: none;
}

.coverage-chevron {
  transition: transform 0.3s ease;
  color: var(--text-secondary);
  flex-shrink: 0;
}

.coverage-banner.expanded .coverage-chevron {
  transform: rotate(180deg);
}

.coverage-chips {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.coverage-details {
  margin-top: 8px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.coverage-details-row {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 12px;
  padding: 8px 0;
  font-size: 13px;
  border-bottom: 1px solid var(--border-color);
}

.coverage-details-row:last-child {
  border-bottom: none;
}

.coverage-details-label {
  font-weight: 700;
  color: var(--text-secondary);
}

.coverage-details-value {
  color: var(--text-primary);
}

@media (max-width: 768px) {
  .coverage-banner {
    padding: 10px 14px;
  }
  
  .coverage-chips {
    gap: 8px;
  }
  
  .coverage-details-row {
    grid-template-columns: 1fr;
    gap: 4px;
  }
}
.coverage-banner {
  scrollbar-width: none;
}
.coverage-banner::-webkit-scrollbar {
  display: none;
}
.coverage-banner-title::before {
  content: "ðŸ“Š";
  font-size:  16px;
}
.coverage-banner.critical-state {
  background: #fef2f2;
  border: 2px solid #ef4444;
  animation: intense-shake 0.8s ease-in-out; /* Shakes on load/update */
  box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25);
}
.coverage-banner.critical-state .coverage-banner-title {
  color: #b91c1c;
  border-right-color: #fca5a5;
}
.coverage-chip.gap-alert .status-dot {
  background: white;
  box-shadow: 0 0 4px rgba(255,255,255,0.8);
  animation: pulse-white 1.5s infinite;
}
@keyframes pulse-white {
  0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
  70% { box-shadow: 0 0 0 6px rgba(255, 255, 255, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
}
.coverage-chip.gap-alert {
  background: #dc2626; 
  color: white; 
  border: 1px solid #b91c1c;
  font-weight: 800;
  animation: none; /* The banner shakes, chips stay solid */
}
.coverage-banner-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 800;
  color: var(--coverage-title-color);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  padding-right: 16px;
  border-right: 2px solid var(--border-color);
  transition: color 0.2s, border-color 0.2s;
}
.coverage-chips {
  display: flex;
  gap: 10px;
  flex-wrap: nowrap;
  align-items: center;
}
.coverage-chip:hover {
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
.coverage-chip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border-radius: 10px;
  font-size:  13px;
  font-weight:  700;
  white-space: nowrap;
  transition: all 0.2s ease;
  cursor: default;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.coverage-chip.good {
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  color: #15803d;
  border: 1px solid #86efac;
}
.coverage-chip.warning {
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  color: #b45309;
  border: 1px solid #fcd34d;
}
.coverage-chip.critical {
  background: #fef2f2;
  color: #dc2626;
  border: 1px solid #fca5a5;
  animation: pulse-critical 2s ease-in-out infinite;
}
@keyframes pulse-critical {
  0%, 100% { box-shadow: 0 1px 3px rgba(220, 38, 38, 0.1); }
  50% { box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.15); }
}
@keyframes intense-shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
  20%, 40%, 60%, 80% { transform: translateX(4px); }
}
body.dark-mode img[alt="Company Logo"]{
  filter: brightness(1.05);
}
.coverage-chip .status-dot {
  width: 10px;
  height: 10px;
  border-radius:  50%;
  flex-shrink: 0;
}
.coverage-chip.good .status-dot { 
  background: linear-gradient(135deg, #22c55e, #16a34a);
  box-shadow: 0 0 6px rgba(34, 197, 94, 0.4);
}
.coverage-chip.warning .status-dot { 
  background: linear-gradient(135deg, #f59e0b, #d97706);
  box-shadow: 0 0 6px rgba(245, 158, 11, 0.4);
}
.coverage-chip.critical .status-dot { 
  background: linear-gradient(135deg, #ef4444, #dc2626);
  box-shadow: 0 0 6px rgba(239, 68, 68, 0.4);
}
.coverage-chip .channel-abbrev {
  font-weight: 800;
  font-size: 12px;
  letter-spacing: 0.3px;
}
.coverage-chip .coverage-count {
  font-weight: 600;
  opacity: 0.85;
  font-size: 13px;
}
/* Hidden state */
.coverage-banner.hidden {
  display: none;
}
/* All Good State */
.coverage-all-good {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #15803d;
  font-weight: 700;
  font-size: 14px;
  padding: 6px 14px;
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  border-radius: 10px;
  border: 1px solid #86efac;
}
.coverage-all-good::before {
  content: "âœ“";
  font-weight: 900;
  font-size: 16px;
}
.coverage-all-good svg {
  width: 16px;
  height: 16px;
  fill: currentColor;
}

.coverageEmptyHint{
  font-size:12px;
  color: var(--text-secondary);
  padding: 8px 2px;
  font-style: italic;
}

.covLeft{display:flex; flex-direction:column; gap:6px;}
.covChan{font-weight:900; font-size:12px;}
.covChanSub{font-weight:700; opacity:0.7; margin-left:6px; font-size:11px;}
.covRight{font-size:11px; color:var(--text-secondary); font-weight:800; white-space:nowrap;}

.covBlocks{display:flex; flex-wrap:wrap; gap:6px;}
.covBlock{
  display:inline-flex;
  align-items:center;
  padding:3px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  border:1px solid var(--border-color);
  background: var(--bg-tertiary);
}
.covBlock.ok{
  border-color: rgba(34,197,94,0.35);
  background: rgba(34,197,94,0.12);
  color: #16a34a;
}
body.dark-mode .covBlock.ok{ color:#86efac; }

.covBlock.bad{
  border-color: rgba(239,68,68,0.35);
  background: rgba(239,68,68,0.12);
  color: #dc2626;
}
body.dark-mode .covBlock.bad{ color:#fca5a5; }

/* ============================================
   COVERAGE GAPS DASHBOARD - REDESIGNED
   Clean, focused design showing only gaps
   ============================================ */
#coverageDashboard {
  margin-bottom: 20px;
}

/* Main Container */
.cov-panel {
  background: var(--card-bg, #ffffff);
  border: 1px solid var(--border-color, #e2e8f0);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 2px 8px var(--shadow-sm, rgba(0,0,0,0.04));
}

/* Header - Always Visible */
.cov-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  cursor: pointer;
  transition: background 0.2s;
  user-select: none;
}
.cov-header:hover {
  background: var(--bg-secondary, #f8fafc);
}

.cov-header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.cov-icon {
  width: 42px;
  height: 42px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
  box-shadow: 0 2px 8px rgba(15, 118, 110, 0.25);
}
.cov-icon svg {
  width: 20px;
  height: 20px;
  color: white;
}

.cov-title-wrap {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.cov-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary, #1e293b);
  margin: 0;
}
.cov-subtitle {
  font-size: 12px;
  color: var(--text-secondary, #64748b);
}

.cov-header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* Status Badge */
.cov-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  transition: all 0.2s;
}
.cov-badge .dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
}
.cov-badge.ok {
  background: rgba(34, 197, 94, 0.12);
  color: #15803d;
  border: 1px solid rgba(34, 197, 94, 0.25);
}
.cov-badge.ok .dot {
  background: #22c55e;
}
.cov-badge.warn {
  background: rgba(245, 158, 11, 0.12);
  color: #b45309;
  border: 1px solid rgba(245, 158, 11, 0.25);
}
.cov-badge.warn .dot {
  background: #f59e0b;
}
.cov-badge.alert {
  background: rgba(239, 68, 68, 0.12);
  color: #b91c1c;
  border: 1px solid rgba(239, 68, 68, 0.3);
}
.cov-badge.alert .dot {
  background: #ef4444;
  animation: cov-pulse 1.5s ease-in-out infinite;
}
@keyframes cov-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* Chevron */
.cov-chevron {
  width: 18px;
  height: 18px;
  color: var(--text-tertiary, #94a3b8);
  transition: transform 0.25s ease;
}
.cov-panel.expanded .cov-chevron {
  transform: rotate(180deg);
}

/* Body - Collapsible */
.cov-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
.cov-panel.expanded .cov-body {
  max-height: 800px;
}

.cov-content {
  padding: 0 20px 20px 20px;
}

/* Stats Row */
.cov-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}
.cov-stat {
  background: var(--bg-secondary, #f8fafc);
  border: 1px solid var(--border-color, #e2e8f0);
  border-radius: 10px;
  padding: 14px;
  text-align: center;
}
.cov-stat-num {
  font-size: 26px;
  font-weight: 800;
  color: var(--text-primary, #1e293b);
  line-height: 1;
}
.cov-stat-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--text-secondary, #64748b);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 4px;
}
.cov-stat.gap-stat {
  border-color: rgba(239, 68, 68, 0.3);
  background: rgba(239, 68, 68, 0.06);
}
.cov-stat.gap-stat .cov-stat-num {
  color: #dc2626;
}

/* Gaps List */
.cov-gaps-section {
  border: 1px solid var(--border-color, #e2e8f0);
  border-radius: 12px;
  overflow: hidden;
  background: var(--bg-secondary, #f8fafc);
}

.cov-gaps-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--card-bg, #ffffff);
  border-bottom: 1px solid var(--border-color, #e2e8f0);
}
.cov-gaps-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-primary, #1e293b);
}
.cov-gaps-hint {
  font-size: 11px;
  color: var(--text-tertiary, #94a3b8);
}

.cov-gaps-list {
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 400px;
  overflow-y: auto;
}

/* Individual Gap Card */
.cov-gap-card {
  background: var(--card-bg, #ffffff);
  border: 1px solid var(--border-color, #e2e8f0);
  border-radius: 10px;
  overflow: hidden;
}

.cov-gap-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border-color, #e2e8f0);
  background: var(--bg-secondary, #f8fafc);
}

.cov-gap-team {
  display: flex;
  align-items: center;
  gap: 10px;
}
.cov-gap-badge {
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 10px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.cov-gap-name {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-primary, #1e293b);
}

.cov-gap-info {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: #dc2626;
  font-weight: 600;
}

/* Time Blocks with Gaps */
.cov-gap-times {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border-color, #e2e8f0);
}
.cov-time-pill {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 5px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  background: rgba(239, 68, 68, 0.08);
  color: #dc2626;
  border: 1px solid rgba(239, 68, 68, 0.2);
}
.cov-time-pill .cov-time-count {
  opacity: 0.75;
  font-weight: 600;
}

/* Shifts in Gap */
.cov-gap-shifts {
  padding: 10px 14px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 8px;
}

.cov-shift-btn {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 10px 12px;
  background: var(--bg-secondary, #f8fafc);
  border: 1px solid var(--border-color, #e2e8f0);
  border-radius: 8px;
  cursor: pointer;
  text-align: left;
  transition: all 0.15s ease;
}
.cov-shift-btn:hover {
  background: var(--card-bg, #ffffff);
  border-color: #b37e78;
  box-shadow: 0 2px 8px rgba(15, 118, 110, 0.12);
}
.cov-shift-time {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-secondary, #64748b);
}
.cov-shift-person {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-primary, #1e293b);
}

/* All Good State */
.cov-all-good {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px 20px;
  text-align: center;
}
.cov-all-good-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.08) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
}
.cov-all-good-icon svg {
  width: 24px;
  height: 24px;
  color: #22c55e;
}
.cov-all-good-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary, #1e293b);
  margin-bottom: 4px;
}
.cov-all-good-desc {
  font-size: 12px;
  color: var(--text-secondary, #64748b);
}

/* Empty State */
.cov-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px 20px;
  text-align: center;
}
.cov-empty-icon {
  font-size: 36px;
  margin-bottom: 12px;
  opacity: 0.5;
}
.cov-empty-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text-primary, #1e293b);
  margin-bottom: 4px;
}
.cov-empty-desc {
  font-size: 12px;
  color: var(--text-secondary, #64748b);
}

/* Dark Mode */
body.dark-mode .cov-panel {
  background: var(--card-bg);
  border-color: var(--border-color);
}
body.dark-mode .cov-header:hover {
  background: var(--bg-tertiary);
}
body.dark-mode .cov-title {
  color: var(--text-primary);
}
body.dark-mode .cov-subtitle {
  color: var(--text-secondary);
}
body.dark-mode .cov-badge.ok {
  background: rgba(34, 197, 94, 0.15);
  color: #86efac;
  border-color: rgba(34, 197, 94, 0.3);
}
body.dark-mode .cov-badge.warn {
  background: rgba(245, 158, 11, 0.15);
  color: #fcd34d;
  border-color: rgba(245, 158, 11, 0.3);
}
body.dark-mode .cov-badge.alert {
  background: rgba(239, 68, 68, 0.18);
  color: #fca5a5;
  border-color: rgba(239, 68, 68, 0.35);
}
body.dark-mode .cov-stat {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
}
body.dark-mode .cov-stat-num {
  color: var(--text-primary);
}
body.dark-mode .cov-stat.gap-stat {
  background: rgba(239, 68, 68, 0.1);
  border-color: rgba(239, 68, 68, 0.3);
}
body.dark-mode .cov-stat.gap-stat .cov-stat-num {
  color: #fca5a5;
}
body.dark-mode .cov-gaps-section {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
}
body.dark-mode .cov-gaps-header {
  background: var(--card-bg);
  border-color: var(--border-color);
}
body.dark-mode .cov-gaps-title {
  color: var(--text-primary);
}
body.dark-mode .cov-gap-card {
  background: var(--card-bg);
  border-color: var(--border-color);
}
body.dark-mode .cov-gap-head {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
}
body.dark-mode .cov-gap-name {
  color: var(--text-primary);
}
body.dark-mode .cov-gap-info {
  color: #fca5a5;
}
body.dark-mode .cov-time-pill {
  background: rgba(239, 68, 68, 0.12);
  color: #fca5a5;
  border-color: rgba(239, 68, 68, 0.25);
}
body.dark-mode .cov-gap-shifts {
  border-color: var(--border-color);
}
body.dark-mode .cov-shift-btn {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
}
body.dark-mode .cov-shift-btn:hover {
  background: var(--card-bg);
  border-color: #14b8a6;
}
body.dark-mode .cov-shift-time {
  color: var(--text-secondary);
}
body.dark-mode .cov-shift-person {
  color: var(--text-primary);
}
body.dark-mode .cov-all-good-icon {
  background: rgba(34, 197, 94, 0.18);
}
body.dark-mode .cov-all-good-icon svg {
  color: #86efac;
}
body.dark-mode .cov-all-good-title {
  color: var(--text-primary);
}
body.dark-mode .cov-all-good-desc {
  color: var(--text-secondary);
}
body.dark-mode .cov-empty-title {
  color: var(--text-primary);
}
body.dark-mode .cov-empty-desc {
  color: var(--text-secondary);
}

/* Responsive */
@media (max-width: 640px) {
  .cov-stats {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  .cov-stat {
    padding: 10px;
  }
  .cov-stat-num {
    font-size: 20px;
  }
  .cov-gap-shifts {
    grid-template-columns: 1fr;
  }
}

/* ============================================
   AGENT PTO DASHBOARD STYLES
   ============================================ */
.agent-pto-hero {
  display: flex;
  align-items: center;
  gap: 24px;
  padding: 24px;
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  border: 2px solid #86efac;
  border-radius: 16px;
  margin-bottom: 20px;
}
.pto-ring {
  position: relative;
  width: 100px;
  height: 100px;
  flex-shrink: 0;
}
.pto-ring svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}
.pto-ring-bg {
  fill: none;
  stroke: #e2e8f0;
  stroke-width: 8;
}
.pto-ring-fill {
  fill: none;
  stroke: #22c55e;
  stroke-width: 8;
  stroke-linecap: round;
  stroke-dasharray: 283;
  stroke-dashoffset: 70;
  transition: stroke-dashoffset 1s ease;
}
.pto-ring-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
.pto-value {
  font-size: 28px;
  font-weight: 900;
  color: #16a34a;
  line-height: 1;
}
.pto-label {
  font-size: 10px;
  font-weight: 600;
  color: #22c55e;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.pto-hero-info {
  flex: 1;
}
.pto-hero-title {
  font-size: 18px;
  font-weight: 800;
  color: #15803d;
  margin-bottom: 4px;
}
.pto-hero-subtitle {
  font-size: 13px;
  color: #22c55e;
}
.agent-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}
.agent-stat-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  transition: all 0.2s;
}
.agent-stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.agent-stat-icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.agent-stat-icon svg {
  width: 22px;
  height: 22px;
  color: white;
}
.agent-stat-info {
  flex: 1;
}
.agent-stat-value {
  font-size: 22px;
  font-weight: 800;
  color: #1e293b;
  line-height: 1;
}
.agent-stat-label {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  margin-top: 2px;
}

/* Profile Section Styles */
.profile-section {
  margin-bottom: 20px;
}
.profile-section:last-child {
  margin-bottom: 0;
}
.profile-section-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid #e2e8f0;
}
.profile-section-header[style*="cursor: pointer"]:hover {
  background: var(--bg-tertiary);
  margin: -8px -12px 12px -12px;
  padding: 8px 12px;
  border-radius: 8px;
  border-bottom: none;
}
.section-icon {
  font-size: 16px;
}
.section-title {
  font-size: 13px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.profile-section .agent-pto-hero {
  margin-bottom: 0;
}
.profile-section .agent-stats-grid {
  margin-bottom: 0;
}
.zendesk-stats .agent-stat-card {
  flex-direction: column;
}

/* Clickable ticket list styles */
.ticket-list-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  color: inherit;
}
.ticket-list-item:hover {
  background: var(--bg-tertiary);
  border-color: var(--accent-primary);
  transform: translateX(4px);
}
.ticket-list-item:last-child {
  margin-bottom: 0;
}
.ticket-id-badge {
  background: var(--accent-primary);
  color: white;
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 4px;
  flex-shrink: 0;
}
.ticket-subject {
  flex: 1;
  font-size: 12px;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.ticket-priority {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 4px;
  text-transform: uppercase;
  flex-shrink: 0;
}
.ticket-priority.high, .ticket-priority.urgent {
  background: rgba(239, 68, 68, 0.15);
  color: #dc2626;
}
.ticket-priority.normal {
  background: rgba(59, 130, 246, 0.15);
  color: #2563eb;
}
.ticket-priority.low {
  background: rgba(156, 163, 175, 0.15);
  color: #6b7280;
}
.ticket-arrow {
  color: var(--text-tertiary);
  font-size: 14px;
  flex-shrink: 0;
}
body.dark-mode .ticket-list-item {
  background: var(--bg-tertiary);
}
body.dark-mode .ticket-list-item:hover {
  background: var(--bg-secondary);
}
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

/* Shift Modal Hint */
.shift-modal-hint {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 14px 16px;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 1px solid #f59e0b;
  border-radius: 12px;
  margin-top: 12px;
}
.hint-icon {
  font-size: 16px;
  flex-shrink: 0;
}
.hint-text {
  font-size: 13px;
  color: #92400e;
  line-height: 1.4;
}
body.dark-mode .shift-modal-hint {
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.1) 100%);
  border-color: rgba(245, 158, 11, 0.4);
}
body.dark-mode .hint-text {
  color: #fbbf24;
}
body.dark-mode .profile-section-header {
  border-color: var(--border-color);
}
body.dark-mode .section-title {
  color: var(--text-secondary);
}

/* Sign Out Button */
.sign-out-btn {
  background: transparent;
  color: #dc2626;
  border: 1px solid #fecaca;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.sign-out-btn:hover {
  background: #fef2f2;
  border-color: #dc2626;
}
body.dark-mode .sign-out-btn {
  background: transparent;
  color: #f87171;
  border-color: rgba(248, 113, 113, 0.3);
}
body.dark-mode .sign-out-btn:hover {
  background: rgba(248, 113, 113, 0.1);
  border-color: #f87171;
}

.agent-info-card {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px;
}
.agent-info-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}
.agent-info-icon {
  font-size: 18px;
}
.agent-info-title {
  font-size: 14px;
  font-weight: 700;
  color: #334155;
}
.agent-info-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.agent-info-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: #64748b;
}
.info-bullet {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* Agent Quick Actions */
.agent-quick-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}
.agent-action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 16px;
  border: none;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
}
.agent-action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}
.agent-action-btn.secondary {
  background: #f1f5f9;
  color: #475569;
  box-shadow: none;
  border: 1px solid #e2e8f0;
}
.agent-action-btn.secondary:hover {
  background: #e2e8f0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.agent-action-btn .action-icon {
  font-size: 16px;
}
.agent-action-btn .action-text {
  white-space: nowrap;
}
body.dark-mode .agent-action-btn.secondary {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-color: var(--border-color);
}
body.dark-mode .agent-action-btn.secondary:hover {
  background: var(--bg-secondary);
}

/* Captain shift styling */
.shift.captain-shift {
  position: relative;
}
.shift.captain-shift::before {
  content: "ðŸ‘‘";
  position: absolute;
  top: -8px;
  right: -8px;
  font-size: 14px;
}
/* =========================
   Admin Tools (v2)
   ========================= */
.overlay-admin { z-index: 10000; }
.overlay-sub { z-index: 10050; }

.adminModal { width: 620px; max-width: calc(100vw - 24px); }
.adminHead {
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:14px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  background:
    radial-gradient(1200px 400px at 20% 0%, rgba(179,126,120,0.35), transparent 55%),
    linear-gradient(135deg, #3c1c1a 0%, #2a1412 55%, #1a0e0d 100%);
}
.adminHeadLeft{display:flex; align-items:center; gap:12px;}
.adminHeadIcon{
  width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center;
  background: rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.14); color:#fff; font-size:18px;
}
.adminTitle{color:#fff; font-weight:900;}
.adminSubtitle{font-size:12px; color: rgba(226,232,240,0.85); margin-top:2px;}

.iconClose{
  width:36px; height:36px; border-radius:10px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.08);
  color:#fff; cursor:pointer;
}
.iconClose:hover{background: rgba(255,255,255,0.14);}
.iconClose.light{border-color: rgba(255,255,255,0.28); background: rgba(255,255,255,0.14);}

.adminBody{padding:16px;}
.adminStrip{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:12px;
  border-radius:14px;
  background: linear-gradient(135deg, rgba(179,126,120,0.15), rgba(164,89,83,0.10));
  border: 1px solid rgba(179,126,120,0.25);
  margin-bottom:14px;
}
.adminStripLeft{display:flex; gap:10px; align-items:center;}
.adminStripIcon{
  width:40px; height:40px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(255,255,255,0.75);
}
body.dark-mode .adminStripIcon{
  background: rgba(60,28,26,0.9); border:1px solid rgba(179,126,120,0.25); color:#e2e8f0;
}
.adminStripTitle{font-weight:900;}
.adminStripDesc{font-size:12px; opacity:0.75;}
.adminStripActions{display:flex; gap:8px; align-items:center;}
.adminBtnSm{padding:8px 10px; font-size:12px;}

.adminGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;}
.adminCard{
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,0.25);
  background: rgba(255,255,255,0.92);
  cursor:pointer;
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}
body.dark-mode .adminCard{background: rgba(35,35,35,0.95); border-color: rgba(179,126,120,0.22);}
.adminCard:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(2,6,23,0.18);
  border-color: rgba(179,126,120,0.45);
}
.adminCardTop{display:flex; align-items:flex-start; gap:10px;}
.adminIcon{
  width:40px; height:40px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; flex:0 0 40px;
  border:1px solid rgba(148,163,184,0.22);
}
.adminIconAmber{background: rgba(251,191,36,0.16);}
.adminIconGreen{background: rgba(34,197,94,0.16);}
.adminIconBlue{background: rgba(59,130,246,0.16);}
.adminIconPurple{background: rgba(139,92,246,0.16);}
.adminIconOrange{background: rgba(249,115,22,0.16);}
.adminIconTeal{background: rgba(20,184,166,0.16);}
.adminIconSlate{background: rgba(148,163,184,0.14);}
.adminIconRed{background: rgba(239,68,68,0.16);}
.adminCardText{flex:1;}
.adminCardTitle{font-weight:900; font-size:13px;}
.adminCardDesc{font-size:12px; opacity:0.72; margin-top:2px;}
.adminChip{
  font-size:11px; font-weight:800;
  padding:3px 8px; border-radius:999px;
  border:1px solid rgba(148,163,184,0.25);
  opacity:0.9; white-space:nowrap;
}

/* Danger Zone */
.dangerCard{
  padding:12px; border-radius:14px;
  border:1px solid rgba(239,68,68,0.22);
  background: linear-gradient(135deg, rgba(239,68,68,0.10), rgba(251,113,133,0.08));
}
.dangerTop{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.dangerTitle{font-weight:900; color:#b91c1c;}
.dangerDesc{font-size:12px; opacity:0.75; margin-top:2px;}
body.dark-mode .dangerTitle{color:#fb7185;}
.dangerActions{display:flex; gap:8px; align-items:center;}
.dangerBtn{padding:8px 10px; font-size:12px;}
.dangerBtnPrimary{padding:8px 10px; font-size:12px;}

/* PTO Balance top row */
.balanceTopRow{display:flex; gap:10px; align-items:center; margin-bottom:10px;}
.bulkHint{font-size:12px; opacity:0.75; margin-bottom:12px;}

/* Bulk PTO modal */
.bulkModal{width:520px; max-width: calc(100vw - 24px);}
.bulkHead{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:14px 16px;
  border-bottom:none;
  background:
    radial-gradient(900px 320px at 20% 0%, rgba(179,126,120,0.38), transparent 55%),
    linear-gradient(135deg, #b37e78 0%, #8f5f5a 55%, #6b4743 100%);
}
.bulkHeadLeft{display:flex; align-items:center; gap:12px;}
.bulkHeadIcon{
  width:40px; height:40px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(255,255,255,0.14);
  border:1px solid rgba(255,255,255,0.22);
  color:#fff;
}
.bulkSubtitle{font-size:12px; color: rgba(255,255,255,0.9); margin-top:2px;}
.bulkBody{padding:16px;}
.bulkInfo{
  padding:12px; border-radius:14px;
  border:1px solid rgba(179,126,120,0.24);
  background: rgba(247,242,241,0.75);
  margin-bottom:12px;
}
body.dark-mode .bulkInfo{
  background: rgba(60,28,26,0.5);
  border-color: rgba(179,126,120,0.22);
  color:#e2e8f0;
}
.bulkInfoTitle{font-weight:900; margin-bottom:2px;}
.bulkInfoText{font-size:12px; opacity:0.8;}
.bulkForm{display:flex; flex-direction:column; gap:10px;}
.bulkRow{display:flex; flex-direction:column; gap:6px;}
.fieldLabel{
  font-size:11px; font-weight:800;
  letter-spacing:0.6px;
  text-transform:uppercase;
  opacity:0.75;
}
.fieldInput{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,0.28);
  background: rgba(255,255,255,0.92);
  outline:none;
}
body.dark-mode .fieldInput{
  background: rgba(35,35,35,0.9);
  border-color: rgba(179,126,120,0.22);
  color:#e2e8f0;
}
.fieldInput:focus{
  border-color: rgba(179,126,120,0.55);
  box-shadow: 0 0 0 4px rgba(179,126,120,0.12);
}
.bulkMeta{font-size:12px; opacity:0.75; padding-top:2px;}
.bulkActions{display:flex; justify-content:flex-end; gap:8px; padding-top:6px;}

:root{
  --accent-focus: var(--accent-primary); /* d8636b */
}

/* Load controls */
.load-btn:hover{
  border-color: var(--accent-focus) !important;
  color: var(--accent-focus) !important;
}

/* Selected shift + drag target (was teal) */
.shift.selected { outline: 2px solid var(--accent-focus) !important; }
.shift.dropTarget { border: 2px dashed var(--accent-focus) !important; background: color-mix(in srgb, var(--accent-selected) 20%, #fff 80%) !important; }
body.dark-mode .shift.dropTarget { background: color-mix(in srgb, var(--accent-selected) 18%, #000 82%) !important; }

/* Selected checkbox badge on shift (was teal) */
.shift.selected .selBox{
  background: var(--accent-focus) !important;
  border-color: var(--accent-focus) !important;
}

/* Dark-mode hover teal leftovers */
body.dark-mode #loadMoreControls button:hover,
body.dark-mode .shift-chip:hover,
body.dark-mode #masterSchedule button:hover{
  border-color: var(--accent-focus) !important;
  color: var(--accent-focus) !important;
}
body.dark-mode .shift-chip:hover{
  background: var(--bg-secondary) !important;
}
/* =========================================================
   GLOBAL COLOR REMODEL (FORCES YOUR PALETTE EVERYWHERE)
   Paste at the VERY BOTTOM of <style>
   ========================================================= */

/* 1) Canonical theme tokens */
:root{
  /* LIGHT MODE core */
  --bg-primary: #f7f2f1;
  --bg-secondary: #ffffff;
  --bg-tertiary: #fbf6f5;
  --border-color: #eadfdd;

  --text-primary: #1a0e0d;
  --text-secondary: #6f5a57;
  --text-tertiary: #a38b87;

  --header-bg: #b37e78;          /* header */
  --day-tab-bg: #b37e78;         /* calendar tabs */
  --day-tab-hover-bg: #c7928b;
    --seg-bg: #f7f2f1;
 --seg-btn-color: #6f5a57;
  --seg-btn-active-bg: #ecd0b0;  /* selected calendar tab */
  --seg-btn-active-color: #361c1a;

  --accent-primary: #d8636b;     /* request time off (CTA) */
  --accent-selected: #ecd0b0;

  /* â€œforce-accentâ€ tokens used for borders/outlines/hovers */
  --accent-focus: #b37e78;
  --accent-ring: rgba(179,126,120,0.35);

  /* Make sure â€œcontent panelsâ€ donâ€™t drift into teal/blue */
  --card-bg: #ffffff;
  --input-bg: #ffffff;
  --load-controls-bg: #fbf6f5;

  /* schedule/day surfaces */
  --shift-card-bg: #f7f2f1;
  --day-content-bg: #f7f2f1;
  --day-body-bg: #f7f2f1;

  /* neutral icon buttons */
  --icon-btn-bg: rgba(255,255,255,0.16);
  --icon-btn-color: #ffffff;
  --icon-btn-border: rgba(255,255,255,0.22);
}

body.dark-mode{
  /* DARK MODE core */
  --bg-primary: #1f1f1f;
  --bg-secondary: #242424;
  --bg-tertiary: #2b2b2b;
  --border-color: #3a3a3a;

  --text-primary: #f3f3f3;
  --text-secondary: #cfcfcf;
  --text-tertiary: #a9a9a9;

  --header-bg: #361c1a;          /* header */
  --day-tab-bg: #242424;         /* calendar tabs */
  --day-tab-hover-bg: #2d2d2d;
  --seg-btn-active-bg: #a45953;  /* selected calendar tab */
  --seg-btn-active-color: #ffffff;

  --accent-primary: #a45953;     /* request time off (CTA) */
  --accent-selected: #a45953;

  --accent-focus: #a45953;
  --accent-ring: rgba(164,89,83,0.35);

  --card-bg: #242424;
  --input-bg: #1f1f1f;
  --load-controls-bg: #242424;

  /* schedule/day surfaces */
  --shift-card-bg: #242424;
  --day-content-bg: #242424;
  --day-body-bg: #1f1f1f;

  --icon-btn-bg: rgba(255,255,255,0.10);
  --icon-btn-color: #f3f3f3;
  --icon-btn-border: rgba(255,255,255,0.18);
}

/* 2) Hard overrides for anything still â€œteal/blueâ€ */

/* Header + title */
.header{ background: var(--header-bg) !important; border-bottom-color: var(--border-color) !important; }
.hTitle{ color:#fff !important; }

/* Agent-mode header was teal â€” force to your palette */
body.agent-mode .header{
  background: var(--header-bg) !important;
}

/* Profile pill - darker to stand out */
.pill.profile-pill{
  background: linear-gradient(135deg, #8f5f5a 0%, #6b4743 100%) !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.25) !important;
  border: 1px solid rgba(0,0,0,0.15) !important;
}
.pill.profile-pill:hover{
  box-shadow: 0 6px 18px rgba(0,0,0,0.3) !important;
  transform: translateY(-1px);
}
body.dark-mode .pill.profile-pill{
  background: linear-gradient(135deg, #a45953 0%, #7d3f3a 100%) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
  border: 1px solid rgba(255,255,255,0.1) !important;
}

/* Selection outline + drop target (was teal #b37e78) */
.shift.selected{ outline: 2px solid var(--accent-focus) !important; }
.shift.dropTarget{ border: 2px dashed var(--accent-focus) !important; background: color-mix(in srgb, var(--accent-selected) 25%, transparent) !important; }
.shift.selected .selBox{ background: var(--accent-focus) !important; border-color: var(--accent-focus) !important; color: #fff !important; }

/* Load controls + buttons: remove teal hover borders */
#loadMoreControls{ background: var(--load-controls-bg) !important; border-color: var(--border-color) !important; }
#loadMoreControls button:hover{
  border-color: var(--accent-focus) !important;
  color: var(--accent-focus) !important;
}
body.dark-mode #loadMoreControls button:hover{
  border-color: var(--accent-focus) !important;
  color: var(--accent-focus) !important;
}

/* Segmented control: selected tab color */
.seg{ background: var(--seg-bg) !important; }
.segBtn.active{
  background: var(--seg-btn-active-bg) !important;
  color: var(--seg-btn-active-color) !important;
  border-color: color-mix(in srgb, var(--seg-btn-active-bg) 65%, #000 35%) !important;
}

/* Calendar/day tabs (broad net; covers different tab implementations) */
.dayTab, .dayBtn, .dayPill, #dayTabs button, .calTab, .calendarTab{
  background: var(--day-tab-bg) !important;
  border-color: color-mix(in srgb, var(--day-tab-bg) 75%, #000 25%) !important;
  color: #fff !important;
}
.dayTab:hover, .dayBtn:hover, .dayPill:hover, #dayTabs button:hover, .calTab:hover, .calendarTab:hover{
  background: var(--day-tab-hover-bg) !important;
}
.dayTab.active, .dayBtn.active, .dayPill.active, #dayTabs button.active, .calTab.active, .calendarTab.active,
.dayTab.selected, .dayBtn.selected, .dayPill.selected, #dayTabs button.selected, .calTab.selected, .calendarTab.selected{
  background: var(--accent-selected) !important;
  color: var(--text-primary) !important;
  border-color: color-mix(in srgb, var(--accent-selected) 70%, #000 30%) !important;
}

/* Main schedule surfaces (removes any remaining blue-ish panels) */
.dayBody, .dayCol, .dayContent, .dayWrap, .scheduleBody, .schedulePanel{
  background: var(--day-body-bg) !important;
}
.dayHead, .dayHeader, .dayTitleBar{
  background: color-mix(in srgb, var(--header-bg) 55%, #000 45%) !important;
  color: #f7f2f1 !important;
  border-color: var(--border-color) !important;
}

/* Shift cards */
.shiftCard, .shift, .shiftBox, .shift-chip{
  background: var(--shift-card-bg) !important;
  border-color: var(--border-color) !important;
  color: var(--text-primary) !important;
}

/* Modals: force the same palette everywhere */
.overlay{ background: rgba(26,14,13,0.40) !important; }
body.dark-mode .overlay{ background: rgba(0,0,0,0.72) !important; }

/* =============================================================
   UNIFIED MODAL DESIGN SYSTEM
   Professional, consistent modal styling across all views
   ============================================================= */

/* Base Modal Styles */
.modal {
  background: var(--card-bg) !important;
  border: 1px solid var(--border-color) !important;
  border-radius: 20px !important;
  box-shadow: 0 25px 60px -15px rgba(0,0,0,0.3), 0 10px 25px -10px rgba(0,0,0,0.15) !important;
  color: var(--text-primary) !important;
  overflow: hidden;
}

/* Unified Modal Header - Gradient with brand colors */
.mHead, .mHeader, .modal-header {
  background: linear-gradient(135deg, var(--modal-gradient-start) 0%, var(--modal-gradient-end) 100%) !important;
  color: #fff !important;
  padding: 20px 24px !important;
  border-bottom: none !important;
  position: relative;
}
.mHead::after, .mHeader::after, .modal-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
}
.mTitle, .modal-title {
  font-weight: 700 !important;
  font-size: 17px !important;
  color: #fff !important;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
}
.mHead .btn, .mHeader .btn, .modal-header .btn {
  background: rgba(255,255,255,0.15) !important;
  border: 1px solid rgba(255,255,255,0.25) !important;
  color: #fff !important;
  backdrop-filter: blur(4px);
  transition: all 0.2s ease !important;
}
.mHead .btn:hover, .mHeader .btn:hover, .modal-header .btn:hover {
  background: rgba(255,255,255,0.25) !important;
  transform: scale(1.05);
}

/* Unified Modal Body */
.mBody, .modal-body {
  background: var(--bg-secondary) !important;
  color: var(--text-primary) !important;
  padding: 24px !important;
}

/* Unified Modal Footer */
.mFoot, .modal-footer {
  background: var(--bg-tertiary) !important;
  border-top: 1px solid var(--border-color) !important;
  padding: 16px 24px !important;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

/* Unified Form Elements in Modals */
.modal input, .modal select, .modal textarea {
  background: var(--input-bg) !important;
  border: 2px solid var(--border-color) !important;
  border-radius: 10px !important;
  color: var(--text-primary) !important;
  padding: 12px 14px !important;
  font-size: 14px !important;
  transition: all 0.2s ease !important;
}
.modal input:focus, .modal select:focus, .modal textarea:focus {
  border-color: var(--accent-primary) !important;
  box-shadow: 0 0 0 3px var(--accent-ring) !important;
  outline: none !important;
}
.modal label {
  font-size: 12px !important;
  font-weight: 600 !important;
  color: var(--text-secondary) !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
  margin-bottom: 8px !important;
  display: block;
}

/* Unified Action Buttons */
.modal-action-btn {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 20px;
  background: var(--card-bg);
  border: 2px solid var(--border-color);
  border-radius: 14px;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  text-align: left;
  width: 100%;
}
.modal-action-btn:hover {
  border-color: var(--accent-primary);
  background: var(--bg-tertiary);
  transform: translateX(4px);
  box-shadow: 0 4px 12px var(--modal-btn-shadow);
}
.modal-action-icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}
.modal-action-icon.swap { background: linear-gradient(135deg, var(--modal-gradient-start), var(--modal-gradient-end)); color: #fff; }
.modal-action-icon.timeoff { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; }
.modal-action-icon.info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #fff; }
.modal-action-icon.danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; }
.modal-action-content h4 {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}
.modal-action-content p {
  font-size: 13px;
  color: var(--text-secondary);
  margin: 0;
}

/* Unified Info Cards in Modals */
.modal-info-card {
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
  border: 2px solid var(--border-color);
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 20px;
}
.modal-info-card.highlight {
  background: linear-gradient(135deg, color-mix(in srgb, var(--accent-primary) 8%, var(--bg-secondary) 92%) 0%, var(--bg-secondary) 100%);
  border-color: var(--accent-primary);
}

/* Unified Detail Rows */
.modal-detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border-color);
}
.modal-detail-row:last-child { border-bottom: none; }
.modal-detail-label {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
}
.modal-detail-value {
  font-size: 13px;
  color: var(--text-primary);
  font-weight: 600;
}

/* Unified Button Styles */
.modal .btn-primary, .modal .btnPrimary {
  background: linear-gradient(135deg, var(--accent-primary) 0%, color-mix(in srgb, var(--accent-primary) 85%, #000 15%) 100%) !important;
  color: #fff !important;
  border: none !important;
  padding: 12px 24px !important;
  border-radius: 10px !important;
  font-weight: 600 !important;
  font-size: 14px !important;
  cursor: pointer;
  transition: all 0.2s ease !important;
  box-shadow: 0 4px 12px var(--modal-btn-shadow) !important;
}
.modal .btn-primary:hover, .modal .btnPrimary:hover {
  transform: translateY(-1px) !important;
  box-shadow: 0 6px 20px var(--modal-btn-hover-shadow) !important;
}
.modal .btn-secondary, .modal .btnSecondary, .modal .btn.ghost {
  background: var(--bg-tertiary) !important;
  color: var(--text-primary) !important;
  border: 2px solid var(--border-color) !important;
  padding: 10px 20px !important;
  border-radius: 10px !important;
  font-weight: 600 !important;
  font-size: 14px !important;
  cursor: pointer;
  transition: all 0.2s ease !important;
}
.modal .btn-secondary:hover, .modal .btnSecondary:hover, .modal .btn.ghost:hover {
  background: var(--bg-primary) !important;
  border-color: var(--text-secondary) !important;
}
.modal .btn-danger {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
  color: #fff !important;
  border: none !important;
}

/* Section Dividers in Modals */
.modal-section-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 20px 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--border-color);
}

/* Smooth Animations */
@keyframes modalSlideIn {
  from { opacity: 0; transform: translateY(-20px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.modal {
  animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

/* =============================================================
   END UNIFIED MODAL DESIGN SYSTEM
   ============================================================= */

/* Primary CTA buttons (Request Time Off) */
.btnPrimary, .btnRequestTimeOff, #btnRequestTimeOff, [data-action="requestTimeOff"]{
  background: var(--accent-primary) !important;
  border-color: var(--accent-primary) !important;
  color: #fff !important;
}
.btnPrimary:hover, .btnRequestTimeOff:hover, #btnRequestTimeOff:hover, [data-action="requestTimeOff"]:hover{
  filter: brightness(0.95);
  box-shadow: 0 8px 18px var(--accent-ring) !important;
}

/* â€œQuick actionsâ€ / panels that had blue+teal gradients */
#agentQuickActions{
  background: color-mix(in srgb, var(--accent-selected) 20%, var(--bg-secondary) 80%) !important;
  border-color: var(--accent-focus) !important;
}
/* =========================================================
   PATCH: remove remaining BLUE + fix time off + fix header icons
   Append UNDER your current remodel block
   ========================================================= */

/* A) Any remaining BLUE/teal gradients on schedule/day headers */
.day-content-header,
.dayContentHeader,
.dayTopBar,
.dayCardHeader,
.dayHeaderBar,
.viewDayHeader,
.viewDayTop,
#viewDayHeader,
#viewDayTop,
#viewDayTitle,
.dayHead,
.dayHeader,
.dayTitleBar{
  background: var(--day-header-bg) !important;
  border-color: var(--border-color) !important;
  color: #fff !important;
}
.day-content-header *,
.dayContentHeader *,
.dayTopBar *,
.dayCardHeader *,
.dayHeaderBar *,
.viewDayHeader *,
.viewDayTop *,
#viewDayHeader *,
#viewDayTop *,
#viewDayTitle *{
  color:#fff !important;
}

/* If the big inner schedule panel is still navy/blue */
.viewDay,
.viewDayPanel,
.viewDayCard,
.dayPanel{
  background: var(--day-content-bg) !important;
  border-color: var(--border-color) !important;
}

/* B) Request Time Off button (your screenshot shows it still teal) */
/* Catch common IDs/classes + inline styles */
#btnRequestTimeOff,
#requestTimeOffBtn,
#btnTimeOff,
.btnRequestTimeOff,
.requestTimeOffBtn,
button[data-action="requestTimeOff"],
button[onclick*="requestTimeOff"],
button[onclick*="openTimeOff"],
button[style*="background:#b37e78"],
button[style*="background: #b37e78"],
button[style*="background:#8f5f5a"],
button[style*="background: #8f5f5a"]{
  background: var(--accent-primary) !important;
  border-color: var(--accent-primary) !important;
  color: #fff !important;
}
#btnRequestTimeOff:hover,
#requestTimeOffBtn:hover,
#btnTimeOff:hover,
.btnRequestTimeOff:hover,
.requestTimeOffBtn:hover,
button[data-action="requestTimeOff"]:hover{
  filter: brightness(0.95);
  box-shadow: 0 10px 22px var(--accent-ring) !important;
}

/* C) Time Off modal: header + primary confirm button must match palette */
#timeoffModal .mHeader,
#timeOffModal .mHeader,
.timeoffModal .mHeader,
.modal[data-modal="timeoff"] .mHeader,
.modal[data-modal="timeOff"] .mHeader{
  background: var(--header-bg) !important;
  color: #fff !important;
}
#timeoffModal .btnPrimary,
#timeOffModal .btnPrimary,
.timeoffModal .btnPrimary,
.modal[data-modal="timeoff"] .btnPrimary,
.modal[data-modal="timeOff"] .btnPrimary{
  background: var(--accent-primary) !important;
  border-color: var(--accent-primary) !important;
  color:#fff !important;
}

/* SweetAlert confirm (if your time off flow uses Swal) */
.swal2-popup{
  background: var(--card-bg) !important;
  color: var(--text-primary) !important;
  border: 1px solid var(--border-color) !important;
}
.swal2-title{
  color: var(--text-primary) !important;
}
.swal2-confirm{
  background: var(--accent-primary) !important;
  border: 1px solid var(--accent-primary) !important;
  color:#fff !important;
}

/* D) Top-right header icon buttons - Clean minimal style */
.header .iconBtn,
.header .icon-btn,
.header button.icon,
.header .topIconBtn,
.header .iconButton,
#btnNotif, #btnTheme, #btnRefresh, #btnDarkMode, #btnLightMode, #btnAdmin, #drawerToggle{
  background: rgba(255, 255, 255, 0.12) !important;
  color: rgba(255, 255, 255, 0.9) !important;
  border: none !important;
  border-radius: 10px !important;
  width: 36px !important;
  height: 36px !important;
  transition: all 0.2s ease !important;
}
#btnNotif {
  position: relative;
  overflow: visible;
}
#notifCount {
  position: absolute;
  top: 5px;
  right: 5px;
  transform: translate(40%, -40%);

  width: 9px;
  height: 9px;
  border-radius: 50%;

  background: #ef4444;

  /* makes it blend nicely with your glassy header */
  box-shadow:
    0 0 0 2px rgba(255,255,255,0.7),
    0 2px 6px rgba(0,0,0,0.25);

  pointer-events: none;
}

/* Hidden state */
#notifCount.hidden {
  display: none;
}

.header .iconBtn:hover,
.header .icon-btn:hover,
.header button.icon:hover,
.header .topIconBtn:hover,
.header .iconButton:hover,
#btnNotif:hover, #btnTheme:hover, #btnRefresh:hover, #btnAdmin:hover, #drawerToggle:hover{
  background: rgba(255, 255, 255, 0.22) !important;
  transform: translateY(-1px);
}

/* Make SVG icons follow button color */
.header .iconBtn svg,
.header .icon-btn svg,
.header button.icon svg,
.header .topIconBtn svg,
.header .iconButton svg{
  fill: currentColor !important;
  width: 18px !important;
  height: 18px !important;
}

/* Dark mode icon buttons */
body.dark-mode .header .iconBtn,
body.dark-mode .header .icon-btn,
body.dark-mode .header button.icon,
body.dark-mode .header .topIconBtn,
body.dark-mode .header .iconButton,
body.dark-mode #btnNotif,
body.dark-mode #btnTheme,
body.dark-mode #btnRefresh,
body.dark-mode #btnAdmin,
body.dark-mode #drawerToggle{
  background: rgba(255,255,255,0.08) !important;
  color: rgba(255,255,255,0.85) !important;
}
body.dark-mode .header .iconBtn:hover,
body.dark-mode .header .icon-btn:hover{
  background: rgba(255,255,255,0.15) !important;
}

/* Dark mode: Time off CTA is a45953 */
body.dark-mode #btnRequestTimeOff,
body.dark-mode #requestTimeOffBtn,
body.dark-mode .btnRequestTimeOff,
body.dark-mode button[data-action="requestTimeOff"]{
  background: var(--accent-primary) !important; /* a45953 */
  border-color: var(--accent-primary) !important;
}
/* ===== FINAL THEME LOCK (removes remaining navy/blue) ===== */
/* The big day header strip */
.day-content-header{
  background: var(--day-header-bg) !important;
  border-bottom: 1px solid var(--border-color) !important;
}
/* The main body area behind the shifts */
.day-content-body{
  background: var(--day-body-bg) !important;
}
/* The card container itself */
.day-content{
  background: var(--day-content-bg) !important;
  border-color: var(--border-color) !important;
}
/* Kill any leftover hardcoded slate borders */
.day-content-header,
.channel-header,
.listHead{
  border-color: var(--border-color) !important;
}
/* Request Time Off button everywhere */
#btnRequestTimeOff,
.btnRequestTimeOff,
[data-action="requestTimeOff"]{
  background: var(--accent-primary) !important;
  border-color: var(--accent-primary) !important;
  color: #fff !important;
}

/* Request Time Off modal (force theme tokens) */
#futureTimeOffModal .modal,
#futureTimeOffModal > div,
#futureTimeOffModal .mBody{
  background: var(--card-bg) !important;
  border-color: var(--border-color) !important;
  color: var(--text-primary) !important;
}

#futureTimeOffModal input,
#futureTimeOffModal select,
#futureTimeOffModal textarea{
  background: var(--input-bg) !important;
  border-color: var(--border-color) !important;
  color: var(--text-primary) !important;
}
body.dark-mode .header .iconBtn{
  background: rgba(255,255,255,0.08) !important;
  border-color: rgba(255,255,255,0.16) !important;
  color: #f3f3f3 !important;
}
body.dark-mode .header .iconBtn:hover{
  border-color: var(--accent-primary) !important;
  color: var(--accent-primary) !important;
}


  
/* === FINAL DAY HEADER COLOR FIX === */
/* Light mode: #b37e78 (same as header) | Dark mode: #3c1c1a */
.day-content-header {
  background: var(--day-header-bg) !important;
}

/* === FINAL SHIFT CARD & CONTENT AREA FIXES === */
/* Shift cards should use warm cream in light mode */
.shift-card-b,
.shift,
.agentShiftItem {
  background: var(--shift-card-bg) !important;
}

/* The content area behind shifts */
.day-content,
.day-content-body {
  background: var(--day-body-bg) !important;
}

/* Agent toolbar in dark mode */
body.dark-mode .agent-toolbar,
body.dark-mode .agent-toolbar-item {
  background: #1a0e0d !important;
}

/* === ADMIN & BULK MODALS - CONSISTENT WARM THEME === */
/* Light mode admin head */
.adminHead {
  background:
    radial-gradient(1200px 400px at 20% 0%, rgba(179,126,120,0.25), transparent 55%),
    linear-gradient(135deg, #b37e78 0%, #8f5f5a 55%, #6b4743 100%) !important;
}
/* Dark mode admin head */
body.dark-mode .adminHead {
  background:
    radial-gradient(1200px 400px at 20% 0%, rgba(164,89,83,0.35), transparent 55%),
    linear-gradient(135deg, #3c1c1a 0%, #2a1412 55%, #1a0e0d 100%) !important;
}
/* Dark mode admin body */
body.dark-mode .adminBody,
body.dark-mode .adminModal .mBody {
  background: #1f1f1f !important;
}
/* Dark mode admin strip */
body.dark-mode .adminStrip {
  background: linear-gradient(135deg, rgba(164,89,83,0.15), rgba(60,28,26,0.25)) !important;
  border-color: rgba(164,89,83,0.25) !important;
}
/* Dark mode bulk head */
body.dark-mode .bulkHead {
  background:
    radial-gradient(900px 320px at 20% 0%, rgba(164,89,83,0.38), transparent 55%),
    linear-gradient(135deg, #a45953 0%, #7d3f3a 55%, #5a2a28 100%) !important;
}
/* Dark mode bulk body */
body.dark-mode .bulkBody,
body.dark-mode .bulkModal .mBody {
  background: #1f1f1f !important;
}

</style>
</head>
<!-- âœ… Body starts without auth-pending if early check found valid session -->
<body>
  <script>
    // Apply auth-pending class only if no valid session was found in early check
    if (!window._hasValidSession) {
      document.body.classList.add('auth-pending');
    }
  </script>
  <!-- AUTH OVERLAY - Blocks all interaction until signed in -->
  <div id="authOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    z-index: 99999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 24px;
  ">
<img
  src="https://i.imgur.com/ndsvLxn.png"
  alt="Company Logo"
  style="
    width:64px;
    height:64px;
    border-radius:16px;
    display:block;
    object-fit:contain;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  "
/>
    <div style="font-size: 24px; font-weight: 700; color: #0f172a;">Scheduling Manager</div>
    <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">Sign in to continue</div>
    <div id="authLoginContainer">
      <div id="g_id_onload"
           data-client_id="63798769550-6hfbo9bodtej1i6k00ch0i4n523v02v0.apps.googleusercontent.com"
           data-callback="handleSignIn"
           data-auto_prompt="false"></div>
      <div class="g_id_signin" data-type="standard" data-size="large"></div>
    </div>
    <div style="margin-top: 32px; font-size: 11px; color: #94a3b8;">Musely Support Team</div>
  </div>
  <!-- HEADER -->
  <div class="header">
    <div class="hLeft">
<img
  src="https://i.imgur.com/ndsvLxn.png"
  alt="Company Logo"
  style="
    width:32px;
    height:32px;
    border-radius:8px;
    display:block;
    object-fit:contain;
    margin-right:12px;
  "
/>
  
      <div class="hTitle">Musely Scheduler</div>
      
      <div class="metaGroup" style="margin-left: 16px;">
        <!-- Agent Profile Pill (agents only - shows PTO and opens profile modal) -->
        <div id="balancePill" class="pill profile-pill" style="display:none;" onclick="openBalanceModal()">
            <span id="balanceText">My Profile</span>
            <span class="profile-pill-badge" id="ptoBadge">0h</span>
        </div>
        <!-- Manager Sign Out Pill (managers only - simple sign out, no modal) -->
        <div id="managerSignOutPill" class="pill sign-out-pill" style="display:none;" onclick="handleLogout()">
            Sign Out
        </div>
        <div id="managerContextPill" class="pill" style="display:none; background:rgba(255,255,255,0.12); color:rgba(255,255,255,0.9); border:none; font-size:11px; font-weight:600; border-radius:20px;">Loading...</div>
      </div>
    </div>
    <div class="hRight">
      <div class="seg">
        <button class="segBtn active" id="btnSchedule" onclick="setView('schedule')">Schedule</button>
        <button class="segBtn" id="btnGoals" onclick="setView('goals')" style="display:none;">Goals</button>
        <button class="segBtn" id="btnMetrics" onclick="setView('metrics')">Metrics</button>
      </div>
<div class="header-divider"></div>
      <!-- Agent Notifications Button (visible for agents) -->
      <button id="btnAgentNotif" class="iconBtn" type="button" title="My Notifications" onclick="openAgentNotifications()" style="position:relative; display:none;">
        <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
        <span id="agentNotifBadge" style="position:absolute; top:-4px; right:-4px; background:#ef4444; color:white; font-size:10px; font-weight:700; min-width:18px; height:18px; border-radius:9px; display:none; align-items:center; justify-content:center;">0</span>
      </button>
      <button id="btnNotif" class="iconBtn" type="button" title="Notifications">
  <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
  <span id="notifCount" class="hidden">0</span>
</button>

<button id="btnAgentToggle" class="btn ghost" style="display:none; font-size:12px; border:1px solid #cbd5e1; margin-right:10px;" onclick="toggleAgentView()">Show Team</button>
      <button id="btnAdmin" type="button" class="iconBtn" title="Admin Settings" onclick="openAdminModal()">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      </button>
      <button id="btnDarkMode" type="button" class="iconBtn" title="Toggle Dark Mode" onclick="toggleDarkMode()">
        <svg id="darkModeIcon" viewBox="0 0 24 24">
          <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
      </button>
<button type="button" class="iconBtn" title="Refresh schedule data" onclick="forceRefresh()">
        <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
      </button>
      <!-- View Toggle (Grid/List) -->
      <button type="button" class="iconBtn" id="btnViewToggle" title="Toggle Grid/List View" onclick="toggleShiftView()">
        <svg id="viewToggleIcon" viewBox="0 0 24 24"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z" fill="currentColor"/></svg>
      </button>
      <!-- Timezone Selector -->
      <div style="position: relative; display: inline-block;">
        <button type="button" class="iconBtn" id="btnTimezone" title="Timezone Settings" onclick="toggleTimezoneDropdown()">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="currentColor"/></svg>
        </button>
        <div id="timezoneDropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; min-width: 200px; z-index: 1000;">
          <div style="font-size: 11px; color: var(--text-secondary); padding: 4px 8px; font-weight: 600; border-bottom: 1px solid var(--border-color); margin-bottom: 6px;">Display Times In:</div>
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 13px;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
            <input type="radio" name="timezone" value="PST" checked onchange="setUserTimezone('PST')"> 
            <span>ðŸŒ´ Pacific (PST)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 13px;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
            <input type="radio" name="timezone" value="MST" onchange="setUserTimezone('MST')"> 
            <span>ðŸ”ï¸ Mountain (MST)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 13px;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
            <input type="radio" name="timezone" value="CST" onchange="setUserTimezone('CST')"> 
            <span>ðŸŒ½ Central (CST)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 13px;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
            <input type="radio" name="timezone" value="EST" onchange="setUserTimezone('EST')"> 
            <span>ðŸ™ï¸ Eastern (EST)</span>
          </label>
          <div style="border-top: 1px solid var(--border-color); margin-top: 6px; padding-top: 8px; font-size: 10px; color: var(--text-secondary); text-align: center;">
            â„¹ï¸ PST always shown in parentheses
          </div>
        </div>
      </div>
      <!-- Google Calendar Export -->
      <button type="button" class="iconBtn" id="btnExportCal" title="Export to Google Calendar" onclick="exportToGoogleCalendar()">
        <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-2 5h-5v5h5v-5z" fill="currentColor"/></svg>
      </button>
      <button class="iconBtn" id="drawerToggle" title="Tools" onclick="toggleDrawer()">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5v-6h14v6zm0-8H5V5h14v6z"/></svg>
      </button>
      
      <button id="btnMasterMode" class="action-btn" onclick="toggleMasterMode()">Edit Master Schedule</button>
    </div>
  </div>
  <!-- NAV (below header like your UI) -->
  <div class="navGroup">
    <button class="navBtn" onclick="changeDay(-1)">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <div style="position:relative; overflow:hidden; width:32px; height:32px;">
      <input type="date" id="navDatePicker" style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0; cursor:pointer;" onchange="handleDateJump(this.value)">
      <button class="navBtn" style="pointer-events:none;">
          <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5z"/></svg>
      </button>
    </div>
    <button class="navBtn" onclick="changeDay(1)">
        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
    </button>
</div>
<div id="loadMoreControls" class="load-controls">
  <button id="btnLoadPast" class="load-btn" onclick="loadPastSchedule()">
    â† Load History
  </button>
  <span id="loadedRangeLabel" class="load-label">
    Today â†’ 14 days
  </span>
  <button id="btnLoadFuture" class="load-btn" onclick="loadExtendedFuture()">
    Load Future â†’
  </button>
</div>

<!-- AGENT COMPACT SUMMARY BAR -->
<div id="agentCompactBar">
  <div class="compact-summary">
    <div class="summary-card now">
      <div class="summary-icon">ðŸŸ¢</div>
      <div class="summary-content">
        <div class="summary-label">CURRENT STATUS</div>
        <div class="summary-value" id="summaryNowValue">Off Shift</div>
        <div class="summary-sub" id="summaryNowTeam"></div>
      </div>
    </div>
    <div class="summary-card next">
      <div class="summary-icon">â°</div>
      <div class="summary-content">
        <div class="summary-label">NEXT SHIFT</div>
        <div class="summary-value" id="summaryNextValue">--</div>
        <div class="summary-sub" id="summaryNextDate"></div>
      </div>
    </div>
    <div class="summary-card role" id="summaryRoleCard" style="display:none;">
      <div class="summary-icon">ðŸŽ¯</div>
      <div class="summary-content">
        <div class="summary-label">YOUR ROLE</div>
        <div class="summary-value" id="summaryRoleValue">--</div>
        <div class="summary-sub" id="summaryRoleDate"></div>
      </div>
    </div>
    <!-- Meeting Coverage Card (shows when agent has a meeting role) -->
    <div class="summary-card meeting" id="summaryMeetingCard" style="display:none;">
      <div class="summary-icon" id="summaryMeetingIcon">ðŸ“…</div>
      <div class="summary-content">
        <div class="summary-label">MEETING ROLE</div>
        <div class="summary-value" id="summaryMeetingRole">--</div>
        <div class="summary-sub" id="summaryMeetingDate"></div>
      </div>
    </div>
    <!-- Open Shifts Alert (shows when open shifts available) -->
    <div class="summary-card openshift" id="summaryOpenShiftsCard" style="display:none; cursor: pointer;" onclick="showOpenShiftsPanel()">
      <div class="summary-icon">ðŸ””</div>
      <div class="summary-content">
        <div class="summary-label">OPEN SHIFTS</div>
        <div class="summary-value" id="summaryOpenShiftsCount">0 Available</div>
        <div class="summary-sub" style="color: #dc2626; font-weight: 600;">Click to view</div>
      </div>
    </div>
  </div>
  <div class="compact-actions">
    <div class="compact-tz-wrapper">
      <label class="compact-tz-label">Display Times In:</label>
      <select id="compactTzSelect" class="compact-tz-select" onchange="setUserTimezone(this.value)">
        <option value="PST">Pacific (PST)</option>
        <option value="MST">Mountain (MST)</option>
        <option value="CST">Central (CST)</option>
        <option value="EST">Eastern (EST)</option>
      </select>
    </div>
    <button class="compact-btn secondary" onclick="toggleAgentGoalsPanel()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-color: #f59e0b;">ðŸŽ¯ My Goals</button>
    <button class="compact-btn secondary" onclick="agentLoadMoreSchedule()">ðŸ“† Load 30 Days</button>
    <button class="compact-btn secondary" onclick="openSwapShiftModal()">ðŸ”„ Swap Shift</button>
    <button class="compact-btn primary" onclick="openFutureTimeOffModal()">ðŸ–ï¸ Request Time Off</button>
  </div>
</div>

<!-- Agent Quick Actions (hidden, replaced by compact bar) -->
<div id="agentQuickActions" class="agent-toolbar">
  <!-- Schedule Range Info -->
  <div class="agent-toolbar-item range-info">
    <span class="toolbar-icon">ðŸ“…</span>
    <div class="toolbar-text">
      <div class="toolbar-label">Viewing</div>
      <div class="toolbar-value" id="agentRangeLabel">Today â†’ 14 days</div>
    </div>
  </div>
  
  <!-- Load More Button for Agents -->
  <button id="btnAgentLoadMore" class="agent-toolbar-btn secondary" onclick="agentLoadMoreSchedule()">
    ðŸ“† Load 30 Days
  </button>
  
  <!-- Future Time Off Request -->
  <button class="agent-toolbar-btn primary" onclick="openFutureTimeOffModal()">
    ðŸ–ï¸ Request Time Off
  </button>
</div>
<!-- Agent Schedule Banner (Current + Next Shift) -->
<div id="agentScheduleBanner" class="agent-schedule-banner" style="display:none;">
  <div class="agent-schedule-card current">
    <div class="agent-schedule-card-head">
      <span class="agent-schedule-label">Current Shift</span>
      <span class="agent-schedule-pill off" id="agentCurrentShiftStatus">Off</span>
    </div>
    <div class="agent-schedule-time" id="agentCurrentShiftTime">--</div>
    <div class="agent-schedule-meta">
      <span class="agent-schedule-team" id="agentCurrentShiftTeam">--</span>
      <span id="agentCurrentShiftRole"></span>
    </div>
    <div class="agent-schedule-progress" id="agentCurrentShiftProgressWrap">
      <div class="agent-schedule-progress-bar" id="agentCurrentShiftProgress"></div>
    </div>
  </div>
  <div class="agent-schedule-card next">
    <div class="agent-schedule-card-head">
      <span class="agent-schedule-label">Next Shift</span>
      <span class="agent-schedule-pill" id="agentNextShiftStatus">Upcoming</span>
    </div>
    <div class="agent-schedule-time" id="agentNextShiftTime">--</div>
    <div class="agent-schedule-meta">
      <span class="agent-schedule-team" id="agentNextShiftTeam">--</span>
      <span id="agentNextShiftRole"></span>
    </div>
    <div class="agent-schedule-date" id="agentNextShiftDate"></div>
  </div>
</div>

<!-- Agent Assignments Banner (NEW - Shows Meeting Role & Weekly Assignments) -->
<div id="agentAssignmentsBanner" style="display:none; padding: 0 24px; margin-bottom: 16px;">
  <div style="display: flex; gap: 12px; flex-wrap: wrap;">
    <!-- Meeting Role Card -->
    <div id="agentMeetingRoleCard" style="display: none; flex: 1; min-width: 280px; background: var(--bg-secondary); border-radius: 12px; padding: 14px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px var(--shadow-sm);">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
        <span id="agentMeetingRoleIcon" style="font-size: 20px;">ðŸ“…</span>
        <div>
          <div id="agentMeetingRoleLabel" style="font-size: 13px; font-weight: 700; color: var(--text-primary);">Meeting Role</div>
          <div id="agentMeetingRoleDate" style="font-size: 11px; color: var(--text-secondary);">Date</div>
        </div>
      </div>
      <div id="agentMeetingRoleDesc" style="font-size: 11px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; color: var(--text-secondary);"></div>
    </div>
    
    <!-- Weekly Assignments Card -->
    <div id="agentWeeklyAssignCard" style="display: none; flex: 1; min-width: 280px; background: var(--bg-secondary); border-radius: 12px; padding: 14px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px var(--shadow-sm);">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
        <span style="font-size: 20px;">ðŸŽ¯</span>
        <div>
          <div style="font-size: 13px; font-weight: 700; color: var(--text-primary);">Your Assignments</div>
          <div id="agentWeeklyAssignWeek" style="font-size: 11px; color: var(--text-secondary);">This Week</div>
        </div>
      </div>
      <div id="agentWeeklyAssignList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
    </div>
  </div>
</div>
  <!-- MAIN -->
  <div class="main">
    <div class="content">
      <!-- Redesigned Coverage Dashboard (Managers Only) -->
      <div id="coverageDashboard" style="display:none;">
        <div class="cov-panel" id="covPanel">
          <div class="cov-header" onclick="toggleCoverageDashboard()">
            <div class="cov-header-left">
              <div class="cov-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>
                </svg>
              </div>
              <div class="cov-title-wrap">
                <h3 class="cov-title">Coverage Today</h3>
                <span class="cov-subtitle" id="covSubtitle">Checking staffing levels...</span>
              </div>
            </div>
            <div class="cov-header-right">
              <span class="cov-badge ok" id="covBadge"><span class="dot"></span><span id="covBadgeText">All Good</span></span>
              <svg class="cov-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
          </div>
          <div class="cov-body">
            <div class="cov-content" id="covContent">
              <!-- Content rendered dynamically -->
            </div>
          </div>
        </div>
      </div>
      
      <div id="scheduleView" class="schedule-container">
  <div class="day-tabs" id="dayTabs"></div>
  <div class="day-content">
    <div class="day-content-header">
      <div>
        <h2 id="viewDayTitle" style="margin:0; font-size:20px; font-weight:800;"></h2>
        <div id="viewDayStats" style="font-size:12px; opacity:0.7; margin-top:4px;"></div>
      </div>
    </div>
    <div id="dayContentBody" class="day-content-body">
      <div id="loadingPlaceholder" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text-secondary);">
        <div class="schedule-loader">
          <div class="loader-spinner"></div>
          <div class="loader-text">Loading your schedule...</div>
          <div class="loader-subtext">Fetching shifts and assignments</div>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
.schedule-loader {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}
.loader-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--border-color);
  border-top-color: var(--accent-primary);
  border-radius: 50%;
  animation: spin 0.8s ease-in-out infinite;
}
.loader-text {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
}
.loader-subtext {
  font-size: 12px;
  color: var(--text-tertiary);
  animation: pulse-text 1.5s ease-in-out infinite;
}
@keyframes pulse-text {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.85; transform: scale(1.02); }
}
@keyframes pulse-open {
  0%, 100% { box-shadow: 0 2px 12px rgba(220, 38, 38, 0.3); }
  50% { box-shadow: 0 4px 20px rgba(220, 38, 38, 0.5); }
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
@keyframes pulse-bell {
  0%, 100% { transform: scale(1) rotate(0deg); }
  25% { transform: scale(1.2) rotate(-10deg); }
  50% { transform: scale(1.2) rotate(10deg); }
  75% { transform: scale(1.1) rotate(-5deg); }
}
@keyframes pulse-badge {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
/* Open Shift Card Styles */
.open-shift {
  position: relative;
}
.open-shift::before {
  content: "NEEDS COVERAGE";
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  background: #dc2626;
  color: white;
  font-size: 8px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 4px;
  z-index: 1;
}
body.dark-mode .open-shift {
  background: repeating-linear-gradient(45deg, #450a0a, #450a0a 10px, #7f1d1d 10px, #7f1d1d 20px) !important;
  border-color: #ef4444 !important;
}
</style>
<div id="masterView" style="display:none; height:100%; overflow-y:auto;"></div>

<!-- ============================================================ -->
<!-- GOALS & ATTENDANCE VIEW â€” MODERNIZED                        -->
<!-- Replaces original lines ~5663-5990 in index.html            -->
<!-- Implements: A1 Tab Shell, A2 Primitives, A3 Overview,       -->
<!--   B2 Goal Cards, C2 Task List, D2 QA+CSAT, D3 Badge,       -->
<!--   E1 Timeline, F1 Meeting Follow-up, F2 Performance Band    -->
<!-- ============================================================ -->

<div id="goalsView" style="display:none; height:100%; flex:1; min-height:0; overflow:hidden;">
  <div class="goals-container">

    <!-- Left Sidebar: Agent List -->
    <div class="goals-sidebar">
      <div class="goals-sidebar-header">
        <div class="goals-sidebar-title">Team Members</div>
        <input type="text" id="goalsAgentSearch" class="goals-search" placeholder="Search agent..." oninput="filterGoalsAgentList()">
      </div>
      <div id="goalsAgentList" class="goals-agent-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Right Panel: Goals Detail -->
    <div class="goals-main">
      <div id="goalsPlaceholder" class="goals-placeholder">
        <div style="font-size: 48px;">ðŸŽ¯</div>
        <div style="font-size: 16px; font-weight: 600; margin-top: 12px;">Select a Team Member</div>
        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">Choose a team member from the list to view and edit their goals, attendance, and performance tracking.</div>
      </div>

      <div id="goalsContent" class="goals-content" style="display:none;">

        <!-- â”€â”€ Agent Header (consistent across all tabs) â”€â”€ -->
        <div class="goals-agent-header">
          <div class="goals-agent-info">
            <div class="goals-agent-name" id="goalsAgentName">Agent Name</div>
            <div class="goals-agent-meta" id="goalsAgentMeta">Last updated: Never</div>
          </div>
          <div class="goals-agent-actions">
            <button class="btn primary" onclick="saveAgentGoals()">ðŸ’¾ Save Changes</button>
          </div>
        </div>

        <!-- â”€â”€ Tab Bar (with badge support) â”€â”€ -->
        <div class="goals-tabs">
          <button class="goals-tab active" data-tab="overview" onclick="switchGoalsTab('overview')">ðŸ“‹ Overview</button>
          <button class="goals-tab" data-tab="smart" onclick="switchGoalsTab('smart')">ðŸŽ¯ Goals</button>
          <button class="goals-tab" data-tab="tasks" onclick="switchGoalsTab('tasks')">ðŸ“Œ Tasks</button>
          <button class="goals-tab" data-tab="attendance" onclick="switchGoalsTab('attendance')">ðŸ“… Attendance</button>
          <button class="goals-tab" data-tab="metrics" onclick="switchGoalsTab('metrics')">ðŸ“Š Performance</button>
          <button class="goals-tab" data-tab="qa" onclick="switchGoalsTab('qa')">
            âœ… QA
            <span class="goals-tab-badge" id="qaTabBadge" style="display:none;">0</span>
          </button>
          <button class="goals-tab" data-tab="topics" onclick="switchGoalsTab('topics')">ðŸ’¬ Topics</button>
          <button class="goals-tab" data-tab="notes" onclick="switchGoalsTab('notes')">ðŸ“ 1:1 Notes</button>
        </div>

        <!-- â”€â”€ Tab Content Area â”€â”€ -->
        <div class="goals-tab-content">

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- OVERVIEW TAB (A3 â€” read-only summary v1)   -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="tabOverview" class="goals-tab-pane active">
            <div class="overview-grid" id="overviewGrid">
              <!-- Goals summary card -->
              <div class="overview-card">
                <div class="overview-card-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">ðŸŽ¯</div>
                <div class="overview-card-body">
                  <div class="overview-card-label">Active Goals</div>
                  <div class="overview-card-value" id="ovGoalsActive">0</div>
                  <div class="overview-card-sub" id="ovGoalsDue">No goals due soon</div>
                </div>
              </div>
              <!-- Tasks summary card -->
              <div class="overview-card">
                <div class="overview-card-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">ðŸ“Œ</div>
                <div class="overview-card-body">
                  <div class="overview-card-label">Tasks</div>
                  <div class="overview-card-value" id="ovTasksOpen">0</div>
                  <div class="overview-card-sub" id="ovTasksOverdue">0 overdue</div>
                </div>
              </div>
              <!-- QA summary card -->
              <div class="overview-card">
                <div class="overview-card-icon" style="background: linear-gradient(135deg, #10b981, #059669);">âœ…</div>
                <div class="overview-card-body">
                  <div class="overview-card-label">QA Reviews</div>
                  <div class="overview-card-value" id="ovQaCount">0</div>
                  <div class="overview-card-sub" id="ovQaPending">0 pending review</div>
                </div>
              </div>
              <!-- CSAT Follow-ups card -->
              <div class="overview-card">
                <div class="overview-card-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">âš ï¸</div>
                <div class="overview-card-body">
                  <div class="overview-card-label">CSAT Follow-ups</div>
                  <div class="overview-card-value" id="ovCsatPending">0</div>
                  <div class="overview-card-sub" id="ovCsatSub">needing follow-up</div>
                </div>
              </div>
              <!-- Attendance card -->
              <div class="overview-card">
                <div class="overview-card-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ðŸ“…</div>
                <div class="overview-card-body">
                  <div class="overview-card-label">Attendance</div>
                  <div class="overview-card-value" id="ovBradford">0</div>
                  <div class="overview-card-sub" id="ovBradfordLabel">Bradford Factor</div>
                </div>
              </div>
              <!-- Performance card -->
              <div class="overview-card">
                <div class="overview-card-icon" style="background: linear-gradient(135deg, #ec4899, #db2777);">ðŸ“Š</div>
                <div class="overview-card-body">
                  <div class="overview-card-label">Performance</div>
                  <div class="overview-card-value" id="ovPerfWeeks">0</div>
                  <div class="overview-card-sub" id="ovPerfSub">weeks tracked</div>
                </div>
              </div>
            </div>

            <!-- Quick action items -->
            <div class="overview-actions" id="overviewActions">
              <!-- Populated by JS with attention items -->
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- S.M.A.R.T. GOALS TAB (B2 â€” cards + editor) -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="tabSmart" class="goals-tab-pane">
            <!-- Section Header -->
            <div class="section-header-bar">
              <div class="section-header-left">
                <span class="section-header-title">ðŸŽ¯ S.M.A.R.T. Goals</span>
                <span class="section-header-hint">Specific, Measurable, Attainable, Relevant, Time-bound</span>
              </div>
              <div class="section-header-right">
                <button class="btn-modern primary-sm" onclick="openGoalEditor()">+ Add Goal</button>
              </div>
            </div>

            <!-- Goal Cards List -->
            <div id="smartGoalsList" class="smart-goals-list">
              <!-- Populated by JS â€” each goal is a card -->
              <!-- Empty state rendered dynamically -->
            </div>

            <!-- Goal Editor Drawer (hidden by default) -->
            <div id="goalEditorDrawer" class="goal-editor-drawer" style="display:none;">
              <div class="goal-editor-header">
                <span class="goal-editor-title" id="goalEditorTitle">New Goal</span>
                <button class="btn-modern ghost-sm" onclick="closeGoalEditor()">âœ•</button>
              </div>
              <div class="goal-editor-body">
                <input type="hidden" id="goalEditorId" value="">
                <div class="goal-editor-field">
                  <label>Goal Title</label>
                  <input type="text" id="goalEditorTitleInput" placeholder="e.g. Improve first-response time to under 2 minutes" class="modern-input">
                </div>
                <div class="goal-editor-row">
                  <div class="goal-editor-field">
                    <label>Status</label>
                    <select id="goalEditorStatus" class="modern-select">
                      <option value="draft">ðŸ“ Draft</option>
                      <option value="active" selected>ðŸŸ¢ Active</option>
                      <option value="at_risk">ðŸŸ¡ At Risk</option>
                      <option value="complete">âœ… Complete</option>
                      <option value="archived">ðŸ“¦ Archived</option>
                    </select>
                  </div>
                  <div class="goal-editor-field">
                    <label>Due Date</label>
                    <input type="date" id="goalEditorDue" class="modern-input">
                  </div>
                </div>
                <div class="goal-editor-row">
                  <div class="goal-editor-field">
                    <label>Review Cadence</label>
                    <select id="goalEditorCadence" class="modern-select">
                      <option value="">None</option>
                      <option value="weekly">Weekly</option>
                      <option value="biweekly">Biweekly</option>
                      <option value="monthly">Monthly</option>
                    </select>
                  </div>
                  <div class="goal-editor-field">
                    <label>Next Check-in</label>
                    <input type="date" id="goalEditorNextCheckin" class="modern-input">
                  </div>
                </div>
                <div class="goal-editor-smart-fields">
                  <div class="goal-editor-field">
                    <label><span class="smart-label">S</span> Specific</label>
                    <textarea id="goalEditorSpecific" class="modern-textarea" placeholder="Clearly define what success looks like and who's involved."></textarea>
                  </div>
                  <div class="goal-editor-field">
                    <label><span class="smart-label">M</span> Measurable</label>
                    <textarea id="goalEditorMeasurable" class="modern-textarea" placeholder="Determine how progress will be tracked or proven."></textarea>
                  </div>
                  <div class="goal-editor-field">
                    <label><span class="smart-label">A</span> Attainable</label>
                    <textarea id="goalEditorAttainable" class="modern-textarea" placeholder="Ensure the goal is realistic given time, workload and tools."></textarea>
                  </div>
                  <div class="goal-editor-field">
                    <label><span class="smart-label">R</span> Relevant</label>
                    <textarea id="goalEditorRelevant" class="modern-textarea" placeholder="Aligns with your current role, responsibilities, and priorities."></textarea>
                  </div>
                  <div class="goal-editor-field">
                    <label><span class="smart-label">T</span> Time Bound</label>
                    <textarea id="goalEditorTimeBound" class="modern-textarea" placeholder="Give the goal a realistic but motivating deadline."></textarea>
                  </div>
                </div>
              </div>
              <div class="goal-editor-footer">
                <button class="btn-modern ghost-sm" onclick="closeGoalEditor()">Cancel</button>
                <button class="btn-modern danger-sm" id="goalEditorDeleteBtn" onclick="deleteCurrentGoal()" style="display:none;">ðŸ—‘ Delete</button>
                <button class="btn-modern primary-sm" onclick="saveGoalFromEditor()">ðŸ’¾ Save Goal</button>
              </div>
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- TASKS TAB (C2 â€” task list with filters)     -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="tabTasks" class="goals-tab-pane">
            <div class="section-header-bar">
              <div class="section-header-left">
                <span class="section-header-title">ðŸ“Œ Tasks & Projects</span>
              </div>
              <div class="section-header-right">
                <button class="btn-modern primary-sm" onclick="openTaskEditor()">+ Add Task</button>
              </div>
            </div>

            <!-- Filter Chips -->
            <div class="filter-chips" id="taskFilterChips">
              <button class="filter-chip active" data-filter="all" onclick="filterTasks('all')">All</button>
              <button class="filter-chip" data-filter="overdue" onclick="filterTasks('overdue')">ðŸ”´ Overdue</button>
              <button class="filter-chip" data-filter="due_soon" onclick="filterTasks('due_soon')">ðŸŸ¡ Due Soon</button>
              <button class="filter-chip" data-filter="in_progress" onclick="filterTasks('in_progress')">ðŸ”„ In Progress</button>
              <button class="filter-chip" data-filter="done" onclick="filterTasks('done')">âœ… Completed</button>
            </div>

            <!-- Task List -->
            <div id="tasksList" class="tasks-list">
              <!-- Empty state rendered dynamically -->
            </div>

            <!-- Task Editor (inline expandable) -->
            <div id="taskEditorPanel" class="task-editor-panel" style="display:none;">
              <input type="hidden" id="taskEditorId" value="">
              <div class="task-editor-grid">
                <div class="goal-editor-field" style="grid-column: 1 / -1;">
                  <label>Task Title</label>
                  <input type="text" id="taskEditorTitle" class="modern-input" placeholder="What needs to be done?">
                </div>
                <div class="goal-editor-field">
                  <label>Priority</label>
                  <select id="taskEditorPriority" class="modern-select">
                    <option value="">Select</option>
                    <option value="high">ðŸ”´ High</option>
                    <option value="medium">ðŸŸ¡ Medium</option>
                    <option value="low">ðŸŸ¢ Low</option>
                  </select>
                </div>
                <div class="goal-editor-field">
                  <label>Due Date</label>
                  <input type="date" id="taskEditorDue" class="modern-input">
                </div>
                <div class="goal-editor-field">
                  <label>Status</label>
                  <select id="taskEditorStatus" class="modern-select">
                    <option value="open">Open</option>
                    <option value="in_progress">In Progress</option>
                    <option value="done">Completed</option>
                    <option value="blocked">Blocked</option>
                  </select>
                </div>
                <div class="goal-editor-field" style="grid-column: 1 / -1;">
                  <label>Notes</label>
                  <textarea id="taskEditorNotes" class="modern-textarea" placeholder="Additional details..."></textarea>
                </div>
              </div>
              <div class="task-editor-actions">
                <button class="btn-modern ghost-sm" onclick="closeTaskEditor()">Cancel</button>
                <button class="btn-modern danger-sm" id="taskEditorDeleteBtn" onclick="deleteCurrentTask()" style="display:none;">ðŸ—‘ Delete</button>
                <button class="btn-modern primary-sm" onclick="saveTaskFromEditor()">Save Task</button>
              </div>
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- ATTENDANCE TAB (E1 timeline + F1 meeting)   -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="tabAttendance" class="goals-tab-pane">
            <div class="section-header-bar">
              <div class="section-header-left">
                <span class="section-header-title">ðŸ“… Attendance Summary</span>
              </div>
              <div class="section-header-right">
                <select id="attendancePeriod" onchange="loadAgentAttendance()" class="modern-select" style="width: auto;">
                  <option value="7">Last 7 Days</option>
                  <option value="30">Last 30 Days</option>
                  <option value="60">Last 60 Days</option>
                  <option value="90" selected>Last 90 Days</option>
                  <option value="180">Last 6 Months</option>
                  <option value="365">Last Year</option>
                </select>
              </div>
            </div>

            <!-- Summary Band -->
            <div class="summary-band">
              <div class="summary-card bradford">
                <div class="summary-card-label">Bradford Factor</div>
                <div class="summary-card-value" id="attBradford">--</div>
                <div class="summary-card-status" id="attBradfordStatus">Calculating...</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">Call Outs</div>
                <div class="summary-card-value" id="attCallOuts">--</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">PTO Requests</div>
                <div class="summary-card-value" id="attPTO">--</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">Swaps Initiated</div>
                <div class="summary-card-value" id="attSwapsInit">--</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">Times Replaced</div>
                <div class="summary-card-value" id="attReplaced">--</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">Covered Others</div>
                <div class="summary-card-value" id="attCovered">--</div>
              </div>
            </div>

            <!-- Meeting Follow-up Action Area (F1) -->
            <div class="section-header-bar" style="margin-top: 24px;">
              <div class="section-header-left">
                <span class="section-header-title">ðŸ“ž Meeting Follow-ups</span>
              </div>
              <div class="section-header-right">
                <button class="btn-modern primary-sm" onclick="addMeetingFollowup()">+ Log Follow-up</button>
              </div>
            </div>
            <div id="meetingFollowups" class="meeting-followups-list">
              <!-- Populated by JS -->
            </div>

            <!-- Timeline (E1 â€” unified timeline component) -->
            <div class="section-header-bar" style="margin-top: 24px;">
              <div class="section-header-left">
                <span class="section-header-title">ðŸ“œ Event History</span>
              </div>
              <div class="section-header-right">
                <div class="filter-chips compact">
                  <button class="filter-chip active" data-filter="all" onclick="filterTimeline('all', 'attendance')">All</button>
                  <button class="filter-chip" data-filter="timeoff" onclick="filterTimeline('timeoff', 'attendance')">PTO</button>
                  <button class="filter-chip" data-filter="swap" onclick="filterTimeline('swap', 'attendance')">Swaps</button>
                  <button class="filter-chip" data-filter="callout" onclick="filterTimeline('callout', 'attendance')">Call Outs</button>
                </div>
              </div>
            </div>
            <div class="timeline" id="attendanceTimeline">
              <div class="timeline-loading">Loading attendance data...</div>
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- PERFORMANCE TAB (F2 â€” summary band + list)  -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="tabMetrics" class="goals-tab-pane">
            <div class="section-header-bar">
              <div class="section-header-left">
                <span class="section-header-title">ðŸ“Š Weekly Performance Metrics</span>
              </div>
              <div class="section-header-right">
                <button class="btn-modern primary-sm" onclick="addMetricsRow()">+ Add Week</button>
              </div>
            </div>

            <!-- Performance Summary Band (F2) -->
            <div class="summary-band" id="perfSummaryBand">
              <div class="summary-card">
                <div class="summary-card-label">Avg Tickets/Week</div>
                <div class="summary-card-value" id="perfAvgTickets">--</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">Avg CSAT</div>
                <div class="summary-card-value" id="perfAvgCsat">--</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">This Week vs Prior</div>
                <div class="summary-card-value" id="perfTrend">--</div>
              </div>
              <div class="summary-card">
                <div class="summary-card-label">Total Call Outs</div>
                <div class="summary-card-value" id="perfTotalCallOuts">--</div>
              </div>
            </div>

            <div class="goals-table-wrap">
              <table class="goals-table" id="metricsTable">
                <thead>
                  <tr>
                    <th style="width:14%">Week Starting</th>
                    <th style="width:10%">Tickets Solved</th>
                    <th style="width:10%">CSAT %</th>
                    <th style="width:20%">Wins / Challenges</th>
                    <th style="width:10%">Call Outs</th>
                    <th style="width:12%">Make Up Hours</th>
                    <th style="width:18%">Notes</th>
                    <th style="width:6%"></th>
                  </tr>
                </thead>
                <tbody id="metricsTableBody">
                  <!-- Rows added by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- QA TAB (D2 â€” two sections + D3 badge)       -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="tabQa" class="goals-tab-pane">

            <!-- Section 1: QA Reviews (existing, modernized) -->
            <div class="section-header-bar">
              <div class="section-header-left">
                <span class="section-header-title">âœ… QA Reviews</span>
              </div>
              <div class="section-header-right">
                <button class="btn-modern primary-sm" onclick="addQaRow()">+ Add QA Review</button>
              </div>
            </div>
            <div class="goals-table-wrap">
              <table class="goals-table" id="qaTable">
                <thead>
                  <tr>
                    <th style="width:12%">Date</th>
                    <th style="width:12%">Channel</th>
                    <th style="width:12%">Ticket #</th>
                    <th style="width:25%">Notes</th>
                    <th style="width:10%">Gone Over?</th>
                    <th style="width:23%">Follow-up Notes</th>
                    <th style="width:6%"></th>
                  </tr>
                </thead>
                <tbody id="qaTableBody">
                  <!-- Rows added by JS -->
                </tbody>
              </table>
            </div>

            <!-- Section 2: Low CSAT Follow-ups (D1/D2 â€” new) -->
            <div class="section-header-bar" style="margin-top: 32px;">
              <div class="section-header-left">
                <span class="section-header-title">âš ï¸ Low CSAT Follow-ups</span>
                <span class="csat-pending-count" id="csatPendingCount" style="display:none;">0 pending</span>
              </div>
              <div class="section-header-right">
                <button class="btn-modern primary-sm" onclick="openCsatFollowupEditor()">+ Add Follow-up</button>
              </div>
            </div>

            <!-- CSAT Filter -->
            <div class="filter-chips" id="csatFilterChips">
              <button class="filter-chip active" data-filter="all" onclick="filterCsatFollowups('all')">All</button>
              <button class="filter-chip" data-filter="pending" onclick="filterCsatFollowups('pending')">â³ Needs Follow-up</button>
              <button class="filter-chip" data-filter="completed" onclick="filterCsatFollowups('completed')">âœ… Completed</button>
            </div>

            <!-- CSAT Follow-ups List -->
            <div id="csatFollowupsList" class="csat-followups-list">
              <!-- Empty state rendered dynamically -->
            </div>

            <!-- CSAT Follow-up Editor (inline panel) -->
            <div id="csatEditorPanel" class="csat-editor-panel" style="display:none;">
              <input type="hidden" id="csatEditorId" value="">
              <div class="task-editor-grid">
                <div class="goal-editor-field">
                  <label>Date Received</label>
                  <input type="date" id="csatEditorDate" class="modern-input">
                </div>
                <div class="goal-editor-field">
                  <label>Ticket Number</label>
                  <input type="text" id="csatEditorTicket" class="modern-input" placeholder="#12345">
                </div>
                <div class="goal-editor-field">
                  <label>Channel</label>
                  <select id="csatEditorChannel" class="modern-select">
                    <option value="">Select</option>
                    <option value="Live Chat">Live Chat</option>
                    <option value="Phone">Phone</option>
                    <option value="Email">Email</option>
                    <option value="Socials">Socials</option>
                  </select>
                </div>
                <div class="goal-editor-field">
                  <label>Rating</label>
                  <select id="csatEditorRating" class="modern-select">
                    <option value="">Select</option>
                    <option value="1">â­ 1 â€” Very Poor</option>
                    <option value="2">â­â­ 2 â€” Poor</option>
                    <option value="3">â­â­â­ 3 â€” Below Average</option>
                  </select>
                </div>
                <div class="goal-editor-field" style="grid-column: 1 / -1;">
                  <label>Issue Summary</label>
                  <textarea id="csatEditorSummary" class="modern-textarea" placeholder="Brief summary of the customer issue..."></textarea>
                </div>
                <div class="goal-editor-field">
                  <label>Follow-up Method</label>
                  <select id="csatEditorMethod" class="modern-select">
                    <option value="">Select</option>
                    <option value="email">ðŸ“§ Email</option>
                    <option value="chat">ðŸ’¬ Chat</option>
                    <option value="phone">ðŸ“ž Phone</option>
                  </select>
                </div>
                <div class="goal-editor-field">
                  <label>
                    <input type="checkbox" id="csatEditorCompleted" onchange="toggleCsatCompletedDate()">
                    Patient Contacted / Completed
                  </label>
                  <input type="date" id="csatEditorCompletedAt" class="modern-input" style="display:none;">
                </div>
                <div class="goal-editor-field" style="grid-column: 1 / -1;">
                  <label>Notes</label>
                  <textarea id="csatEditorNotes" class="modern-textarea" placeholder="Follow-up notes..."></textarea>
                </div>
              </div>
              <div class="task-editor-actions">
                <button class="btn-modern ghost-sm" onclick="closeCsatEditor()">Cancel</button>
                <button class="btn-modern danger-sm" id="csatEditorDeleteBtn" onclick="deleteCurrentCsatFollowup()" style="display:none;">ðŸ—‘ Delete</button>
                <button class="btn-modern primary-sm" onclick="saveCsatFollowupFromEditor()">Save Follow-up</button>
              </div>
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- TOPICS TAB (unchanged structure, cleaner)   -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="tabTopics" class="goals-tab-pane">
            <div class="section-header-bar">
              <div class="section-header-left">
                <span class="section-header-title">ðŸ’¬ Topics Discussed</span>
              </div>
              <div class="section-header-right">
                <button class="btn-modern primary-sm" onclick="addTopicRow()">+ Add Topic</button>
              </div>
            </div>
            <div class="goals-table-wrap">
              <table class="goals-table" id="topicsTable">
                <thead>
                  <tr>
                    <th style="width:12%">Date</th>
                    <th style="width:22%">Topic Discussed</th>
                    <th style="width:22%">Their Thoughts</th>
                    <th style="width:12%">Follow-up?</th>
                    <th style="width:26%">Notes</th>
                    <th style="width:6%"></th>
                  </tr>
                </thead>
                <tbody id="topicsTableBody">
                  <!-- Rows added by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- 1:1 NOTES TAB (unchanged structure, cleaner)-->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="tabNotes" class="goals-tab-pane">
            <div class="section-header-bar">
              <div class="section-header-left">
                <span class="section-header-title">ðŸ“ 1:1 Notes + Questions Monthly</span>
              </div>
              <div class="section-header-right">
                <button class="btn-modern primary-sm" onclick="addNoteRow()">+ Add Entry</button>
              </div>
            </div>
            <div class="goals-table-wrap">
              <table class="goals-table" id="notesTable">
                <thead>
                  <tr>
                    <th style="width:12%">Date</th>
                    <th style="width:22%">Question Asked</th>
                    <th style="width:22%">Their Answer</th>
                    <th style="width:12%">Follow-up?</th>
                    <th style="width:26%">Notes</th>
                    <th style="width:6%"></th>
                  </tr>
                </thead>
                <tbody id="notesTableBody">
                  <!-- Rows added by JS -->
                </tbody>
              </table>
            </div>
          </div>

        </div><!-- /goals-tab-content -->
      </div><!-- /goalsContent -->
    </div><!-- /goals-main -->
  </div><!-- /goals-container -->
</div><!-- /goalsView -->


<!-- Agent Goals Modal (read-only view for agents) -->
<div id="agentGoalsModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeAgentGoalsModal()">
  <div class="modal" style="width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
    <div class="mHead" style="background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%); border-bottom: none; flex-shrink: 0;">
      <span class="mTitle" style="color: white;">ðŸ“‹ My Goals & Progress</span>
      <button type="button" class="btn ghost" style="padding:6px 12px; color:white; background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.25);" onclick="closeAgentGoalsModal()">âœ•</button>
    </div>
    <div class="mBody" style="flex: 1; overflow-y: auto; max-height: calc(90vh - 60px); padding: 20px;">
      <div class="agent-goals-meta" id="agentGoalsMeta" style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 16px;">Last updated: Never</div>
      <div id="agentGoalsContent">
        <div class="attendance-loading">Loading your goals...</div>
      </div>
    </div>
  </div>
</div>

<div id="agentGoalsView" style="display:none; height:100%; flex:1; min-height:0; overflow:auto; padding: 24px;">
  <div class="agent-goals-container">
    <div class="agent-goals-header">
      <h2>ðŸ“‹ My Goals & Progress</h2>
      <div class="agent-goals-meta" id="agentGoalsMetaAlt">Last updated: Never</div>
    </div>
    <div id="agentGoalsContentAlt">
      <!-- Populated by JS -->
    </div>
  </div>
</div>


<style>
/* ============================================ */
/* GOALS WORKSPACE â€” MODERNIZED STYLES          */
/* ============================================ */
/* ============================================================ */
/* GOALS WORKSPACE â€” MODERNIZED STYLES                          */
/* Replaces original goals CSS block (~lines 5992-6500+)        */
/* Implements: A2 Shared Primitives, all visual updates         */
/* ============================================================ */

/* â”€â”€ Existing Goals Container (unchanged) â”€â”€ */
.goals-container {
  display: flex;
  height: 100%;
  gap: 0;
  background: var(--bg-primary);
}

.goals-sidebar {
  width: 280px;
  min-width: 280px;
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  background: var(--bg-secondary);
}

.goals-sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border-color);
}

.goals-sidebar-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 12px;
}

.goals-search {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 13px;
  background: var(--input-bg);
  color: var(--text-primary);
  transition: border-color 0.2s, box-shadow 0.2s;
}
.goals-search:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px rgba(179, 126, 120, 0.12);
}

.goals-agent-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.goals-agent-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.15s;
  margin-bottom: 4px;
  border: 1px solid transparent;
}

.goals-agent-item:hover {
  background: var(--bg-tertiary);
}

.goals-agent-item.active {
  background: var(--accent-selected);
  border-color: var(--accent-primary);
}

.goals-agent-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 14px;
  color: white;
  flex-shrink: 0;
}

.goals-agent-item-info {
  flex: 1;
  min-width: 0;
}

.goals-agent-item-name {
  font-weight: 600;
  font-size: 13px;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.goals-agent-item-meta {
  font-size: 11px;
  color: var(--text-tertiary);
}

.goals-agent-badge {
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 600;
  flex-shrink: 0;
}

.goals-agent-badge.watch { background: #fef3c7; color: #92400e; }
.goals-agent-badge.concern { background: #fed7aa; color: #c2410c; }
.goals-agent-badge.serious { background: #fecaca; color: #b91c1c; }
.goals-agent-badge.critical { background: #ef4444; color: white; }

.goals-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--bg-primary);
}

.goals-placeholder {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  text-align: center;
  padding: 40px;
}

.goals-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* â”€â”€ Agent Header â”€â”€ */
.goals-agent-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
}

.goals-agent-name {
  font-size: 20px;
  font-weight: 800;
  color: var(--text-primary);
}

.goals-agent-meta {
  font-size: 12px;
  color: var(--text-tertiary);
  margin-top: 2px;
}

/* â”€â”€ Tab Bar â”€â”€ */
.goals-tabs {
  display: flex;
  gap: 4px;
  padding: 12px 24px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  overflow-x: auto;
}

.goals-tab {
  padding: 10px 16px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.15s;
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.goals-tab:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.goals-tab.active {
  background: var(--accent-selected);
  color: var(--text-primary);
}

/* D3 â€” Tab Badge */
.goals-tab-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 18px;
  height: 18px;
  padding: 0 5px;
  border-radius: 9px;
  background: #ef4444;
  color: white;
  font-size: 10px;
  font-weight: 700;
  line-height: 1;
}

.goals-tab-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.goals-tab-pane {
  display: none;
}

.goals-tab-pane.active {
  display: block;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* A2 â€” SHARED UI PRIMITIVES                   */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Section Header Bar */
.section-header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.section-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.section-header-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
}
.section-header-hint {
  font-size: 11px;
  font-weight: 400;
  color: var(--text-tertiary);
}
.section-header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Modern Buttons */
.btn-modern {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 13px;
}
.btn-modern.primary-sm {
  padding: 8px 16px;
  background: linear-gradient(135deg, var(--modal-gradient-start) 0%, var(--modal-gradient-end) 100%);
  color: white;
  box-shadow: 0 2px 8px var(--modal-btn-shadow);
}
.btn-modern.primary-sm:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px var(--modal-btn-hover-shadow);
}
.btn-modern.ghost-sm {
  padding: 8px 16px;
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}
.btn-modern.ghost-sm:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}
.btn-modern.danger-sm {
  padding: 8px 16px;
  background: transparent;
  color: #ef4444;
  border: 1px solid #fecaca;
}
.btn-modern.danger-sm:hover {
  background: #fef2f2;
}

/* Modern Inputs */
.modern-input,
.modern-select,
.modern-textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 13px;
  background: var(--input-bg);
  color: var(--text-primary);
  transition: border-color 0.2s, box-shadow 0.2s;
}
.modern-input:focus,
.modern-select:focus,
.modern-textarea:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px rgba(179, 126, 120, 0.12);
}
.modern-textarea {
  resize: vertical;
  min-height: 60px;
}

/* Status Pill */
.status-pill {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}
.status-pill.draft { background: #f1f5f9; color: #64748b; }
.status-pill.active { background: #dcfce7; color: #166534; }
.status-pill.at_risk { background: #fef3c7; color: #92400e; }
.status-pill.complete { background: #dbeafe; color: #1e40af; }
.status-pill.archived { background: #f3f4f6; color: #6b7280; }
.status-pill.open { background: #e0f2fe; color: #0369a1; }
.status-pill.in_progress { background: #fef3c7; color: #92400e; }
.status-pill.done { background: #dcfce7; color: #166534; }
.status-pill.blocked { background: #fecaca; color: #b91c1c; }
.status-pill.overdue { background: #fecaca; color: #b91c1c; }
.status-pill.pending { background: #fef3c7; color: #92400e; }
.status-pill.completed { background: #dcfce7; color: #166534; }

body.dark-mode .status-pill.draft { background: #334155; color: #94a3b8; }
body.dark-mode .status-pill.active { background: #14532d; color: #86efac; }
body.dark-mode .status-pill.at_risk { background: #713f12; color: #fde68a; }
body.dark-mode .status-pill.complete { background: #1e3a5f; color: #93c5fd; }
body.dark-mode .status-pill.archived { background: #374151; color: #9ca3af; }
body.dark-mode .status-pill.open { background: #0c4a6e; color: #7dd3fc; }
body.dark-mode .status-pill.in_progress { background: #713f12; color: #fde68a; }
body.dark-mode .status-pill.done { background: #14532d; color: #86efac; }
body.dark-mode .status-pill.blocked { background: #7f1d1d; color: #fca5a5; }
body.dark-mode .status-pill.overdue { background: #7f1d1d; color: #fca5a5; }
body.dark-mode .status-pill.pending { background: #713f12; color: #fde68a; }
body.dark-mode .status-pill.completed { background: #14532d; color: #86efac; }

/* Empty State */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px 24px;
  text-align: center;
  border: 2px dashed var(--border-color);
  border-radius: 16px;
  background: var(--bg-tertiary);
}
.empty-state-icon {
  font-size: 48px;
  margin-bottom: 12px;
}
.empty-state-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 6px;
}
.empty-state-text {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 16px;
  max-width: 340px;
}

/* Filter Chips */
.filter-chips {
  display: flex;
  gap: 6px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.filter-chips.compact {
  margin-bottom: 0;
}
.filter-chip {
  padding: 6px 14px;
  border: 1px solid var(--border-color);
  border-radius: 99px;
  background: transparent;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.filter-chip:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-color: var(--text-tertiary);
}
.filter-chip.active {
  background: var(--accent-selected);
  color: var(--text-primary);
  border-color: var(--accent-primary);
}

/* Summary Band (shared: Attendance + Performance) */
.summary-band {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  margin-bottom: 24px;
}
@media (max-width: 900px) {
  .summary-band { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 600px) {
  .summary-band { grid-template-columns: repeat(2, 1fr); }
}

.summary-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 14px 10px;
  text-align: center;
  transition: transform 0.15s, box-shadow 0.15s;
  min-width: 0;
}
.summary-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--shadow-sm);
}

.summary-card.bradford {
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: white;
  border: none;
}
.summary-card.bradford .summary-card-label,
.summary-card.bradford .summary-card-status {
  color: rgba(255,255,255,0.85);
}
.summary-card.bradford .summary-card-value {
  color: white;
}

.summary-card-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.summary-card-value {
  font-size: 24px;
  font-weight: 800;
  color: var(--text-primary);
  margin: 4px 0 2px;
  line-height: 1.1;
}

.summary-card-status {
  font-size: 11px;
  font-weight: 600;
}
.summary-card-status.good { color: #22c55e; }
.summary-card-status.watch { color: #eab308; }
.summary-card-status.concern { color: #f97316; }
.summary-card-status.serious { color: #ef4444; }
.summary-card-status.critical { color: #dc2626; font-weight: 700; }


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* A3 â€” OVERVIEW TAB                            */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.overview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.overview-card {
  display: flex;
  align-items: center;
  gap: 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 14px;
  padding: 18px 20px;
  transition: transform 0.15s, box-shadow 0.15s;
}
.overview-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px var(--shadow-sm);
}

.overview-card-icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: white;
  flex-shrink: 0;
}

.overview-card-body {
  flex: 1;
  min-width: 0;
}

.overview-card-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.overview-card-value {
  font-size: 24px;
  font-weight: 800;
  color: var(--text-primary);
  margin: 2px 0;
}

.overview-card-sub {
  font-size: 11px;
  color: var(--text-secondary);
}

/* Overview attention items */
.overview-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.overview-action-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;
}
.overview-action-item:hover {
  background: var(--bg-tertiary);
  border-color: var(--accent-primary);
}
.overview-action-item.urgent {
  border-left: 3px solid #ef4444;
}
.overview-action-item.warning {
  border-left: 3px solid #f59e0b;
}
.overview-action-item.info {
  border-left: 3px solid #3b82f6;
}
.overview-action-icon {
  font-size: 18px;
  flex-shrink: 0;
}
.overview-action-text {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
}
.overview-action-meta {
  font-size: 11px;
  color: var(--text-tertiary);
  white-space: nowrap;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* B2 â€” SMART GOALS CARDS + EDITOR             */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.smart-goals-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Goal Card */
.smart-goal-card-v2 {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 14px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
}
.smart-goal-card-v2:hover {
  border-color: var(--accent-primary);
  box-shadow: 0 4px 12px var(--shadow-sm);
  transform: translateY(-1px);
}

.smart-goal-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.smart-goal-card-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
  flex: 1;
  margin-right: 12px;
}

.smart-goal-card-meta {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.smart-goal-card-meta-item {
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 4px;
}

.smart-goal-card-preview {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
}
.smart-goal-preview-field {
  background: var(--bg-tertiary);
  padding: 8px 10px;
  border-radius: 8px;
}
.smart-goal-preview-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--accent-primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 3px;
}
.smart-goal-preview-value {
  font-size: 12px;
  color: var(--text-primary);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Goal Editor Drawer */
.goal-editor-drawer {
  background: var(--bg-secondary);
  border: 1px solid var(--accent-primary);
  border-radius: 14px;
  margin-top: 16px;
  overflow: hidden;
  box-shadow: 0 8px 24px var(--shadow-md);
}
.goal-editor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border-color);
}
.goal-editor-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
}
.goal-editor-body {
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.goal-editor-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.goal-editor-field label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
}
.goal-editor-smart-fields {
  display: flex;
  flex-direction: column;
  gap: 12px;
  border-top: 1px solid var(--border-color);
  padding-top: 16px;
  margin-top: 4px;
}
.goal-editor-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 16px 20px;
  background: var(--bg-tertiary);
  border-top: 1px solid var(--border-color);
}

/* SMART Label (colored letter badge) */
.smart-label {
  display: inline-block;
  width: 18px;
  height: 18px;
  background: var(--accent-primary);
  color: white;
  border-radius: 4px;
  text-align: center;
  line-height: 18px;
  font-weight: 700;
  margin-right: 4px;
  font-size: 11px;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* C2 â€” TASKS LIST                              */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.tasks-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.task-card {
  display: flex;
  align-items: center;
  gap: 14px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 14px 18px;
  cursor: pointer;
  transition: all 0.15s;
}
.task-card:hover {
  border-color: var(--accent-primary);
  box-shadow: 0 2px 8px var(--shadow-sm);
}
.task-card.overdue {
  border-left: 3px solid #ef4444;
}
.task-card.done {
  opacity: 0.6;
}
.task-card.done .task-card-title {
  text-decoration: line-through;
}

.task-card-priority {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.task-card-priority.high { background: #ef4444; }
.task-card-priority.medium { background: #f59e0b; }
.task-card-priority.low { background: #22c55e; }

.task-card-body {
  flex: 1;
  min-width: 0;
}
.task-card-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.task-card-subtitle {
  font-size: 11px;
  color: var(--text-tertiary);
  margin-top: 2px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.task-card-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

/* Task Editor Panel */
.task-editor-panel,
.csat-editor-panel {
  background: var(--bg-secondary);
  border: 1px solid var(--accent-primary);
  border-radius: 14px;
  padding: 20px;
  margin-top: 16px;
  box-shadow: 0 8px 24px var(--shadow-md);
}
.task-editor-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}
.task-editor-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* D2 â€” CSAT FOLLOW-UPS                         */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.csat-pending-count {
  display: inline-flex;
  align-items: center;
  padding: 3px 10px;
  border-radius: 99px;
  background: #fef3c7;
  color: #92400e;
  font-size: 11px;
  font-weight: 700;
}
body.dark-mode .csat-pending-count {
  background: #713f12;
  color: #fde68a;
}

.csat-followups-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.csat-followup-card {
  display: flex;
  align-items: center;
  gap: 14px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 14px 18px;
  cursor: pointer;
  transition: all 0.15s;
}
.csat-followup-card:hover {
  border-color: var(--accent-primary);
  box-shadow: 0 2px 8px var(--shadow-sm);
}
.csat-followup-card.pending {
  border-left: 3px solid #f59e0b;
}
.csat-followup-card.completed {
  border-left: 3px solid #22c55e;
  opacity: 0.75;
}

.csat-followup-rating {
  font-size: 16px;
  flex-shrink: 0;
}

.csat-followup-body {
  flex: 1;
  min-width: 0;
}
.csat-followup-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}
.csat-followup-subtitle {
  font-size: 11px;
  color: var(--text-tertiary);
  margin-top: 2px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.csat-followup-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* E1 â€” UNIFIED TIMELINE COMPONENT              */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.timeline {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.timeline-loading {
  padding: 32px;
  text-align: center;
  color: var(--text-secondary);
  font-size: 13px;
}

/* E2 â€” Date group headers */
.timeline-date-group {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 12px 0 6px;
  margin-top: 8px;
}
.timeline-date-group:first-child {
  margin-top: 0;
}

.timeline-item {
  display: flex;
  align-items: flex-start;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border-color);
  transition: background 0.15s;
}
.timeline-item:last-child {
  border-bottom: none;
}
.timeline-item:hover {
  background: var(--bg-tertiary);
  margin: 0 -12px;
  padding: 14px 12px;
  border-radius: 8px;
}

.timeline-item-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}
.timeline-item-icon.timeoff { background: #dbeafe; }
.timeline-item-icon.swap { background: #e0e7ff; }
.timeline-item-icon.callout { background: #fecaca; }
.timeline-item-icon.replaced { background: #fed7aa; }
.timeline-item-icon.covered { background: #dcfce7; }
.timeline-item-icon.meeting { background: #f3e8ff; }

body.dark-mode .timeline-item-icon.timeoff { background: #1e3a5f; }
body.dark-mode .timeline-item-icon.swap { background: #312e81; }
body.dark-mode .timeline-item-icon.callout { background: #7f1d1d; }
body.dark-mode .timeline-item-icon.replaced { background: #713f12; }
body.dark-mode .timeline-item-icon.covered { background: #14532d; }
body.dark-mode .timeline-item-icon.meeting { background: #4a1d96; }

.timeline-item-body {
  flex: 1;
  min-width: 0;
}
.timeline-item-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}
.timeline-item-subtitle {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}

.timeline-item-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 4px;
  flex-shrink: 0;
}
.timeline-item-date {
  font-size: 12px;
  color: var(--text-tertiary);
  white-space: nowrap;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* F1 â€” MEETING FOLLOW-UPS                      */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.meeting-followups-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* EXISTING TABLE STYLES (kept for Topics/Notes)*/
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.goals-table-wrap {
  overflow-x: auto;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
}

.goals-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.goals-table th {
  background: var(--bg-tertiary);
  padding: 12px 10px;
  text-align: left;
  font-weight: 600;
  color: var(--text-secondary);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border-color);
}

.goals-table td {
  padding: 10px;
  border-bottom: 1px solid var(--border-color);
  vertical-align: top;
}

.goals-table tr:last-child td {
  border-bottom: none;
}

.goals-table input,
.goals-table select,
.goals-table textarea {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 12px;
  background: var(--input-bg);
  color: var(--text-primary);
  transition: border-color 0.2s;
}
.goals-table input:focus,
.goals-table select:focus,
.goals-table textarea:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 2px rgba(179, 126, 120, 0.1);
}

.goals-table textarea {
  min-height: 50px;
  resize: vertical;
}

.goals-table .btn-delete {
  padding: 6px 10px;
  background: transparent;
  border: 1px solid #fecaca;
  color: #dc2626;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.15s;
}

.goals-table .btn-delete:hover {
  background: #fef2f2;
}

/* Agent Goals (read-only) styles */
.agent-goals-section {
  margin-bottom: 24px;
}
.agent-goals-section-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--accent-selected);
}
.agent-goal-item {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 14px 16px;
  margin-bottom: 8px;
}
.agent-goal-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.agent-goal-value {
  font-size: 13px;
  color: var(--text-primary);
  margin-top: 4px;
  line-height: 1.5;
}

/* Responsive adjustments */
@media (max-width: 1100px) {
  .smart-goal-card-preview {
    grid-template-columns: repeat(3, 1fr);
  }
  .task-editor-grid {
    grid-template-columns: 1fr 1fr;
  }
}
@media (max-width: 768px) {
  .goals-sidebar {
    width: 220px;
    min-width: 220px;
  }
  .overview-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .smart-goal-card-preview {
    grid-template-columns: 1fr;
  }
  .task-editor-grid {
    grid-template-columns: 1fr;
  }
  .goal-editor-row {
    grid-template-columns: 1fr;
  }
}


/* â”€â”€ Zendesk Ticket Links â”€â”€ */
.ticket-link {
  color: var(--accent-primary);
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
}
.ticket-link:hover {
  text-decoration: underline;
  color: var(--accent-secondary);
}
.ticket-link-icon {
  display: inline-flex;
  align-items: center;
  font-size: 14px;
  text-decoration: none;
  flex-shrink: 0;
  opacity: 0.7;
  transition: opacity 0.15s;
}
.ticket-link-icon:hover { opacity: 1; }


/* â”€â”€ Agent View Tabs (read-only modal) â”€â”€ */
.agent-view-tab {
  padding: 8px 14px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}
.agent-view-tab:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.agent-view-tab.active {
  background: var(--accent-primary);
  color: white;
  border-color: var(--accent-primary);
}

</style>

      <div id="metricsView" style="display:none; height:100%; flex:1; min-height:0; overflow:hidden;">
        <div class="metricsWrap" style="height:100%;">
          <div class="metricsLeft">
            <div class="metricsTop">
              <div class="metricsTitleWrap">
  <div class="metricsTitle">Agent Metrics</div>
  <div id="metricsCount" class="metricsCount"></div>
</div>
              <input id="metricsSearch" class="qrSearch" placeholder="Search agent..." oninput="renderMetricsList()" />
            </div>
            <div id="metricsList" class="metricsList"></div>
          </div>
          <div id="metricsDrawer" class="metricsDrawer">
            <div class="metricsDrawerHead">
              <div style="font-weight:800;">Profile</div>
              <button type="button" class="btn ghost" style="padding:6px 10px;" onclick="closeMetricsDrawer()">âœ•</button>
            </div>
            <div class="metricsDrawerBody">
              <div id="mProfLoader" style="color:#64748b; font-size:13px; padding:10px 0;">Select an agent to load metrics.</div>
              <div id="mProfContent" style="display:none; text-align:center;">
                <img id="mAvatar" src="" style="width:72px; height:72px; border-radius:50%; background:#e2e8f0; margin:10px auto 10px; border:3px solid #fff; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                <div id="mName" style="font-size:18px; font-weight:900; color:#0f172a;"></div>
                <div id="mEmail" style="font-size:12px; color:#64748b; margin-bottom:14px;"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; text-align:left; margin: 0 auto; max-width: 360px;">
                  <div style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd;">
                    <div style="font-size:10px; font-weight:800; color:#0369a1;">OPEN TICKETS</div>
                    <div id="mOpen" style="font-size:18px; font-weight:900; color:#0284c7;">--</div>
                  </div>
                  <div style="background:#fdf2f8; padding:10px; border-radius:8px; border:1px solid #fbcfe8;">
                    <div style="font-size:10px; font-weight:800; color:#be185d;">ROLE</div>
                    <div id="mRole" style="font-size:14px; font-weight:800; color:#db2777;">--</div>
                  </div>
                </div>
                <!-- Clickable ticket list for managers -->
                <div id="mTicketsList" style="margin:12px auto 0; max-width: 360px; max-height: 180px; overflow-y: auto; display: none;">
                  <!-- Populated by JS -->
                </div>
                <div id="mTicketsEmpty" style="margin:8px auto 0; max-width: 360px; text-align: center; color: var(--text-tertiary); font-size: 12px; display: none;">
                  ðŸŽ‰ No open tickets!
                </div>
                <div style="margin:10px auto 0; max-width: 360px; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; font-size: 11px; color: var(--text-secondary); text-align: center;">
                  ðŸ’¡ For CSAT &amp; Solved metrics, view <a href="https://musely.zendesk.com/explore" target="_blank" style="color: var(--accent-primary);">Zendesk Explore</a>
                </div>
                <div style="margin:10px auto 0; max-width: 360px; text-align:left;">
                  <div style="font-size:11px; color:#94a3b8;">Last Login: <span id="mLogin">--</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Old skeleton view - replaced with inline loading spinner -->
      <div id="skeletonView" class="skel-wrapper" style="display:none !important;">
        <div class="skel-col"><div class="skel-anim skel-head"></div><div class="skel-anim skel-card"></div><div class="skel-anim skel-card"></div></div>
        <div class="skel-col"><div class="skel-anim skel-head"></div><div class="skel-anim skel-card"></div><div class="skel-anim skel-card"></div></div>
        <div class="skel-col"><div class="skel-anim skel-head"></div><div class="skel-anim skel-card"></div><div class="skel-anim skel-card"></div></div>
        <div class="skel-col"><div class="skel-anim skel-head"></div><div class="skel-anim skel-card"></div><div class="skel-anim skel-card"></div></div>
      </div>
    </div>
    <!-- RIGHT DRAWER -->
    <div id="rightDrawer" class="drawer">
      <div class="drawerHead" style="height: auto; flex-direction: column; gap: 10px; padding-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
          <span>Tools</span>
          <div class="seg">
            <button class="segBtn active" id="btnModeQuick" onclick="setMode('quick')">Quick</button>
            <button class="segBtn" id="btnModeTeam" onclick="setMode('team')">Channel</button>
          </div>
        </div>
      </div>
      <div class="drawerBody" id="drawerQuick">
        <div class="filter-card">
          <div class="filter-header">âš¡ Quick Filters</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn-pill" onclick="filterToday()">Today</button>
            <button class="btn-pill" style="background:#fef2f2; color:#ef4444;" onclick="resetAllFilters()">Reset</button>
          </div>
        </div>
        <div class="filter-card" style="border-left: 4px solid #b37e78;">
          <div class="filter-header">ðŸ‘¥ Channel View</div>
          <select id="teamDropdown" onchange="updateTeamAgentList()" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:12px;">
            <option value="">Select Team...</option>
          </select>
          <div id="teamAgentList" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
        </div>
        <div style="margin-top:20px; border-top:1px solid #f1f5f9; padding-top:16px;">
          <label style="font-size:11px; color:#94a3b8; font-weight:700;">SEARCH ALL PEOPLE</label>
          <input class="qrSearch" id="qrSearch" placeholder="Search name..." oninput="renderQuickRail()" />
          <div id="qrList" style="display:flex; flex-direction:column; gap:6px;"></div>
        </div>
      </div>
      <div class="drawerBody hidden" id="drawerTeam">
        <p style="font-size:13px; color:#64748b; margin-bottom:16px;">Select shifts in the calendar, then apply bulk changes.</p>
        <div style="margin-bottom:8px; font-size:12px; font-weight:700; color:#0f172a;">SELECTED: <span id="tpCount" style="color:#b37e78;">0</span></div>
        <div style="margin-bottom:16px;">
          <label>Assign To</label>
          <select id="tpPerson"></select>
        </div>
        <button class="btn primary" style="width:100%;" onclick="applyBatch()">Apply Changes</button>
        <button class="btn ghost" style="width:100%; margin-top:12px;" onclick="clearTeamSelection()">Clear Selection</button>
      </div>
    </div>
  </div>
  <!-- SELECTION BAR -->
  <div id="selectionBar" class="selection-bar">
    <div class="sb-left">
      <div class="sb-count"><span id="sbCount">0</span> selected</div>
      <div style="height: 20px; width: 1px; background: rgba(255,255,255,0.2);"></div>
      <button class="sb-btn" id="btnSelectSimilar" onclick="selectSimilarVisible()">Select All Visible for this Person</button>
    </div>
    <div class="sb-actions">
      <button class="sb-btn" onclick="clearTeamSelection()">Cancel</button>
      <button class="sb-btn primary" onclick="openBatchEditModal()">Edit / Move</button>
      <button class="sb-btn danger" onclick="batchMarkOff()">Mark OFF</button>
    </div>
  </div>
  <!-- EDIT SHIFT MODAL -->
  <div id="editShiftModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div class="edit-shift-modal-content" style="background:var(--card-bg, white); padding:24px; border-radius:12px; width:320px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); border:1px solid var(--border-color, #e2e8f0);">
      <h3 style="margin:0 0 20px 0; color:var(--text-primary, #0f172a); font-size:18px; font-weight:700;">Edit Shift</h3>
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:6px; text-transform:uppercase;">Employee</label>
        <input type="text" id="modalEmployee" disabled style="width:100%; padding:10px 12px; border:1px solid var(--border-color, #e2e8f0); background:var(--bg-tertiary, #f8fafc); border-radius:8px; color:var(--text-secondary, #64748b); font-size:14px; box-sizing:border-box;">
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:6px; text-transform:uppercase;">Day</label>
        <input type="text" id="modalDay" disabled style="width:100%; padding:10px 12px; border:1px solid var(--border-color, #e2e8f0); background:var(--bg-tertiary, #f8fafc); border-radius:8px; color:var(--text-secondary, #64748b); font-size:14px; box-sizing:border-box;">
      </div>
      <div style="display:flex; gap:12px; margin-bottom:16px;">
        <div style="flex:1;">
          <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:6px; text-transform:uppercase;">Start</label>
          <input type="time" id="modalStart" style="width:100%; padding:10px 12px; border:1px solid var(--border-color, #e2e8f0); border-radius:8px; background:var(--card-bg, #fff); color:var(--text-primary, #0f172a); font-size:14px; box-sizing:border-box;">
        </div>
        <div style="flex:1;">
          <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:6px; text-transform:uppercase;">End</label>
          <input type="time" id="modalEnd" style="width:100%; padding:10px 12px; border:1px solid var(--border-color, #e2e8f0); border-radius:8px; background:var(--card-bg, #fff); color:var(--text-primary, #0f172a); font-size:14px; box-sizing:border-box;">
        </div>
      </div>
      <input type="hidden" id="modalOrigStart">
      <input type="hidden" id="modalOrigEnd">
      <input type="hidden" id="modalOrigTeam">
      <input type="hidden" id="modalOrigRole">
      <input type="hidden" id="modalDocId">
      <input type="hidden" id="modalAssignmentId">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:16px;">
        <div>
          <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:6px; text-transform:uppercase;">Channel</label>
          <select id="modalTeam" onchange="toggleCustomChannel(this)" style="width:100%; padding:10px 12px; border:1px solid var(--border-color, #e2e8f0); border-radius:8px; background:var(--card-bg, #fff); color:var(--text-primary, #0f172a); font-size:14px; box-sizing:border-box;"></select>
        </div>
        <div>
          <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:6px; text-transform:uppercase;">Role</label>
          <select id="modalRole" style="width:100%; padding:10px 12px; border:1px solid var(--border-color, #e2e8f0); border-radius:8px; background:var(--card-bg, #fff); color:var(--text-primary, #0f172a); font-size:14px; box-sizing:border-box;"></select>
        </div>
      </div>
      <div id="customChannelWrapper" style="margin-bottom:20px; display:none;">
        <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:6px; text-transform:uppercase;">Custom Channel Name</label>
        <input type="text" id="modalCustomChannel" placeholder="Enter custom channel name..." style="width:100%; padding:10px 12px; border:1px solid var(--border-color, #e2e8f0); border-radius:8px; background:var(--card-bg, #fff); color:var(--text-primary, #0f172a); font-size:14px; box-sizing:border-box;">
      </div>
      <div style="display:flex; justify-content:space-between; padding-top:16px; border-top:1px solid var(--border-color, #e2e8f0);">
        <button type="button" id="modalDeleteBtn" onclick="deleteShift()" style="background:#fef2f2; color:#dc2626; border:1px solid #fecaca; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Delete</button>
        <div style="display:flex; gap:10px;">
          <button type="button" onclick="closeModal()" style="background:var(--bg-tertiary, #f1f5f9); color:var(--text-secondary, #64748b); border:1px solid var(--border-color, #e2e8f0); padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Cancel</button>
          <button type="button" onclick="saveShift()" style="background:#b37e78; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Save</button>
        </div>
      </div>
    </div>
  </div>
  <!-- OVERLAYS -->
  <div id="modalOverlay" class="overlay" onclick="if(event.target===this) closeModal()">
    <div class="modal" style="width: 420px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
      <!-- Modern Header with gradient -->
      <div class="mHead" style="background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%); border-bottom: none; padding: 20px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 18px;">ðŸ”„</span>
          </div>
          <div>
            <span class="mTitle" style="color: white; font-size: 18px; font-weight: 700;">Replace Coverage</span>
            <div id="mSub" style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 2px;"></div>
          </div>
        </div>
        <button type="button" class="btn ghost" style="padding: 8px; color: white; background: rgba(255,255,255,0.1); border-radius: 8px;" onclick="closeModal()">âœ•</button>
      </div>
      
      <div class="mBody" style="padding: 24px;">
        <!-- Replace With Section -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Replace With</label>
          <select id="mNewPerson" style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-color, #e2e8f0); border-radius: 12px; font-size: 15px; font-weight: 700; color: var(--text-primary, #1e293b); background: var(--bg-secondary, #f8fafc); cursor: pointer; transition: all 0.2s;"></select>
        </div>
        
        <!-- Notification Section -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Notification</label>
          <select id="mNotify" style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-color, #e2e8f0); border-radius: 12px; font-size: 15px; font-weight: 700; color: var(--text-primary, #1e293b); background: var(--bg-secondary, #f8fafc); cursor: pointer; transition: all 0.2s;">
            <option value="send">ðŸ¤– Notify now (Google Chat)</option>
            <option value="defer">ðŸ•’ Notify later (queue)</option>
          </select>
          <div style="margin-top:8px; font-size:12px; color: var(--text-secondary, #64748b); font-weight:600;">
            â€œNotify laterâ€ keeps it in the manager queue until you send.
          </div>
        </div>
        
        <!-- Notes Section -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Notes</label>
          <textarea id="mNotes" placeholder="Add any notes about this change..." style="width: 100%; min-height: 84px; padding: 14px 16px; border: 1px solid var(--border-color, #e2e8f0); border-radius: 12px; font-size: 14px; color: var(--text-primary, #1e293b); background: var(--bg-secondary, #f8fafc); resize: vertical; font-family: inherit; transition: all 0.2s; box-sizing: border-box;"></textarea>
        </div>
        
        <!-- Quick Actions -->
        <div style="display: flex; gap: 10px; padding-top: 8px; border-top: 1px solid var(--border-color, #e2e8f0);">
          <button id="actionBtn" onclick="markTimeOff()" style="display: flex; align-items: center; gap: 6px; padding: 10px 14px; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #dc2626; border: 1px solid #fecaca; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
            <span>â›”</span> Mark Off
          </button>
          <button id="btnDeleteShift" onclick="deleteLiveShiftFromReplace()" style="display: none; align-items: center; gap: 6px; padding: 10px 14px; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #dc2626; border: 1px solid #fecaca; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
            <span>ðŸ—‘ï¸</span> Delete
          </button>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="mFoot" style="background: var(--bg-secondary, #f8fafc); padding: 16px 24px; border-top: 1px solid var(--border-color, #e2e8f0); display: flex; justify-content: flex-end; gap: 10px;">
        <button class="btn ghost" onclick="closeModal()" style="padding: 12px 20px; background: var(--card-bg, #ffffff); color: var(--text-secondary, #64748b); border: 1px solid var(--border-color, #e2e8f0); border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=getComputedStyle(document.body).getPropertyValue('--bg-tertiary')||'#f1f5f9'" onmouseout="this.style.background=getComputedStyle(document.body).getPropertyValue('--card-bg')||'#ffffff'">Cancel</button>
        <button class="btn primary" id="mSave" onclick="saveReplace()" style="padding: 12px 24px; background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(179,126,120,0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(179,126,120,0.4)'" onmouseout="this.style.transform='none'; this.style.boxShadow='0 2px 8px rgba(179,126,120,0.3)'">Save Changes</button>
      </div>
    </div>
  </div>
<!-- Holiday Management Modal -->
<div id="holidayModal" class="overlay overlay-sub" style="display:none;" onclick="if(event.target===this) closeHolidayModal()">
  <div class="modal" style="width: 500px;">
    <div class="mHead">
      <span class="mTitle">ðŸŽ„ Manage Holidays</span>
      <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closeHolidayModal()">âœ•</button>
    </div>
    
    <div class="mBody">
      <!-- Add Holiday Form -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:16px; background:#f8fafc; border-radius:10px; margin-bottom:20px;">
        <div>
          <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">DATE</label>
          <input type="date" id="holidayDate" style="width:100%; padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;" />
        </div>
        <div>
          <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">HOLIDAY NAME</label>
          <input type="text" id="holidayName" placeholder="e.g., Christmas Day" style="width:100%; padding:8px 12px; border:1px solid #e2e8f0; border-radius: 6px; font-size:14px;" />
        </div>
        <div>
          <label style="font-size:11px; font-weight:600; color:#64748b; display: block; margin-bottom:4px;">THEME</label>
          <select id="holidayTheme" style="width:100%; padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
            <option value="christmas">ðŸŽ„ Christmas</option>
            <option value="newyear">ðŸŽ† New Year</option>
            <option value="july4th">ðŸ‡ºðŸ‡¸ July 4th</option>
            <option value="halloween">ðŸŽƒ Halloween</option>
            <option value="thanksgiving">ðŸ¦ƒ Thanksgiving</option>
            <option value="valentines">ðŸ’– Valentine's</option>
            <option value="stpatricks">ðŸ’š St. Patrick's</option>
            <option value="easter">ðŸ£ Easter</option>
            <option value="default">â­ Generic</option>
          </select>
        </div>
        <div>
          <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">EMOJI</label>
          <select id="holidayEmoji" style="width:100%; padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
            <option value="ðŸŽ„">ðŸŽ„</option>
            <option value="ðŸŽ†">ðŸŽ†</option>
            <option value="ðŸ‡ºðŸ‡¸">ðŸ‡ºðŸ‡¸</option>
            <option value="ðŸŽƒ">ðŸŽƒ</option>
            <option value="ðŸ¦ƒ">ðŸ¦ƒ</option>
            <option value="ðŸ’–">ðŸ’–</option>
            <option value="ðŸ’š">ðŸ’š</option>
            <option value="ðŸ£">ðŸ£</option>
            <option value="â­">â­</option>
          </select>
        </div>
        <button onclick="addHoliday()" style="grid-column: 1 / -1; background:#b37e78; color: white; border:none; border-radius:8px; padding:12px; font-weight:600; cursor: pointer; font-size:14px;">
          + Add Holiday
        </button>
      </div>
      
      <!-- Holiday List -->
      <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:12px;">SCHEDULED HOLIDAYS</label>
      <div id="holidayList" style="max-height:250px; overflow-y:auto;">
        <div style="text-align:center; color:#94a3b8; padding:20px;">Loading... </div>
      </div>
    </div>
  </div>
</div>
  <div id="profileOverlay" class="overlay" onclick="if(event.target===this) closeProfile()">
    <div class="modal" style="width: 400px;">
      <div class="mHead" style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
        <span class="mTitle">Agent Profile</span>
        <button type="button" class="btn ghost" style="padding:4px 8px;" onclick="closeProfile()">âœ•</button>
      </div>
      <div class="mBody" style="text-align: center; padding: 30px;">
        <div id="profLoader" style="color: #64748b; font-size: 13px;"><div>Fetching live metrics from Zendesk...</div></div>
        <div id="profContent" style="display:none;">
          <img id="pAvatar" src="" style="width: 80px; height: 80px; border-radius: 50%; background: #e2e8f0; margin-bottom: 15px; border: 3px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          <h2 id="pName" style="margin: 0 0 5px 0; font-size: 20px; color: #0f172a;">Name</h2>
          <div id="pEmail" style="font-size: 12px; color: #64748b; margin-bottom: 20px;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c7a2aaa6aeab87a2bfa6aab7aba2e9a4a8aa">[email&#160;protected]</a></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left;">
            <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; border: 1px solid #bae6fd;">
              <div style="font-size: 10px; font-weight: 700; color: #0369a1;">OPEN TICKETS</div>
              <div id="pTickets" style="font-size: 20px; font-weight: 800; color: #0284c7;">--</div>
            </div>
            <div style="background:#fdf2f8; padding:10px; border-radius:8px; border:1px solid #fbcfe8;">
              <div style="font-size:10px; font-weight:700; color:#be185d;">ROLE</div>
              <div id="pRole" style="font-size:14px; font-weight:800; color:#db2777;">--</div>
            </div>
          </div>
          <div style="margin-top: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; font-size: 11px; color: var(--text-secondary); text-align: center;">
            ðŸ’¡ For CSAT &amp; Solved metrics, view <a href="https://musely.zendesk.com/explore" target="_blank" style="color: var(--accent-primary);">Zendesk Explore</a>
          </div>
          <div style="margin-top: 12px; font-size: 11px; color: #94a3b8;">Last Login: <span id="pLogin">--</span></div>
          
          <!-- âœ… Logout Button -->
          <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color);">
            <button onclick="handleLogout()" style="
              background: transparent;
              color: #dc2626;
              border: 1px solid #fecaca;
              padding: 10px 20px;
              border-radius: 8px;
              font-size: 13px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              display: inline-flex;
              align-items: center;
              gap: 8px;
            " onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#dc2626';" 
               onmouseout="this.style.background='transparent'; this.style.borderColor='#fecaca';">
              ðŸšª Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="masterOverlay" class="overlay" onclick="if(event.target===this) closeMasterModal()">
    <div class="modal">
      <div class="mHead">
        <span class="mTitle">Edit Master Template</span>
        <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closeMasterModal()">âœ•</button>
      </div>
      <div class="mBody">
        <div style="margin-bottom:16px; font-size:13px; color:#64748b;" id="mstSub"></div>
        <input type="hidden" id="mstPerson">
        <input type="hidden" id="mstDay">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
          <div><label>Start Time (PST)</label><input id="mstStart" placeholder="e.g. 8:00 AM"></div>
          <div><label>End Time (PST)</label><input id="mstEnd" placeholder="e.g. 5:00 PM"></div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
          <div><label>Team</label><select id="mstTeam"></select></div>
          <div><label>Role</label><select id="mstRole"></select></div>
        </div>
        <div style="background:#f0f9ff; padding:12px; border-radius:8px; border:1px solid #bae6fd; font-size:12px; color:#0369a1; display:flex; gap:10px; align-items:start;">
          <input type="checkbox" id="mstSync" style="width:auto; margin-top:2px;">
          <span><b>Sync to LIVE Schedule?</b><br>Check this to update all future shifts starting <b>tomorrow</b>. Leave unchecked to only update the template for new generations.</span>
        </div>
      </div>
      <div class="mFoot">
        <button class="btn ghost" onclick="closeMasterModal()">Cancel</button>
        <button class="btn primary" onclick="saveMasterEdit()">Save Changes</button>
      </div>
    </div>
  </div>
  <div id="pickerOverlay" class="overlay" onclick="if(event.target===this) closePicker()">
    <div class="modal" style="width: 500px; height: 600px; display:flex; flex-direction:column;">
      <div class="mHead">
        <span class="mTitle">Filter People</span>
        <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closePicker()">âœ•</button>
      </div>
      <div style="padding:16px; border-bottom:1px solid #e2e8f0; display:flex; gap:12px;">
        <input id="pickerSearch" placeholder="Search..." oninput="renderPickerList()" style="flex:1;">
        <button class="btn ghost" onclick="pickerToggleAll(true)">All</button>
        <button class="btn ghost" onclick="pickerToggleAll(false)">None</button>
      </div>
      <div id="pickerList" class="pickerList" style="flex:1; overflow-y:auto; padding:8px;"></div>
      <div class="mFoot"><button class="btn primary" onclick="applyPicker()">Apply Filter</button></div>
    </div>
  </div>
  <!-- âœ… Admin Overlay (ONLY ONCE) -->
  <div id="adminOverlay" class="overlay overlay-admin" style="display:none;" onclick="if(event.target===this) closeAdminModal()">
    <div class="modal adminModal">
      <div class="mHead adminHead">
        <div class="adminHeadLeft">
          <div class="adminHeadIcon">âš™ï¸</div>
          <div>
            <div class="mTitle adminTitle">Admin Tools</div>
            <div class="adminSubtitle">Manage queues, balances, rules, and system actions.</div>
          </div>
        </div>
        <button type="button" class="iconClose" onclick="closeAdminModal()" aria-label="Close">âœ•</button>
      </div>

      <div class="mBody adminBody">
        <!-- Audit Log (full width) -->
        <div class="adminStrip">
          <div class="adminStripLeft">
            <div class="adminStripIcon">ðŸ§¾</div>
            <div>
              <div class="adminStripTitle">Audit Log</div>
              <div class="adminStripDesc">View history &amp; log end-of-day reports</div>
            </div>
          </div>
          <div class="adminStripActions">
            <button type="button" class="btn ghost adminBtnSm" onclick="logEndOfDaySummary()">ðŸ“ Log EOD</button>
            <button type="button" class="btn ghost adminBtnSm" onclick="openAuditLog()">View</button>
          </div>
        </div>

        <!-- Tool grid -->
        <div class="adminGrid">
          <div class="adminCard" onclick="openBalanceModal()">
            <div class="adminCardTop">
              <div class="adminIcon adminIconGreen">ðŸ’°</div>
              <div class="adminCardText">
                <div class="adminCardTitle">PTO Balance</div>
                <div class="adminCardDesc">Adjust PTO hours (incl. bulk add)</div>
              </div>
              <span class="adminChip">Manage</span>
            </div>
          </div>

          <div class="adminCard" onclick="openHolidayModal()">
            <div class="adminCardTop">
              <div class="adminIcon adminIconBlue">ðŸŽ‰</div>
              <div class="adminCardText">
                <div class="adminCardTitle">Company Holidays</div>
                <div class="adminCardDesc">Manage holiday dates</div>
              </div>
              <span class="adminChip">Edit</span>
            </div>
          </div>

          <div class="adminCard" onclick="openStaffingModal()">
            <div class="adminCardTop">
              <div class="adminIcon adminIconPurple">ðŸ›¡ï¸</div>
              <div class="adminCardText">
                <div class="adminCardTitle">Staffing Rules</div>
                <div class="adminCardDesc">Minimum agents per channel</div>
              </div>
              <span class="adminChip">Rules</span>
            </div>
          </div>

          <!-- Agents (this matches your existing function name) -->
          <div class="adminCard" onclick="openManageAgentsModal()">
            <div class="adminCardTop">
              <div class="adminIcon adminIconSlate">ðŸ‘¥</div>
              <div class="adminCardText">
                <div class="adminCardTitle">Agents</div>
                <div class="adminCardDesc">Add / edit agent access</div>
              </div>
              <span class="adminChip">Admin</span>
            </div>
          </div>

          <!-- Meeting Rotation (NEW) -->
          <div class="adminCard" onclick="openMeetingRotationModal()">
            <div class="adminCardTop">
              <div class="adminIcon adminIconOrange">ðŸ“…</div>
              <div class="adminCardText">
                <div class="adminCardTitle">Meeting Rotation</div>
                <div class="adminCardDesc">Thursday Live Chat coverage</div>
              </div>
              <span class="adminChip">Rotation</span>
            </div>
          </div>

          <!-- Weekly Assignments (NEW) -->
          <div class="adminCard" onclick="openWeeklyAssignmentsModal()">
            <div class="adminCardTop">
              <div class="adminIcon adminIconTeal">ðŸŽ¯</div>
              <div class="adminCardText">
                <div class="adminCardTitle">Weekly Assignments</div>
                <div class="adminCardDesc">Tips, Moments, Walkthroughs</div>
              </div>
              <span class="adminChip">Assign</span>
            </div>
          </div>

          <!-- Clear Event History -->
          <div class="adminCard" onclick="openClearEventsModal()">
            <div class="adminCardTop">
              <div class="adminIcon adminIconRed">ðŸ—‘ï¸</div>
              <div class="adminCardText">
                <div class="adminCardTitle">Clear Event History</div>
                <div class="adminCardDesc">Remove test data / old events</div>
              </div>
              <span class="adminChip">Clean</span>
            </div>
          </div>

        <!-- Danger Zone -->
        <div class="dangerCard">
          <div class="dangerTop">
            <div>
              <div class="dangerTitle">Danger Zone</div>
              <div class="dangerDesc">Bulk delete or regenerate schedule</div>
            </div>
            <div class="dangerActions">
              <button type="button" class="btn ghost dangerBtn" onclick="wipeFutureSchedule()">Wipe Future</button>
              <button type="button" class="btn danger dangerBtnPrimary" onclick="regenerateAllSchedule()">Regenerate</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

      </div>
      <div id="staffingModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeStaffingModal()">
  <div class="modal" style="width: 500px;">
    <div class="mHead">
      <span class="mTitle">ðŸ›¡ï¸ Staffing Requirements</span>
      <button type="button" class="btn ghost" onclick="closeStaffingModal()">âœ•</button>
    </div>
    <div class="mBody">
      <div style="background:#f8fafc; padding:16px; border-radius:8px; margin-bottom:16px; border:1px solid #e2e8f0;">
        <label>Add New Rule</label>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <select id="ruleTeam" style="flex:2;"><option value="">Select Team...</option></select>
          <select id="ruleDay" style="flex:1;">
            <option value="All">Every Day</option>
            <option value="Weekday">Mon-Fri</option>
            <option value="Weekend">Sat-Sun</option>
            <option value="Mon">Mon</option><option value="Tue">Tue</option><option value="Wed">Wed</option>
            <option value="Thu">Thu</option><option value="Fri">Fri</option><option value="Sat">Sat</option><option value="Sun">Sun</option>
          </select>
          <input id="ruleMin" type="number" placeholder="Min" style="flex:1; width:60px;">
        </div>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <select id="ruleTimeBlock" style="flex:1;">
            <option value="all">All Hours</option>
            <option value="morning">Morning (6a-12p)</option>
            <option value="afternoon">Afternoon (12p-6p)</option>
            <option value="evening">Evening (6p-10p)</option>
            <option value="custom">Custom Hours</option>
          </select>
          <input id="ruleStartHour" type="number" min="0" max="23" placeholder="Start" style="flex:1; display:none;">
          <input id="ruleEndHour" type="number" min="0" max="23" placeholder="End" style="flex:1; display:none;">
        </div>
        <button class="btn primary" style="width:100%;" onclick="addRule()">+ Save Requirement</button>
      </div>
      
      <div style="background:#fbf6f5; padding:12px; border-radius:8px; margin-bottom:16px; border:1px solid #bfdbfe;">
        <div style="font-size:11px; font-weight:700; color:#b37e78; margin-bottom:6px;">ðŸ’¡ Recommended Rules</div>
        <div style="display:flex; flex-wrap:wrap; gap:6px;">
          <button class="btn ghost" style="font-size:10px; padding:4px 8px;" onclick="addQuickRule('Live Chat', 3, 'morning')">LC 3+ (AM)</button>
          <button class="btn ghost" style="font-size:10px; padding:4px 8px;" onclick="addQuickRule('Phone', 2, 'all')">Phone 2+</button>
          <button class="btn ghost" style="font-size:10px; padding:4px 8px;" onclick="addQuickRule('MD Support', 1, 'all')">MD 1+</button>
        </div>
      </div>
      
      <label>Current Rules</label>
      <div id="ruleList" style="max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:8px;"></div>
    </div>
  </div>
</div>

  <!-- Clear Events Modal -->
  <div id="clearEventsModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeClearEventsModal()">
    <div class="modal" style="width: 520px; max-width: 92vw;">
      <div class="mHead" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); border-bottom: none;">
        <span class="mTitle" style="color: white;">ðŸ—‘ï¸ Clear Event History</span>
        <button type="button" class="btn ghost" style="color:white; background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.25); padding:6px 12px;" onclick="closeClearEventsModal()">âœ•</button>
      </div>
      <div class="mBody" style="max-height: 70vh; overflow-y: auto; padding: 20px;">

        <!-- Warning Banner -->
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px; padding: 14px 16px; margin-bottom: 20px; display: flex; gap: 12px; align-items: flex-start;">
          <span style="font-size: 22px; line-height: 1;">âš ï¸</span>
          <div>
            <div style="font-weight: 700; font-size: 13px; color: #991b1b; margin-bottom: 3px;">Caution: Permanent Deletion</div>
            <div style="font-size: 12px; color: #7f1d1d; line-height: 1.5;">This will permanently delete event history data. This action cannot be undone. Use this to clear test data or old records that are affecting attendance scores.</div>
          </div>
        </div>

        <!-- Date Filter -->
        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-primary);">
            <input type="checkbox" id="clearEventsUseDateFilter" onchange="toggleClearEventsDateFilter()" style="width: 16px; height: 16px; accent-color: #dc2626; flex-shrink: 0;">
            Only delete events before a specific date
          </label>
          <input type="date" id="clearEventsBeforeDate" class="fieldInput" style="width: 100%; display: none; margin-top: 8px; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 13px;" title="Delete only events created before this date">
        </div>

        <!-- Collections to Clear -->
        <div style="margin-bottom: 20px;">
          <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 10px;">Select data to clear:</div>
          <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden;">
            <label class="clear-events-option">
              <input type="checkbox" class="clearEventsCollection" value="time_off_requests" checked>
              <div class="clear-events-option-icon" style="background: #dbeafe;">ðŸ–ï¸</div>
              <div class="clear-events-option-text">
                <span class="clear-events-option-name">Time Off Requests</span>
                <span class="clear-events-option-desc">PTO, sick days</span>
              </div>
            </label>
            <label class="clear-events-option">
              <input type="checkbox" class="clearEventsCollection" value="swap_requests" checked>
              <div class="clear-events-option-icon" style="background: #fef3c7;">ðŸ”„</div>
              <div class="clear-events-option-text">
                <span class="clear-events-option-name">Swap Requests</span>
                <span class="clear-events-option-desc">Shift swaps</span>
              </div>
            </label>
            <label class="clear-events-option">
              <input type="checkbox" class="clearEventsCollection" value="agent_notifications">
              <div class="clear-events-option-icon" style="background: #e0e7ff;">ðŸ””</div>
              <div class="clear-events-option-text">
                <span class="clear-events-option-name">Agent Notifications</span>
                <span class="clear-events-option-desc">Alerts sent to agents</span>
              </div>
            </label>
            <label class="clear-events-option">
              <input type="checkbox" class="clearEventsCollection" value="manager_notifications">
              <div class="clear-events-option-icon" style="background: #fce7f3;">ðŸ“£</div>
              <div class="clear-events-option-text">
                <span class="clear-events-option-name">Manager Notifications</span>
                <span class="clear-events-option-desc">Alerts sent to managers</span>
              </div>
            </label>
            <label class="clear-events-option">
              <input type="checkbox" class="clearEventsCollection" value="audit_log">
              <div class="clear-events-option-icon" style="background: #f1f5f9;">ðŸ“‹</div>
              <div class="clear-events-option-text">
                <span class="clear-events-option-name">Audit Log</span>
                <span class="clear-events-option-desc">Activity history</span>
              </div>
            </label>
            <label class="clear-events-option" style="border-bottom: none;">
              <input type="checkbox" class="clearEventsCollection" value="holiday_transactions">
              <div class="clear-events-option-icon" style="background: #dcfce7;">ðŸŽ„</div>
              <div class="clear-events-option-text">
                <span class="clear-events-option-name">Holiday Transactions</span>
                <span class="clear-events-option-desc">Holiday tracking</span>
              </div>
            </label>
          </div>
        </div>

        <!-- Confirmation -->
        <div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: 10px; padding: 14px 16px; margin-bottom: 20px;">
          <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="clearEventsConfirm" style="width: 18px; height: 18px; accent-color: #dc2626; flex-shrink: 0; margin-top: 1px;">
            <span style="font-size: 13px; font-weight: 600; color: #92400e; line-height: 1.4;">I understand this will permanently delete the selected data</span>
          </label>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" class="btn ghost" onclick="closeClearEventsModal()" style="padding: 10px 20px; font-size: 13px;">Cancel</button>
          <button type="button" class="btn danger" onclick="executeClearEvents()" style="padding: 10px 20px; font-size: 13px; min-width: 160px; background: #dc2626; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            ðŸ—‘ï¸ Clear Selected Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
  .clear-events-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background 0.15s;
    user-select: none;
  }
  .clear-events-option:hover { background: var(--bg-tertiary); }
  .clear-events-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #dc2626;
    flex-shrink: 0;
  }
  .clear-events-option-icon {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .clear-events-option-text {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }
  .clear-events-option-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
  }
  .clear-events-option-desc {
    font-size: 11px;
    color: var(--text-tertiary);
    line-height: 1.3;
  }
  </style>

  <!-- âœ… Audit Overlay (sibling, not nested) -->
  <div id="auditOverlay" class="overlay" style="display:none;" onclick="if(event.target===this) closeAuditModal()">
    <div class="modal" style="width: 700px; max-width: 90vw; height: 80vh; display:flex; flex-direction:column;">
      <div class="mHead">
        <span class="mTitle">Audit History</span>
        <div style="display:flex; gap:8px; align-items:center;">
          <button type="button" class="btn ghost" style="padding:6px 12px; font-size:11px; color:#ef4444;" onclick="clearAuditHistory()" title="Clear audit history">ðŸ—‘ï¸ Clear</button>
          <button type="button" class="btn ghost" style="padding:6px 12px;" onclick="closeAuditModal()">âœ•</button>
        </div>
      </div>
      <div class="mBody" style="flex:1; overflow:hidden; padding:0; display:flex; flex-direction:column;">
        <div style="background:#fff; border-bottom:1px solid #e2e8f0; padding:10px 16px; font-size:12px; color:#64748b;">
          Showing last 50 actions. Newest first.
        </div>
        <div style="flex:1; overflow-y:auto;">
          <table class="audit-table">
            <thead>
              <tr>
                <th style="width:140px;">Time</th>
                <th style="width:120px;">Manager</th>
                <th style="width:100px;">Action</th>
                <th style="width:120px;">Target</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="auditList">
              <tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">Loading history...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Master Context -->
  <div id="masterContextOverlay" class="overlay" style="display:none; z-index:200;">
    <div class="modal" style="width: 400px;">
      <div class="mHead"><span class="mTitle">Select Manager Context</span></div>
      <div class="mBody">
        <p style="font-size:13px; color:#64748b; margin-bottom:12px;">
          You are logged in as <b>Master Admin</b>.<br>
          Please select which Manager's schedule you wish to view/manage.
        </p>
        <label>Available Managers</label>
        <select id="masterManagerDropdown" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
          <option value="" disabled selected>Loading...</option>
        </select>
      </div>
      <div class="mFoot" style="justify-content:flex-end;">
        <button type="button" class="btn primary" id="btnConfirmManager" onclick="confirmManagerSelection()">Load Dashboard</button>
      </div>
    </div>
  </div>
  
  <!-- Meeting Rotation Modal (Enhanced) -->
  <div id="meetingRotationModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeMeetingRotationModal()">
    <div class="modal" style="width: 600px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden;">
      <!-- Sticky Header -->
      <div class="mHead" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); flex-shrink: 0; position: sticky; top: 0; z-index: 10;">
        <span class="mTitle" style="color: white;">ðŸ“… Meeting Rotation</span>
        <button type="button" class="btn ghost" style="color: white; font-size: 18px; padding: 4px 10px;" onclick="closeMeetingRotationModal()">âœ•</button>
      </div>
      
      <!-- Scrollable Body -->
      <div class="mBody" style="overflow-y: auto; flex: 1; padding: 16px;">
        <!-- Quick Setup Row -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px;">
          <div>
            <label style="font-size: 11px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Type</label>
            <select id="rotationMeetingType" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-size: 12px;" onchange="onMeetingTypeChange()">
              <option value="thursday">Thursday (Weekly)</option>
              <option value="wednesday">Wednesday (Monthly)</option>
              <option value="allhands">All Hands</option>
            </select>
          </div>
          <div>
            <label style="font-size: 11px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Date</label>
            <input type="date" id="rotationDate" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-size: 12px;" onchange="loadRotationForDate()">
          </div>
          <div>
            <label style="font-size: 11px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Time (PST)</label>
            <select id="rotationTimePST" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-size: 12px;">
              <option value="12:00 PM - 1:15 PM">12:00 PM - 1:15 PM</option>
              <option value="12:45 PM - 2:00 PM">12:45 PM - 2:00 PM</option>
              <option value="4:00 PM - 5:00 PM">4:00 PM - 5:00 PM</option>
              <option value="11:00 AM - 12:00 PM">11:00 AM - 12:00 PM</option>
              <option value="1:00 PM - 2:00 PM">1:00 PM - 2:00 PM</option>
              <option value="2:00 PM - 3:00 PM">2:00 PM - 3:00 PM</option>
              <option value="3:00 PM - 4:00 PM">3:00 PM - 4:00 PM</option>
            </select>
          </div>
        </div>
        
        <!-- Hidden EST time selector -->
        <select id="rotationTimeEST" style="display: none;" onchange="convertMeetingTime()">
          <option value="3:00 PM - 4:15 PM">3:00 PM - 4:15 PM</option>
          <option value="3:45 PM - 5:00 PM">3:45 PM - 5:00 PM</option>
          <option value="7:00 PM - 8:00 PM">7:00 PM - 8:00 PM</option>
        </select>
        
        <!-- Coverage Assignment Card -->
        <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 14px; margin-bottom: 14px;">
          <div style="font-weight: 700; font-size: 13px; margin-bottom: 6px; color: var(--text-primary);">ðŸ‘¥ Live Chat Coverage During Meeting</div>
          <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; border-left: 3px solid #6366f1;">
            <div style="font-weight: 600; margin-bottom: 4px;">ðŸ“‹ Who does what:</div>
            <div>â€¢ <strong style="color: #1e40af;">LC Agents</strong> = <strong>MISS</strong> meeting (cover Live Chat)</div>
            <div>â€¢ <strong style="color: #065f46;">Backups</strong> = <strong>ATTEND</strong> meeting (set Away, jump in if busy)</div>
            <div>â€¢ <strong style="color: #92400e;">Captain</strong> = <strong>ATTEND</strong> meeting (steers ship, last resort)</div>
            <div style="margin-top: 6px; font-style: italic;">Queue priority: LC Agents â†’ Backups â†’ Captain</div>
          </div>
          
          <!-- Role Grid -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
            <!-- Captain -->
            <div style="background: #fef3c7; padding: 10px; border-radius: 8px; border-left: 3px solid #f59e0b;">
              <div style="font-size: 11px; font-weight: 600; color: #92400e; margin-bottom: 6px;">ðŸ‘¤ Captain <span style="font-weight: 400; opacity: 0.8;">(Attends - Last Resort)</span></div>
              <select id="rotationCaptain" style="width: 100%; padding: 6px 8px; border: 1px solid #fcd34d; border-radius: 4px; background: white; font-size: 12px; color: #333;">
                <option value="">-- Select --</option>
              </select>
            </div>
            
            <!-- Notes -->
            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
              <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">ðŸ“ Notes</div>
              <input type="text" id="rotationNotes" placeholder="Social Segment, Team Building..." style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); font-size: 12px; color: var(--text-primary);">
            </div>
          </div>
          
          <!-- Backups Row -->
          <div style="background: #d1fae5; padding: 10px; border-radius: 8px; border-left: 3px solid #10b981; margin-bottom: 10px;">
            <div style="font-size: 11px; font-weight: 600; color: #065f46; margin-bottom: 6px;">ðŸ”„ Backups <span style="font-weight: 400; opacity: 0.8;">(Attend Meeting - Away in Zendesk)</span></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <select id="rotationBackup1" style="width: 100%; padding: 6px 8px; border: 1px solid #6ee7b7; border-radius: 4px; background: white; font-size: 12px; color: #333;">
                <option value="">Backup #1</option>
              </select>
              <select id="rotationBackup2" style="width: 100%; padding: 6px 8px; border: 1px solid #6ee7b7; border-radius: 4px; background: white; font-size: 12px; color: #333;">
                <option value="">Backup #2</option>
              </select>
            </div>
          </div>
          
          <!-- LC Agents -->
          <div style="background: #dbeafe; padding: 10px; border-radius: 8px; border-left: 3px solid #3b82f6;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <div style="font-size: 11px; font-weight: 600; color: #1e40af;">ðŸ’¬ LC Agents <span style="font-weight: 400; opacity: 0.8;">(Miss Meeting - Cover LC)</span></div>
              <div style="display: flex; gap: 4px;">
                <select id="addLcAgentSelect" style="padding: 4px 6px; border: 1px solid #93c5fd; border-radius: 4px; background: white; font-size: 11px; color: #333; min-width: 100px;">
                  <option value="">+ Add</option>
                </select>
                <button type="button" onclick="addLcAgent()" style="padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">Add</button>
              </div>
            </div>
            <div id="lcAgentsContainer" style="display: flex; flex-wrap: wrap; gap: 4px; min-height: 24px;">
              <span style="color: #64748b; font-size: 10px; font-style: italic;">None assigned</span>
            </div>
          </div>
        </div>
        
        <!-- All Hands PTO Section (conditional) -->
        <div id="allHandsPtoSection" style="display: none; background: #fce7f3; padding: 10px; border-radius: 8px; margin-bottom: 14px; border-left: 3px solid #ec4899;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <div style="font-size: 11px; font-weight: 600; color: #9d174d;">ðŸŽ PTO Credit <span style="font-weight: 400;">(+1hr for staying late)</span></div>
            <div style="display: flex; gap: 4px;">
              <select id="addPtoAgentSelect" style="padding: 4px 6px; border: 1px solid #f9a8d4; border-radius: 4px; background: white; font-size: 11px; min-width: 100px;">
                <option value="">+ Add</option>
              </select>
              <button type="button" onclick="addPtoAgent()" style="padding: 4px 8px; background: #ec4899; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">Add</button>
            </div>
          </div>
          <div id="allHandsPtoAgents" style="display: flex; flex-wrap: wrap; gap: 4px; min-height: 24px;">
            <span style="color: #64748b; font-size: 10px; font-style: italic;">None</span>
          </div>
        </div>
        
        <!-- Collapsible Sections -->
        <details style="margin-bottom: 10px;">
          <summary style="cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-secondary); padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">ðŸ“Š Fairness Stats (who's missed most meetings)</summary>
          <div id="fairnessStats" style="padding: 10px; font-size: 11px; background: var(--bg-secondary); border-radius: 0 0 6px 6px; max-height: 150px; overflow-y: auto;">
            <div style="color: var(--text-secondary);">Loading...</div>
          </div>
        </details>
        
        <details>
          <summary style="cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-secondary); padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">ðŸ“œ Recent Rotations</summary>
          <div id="rotationHistory" style="padding: 10px; font-size: 11px; background: var(--bg-secondary); border-radius: 0 0 6px 6px; max-height: 120px; overflow-y: auto;">
            <div style="color: var(--text-secondary);">Loading...</div>
          </div>
        </details>
      </div>
      
      <!-- Sticky Footer -->
      <div class="mFoot" style="flex-shrink: 0; border-top: 1px solid var(--border-color);">
        <button type="button" class="btn ghost" onclick="closeMeetingRotationModal()">Cancel</button>
        <button type="button" class="btn primary" onclick="saveRotation()">ðŸ’¾ Save</button>
      </div>
    </div>
  </div>

  <!-- Weekly Assignments Modal (Redesigned) -->
  <div id="weeklyAssignmentsModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeWeeklyAssignmentsModal()">
    <div class="modal" style="width: 550px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden;">
      <!-- Sticky Header -->
      <div class="mHead" style="flex-shrink: 0; position: sticky; top: 0; z-index: 10;">
        <span class="mTitle">ðŸŽ¯ Weekly Assignments</span>
        <button type="button" class="btn ghost" style="font-size: 18px; padding: 4px 10px;" onclick="closeWeeklyAssignmentsModal()">âœ•</button>
      </div>
      
      <!-- Scrollable Body -->
      <div class="mBody" style="overflow-y: auto; flex: 1; padding: 16px;">
        <!-- Week Selector -->
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
          <label style="font-size: 12px; color: var(--text-secondary); white-space: nowrap;">Week of:</label>
          <input type="date" id="weeklyAssignmentDate" style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-size: 12px;" onchange="loadWeeklyAssignments()">
        </div>
        
        <!-- LC Sync Presentations Section -->
        <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 14px; margin-bottom: 14px;">
          <div style="font-weight: 700; font-size: 12px; margin-bottom: 12px; color: var(--text-primary);">ðŸŽ¤ LC Sync Presentations</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <!-- LC Team Member Tips (presented during LC Syncs) -->
            <div style="background: #dbeafe; padding: 10px; border-radius: 8px; border: 1px solid #93c5fd; border-left: 3px solid #3b82f6;">
              <div style="font-size: 10px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">ðŸ“¢ LC Team Member Tips</div>
              <div style="font-size: 9px; color: #64748b; margin-bottom: 6px; font-style: italic;">Presented during LC Syncs</div>
              <select id="weeklyLcTips1" style="width: 100%; padding: 6px; border: 1px solid #93c5fd; border-radius: 4px; background: white; font-size: 11px; color: #333; margin-bottom: 4px;">
                <option value="">Person 1</option>
              </select>
              <select id="weeklyLcTips2" style="width: 100%; padding: 6px; border: 1px solid #93c5fd; border-radius: 4px; background: white; font-size: 11px; color: #333;">
                <option value="">Person 2</option>
              </select>
            </div>
            
            <!-- Team Member Tips (regular tips) -->
            <div style="background: #fef3c7; padding: 10px; border-radius: 8px; border: 1px solid #fcd34d; border-left: 3px solid #f59e0b;">
              <div style="font-size: 10px; font-weight: 600; color: #92400e; margin-bottom: 4px;">ðŸŽ¤ Team Member Tips</div>
              <div style="font-size: 9px; color: #64748b; margin-bottom: 6px; font-style: italic;">Regular meeting tips</div>
              <select id="weeklyTips1" style="width: 100%; padding: 6px; border: 1px solid #fcd34d; border-radius: 4px; background: white; font-size: 11px; color: #333; margin-bottom: 4px;">
                <option value="">Person 1</option>
              </select>
              <select id="weeklyTips2" style="width: 100%; padding: 6px; border: 1px solid #fcd34d; border-radius: 4px; background: white; font-size: 11px; color: #333;">
                <option value="">Person 2</option>
              </select>
            </div>
            
            <!-- Moments That Made Me Smile (single person) -->
            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
              <div style="font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">ðŸ˜Š Moments That Made Me Smile</div>
              <select id="weeklyMoments" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); font-size: 11px; color: var(--text-primary);">
                <option value="">-- Select --</option>
              </select>
            </div>
            
            <!-- Ticket Walkthroughs -->
            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
              <div style="font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">ðŸŽ« Ticket Walkthroughs</div>
              <select id="weeklyWalkthroughs" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); font-size: 11px; color: var(--text-primary);">
                <option value="">-- Select --</option>
              </select>
            </div>
            
            <!-- CSAT Workshop -->
            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); grid-column: span 2;">
              <div style="font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">ðŸ“ˆ CSAT Workshop</div>
              <select id="weeklyCsatWorkshop" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); font-size: 11px; color: var(--text-primary);">
                <option value="">-- Select --</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Team Building -->
        <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 14px; margin-bottom: 14px;">
          <div style="font-weight: 700; font-size: 12px; margin-bottom: 10px; color: var(--text-primary);">ðŸ—ï¸ Team Building</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">Lead</div>
              <select id="weeklyTeamBuilding" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); font-size: 11px; color: var(--text-primary);">
                <option value="">-- Select --</option>
              </select>
            </div>
            <div>
              <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">Volunteer</div>
              <select id="weeklyVolunteer" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); font-size: 11px; color: var(--text-primary);">
                <option value="">-- Select --</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Special Events -->
        <div style="margin-bottom: 14px;">
          <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">ðŸ“† Special Events This Week</div>
          <input type="text" id="weeklyEvents" placeholder="e.g., Thursday & All Hands, Social Segment" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); font-size: 12px; color: var(--text-primary);">
        </div>
        
        <!-- History (Collapsible) -->
        <details>
          <summary style="cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-secondary); padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">ðŸ“œ Recent Weeks</summary>
          <div id="weeklyAssignmentHistory" style="padding: 10px; font-size: 11px; background: var(--bg-secondary); border-radius: 0 0 6px 6px; max-height: 100px; overflow-y: auto;">
            <div style="color: var(--text-secondary);">Loading...</div>
          </div>
        </details>
      </div>
      
      <!-- Sticky Footer -->
      <div class="mFoot" style="flex-shrink: 0; border-top: 1px solid var(--border-color);">
        <button type="button" class="btn ghost" onclick="closeWeeklyAssignmentsModal()">Cancel</button>
        <button type="button" class="btn primary" onclick="saveWeeklyAssignments()">ðŸ’¾ Save</button>
      </div>
    </div>
  </div>

  <!-- âœ… Notifications Panel (NOT inside any overlay/div) -->
  <div id="notifPanel"
       style="display:none; position:fixed; top:74px; right:20px; width:360px; background:#fff; border:1px solid #e2e8f0; box-shadow:0 10px 25px rgba(0,0,0,0.1); border-radius:16px; z-index:3001; overflow:hidden;"
       onclick="event.stopPropagation()">
    <div class="mHead">
      <span class="mTitle">Notifications</span>
      <div style="display:flex; gap:8px;">
        <button type="button" class="btn ghost" style="padding:4px 8px; font-size:11px;" onclick="loadPendingNotifications()" title="Refresh">ðŸ”„</button>
        <button type="button" class="btn ghost" style="padding:4px 8px; font-size:11px;" onclick="clearNotifications()">Clear</button>
        <button type="button" class="btn primary" style="padding:4px 8px; font-size:11px;" onclick="sendAllPending()">Send</button>
      </div>
    </div>
    <div id="notifList" style="max-height:300px; overflow-y:auto; padding:10px;"></div>
  </div>
  <div id="toastHost"></div>
  <div id="loader" class="hidden"></div>
  <!-- My Profile / Balance Modal -->
<div id="balanceModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeBalanceModal()">
  <div class="modal" style="width: 550px; max-height: 90vh; display: flex; flex-direction: column;">
    <div class="mHead" style="background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%); border-bottom: none; flex-shrink: 0;">
      <span id="balanceModalTitle" class="mTitle" style="color: white;">ðŸ‘¤ My Profile</span>
      <button type="button" class="btn ghost" style="padding:6px 12px; color:white; background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.25);" onclick="closeBalanceModal()">âœ•</button>
    </div>
    
    <div class="mBody" style="flex: 1; overflow-y: auto; max-height: calc(90vh - 60px);">
      <!-- Agent View - My Profile Dashboard -->
      <div id="agentBalanceView" style="display:none;">
        <!-- PTO Balance Card -->
        <div class="profile-section">
          <div class="profile-section-header">
            <span class="section-icon">ðŸ–ï¸</span>
            <span class="section-title">Time Off Balance</span>
          </div>
          <div class="agent-pto-hero">
            <div class="pto-ring">
              <svg viewBox="0 0 100 100">
                <circle class="pto-ring-bg" cx="50" cy="50" r="45"/>
                <circle class="pto-ring-fill" cx="50" cy="50" r="45" id="ptoRingFill"/>
              </svg>
              <div class="pto-ring-content">
                <div class="pto-value" id="agentPtoBalance">--</div>
                <div class="pto-label">hours</div>
              </div>
            </div>
            <div class="pto-hero-info">
              <div class="pto-hero-title">Available PTO</div>
              <div class="pto-hero-subtitle">Use the "Request Time Off" button in the toolbar</div>
            </div>
          </div>
        </div>
        
        <!-- Zendesk Performance Section -->
        <div class="profile-section">
          <div class="profile-section-header">
            <span class="section-icon">ðŸ“Š</span>
            <span class="section-title">Open Tickets</span>
          </div>
          <!-- Open tickets count with clickable list -->
          <div id="agentTicketsContainer">
            <div class="agent-stat-card" style="flex-direction: column; align-items: stretch;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div class="agent-stat-icon" style="background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%); width: 40px; height: 40px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                </div>
                <div>
                  <div class="agent-stat-value" id="agentZendeskOpens" style="font-size: 24px;">--</div>
                  <div class="agent-stat-label">Open Tickets</div>
                </div>
              </div>
              <!-- Clickable ticket list -->
              <div id="agentTicketsList" style="max-height: 200px; overflow-y: auto; display: none;">
                <!-- Populated by JS -->
              </div>
              <div id="agentTicketsLoading" style="text-align: center; color: var(--text-secondary); font-size: 12px; padding: 8px;">
                Loading tickets...
              </div>
              <div id="agentTicketsEmpty" style="text-align: center; color: var(--text-tertiary); font-size: 12px; padding: 8px; display: none;">
                ðŸŽ‰ No open tickets!
              </div>
            </div>
          </div>
          <div style="margin-top: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; font-size: 11px; color: var(--text-secondary);">
            ðŸ’¡ <strong>Tip:</strong> For detailed metrics (CSAT, solved by hour), check <a href="https://musely.zendesk.com/explore" target="_blank" style="color: var(--accent-primary);">Zendesk Explore</a>
          </div>
        </div>
        
        <!-- Schedule Stats -->
        <div class="profile-section">
          <div class="profile-section-header">
            <span class="section-icon">ðŸ“…</span>
            <span class="section-title">Schedule Overview</span>
          </div>
          <div class="agent-stats-grid">
            <div class="agent-stat-card">
              <div class="agent-stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
              <div class="agent-stat-info">
                <div class="agent-stat-value" id="agentNextShift">--</div>
                <div class="agent-stat-label">Next Shift</div>
              </div>
            </div>
            <div class="agent-stat-card">
              <div class="agent-stat-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
              </div>
              <div class="agent-stat-info">
                <div class="agent-stat-value" id="agentUpcomingShifts">--</div>
                <div class="agent-stat-label">Shifts This Week</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Weekly Assignments Section (for agents) -->
        <div class="profile-section" id="agentWeeklyAssignmentsSection" style="display: none;">
          <div class="profile-section-header">
            <span class="section-icon">ðŸŽ¯</span>
            <span class="section-title">Your Assignments</span>
          </div>
          <div id="agentWeeklyAssignments" style="font-size: 13px;">
            <div style="color: var(--text-secondary);">Loading...</div>
          </div>
        </div>
        
        <!-- Thursday Rotation Section (for agents covering) -->
        <div class="profile-section" id="agentRotationSection" style="display: none;">
          <div class="profile-section-header">
            <span class="section-icon">ðŸ“…</span>
            <span class="section-title">Thursday Meeting Coverage</span>
          </div>
          <div id="agentRotationInfo" style="font-size: 13px; padding: 10px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; color: #92400e;">
            <div style="color: var(--text-secondary);">Loading...</div>
          </div>
        </div>
        
        <!-- Goals & Performance Section (NEW - Integrated) -->
        <div class="profile-section" id="agentGoalsProfileSection">
          <div class="profile-section-header" style="cursor: pointer;" onclick="toggleProfileGoalsSection()">
            <span class="section-icon">ðŸŽ¯</span>
            <span class="section-title">My Goals & Performance</span>
            <span id="profileGoalsToggle" style="margin-left: auto; font-size: 12px; color: var(--text-tertiary);">â–¼ Expand</span>
          </div>
          <div id="profileGoalsContent" style="display: none; margin-top: 12px;">
            <div id="profileGoalsLoading" style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
              Loading your goals...
            </div>
            <div id="profileGoalsData" style="display: none;">
              <!-- S.M.A.R.T. Goals Summary -->
              <div id="profileSmartGoals" style="margin-bottom: 16px;"></div>
              
              <!-- Tasks Summary -->
              <div id="profileTasks" style="margin-bottom: 16px;"></div>
              
              <!-- Performance Metrics -->
              <div id="profilePerformance" style="margin-bottom: 16px;"></div>
              
              <!-- QA'd Tickets Summary -->
              <div id="profileQATickets" style="margin-bottom: 16px;"></div>
              
              <!-- 1:1 Notes Summary -->
              <div id="profileOneOnOne" style="margin-bottom: 16px;"></div>
              
              <!-- Last Updated Info -->
              <div id="profileGoalsMeta" style="font-size: 11px; color: var(--text-tertiary); text-align: right; padding-top: 8px; border-top: 1px solid var(--border-color);">
                Last updated: Never
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sign Out Section -->
        <div class="profile-section" style="margin-top: 8px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
          <button onclick="handleLogout()" class="sign-out-btn">
            ðŸšª Sign Out
          </button>
        </div>
      </div>
      
      <!-- Manager View -->
      <div id="managerBalanceView" style="display:none;">
        <div class="balanceTopRow">
  <input type="text" id="balanceSearch" class="fieldInput" placeholder="Search agentâ€¦" oninput="renderBalanceList()" />
  <button type="button" class="btn ghost" onclick="openBulkPtoModal()" title="Bulk add PTO to all agents">âž• Bulk Add</button>
</div>
<div class="bulkHint">Tip: use <strong>Bulk Add</strong> for team meetings, company events, or bonus time.</div>

        
        <div id="balanceList" style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
          <!-- Will be populated by JS -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bulk PTO Modal -->
<div id="bulkPtoModal" class="overlay overlay-sub" style="display:none;" onclick="if(event.target===this) closeBulkPtoModal()">
  <div class="modal bulkModal">
    <div class="mHead bulkHead">
      <div class="bulkHeadLeft">
        <div class="bulkHeadIcon">âž•</div>
        <div>
          <div class="mTitle" style="color:white;">Bulk Add PTO</div>
          <div class="bulkSubtitle">Add the same hours to every active agent.</div>
        </div>
      </div>
      <button type="button" class="iconClose light" onclick="closeBulkPtoModal()" aria-label="Close">âœ•</button>
    </div>

    <div class="mBody bulkBody">
      <div class="bulkInfo">
        <div class="bulkInfoTitle">Heads up</div>
        <div class="bulkInfoText">This will update each agentâ€™s PTO balance and log an audit entry.</div>
      </div>

      <div class="bulkForm">
        <div class="bulkRow">
          <label class="fieldLabel" for="bulkPtoHours">Hours to add</label>
          <input id="bulkPtoHours" type="number" min="0.25" step="0.25" value="1" class="fieldInput" />
        </div>

        <div class="bulkRow">
          <label class="fieldLabel" for="bulkPtoReason">Reason (optional)</label>
          <input id="bulkPtoReason" type="text" placeholder="e.g., Team meeting" class="fieldInput" />
        </div>

        <div class="bulkMeta">
          <span>Applies to: <strong id="bulkPtoAgentCount">0</strong> agents</span>
        </div>

        <div class="bulkActions">
          <button type="button" class="btn ghost" onclick="closeBulkPtoModal()">Cancel</button>
          <button type="button" class="btn primary" onclick="applyBulkPto()">Add to all</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Agent Overlay - REDESIGNED -->
<div id="agentOverlay" class="overlay" style="display:none;" onclick="if(event.target===this) closeAgentModal()">
  <div class="modal agent-shift-modal">
    <!-- Modern Header -->
    <div class="agent-modal-header">
      <div class="agent-modal-header-content">
        <div class="agent-modal-icon">ðŸ“…</div>
        <div>
          <div class="agent-modal-title">Shift Details</div>
          <div class="agent-modal-subtitle">Manage your upcoming shift</div>
        </div>
      </div>
      <button type="button" class="agent-modal-close" onclick="closeAgentModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div class="agent-modal-body">
      <!-- Shift Info Card -->
      <div class="shift-info-card" id="agShiftDetailsCard">
        <div class="shift-info-date" id="agShiftDate">--</div>
        <div class="shift-info-time" id="agShiftTime">--</div>
        <div class="shift-info-team" id="agShiftTeam">--</div>
      </div>
      
      <!-- Action Buttons -->
      <div id="agActionSelect" class="agent-action-list">
        <button class="agent-shift-action" onclick="showAgentForm('swap')">
          <div class="action-icon-wrapper swap">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 3l4 4-4 4"/>
              <path d="M20 7H4"/>
              <path d="M8 21l-4-4 4-4"/>
              <path d="M4 17h16"/>
            </svg>
          </div>
          <div class="action-content">
            <div class="action-title">Swap or Give Away</div>
            <div class="action-desc">Trade this shift with a teammate</div>
          </div>
          <svg class="action-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </button>
        
        <!-- Info hint about time off -->
        <div class="shift-modal-hint">
          <span class="hint-icon">ðŸ’¡</span>
          <span class="hint-text">Need time off? Use the <strong>"Request Time Off"</strong> button in the toolbar above your schedule.</span>
        </div>
      </div>
      
      <!-- Swap Form (Hidden by Default) -->
      <div id="agFormSwap" style="display:none;" class="agent-form-section">
        <div class="form-group">
          <label class="form-label">Select Teammate</label>
          <select id="agSwapPerson" class="form-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Add a Note (Optional)</label>
          <input type="text" id="agSwapNote" placeholder="e.g., Thanks for covering!" class="form-input">
        </div>
        <div class="form-actions">
          <button class="btn-back" onclick="resetAgentModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Back
          </button>
          <button class="btn-submit" onclick="submitSwap()">
            Send Request
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
      </div>
    
      <!-- Time Off Form (Hidden by Default) -->
      <div id="agFormTimeOff" style="display:none; animation: slideIn 0.3s ease;">
        
        <!-- Compact PTO Balance Display - Single Column -->
        <div style="display:flex; justify-content:center; margin-bottom:16px;">
          <div style="text-align:center; padding:14px 32px; background:linear-gradient(135deg, #faf5f4 0%, #f0e6e4 100%); border-radius:12px; border:2px solid #86efac;">
            <div style="font-size:10px; font-weight:700; color:#15803d; text-transform:uppercase; letter-spacing:0.5px;">PTO Balance</div>
            <div id="agPtoHours" style="font-size:28px; font-weight:900; color:#16a34a;">--</div>
            <div style="font-size:10px; color:#22c55e;">hours available</div>
          </div>
        </div>
        <!-- Type Selection - Compact Cards -->
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">Type</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <label class="type-card" onclick="this.querySelector('input').checked=true; updateTypeSelection();" style="display:flex; align-items:center; gap:10px; padding:12px; border:2px solid #b37e78; border-radius:10px; cursor:pointer; background:#fbf6f5; transition:all 0.2s;">
              <input type="radio" name="timeOffType" value="Make Up" checked style="width:16px; height:16px; accent-color:#b37e78;" onchange="updateTypeSelection()">
              <div>
                <div style="font-size:13px; font-weight:600; color:#1e293b;">ðŸ”„ MAKE UP</div>
                <div style="font-size:10px; color:#64748b;">Work another time</div>
              </div>
            </label>
            <label class="type-card" onclick="this.querySelector('input').checked=true; updateTypeSelection();" style="display:flex; align-items:center; gap:10px; padding:12px; border:2px solid #e2e8f0; border-radius:10px; cursor:pointer; background:#fff; transition:all 0.2s;">
              <input type="radio" name="timeOffType" value="PTO" style="width:16px; height:16px; accent-color:#16a34a;" onchange="updateTypeSelection()">
              <div>
                <div style="font-size:13px; font-weight:600; color:#1e293b;">ðŸ”¥ USE PTO</div>
                <div style="font-size:10px; color:#64748b;">Deduct hours</div>
              </div>
            </label>
          </div>
        </div>
        <!-- Make Up Date(s) - supports multiple dates -->
        <div id="agMakeUpWrap" style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase;">Make Up Date(s)</label>
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="date" id="agMakeUpDate" style="flex:1; padding:10px 12px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px; box-sizing:border-box;">
            <button type="button" onclick="addMakeUpDate()" style="padding: 10px 16px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">+ Add</button>
          </div>
          <div id="makeUpDatesList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
          <div style="font-size: 10px; color: #94a3b8; margin-top: 6px;">ðŸ’¡ Add multiple dates if you need to spread make-up time across several days</div>
        </div>
        <!-- Reason -->
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase;">Reason</label>
          <input type="text" id="agToReason" placeholder="e.g., Sick, Appointment..." style="width:100%; padding:10px 12px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px; box-sizing:border-box;">
        </div>
        <!-- Actions -->
        <div style="display:flex; gap:10px;">
          <button class="btn ghost" onclick="resetAgentModal()" style="flex:1; padding:12px;">â† Back</button>
          <button onclick="submitTimeOff()" style="flex:2; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; border:none; border-radius:10px; padding:12px; font-weight:700; cursor:pointer;">
            Submit Request â†’
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</div>
<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    SCHEDULING MANAGER APP                        â•‘
// â•‘                  INDEX OF SECTIONS (Ctrl+F)                      â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘  [SECTION 1]  CONFIGURATION (CHANNEL_CONFIG, CHANNEL_ABBREV)     â•‘
// â•‘  [SECTION 2]  AUTHENTICATION (handleSignIn, saveAuthSession)     â•‘
// â•‘  [SECTION 3]  DARK MODE (initDarkMode, toggleDarkMode)           â•‘
// â•‘  [SECTION 4]  UTILITIES (pstISODate, formatTime, escapeHtml)     â•‘
// â•‘  [SECTION 5]  CACHE (getCachedData, setCachedData)               â•‘
// â•‘  [SECTION 6]  PRESENCE (sendManagerHeartbeat, fetchPresence)     â•‘
// â•‘  [SECTION 7]  INIT & LOAD (window.onload, load, loadSystemData)  â•‘
// â•‘  [SECTION 8]  RENDERING (renderView, renderScheduleView)         â•‘
// â•‘  [SECTION 9]  COVERAGE (renderCoverageDashboard, loadRules)      â•‘
// â•‘  [SECTION 10] SHIFTS (deleteShift, saveShift, markTimeOff)       â•‘
// â•‘  [SECTION 11] TIME OFF (submitTimeOff, openFutureTimeOffModal)   â•‘
// â•‘  [SECTION 12] NOTIFICATIONS (toggleNotifPanel, sendAllPending)   â•‘
// â•‘  [SECTION 13] MASTER SCHEDULE (renderMasterView, masterApply)    â•‘
// â•‘  [SECTION 14] METRICS (renderMetricsView, fetchAgentStats)       â•‘
// â•‘  [SECTION 15] AGENT MODE (loadAgentNotifications, respondSwap)   â•‘
// â•‘  [SECTION 16] ADMIN (openAdminModal, wipeFutureSchedule)         â•‘
// â•‘  [SECTION 17] FILTERS (applyLocalFilters, filterTeam)            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHANNEL_CONFIG = {
  // hours: [StartHour, EndHour] in 24h format (e.g., 8am-4pm is [8, 16])
  // minStaff: Default minimum staff, statusInterval: Hours between status updates
  "Live Chat":       { abbrev: "LC",    color: "#b3a6d5", border: "#9688c2", text: "#351d77", hours: [8, 16], minStaff: 3, statusInterval: 2 },
  "LiveChat":        { abbrev: "LC",    color: "#b3a6d5", border: "#9688c2", text: "#351d77", hours: [8, 16], minStaff: 3, statusInterval: 2 },
  
  "Phone":           { abbrev: "Phone", color: "#a1c3c8", border: "#7ea9b0", text: "#135062", hours: [6, 20], minStaff: 2, statusInterval: 2 },
  "Phone Support":   { abbrev: "Phone", color: "#a1c3c8", border: "#7ea9b0", text: "#135062", hours: [6, 20], minStaff: 2, statusInterval: 2 },
  "PhoneSupport":    { abbrev: "Phone", color: "#a1c3c8", border: "#7ea9b0", text: "#135062", hours: [6, 20], minStaff: 2, statusInterval: 2 },
  "Socials":         { abbrev: "SS",    color: "#f8ca9b", border: "#e5b078", text: "#b35f16", hours: [8, 17], minStaff: 1, statusInterval: 3 },
  "Disputes":        { abbrev: "Dis",   color: "#d0b0ad", border: "#b89490", text: "#4c1130", hours: [8, 17], minStaff: 1, statusInterval: 2 },
  "MD Support":      { abbrev: "MD",    color: "#a3c1f3", border: "#7ba3e8", text: "#2655cb", hours: [8, 17], minStaff: 1, statusInterval: 3 },
  "MDSupport":       { abbrev: "MD",    color: "#a3c1f3", border: "#7ba3e8", text: "#2655cb", hours: [8, 17], minStaff: 1, statusInterval: 3 },
  "Defcon":          { abbrev: "DEF",   color: "#fca5a5", border: "#f87171", text: "#991b1b", hours: [8, 17], minStaff: 1, statusInterval: 2 },
  
  // Default others to 8-5 if unsure
  "Floater":         { abbrev: "Float", color: "#fee498", border: "#ecd07a", text: "#7f692a", hours: [8, 17], minStaff: 1, statusInterval: 2 },
  "Email/Floater":   { abbrev: "Float", color: "#fee498", border: "#ecd07a", text: "#7f692a", hours: [8, 17], minStaff: 1, statusInterval: 2 },
  "Lunch":           { abbrev: "ðŸ½ï¸",   color: "#dcfce7", border: "#86efac", text: "#166534", hours: [0, 24], minStaff: 0, statusInterval: 0, isBreak: true },
  "Projects":        { abbrev: "Proj",  color: "#e9d0db", border: "#d4b0c0", text: "#8c1b47", hours: [8, 17], minStaff: 1, statusInterval: 3 },
  "1:1 Meeting":     { abbrev: "1:1",   color: "#adbaf1", border: "#8e9de0", text: "#20175c", hours: [8, 17], minStaff: 0, statusInterval: 0, isBreak: true },
  "1:1 Meetings":    { abbrev: "1:1",   color: "#adbaf1", border: "#8e9de0", text: "#20175c", hours: [8, 17], minStaff: 0, statusInterval: 0, isBreak: true },
  // Generic Meeting (not 1:1 specific)
  "Meeting":         { abbrev: "MTG",   color: "#c4b5fd", border: "#a78bfa", text: "#4c1d95", hours: [8, 17], minStaff: 0, statusInterval: 0, isBreak: true },
  "Meetings":        { abbrev: "MTG",   color: "#c4b5fd", border: "#a78bfa", text: "#4c1d95", hours: [8, 17], minStaff: 0, statusInterval: 0, isBreak: true },
  // Custom/Other channel (teal color)
  "Custom":          { abbrev: "CUST",  color: "#99f6e4", border: "#5eead4", text: "#8f5f5a", hours: [8, 17], minStaff: 0, statusInterval: 0 },
  "Other":           { abbrev: "Other", color: "#e2e8f0", border: "#cbd5e1", text: "#475569", hours: [8, 17], minStaff: 0, statusInterval: 0 }
};
const CHANNEL_ABBREV = {
  "Live Chat": "LC",
  "LiveChat": "LC",
  "Phone": "Phone",
  "Phone Support": "Phone",
  "PhoneSupport": "Phone",
  "Socials": "SS",
  "MD Support": "MD",
  "MDSupport": "MD",
  "Disputes": "Dis",
  "Floater": "Float",
  "EmailFloater": "Float",
  "Email/Floater": "Float",
  "Lunch": "Lunch",
  "Projects": "Proj",
  "ReportingProjects": "Proj",
  "1: 1 Meetings": "1:1",
  "1:1s Meetings": "1:1",
  "11Meetings": "1:1",
  "Meeting": "MTG",
  "Meetings": "MTG",
  "Custom": "CUST",
  "Other": "Other"
};
  const $ = (id) => document.getElementById(id);
  // ============================================
  // [SECTION 2] AUTHENTICATION
  // ============================================
  async function handleSignIn(response) {
  console.log("Sign-in response received");
  
  try {
    const res = await fetch('/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ credential: response.credential })
    });
    
    const data = await res.json();
    
    if (data.error) {
      console.error("Auth error:", data.error);
      toast("Access Denied: " + data.error, "error");
      return;
    }
    
    // Set global identity
    window._myEmail = data.userEmail;
    window._myName = data.matchedPerson;
    window._isManager = data.isManager;
    window._currentUser = data.matchedPerson;
    
    console.log(`Signed in as: ${window._myName}, Manager: ${window._isManager}`);
    
    // âœ… Save auth session to cache
    saveAuthSession(data.userEmail, data.matchedPerson, data.isManager);
    
    // âœ… Remove auth-pending to reveal the app
    document.body.classList.remove("auth-pending");
    
    // Show fresh login indicator
    showSessionIndicator(false);
    
    // Hide the login button after successful sign-in
    const loginContainer = document.getElementById("authLoginContainer");
    if (loginContainer) loginContainer.style.display = "none";
    
    // Now load the dashboard
    load();
    
  } catch (err) {
    console.error("Sign-in failed:", err);
    toast("Sign-in failed", "error");
  }
}
// Expose to global scope IMMEDIATELY
window.handleSignIn = handleSignIn;
  // ============================================
// CLIENT-SIDE CACHE CONFIGURATION
// ============================================
const CACHE_CONFIG = {
  SCHEDULE_KEY: 'musely_schedule_cache',
  METADATA_KEY: 'musely_metadata_cache',
  TTL: 10 * 60 * 1000,  // 10 minutes in milliseconds (increased from 5)
  VERSION: '1.1'       // Increment to invalidate old caches
};

// ============================================
// SESSION PERSISTENCE (Enhanced - 8 hour auth cache)
// ============================================
// Note: Session data is stored in localStorage without encryption.
// This is acceptable because:
// 1. Server still validates all requests with preview key
// 2. Session TTL is 8 hours but refreshes on activity
// 3. No passwords or tokens are stored
// 4. Only caches display name, email, and role flag
// For higher security requirements, consider using httpOnly cookies
const SESSION_CONFIG = {
  KEY: 'musely_auth_session',
  BACKUP_KEY: 'musely_auth_session_backup', // Backup in sessionStorage
  TTL: 8 * 60 * 60 * 1000, // 8 hours in milliseconds
  WARNING_THRESHOLD: 30 * 60 * 1000, // Warn 30 min before expiry
  VERSION: '1.1' // Incremented for new format
};

// Session activity tracker
let _lastActivityTime = Date.now();
let _sessionWarningShown = false;

function saveAuthSession(email, name, isManager) {
  const sessionData = {
    email,
    name,
    isManager,
    timestamp: Date.now(),
    lastActivity: Date.now(),
    version: SESSION_CONFIG.VERSION,
    cached: true
  };
  try {
    // Save to localStorage (persists across browser sessions)
    localStorage.setItem(SESSION_CONFIG.KEY, JSON.stringify(sessionData));
    // Also save to sessionStorage as backup (survives refresh, cleared on tab close)
    sessionStorage.setItem(SESSION_CONFIG.BACKUP_KEY, JSON.stringify(sessionData));
    console.log('âœ… Auth session saved to cache');
  } catch (err) {
    console.warn('Failed to save auth session:', err);
  }
}

// âœ… NEW: Refresh session timestamp on user activity
function refreshSessionTimestamp() {
  try {
    const raw = localStorage.getItem(SESSION_CONFIG.KEY);
    if (!raw) return;
    
    const data = JSON.parse(raw);
    data.lastActivity = Date.now();
    
    localStorage.setItem(SESSION_CONFIG.KEY, JSON.stringify(data));
    sessionStorage.setItem(SESSION_CONFIG.BACKUP_KEY, JSON.stringify(data));
    
    _lastActivityTime = Date.now();
    _sessionWarningShown = false; // Reset warning flag on activity
    
    console.log('ðŸ”„ Session timestamp refreshed');
  } catch (err) {
    console.warn('Failed to refresh session timestamp:', err);
  }
}

function loadAuthSession() {
  try {
    // Try localStorage first
    let raw = localStorage.getItem(SESSION_CONFIG.KEY);
    
    // If localStorage is empty, try sessionStorage backup
    if (!raw) {
      raw = sessionStorage.getItem(SESSION_CONFIG.BACKUP_KEY);
      if (raw) {
        console.log('ðŸ“¦ Restoring session from backup');
        localStorage.setItem(SESSION_CONFIG.KEY, raw);
      }
    }
    
    if (!raw) return null;

    const data = JSON.parse(raw);
    
    // Check version - graceful migration
    if (data.version !== SESSION_CONFIG.VERSION) {
      // Try to migrate old session format
      if (data.email && data.name && data.version === '1.0') {
        console.log('ðŸ”„ Migrating session to new version');
        data.version = SESSION_CONFIG.VERSION;
        data.lastActivity = data.timestamp;
        localStorage.setItem(SESSION_CONFIG.KEY, JSON.stringify(data));
      } else {
        console.log('Session cache version mismatch, clearing...');
        clearAuthSession();
        return null;
      }
    }

    // Check TTL based on last activity (not original login time)
    const activityAge = Date.now() - (data.lastActivity || data.timestamp);
    if (activityAge > SESSION_CONFIG.TTL) {
      console.log('Session cache expired due to inactivity, clearing...');
      showSessionExpiredNotification();
      clearAuthSession();
      return null;
    }
    
    // Check if session is about to expire (within warning threshold)
    const timeRemaining = SESSION_CONFIG.TTL - activityAge;
    if (timeRemaining < SESSION_CONFIG.WARNING_THRESHOLD && !_sessionWarningShown) {
      showSessionExpiryWarning(timeRemaining);
    }

    console.log(`âœ… Loaded cached session (activity age: ${Math.floor(activityAge / 1000)}s, ${Math.floor(timeRemaining / 60000)}min remaining)`);
    return data;
  } catch (err) {
    console.warn('Failed to load auth session:', err);
    clearAuthSession();
    return null;
  }
}

function clearAuthSession() {
  try {
    localStorage.removeItem(SESSION_CONFIG.KEY);
    sessionStorage.removeItem(SESSION_CONFIG.BACKUP_KEY);
    console.log('ðŸ—‘ï¸ Auth session cleared');
  } catch (err) {
    console.warn('Failed to clear auth session:', err);
  }
}

// âœ… NEW: Handle explicit user logout
function handleLogout() {
  // Clear auth session
  clearAuthSession();
  
  // Clear schedule caches
  if (typeof clearScheduleCache === 'function') {
    clearScheduleCache();
  }
  
  // Clear global identity
  window._myEmail = null;
  window._myName = null;
  window._isManager = null;
  window._currentUser = null;
  
  // Show logout confirmation
  toast("âœ… Signed out successfully", "success");
  
  // Close profile modal if open
  const profileOverlay = document.getElementById('profileOverlay');
  if (profileOverlay) profileOverlay.style.display = 'none';
  
  // Show login screen
  document.body.classList.add("auth-pending");
  const loginContainer = document.getElementById("authLoginContainer");
  if (loginContainer) loginContainer.style.display = "flex";
  
  // Reload page after a brief delay
  setTimeout(() => {
    window.location.reload();
  }, 500);
}
window.handleLogout = handleLogout;

// âœ… NEW: Show warning before session expires
function showSessionExpiryWarning(timeRemaining) {
  _sessionWarningShown = true;
  const minutes = Math.ceil(timeRemaining / 60000);
  
  const warning = document.createElement('div');
  warning.id = 'sessionWarning';
  warning.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    z-index: 9999;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease-out;
  `;
  warning.innerHTML = `
    <span>â° Session expires in ${minutes} minutes</span>
    <button onclick="refreshSessionTimestamp(); this.parentElement.remove(); toast('Session extended!', 'success');" 
      style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
             color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
      Extend
    </button>
  `;
  
  // Remove any existing warning
  const existing = document.getElementById('sessionWarning');
  if (existing) existing.remove();
  
  document.body.appendChild(warning);
}

// âœ… NEW: Show notification when session expires
function showSessionExpiredNotification() {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 24px 32px;
    background: white;
    border-radius: 16px;
    font-size: 14px;
    z-index: 10000;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    text-align: center;
    max-width: 400px;
  `;
  notification.innerHTML = `
    <div style="font-size: 48px; margin-bottom: 16px;">ðŸ”</div>
    <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: #1a1a1a;">Session Expired</div>
    <div style="color: #666; margin-bottom: 20px;">Your session has expired due to inactivity. Please sign in again to continue.</div>
    <button onclick="this.parentElement.remove(); location.reload();" 
      style="background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%); 
             color: white; border: none; padding: 12px 24px; border-radius: 10px; 
             cursor: pointer; font-weight: 700; font-size: 14px;">
      Sign In Again
    </button>
  `;
  document.body.appendChild(notification);
}

function showSessionIndicator(isCached) {
  const authOverlay = document.getElementById('authOverlay');
  if (!authOverlay) return;
  
  const indicator = document.createElement('div');
  indicator.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 20px;
    padding: 8px 16px;
    background: ${isCached ? 'rgba(34, 197, 94, 0.9)' : 'rgba(59, 130, 246, 0.9)'};
    color: white;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: slideUp 0.3s ease-out;
  `;
  indicator.textContent = isCached ? 'ðŸ”’ Session restored' : 'ðŸ”‘ Logged in';
  
  document.body.appendChild(indicator);
  
  // Auto-hide after 1.5 seconds
  setTimeout(() => {
    indicator.style.transition = 'opacity 0.3s, transform 0.3s';
    indicator.style.opacity = '0';
    indicator.style.transform = 'translateY(20px)';
    setTimeout(() => indicator.remove(), 300);
  }, 1500);
}

// ============================================
// DARK MODE TOGGLE
// ============================================
const DARK_MODE_KEY = 'musely_dark_mode';

// ============================================
// [SECTION 3] DARK MODE
// ============================================
function initDarkMode() {
  // Check for saved preference or use prefers-color-scheme
  const savedMode = localStorage.getItem(DARK_MODE_KEY);
  
  // Safely check for prefers-color-scheme support
  const prefersDark = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)').matches : false;
  
  const shouldUseDarkMode = savedMode === 'true' || (savedMode === null && prefersDark);
  
  if (shouldUseDarkMode) {
    document.body.classList.add('dark-mode');
    updateDarkModeIcon(true);
  }
}

function toggleDarkMode() {
  const isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem(DARK_MODE_KEY, isDark.toString());
  updateDarkModeIcon(isDark);
  // Toast removed - too frequent and distracting
}

function updateDarkModeIcon(isDark) {
  const icon = document.getElementById('darkModeIcon');
  if (!icon) return;
  
  if (isDark) {
    // Moon icon for dark mode
    icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/>';
  } else {
    // Sun icon for light mode
    icon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" stroke-width="2" fill="none"/>';
  }
}

// Initialize dark mode on page load
if (typeof window !== 'undefined') {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDarkMode);
  } else {
    initDarkMode();
  }
}

// ============================================
// [SECTION 3.5] USER PREFERENCES & FEATURES
// ============================================
const USER_PREFS_KEY = 'musely_user_prefs';

function getUserPrefs() {
  try {
    const saved = localStorage.getItem(USER_PREFS_KEY);
    return saved ? JSON.parse(saved) : { shiftView: 'grid', timezone: 'PST' };
  } catch (e) {
    return { shiftView: 'grid', timezone: 'PST' };
  }
}

function saveUserPrefs(prefs) {
  try {
    localStorage.setItem(USER_PREFS_KEY, JSON.stringify(prefs));
  } catch (e) {
    console.error('Failed to save preferences:', e);
  }
}

// Initialize user preferences
function initUserPrefs() {
  const prefs = getUserPrefs();
  
  // Apply view preference
  if (prefs.shiftView === 'list') {
    document.querySelectorAll('.shifts-grid').forEach(g => g.classList.add('view-list'));
    updateViewToggleIcon(true);
  }
  
  // Apply timezone preference to both selectors
  const tz = prefs.timezone || 'PST';
  
  // Update header radio buttons
  const tzRadio = document.querySelector(`input[name="timezone"][value="${tz}"]`);
  if (tzRadio) tzRadio.checked = true;
  
  // Update compact bar select dropdown
  const tzSelect = document.getElementById('compactTzSelect');
  if (tzSelect) tzSelect.value = tz;
}

// View Toggle (Grid vs List)
function toggleShiftView() {
  const prefs = getUserPrefs();
  const isList = prefs.shiftView === 'list';
  prefs.shiftView = isList ? 'grid' : 'list';
  saveUserPrefs(prefs);
  
  document.querySelectorAll('.shifts-grid').forEach(g => {
    g.classList.toggle('view-list', !isList);
  });
  
  updateViewToggleIcon(!isList);
  toast(!isList ? 'ðŸ“‹ List view enabled' : 'ðŸ“Š Grid view enabled', 'info');
}

function updateViewToggleIcon(isList) {
  const icon = document.getElementById('viewToggleIcon');
  if (!icon) return;
  
  if (isList) {
    // List icon
    icon.innerHTML = '<path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" fill="currentColor"/>';
  } else {
    // Grid icon
    icon.innerHTML = '<path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z" fill="currentColor"/>';
  }
}

// Timezone Functions
function toggleTimezoneDropdown() {
  const dropdown = document.getElementById('timezoneDropdown');
  if (dropdown) {
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  }
}

function setUserTimezone(tz) {
  const prefs = getUserPrefs();
  prefs.timezone = tz;
  saveUserPrefs(prefs);
  
  // Close the radio button dropdown if it's open (only in manager mode)
  const dropdown = document.getElementById('timezoneDropdown');
  if (dropdown && dropdown.style.display !== 'none') {
    dropdown.style.display = 'none';
  }
  
  toast(`Timezone: ${tz}`, 'info');
  
  // CRITICAL: Regenerate all time labels with new timezone
  const regenerateLabels = (arr) => {
    if (!Array.isArray(arr)) return;
    arr.forEach(item => {
      if (item.start) item.startLabel = toAmPm(item.start);
      if (item.end) item.endLabel = toAmPm(item.end);
    });
  };
  
  // Use window-scoped variables for cross-scope access
  if (window._allData) regenerateLabels(window._allData);
  if (window._filteredData) regenerateLabels(window._filteredData);
  
  // Sync both timezone selectors
  // Update compact bar select dropdown
  const tzSelect = document.getElementById('compactTzSelect');
  if (tzSelect) tzSelect.value = tz;
  
  // Update header radio buttons
  const tzRadio = document.querySelector(`input[name="timezone"][value="${tz}"]`);
  if (tzRadio) tzRadio.checked = true;
  
  // Force re-render the schedule view
  if (typeof renderView === 'function') {
    renderView();
  }
  
  // Update compact bar display if in agent mode
  if (typeof updateCompactBar === 'function') {
    updateCompactBar();
  }
}

// Convert PST time to user's timezone
function convertTimeToUserTz(pstHour) {
  const prefs = getUserPrefs();
  if (prefs.timezone === 'PST') return pstHour;
  
  // Timezone offsets from PST (positive = ahead)
  const offsets = { 'PST': 0, 'MST': 1, 'CST': 2, 'EST': 3 };
  const offset = offsets[prefs.timezone] || 0;
  return pstHour + offset;
}

// Format time with both user TZ and PST reference
function formatTimeWithTz(pstHour) {
  const prefs = getUserPrefs();
  const userHour = convertTimeToUserTz(pstHour);
  
  // Format as 12-hour time
  const formatHour = (h) => {
    const hr = h % 24;
    const suffix = hr >= 12 ? 'PM' : 'AM';
    const displayHr = hr % 12 || 12;
    return `${displayHr}:00 ${suffix}`;
  };
  
  if (prefs.timezone === 'PST') {
    return formatHour(pstHour);
  }
  return `${formatHour(userHour)} (${formatHour(pstHour)} PST)`;
}

// Close timezone dropdown when clicking outside
document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('timezoneDropdown');
  const btn = document.getElementById('btnTimezone');
  if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
    dropdown.style.display = 'none';
  }
});

// Google Calendar Export
function exportToGoogleCalendar() {
  const myName = window._myName || "";
  if (!myName) {
    toast("Please sign in to export your schedule", "error");
    return;
  }
  
  // Get current week's shifts for this agent
  const shifts = (_filteredData || []).filter(s => 
    s.person && s.person.toLowerCase().trim() === myName.toLowerCase().trim()
  );
  
  if (shifts.length === 0) {
    toast("No shifts found to export", "info");
    return;
  }
  
  Swal.fire({
    title: 'ðŸ“… Export to Google Calendar',
    html: `
      <div style="text-align: left; font-size: 14px; line-height: 1.6;">
        <p>Export <strong>${shifts.length} shift(s)</strong> to your Google Calendar?</p>
        <p style="font-size: 12px; color: #64748b; margin-top: 8px;">Each shift will open in a new tab for you to add.</p>
      </div>
    `,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Export All',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#4285f4'
  }).then(result => {
    if (result.isConfirmed) {
      exportShiftsToGCal(shifts);
    }
  });
}

function exportShiftsToGCal(shifts) {
  const sorted = [...shifts].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
  let exported = 0;
  
  sorted.forEach((shift, idx) => {
    setTimeout(() => {
      const title = encodeURIComponent(`${shift.team || 'Work'} Shift`);
      const date = (shift.date || new Date().toISOString().split('T')[0]).replace(/-/g, '');
      
      // Parse shift times
      let startHour = 9, endHour = 17;
      if (shift.start) startHour = Math.floor(parseFloat(shift.start));
      if (shift.end) endHour = Math.floor(parseFloat(shift.end));
      
      const startDT = `${date}T${String(startHour).padStart(2, '0')}0000`;
      const endDT = `${date}T${String(endHour).padStart(2, '0')}0000`;
      const details = encodeURIComponent(shift.notes || 'Scheduled shift');
      
      const gcalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDT}/${endDT}&details=${details}&ctz=America/Los_Angeles`;
      
      window.open(gcalUrl, '_blank');
      exported++;
      
      if (exported === sorted.length) {
        toast(`âœ… Opened ${exported} shift(s) for calendar export`, 'success');
      }
    }, idx * 600); // Stagger to avoid popup blocker
  });
}

// ============================================
// MULTIPLE MAKE-UP DATES
// ============================================
let _selectedMakeUpDates = [];

function addMakeUpDate() {
  const dateInput = document.getElementById("agMakeUpDate");
  const date = dateInput ? dateInput.value : "";
  
  if (!date) {
    toast("Please select a date first", "error");
    return;
  }
  
  if (_selectedMakeUpDates.includes(date)) {
    toast("This date is already added", "error");
    return;
  }
  
  _selectedMakeUpDates.push(date);
  dateInput.value = ""; // Clear for next
  renderMakeUpDatesList();
  toast(`Added: ${new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}`, 'success');
}

function removeMakeUpDate(date) {
  _selectedMakeUpDates = _selectedMakeUpDates.filter(d => d !== date);
  renderMakeUpDatesList();
}

function renderMakeUpDatesList() {
  const container = document.getElementById("makeUpDatesList");
  if (!container) return;
  
  if (_selectedMakeUpDates.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = _selectedMakeUpDates.map(date => {
    const d = new Date(date + 'T12:00:00');
    const formatted = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    return `
      <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); color: #1e40af; border-radius: 20px; font-size: 12px; font-weight: 500; border: 1px solid #93c5fd;">
        ðŸ“… ${formatted}
        <button type="button" onclick="removeMakeUpDate('${date}')" style="background: none; border: none; color: #1e40af; cursor: pointer; font-size: 16px; line-height: 1; padding: 0; font-weight: bold;">Ã—</button>
      </span>
    `;
  }).join('');
}

function resetMakeUpDates() {
  _selectedMakeUpDates = [];
  renderMakeUpDatesList();
}

function getMakeUpDatesString() {
  if (_selectedMakeUpDates.length === 0) {
    const single = document.getElementById("agMakeUpDate");
    return single ? single.value : "";
  }
  return _selectedMakeUpDates.join(', ');
}

// Initialize preferences on page load
if (typeof window !== 'undefined') {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initUserPrefs);
  } else {
    setTimeout(initUserPrefs, 100);
  }
}
  
  const PST_TZ = "America/Los_Angeles";
  const pad2 = (n) => String(n).padStart(2, "0");
  const TZ = "America/Los_Angeles";
  
  // ============================================
  // GLOBAL ERROR HANDLERS
  // ============================================
  window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    // Don't show toast for minor errors
    if (event.reason && event.reason.message && !event.reason.message.includes('Failed to fetch')) {
      // Only log, don't interrupt user
    }
  });
  
  window.onerror = function(msg, url, line, col, error) {
    console.error('Global error:', msg, 'at', url, 'line:', line);
    return false; // Let the default handler run
  };
  
  // Helper to get today's date in YYYY-MM-DD format (PST timezone)
  // ============================================
  // [SECTION 4] UTILITIES
  // ============================================
  function pstISODate(d = new Date()) {
    return new Intl.DateTimeFormat("en-CA", {
      timeZone: TZ,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    }).format(d);
  }
  function pstISODateOffset(days) {
    const d = new Date();
    d.setDate(d.getDate() + days);
    return pstISODate(d);
  }
  
  // --- CLOUD RUN BRIDGE START ---
  // This object "fakes" the Google Apps Script environment so your UI works in Cloud Run.
  
  // --- CLOUD RUN BRIDGE START ---
  // --- CLOUD RUN BRIDGE START ---
  const google = {
    script: {
      // We return a proxy to handle 'run' so we can create a fresh chain for every request
      run: {
        withSuccessHandler: function(success) {
          // Create a NEW object for this specific request chain
          const chain = {
            _success: success,
            _fail: null,
            
            withFailureHandler: function(failure) {
              this._fail = failure;
              return this;
            },
            // --- 1. AUTO-GEN ---
            checkAndAutoGenerate: function() {
               console.log("Bridge: Auto-gen check.");
               setTimeout(() => { if(this._success) this._success({ generated: false }); }, 10);
            },
            // --- 3. MASTER SCHEDULE ---
            uiGetBaseData: async function() {
                try {
                    const res = await fetch('./?action=base-schedule');
                    if(!res.ok) throw new Error("Failed to load master");
                    const json = await res.json();
                    if(this._success) this._success(json);
                } catch(err) { 
                    if(this._fail) this._fail(err); 
                }
            },
            // --- 4. CONFIGURATION ---
            uiGetConfig: function() {
               setTimeout(() => {
                 if(this._success) this._success({
                   isManager: true, role: 'MASTER', automationEnabled: true,
                   allManagers: [{name: "Admin", email: "admin@musely.com"}],
                   currentUser: "Admin", matchedPerson: "Admin"
                 });
               }, 50);
            },
            uiReplaceAssignment: async function(payload) {
  try {
    console.log("uiReplaceAssignment payload:", payload);
    if (!payload?.docId || !payload?.assignmentId || !payload?.newPerson) {
      throw new Error("Missing docId, assignmentId, or newPerson (client)");
    }
    const res = await fetch("./?action=assignment/replace", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    let json = {};
    try { json = JSON.parse(text); } catch {}
    if (!res.ok) {
      throw new Error(json.error || json.message || text || `HTTP ${res.status}`);
    }
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(String(e.message || e));
  }
},
            // --- 5. SYSTEM DATA (TEAMS & PEOPLE) ---
            uiGetManagerData: async function() {
               console.log("Bridge: Fetching People & Teams...");
               try {
                 const ts = Date.now();
                 // 1. Teams
                 const tReq = await fetch(`./?action=teams&_t=${ts}`);
                 const tRes = await tReq.json();
                 const teams = (tRes.teams || []).map(t => t.id);
                 // 2. People
                 const pReq = await fetch(`./?action=people&_t=${ts}`);
                 const pRes = await pReq.json();
                 const peopleList = (pRes.people || []).map(p => p.name || p.id);
                 console.log(`Bridge: Loaded ${peopleList.length} people.`);
                 if(this._success) this._success({ people: peopleList, teams: teams, timeOff: [] });
               } catch(e) {
                 console.error("Bridge Error (System Data):", e);
                 const fallback = ["Adam", "Baylie", "Brandi", "Elizabeth", "Gisenia", "Kelsey"];
                 if(this._success) this._success({ people: fallback, teams: [], timeOff: [] });
               }
            },
            // --- 6. ZENDESK ---
            uiGetZendeskMetricsSnapshot: function() {
               setTimeout(() => { if(this._success) this._success([]); }, 50);
            },
            // --- 8. OTHER WRITE OPERATIONS ---
            uiSetTimeOff: async function(docId, assignmentId, enforce) {
  try {
    const res = await fetch(`./?action=assignment/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        docId,
        assignmentId,
        patch: { notes: "[OFF]" },
        enforce: !!enforce
      })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || json.message || "Update failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},
uiRestoreAssignment: async function(docId, assignmentId) {
  try {
    const res = await fetch(`./?action=assignment/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        docId,
        assignmentId,
        patch: { notes: "" }
      })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || json.message || "Restore failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},
uiGetAuditLogs: async function() {
  try {
    const res = await fetch("./?action=audit/logs");
    const json = await res.json().catch(() => ([]));
    if (this._success) this._success(json);
  } catch (e) {
    if (this._success) this._success([]); // fail soft
  }
},
uiGetStaffingRules: async function() {
  try {
    const res = await fetch("./?action=staffing/rules");
    const json = await res.json().catch(() => ([]));
    if (this._success) this._success(json);
  } catch (e) {
    if (this._success) this._success([]);
  }
},
uiSaveStaffingRule: async function(rule) {
  try {
    const res = await fetch("./?action=staffing/rules", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(rule || {})
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || "Save failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},
uiDeleteStaffingRule: async function(idx) {
  try {
    const res = await fetch("./?action=staffing/rules/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ idx })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || "Delete failed");
    if (this._success) this._success(json);
  } catch (e) {
    if (this._fail) this._fail(e.message || String(e));
  }
},
runGenerate: async function() {
  try {
    const res = await fetch("./?action=generate", { method: "POST" });
    const json = await res.json().catch(() => ({}));
    if (this._success) this._success(json);
  } catch (e) { if (this._fail) this._fail(e.message || String(e)); }
},
            handleMasterScheduleEdit: async function(payload) {
                console.log("Bridge: Master Edit Request", payload);
                try {
                    const res = await fetch('./?action=update-master-schedule', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    if (!res.ok) throw new Error("Network request failed");
                    
                    const json = await res.json();
                    if (json.status === "error") throw new Error(json.message);
                    
                    if(this._success) this._success(json);
                } catch(err) {
                    console.error("Bridge Error:", err);
                    if(this._fail) this._fail(err.message);
                }
            }, // <--- COMMA HERE IS IMPORTANT
            // --- 10. ZENDESK PROFILE ---
            getZendeskProfile: async function(name) {
                console.log("Bridge: Fetching Zendesk Profile for", name);
                try {
                    const res = await fetch('./?action=agent-profile', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name: name })
                    });
                    if (!res.ok) throw new Error("Network request failed");
                    const json = await res.json();
                    
                    if(this._success) this._success(json);
                } catch(err) {
                    console.error("Profile Fetch Error:", err);
                    if(this._fail) this._fail(err.message);
                }
            }
          }; 
          return chain;
        }
      },
      
      // Group B: URL handling
      url: {
          getLocation: function(cb) { cb({ hash: window.location.hash || "" }); }
      }
    }
  };
  // --- CLOUD RUN BRIDGE END ---
  
  function fatal_(title, detail) {
    console.error("FATAL:", title, detail);
    if ($("skeletonView")) $("skeletonView").style.display = "none";
    if ($("loader")) $("loader").classList.add("hidden");
    const host = $("listView") || document.body;
    host.innerHTML = `<div style="padding:20px; color:red; font-weight:bold;">${title}<br><span style="font-weight:normal; font-size:12px; color:#333;">${detail}</span></div>`;
  }
  // --- 2. GLOBAL VARIABLES ---
  // Expose key data arrays globally for timezone conversion and other cross-scope access
  window._allData = window._allData || [];
  window._filteredData = window._filteredData || [];
  let _allData = window._allData, _filteredData = window._filteredData;
  
  // Sync function to keep window and local vars in sync
  function syncDataArrays() {
    window._allData = _allData;
    window._filteredData = _filteredData;
  }
  
  let _people=[], _teams=[], _roles=[], _timeOff=new Set();
  let _view="schedule", _mode="quick", _activeTeam="", _selectedPeople=new Set(), _teamSelected=new Set();
  let _editing=null, _dragPerson=null, _drawerOpen=false, _lastUndo=null, _notifQueue=[];
  let _zendeskMetricsList = [], _zendeskMetricsByName = new Map(), _zendeskSnapshotLoaded = false;
  let _selectedManagerEmail = "", _currentManagerName = "";
  let _isMasterMode = false;
  let _activeProfileRequest = "";
  let _activeMetricsRequest = "";
  let _activeMetricsEmail = "";
  let _peopleMeta = [];
  let _peopleMetaByName = new Map();
// Schedule date range tracking
  let _scheduleLoadedPast = 0;      // How many past days are loaded
  let _scheduleLoadedFuture = 14;   // How many future days are loaded
  let _isLoadingMore = false;       // Prevent duplicate loads
  let _agentScheduleDays = 14;      // Track agent's loaded days (separate from manager controls)
  
  // NEW: To track the logged in user's Real Name (not just email)
  let _myName = ""; 
  let _masterSelected=new Set(), _masterRawData=[]; // Moved here for safety
  let _lastSelectedPerson = null;
  // --- 3. HELPERS (FORMATTING) ---
  function formatCsatDisplay(val) {
    if (val === null || val === undefined || val === "" || val === "--") return "--";
    if (String(val).includes("%")) return val;
    const n = Number(val);
    if (isNaN(n)) return "--";
    if (n <= 1 && n !== 0) return Math.round(n * 100) + "%";
    return Math.round(n) + "%";
  }
  function getTeamClass(t) { 
    const l = (t || "").toLowerCase().replace(/[\s\/]+/g, ''); 
    
    if (l.includes("social")) return "t-socials";
    if (l.includes("phone")) return "t-phone";
    if (l.includes("livechat") || l === "lc") return "t-livechat";
    if (l.includes("md") || l.includes("medical")) return "t-mdsupport";
    if (l.includes("dispute") || l === "dis") return "t-disputes";
    if (l.includes("float") || l.includes("email")) return "t-floater";
    if (l.includes("project") || l === "proj") return "t-projects";
    if (l.includes("lunch")) return "t-lunch";
    if (l.includes("1:1") || (l.includes("11") && l.includes("meeting"))) return "t-11meeting";
    
    return "t-other"; 
}
function getChannelDisplayName(dbName) {
    const map = {
        "livechat": "Live Chat",
        "phonesupport": "Phone",
        "mdsupport":  "MD Support",
        "emailfloater": "Floater",
        "reportingprojects": "Projects",
        "11meeting": "1:1 Meetings",
        "1:1meeting": "1:1 Meetings",
        "socials": "Socials",
        "disputes": "Disputes",
        "lunch": "Lunch",
        "meeting": "Meeting",
        "meetings": "Meetings",
        "custom": "Custom",
        "other": "Other"
    };
    const key = String(dbName || "").toLowerCase().replace(/[\s\/]+/g, '');
    return map[key] || dbName;
}
function getChannelConfig(teamName) {
  if (!teamName) return { abbrev: "â€”", color: "#f8fafc", border: "#e2e8f0", text: "#475569" };
  
  const teamStr = String(teamName).trim();
  
  // Try exact match first
  if (CHANNEL_CONFIG[teamStr]) return CHANNEL_CONFIG[teamStr];
  
  // Try normalized match (remove spaces, lowercase)
  const normalized = teamStr.toLowerCase().replace(/[\s_\-\/]/g, '');
  for (const [key, val] of Object.entries(CHANNEL_CONFIG)) {
    const keyNorm = key.toLowerCase().replace(/[\s_\-\/]/g, '');
    if (keyNorm === normalized) return val;
  }
  
  // Partial matching for common patterns
  if (normalized.includes('livechat') || normalized.includes('chat')) {
    return CHANNEL_CONFIG["LiveChat"];
  }
  if (normalized.includes('phone')) {
    return CHANNEL_CONFIG["Phone"];
  }
  if (normalized.includes('dispute')) {
    return CHANNEL_CONFIG["Disputes"];
  }
  if (normalized.includes('social')) {
    return CHANNEL_CONFIG["Socials"];
  }
  if (normalized.includes('floater') || normalized.includes('email')) {
    return CHANNEL_CONFIG["Floater"];
  }
  if (normalized.includes('md') || normalized.includes('medical')) {
    return CHANNEL_CONFIG["MD Support"];
  }
  if (normalized.includes('lunch')) {
    return CHANNEL_CONFIG["Lunch"];
  }
  if (normalized.includes('project')) {
    return CHANNEL_CONFIG["Projects"];
  }
  if (normalized.includes('1:1')) {
    return CHANNEL_CONFIG["1:1 Meeting"];
  }
  
  // Ultimate fallback - use first 3-4 chars
  return { 
    abbrev: teamStr.substring(0, 4).toUpperCase(), 
    color: "#f8fafc", 
    border: "#e2e8f0", 
    text: "#475569" 
  };
}
function getChannelAbbrev(channelName) {
    const config = getChannelConfig(channelName);
    return config.abbrev;
}
  function _formatTime(val) { 
    if(!val) return ""; 
    if (val instanceof Date) { return val.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); } 
    return val; 
  }
  // Cache helper functions
// ============================================
// [SECTION 5] CACHE MANAGEMENT
// ============================================
function getCachedData(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    
    const cached = JSON.parse(raw);
    const now = Date.now();
    
    // Check if cache is still valid
    if (cached.version !== CACHE_CONFIG.VERSION) {
      console.log(`ðŸ—‘ï¸ Cache version mismatch for ${key}`);
      localStorage.removeItem(key);
      return null;
    }
    
    if (now - cached.timestamp > CACHE_CONFIG.TTL) {
      console.log(`â° Cache expired for ${key}`);
      localStorage.removeItem(key);
      return null;
    }
    
    console.log(`âœ… Cache HIT for ${key} (${Math.round((CACHE_CONFIG.TTL - (now - cached.timestamp)) / 1000)}s remaining)`);
    return cached.data;
  } catch (e) {
    console.error('Cache read error:', e);
    return null;
  }
}

function setCachedData(key, data) {
  try {
    // âœ… Trim payload to only needed fields for agents
    let trimmedData = data;
    if (!window._isManager && key === CACHE_CONFIG.SCHEDULE_KEY && Array.isArray(data)) {
      // For agents, only keep essential fields to reduce cache size
      trimmedData = data.map(item => ({
        // Core schedule fields
        docId: item.docId,
        dateISO: item.dateISO,
        dateLabel: item.dateLabel,
        dayKey: item.dayKey,
        team: item.team,
        person: item.person,
        start: item.start,
        end: item.end,
        startLabel: item.startLabel,
        endLabel: item.endLabel,
        role: item.role,
        notes: item.notes,
        assignmentId: item.assignmentId,
        notifyStatus: item.notifyStatus,
        // Omit large fields like full assignments array, metadata, etc.
      }));
      // Only log size difference in development
      if (window.location.hostname === 'localhost') {
        console.log(`ðŸ“¦ Trimmed cache payload from ${JSON.stringify(data).length} to ${JSON.stringify(trimmedData).length} bytes`);
      }
    }

    const cacheEntry = {
      version: CACHE_CONFIG.VERSION,
      timestamp: Date.now(),
      data: trimmedData
    };
    localStorage.setItem(key, JSON.stringify(cacheEntry));
    console.log(`ðŸ’¾ Cache SET for ${key}`);
  } catch (e) {
    console.error('Cache write error:', e);
    // If localStorage is full, clear old caches
    if (e.name === 'QuotaExceededError') {
      localStorage.removeItem(CACHE_CONFIG.SCHEDULE_KEY);
      localStorage.removeItem(CACHE_CONFIG.METADATA_KEY);
    }
  }
}
function clearScheduleCache() {
  localStorage.removeItem(CACHE_CONFIG.SCHEDULE_KEY);
  localStorage.removeItem(CACHE_CONFIG.METADATA_KEY);
  console.log('ðŸ§¹ Schedule cache cleared');
}
// ============================================
  // MANAGER PRESENCE TRACKING - ENHANCED
  // ============================================

  // Send heartbeat if user is a manager
  // ============================================
  // [SECTION 6] MANAGER PRESENCE TRACKING
  // ============================================
  function getPresenceContext() {
    let view = "Daily Schedule";
    let area = "";
    let isEditing = false;
    let editingTarget = null;

    if (_view === "metrics") {
      view = "Metrics";
    } else if (_view === "schedule") {
      if (window._isMasterMode) {
        view = _masterEditEnabled ? "Editing Master Schedule" : "Master Schedule";
        isEditing = _masterEditEnabled;
      } else {
        view = _isEditingSchedule ? "Editing Daily Schedule" : "Daily Schedule";
        area = (typeof _activeTeam !== "undefined" && _activeTeam) ? _activeTeam : "";
        isEditing = _isEditingSchedule;
        editingTarget = _editing ? `${_editing.person || ''} - ${_editing.dateLabel || ''}` : null;
      }
    }

    return { view, area, isEditing, editingTarget };
  }

  function sendManagerHeartbeat() {
    if (!window._isManager || !window._myName) return;

    const { view, area, isEditing, editingTarget } = getPresenceContext();

    console.log(`[Presence] Sending heartbeat: ${window._myName} - ${view}${isEditing ? ' (editing)' : ''}`);

    fetch('./?action=manager/heartbeat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        managerName: window._myName,
        view: view,
        area: area,
        isEditing: isEditing,
        editingTarget: editingTarget
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        console.log('[Presence] Heartbeat sent successfully');
      } else {
        console.error('[Presence] Heartbeat failed:', data.error);
      }
    })
    .catch(err => console.error('[Presence] Heartbeat error:', err));
  }

  // Poll for active managers
  async function fetchManagerPresence() {
    if (!window._isManager) return;

    try {
      console.log('[Presence] Fetching active managers...');
      const res = await fetch('./?action=manager/presence', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isManager: true })
      });
      const data = await res.json();

      console.log('[Presence] Response:', data);

      if (data.ok && data.activeManagers) {
        displayManagerPresence(data.activeManagers);
      }
    } catch (err) {
      console.error('[Presence] Fetch error:', err);
    }
  }

  // Display manager presence in UI - Modern Design with Conflict Detection
  function displayManagerPresence(managers) {
    // Get or create presence indicator
    let presenceEl = document.getElementById('managerPresenceIndicator');

    // Create indicator if doesn't exist
    if (!presenceEl) {
      presenceEl = document.createElement('div');
      presenceEl.id = 'managerPresenceIndicator';
      presenceEl.className = 'manager-presence-pill';
      
      const metaGroup = document.querySelector('.metaGroup');
      if (metaGroup) {
        metaGroup.appendChild(presenceEl);
      } else {
        console.error('[Presence] metaGroup not found');
        return;
      }
    }

    // Filter out current user
    const otherManagers = (managers || []).filter(m => m.managerName !== window._myName);
    
    // Check for conflicts (same team being edited)
    const myPresence = getPresenceContext();
    const conflicts = otherManagers.filter(m => 
      m.isEditing && myPresence.isEditing && m.area && myPresence.area && m.area === myPresence.area
    );
    
    // Check who's editing
    const editingManagers = otherManagers.filter(m => m.isEditing);

    const setPresenceVariant = () => {
      presenceEl.classList.remove("mp-solo","mp-one","mp-many","mp-conflict","mp-editing");
      if (conflicts.length > 0) {
        presenceEl.classList.add("mp-conflict");
      } else if (editingManagers.length > 0) {
        presenceEl.classList.add("mp-editing");
      } else if (otherManagers.length === 0) {
        presenceEl.classList.add("mp-solo");
      } else if (otherManagers.length === 1) {
        presenceEl.classList.add("mp-one");
      } else {
        presenceEl.classList.add("mp-many");
      }
    };

    // Show conflict warning if someone else is editing same area
    if (conflicts.length > 0) {
      const conflictNames = conflicts.map(m => m.managerName.split(' ')[0]).join(', ');
      presenceEl.innerHTML = `
        <span class="presence-dot conflict"></span>
        <span class="presence-conflict-text">âš ï¸ ${conflictNames} editing same area</span>
      `;
      presenceEl.title = `Conflict: ${conflicts.map(m => `${m.managerName} is editing ${m.area}`).join('\n')}`;
      setPresenceVariant();
      
    } else if (otherManagers.length === 0) {
      // Only you are online
      presenceEl.innerHTML = `
        <span class="presence-dot"></span>
        <span class="presence-name">Online</span>
      `;
      presenceEl.title = `You are viewing ${myPresence.view}${myPresence.area ? ` (${myPresence.area})` : ""}`;
      setPresenceVariant();

    } else if (otherManagers.length === 1) {
      const m = otherManagers[0];
      const editingIndicator = m.isEditing ? '<span class="presence-editing-badge">âœï¸</span>' : '';
      presenceEl.innerHTML = `
        <span class="presence-dot${m.isEditing ? ' editing' : ''}"></span>
        <span class="presence-name">${m.managerName.split(' ')[0]}</span>
        ${editingIndicator}
        <span class="presence-view">${m.view}</span>
      `;
      presenceEl.title = `${m.managerName} is ${m.isEditing ? 'editing' : 'viewing'} ${m.view}${m.area ? ` (${m.area})` : ''}`;
      setPresenceVariant();

    } else {
      const editingCount = editingManagers.length;
      presenceEl.innerHTML = `
        <span class="presence-dot${editingCount > 0 ? ' editing' : ''}"></span>
        <span class="presence-count">${otherManagers.length + 1} online</span>
        ${editingCount > 0 ? `<span class="presence-editing-badge">${editingCount} editing</span>` : ''}
      `;
      presenceEl.title = otherManagers.map(m => 
        `${m.managerName}: ${m.isEditing ? 'âœï¸ ' : ''}${m.view}${m.area ? ` (${m.area})` : ''}`
      ).join('\n');
      setPresenceVariant();
    }

    // Add click handler for details popup
    presenceEl.onclick = function() {
      const now = new Date();
      const myPresence = getPresenceContext();
      const myViewLabel = `${myPresence.view}${myPresence.area ? ` â€¢ ${myPresence.area}` : ""}`;
      
      let html = `
        <div style="text-align: left; font-size: 14px; max-height: 300px; overflow-y: auto;">
          <!-- Current user -->
          <div style="display:flex; align-items:center; gap:12px; padding:14px; margin-bottom:10px; background:linear-gradient(135deg, #faf5f4 0%, #f0e6e4 100%); border-radius:12px; border-left:4px solid #b37e78;">
            <div style="width:40px; height:40px; border-radius:10px; background:linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:16px;">
              ${(window._myName || 'Y').charAt(0).toUpperCase()}
            </div>
            <div style="flex:1;">
              <div style="font-weight:700; color:#1e293b; font-size:14px;">${window._myName || 'You'} <span style="font-size:11px; color:#b37e78;">(You)</span></div>
              <div style="font-size:12px; color:#64748b; margin-top:2px;">
                ðŸ“ ${myViewLabel}
              </div>
            </div>
            <div style="font-size:11px; color:#b37e78; background:#f0e6e4; padding:4px 8px; border-radius:6px;">
              Active
            </div>
          </div>
      `;
      
      if (otherManagers.length > 0) {
        html += otherManagers.map(m => {
          const ago = getTimeAgo(m.lastHeartbeat);
          const editingBadge = m.isEditing 
            ? `<span style="font-size:10px; padding:2px 6px; background:rgba(245,158,11,0.2); border:1px solid rgba(245,158,11,0.4); border-radius:4px; color:#b45309; font-weight:600; margin-left:6px;">âœï¸ Editing</span>` 
            : '';
          const borderColor = m.isEditing ? '#f59e0b' : '#8f7a77';
          const bgColor = m.isEditing 
            ? 'linear-gradient(135deg, #fefce8 0%, #fef3c7 100%)' 
            : 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)';
          return `
            <div style="display:flex; align-items:center; gap:12px; padding:14px; margin-bottom:10px; background:${bgColor}; border-radius:12px; border-left:4px solid ${borderColor};">
              <div style="width:40px; height:40px; border-radius:10px; background:linear-gradient(135deg, ${m.isEditing ? '#f59e0b' : '#a08885'} 0%, ${m.isEditing ? '#d97706' : '#8f7a77'} 100%); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:16px;">
                ${m.managerName.charAt(0).toUpperCase()}
              </div>
              <div style="flex:1;">
                <div style="font-weight:700; color:#1e293b; font-size:14px;">${m.managerName}${editingBadge}</div>
                <div style="font-size:12px; color:#64748b; margin-top:2px;">
                  ðŸ“ ${m.view}${m.area ? ` â€¢ ${m.area}` : ''}
                </div>
              </div>
              <div style="font-size:11px; color:#94a3b8; background:#e2e8f0; padding:4px 8px; border-radius:6px;">
                ${ago}
              </div>
            </div>
          `;
        }).join('');
      } else {
        html += `
          <div style="text-align:center; padding:20px; color:#94a3b8; font-size:13px;">
            No other managers currently online
          </div>
        `;
      }
      
      html += `
        </div>
        <div style="text-align:center; margin-top:16px; font-size:11px; color:#94a3b8;">
          Last updated: ${now.toLocaleTimeString()}
        </div>
      `;
      
      // Fetch agents if manager
      if (window._isManager) {
        fetch('/agent/presence')
          .then(r => r.json())
          .then(data => {
            if (data.ok && data.activeAgents && data.activeAgents.length > 0) {
              let agentHtml = `
                <div style="margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 16px;">
                  <div style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                    ðŸ‘¤ Agents Online (${data.activeAgents.length})
                  </div>
                  <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              `;
              data.activeAgents.forEach(agent => {
                agentHtml += `
                  <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 8px; border: 1px solid #86efac;">
                    <span style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></span>
                    <span style="font-size: 13px; font-weight: 500; color: #166534;">${agent.agentName}</span>
                  </div>
                `;
              });
              agentHtml += `</div></div>`;
              
              // Update the Swal content
              const contentEl = Swal.getHtmlContainer();
              if (contentEl) {
                contentEl.innerHTML += agentHtml;
              }
            }
          })
          .catch(err => console.warn('Failed to fetch agent presence:', err));
      }
      
      Swal.fire({
        title: '<span style="font-size:20px;">ðŸ‘¥ Team Online</span>',
        html: html,
        showConfirmButton: true,
        confirmButtonText: 'Close',
        confirmButtonColor: '#b37e78',
        showClass: { popup: 'animate__animated animate__fadeIn animate__faster' },
        hideClass: { popup: 'animate__animated animate__fadeOut animate__faster' }
      });
    };

    presenceEl.style.display = 'inline-flex';
    presenceEl.style.cursor = 'pointer';
  }

  // Helper to get time ago string
  function getTimeAgo(timestamp) {
    const now = Date.now();
    const then = new Date(timestamp).getTime();
    const diff = Math.floor((now - then) / 1000);
    
    if (diff < 60) return 'Just now';
    if (diff < 120) return '1 min ago';
    if (diff < 300) return `${Math.floor(diff / 60)} mins ago`;
    return 'Active';
  }
  
  // Start agent heartbeat for non-managers
  function startAgentHeartbeat() {
    if (window._isManager) return;
    if (!window._myName) return;
    
    const sendHeartbeat = () => {
      fetch('/agent/heartbeat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          agentName: window._myName,
          view: 'schedule'
        })
      }).catch(err => console.warn('Agent heartbeat failed:', err));
    };
    
    // Send immediately and then every 2 minutes
    sendHeartbeat();
    setInterval(sendHeartbeat, 2 * 60 * 1000);
  }
  
  // ============================================
  // SSE REAL-TIME STREAM
  // Replaces polling with push-based updates
  // Falls back to polling if SSE fails
  // ============================================
  let _sseConnection = null;
  let _sseReconnectAttempts = 0;
  let _sseMaxReconnectAttempts = 5;
  let _sseFallbackMode = false;
  let _sseReconnectTimer = null;
  
  function startRealtimeStream() {
    // Don't start if already connected or in fallback mode
    if (_sseConnection && _sseConnection.readyState !== EventSource.CLOSED) {
      console.log("[SSE] Already connected");
      return;
    }
    
    // Require auth info
    if (!window._myName && !window._myEmail) {
      console.log("[SSE] Waiting for auth...");
      setTimeout(startRealtimeStream, 2000);
      return;
    }
    
    // Build SSE URL with user info
    const params = new URLSearchParams({
      email: window._myEmail || "",
      name: window._myName || "",
      isManager: window._isManager ? "true" : "false"
    });
    
    const sseUrl = `/events?${params.toString()}`;
    console.log(`[SSE] Connecting to ${sseUrl}`);
    
    try {
      _sseConnection = new EventSource(sseUrl);
      
      // Connected event
      _sseConnection.addEventListener("connected", (e) => {
        try {
          const data = JSON.parse(e.data);
          console.log("[SSE] âœ… Connected:", data);
          _sseReconnectAttempts = 0;
          _sseFallbackMode = false;
          
          // Stop polling timers since SSE is working
          stopPollingTimers();
          
          // Initial UI refresh
          if (window._isManager) {
            fetchManagerPresence();
          }
        } catch (err) {
          console.warn("[SSE] Connected event parse error:", err);
        }
      });
      
      // Ping event (keep-alive)
      _sseConnection.addEventListener("ping", (e) => {
        // Just acknowledge - no action needed
      });
      
      // Agent notification event
      _sseConnection.addEventListener("notification", (e) => {
        try {
          const data = JSON.parse(e.data);
          console.log("[SSE] ðŸ”” Agent notification:", data);
          
          // Update notification badge
          updateNotificationBadge(data.unreadCount);
          
          // Update cached notifications
          if (data.latestItems) {
            window._agentNotifications = data.latestItems;
          }
          
          // Show visual indicator if new notifications
          if (data.unreadCount > 0) {
            pulseNotificationBell();
          }
        } catch (err) {
          console.warn("[SSE] Notification parse error:", err);
        }
      });
      
      // Manager notification event
      _sseConnection.addEventListener("manager_notification", (e) => {
        try {
          const data = JSON.parse(e.data);
          console.log("[SSE] ðŸ“‹ Manager notification:", data);
          
          // Update manager notification badge
          const badge = document.getElementById("notifCount");
          if (badge) {
            badge.textContent = data.pendingCount || "";
            badge.style.display = data.pendingCount > 0 ? "flex" : "none";
          }
          
          // Show pulse if new pending items
          if (data.pendingCount > 0) {
            pulseNotificationBell();
          }
        } catch (err) {
          console.warn("[SSE] Manager notification parse error:", err);
        }
      });
      
      // Presence event (managers online)
      _sseConnection.addEventListener("presence", (e) => {
        try {
          const data = JSON.parse(e.data);
          console.log("[SSE] ðŸ‘¥ Manager presence update:", data.online?.length || 0, "online");
          
          // Update presence UI
          if (typeof updatePresenceUI === "function") {
            updatePresenceUI(data.online || []);
          }
        } catch (err) {
          console.warn("[SSE] Presence parse error:", err);
        }
      });
      
      // Agent presence event (for managers)
      _sseConnection.addEventListener("agent_presence", (e) => {
        try {
          const data = JSON.parse(e.data);
          console.log("[SSE] ðŸ‘¤ Agent presence update:", data.online?.length || 0, "online");
          
          // Update agent presence UI if available
          if (typeof updateAgentPresenceUI === "function") {
            updateAgentPresenceUI(data.online || []);
          }
        } catch (err) {
          console.warn("[SSE] Agent presence parse error:", err);
        }
      });
      
      // Time-off count event
      _sseConnection.addEventListener("timeoff_count", (e) => {
        try {
          const data = JSON.parse(e.data);
          console.log("[SSE] ðŸ“ Time-off count:", data.count);
          
          // Update time-off badge on notification bell
          updateTimeOffBadge(data.count);
        } catch (err) {
          console.warn("[SSE] Timeoff count parse error:", err);
        }
      });
      
      // Banner/alert event
      _sseConnection.addEventListener("banner", (e) => {
        try {
          const data = JSON.parse(e.data);
          console.log("[SSE] ðŸš¨ Banner:", data);
          
          // Show banner if important
          if (data.message && data.severity !== "info") {
            toast(data.message, data.severity || "warning");
          }
          
          // If this is a coverage-related banner, refresh coverage dashboard
          if (data.type === "coverage" && typeof renderCoverageDashboard === "function") {
            renderCoverageDashboard();
          }
        } catch (err) {
          console.warn("[SSE] Banner parse error:", err);
        }
      });
      
      // Error handling
      _sseConnection.onerror = (e) => {
        console.warn("[SSE] âŒ Connection error");
        _sseConnection.close();
        
        _sseReconnectAttempts++;
        
        if (_sseReconnectAttempts <= _sseMaxReconnectAttempts) {
          // Exponential backoff: 2s, 4s, 8s, 16s, 32s
          const delay = Math.min(2000 * Math.pow(2, _sseReconnectAttempts - 1), 60000);
          console.log(`[SSE] Reconnecting in ${delay/1000}s (attempt ${_sseReconnectAttempts}/${_sseMaxReconnectAttempts})`);
          
          _sseReconnectTimer = setTimeout(startRealtimeStream, delay);
        } else {
          console.warn("[SSE] Max reconnect attempts reached, falling back to polling");
          _sseFallbackMode = true;
          startFallbackPolling();
        }
      };
      
    } catch (err) {
      console.error("[SSE] Failed to create EventSource:", err);
      _sseFallbackMode = true;
      startFallbackPolling();
    }
  }
  
  function stopRealtimeStream() {
    if (_sseConnection) {
      _sseConnection.close();
      _sseConnection = null;
    }
    if (_sseReconnectTimer) {
      clearTimeout(_sseReconnectTimer);
      _sseReconnectTimer = null;
    }
  }
  
  function stopPollingTimers() {
    if (_presenceHeartbeatTimer) {
      clearInterval(_presenceHeartbeatTimer);
      _presenceHeartbeatTimer = null;
    }
    if (_presencePollTimer) {
      clearInterval(_presencePollTimer);
      _presencePollTimer = null;
    }
    if (_notificationPollTimer) {
      clearInterval(_notificationPollTimer);
      _notificationPollTimer = null;
    }
    console.log("[SSE] Polling timers stopped (SSE active)");
  }
  
  function startFallbackPolling() {
    console.log("[SSE] Starting fallback polling mode (60s interval)");
    
    // Less frequent polling as fallback
    if (window._isManager) {
      _presenceHeartbeatTimer = setInterval(sendManagerHeartbeat, 60000);
      _presencePollTimer = setInterval(fetchManagerPresence, 60000);
      _notificationPollTimer = setInterval(softRefreshNotifications, 60000);
    } else {
      _notificationPollTimer = setInterval(() => {
        loadAgentNotifications();
      }, 60000);
    }
  }
  
  function updateNotificationBadge(count) {
    const badge = document.getElementById("notifCount");
    if (badge) {
      badge.textContent = count || "";
      badge.style.display = count > 0 ? "flex" : "none";
    }
  }
  
  function updateTimeOffBadge(count) {
    const badge = document.getElementById("notifCount");
    if (badge && window._isManager) {
      const current = parseInt(badge.textContent) || 0;
      const newTotal = current + count;
      badge.textContent = newTotal || "";
      badge.style.display = newTotal > 0 ? "flex" : "none";
    }
  }
  
  function pulseNotificationBell() {
    const notifBtn = document.getElementById("btnNotif");
    if (notifBtn) {
      notifBtn.style.animation = "pulse-bell 0.5s ease 3";
      notifBtn.style.boxShadow = "0 0 12px rgba(239, 68, 68, 0.6)";
      setTimeout(() => {
        notifBtn.style.animation = "";
        notifBtn.style.boxShadow = "";
      }, 2000);
    }
  }
  
  // ---- Manager Presence: start once (ONLY after auth is known) ----
let _presenceStarted = false;
let _presenceHeartbeatTimer = null;
let _presencePollTimer = null;
let _notificationPollTimer = null;
let _isEditingSchedule = false; // Flag to prevent refresh during edits

function startManagerPresenceTracking() {
  if (_presenceStarted) return;
  if (!window._isManager) return;
  if (!window._myName || !window._myEmail) return;

  _presenceStarted = true;

  // Initial kick-off (keep these as-is)
  setTimeout(sendManagerHeartbeat, 1000);
  setTimeout(fetchManagerPresence, 2000);

  // Try SSE first, fall back to polling
  startRealtimeStream();
  
  // Only start polling if SSE fails (handled by startRealtimeStream fallback)
  // Legacy polling timers are started by startFallbackPolling() if needed
}

// âœ… Start notification polling for agents (no presence tracking for agents)
function startAgentNotificationPolling() {
  if (window._isManager) return;
  if (!window._myName) return;
  
  // Try SSE first
  startRealtimeStream();
  
  // Fallback polling is handled by SSE error handler
}

// âœ… Soft refresh - only updates notification data, not the whole UI
async function softRefreshNotifications() {
  if (_isEditingSchedule) {
    console.log("[Notifications] Skipping refresh - user is editing");
    return;
  }
  
  try {
    // For managers: check for new pending notifications
    if (window._isManager) {
      const res = await fetch('/?action=pendingNotifications', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const data = await res.json();
      
      if (data.ok) {
        const newCount = (data.managerNotifications?.length || 0) + (data.shiftNotifications?.length || 0);
        const currentCount = pendingNotifications?.length || 0;
        
        // Only show indicator if count increased
        if (newCount > currentCount) {
          showNewNotificationIndicator(newCount - currentCount);
        }
      }
    }
  } catch (err) {
    console.warn("[Notifications] Soft refresh failed:", err);
  }
}

// âœ… Show a non-intrusive indicator when new notifications arrive
function showNewNotificationIndicator(count) {
  const notifBtn = $("btnNotif");
  if (notifBtn) {
    // Add pulsing glow effect
    notifBtn.style.animation = "pulse-bell 0.5s ease 3";
    notifBtn.style.boxShadow = "0 0 12px rgba(239, 68, 68, 0.6)";
    setTimeout(() => {
      notifBtn.style.animation = "";
      notifBtn.style.boxShadow = "";
    }, 2000);
  }
  
  // Update badge count
  const badge = $("notifCount");
  if (badge) {
    const currentVal = parseInt(badge.textContent) || 0;
    badge.textContent = currentVal + count;
    badge.classList.remove("hidden");
  }
  
  // Show toast notification
  toast(`ðŸ”” ${count} new notification${count > 1 ? 's' : ''} - click bell to view`, "info");
}

// âœ… Mark editing mode on/off to prevent disruption
function setEditingMode(isEditing) {
  _isEditingSchedule = isEditing;
  if (isEditing) {
    console.log("[Edit Mode] Enabled - auto-refresh paused");
  } else {
    console.log("[Edit Mode] Disabled - auto-refresh resumed");
  }
}

  // --- 4. LOAD SEQUENCE ---
  // ============================================
  // [SECTION 7] INITIALIZATION & DATA LOADING
  // ============================================
  window.onload = function() {
    // âœ… Check for cached session before requiring login
    // Note: Early check in <head> already hides auth overlay if valid session exists
    const cachedSession = loadAuthSession();
    if (cachedSession || window._hasValidSession) {
      // Use cached session or validate the early check
      const session = cachedSession || loadAuthSession(); // Double-check
      if (session) {
        console.log('ðŸ”“ Restoring cached session:', session.name);
        
        // Set global identity from cache
        window._myEmail = session.email;
        window._myName = session.name;
        window._isManager = session.isManager;
        window._currentUser = session.name;
        
        // Ensure auth-pending is removed (may already be hidden by early check)
        document.body.classList.remove("auth-pending");
        
        // Hide auth overlay explicitly
        const authOverlay = document.getElementById("authOverlay");
        if (authOverlay) authOverlay.style.display = "none";
        
        // Hide login container
        const loginContainer = document.getElementById("authLoginContainer");
        if (loginContainer) loginContainer.style.display = "none";
        
        // âœ… Refresh session timestamp on page load
        refreshSessionTimestamp();
      }
    } else {
      // No valid session - ensure login screen is shown
      document.body.classList.add("auth-pending");
      const authOverlay = document.getElementById("authOverlay");
      if (authOverlay) authOverlay.style.display = "flex";
    }
    
    // âœ… Set up session activity tracking (refresh on user interactions)
    setupSessionActivityTracking();
    
    // âœ… Set up periodic session validation (every 5 minutes)
    setInterval(() => {
      if (window._myEmail) {
        const session = loadAuthSession();
        if (!session) {
          // Session expired, show login
          document.body.classList.add("auth-pending");
          const loginContainer = document.getElementById("authLoginContainer");
          if (loginContainer) loginContainer.style.display = "flex";
        }
      }
    }, 5 * 60 * 1000);
    
    try { load(); } catch (e) { fatal_("Boot Crash", e.message); }
  };
  
  // âœ… NEW: Track user activity to keep session alive
  function setupSessionActivityTracking() {
    const activityEvents = ['click', 'keypress', 'scroll', 'touchstart'];
    let lastRefresh = Date.now();
    const REFRESH_INTERVAL = 5 * 60 * 1000; // Refresh at most every 5 minutes
    
    const handleActivity = () => {
      const now = Date.now();
      if (now - lastRefresh > REFRESH_INTERVAL) {
        if (window._myEmail && typeof refreshSessionTimestamp === 'function') {
          refreshSessionTimestamp();
          lastRefresh = now;
        }
      }
    };
    
    activityEvents.forEach(event => {
      document.addEventListener(event, handleActivity, { passive: true });
    });
  }
  function load(force, targetEmail) {
  // âœ… Show/hide login button based on auth state
  const loginContainer = document.getElementById("authLoginContainer");
  if (loginContainer) {
    loginContainer.style.display = (window._myName && window._myEmail) ? "none" : "flex";
  }
  
  // 1. Gatekeeper: Stop if no identity is present yet
  if (!window._myName && !window._myEmail) {
    console.log("No identity found. Skipping data load until sign-in.");
    return; 
  }
  // 2. Show loading state
  const loadingPlaceholder = $("loadingPlaceholder");
  if (loadingPlaceholder) loadingPlaceholder.style.display = "flex";
  if ($("dayTabs")) $("dayTabs").innerHTML = "";
  if ($("viewDayTitle")) $("viewDayTitle").textContent = "";
  if ($("viewDayStats")) $("viewDayStats").textContent = "";
  
  setView('schedule');
  if ($("calViewWrapper")) $("calViewWrapper").style.display = "none";
  if (targetEmail) _selectedManagerEmail = targetEmail;
  const isManager = window._isManager;
  const myName = window._myName;
  // 3. UI Adjustments based on Role
  if (isManager) {
    // === MANAGER VIEW ===
    document.body.classList.remove("agent-mode");
    document.body.classList.add("manager-mode");
    
    if (typeof startManagerPresenceTracking === "function") startManagerPresenceTracking(); 
    
    // Show manager-only elements
    if ($("btnAdmin")) $("btnAdmin").style.display = "flex";
    if ($("btnMasterMode")) $("btnMasterMode").style.display = "";
    if ($("drawerToggle")) $("drawerToggle").style.display = "";
    if ($("btnAgentToggle")) $("btnAgentToggle").style.display = "none";
    
    // âœ… MANAGER: Ensure Metrics and Goals buttons are VISIBLE
    if ($("btnMetrics")) $("btnMetrics").style.display = ""; 
    if ($("btnGoals")) $("btnGoals").style.display = "";
    
    // Update header title
    const headerTitle = document.querySelector(".hTitle");
    if (headerTitle) headerTitle.textContent = "Scheduling Manager";
    
  } else {
    // === AGENT VIEW ===
    document.body.classList.add("agent-mode");
    document.body.classList.remove("manager-mode");
    
    // Start agent heartbeat for presence tracking
    if (typeof startAgentHeartbeat === "function") startAgentHeartbeat();
    
    // Hide manager-only elements
    if ($("btnAdmin")) $("btnAdmin").style.display = "none";
    if ($("btnMasterMode")) $("btnMasterMode").style.display = "none";
    if ($("drawerToggle")) $("drawerToggle").style.display = "none";
    if ($("btnAgentToggle")) $("btnAgentToggle").style.display = "none";
    
    // âœ… AGENT: FORCE HIDE METRICS BUTTON and Goals button (uses compact bar button instead)
    if ($("btnMetrics")) $("btnMetrics").style.display = "none";
    if ($("btnGoals")) $("btnGoals").style.display = "none";
    
    // Update header title
    const headerTitle = document.querySelector(".hTitle");
    if (headerTitle) headerTitle.textContent = "My Schedule";
    
    // Filter to only show agent's own shifts
    if (myName) {
      _selectedPeople.clear(); 
      _selectedPeople.add(myName);
    }
  }
  // 4. Trigger fetch
  loadSystemData();
  checkUrlNotifs();
  
  // âœ… 5. Trigger Balance Load (so pill/modal works immediately)
  loadBalances();
  
  // âœ… 6. Load agent notifications and show agent UI (for non-managers)
  if (!isManager) {
    if ($("btnAgentNotif")) $("btnAgentNotif").style.display = "flex";
    if ($("agentQuickActions")) $("agentQuickActions").style.display = "flex";
    loadAgentNotifications();
    loadPendingSwaps();
    // âœ… Start polling for new notifications every 60 seconds
    startAgentNotificationPolling();
  } else {
    if ($("btnAgentNotif")) $("btnAgentNotif").style.display = "none";
    if ($("agentQuickActions")) $("agentQuickActions").style.display = "none";
  }
}
  // If value is a pure YYYY-MM-DD (date-only), do NOT convert timezones.
function dayKeyPST(value) {
  if (!value) return "";
  // 1) If backend already sends YYYY-MM-DD, keep it as-is
  if (typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
    return value;
  }
  // 2) If it's a Date (or parseable), decide if itâ€™s "date-only" at UTC midnight
  const d = (value instanceof Date) ? value : new Date(value);
  if (isNaN(d)) return "";
  // If it looks like a date-only stored at 00:00:00Z, keep its UTC day
  if (d.getUTCHours() === 0 && d.getUTCMinutes() === 0 && d.getUTCSeconds() === 0) {
    return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth() + 1)}-${pad2(d.getUTCDate())}`;
  }
  // Otherwise it's a real timestamp -> format by PST
  return formatDatePST(d); // uses Intl + America/Los_Angeles
}
function displayDayLabel(dayKey) {
  if (!dayKey) return "";
  // Defensive: if it's already a label, just return it
  if (typeof dayKey !== "string" || !/^\d{4}-\d{2}-\d{2}$/.test(dayKey)) return String(dayKey);
  const [y, m, d] = dayKey.split("-").map(Number);
  const anchor = new Date(Date.UTC(y, m - 1, d, 12, 0, 0)); // noon UTC anchor
  return new Intl.DateTimeFormat("en-US", {
    timeZone: PST_TZ,
    weekday: "short",
    month: "short",
    day: "numeric",
  }).format(anchor); // -> "Tue, Dec 30"
}
function pstParts(d) {
  const dt = (d instanceof Date) ? d : new Date(d);
  if (isNaN(dt)) return null;
  const parts = new Intl.DateTimeFormat("en-CA", {
    timeZone: PST_TZ,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false,
  }).formatToParts(dt);
  const out = {};
  for (const p of parts) if (p.type !== "literal") out[p.type] = p.value;
  return out;
}
// YYYY-MM-DD in Pacific Time (best for keys/grouping)
function formatDatePST(d) {
  const p = pstParts(d);
  if (!p) return "";
  return `${p.year}-${p.month}-${p.day}`;
}
// HH:MM in Pacific Time (useful for display)
function formatTimePST(d) {
  const p = pstParts(d);
  if (!p) return "";
  return `${p.hour}:${p.minute}`;
}
// If anything calls these from inline handlers, ensure global:
window.formatDatePST = formatDatePST;
window.formatTimePST = formatTimePST;
  async function loadSystemData() {
  console.log("Loading system data...");
  
  // âœ… Refresh session timestamp on data load (user is active)
  if (typeof refreshSessionTimestamp === 'function') {
    refreshSessionTimestamp();
  }
  
  const isManager = window._isManager;
  const myName = window._myName;
  
  // ============================================
  // SMART AUTO-GENERATION (Only once per day, managers only)
  // ============================================
  // Only managers need to trigger generation, and only once per day
  if (isManager) {
    const today = pstISODate();
    const lastGenKey = 'lastAutoGenDate';
    const lastGenDate = localStorage.getItem(lastGenKey);
    
    if (lastGenDate !== today) {
      try {
        console.log("ðŸ”„ Auto-generating 14-day schedule horizon...");
        const genRes = await fetch('./?action=admin/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            days: 14,
            teamKey: "ALL"
          })
        });
        const genData = await genRes.json();
        if (genData.ok) {
          console.log("âœ… 14-day horizon generated");
          localStorage.setItem(lastGenKey, today);
        }
      } catch (e) {
        console.warn("Auto-generate failed; continuing:", e);
      }
    } else {
      console.log("â­ï¸ Skipping auto-generate (already ran today)");
    }
  }
  
  // ============================================
  // AGENT CACHING LOGIC
  // ============================================
  if (!isManager && myName) {
    const cacheKey = `${CACHE_CONFIG.SCHEDULE_KEY}_${myName}`;
    const cachedSchedule = getCachedData(cacheKey);
    
    if (cachedSchedule) {
      console.log("ðŸ“¦ Loading schedule from cache for agent:", myName);
      
      // Use cached data
      _people = cachedSchedule.people || [];
      _teams = cachedSchedule.teams || [];
      _allData = cachedSchedule.allData || [];
      
      // Regenerate time labels with current timezone preference
      _allData.forEach(item => {
        if (item.start) item.startLabel = toAmPm(item.start);
        if (item.end) item.endLabel = toAmPm(item.end);
      });
      
      // Update UI with cached data
      renderTeamChips();
      fillSelect("tpPerson", _people);
      fillSelect("mNewPerson", _people);
      renderQuickRail();
      initFilters();
      
      // Update cache indicator
      updateCacheIndicator(true);
      await loadGlobalRules();
      await loadHolidays();
      
      applyLocalFilters();
      if ($("loadingPlaceholder")) $("loadingPlaceholder").style.display = "none";
      if (_allData.length > 0) renderView();
      
      return; // Skip network fetch
    }
  }
  
  // ============================================
  // FRESH FETCH (Manager or cache miss)
  // ============================================
  try {
    updateCacheIndicator(false);
    
    // 1. Fetch Metadata
    const metaRes = await fetch('/getmetadata', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ isManager: isManager, action: 'getMetadata' })
    });
    const meta = await metaRes.json();
    _peopleMeta = Array.isArray(meta.people) ? meta.people : [];
    _peopleMetaByName = new Map();
    _peopleMeta.forEach(p => {
      const display = String(p.name || p.id || "").trim();
      if (display) _peopleMetaByName.set(display.toLowerCase(), p);
    });
    _people = _peopleMeta.map(p => p.name || p.id).filter(Boolean);
    _teams = (meta.teams || []).map(t => t.id || t.name).filter(Boolean);
    if (!_teams.includes("Lunch")) _teams.push("Lunch");
      if (!_teams.includes("1:1 Meeting")) _teams.push("1:1 Meeting");
    
    // âœ… Fetch roles from Firestore
    try {
      const rolesRes = await fetch('./?action=roles');
      if (rolesRes.ok) {
        const rolesData = await rolesRes.json();
        if (rolesData.roles && rolesData.roles.length > 0) {
          _roles = rolesData.roles.map(r => r.id || r.name).filter(Boolean);
        } else {
          _roles = ["Agent", "Backup 1", "Backup 2", "Captain"]; // Fallback defaults
        }
      } else {
        _roles = ["Agent", "Backup 1", "Backup 2", "Captain"];
      }
    } catch (e) {
      console.warn("Failed to fetch roles, using defaults:", e);
      _roles = ["Agent", "Backup 1", "Backup 2", "Captain"];
    }
    
    _zendeskMetricsList = meta.zendeskMetrics || [];
    _zendeskMetricsByName = new Map();
    _zendeskMetricsList.forEach(r => { 
      if(r && r.agentName) _zendeskMetricsByName.set(String(r.agentName), r); 
    });
    
    _timeOff.clear(); 
    (meta.timeOff || []).forEach(t => _timeOff.add(`${t.person}|${t.dateISO}`));
    renderTeamChips(); 
    fillSelect("tpPerson", _people); 
    fillSelect("mNewPerson", _people); 
    renderQuickRail(); 
    initFilters();
    // 2. Fetch Schedule
    const payload = {
      daysForward: 14,
      targetEmail: _selectedManagerEmail,
      isManager: isManager,
      agentName: myName  // Backend uses this to filter for agents
    };
    const today = pstISODate();
    const shiftRes = await fetch(`/initdashboard?start=${today}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ...payload, action: "initdashboard" })
    });
    
    const shifts = await shiftRes.json();
    if (shifts && shifts.schedule && shifts.schedule.results) {
      _allData = [];
      shifts.schedule.results.forEach(day => {
        if (day.assignments) {
          day.assignments.forEach(a => {
            const docId = String(day.id || "");
            const teamName = (docId.includes("__") ? docId.split("__")[1] : "") || day.team || "General";
            const assignmentId = a.assignmentId ?? a.id ?? a.assignment_id ?? a.assignmentID ?? "";
            const dayKey = dayKeyPST(day.date);
            _allData.push({
              ...a,
              docId,
              assignmentId,
              date: day.date,
              dateISO: dayKey,
              dayKey,
              dateLabel: dayKey,
              team: teamName,
              startLabel: toAmPm(a.start),
              endLabel: toAmPm(a.end),
            });
          });
        }
      });
    }
    // ============================================
    // CACHE THE DATA FOR AGENTS
    // ============================================
    if (!isManager && myName) {
      const cacheKey = `${CACHE_CONFIG.SCHEDULE_KEY}_${myName}`;
      setCachedData(cacheKey, {
        people: _people,
        teams: _teams,
        allData: _allData
      });
    }

    // Check for pending requests on load (managers only)
    if (isManager) {
      loadTimeOffCount();
    }
    
    // 3. Finalize View
    await loadGlobalRules();
    await loadHolidays();
    _scheduleLoadedPast = 0;
  _scheduleLoadedFuture = 14;
  _agentScheduleDays = 14; // Reset agent days tracking
  updateLoadedRangeLabel();
  updateAgentRangeLabel();  
    applyLocalFilters();
    if ($("loadingPlaceholder")) $("loadingPlaceholder").style.display = "none";
    if (_allData.length > 0) renderView();
  } catch (e) {
    console.error("System Data Load Failed:", e);
    if ($("loadingPlaceholder")) $("loadingPlaceholder").style.display = "none";
    fatal_("Data Load Failed", e);
  }
}
let _staffingRules = []; // Global variable to store rules
async function loadGlobalRules() {
  try {
    const res = await fetch('./?action=staffing/rules');
    if (res.ok) _staffingRules = await res.json();
  } catch (e) { console.error("Rules load error", e); }
}
function updateCacheIndicator(fromCache) {
  // Remove any existing indicator
  const existingIndicator = document.getElementById('cacheIndicator');
  if (existingIndicator) existingIndicator.remove();
  
  // For non-managers, show a subtle notification that auto-hides
  if (fromCache && !window._isManager) {
    // Show a brief toast instead of persistent indicator
    const indicator = document.createElement('div');
    indicator.id = 'cacheIndicator';
    indicator.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 10px 16px;
      background: rgba(251, 191, 36, 0.95);
      color: #92400e;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideUp 0.3s ease-out;
    `;
    indicator.innerHTML = 'ðŸ“¦ Cached data <span style="opacity:0.7; font-weight:400;">â€¢ Click to refresh</span>';
    indicator.title = 'Showing cached data. Click to reload latest schedule.';
    
    indicator.onclick = function() {
      this.style.opacity = '0.5';
      this.style.pointerEvents = 'none';
      clearScheduleCache();
      load();
      toast('â™»ï¸ Refreshing data...', 'info');
    };
    
    indicator.onmouseenter = function() {
      this.style.transform = 'scale(1.02)';
    };
    indicator.onmouseleave = function() {
      this.style.transform = 'scale(1)';
    };
    
    document.body.appendChild(indicator);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      if (indicator && indicator.parentNode) {
        indicator.style.transition = 'opacity 0.3s, transform 0.3s';
        indicator.style.opacity = '0';
        indicator.style.transform = 'translateY(20px)';
        setTimeout(() => indicator.remove(), 300);
      }
    }, 5000);
  }
}
  // ============================================
  // [SECTION 8] SCHEDULE RENDERING
  // ============================================
  function renderView() {
  // If we are in metrics view, show that
  if (_view === "metrics") {
    $("scheduleView").style.display = "none";
    $("metricsView").style.display = "block";
    renderMetricsList();
    return; // Stop here
  }
  // Otherwise, default to the new SCHEDULE view
  $("scheduleView").style.display = "flex";
  $("metricsView").style.display = "none";
  
  // Render the new Single Day view
  renderScheduleView();
  
  // Update agent schedule banner (agents only)
  if (!window._isManager) {
    updateAgentScheduleBanner();
    // Load assignments for dashboard banner
    loadAgentDashboardAssignments();
  }
  
  // Update the coverage banner (Managers only)
  if (window._isManager) {
    renderCoverageCard();
  }
}
  async function wipeFutureSchedule() {
  const result = await Swal.fire({
    title: 'âš ï¸ Wipe Schedule Data',
    html: `
      <div style="text-align:left; padding:10px;">
        <p style="color:#ef4444; font-weight:600; margin-bottom:16px;">Select what to delete:</p>
        
        <label style="display:flex; align-items:center; gap:10px; padding:12px; background:#fef2f2; border:1px solid #fecaca; border-radius:8px; margin-bottom:10px; cursor:pointer;">
          <input type="radio" name="wipeScope" value="future" checked style="width:18px; height:18px;">
          <div>
            <div style="font-weight:600; color:#dc2626;">Future Only</div>
            <div style="font-size:12px; color:#64748b;">Delete from today onwards</div>
          </div>
        </label>
        
        <label style="display:flex; align-items:center; gap:10px; padding:12px; background:#fff7ed; border:1px solid #fed7aa; border-radius:8px; margin-bottom:10px; cursor:pointer;">
          <input type="radio" name="wipeScope" value="all" style="width:18px; height:18px;">
          <div>
            <div style="font-weight:600; color:#c2410c;">Everything</div>
            <div style="font-size:12px; color:#64748b;">Delete ALL schedule data (past + future)</div>
          </div>
        </label>
        
        <div style="font-size:12px; color:#94a3b8; margin-top:12px;">
          âš ï¸ This action cannot be undone. Use "Regenerate" after to create new schedules.
        </div>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'ðŸ—‘ï¸ Delete Selected',
    cancelButtonText: 'Cancel',
    preConfirm: () => {
      const scope = document.querySelector('input[name="wipeScope"]:checked')?.value || 'future';
      return { scope };
    }
  });
  
  if (!result.isConfirmed) return;
  
  const wipePast = result.value.scope === 'all';
  
  // Show loading
  Swal.fire({
    title: 'Wiping Schedule...',
    html: wipePast ? 'Deleting ALL schedule data...' : 'Deleting future schedule days...',
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => Swal.showLoading()
  });
  
  try {
    const res = await fetch('./?action=admin/wipe-future', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ confirm: true, includePast: wipePast })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      Swal.fire({
        icon: 'success',
        title: 'Schedule Wiped!',
        html: `<div>Deleted <strong>${data.deleted}</strong> schedule days.</div>
               <div style="margin-top:10px; font-size:13px; color:#64748b;">
                 Use "Regenerate" to create the new schedule.
               </div>`,
        confirmButtonColor: '#16a34a'
      });
      
      // Clear local data and refresh
      _allData = [];
      loadSystemData();
    } else {
      throw new Error(data.error || 'Wipe failed');
    }
  } catch (err) {
    Swal.fire({
      icon: 'error',
      title: 'Wipe Failed',
      text: err.message,
      confirmButtonColor: '#ef4444'
    });
  }
}

// Master Schedule (Template) Draft Editing
let _masterOriginalData = null; // snapshot from server
let _masterDraftData = null;    // editable working copy
let _masterEditEnabled = false; // must click Edit first

function deepClone(obj) {
  return JSON.parse(JSON.stringify(obj || {}));
}

function renderQuickStats() {
  // Only show for managers
  if (!window._isManager) return;
  
  const todayISO = pstISODate();
  const todayShifts = _allData.filter(s => s.dateISO === todayISO || dayKeyPST(s.date) === todayISO);
  
  // Count by channel
  const channelCounts = {};
  let offCount = 0;
  
  todayShifts.forEach(s => {
    const channel = s.team || 'Other';
    channelCounts[channel] = (channelCounts[channel] || 0) + 1;
    
    const notes = String(s.notes || '').toLowerCase();
    if (notes.includes('[off]')) offCount++;
  });
  
  // Remove existing stats bar
  const existing = document.getElementById('quickStatsBar');
  if (existing) existing.remove();
  
  // Create stats bar
  const bar = document.createElement('div');
  bar.id = 'quickStatsBar';
  bar.style.cssText = `
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 12px 20px;
    margin:  0 20px 16px 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
  `;
  
  let statsHtml = `
    <div style="font-weight:800; color:#0f172a; font-size: 14px;">
      ðŸ“Š Today's Coverage
    </div>
    <div style="height:20px; width:1px; background:#e2e8f0;"></div>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
  `;
  
  // Add channel counts
  Object.entries(channelCounts).sort((a, b) => b[1] - a[1]).slice(0, 6).forEach(([channel, count]) => {
    const config = CHANNEL_CONFIG[channel] || { abbrev: channel.substring(0, 2), color: '#f1f5f9', text: '#475569' };
    statsHtml += `
      <div style="
        background: ${config.color};
        color: ${config.text};
        padding: 4px 10px;
        border-radius:  6px;
        font-size:  12px;
        font-weight: 700;
      ">
        ${config.abbrev}:  ${count}
      </div>
    `;
  });
  
  // Add off count if any
  if (offCount > 0) {
    statsHtml += `
      <div style="
        background: #fef2f2;
        color: #dc2626;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight:  700;
      ">
        â›” ${offCount} OFF
      </div>
    `;
  }
  
  statsHtml += `
    </div>
    <div style="margin-left:auto; font-size:11px; color:#94a3b8;">
      ${todayShifts.length} total shifts
    </div>
  `;
  
  bar.innerHTML = statsHtml;
  
  // Insert at top of content area
  const content = document.querySelector('.content');
  if (content) {
    content.insertBefore(bar, content.firstChild);
  }
}

async function openAddAgentModal() {
  const { value: formValues } = await Swal.fire({
    title: "Add New Agent",
    html: `
      <div style="text-align:left;">
        <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:4px; text-transform:uppercase;">Full Name *</label>
        <input id="aaName" class="swal2-input" placeholder="e.g., John Smith" style="margin:0 0 12px 0;">
        
        <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:4px; text-transform:uppercase;">Email *</label>
        <input id="aaEmail" class="swal2-input" placeholder="john@company.com" style="margin:0 0 12px 0;">
        
        <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:4px; text-transform:uppercase;">Role</label>
        <select id="aaRole" class="swal2-select" style="margin:0 0 12px 0; width:100%; padding:10px; border:1px solid var(--border-color, #e2e8f0); border-radius:8px;">
          <option value="agent">Agent (Standard Access)</option>
          <option value="admin">Admin (Full Access)</option>
        </select>
        
        <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:4px; text-transform:uppercase;">Chat User ID (optional)</label>
        <input id="aaChat" class="swal2-input" placeholder="For Google Chat notifications" style="margin:0;">
      </div>
    `,
    focusConfirm: false,
    showCancelButton: true,
    confirmButtonText: "Add Agent",
    confirmButtonColor: "#16a34a",
    preConfirm: () => {
      const name = document.getElementById("aaName").value.trim();
      const email = document.getElementById("aaEmail").value.trim();
      const role = document.getElementById("aaRole").value;
      const chatUserId = document.getElementById("aaChat").value.trim();
      if (!name || !email) {
        Swal.showValidationMessage("Name and email are required.");
        return;
      }
      if (!email.includes("@")) {
        Swal.showValidationMessage("Please enter a valid email address.");
        return;
      }
      return { name, email, role, chatUserId };
    }
  });

  if (!formValues) return;

  try {
    Swal.fire({ title: "Adding agent...", allowOutsideClick:false, showConfirmButton:false, didOpen: () => Swal.showLoading() });

    const res = await fetch("./?action=people/add", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(formValues)
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Failed to add agent");

    // Refresh metadata to get the new agent in _people list
    await loadSystemData();
    
    // If we're in Master Schedule view, refresh it
    const masterView = document.getElementById("masterView");
    if (masterView && masterView.style.display !== "none") {
      renderMasterView(_masterRawData || {});
    }
    
    Swal.fire({ 
      icon:"success", 
      title:"Agent Added!", 
      html:`<div style="text-align:left;">
        <p><strong>${formValues.name}</strong> has been added to the system.</p>
        <p style="font-size:12px; color:#64748b; margin-top:8px;">Document ID: <code>${data.docId}</code></p>
        <p style="font-size:12px; color:#64748b;">Role: ${formValues.role}</p>
        <p style="font-size:12px; color:#16a34a; margin-top:8px;">âœ“ Agent will appear in Master Schedule</p>
      </div>`,
      confirmButtonColor:"#16a34a" 
    });
  } catch (e) {
    console.error(e);
    Swal.fire({ icon:"error", title:"Add failed", text:e.message, confirmButtonColor:"#ef4444" });
  }
}

// Open Agent Management Modal
async function openManageAgentsModal() {
  Swal.fire({ title: "Loading agents...", allowOutsideClick:false, showConfirmButton:false, didOpen: () => Swal.showLoading() });
  
  try {
    const res = await fetch("./?action=people/list");
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Failed to load agents");
    
    const agents = data.people || [];
    
    let tableHtml = `
      <div style="max-height:400px; overflow-y:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="background:var(--bg-tertiary, #f8fafc); position:sticky; top:0;">
              <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border-color, #e2e8f0);">Name</th>
              <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border-color, #e2e8f0);">Email</th>
              <th style="padding:10px; text-align:center; border-bottom:2px solid var(--border-color, #e2e8f0);">Role</th>
              <th style="padding:10px; text-align:center; border-bottom:2px solid var(--border-color, #e2e8f0);">Status</th>
              <th style="padding:10px; text-align:center; border-bottom:2px solid var(--border-color, #e2e8f0);">Actions</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    agents.sort((a, b) => (a.name || a.docId).localeCompare(b.name || b.docId)).forEach(agent => {
      const isActive = agent.active !== false;
      const role = agent.role || 'agent';
      const roleColor = role === 'admin' ? '#7c3aed' : '#64748b';
      const statusColor = isActive ? '#16a34a' : '#ef4444';
      
      tableHtml += `
        <tr style="border-bottom:1px solid var(--border-color, #e2e8f0);">
          <td style="padding:10px; font-weight:600; color:var(--text-primary, #0f172a);">${agent.name || agent.docId}</td>
          <td style="padding:10px; color:var(--text-secondary, #64748b); font-size:12px;">${agent.email || '-'}</td>
          <td style="padding:10px; text-align:center;">
            <span style="background:${roleColor}20; color:${roleColor}; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600; text-transform:uppercase;">${role}</span>
          </td>
          <td style="padding:10px; text-align:center;">
            <span style="color:${statusColor}; font-size:11px; font-weight:600;">${isActive ? 'â— Active' : 'â—‹ Inactive'}</span>
          </td>
          <td style="padding:10px; text-align:center;">
            <button onclick="editAgentModal('${agent.docId}')" style="background:#b37e78; color:white; border:none; padding:4px 10px; border-radius:6px; font-size:11px; cursor:pointer; font-weight:600;">Edit</button>
          </td>
        </tr>
      `;
    });
    
    tableHtml += `</tbody></table></div>`;
    
    Swal.fire({
      title: "ðŸ‘¥ Manage Agents",
      html: tableHtml,
      width: 700,
      showConfirmButton: false,
      showCloseButton: true,
      footer: '<button onclick="Swal.close(); openAddAgentModal();" style="background:#16a34a; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer;">+ Add New Agent</button>'
    });
  } catch (e) {
    console.error(e);
    Swal.fire({ icon:"error", title:"Load failed", text:e.message, confirmButtonColor:"#ef4444" });
  }
}

// Edit a specific agent
async function editAgentModal(docId) {
  Swal.fire({ title: "Loading...", allowOutsideClick:false, showConfirmButton:false, didOpen: () => Swal.showLoading() });
  
  try {
    const res = await fetch("./?action=people/list");
    const data = await res.json();
    if (!data.ok) throw new Error("Failed to load agent data");
    
    const agent = data.people.find(p => p.docId === docId);
    if (!agent) throw new Error("Agent not found");
    
    const { value: formValues } = await Swal.fire({
      title: `Edit Agent: ${agent.name || docId}`,
      html: `
        <div style="text-align:left;">
          <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:4px; text-transform:uppercase;">Full Name</label>
          <input id="eaName" class="swal2-input" value="${agent.name || ''}" style="margin:0 0 12px 0;">
          
          <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:4px; text-transform:uppercase;">Email</label>
          <input id="eaEmail" class="swal2-input" value="${agent.email || ''}" style="margin:0 0 12px 0;">
          
          <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:4px; text-transform:uppercase;">Role</label>
          <select id="eaRole" class="swal2-select" style="margin:0 0 12px 0; width:100%; padding:10px; border:1px solid var(--border-color, #e2e8f0); border-radius:8px;">
            <option value="agent" ${agent.role !== 'admin' ? 'selected' : ''}>Agent (Standard Access)</option>
            <option value="admin" ${agent.role === 'admin' ? 'selected' : ''}>Admin (Full Access)</option>
          </select>
          
          <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:4px; text-transform:uppercase;">Chat User ID</label>
          <input id="eaChat" class="swal2-input" value="${agent.chatUserId || ''}" style="margin:0 0 12px 0;">
          
          <label style="display:block; font-size:11px; font-weight:600; color:var(--text-secondary, #64748b); margin-bottom:4px; text-transform:uppercase;">Status</label>
          <select id="eaActive" class="swal2-select" style="margin:0; width:100%; padding:10px; border:1px solid var(--border-color, #e2e8f0); border-radius:8px;">
            <option value="true" ${agent.active !== false ? 'selected' : ''}>Active</option>
            <option value="false" ${agent.active === false ? 'selected' : ''}>Inactive</option>
          </select>
          
          <div style="margin-top:12px; padding:8px; background:#f8fafc; border-radius:6px; font-size:11px; color:#64748b;">
            Document ID: <code>${docId}</code>
          </div>
        </div>
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: "Save Changes",
      confirmButtonColor: "#b37e78",
      preConfirm: () => {
        return {
          docId: docId,
          name: document.getElementById("eaName").value.trim(),
          email: document.getElementById("eaEmail").value.trim(),
          role: document.getElementById("eaRole").value,
          chatUserId: document.getElementById("eaChat").value.trim(),
          active: document.getElementById("eaActive").value === 'true'
        };
      }
    });
    
    if (!formValues) {
      openManageAgentsModal(); // Go back to list
      return;
    }
    
    Swal.fire({ title: "Saving...", allowOutsideClick:false, showConfirmButton:false, didOpen: () => Swal.showLoading() });
    
    const updateRes = await fetch("./?action=people/update", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(formValues)
    });
    const updateData = await updateRes.json();
    if (!updateData.ok) throw new Error(updateData.error || "Update failed");
    
    await loadSystemData();
    
    Swal.fire({ 
      icon:"success", 
      title:"Agent Updated!", 
      confirmButtonColor:"#16a34a",
      didClose: () => openManageAgentsModal()
    });
  } catch (e) {
    console.error(e);
    Swal.fire({ icon:"error", title:"Error", text:e.message, confirmButtonColor:"#ef4444" });
  }
}

function calculateCoverageForToday() {
  // Get today's date in PST
  const todayISO = pstISODate();
  
  // Filter shifts for today only
  const todayShifts = _filteredData.filter(s => {
    const shiftDate = s.dateISO || dayKeyPST(s.date);
    return shiftDate === todayISO;
  });
  
  // Count shifts per channel
  const channelCounts = new Map();
  todayShifts.forEach(s => {
    const channel = s.team || "Other";
    const notes = String(s.notes || "").toLowerCase();
    const isOff = notes.includes("[off]");
    
    if (!isOff) {
      channelCounts.set(channel, (channelCounts.get(channel) || 0) + 1);
    }
  });
  
  // Compare against staffing rules
  const coverage = [];
  
  // Get day of week for rule matching
  const today = new Date();
  const dayOfWeek = today.toLocaleDateString("en-US", { 
    weekday: 'short', 
    timeZone: PST_TZ 
  }); // "Mon", "Tue", etc.
  
  _staffingRules.forEach(rule => {
    // Check if rule applies to today
    if (rule.day !== "All" && rule.day !== dayOfWeek) return;
    
    const channel = rule.team;
    const min = parseInt(rule.min) || 0;
    const current = channelCounts.get(channel) || 0;
    const config = CHANNEL_CONFIG[channel] || {};
    const abbrev = config.abbrev || channel.substring(0, 3).toUpperCase();
    
    let status = "good";
    if (current < min) {
      status = current < (min * 0.5) ? "critical" : "warning";
    }
    
    coverage.push({
      channel,
      abbrev,
      current,
      min,
      status,
      diff: current - min
    });
  });
  
  return coverage;
}
function renderCoverageCard() {
  renderCoverageDashboard();
}

// Modern Coverage Dashboard Renderer - Redesigned
// ============================================
// [SECTION 9] COVERAGE DASHBOARD
// ============================================
function renderCoverageDashboard() {
  const dashboard = document.getElementById("coverageDashboard");
  const panel = document.getElementById("covPanel");
  const badge = document.getElementById("covBadge");
  const badgeText = document.getElementById("covBadgeText");
  const subtitle = document.getElementById("covSubtitle");
  const content = document.getElementById("covContent");

  // Coverage dashboard only for managers
  if (!dashboard || !window._isManager) {
    if (dashboard) dashboard.style.display = "none";
    return;
  }

  dashboard.style.display = "block";
  const todayKey = pstISODate();

  // Shifts today (exclude OFF)
  const todayShifts = _filteredData.filter(s => {
    const k = s.dayKey || s.dateISO || dayKeyPST(s.date);
    return k === todayKey && !String(s.notes || "").toUpperCase().includes("[OFF]");
  });

  // Time blocks
  const blocks = [
    { label: "6a-8a", start: 6, end: 8 },
    { label: "8a-10a", start: 8, end: 10 },
    { label: "10a-12p", start: 10, end: 12 },
    { label: "12p-2p", start: 12, end: 14 },
    { label: "2p-4p", start: 14, end: 16 },
    { label: "4p-6p", start: 16, end: 18 },
    { label: "6p-8p", start: 18, end: 20 }
  ];

  const nowPST = new Date(new Date().toLocaleString("en-US", { timeZone: "America/Los_Angeles" }));
  const currentHour = nowPST.getHours();

  // Count active shifts
  const activeNow = todayShifts.filter(s => {
    const startH = parseTimeDecimal(s.start);
    const endH = parseTimeDecimal(s.end);
    return startH <= currentHour && endH > currentHour;
  }).length;

  const coversBlock = (shift, blockStart, blockEnd) => {
    if (!shift.start || !shift.end) return false;
    const s = parseTimeDecimal(shift.start);
    const e = parseTimeDecimal(shift.end);
    return s <= blockStart && e >= blockEnd;
  };

  // If no rules, show empty state
  if (!_staffingRules || _staffingRules.length === 0) {
    badge.className = "cov-badge warn";
    badgeText.textContent = "No Rules";
    subtitle.textContent = "Add staffing rules in Admin Tools";
    content.innerHTML = `
      <div class="cov-empty">
        <div class="cov-empty-icon">ðŸ“‹</div>
        <div class="cov-empty-title">No Staffing Rules</div>
        <div class="cov-empty-desc">Add staffing rules in Admin Tools to see coverage analysis</div>
      </div>`;
    return;
  }

  const todayDOW = new Date().toLocaleDateString("en-US", { weekday: "short", timeZone: PST_TZ });
  const isWeekday = ["Mon", "Tue", "Wed", "Thu", "Fri"].includes(todayDOW);
  const isWeekend = ["Sat", "Sun"].includes(todayDOW);

  let totalGaps = 0;
  const teamsWithGaps = [];

  _staffingRules.forEach(rule => {
    const dayMatch =
      rule.day === "All" ||
      rule.day === todayDOW ||
      (rule.day === "Weekday" && isWeekday) ||
      (rule.day === "Weekend" && isWeekend);

    if (!dayMatch) return;

    const min = parseInt(rule.min) || 0;
    const channel = rule.team;
    const config = getChannelConfig(channel);

    let openHour, closeHour;
    if (rule.startHour !== undefined && rule.endHour !== undefined && rule.timeBlock !== "all") {
      openHour = parseInt(rule.startHour) || 0;
      closeHour = parseInt(rule.endHour) || 24;
    } else {
      [openHour, closeHour] = config.hours || [8, 17];
    }

    const gaps = [];

    blocks.forEach(blk => {
      if (blk.end <= currentHour) return;
      if (blk.start < openHour || blk.end > closeHour) return;

      const count = todayShifts.filter(s =>
        s.team === channel && coversBlock(s, blk.start, blk.end)
      ).length;

      if (count < min) {
        gaps.push({ label: blk.label, count, min });
        totalGaps++;
      }
    });

    if (gaps.length > 0) {
      teamsWithGaps.push({
        channel,
        abbrev: config.abbrev || channel.substring(0, 3).toUpperCase(),
        color: config.color,
        textColor: config.text,
        min,
        gaps
      });
    }
  });

  // Update badge and subtitle
  if (totalGaps > 0) {
    badge.className = "cov-badge alert";
    badgeText.textContent = totalGaps + " Gap" + (totalGaps === 1 ? "" : "s");
    subtitle.textContent = totalGaps + " staffing gap" + (totalGaps === 1 ? "" : "s") + " detected";
  } else if (currentHour >= 20) {
    badge.className = "cov-badge ok";
    badgeText.textContent = "Day Complete";
    subtitle.textContent = "All shifts completed successfully";
  } else {
    badge.className = "cov-badge ok";
    badgeText.textContent = "All Good";
    subtitle.textContent = "All channels fully staffed";
  }

  // Build content
  let html = '';

  // Stats row
  html += `
    <div class="cov-stats">
      <div class="cov-stat">
        <div class="cov-stat-num">${todayShifts.length}</div>
        <div class="cov-stat-label">Total Shifts</div>
      </div>
      <div class="cov-stat">
        <div class="cov-stat-num">${activeNow}</div>
        <div class="cov-stat-label">Active Now</div>
      </div>
      <div class="cov-stat ${totalGaps > 0 ? 'gap-stat' : ''}">
        <div class="cov-stat-num">${totalGaps > 0 ? totalGaps : 'âœ“'}</div>
        <div class="cov-stat-label">${totalGaps > 0 ? 'Coverage Gaps' : 'Fully Staffed'}</div>
      </div>
    </div>`;

  // Show gaps or all-good message
  if (teamsWithGaps.length === 0) {
    html += `
      <div class="cov-all-good">
        <div class="cov-all-good-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="cov-all-good-title">All Channels Fully Staffed</div>
        <div class="cov-all-good-desc">No coverage gaps detected for remaining time blocks</div>
      </div>`;
  } else {
    html += `
      <div class="cov-gaps-section">
        <div class="cov-gaps-header">
          <span class="cov-gaps-title">Gaps Requiring Coverage</span>
          <span class="cov-gaps-hint">Click a shift to reassign</span>
        </div>
        <div class="cov-gaps-list">`;

    teamsWithGaps.forEach(team => {
      const shifts = todayShifts
        .filter(s => s.team === team.channel && !String(s.notes || "").toUpperCase().includes("[OFF]"))
        .sort((a, b) => parseTimeDecimal(a.start) - parseTimeDecimal(b.start));

      const timePills = team.gaps.map(g => 
        `<span class="cov-time-pill">${escapeHtml(g.label)} <span class="cov-time-count">${g.count}/${g.min}</span></span>`
      ).join("");

      const shiftButtons = shifts.length ? shifts.map(s => {
        const dayKey = s.dateISO || s.dayKey || dayKeyPST(s.date) || s.date;
        const item = {
          ...s,
          dateISO: dayKey,
          dateLabel: s.dateLabel || displayDayLabel(dayKey),
          startLabel: s.startLabel || toAmPm(s.start) || s.start || "",
          endLabel: s.endLabel || toAmPm(s.end) || s.end || ""
        };
        return `<button type="button" class="cov-shift-btn" onclick='openReplaceModal(${JSON.stringify(item).replace(/</g,"\\u003c")})'>
          <span class="cov-shift-time">${escapeHtml(item.startLabel)} - ${escapeHtml(item.endLabel)}</span>
          <span class="cov-shift-person">${escapeHtml(item.person || "Unassigned")}</span>
        </button>`;
      }).join("") : `<div style="padding:8px;color:var(--text-secondary);font-size:12px;">No shifts scheduled</div>`;

      html += `
        <div class="cov-gap-card">
          <div class="cov-gap-head">
            <div class="cov-gap-team">
              <span class="cov-gap-badge" style="background:${team.color};color:${team.textColor};">${escapeHtml(team.abbrev)}</span>
              <span class="cov-gap-name">${escapeHtml(team.channel)}</span>
            </div>
            <span class="cov-gap-info">${team.gaps.length} gap${team.gaps.length === 1 ? '' : 's'}</span>
          </div>
          <div class="cov-gap-times">${timePills}</div>
          <div class="cov-gap-shifts">${shiftButtons}</div>
        </div>`;
    });

    html += `</div></div>`;
  }

  content.innerHTML = html;
  
  // Also check for open shifts
  updateCoverageOpenShifts();
}

// Toggle coverage dashboard expansion
function toggleCoverageDashboard() {
  const panel = document.getElementById("covPanel");
  if (panel) panel.classList.toggle("expanded");
}

// Legacy compatibility
function toggleCoverage() {
  toggleCoverageDashboard();
}

function normalizeChannelName(name) {
  if (!name) return 'other';
  const n = name.toLowerCase().replace(/[\s\-_\/]+/g, '');
  
  if (n.includes('livechat') || n === 'lc') return 'livechat';
  if (n.includes('phone') || n === 'ph') return 'phone';
  if (n.includes('email') || n.includes('floater') || n === 'float') return 'emailfloater';
  if (n.includes('social') || n === 'ss' || n === 'soc') return 'socials';
  if (n.includes('dispute') || n === 'dis') return 'disputes';
  if (n.includes('md') || n.includes('medical')) return 'mdsupport';
  if (n.includes('project') || n === 'proj') return 'projects';
  if (n.includes('lunch')) return 'lunch';
  if (n.includes('1:1') || n.includes('11meeting')) return '1:1meetings';
  if (n.includes('meeting') || n === 'mtg') return 'meeting';
  if (n.includes('custom')) return 'custom';
  if (n.includes('defcon')) return 'defcon';
  
  return n;
}
async function logEndOfDaySummary() {
  const result = await Swal.fire({
    title: 'Log End-of-Day Report?',
    text: "This will analyze today's staffing and save a summary to the Audit Log.",
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Yes, Save Log',
    confirmButtonColor: '#1e293b'
  });
  if (!result.isConfirmed) return;
  // 1. Setup Data
  const todayKey = pstISODate();
  const todayShifts = _allData.filter(s => 
    (s.dateISO === todayKey || dayKeyPST(s.date) === todayKey) && 
    !(s.notes || '').includes('[OFF]')
  );
  const blocks = [
    { label: "6a-8a", start: 6, end: 8 },
    { label: "8a-10a", start: 8, end: 10 },
    { label: "10a-12p", start: 10, end: 12 },
    { label: "12p-2p", start: 12, end: 14 },
    { label: "2p-4p", start: 14, end: 16 },
    { label: "4p-6p", start: 16, end: 18 },
    { label: "6p-8p", start: 18, end: 20 }
  ];
  let report = [];
  
  if (!_staffingRules || _staffingRules.length === 0) {
    return toast("No staffing rules to check against", "warning");
  }
  const todayDOW = new Date().toLocaleDateString('en-US', { weekday: 'short' });
  const isWeekday = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].includes(todayDOW);
  const isWeekend = ['Sat', 'Sun'].includes(todayDOW);
  
  _staffingRules.forEach(rule => {
    // Check if rule applies to today
    const dayMatch = rule.day === 'All' || 
                     rule.day === todayDOW ||
                     (rule.day === 'Weekday' && isWeekday) ||
                     (rule.day === 'Weekend' && isWeekend);
    if (!dayMatch) return;
    const channel = rule.team;
    const min = parseInt(rule.min) || 0;
    
    // Use rule's time block hours if specified, otherwise use config hours
    const config = getChannelConfig(channel);
    let openHour, closeHour;
    if (rule.startHour !== undefined && rule.endHour !== undefined && rule.timeBlock !== 'all') {
      openHour = parseInt(rule.startHour) || 0;
      closeHour = parseInt(rule.endHour) || 24;
    } else {
      [openHour, closeHour] = config.hours || [8, 17];
    }
    const teamGaps = [];
    blocks.forEach(blk => {
      // Skip this block if it's outside the rule's time range
      if (blk.start < openHour || blk.end > closeHour) return;
      const count = todayShifts.filter(s => {
        if (s.team !== channel) return false;
        if (!s.start || !s.end) return false;
        
        const start = parseTimeDecimal(s.start);
        const end = parseTimeDecimal(s.end);
        
        // Strict Check: Shift must cover this block
        return start <= blk.start && end >= blk.end;
      }).length;
      if (count < min) {
        teamGaps.push(`${blk.label} (${count}/${min})`);
      }
    });
    if (teamGaps.length > 0) {
      report.push(`${config.abbrev}: ${teamGaps.join(', ')}`);
    }
  });
  // 3. Create Log Message
  let summary = "";
  let actionType = "EOD REPORT";
  
  if (report.length === 0) {
    summary = "âœ… All staffing targets met for the day.";
    actionType = "EOD SUCCESS";
  } else {
    summary = "âš ï¸ Gaps: " + report.join(" | ");
    actionType = "EOD ALERT";
  }
  // 4. Send to Backend
  logAuditEntry({
    action: actionType,
    manager: window._myName || "System",
    target: "Daily Schedule",
    date: todayKey,
    details: summary
  });
  toast("Daily summary logged to Audit History", "success");
}
function parseTimeDecimal(t) {
  if (!t) return 0;
  const [h, m] = t.split(':').map(Number);
  return h + (m || 0) / 60;
}
async function regenerateAllSchedule() {
  const result = await Swal.fire({
    title: 'ðŸ”„ Regenerate Entire Schedule?',
    html: `
      <div style="text-align:left; padding:10px;">
        <p style="font-weight:600; color:#1e293b;">This will:</p>
        <ol style="font-size:13px; color:#64748b; margin-top:10px;">
          <li style="margin-bottom:8px;"><span style="color:#ef4444; font-weight:600;">DELETE</span> all scheduled shifts from today onwards</li>
          <li style="margin-bottom:8px;"><span style="color:#16a34a; font-weight:600;">GENERATE</span> fresh shifts from the Master Schedule template</li>
        </ol>
        <div style="margin-top:15px; padding:10px; background:#fef3c7; border-radius:8px; border:1px solid #fcd34d;">
          <strong style="color:#92400e;">âš ï¸ Warning:</strong>
          <span style="color:#92400e; font-size:12px;">Any manual changes made to existing shifts will be lost!</span>
        </div>
      </div>
      <div style="margin-top:15px;">
        <label style="font-size:12px; font-weight:600; color:#64748b;">Days to Generate:</label>
        <input type="number" id="regenDays" value="14" min="1" max="31" 
               style="width:80px; padding:8px; border:1px solid #cbd5e1; border-radius:6px; margin-left:10px;">
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#b37e78',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'ðŸ”„ Yes, Regenerate',
    cancelButtonText: 'Cancel',
    preConfirm: () => {
      const days = document.getElementById('regenDays').value;
      return { days: parseInt(days) || 14 };
    }
  });
  if (!result.isConfirmed) return;
  const daysToGen = result.value.days;
  // Show loading
  Swal.fire({
    title: 'Regenerating Schedule...',
    html: `
      <div style="margin-bottom:10px;">Step 1: Wiping old schedule...</div>
      <div style="font-size:12px; color:#64748b;">This may take a moment...</div>
    `,
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => Swal.showLoading()
  });
  try {
    const res = await fetch('./?action=admin/regenerate-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ confirm: true, days: daysToGen })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      Swal.fire({
        icon: 'success',
        title: 'âœ… Schedule Regenerated!',
        html: `
          <div style="text-align:left; padding:10px; background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0;">
            <div style="margin-bottom:8px;">ðŸ—‘ï¸ <strong>Deleted:</strong> ${data.deleted} old schedule days</div>
            <div style="margin-bottom:8px;">âœ¨ <strong>Generated:</strong> ${data.generated} new schedule documents</div>
            <div style="margin-bottom:8px;">ðŸ‘¤ <strong>Total Shifts:</strong> ${data.totalAssignments || 'N/A'}</div>
            <div style="margin-bottom:8px;">ðŸ“… <strong>Days Forward:</strong> ${data.daysForward}</div>
            <div>ðŸ‘¥ <strong>Teams:</strong> ${data.teams?.join(', ') || 'All'}</div>
          </div>
        `,
        confirmButtonColor: '#16a34a',
        confirmButtonText: 'Refresh Dashboard'
      }).then(() => {
        // Clear cache and reload
        clearScheduleCache();
        load(true);
      });
    } else {
      throw new Error(data.error || 'Regeneration failed');
    }
  } catch (err) {
    Swal.fire({
      icon: 'error',
      title: 'Regeneration Failed',
      text: err.message,
      confirmButtonColor: '#ef4444'
    });
  }
}
async function regenerateSchedule() {
  return regenerateAllSchedule();
}
  async function saveShift() {
  if (!_isMasterMode) {
    Swal.fire({ icon:"info", title:"Not available here", text:"This editor is only for Master Schedule." });
    return;
  }

  const person = document.getElementById("modalEmployee").value;
  const day = document.getElementById("modalDay").value;
  const newStart = document.getElementById("modalStart").value;
  const newEnd = document.getElementById("modalEnd").value;
  const newTeam = getSelectedChannel(); // Use the helper function for custom channels
  const newRole = document.getElementById("modalRole")?.value || "";
  const origStart = document.getElementById("modalOrigStart").value;
  const origEnd = document.getElementById("modalOrigEnd").value;
  const origTeam = document.getElementById("modalOrigTeam")?.value || "";
  const origRole = document.getElementById("modalOrigRole")?.value || "";
  const isAdding = origStart === "NEW";

  if (!newStart || !newEnd) {
    Swal.fire({ icon:'warning', title:'Missing Times', text:'Please enter both start and end times.', confirmButtonColor:'#b37e78' });
    return;
  }
  
  if (!newTeam) {
    Swal.fire({ icon:'warning', title:'Missing Channel', text:'Please select or enter a channel.', confirmButtonColor:'#b37e78' });
    return;
  }

  if (!_masterEditEnabled) {
    toast("Click Edit to make draft changes first.", "info");
    return;
  }

  const dayData = _masterRawData[day] || [];
  if (isAdding) {
    const newShift = { person, start: newStart, end: newEnd, team: newTeam };
    if (newRole) newShift.role = newRole;
    dayData.push(newShift);
    _masterRawData[day] = dayData;
  } else {
    const sameValue = (a, b) => (a || "") === (b || "");
    let shiftToUpdate = dayData.find(s =>
      s.person === person &&
      s.start === origStart &&
      s.end === origEnd &&
      sameValue(s.team, origTeam) &&
      sameValue(s.role, origRole)
    );
    if (!shiftToUpdate) {
      shiftToUpdate = dayData.find(s =>
        s.person === person &&
        s.start === origStart &&
        s.end === origEnd
      );
    }
    if (!shiftToUpdate) {
      toast("Shift not found. Try re-opening the shift.", "error");
      return;
    }
    shiftToUpdate.start = newStart;
    shiftToUpdate.end = newEnd;
    shiftToUpdate.team = newTeam;
    if (newRole) {
      shiftToUpdate.role = newRole;
    } else {
      delete shiftToUpdate.role;
    }
  }

  renderMasterView(_masterRawData);
  closeModal();
  toast("Draft updated. Click Preview to apply.", "success");
}

// 1. Open the Queue (uses SweetAlert for simplicity)
async function openTimeOffQueue() {

  Swal.fire({ title: 'Loading...', didOpen: () => Swal.showLoading() });
  try {
    const res = await fetch('./?action=timeoff/list');
    const data = await res.json();
    
    if (!data.ok) throw new Error(data.error);
    if (!data.requests || data.requests.length === 0) {
      Swal.fire("All caught up!", "No pending time off requests.", "success");
      return;
    }
    let html = `<div style="text-align:left; max-height:400px; overflow-y:auto;">`;
    
    // Helper to calculate hours for UI (handles AM/PM)
    const calcHours = (s, e) => {
        if(!s || !e) return 4;
        const parse = (t) => {
           const match = t.match(/(\d+):(\d+)\s?(AM|PM)?/i);
           if(!match) return 0;
           let h = parseInt(match[1]);
           let ampm = match[3] ? match[3].toUpperCase() : null;
           if (ampm === "PM" && h < 12) h += 12;
           if (ampm === "AM" && h === 12) h = 0;
           return h + (parseInt(match[2])/60);
        };
        let diff = parse(e) - parse(s);
        if(diff < 0) diff += 24;
        return Math.round(diff * 100) / 100;
    };
    data.requests.forEach(req => {
      // 1. Date & Team Label
      let dateDisplay = req.date || "Date Pending";
      let teamLabel = req.team ? `<span style="font-size:10px; background:#e0e7ff; color:#4338ca; padding:2px 5px; border-radius:4px; margin-left:6px; font-weight:700;">${req.team}</span>` : "";
      const reqType = (req.type || "PTO").toString();
      const isMakeUp = reqType.toLowerCase().includes("make");
      const typePill = isMakeUp
        ? `<span style="font-size:10px; background:#dbeafe; color:#b37e78; padding:2px 6px; border-radius:999px; margin-left:8px; font-weight:800;">MAKE UP</span>`
        : `<span style="font-size:10px; background:#f0e6e4; color:#166534; padding:2px 6px; border-radius:999px; margin-left:8px; font-weight:800;">PTO</span>`;
      const makeUpLine = isMakeUp
        ? (req.makeUpDate
            ? `<div style="margin-top:6px; font-size:12px; color:#475569;"><strong>Make Up Date:</strong> ${req.makeUpDate}</div>`
            : `<div style="margin-top:6px; font-size:12px; color:#ef4444;"><strong>Make Up Date:</strong> Not provided</div>`)
        : "";
      // 2. Calculate Deduction Logic
      let deductAmount = 0;
      let timeDisplay = "";
      
      if (req.duration === 'full_day') {
          deductAmount = 8;
      } else if (req.shiftStart && req.shiftEnd) {
          deductAmount = calcHours(req.shiftStart, req.shiftEnd);
          // Only use fallback if math returns 0
          if (deductAmount === 0) deductAmount = 4; 
          timeDisplay = `<div style="font-size:11px; color:#64748b; margin-top:2px;">${req.shiftStart} - ${req.shiftEnd} (${deductAmount} hrs)</div>`;
      } else {
          deductAmount = 4; 
      }
      const bal = req.currentBalance !== undefined ? req.currentBalance : 0;
      const typeBadge = req.duration === 'full_day' 
          ? `<span style="background:#dbeafe; color:#8f5f5a; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:700; margin-right:6px;">FULL DAY</span>`
          : `<span style="background:#f3f4f6; color:#374151; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:700; margin-right:6px;">SHIFT</span>`;
      const actionButtons = isMakeUp
        ? `<button onclick="resolveTimeOff('${req.id}', 'approved', { deduct: false })" 
                  style="padding:8px 16px; background:#b37e78; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;">Approve (No Deduct)</button>`
        : `<button onclick="animateDeduction('bal-${req.id}', ${bal}, ${deductAmount}); resolveTimeOff('${req.id}', 'approved', { deduct: true, amount: ${deductAmount} })" 
                  style="padding:8px 16px; background:#1e293b; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;">Approve & Deduct</button>`;
      html += `
        <div id="req-${req.id}" style="border:1px solid #e2e8f0; padding:16px; margin-bottom:12px; border-radius:12px; background:#fff;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:800; color:#0f172a; font-size:15px;">
                ${req.person} ${teamLabel} ${typePill}
            </div>
            <div style="font-size:11px; background:#f0fdf4; color:#166534; padding:4px 10px; border-radius:20px; border:1px solid #bbf7d0; font-weight:700;">
               Balance: <span id="bal-${req.id}">${bal}</span> hrs
            </div>
          </div>
          <div style="font-size:13px; color:#334155; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #f1f5f9;">
             <div style="margin-bottom:4px;">${typeBadge} <strong>${dateDisplay}</strong> ${timeDisplay}</div>
             <div style="color:#64748b; font-style:italic;">"${req.reason || 'No reason provided'}"</div>
             ${makeUpLine}
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button onclick="resolveTimeOff('${req.id}', 'rejected')" style="padding:8px 16px; background:#fff; color:#ef4444; border:1px solid #fee2e2; border-radius:8px; cursor:pointer; font-weight:600;">Deny</button>
            ${actionButtons}
          </div>
        </div>
      `;
    });
    html += `</div>`;
    Swal.fire({ title: 'Time Off Requests', html: html, width: 600, showConfirmButton: false, showCloseButton: true });
  } catch (err) {
    Swal.fire("Error", err.message, "error");
  }
}
// 2. Handle Decision
async function resolveTimeOff(id, decision, opts = {}) {
  // Optimistic UI: Remove the card immediately to feel "snappy"
  const card = document.getElementById(`req-${id}`);
  if(card) card.style.opacity = "0.5";
  
  toast(decision === 'approved' ? "Approving..." : "Denying...");
  try {
    // CLOUD RUN FETCH CALL
    const res = await fetch('./?action=timeoff/resolve', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        id: id,
        decision: decision,
        manager: window._myName, // Send who made the decision
        // If caller passes deduct, use it. Otherwise:
// - deny => never deduct
// - approve => leave undefined so backend can decide (or your caller can decide)
deduct: (opts && typeof opts.deduct === "boolean")
  ? opts.deduct
  : (decision === "approved" ? undefined : false),
// allow 0 as a valid amount (your old check would drop it)
amount: (opts && opts.amount != null) ? opts.amount : null,
      })
    });
    const text = await res.text(); 
    let data;
    try {
        data = JSON.parse(text);
    } catch (e) {
        console.error("CRITICAL SERVER ERROR:", text);
        throw new Error("Server returned HTML. Check Console (F12) for the real error.");
    }
    
    if (data.ok) {
      toast(`Request ${decision}!`, "success");
      if(card) card.remove(); // Remove from UI
      // 1. Reload balances so Admin Tools shows the new numbers
      loadBalances();
      // 2. Refresh the "Review Queue" Badge Count (THIS WAS MISSING)
      fetch('./?action=timeoff/count')
        .then(r => r.json())
        .then(d => {
           const btnQueue = document.getElementById("btnReviewQueue");
           const notifCountEl = document.getElementById("notifCount");

           
           // Update the "Review Queue" button text
           if (btnQueue) {
    if (d.count > 0) {
      btnQueue.innerHTML = `
        Review Queue
        <span style="
          background:white;
          color:#c2410c;
          padding:2px 6px;
          border-radius:10px;
          font-size:11px;
          font-weight:800;
          margin-left:6px;
        ">
          ${d.count}
        </span>
      `;
    } else {
      btnQueue.innerHTML = "Review Queue";
    }
  }

  // --- Notification dot / badge ---
  if (notifCountEl) {
    if (d.count > 0) {
      notifCountEl.textContent = d.count;
      notifCountEl.classList.remove("hidden");
    } else {
      notifCountEl.textContent = "0";
      notifCountEl.classList.add("hidden");
    }
  }
});
      
      // If there are no more requests, refresh the list to show "All caught up"
      const remaining = document.querySelectorAll('[id^="req-"]').length;
      if(remaining === 0) setTimeout(openTimeOffQueue, 500);
      
    } else {
      if(card) card.style.opacity = "1"; // Revert UI on failure
      toast(data.error || "Error saving decision", "error");
    }
  } catch (err) {
    if(card) card.style.opacity = "1";
    console.error(err);
    toast(err.message, "error");
  }
}
function animateDeduction(elementId, startVal, amountToDeduct) {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    let start = parseFloat(startVal) || 0;
    let end = start - amountToDeduct;
    let duration = 800; // Animation speed in ms
    let startTime = null;
    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        let progress = Math.min((timestamp - startTime) / duration, 1);
        
        // Easing function for smooth look
        let current = start - (amountToDeduct * progress);
        
        el.innerHTML = current.toFixed(1);
        el.style.color = "#ef4444"; // Flash red
        
        if (progress < 1) {
            window.requestAnimationFrame(step);
        } else {
            el.innerHTML = end.toFixed(1); // Ensure exact end value
            el.style.color = "#166534"; // Return to green
        }
    }
    window.requestAnimationFrame(step);
}
// ============================================
// [SECTION 10] SHIFT MANAGEMENT
// ============================================
function deleteShift() {
  // These MUST be defined before branching, otherwise SweetAlert string interpolation breaks
  const person = document.getElementById("modalEmployee").value;
  const day = document.getElementById("modalDay").value;
  const origStart = document.getElementById("modalOrigStart").value;
  const origEnd = document.getElementById("modalOrigEnd").value;
  const origTeam = document.getElementById("modalOrigTeam")?.value || "";
  const origRole = document.getElementById("modalOrigRole")?.value || "";

  // âœ… MASTER MODE = draft-only delete (no backend)
  if (_isMasterMode) {
    if (!_masterEditEnabled) {
      toast("Click Edit to make draft changes first.", "info");
      return;
    }

    const dayData = _masterRawData[day] || [];
    const sameValue = (a, b) => (a || "") === (b || "");
    let removed = false;
    _masterRawData[day] = dayData.filter(s => {
      if (removed) return true;
      const matches = s.person === person &&
        s.start === origStart &&
        s.end === origEnd &&
        sameValue(s.team, origTeam) &&
        sameValue(s.role, origRole);
      if (matches) {
        removed = true;
        return false;
      }
      return true;
    });
    if (!removed) {
      toast("Shift not found. Try re-opening the shift.", "error");
      return;
    }

    renderMasterView(_masterRawData);
    closeModal();
    toast("Draft updated. Click Preview to apply.", "success");
    return;
  }

  // âœ… NON-MASTER MODE = delete LIVE assignment (Firestore scheduleDays)
  // Requires modal to hold docId + assignmentId (see section 3)
  const docId = document.getElementById("modalDocId")?.value || "";
  const assignmentId = document.getElementById("modalAssignmentId")?.value || "";

  if (!docId || !assignmentId) {
    Swal.fire({
      icon: "error",
      title: "Missing delete info",
      text: "Could not find docId/assignmentId for this shift. Re-open the shift and try again.",
      confirmButtonColor: "#ef4444"
    });
    return;
  }

  Swal.fire({
    title: "Delete This Shift?",
    html: `
      <div style="text-align:left; padding:12px; background:#fef2f2; border-radius:8px; border:1px solid #fecaca;">
        <div style="margin-bottom:8px;"><strong>ðŸ‘¤ Employee:</strong> ${person}</div>
        <div style="margin-bottom:8px;"><strong>ðŸ“… Day:</strong> ${day}</div>
        <div><strong>ðŸ• Time:</strong> ${toAmPm(origStart)} - ${toAmPm(origEnd)}</div>
      </div>
      <div style="margin-top:12px; font-size:13px; color:#64748b;">
        This will permanently remove the shift from the live schedule.
      </div>
    `,
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#ef4444",
    cancelButtonColor: "#64748b",
    confirmButtonText: "ðŸ—‘ï¸ Yes, Delete It",
    cancelButtonText: "Cancel"
  }).then((result) => {
    if (result.isConfirmed) {
      executeDeleteAssignmentShift(docId, assignmentId);
    }
  });
}
async function executeDeleteAssignmentShift(docId, assignmentId) {
  Swal.fire({
    title: "Deleting Shift...",
    allowOutsideClick: false,
    allowEscapeKey: false,
    showConfirmButton: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch("./?action=assignment/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ docId, assignmentId })
    });

    const data = await res.json();
    if (!res.ok || !data.ok) {
      throw new Error(data.error || "Delete failed");
    }

    // âœ… Refresh UI (pick the one you already use after changes)
    // Option 1: full reload (simple + reliable)
    closeModal();
await load(true);;

    Swal.fire({
      icon: "success",
      title: "Shift Deleted!",
      text: "Removed from the live schedule.",
      confirmButtonColor: "#16a34a",
      timer: 2200,
      timerProgressBar: true
    });
  } catch (e) {
    console.error("Live delete failed:", e);
    Swal.fire({
      icon: "error",
      title: "Delete Failed",
      text: e.message || "Could not delete",
      confirmButtonColor: "#ef4444"
    });
  }
}

function checkTimeMatch(targetTime, compareTime) {
  const normalize = (t) => {
    if (!t) return "";
    // Standard JS way to handle Date objects instead of Apps Script
    if (t instanceof Date) {
      return t.getHours().toString().padStart(2, '0') + ":" + 
             t.getMinutes().toString().padStart(2, '0');
    }
    return String(t).trim().substring(0, 5);
  };
  return normalize(targetTime) === normalize(compareTime);
}
  // Timezone-aware time formatting
  function toAmPm(timeString) {
    if (!timeString) return "";
    
    // Parse time
    const parts = String(timeString).split(":");
    let hours = parseInt(parts[0], 10);
    const minutes = parts[1] || "00";
    
    if (isNaN(hours)) return "";
    
    // Get user timezone and apply offset
    const tzOffsets = { 'PST': 0, 'MST': 1, 'CST': 2, 'EST': 3 };
    let userTz = 'PST';
    try {
      const prefs = getUserPrefs();
      userTz = prefs.timezone || 'PST';
    } catch(e) {}
    
    const offset = tzOffsets[userTz] || 0;
    const adjustedHours = hours + offset;
    
    // Format with overflow handling (e.g., 25 -> 1 AM)
    const hr = ((adjustedHours % 24) + 24) % 24;
    const suffix = hr >= 12 ? 'PM' : 'AM';
    const displayHr = hr % 12 || 12;
    
    return `${displayHr}:${minutes} ${suffix}`;
  }
// ============================================
// [SECTION 14] METRICS & REPORTING
// ============================================
function renderMetricsView() {
    $("listView").style.display = "none"; $("calViewWrapper").style.display = "none"; $("metricsView").style.display = "block";
    renderMetricsList();
  }
  // ============================================
// AUDIT LOGGING
// ============================================
async function logAuditEntry(entry) {
  try {
    await fetch('/?action=audit/log', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        ...entry,
        timestamp: new Date().toISOString()
      })
    });
  } catch (err) {
    console.error("Audit log failed:", err);
  }
}
  function renderShiftCard(it, mode) {
  const card = mkDiv(`shift ${getTeamClass(it.team)}`);
  
  // Check selection
  if (_teamSelected.has(String(it.assignmentId))) card.classList.add("selected");
  
  // ============================================
  // SHIFT STATUS DETECTION
  // ============================================
  const notes = String(it.notes || "").toLowerCase();
  const personLower = String(it.person || "").toLowerCase().trim();
  const isOff = _timeOff.has(`${it.person}|${it.dateISO}`) || notes.includes("[off]");
  const isOpen = personLower === "open" || it.isOpenShift === true;
  const isBackup = notes.includes("back up") || 
                   notes.includes("backup") || 
                   notes.includes("coverage") ||
                   notes.includes("temp") ||
                   notes.includes("replacing") ||
                   notes.includes("replaced");
  const isCaptain = notes.includes("captain");
  
  // ============================================
  // GET CHANNEL CONFIG FOR COLORS - WITH FALLBACK
  // ============================================
  const config = getChannelConfig(it.team) || {
    abbrev: "â€”",
    color: "#f8fafc",
    border: "#e2e8f0",
    text: "#475569"
  };
  
  // Ensure all properties exist with fallbacks
  const channelAbbrev = config.abbrev || "â€”";
  const channelColor = config.color || "#f8fafc";
  const channelBorder = config.border || "#e2e8f0";
  const channelText = config.text || "#475569";
  const channelDisplay = getChannelDisplayName ?  getChannelDisplayName(it.team) : (it.team || "Unknown");
  
  // ============================================
  // APPLY VISUAL STYLES BASED ON STATUS
  // ============================================
  
  // Priority 0: OPEN shift (needs coverage)
  if (isOpen) {
    card.style.border = "3px dashed #dc2626";
    card.style.background = "repeating-linear-gradient(45deg, #fef2f2, #fef2f2 10px, #fee2e2 10px, #fee2e2 20px)";
    card.style.boxShadow = "0 2px 12px rgba(220, 38, 38, 0.3)";
    card.style.animation = "pulse-open 2s infinite";
    card.classList.add("open-shift");
  }
  // Priority 1: OFF status
  else if (isOff) { 
    card.style.border = "2px solid #f87171"; 
    card.style.background = "#fef2f2"; 
    card.style.opacity = "0.7";
  }
  // Priority 2: Backup/Coverage shift
  else if (isBackup) {
    card.style.border = "2px solid #ef4444";
    card.style.background = "linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)";
    card.style.boxShadow = "0 2px 8px rgba(239, 68, 68, 0.25)";
    card.classList.add("backup-shift");
  }
  // Priority 3: Captain
  else if (isCaptain) {
    card.style.border = "2px solid #f59e0b";
    card.style.background = "linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)";
    card.style.boxShadow = "0 2px 8px rgba(245, 158, 11, 0.25)";
  }
  
  // ============================================
  // BUILD CARD CONTENT
  // ============================================
  let metaIcon = "";
  if (window._isManager && it.notes && it.notes.length > 0) {
    metaIcon = `<span style="font-size: 10px; margin-left: 6px; cursor:help;" title="Notes: ${it.notes}">ðŸ“</span>`;
  }
  // Role badge
  const roleDisplay = it.role 
    ? `<span style="font-size:9px; background:#e0e7ff; color:#4c51bf; padding:2px 6px; border-radius:4px; font-weight:700; margin-left: 4px;">${it.role}</span>` 
    : "";
  
  // Status badge for backup shifts
  let statusBadge = "";
  if (isOpen) {
    statusBadge = `<span style="font-size:8px; background:#dc2626; color:#fff; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:4px; animation:blink 1s infinite;">âš ï¸ OPEN</span>`;
  } else if (isBackup && ! isOff) {
    statusBadge = `<span style="font-size:8px; background:#ef4444; color:#fff; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:4px;">COVERAGE</span>`;
  } else if (isCaptain) {
    statusBadge = `<span style="font-size: 8px; background:#f59e0b; color:#fff; padding:2px 6px; border-radius:4px; font-weight:700; margin-left: 4px;">CAPTAIN</span>`;
  }
  
  // ============================================
  // CHECK FOR REPLACEMENT INFO IN NOTES
  // ============================================
  let replacementDisplay = "";
  const notesStr = String(it.notes || "");
  const replacedMatch = notesStr.match(/(?:replaced|covering for|was)\s+([A-Za-z]+(?:\s+[A-Za-z]+)?)/i);
  if (replacedMatch && replacedMatch[1] && window._isManager && !isOpen) {
    const originalPerson = replacedMatch[1].trim();
    if (originalPerson.toLowerCase() !== (it.person || "").toLowerCase()) {
      replacementDisplay = `<span style="font-size:9px; color:#6b7280; text-decoration:line-through; margin-right:4px;">${escapeHtml(originalPerson)}</span>â†’ `;
      statusBadge = `<span style="font-size:8px; background:#8b5cf6; color:#fff; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:4px;">SWAP</span>`;
    }
  }
  
  // Show original person for open shifts
  let openOriginalDisplay = "";
  if (isOpen && it.originalPerson) {
    openOriginalDisplay = `<div style="font-size:9px; color:#dc2626; margin-top:4px; font-weight:600;">Was: ${escapeHtml(it.originalPerson)} ${it.openReason ? 'â€¢ ' + escapeHtml(it.openReason) : ''}</div>`;
  }
  
  // ============================================
  // SPECIAL STYLING FOR LUNCH/1:1 (Break types)
  // ============================================
  const isBreakType = config.isBreak === true;
  if (isBreakType && !isOff && !isOpen) {
    card.style.opacity = "0.85";
    card.style.background = channelColor;
    card.style.borderStyle = "dashed";
  }
  
  // Build the HTML with color-coded channel badge
  card.innerHTML = `
    <div class="sRow" style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 4px;">
      <span class="sTime" style="font-weight:800; font-size: 11px;">${it.startLabel || ''}-${it.endLabel || ''}</span>
      <span style="font-size:10px; background: ${channelColor}; color: ${channelText}; padding: 2px 6px; border-radius:4px; font-weight: 700; border:1px solid ${channelBorder};" title="${channelDisplay}">${channelAbbrev}</span>
      ${metaIcon}
    </div>
    <div class="sName" title="${it.person || ''}" style="font-weight: 600; ${isOpen ? 'color:#dc2626;' : ''}">
      ${replacementDisplay}${isOpen ? 'âš ï¸ NEEDS COVERAGE' : (it.person || 'Unassigned')}${roleDisplay}${statusBadge}
    </div>
    ${openOriginalDisplay}
    ${isBackup && it.notes && !isOpen ?  `<div style="font-size:9px; color:#dc2626; margin-top:4px; font-weight:600;">${escapeHtml(it.notes)}</div>` : ''}
  `;
  
  const sel = mkDiv("selBox"); 
  sel.textContent = "âœ“"; 
  card.appendChild(sel);
  
  if (mode === "list") card.style.width = "220px";
  
  // ============================================
  // CLICK HANDLING
  // ============================================
  const currentName = String(window._myName || "").trim().toLowerCase();
  const shiftPerson = String(it.person || "").trim().toLowerCase();
  const isMe = currentName && shiftPerson === currentName;
  const isManager = window._isManager === true;
  if (isManager || isMe) {
    card.style.cursor = "pointer";
    
    card.onclick = (e) => { 
      if (isManager) {
        if(_mode === "team" || _teamSelected.size > 0 || e.shiftKey) { 
          toggleTeamSelect(it, card); 
        } else { 
          openReplaceModal(it); 
        } 
      } 
      else if (isMe) {
        openAgentActionModal(it);
      }
    };
    if (isManager) {
      card.draggable = true;
      card.ondragstart = (e) => { e.preventDefault(); }; 
      card.ondragover = (e) => { if(_mode === "quick") { e.preventDefault(); card.classList.add("dropTarget"); } };
      card.ondragleave = () => card.classList.remove("dropTarget");
      card.ondrop = (e) => { 
        e.preventDefault(); 
        card.classList.remove("dropTarget"); 
        if(_dragPerson && _dragPerson !== it.person) { 
          _editing.docId = it.docId || "";
_editing.assignmentId = it.assignmentId || it.id || "";

// âœ… Show delete button for managers only
const delBtn = document.getElementById("btnDeleteShift");
if (delBtn) delBtn.style.display = window._isManager ? "inline-flex" : "none";
          openReplaceModal(it); 
          setTimeout(() => $("mNewPerson").value = _dragPerson, 50); 
        } 
      };
    }
  }
  
  return card;
}

function deleteLiveShiftFromReplace() {
  if (!_editing?.docId || !_editing?.assignmentId) {
    Swal.fire({
      icon: "error",
      title: "Missing delete info",
      text: "docId/assignmentId not found for this shift.",
      confirmButtonColor: "#ef4444"
    });
    return;
  }

  const person = _editing.person || "Unassigned";
  const day = _editing.dateLabel || "";
  const time = `${_editing.startLabel || _editing.start || ""} - ${_editing.endLabel || _editing.end || ""}`;

  Swal.fire({
    title: "Delete This Shift?",
    html: `
      <div style="text-align:left; padding:12px; background:#fef2f2; border-radius:8px; border:1px solid #fecaca;">
        <div style="margin-bottom:8px;"><strong>ðŸ‘¤ Employee:</strong> ${person}</div>
        <div style="margin-bottom:8px;"><strong>ðŸ“… Date:</strong> ${day}</div>
        <div><strong>ðŸ• Time:</strong> ${time}</div>
      </div>
      <div style="margin-top:12px; font-size:13px; color:#64748b;">
        This will permanently remove the shift from the live schedule.
      </div>
    `,
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#ef4444",
    cancelButtonColor: "#64748b",
    confirmButtonText: "ðŸ—‘ï¸ Yes, Delete It",
    cancelButtonText: "Cancel"
  }).then((r) => {
    if (r.isConfirmed) {
      // close the replace modal first for smoother UX
      const overlay = document.getElementById("modalOverlay");
      if (overlay) overlay.style.display = "none";
      executeDeleteAssignmentShift(_editing.docId, _editing.assignmentId);
    }
  });
}

  // --- 6. AGENT ACTIONS (MOVED TO GLOBAL SCOPE) ---
  // These functions are now accessible by the HTML buttons
 function openAgentActionModal(it) {
  console.log("Opening Agent Modal for:", it);
  _editing = it; 
  // Update shift time display
  if($("agShiftTimeDisplay")) {
    $("agShiftTimeDisplay").innerText = `${it.startLabel} - ${it.endLabel}`;
  }
  
  // Update new shift info card elements
  const dateEl = document.getElementById("agShiftDate");
  const timeEl = document.getElementById("agShiftTime");
  const teamEl = document.getElementById("agShiftTeam");
  
  if (dateEl) {
    const d = new Date(it.dateISO + "T12:00:00");
    dateEl.textContent = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  }
  if (timeEl) {
    timeEl.textContent = `${it.startLabel} - ${it.endLabel}`;
  }
  if (teamEl) {
    teamEl.textContent = it.team || "General";
  }
  
  // Legacy: Update title card (for backwards compat)
  const title = `${it.dateLabel} â€¢ ${it.startLabel} - ${it.endLabel}`;
  const titleEl = document.getElementById("agShiftDetails");
  if(titleEl) titleEl.innerText = title;
  
  // Reset modal view
  resetAgentModal();
  
  // Fill coworker dropdown
  try {
    const peopleList = Array.isArray(_people) ? _people : [];
    const currentName = window._myName || "";
    const coworkers = peopleList.filter(p => p !== currentName);
    if (typeof fillSelect === "function") {
      fillSelect("agSwapPerson", coworkers, false);
    }
  } catch (err) {
    console.error("Error filling swap list (non-fatal):", err);
  }
  
  // âœ… NEW: Load and display PTO balance
  loadAgentPtoDisplay();
  
  // Show overlay
  const overlay = document.getElementById("agentOverlay");
  if(overlay) {
    if (overlay.parentElement !== document.body) {
      document.body.appendChild(overlay);
    }
    overlay.style.display = "flex";
    overlay.style.visibility = "visible"; 
    overlay.style.opacity = "1";
    overlay.style.zIndex = "20000";
  } else {
    alert("Error: The 'agentOverlay' HTML is missing.");
  }
}
// âœ… Function to load and display agent's PTO in the modal
function loadAgentPtoDisplay() {
  const ptoEl = document.getElementById("agPtoHours");
  
  if (!ptoEl) return;
  
  // Get balance from cached data
  const balance = _balanceData.get(window._myName) || { pto: 0 };
  
  ptoEl.textContent = balance.pto || 0;
  
  // Color code based on balance
  if (balance.pto <= 0) {
    ptoEl.style.color = "#ef4444"; // Red if zero
  } else if (balance.pto < 8) {
    ptoEl.style.color = "#f59e0b"; // Orange if low
  } else {
    ptoEl.style.color = "#16a34a"; // Green if good
  }
}
// Helper to update visual selection on type radio buttons
function updateTypeSelection() {
  const radios = document.querySelectorAll('input[name="timeOffType"]');
  radios.forEach(radio => {
    const label = radio.closest('label');
    if (radio.checked) {
      if (radio.value === 'Make Up') {
        label.style.borderColor = '#b37e78';
        label.style.background = '#eff6ff';
      } else {
        label.style.borderColor = '#16a34a';
        label.style.background = '#f0fdf4';
      }
    } else {
      label.style.borderColor = '#e2e8f0';
      label.style.background = '#fff';
    }
  });
  // Toggle Make Up Date field
  const selected = document.querySelector('input[name="timeOffType"]:checked');
  const isMakeUp = selected && selected.value === "Make Up";
  const wrap = document.getElementById("agMakeUpWrap");
  const dateEl = document.getElementById("agMakeUpDate");
  if (wrap) wrap.style.display = isMakeUp ? "block" : "none";
  if (!isMakeUp && dateEl) dateEl.value = "";

  // âœ… Show PTO balance warnings based on selection
  if (!isMakeUp) {
    const balance = _balanceData.get(window._myName) || { pto: 0, sick: 0 };
    const currentPto = parseFloat(balance.pto) || 0;

    // Update PTO display with warning color
    const ptoEl = document.getElementById("agPtoHours");
    if (ptoEl) {
      if (currentPto <= 0) {
        ptoEl.style.color = "#ef4444"; // Red if zero
        ptoEl.parentElement.style.borderColor = "#fca5a5";
        ptoEl.parentElement.style.background = "#fee2e2";
      } else if (currentPto < 8) {
        ptoEl.style.color = "#f59e0b"; // Orange if low
        ptoEl.parentElement.style.borderColor = "#fbbf24";
        ptoEl.parentElement.style.background = "#fef3c7";
      }
    }
  }
}

// showToast - alias for main toast function
function showToast(message, type = 'info') {
    toast(message, type);
}
  function showAgentForm(type) {
    if($("agActionSelect")) $("agActionSelect").style.display = "none";
    if (type === 'timeoff') {
        if($("agFormTimeOff")) $("agFormTimeOff").style.display = "block";
        updateTypeSelection();
        if($("agToReason")) {
            $("agToReason").value = "";
            $("agToReason").focus();
        }
    } else {
        if($("agFormSwap")) $("agFormSwap").style.display = "block";
        if($("agSwapNote")) $("agSwapNote").value = "";
    }
  }
  function resetAgentModal() {
    if($("agActionSelect")) $("agActionSelect").style.display = "block";
    if($("agFormTimeOff")) $("agFormTimeOff").style.display = "none";
    if($("agFormSwap")) $("agFormSwap").style.display = "none";
  }
  function openStaffingModal() {
  
  const modal = $("staffingModal");
  if(!modal) return console.error("Staffing modal div not found!");
  // Ensure it sits on top of the Admin modal (z-index)
  modal.style.zIndex = "10010"; 
  modal.style.display = "flex";
  
  // Fill the dropdown immediately using cached data (prevents "loading" delay)
  const sel = $("ruleTeam");
  sel.innerHTML = '<option value="">Select Team...</option>';
  if (_teams && _teams.length > 0) {
    _teams.forEach(t => sel.appendChild(new Option(t, t)));
  }
  
  // Load the list
  loadRules();
}
function closeStaffingModal() {
  $("staffingModal").style.display = "none";
}

// ============================================
// CLEAR EVENTS MODAL FUNCTIONS
// ============================================
function openClearEventsModal() {
  $("clearEventsModal").style.display = "flex";
  
  // Reset form
  document.getElementById("clearEventsConfirm").checked = false;
  document.getElementById("clearEventsUseDateFilter").checked = false;
  document.getElementById("clearEventsBeforeDate").style.display = "none";
  document.getElementById("clearEventsBeforeDate").value = "";
  
  // Reset checkboxes to default (time_off_requests and swap_requests checked)
  document.querySelectorAll(".clearEventsCollection").forEach(cb => {
    cb.checked = (cb.value === "time_off_requests" || cb.value === "swap_requests");
  });
}

function closeClearEventsModal() {
  $("clearEventsModal").style.display = "none";
}

function toggleClearEventsDateFilter() {
  const checkbox = document.getElementById("clearEventsUseDateFilter");
  const dateInput = document.getElementById("clearEventsBeforeDate");
  
  if (checkbox.checked) {
    dateInput.style.display = "block";
    // Set default to 30 days ago
    const date = new Date();
    date.setDate(date.getDate() - 30);
    dateInput.value = date.toISOString().split('T')[0];
  } else {
    dateInput.style.display = "none";
    dateInput.value = "";
  }
}

async function executeClearEvents() {
  // Validate confirmation
  const confirmCheckbox = document.getElementById("clearEventsConfirm");
  if (!confirmCheckbox.checked) {
    toast("Please confirm you understand this action is permanent", "error");
    return;
  }
  
  // Get selected collections
  const selectedCollections = Array.from(document.querySelectorAll(".clearEventsCollection:checked"))
    .map(cb => cb.value);
  
  if (selectedCollections.length === 0) {
    toast("Please select at least one data type to clear", "error");
    return;
  }
  
  // Get date filter if enabled
  let beforeDate = null;
  const useDateFilter = document.getElementById("clearEventsUseDateFilter").checked;
  if (useDateFilter) {
    beforeDate = document.getElementById("clearEventsBeforeDate").value;
    if (!beforeDate) {
      toast("Please select a date or disable the date filter", "error");
      return;
    }
  }
  
  // Final confirmation with SweetAlert
  const dateText = beforeDate ? ` created before ${beforeDate}` : '';
  const result = await Swal.fire({
    title: 'Confirm Deletion',
    html: `
      <div style="text-align:left; padding:0 20px;">
        <p style="margin-bottom:12px;">You are about to permanently delete:</p>
        <ul style="margin:12px 0; padding-left:20px;">
          ${selectedCollections.map(c => `<li style="margin:6px 0;">${c.replace(/_/g, ' ')}</li>`).join('')}
        </ul>
        ${dateText ? `<p style="margin-top:12px; font-weight:600;">Only events${dateText}</p>` : '<p style="margin-top:12px; font-weight:600; color:#dc2626;">All events in these collections</p>'}
        <p style="margin-top:12px; color:#dc2626; font-weight:700;">This action cannot be undone!</p>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc2626',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Yes, Delete',
    cancelButtonText: 'Cancel'
  });
  
  if (!result.isConfirmed) return;
  
  // Show loading
  Swal.fire({
    title: 'Clearing Events...',
    html: 'Please wait while we delete the selected data.',
    allowOutsideClick: false,
    allowEscapeKey: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });
  
  try {
    // Call the API
    const response = await fetch('/admin/clear-events', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        confirm: true,
        beforeDate: beforeDate || undefined,
        collections: selectedCollections
      })
    });
    
    const data = await response.json();
    
    if (response.ok && data.ok) {
      // Success - show results
      const deletedByCollection = data.deletedByCollection || {};
      const totalDeleted = data.totalDeleted || 0;
      
      const resultsHtml = Object.entries(deletedByCollection)
        .map(([collection, count]) => `<li style="margin:6px 0;">${collection.replace(/_/g, ' ')}: <strong>${count}</strong> deleted</li>`)
        .join('');
      
      await Swal.fire({
        icon: 'success',
        title: 'Event History Cleared',
        html: `
          <div style="text-align:left; padding:0 20px;">
            <p style="margin-bottom:12px;">Successfully deleted <strong>${totalDeleted}</strong> total entries:</p>
            <ul style="margin:12px 0; padding-left:20px;">
              ${resultsHtml}
            </ul>
            <p style="margin-top:12px; color:#64748b; font-size:14px;">
              Attendance scores will update automatically on next refresh.
            </p>
          </div>
        `,
        confirmButtonColor: '#16a34a'
      });
      
      closeClearEventsModal();
      
      // If on goals page, reload attendance data
      if (typeof loadAgentAttendance === 'function' && window._currentGoalsAgent) {
        loadAgentAttendance();
      }
    } else {
      throw new Error(data.error || 'Failed to clear events');
    }
  } catch (err) {
    console.error('Clear events error:', err);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: err.message || 'Failed to clear event history. Please try again.',
      confirmButtonColor: '#dc2626'
    });
  }
}

// ============================================
// MEETING ROTATION MODAL FUNCTIONS (Enhanced)
// ============================================
let _currentLcAgents = [];
let _currentPtoAgents = [];
let _lcEligibleAgents = []; // Agents with LC experience

async function openMeetingRotationModal() {
  const modal = $("meetingRotationModal");
  modal.style.display = "flex";
  
  // Reset state
  _currentLcAgents = [];
  _currentPtoAgents = [];
  _lcEligibleAgents = [];
  
  // Set default to next Thursday first (needed for eligible endpoint)
  const today = new Date();
  const daysUntilThursday = (4 - today.getDay() + 7) % 7;
  const nextThursday = new Date(today);
  nextThursday.setDate(today.getDate() + (daysUntilThursday === 0 ? 7 : daysUntilThursday));
  const defaultDate = nextThursday.toISOString().split('T')[0];
  $("rotationDate").value = defaultDate;
  
  // Populate agent dropdowns - use _peopleMeta or fetch from API
  let people = [];
  if (typeof _peopleMeta !== 'undefined' && Array.isArray(_peopleMeta) && _peopleMeta.length > 0) {
    people = _peopleMeta;
  } else if (window.__peopleCache && Array.isArray(window.__peopleCache) && window.__peopleCache.length > 0) {
    people = window.__peopleCache;
  } else {
    // Fetch from API as fallback
    try {
      const res = await fetch("/people");
      if (res.ok) {
        const data = await res.json();
        people = data.people || [];
        window.__peopleCache = people;
      }
    } catch (e) {
      console.error("Failed to fetch people for rotation modal:", e);
    }
  }
  
  // Fetch LC eligible agents (historical LC workers)
  try {
    const eligibleRes = await fetch(`/meeting-rotation/eligible?date=${defaultDate}&type=thursday`);
    const eligibleData = await eligibleRes.json();
    if (eligibleData.ok) {
      _lcEligibleAgents = eligibleData.historicalLcAgents || [];
    }
  } catch (e) {
    console.error("Failed to fetch LC eligible agents:", e);
  }
  
  // Build dropdown options - prioritize LC agents
  populateRotationDropdowns(people);
  
  // Set defaults
  $("rotationMeetingType").value = "thursday";
  $("rotationTimeEST").value = "3:00 PM - 4:15 PM";
  convertMeetingTime();
  onMeetingTypeChange();
  
  loadRotationForDate();
  loadRotationHistory();
  loadFairnessStats(); // Load fairness stats when modal opens
  renderLcAgentsChips();
  renderPtoAgentsChips();
}

// Populate rotation dropdowns with LC agents prioritized
function populateRotationDropdowns(people) {
  const activeAgents = people.filter(p => p.active !== false);
  
  // Separate LC agents and others
  const lcAgents = activeAgents.filter(p => _lcEligibleAgents.includes(p.name));
  const otherAgents = activeAgents.filter(p => !_lcEligibleAgents.includes(p.name));
  
  // Build options with LC agents first, then a separator, then others
  let rotationOptions = '<option value="">-- Select --</option>';
  
  if (lcAgents.length > 0) {
    rotationOptions += '<optgroup label="â˜… Live Chat Agents">';
    rotationOptions += lcAgents.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
    rotationOptions += '</optgroup>';
  }
  
  if (otherAgents.length > 0) {
    rotationOptions += '<optgroup label="Other Agents">';
    rotationOptions += otherAgents.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
    rotationOptions += '</optgroup>';
  }
  
  // LC-specific dropdowns (Captain, Backup, LC Agents)
  $("rotationCaptain").innerHTML = rotationOptions;
  $("rotationBackup1").innerHTML = rotationOptions;
  $("rotationBackup2").innerHTML = rotationOptions;
  $("addLcAgentSelect").innerHTML = rotationOptions;
  
  // All agents for PTO (All Hands)
  const allAgentOptions = '<option value="">-- Select --</option>' + 
    activeAgents.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
  $("addPtoAgentSelect").innerHTML = allAgentOptions;
}

function closeMeetingRotationModal() {
  $("meetingRotationModal").style.display = "none";
}

function onMeetingTypeChange() {
  const meetingType = $("rotationMeetingType").value;
  const allHandsSection = $("allHandsPtoSection");
  const timeSelect = $("rotationTimeEST");
  
  if (meetingType === "allhands") {
    allHandsSection.style.display = "block";
    timeSelect.value = "7:00 PM - 8:00 PM";
  } else {
    allHandsSection.style.display = "none";
    timeSelect.value = "3:00 PM - 4:15 PM";
  }
  convertMeetingTime();
}

function convertMeetingTime() {
  const estTime = $("rotationTimeEST").value;
  const pstInput = $("rotationTimePST");
  
  // EST to PST (EST is 3 hours ahead)
  const timeMap = {
    "3:00 PM - 4:15 PM": "12:00 PM - 1:15 PM",
    "3:45 PM - 5:00 PM": "12:45 PM - 2:00 PM",
    "7:00 PM - 8:00 PM": "4:00 PM - 5:00 PM"
  };
  
  pstInput.value = timeMap[estTime] || estTime;
}

function addLcAgent() {
  const select = $("addLcAgentSelect");
  const agent = select.value;
  if (!agent) return;
  if (_currentLcAgents.includes(agent)) {
    toast("Agent already added", "error");
    return;
  }
  _currentLcAgents.push(agent);
  select.value = "";
  renderLcAgentsChips();
}

function removeLcAgent(agent) {
  _currentLcAgents = _currentLcAgents.filter(a => a !== agent);
  renderLcAgentsChips();
}

function renderLcAgentsChips() {
  const container = $("lcAgentsContainer");
  if (_currentLcAgents.length === 0) {
    container.innerHTML = '<span style="color: #64748b; font-size: 10px; font-style: italic;">None assigned</span>';
    return;
  }
  container.innerHTML = _currentLcAgents.map(agent => `
    <span style="display: inline-flex; align-items: center; gap: 3px; padding: 3px 8px; background: #1e40af; color: white; border-radius: 10px; font-size: 10px;">
      ${agent}
      <button type="button" onclick="removeLcAgent('${agent}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 12px; padding: 0 2px; line-height: 1;">Ã—</button>
    </span>
  `).join('');
}

function addPtoAgent() {
  const select = $("addPtoAgentSelect");
  const agent = select.value;
  if (!agent) return;
  if (_currentPtoAgents.includes(agent)) {
    toast("Agent already added", "error");
    return;
  }
  _currentPtoAgents.push(agent);
  select.value = "";
  renderPtoAgentsChips();
}

function removePtoAgent(agent) {
  _currentPtoAgents = _currentPtoAgents.filter(a => a !== agent);
  renderPtoAgentsChips();
}

function renderPtoAgentsChips() {
  const container = $("allHandsPtoAgents");
  if (_currentPtoAgents.length === 0) {
    container.innerHTML = '<span style="color: #64748b; font-size: 10px; font-style: italic;">None</span>';
    return;
  }
  container.innerHTML = _currentPtoAgents.map(agent => `
    <span style="display: inline-flex; align-items: center; gap: 3px; padding: 3px 8px; background: #9d174d; color: white; border-radius: 10px; font-size: 10px;">
      ${agent}
      <button type="button" onclick="removePtoAgent('${agent}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 12px; padding: 0 2px; line-height: 1;">Ã—</button>
    </span>
  `).join('');
}

async function loadRotationForDate() {
  const date = $("rotationDate").value;
  if (!date) return;
  
  const meetingType = $("rotationMeetingType").value;
  
  // Refresh eligible agents for this date
  try {
    const eligibleRes = await fetch(`/meeting-rotation/eligible?date=${date}&type=${meetingType}`);
    const eligibleData = await eligibleRes.json();
    if (eligibleData.ok) {
      _lcEligibleAgents = eligibleData.historicalLcAgents || [];
      // Re-populate dropdowns with updated eligible agents
      const people = window.__peopleCache || [];
      if (people.length > 0) {
        populateRotationDropdowns(people);
      }
    }
  } catch (e) {
    console.error("Failed to refresh LC eligible agents:", e);
  }
  
  try {
    const res = await fetch(`/meeting-rotation/list?start=${date}&end=${date}`);
    const data = await res.json();
    
    if (data.rotations && data.rotations.length > 0) {
      const r = data.rotations[0];
      $("rotationMeetingType").value = r.meetingType || "thursday";
      $("rotationTimeEST").value = r.meetingTimeEST || "3:00 PM - 4:15 PM";
      $("rotationTimePST").value = r.meetingTimePST || "";
      $("rotationCaptain").value = r.captain || "";
      $("rotationBackup1").value = r.backup1 || "";
      $("rotationBackup2").value = r.backup2 || "";
      $("rotationNotes").value = r.notes || "";
      _currentLcAgents = r.lcAgents || [];
      _currentPtoAgents = r.allHandsPtoAgents || [];
      onMeetingTypeChange();
      convertMeetingTime();
    } else {
      // Clear for new date
      $("rotationCaptain").value = "";
      $("rotationBackup1").value = "";
      $("rotationBackup2").value = "";
      $("rotationNotes").value = "";
      _currentLcAgents = [];
      _currentPtoAgents = [];
    }
    renderLcAgentsChips();
    renderPtoAgentsChips();
  } catch (err) {
    console.error("Error loading rotation:", err);
  }
}

async function loadRotationHistory() {
  try {
    const res = await fetch('/meeting-rotation/list');
    const data = await res.json();
    
    const historyEl = $("rotationHistory");
    if (!data.rotations || data.rotations.length === 0) {
      historyEl.innerHTML = '<div style="color: var(--text-secondary);">No rotations saved yet.</div>';
      return;
    }
    
    historyEl.innerHTML = data.rotations.slice(0, 12).map(r => {
      const typeEmoji = r.meetingType === "allhands" ? "ðŸŽ‰" : r.meetingType === "wednesday" ? "ðŸ“†" : "ðŸ“…";
      const lcCount = (r.lcAgents || []).length;
      return `
        <div style="padding: 6px 8px; border-bottom: 1px solid var(--border-color); background: var(--bg-tertiary); margin-bottom: 4px; border-radius: 4px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 600; cursor: pointer;" onclick="loadRotationByDate('${r.date}')" title="Click to edit">${typeEmoji} ${r.date}</span>
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="font-size: 10px; color: var(--text-secondary);">${r.meetingTimePST || ''}</span>
              <button type="button" onclick="deleteRotation('${r.date}')" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 12px; padding: 2px;" title="Delete">ðŸ—‘ï¸</button>
            </div>
          </div>
          <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
            Capt: <strong>${r.captain || '-'}</strong> | 
            Backups: ${r.backup1 || '-'}, ${r.backup2 || '-'} | 
            LC: ${lcCount}
          </div>
        </div>
      `;
    }).join('');
  } catch (err) {
    console.error("Error loading rotation history:", err);
  }
}

// Load a specific rotation by date
function loadRotationByDate(date) {
  $("rotationDate").value = date;
  loadRotationForDate();
}

// Delete a rotation
async function deleteRotation(date) {
  const result = await Swal.fire({
    title: 'Delete Rotation?',
    text: `Remove meeting rotation for ${date}? This will also remove it from agent schedules.`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, Delete',
    confirmButtonColor: '#dc2626'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const res = await fetch('/meeting-rotation/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ date })
    });
    const data = await res.json();
    
    if (data.ok) {
      toast("âœ… Rotation deleted", "success");
      loadRotationHistory();
      loadFairnessStats();
      // Clear form if viewing this date
      if ($("rotationDate").value === date) {
        $("rotationCaptain").value = "";
        $("rotationBackup1").value = "";
        $("rotationBackup2").value = "";
        $("rotationNotes").value = "";
        _currentLcAgents = [];
        _currentPtoAgents = [];
        renderLcAgentsChips();
        renderPtoAgentsChips();
      }
    } else {
      toast(data.error || "Failed to delete", "error");
    }
  } catch (err) {
    toast("Error deleting rotation", "error");
    console.error(err);
  }
}

async function loadFairnessStats() {
  const statsEl = $("fairnessStats");
  statsEl.innerHTML = '<div style="color: var(--text-secondary);">Loading fairness data...</div>';
  
  try {
    const res = await fetch('/meeting-rotation/fairness?weeks=12');
    const data = await res.json();
    
    if (!data.ok || !data.fairnessReport) {
      statsEl.innerHTML = '<div style="color: var(--text-secondary);">Could not load fairness data.</div>';
      return;
    }
    
    // Filter to people with assignments
    const report = data.fairnessReport.filter(p => p.meetingsMissed > 0 || p.asBackup > 0);
    
    if (report.length === 0) {
      statsEl.innerHTML = '<div style="color: var(--text-secondary);">No rotation history yet. Save some rotations first!</div>';
      return;
    }
    
    statsEl.innerHTML = `
      <div style="margin-bottom: 8px; font-size: 10px; color: var(--text-secondary);">
        ðŸ“Š Last ${data.lookbackWeeks} weeks (${data.totalMeetings} meetings tracked)
      </div>
      <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
        <tr style="background: var(--card-bg);">
          <th style="padding: 6px; text-align: left; border-bottom: 2px solid var(--border-color);">Agent</th>
          <th style="padding: 6px; text-align: center; border-bottom: 2px solid var(--border-color);" title="As Backup (attends meeting)">Backup</th>
          <th style="padding: 6px; text-align: center; border-bottom: 2px solid var(--border-color);" title="As LC Agent (misses meeting)">LC Agent</th>
          <th style="padding: 6px; text-align: center; border-bottom: 2px solid var(--border-color);" title="Total meetings missed">Missed</th>
        </tr>
        ${report.slice(0, 20).map(p => `
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 5px;">${p.name}</td>
            <td style="padding: 5px; text-align: center; color: #10b981;">${p.asBackup || '-'}</td>
            <td style="padding: 5px; text-align: center; color: #3b82f6;">${p.asLcAgent || '-'}</td>
            <td style="padding: 5px; text-align: center; font-weight: 700; color: ${p.meetingsMissed > 3 ? '#dc2626' : p.meetingsMissed > 1 ? '#f59e0b' : '#16a34a'};">
              ${p.meetingsMissed}
            </td>
          </tr>
        `).join('')}
      </table>
      <div style="margin-top: 8px; font-size: 9px; color: var(--text-secondary);">
        ðŸ’¡ Tip: Assign people with <span style="color: #16a34a;">fewer</span> missed meetings as LC Agents for fairness.
      </div>
    `;
  } catch (err) {
    console.error("Error loading fairness stats:", err);
    statsEl.innerHTML = '<div style="color: var(--text-secondary);">Error loading fairness data.</div>';
  }
}

async function saveRotation() {
  const date = $("rotationDate").value;
  const meetingType = $("rotationMeetingType").value;
  const meetingTimeEST = $("rotationTimeEST").value;
  const meetingTimePST = $("rotationTimePST").value;
  const captain = $("rotationCaptain").value;
  const backup1 = $("rotationBackup1").value;
  const backup2 = $("rotationBackup2").value;
  const notes = $("rotationNotes").value;
  
  if (!date) return toast("Please select a date", "error");
  if (!captain) return toast("Please select a Captain", "error");
  
  try {
    const res = await fetch('/meeting-rotation/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        date, 
        meetingType,
        meetingTimeEST,
        meetingTimePST,
        captain, 
        backup1, 
        backup2,
        lcAgents: _currentLcAgents,
        notes,
        allHandsPtoAgents: _currentPtoAgents,
        manager: window._myName || "Admin"
      })
    });
    const data = await res.json();
    
    if (data.ok) {
      let msg = "âœ… Rotation saved!";
      if (meetingType === "allhands" && _currentPtoAgents.length > 0) {
        msg += ` +1h PTO credited to ${_currentPtoAgents.length} agent(s).`;
      }
      toast(msg, "success");
      loadRotationHistory();
      loadFairnessStats();
    } else {
      toast(data.error || "Failed to save", "error");
    }
  } catch (err) {
    toast("Error saving rotation", "error");
    console.error(err);
  }
}

// ============================================
// WEEKLY ASSIGNMENTS MODAL FUNCTIONS
// ============================================
async function openWeeklyAssignmentsModal() {
  const modal = $("weeklyAssignmentsModal");
  modal.style.display = "flex";
  
  // Populate agent dropdowns - use _peopleMeta or fetch from API
  let people = [];
  if (typeof _peopleMeta !== 'undefined' && Array.isArray(_peopleMeta) && _peopleMeta.length > 0) {
    people = _peopleMeta;
  } else if (window.__peopleCache && Array.isArray(window.__peopleCache) && window.__peopleCache.length > 0) {
    people = window.__peopleCache;
  } else {
    // Fetch from API as fallback
    try {
      const res = await fetch("/people");
      if (res.ok) {
        const data = await res.json();
        people = data.people || [];
        window.__peopleCache = people;
      }
    } catch (e) {
      console.error("Failed to fetch people for weekly assignments modal:", e);
    }
  }
  
  const agentOptions = '<option value="">-- Select --</option>' + 
    people.filter(p => p.active !== false).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
  
  // LC Team Member Tips (new)
  $("weeklyLcTips1").innerHTML = agentOptions;
  $("weeklyLcTips2").innerHTML = agentOptions;
  // Regular Team Member Tips
  $("weeklyTips1").innerHTML = agentOptions;
  $("weeklyTips2").innerHTML = agentOptions;
  // Moments (now single select)
  $("weeklyMoments").innerHTML = agentOptions;
  $("weeklyWalkthroughs").innerHTML = agentOptions;
  $("weeklyTeamBuilding").innerHTML = agentOptions;
  $("weeklyVolunteer").innerHTML = agentOptions;
  $("weeklyCsatWorkshop").innerHTML = agentOptions;
  
  // Set default to this Monday
  const today = new Date();
  const dayOfWeek = today.getDay();
  const monday = new Date(today);
  monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
  $("weeklyAssignmentDate").value = monday.toISOString().split('T')[0];
  
  loadWeeklyAssignments();
  loadWeeklyAssignmentHistory();
}

function closeWeeklyAssignmentsModal() {
  $("weeklyAssignmentsModal").style.display = "none";
}

async function loadWeeklyAssignments() {
  const weekOf = $("weeklyAssignmentDate").value;
  if (!weekOf) return;
  
  try {
    const res = await fetch(`/weekly-assignments/list?start=${weekOf}&end=${weekOf}`);
    const data = await res.json();
    
    if (data.assignments && data.assignments.length > 0) {
      const assignment = data.assignments[0];
      const lcTips = assignment.lcTeamMemberTips || [];
      const tips = assignment.teamMemberTips || [];
      const moments = assignment.momentsThatMadeSmile || [];
      
      // LC Team Member Tips (new field)
      $("weeklyLcTips1").value = lcTips[0] || "";
      $("weeklyLcTips2").value = lcTips[1] || "";
      // Regular Team Member Tips
      $("weeklyTips1").value = tips[0] || "";
      $("weeklyTips2").value = tips[1] || "";
      // Moments (now single person)
      $("weeklyMoments").value = moments[0] || "";
      $("weeklyWalkthroughs").value = assignment.ticketWalkthroughs || "";
      $("weeklyTeamBuilding").value = assignment.teamBuilding || "";
      $("weeklyVolunteer").value = assignment.teamBuildingVolunteer || "";
      $("weeklyCsatWorkshop").value = assignment.csatWorkshop || "";
      $("weeklyEvents").value = (assignment.events || []).join(", ");
    } else {
      // Clear fields for new week
      $("weeklyLcTips1").value = "";
      $("weeklyLcTips2").value = "";
      $("weeklyTips1").value = "";
      $("weeklyTips2").value = "";
      $("weeklyMoments").value = "";
      $("weeklyWalkthroughs").value = "";
      $("weeklyTeamBuilding").value = "";
      $("weeklyVolunteer").value = "";
      $("weeklyCsatWorkshop").value = "";
      $("weeklyEvents").value = "";
    }
  } catch (err) {
    console.error("Error loading weekly assignments:", err);
  }
}

async function loadWeeklyAssignmentHistory() {
  try {
    const res = await fetch('/weekly-assignments/list');
    const data = await res.json();
    
    const historyEl = $("weeklyAssignmentHistory");
    if (!data.assignments || data.assignments.length === 0) {
      historyEl.innerHTML = '<div style="color: var(--text-secondary);">No assignments saved yet.</div>';
      return;
    }
    
    historyEl.innerHTML = data.assignments.slice(0, 8).map(a => {
      const lcTips = (a.lcTeamMemberTips || []).join(', ') || '-';
      const tips = (a.teamMemberTips || []).join(', ') || '-';
      const moments = (a.momentsThatMadeSmile || []).join(', ') || '-';
      return `
        <div style="padding: 6px 0; border-bottom: 1px solid var(--border-color);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 600; cursor: pointer;" onclick="loadWeeklyAssignmentByDate('${a.weekOf}')" title="Click to edit">${a.weekOf}</span>
            <button type="button" onclick="deleteWeeklyAssignment('${a.weekOf}')" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 12px; padding: 2px;" title="Delete">ðŸ—‘ï¸</button>
          </div>
          <div style="color: var(--text-secondary); font-size: 10px;">LC Tips: ${lcTips} | Tips: ${tips} | Moments: ${moments}</div>
        </div>
      `;
    }).join('');
  } catch (err) {
    console.error("Error loading assignment history:", err);
  }
}

// Load a specific weekly assignment by date
function loadWeeklyAssignmentByDate(weekOf) {
  $("weeklyAssignmentDate").value = weekOf;
  loadWeeklyAssignmentForDate(weekOf);
}

// Load weekly assignment for a specific date
async function loadWeeklyAssignmentForDate(weekOf) {
  try {
    const res = await fetch(`/weekly-assignments/list?start=${weekOf}&end=${weekOf}`);
    const data = await res.json();
    
    if (data.assignments && data.assignments.length > 0) {
      const a = data.assignments[0];
      // LC Team Member Tips (new)
      $("weeklyLcTips1").value = (a.lcTeamMemberTips || [])[0] || "";
      $("weeklyLcTips2").value = (a.lcTeamMemberTips || [])[1] || "";
      // Regular Team Member Tips
      $("weeklyTips1").value = (a.teamMemberTips || [])[0] || "";
      $("weeklyTips2").value = (a.teamMemberTips || [])[1] || "";
      // Moments (single person now)
      $("weeklyMoments").value = (a.momentsThatMadeSmile || [])[0] || "";
      $("weeklyWalkthroughs").value = a.ticketWalkthroughs || "";
      $("weeklyCsatWorkshop").value = a.csatWorkshop || "";
      $("weeklyTeamBuilding").value = a.teamBuilding || "";
      $("weeklyVolunteer").value = a.teamBuildingVolunteer || "";
      $("weeklyEvents").value = (a.events || []).join(", ");
    }
  } catch (err) {
    console.error("Error loading weekly assignment:", err);
  }
}

// Delete a weekly assignment
async function deleteWeeklyAssignment(weekOf) {
  const result = await Swal.fire({
    title: 'Delete Weekly Assignment?',
    text: `Remove assignments for week of ${weekOf}?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, Delete',
    confirmButtonColor: '#dc2626'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const res = await fetch('/weekly-assignments/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ weekOf })
    });
    const data = await res.json();
    
    if (data.ok) {
      toast("âœ… Weekly assignment deleted", "success");
      loadWeeklyAssignmentHistory();
      // Clear form if viewing this date
      if ($("weeklyAssignmentDate").value === weekOf) {
        $("weeklyLcTips1").value = "";
        $("weeklyLcTips2").value = "";
        $("weeklyTips1").value = "";
        $("weeklyTips2").value = "";
        $("weeklyMoments").value = "";
        $("weeklyWalkthroughs").value = "";
        $("weeklyCsatWorkshop").value = "";
        $("weeklyTeamBuilding").value = "";
        $("weeklyVolunteer").value = "";
        $("weeklyEvents").value = "";
      }
    } else {
      toast(data.error || "Failed to delete", "error");
    }
  } catch (err) {
    toast("Error deleting assignment", "error");
    console.error(err);
  }
}

async function saveWeeklyAssignments() {
  const weekOf = $("weeklyAssignmentDate").value;
  
  if (!weekOf) return toast("Please select a week", "error");
  
  // LC Team Member Tips (new)
  const lcTeamMemberTips = [$("weeklyLcTips1").value, $("weeklyLcTips2").value].filter(Boolean);
  // Regular Team Member Tips
  const teamMemberTips = [$("weeklyTips1").value, $("weeklyTips2").value].filter(Boolean);
  // Moments (single person now)
  const momentsThatMadeSmile = [$("weeklyMoments").value].filter(Boolean);
  const ticketWalkthroughs = $("weeklyWalkthroughs").value;
  const teamBuilding = $("weeklyTeamBuilding").value;
  const teamBuildingVolunteer = $("weeklyVolunteer").value;
  const csatWorkshop = $("weeklyCsatWorkshop").value;
  const eventsStr = $("weeklyEvents").value;
  const events = eventsStr ? eventsStr.split(',').map(e => e.trim()).filter(Boolean) : [];
  
  try {
    const res = await fetch('/weekly-assignments/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        weekOf, 
        lcTeamMemberTips,
        teamMemberTips, 
        momentsThatMadeSmile, 
        ticketWalkthroughs,
        teamBuilding,
        teamBuildingVolunteer,
        csatWorkshop,
        events
      })
    });
    const data = await res.json();
    
    if (data.ok) {
      toast("âœ… Weekly assignments saved!", "success");
      loadWeeklyAssignmentHistory();
    } else {
      toast(data.error || "Failed to save", "error");
    }
  } catch (err) {
    toast("Error saving assignments", "error");
    console.error(err);
  }
}

  // ============================================
  // [SECTION 11] TIME OFF & PTO
  // ============================================
  async function submitTimeOff() {
    const reason = $("agToReason") ? $("agToReason").value : "";
    if (!reason) return toast("Please enter a reason", "error");
    const dateStr = _editing ? _editing.dateISO : new Date().toISOString().split("T")[0];
    
    // NEW: Grab shift times from the global _editing variable
    const sStart = _editing ? _editing.startLabel : "";
    const sEnd = _editing ? _editing.endLabel : "";
    const teamName = _editing ? _editing.team : "";
    const radioSelected = document.querySelector('input[name="timeOffType"]:checked');
    const timeOffType = radioSelected ? radioSelected.value : "Make Up";
    
    // Handle multiple make-up dates
    let makeUpDate = getMakeUpDatesString(); // Use new multi-date function
    let makeUpDates = [..._selectedMakeUpDates];
    
    // Fallback to single input if no dates added via chips
    if (makeUpDates.length === 0) {
      const singleDate = $("agMakeUpDate") ? $("agMakeUpDate").value : "";
      if (singleDate) {
        makeUpDate = singleDate;
        makeUpDates = [singleDate];
      }
    }
    
    if (timeOffType === "Make Up" && makeUpDates.length === 0) {
      return toast("Please add at least one Make Up date", "error");
    } 
    
    // NEW: Grab duration from radio
    const durationSelected = document.querySelector('input[name="timeOffDuration"]:checked');
    const durationVal = durationSelected ? durationSelected.value : "shift";

    // âœ… VALIDATE PTO BALANCE
    if (timeOffType === "PTO") {
      const balance = _balanceData.get(window._myName) || { pto: 0, sick: 0 };
      const currentPto = parseFloat(balance.pto) || 0;

      // Calculate hours needed (rough estimate)
      let hoursNeeded = durationVal === "full_day" ? 8 : 4;

      if (currentPto < hoursNeeded) {
        const result = await Swal.fire({
          title: 'âš ï¸ Insufficient PTO Balance',
          html: `
            <div style="text-align: left; font-size: 14px; line-height: 1.6;">
              <p><strong>Current PTO Balance:</strong> ${currentPto} hours</p>
              <p><strong>Estimated Needed:</strong> ${hoursNeeded} hours</p>
              <p style="color: #dc2626; font-weight: 600;">You do not have enough PTO for this request.</p>
              <p style="margin-top: 12px; padding: 12px; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px;">
                ðŸ’¡ <strong>Consider using "Make Up" instead:</strong> Work at another time without using PTO hours.
              </p>
            </div>
          `,
          icon: 'warning',
          showCancelButton: false,
          confirmButtonText: 'OK',
          confirmButtonColor: '#dc2626'
        });
        return; // Block the request
      } else if (currentPto < hoursNeeded + 4) {
        // Warn if balance would be low after request
        const result = await Swal.fire({
          title: 'âš ï¸ Low PTO Balance Warning',
          html: `
            <div style="text-align: left; font-size: 14px; line-height: 1.6;">
              <p><strong>Current PTO Balance:</strong> ${currentPto} hours</p>
              <p><strong>Estimated After Request:</strong> ~${Math.max(0, currentPto - hoursNeeded)} hours</p>
              <p style="color: #f59e0b; font-weight: 600;">Your PTO balance will be low after this request.</p>
              <p style="margin-top: 12px;">Do you want to continue?</p>
            </div>
          `,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, Continue',
          cancelButtonText: 'Cancel',
          confirmButtonColor: '#f59e0b'
        });
        if (!result.isConfirmed) return;
      }
    }

    const btn = event.currentTarget;
    const originalText = btn.innerText;
    btn.innerText = "Sending...";
    btn.disabled = true;
    try {
      const res = await fetch('./?action=timeoff/request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          person: window._myName,
          type: timeOffType,
          makeUpDate: makeUpDate, // Comma-separated for compatibility
          makeUpDates: makeUpDates, // Array of dates
          reason: reason,
          date: dateStr,
          shiftStart: sStart,
          shiftEnd: sEnd,
          team: teamName, // <--- Sending Team Name
          duration: durationVal,
          category: "pto"
        })
      });
    const data = await res.json();

    if (data.ok) {
      closeAgentModal(); // This calls the function to close the window
      resetMakeUpDates(); // Clear the selected dates

      // Show different messages for Make Up vs PTO
      if (timeOffType === "Make Up") {
        // Format dates nicely
        const formattedDates = makeUpDates.map(d => {
          const date = new Date(d + 'T12:00:00');
          return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }).join('<br>â€¢ ');
        
        Swal.fire({
          title: 'Make-Up Request Sent!',
          html: `
            <div style="text-align: left; font-size: 14px; line-height: 1.6;">
              <p>Your manager has been notified.</p>
              <p style="margin-top: 12px; padding: 12px; background: #dbeafe; border-left: 3px solid #b37e78; border-radius: 4px;">
                ðŸ“Œ <strong>Remember to make up time on:</strong><br>â€¢ ${formattedDates}
              </p>
            </div>
          `,
          icon: 'success',
          confirmButtonColor: '#b37e78'
        });
      } else {
        Swal.fire({
          title: 'PTO Request Sent!',
          text: 'Your manager has been notified.',
          icon: 'success',
          confirmButtonColor: '#b37e78'
        });
      }
      $("agToReason").value = "";
    } else {
      throw new Error(data.error || "Server rejected request");
    }
  } catch (err) {
    console.error(err);
    toast(`Error: ${err.message}`, "error");
  } finally {
    btn.innerText = originalText;
    btn.disabled = false;
  }
}
function closeAgentModal() {
  const modal = document.getElementById('agentOverlay'); // Note: Your HTML ID is 'agentOverlay', not 'agentModal'
  if (modal) {
    modal.style.display = "none";
  } else {
    console.error("Agent modal not found!");
  }
}

// Open swap shift modal - shows list of agent's upcoming shifts to swap
async function openSwapShiftModal() {
  const myName = window._myName || '';
  if (!myName) {
    toast("Please log in to swap shifts", "error");
    return;
  }
  
  const allData = window._filteredData || window._data || [];
  const today = new Date().toISOString().split('T')[0];
  
  // Get my upcoming shifts
  const myShifts = allData
    .filter(s => s.person && s.person.toLowerCase().trim() === myName.toLowerCase().trim())
    .filter(s => s.date >= today)
    .sort((a, b) => {
      if (a.date !== b.date) return (a.date || '').localeCompare(b.date || '');
      return (a.start || '').localeCompare(b.start || '');
    })
    .slice(0, 10); // Show next 10 shifts
  
  if (myShifts.length === 0) {
    toast("No upcoming shifts found to swap", "info");
    return;
  }
  
  // Build shift selection list
  const shiftListHtml = myShifts.map((shift, idx) => {
    const d = new Date(shift.date + 'T12:00:00');
    const dateStr = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    return `
      <div class="swap-shift-option" onclick="selectShiftForSwap(${idx})" data-idx="${idx}" 
           style="padding: 14px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s ease;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-weight: 700; font-size: 14px; color: var(--text-primary);">${dateStr}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${shift.startLabel || shift.start} - ${shift.endLabel || shift.end}</div>
          </div>
          <div style="background: var(--accent-primary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">
            ${shift.team || 'General'}
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Store shifts for later reference
  window._swapShiftOptions = myShifts;
  
  const result = await Swal.fire({
    title: 'ðŸ”„ Swap a Shift',
    html: `
      <div style="text-align: left; margin-bottom: 12px;">
        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">Select a shift you want to swap with a teammate:</p>
        <div id="swapShiftList" style="max-height: 350px; overflow-y: auto;">
          ${shiftListHtml}
        </div>
      </div>
    `,
    showConfirmButton: false,
    showCancelButton: true,
    cancelButtonText: 'Close',
    width: 480,
    customClass: {
      popup: 'swal-dark-mode'
    }
  });
}

// Called when a shift is selected in the swap modal
function selectShiftForSwap(idx) {
  Swal.close();
  const shift = window._swapShiftOptions?.[idx];
  if (shift) {
    openAgentActionModal(shift);
    // Auto-show swap form after a small delay
    setTimeout(() => {
      showAgentForm('swap');
    }, 100);
  }
}

// Show open shifts panel
async function showOpenShiftsPanel() {
  try {
    const res = await fetch('/open-shifts');
    const data = await res.json();
    
    if (!data.ok || !data.openShifts || data.openShifts.length === 0) {
      toast("No open shifts available right now", "info");
      return;
    }
    
    const shiftsHtml = data.openShifts.map(shift => {
      const d = new Date(shift.date + 'T12:00:00');
      const dateStr = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      const shiftId = `${shift.docId}|${shift.assignmentId}`;
      return `
        <div style="padding: 14px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div>
              <div style="font-weight: 700; font-size: 14px; color: var(--text-primary);">${dateStr}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">${shift.startLabel || shift.start || '--'} - ${shift.endLabel || shift.end || '--'}</div>
            </div>
            <div style="background: var(--accent-primary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">
              ${shift.team || 'General'}
            </div>
          </div>
          ${shift.openReason ? `<div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 10px; font-style: italic;">${shift.openReason}</div>` : ''}
          <button onclick="claimOpenShift('${shiftId}')" 
                  style="width: 100%; padding: 10px; background: linear-gradient(135deg, var(--modal-gradient-start) 0%, var(--modal-gradient-end) 100%); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
            Claim This Shift
          </button>
        </div>
      `;
    }).join('');
    
    await Swal.fire({
      title: 'ðŸ“¢ Open Shifts',
      html: `
        <div style="text-align: left;">
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">These shifts need coverage. Claim one to help your team!</p>
          <div style="max-height: 400px; overflow-y: auto;">
            ${shiftsHtml}
          </div>
        </div>
      `,
      showConfirmButton: false,
      showCancelButton: true,
      cancelButtonText: 'Close',
      width: 480,
      customClass: {
        popup: 'swal-dark-mode'
      }
    });
  } catch (err) {
    console.error("Error loading open shifts:", err);
    toast("Failed to load open shifts", "error");
  }
}

// Claim an open shift
async function claimOpenShift(shiftId) {
  const myName = window._myName || '';
  if (!myName) {
    toast("Please log in to claim shifts", "error");
    return;
  }
  
  const result = await Swal.fire({
    title: 'Claim This Shift?',
    text: 'Are you sure you want to volunteer for this shift?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Yes, Claim It',
    confirmButtonColor: '#b37e78'
  });
  
  if (!result.isConfirmed) return;
  
  // Parse the shiftId (format: docId|assignmentId)
  const [docId, assignmentId] = shiftId.split('|');
  
  try {
    const res = await fetch('/open-shifts/fill', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        docId,
        assignmentId,
        agentName: myName,
        notifyAgent: false
      })
    });
    const data = await res.json();
    
    if (data.ok) {
      Swal.close();
      toast("âœ… Shift claimed! It will appear in your schedule soon.", "success");
      // Refresh the open shifts display
      if (typeof updateAgentOpenShifts === 'function') updateAgentOpenShifts();
      // Refresh schedule if possible
      if (typeof loadSchedule === 'function') loadSchedule();
    } else {
      toast(data.error || "Failed to claim shift", "error");
    }
  } catch (err) {
    console.error("Error claiming shift:", err);
    toast("Failed to claim shift", "error");
  }
}


  async function submitSwap() {
    const targetPerson = $("agSwapPerson") ? $("agSwapPerson").value : "";
    const note = $("agSwapNote") ? $("agSwapNote").value : "";
    if (!targetPerson) return toast("Select a co-worker");
    if (!_editing) return toast("No shift selected");
    try {
      const res = await fetch('./?action=swap/request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          fromPerson: window._myName,
          toPerson: targetPerson,
          shiftDate: _editing.dateISO || _editing.date,
          shiftStart: _editing.startLabel || _editing.start,
          shiftEnd: _editing.endLabel || _editing.end,
          team: _editing.team,
          docId: _editing.docId,
          assignmentId: _editing.assignmentId,
          note: note
        })
      });
      
      const data = await res.json();
      
      if (data.ok) {
        closeAgentModal();
        toast(`âœ… Swap request sent to ${targetPerson}`, "success");
      } else {
        toast("Failed to send swap request: " + (data.error || "Unknown error"), "error");
      }
    } catch (err) {
      console.error("Swap request error:", err);
      toast("Failed to send swap request", "error");
    }
  }
  // --- 7. INTERACTIONS (Manager) ---
  function openReplaceModal(it) {
      _editing = it;
      $("mSub").textContent = `${it.dateLabel} â€¢ ${it.startLabel} â€¢ ${it.person}`;
      $("mNotes").value = it.notes || "";
      
      // Check for current "OFF" status
      const isOff = it.notes && it.notes.includes("[OFF]");
      const btn = $("actionBtn");
      if (isOff) { 
          // VISUAL: Green "Restore" state
          btn.innerHTML = "â™»ï¸ Restore Shift"; 
          btn.style.color = "#15803d"; 
          btn.style.borderColor = "#bbf7d0"; 
          btn.style.background = "#f0fdf4";
          // Change the function it calls
          btn.onclick = restoreShift; 
      } else { 
          // VISUAL: Red "Mark Off" state
          btn.innerHTML = "â›” Mark Off"; 
          btn.style.color = "#ef4444"; 
          btn.style.borderColor = "#fecaca"; 
          btn.style.background = "#fef2f2";
          // Change the function it calls
          btn.onclick = markTimeOff; 
      }
      $("modalOverlay").style.display = "flex";
      fillSelect("mNewPerson", _people.filter(p => p !== it.person), false);
  }
  async function saveReplace() {
  if (! _editing) return;
  const newP = document.getElementById("mNewPerson").value;
  if (! newP) return toast("Select person");
  const notes = document.getElementById("mNotes").value;
  const notifyMode = document.getElementById("mNotify").value;
  const originalPerson = _editing.person;
  const originalNotes = _editing.notes || "";
  
  // ============================================
  // CHECK FOR DOUBLE BOOKING BEFORE REPLACING
  // ============================================
  try {
    const conflictRes = await fetch('./?action=schedule/check-conflict', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        personName: newP,
        date: _editing.dateISO || _editing.date,
        startTime: _editing.start || _editing.startLabel,
        endTime: _editing.end || _editing.endLabel,
        excludeAssignmentId: _editing.assignmentId
      })
    });
    const conflictData = await conflictRes.json();
    
    if (conflictData.ok && conflictData.hasConflict && conflictData.conflicts.length > 0) {
      // Check if any conflicts are lunch-related
      const hasLunchConflict = conflictData.conflicts.some(c => c.isLunchConflict);
      
      // Show double booking warning with special lunch styling
      const conflictsList = conflictData.conflicts.map(c => {
        const icon = c.isLunchConflict ? 'ðŸ½ï¸' : 'âš ï¸';
        const style = c.isLunchConflict ? 'color:#dc2626; font-weight:700;' : '';
        return `<div style="${style}">${icon} ${c.team}: ${c.start}-${c.end}${c.isLunchConflict ? ' <b>(LUNCH!)</b>' : ''}</div>`;
      }).join('');
      
      const result = await Swal.fire({
        title: hasLunchConflict ? 'ðŸ½ï¸ Lunch Conflict!' : 'âš ï¸ Double Booking Detected',
        html: `
          <div style="text-align:left; padding:12px; background:${hasLunchConflict ? '#fef2f2' : '#fef3c7'}; border-radius:8px; border:1px solid ${hasLunchConflict ? '#fecaca' : '#fcd34d'};">
            <p style="margin:0 0 8px 0; font-weight:600;">${newP} is already scheduled:</p>
            ${conflictsList}
          </div>
          ${hasLunchConflict ? 
            '<p style="margin-top:12px; font-size:13px; color:#dc2626; font-weight:600;">âš ï¸ This would schedule during their lunch break!</p>' :
            '<p style="margin-top:12px; font-size:13px; color:#64748b;">Do you want to continue anyway?</p>'
          }
        `,
        icon: hasLunchConflict ? 'error' : 'warning',
        showCancelButton: true,
        confirmButtonColor: hasLunchConflict ? '#dc2626' : '#f59e0b',
        cancelButtonColor: '#64748b',
        confirmButtonText: hasLunchConflict ? 'Override Lunch' : 'Yes, Assign Anyway',
        cancelButtonText: 'Cancel'
      });
      
      if (!result.isConfirmed) {
        return; // User cancelled
      }
    }
  } catch (err) {
    console.warn("Conflict check failed, continuing:", err);
  }
  // Find the real local record
  const local = _allData.find(x =>
    String(x.assignmentId) === String(_editing.assignmentId) &&
    String(x.docId) === String(_editing.docId)
  ) || _editing;
  
  // ============================================
  // AUTO-ADD REPLACEMENT INFO TO NOTES
  // ============================================
  let enhancedNotes = notes;
  if (originalPerson && originalPerson !== newP && originalPerson !== "Unassigned") {
    // Check if notes already contains replacement info
    if (!notes.toLowerCase().includes("replaced") && !notes.toLowerCase().includes("covering")) {
      enhancedNotes = notes ? `${notes} [Replaced ${originalPerson}]` : `[Replaced ${originalPerson}]`;
    }
  }
  
  // Close modal + optimistic UI update
  document.getElementById("modalOverlay").style.display = "none";
  toast("Updating...");
  local.person = newP;
  local.notes = enhancedNotes;
  local.originalPerson = originalPerson; // Store for UI display
  renderView();
  const payload = {
    docId: _editing.docId,
    assignmentId: _editing.assignmentId,
    newPerson: newP,
    notes: enhancedNotes,
    notifyMode: notifyMode,
    originalPerson: originalPerson // Send to backend for tracking
  };
  
  try {
    const response = await fetch('./?action=assignment/replace', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const res = await response.json();
    
    if (res.ok || res.status === "success") {
      // Clear cache if agent
      if (! window._isManager && window._myName) {
        clearScheduleCache();
      }
      // Log to audit
      logAuditEntry({
        action: "REPLACE",
        manager: window._myName || window._myEmail,
        target: newP,
        date: local.dateLabel,
        details: `Replaced ${originalPerson} with ${newP} (${local.startLabel})`
      });
      // Handle Notifications
      if (res?.updated?.notifyStatus === "Pending" || notifyMode === "defer") {
        playNotificationSound();
        
        // NOTE: Do NOT add to local _notifQueue because the backend already
        // tracks this notification with notifyStatus='Pending'. 
        // loadPendingNotifications() will fetch it from the backend.
        // Only add undo data separately if needed.
        
        // Store undo data separately for this shift
        const undoKey = `undo_${_editing.docId}_${_editing.assignmentId}`;
        localStorage.setItem(undoKey, JSON.stringify({
          docId: _editing.docId,
          assignmentId: _editing.assignmentId,
          originalPerson: originalPerson,
          originalNotes: originalNotes
        }));
        
        toast("Added to Pending Queue");
        
        // Refresh the notification panel to show backend-tracked notification
        const panel = document.getElementById("notifPanel");
        
        if (panel) {
          panel.style.display = "block";
          panel.classList.add("open");
          loadPendingNotifications(); // This loads from backend
        }
        updateNotifBadge();
      } else {
        playSendSound();
        toast("Saved & Sent");
      }
    } else {
      throw new Error(res.error || res.message || "Unknown error");
    }
  } catch (err) {
    // Rollback UI on failure
    local.person = originalPerson;
    local.notes = originalNotes;
    renderView();
    toast(`Replace failed: ${err.message || err}`);
    console.error("Replace failed:", err);
  }
}
  function checkUrlNotifs() {
    // Use standard URL API instead of google.script.url
    try {
      const hash = window.location.hash;
      if (hash && hash.includes("notif=")) {
        const rawMsg = hash.split("notif=")[1];
        const msg = decodeURIComponent(rawMsg);
        Swal.fire({
            title: 'Schedule Update',
            html: msg,
            icon: 'info',
            confirmButtonText: 'Got it',
            confirmButtonColor: '#1e293b'
        });
        try { history.replaceState(null, null, ' '); } catch(e) {}
      }
    } catch(e) {
      console.log("URL check error:", e);
    }
  }
  function isBackupShift(shift) {
  const notes = String(shift.notes || "").toLowerCase();
  const patterns = [
    "back up",
    "backup", 
    "coverage",
    "covering",
    "temp",
    "temporary",
    "replacing",
    "replaced",
    "fill in",
    "fill-in",
    "fillin"
  ];
  
  return patterns.some(p => notes.includes(p));
}
function isCaptainShift(shift) {
  const notes = String(shift.notes || "").toLowerCase();
  return notes.includes("captain") || notes.includes("lead") || notes.includes("supervisor");
}
  function handleSaveClick() {
     if(!_editing) return;
     const isOff = _editing.notes && _editing.notes.includes("[OFF]");
     if(isOff) restoreShift(); else markTimeOff();
  }
  function markTimeOff(force) {
  if(!_editing) {
    toast("No shift selected", "error");
    return;
  }
  
  // Capture _editing data before async operations
  const editData = { ..._editing };
  
  const doIt = async () => {
    // Validate required fields
    if (!editData.docId || !editData.assignmentId) {
      toast("Missing shift data - cannot mark off", "error");
      console.error("markTimeOff: Missing docId or assignmentId", editData);
      return;
    }
    
    // optimistic UI
    _timeOff.add(`${editData.person}|${editData.dateISO}`);
    
    // Update the actual _editing object if it still exists
    const localItem = _allData.find(x => x.assignmentId === editData.assignmentId);
    if (localItem) {
      localItem.notes = ((localItem.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim() + " [OFF]").trim();
    }
    
    renderView();
    closeModal();
    toast("Marking person OFF...");
    
    try {
      const response = await fetch('./?action=assignment/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          docId: editData.docId,
          assignmentId: editData.assignmentId,
          markOff: true
        })
      });
      
      const res = await response.json();
      
      if (res.ok || res.status === "success") {
        if (!window._isManager && window._myName) {
          clearScheduleCache();
        }
        logAuditEntry({
          action: "MARK OFF",
          manager: window._myName || window._myEmail,
          target: editData.person,
          date: editData.dateLabel,
          details: `Marked ${editData.person} as OFF (${editData.startLabel})`
        });
        if (res && res.requireConfirm && !force) {
          Swal.fire({
            title: "Staffing Alert",
            text: res.message,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Mark Off Anyway",
            confirmButtonColor: "#ef4444"
          }).then((r) => { if (r.isConfirmed) markTimeOff(true); });
          return;
        }
        toast("Success: Marked OFF");
      } else {
        throw new Error(res.error || res.message || "Unknown error");
      }
    } catch (err) {
      toast(`Failed: ${err.message || err}`);
      console.error("markTimeOff failed:", err);
      // rollback UI
      _timeOff.delete(`${editData.person}|${editData.dateISO}`);
      if (localItem) {
        localItem.notes = (localItem.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim();
      }
      renderView();
    }
  };
  if (force) return doIt();
  Swal.fire({
    title: "Mark OFF?",
    text: `Are you sure you want to mark ${editData.person} OFF for this shift?`,
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, Mark OFF",
    confirmButtonColor: "#ef4444",
    cancelButtonColor: "#cbd5e1"
  }).then((r) => { if (r.isConfirmed) doIt(); });
}
  function restoreShift() {
  if (!_editing) {
    toast("No shift selected", "error");
    return;
  }
  
  // Capture _editing data before async operations
  const editData = { ..._editing };
  
  const doIt = async () => {
    // Validate required fields
    if (!editData.docId || !editData.assignmentId) {
      toast("Missing shift data - cannot restore", "error");
      console.error("restoreShift: Missing docId or assignmentId", editData);
      return;
    }
    
    // optimistic UI
    _timeOff.delete(`${editData.person}|${editData.dateISO}`);
    
    // Update the actual item if it still exists
    const localItem = _allData.find(x => x.assignmentId === editData.assignmentId);
    if (localItem) {
      localItem.notes = (localItem.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim();
    }
    
    renderView();
    closeModal();
    toast("Restoring shift...");
    
    try {
      const response = await fetch('./?action=assignment/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          docId: editData.docId,
          assignmentId: editData.assignmentId,
          markOff: false
        })
      });
      
      const res = await response.json();
      
      if (res.ok || res.status === "success") {
        if (!window._isManager && window._myName) {
          clearScheduleCache();
        }
        logAuditEntry({
          action: "RESTORE",
          manager: window._myName || window._myEmail,
          target: editData.person,
          date: editData.dateLabel,
          details: `Restored ${editData.person}'s shift (${editData.startLabel})`
        });
        toast("Success: Shift Restored");
      } else {
        throw new Error(res.error || res.message || "Unknown error");
      }
    } catch (e) {
      toast(`Restore failed: ${e.message || e}`);
      console.error("restoreShift failed:", e);
    }
  };
  
  Swal.fire({
    title: "Restore Shift?",
    text: `Remove the OFF status and restore ${editData.person}'s shift?`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Yes, Restore",
    confirmButtonColor: "#15803d",
    cancelButtonColor: "#cbd5e1"
  }).then((r) => { if (r.isConfirmed) doIt(); });
}
// ============================================
// HOLIDAYS MANAGEMENT
// ============================================
let _holidays = new Map(); // date -> { name, theme, emoji }
// Fetch holidays from backend
async function loadHolidays() {
  try {
    const res = await fetch("/?action=holidays/list");
    const data = await res.json();
    
    if (data.ok && data.holidays) {
      _holidays.clear();
      data.holidays.forEach(h => {
        _holidays.set(h.date, {
          name: h.name,
          theme: h.theme || "default",
          emoji: h.emoji || "â­"
        });
      });
    }
  } catch (err) {
    console.error("Failed to load holidays:", err);
  }
}
// Check if a date is a holiday
function getHoliday(dateStr) {
  return _holidays.get(dateStr) || null;
}
// Open holiday modal
function openHolidayModal() {
  const modal = $("holidayModal");
  if (!modal) return;

  // Show stacked above Admin Tools
  modal.style.display = "flex";
  modal.style.zIndex = "10060";

  renderHolidayList();
}
// Close holiday modal
function closeHolidayModal() {
  $("holidayModal").style.display = "none";
}
// Render holiday list in modal
function renderHolidayList() {
  const container = $("holidayList");
  
  if (_holidays.size === 0) {
    container.innerHTML = `<div style="text-align:center; color:#94a3b8; padding:20px;">No holidays scheduled</div>`;
    return;
  }
  
  // Sort by date
  const sorted = Array.from(_holidays.entries()).sort((a, b) => a[0].localeCompare(b[0]));
  
  container.innerHTML = sorted.map(([date, h]) => {
    const displayDate = new Date(date + "T00:00:00").toLocaleDateString("en-US", {
      weekday: "short",
      month: "short",
      day:  "numeric",
      year: "numeric"
    });
    
    return `
      <div class="holidayItem">
        <div class="holidayInfo">
          <span class="holidayEmoji">${h.emoji}</span>
          <div>
            <div class="holidayName">${h.name}</div>
            <div class="holidayDate">${displayDate}</div>
          </div>
        </div>
        <button class="deleteHolidayBtn" onclick="deleteHoliday('${date}')">ðŸ—‘ï¸ Delete</button>
      </div>
    `;
  }).join("");
}
// Add a new holiday
async function addHoliday() {
  const date = $("holidayDate").value;
  const name = $("holidayName").value.trim();
  const theme = $("holidayTheme").value;
  const emoji = $("holidayEmoji").value;
  
  if (!date || !name) {
    showToast("Please enter date and name", "error");
    return;
  }
  
  try {
    const res = await fetch("/?action=holidays/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ date, name, theme, emoji })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      showToast("Holiday added!", "success");
      
      // Update local cache
      _holidays.set(date, { name, theme, emoji });
      
      // Clear form
      $("holidayDate").value = "";
      $("holidayName").value = "";
      
      // Refresh list and calendar
      renderHolidayList();
      renderView();
    } else {
      showToast(data.error || "Failed to add holiday", "error");
    }
  } catch (err) {
    showToast("Error adding holiday", "error");
    console.error(err);
  }
}
// Delete a holiday
async function deleteHoliday(date) {
  if (!confirm("Delete this holiday?")) return;
  
  try {
    const res = await fetch("/?action=holidays/delete", {
      method: "POST",
      headers: { "Content-Type":  "application/json" },
      body: JSON.stringify({ date })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      showToast("Holiday deleted", "success");
      
      // Update local cache
      _holidays.delete(date);
      
      // Refresh list and calendar
      renderHolidayList();
      renderView();
    } else {
      showToast(data.error || "Failed to delete", "error");
    }
  } catch (err) {
    showToast("Error deleting holiday", "error");
    console.error(err);
  }
}
// Load 30 days of past schedule
async function loadPastSchedule() {
  if (_isLoadingMore) return;
  if (_scheduleLoadedPast >= 30) {
    toast("Past 30 days already loaded");
    return;
  }
  
  _isLoadingMore = true;
  const btn = document.getElementById("btnLoadPast");
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Loading...";
  }
  toast("Loading past schedule...", "info");
  
  try {
    const res = await fetch('./?action=schedule/past', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        daysBack: 30,
        isManager: window._isManager,
        agentName: window._myName
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.results) {
      // Process and merge past data into _allData
      const pastShifts = [];
      data.results.forEach(day => {
        if (day.assignments) {
          day.assignments.forEach(a => {
            const docId = String(day.id || "");
            const teamName = (docId.includes("__") ? docId.split("__")[1] : "") || day.team || "General";
            const assignmentId = a.assignmentId ?? a.id ?? "";
            
            // Extract date from docId (format: "2025-01-01__TeamName")
            const dateFromId = docId.includes("__") ? docId.split("__")[0] : "";
            const dateValue = day.date || dateFromId || "";
            const dayKey = dayKeyPST(dateValue) || dateValue;
            
            // Check if this shift already exists
            const exists = _allData.some(x => 
              x.docId === docId && x.assignmentId === assignmentId
            );
            
            if (!exists && dayKey) {
              pastShifts.push({
                ...a,
                docId,
                assignmentId,
                date: dateValue,
                dateISO: dayKey,
                dateLabel: displayDayLabel(dayKey),
                team: teamName,
                startLabel: toAmPm(a.start) || a.start,
                endLabel: toAmPm(a.end) || a.end
              });
            }
          });
        }
      });
      
      // Merge with existing data
      _allData = [...pastShifts, ..._allData];
      
      // Sort by date
      _allData.sort((a, b) => (a.dateISO || "").localeCompare(b.dateISO || ""));
      
      _scheduleLoadedPast = 30;
      updateLoadedRangeLabel();
      
      // Re-apply filters and render
      applyLocalFilters();
      renderView();
      
      toast(`âœ… Loaded ${pastShifts.length} past shifts`, "success");
    }
    
  } catch (err) {
    console.error("Error loading past schedule:", err);
    toast("Failed to load past schedule", "error");
  } finally {
    _isLoadingMore = false;
    if (btn) {
      btn.disabled = false;
      btn.textContent = "â† Load 30 Days History";
    }
  }
}
// Update the label showing current loaded range
function updateLoadedRangeLabel() {
  const label = document.getElementById("loadedRangeLabel");
  if (!label) return;
  
  let text = "";
  if (_scheduleLoadedPast > 0) {
    text += `${_scheduleLoadedPast}d ago`;
  } else {
    text += "Today";
  }
  text += ` â†’ ${_scheduleLoadedFuture}d ahead`;
  
  label.textContent = text;
  
  // Update button states
  const btnPast = document.getElementById("btnLoadPast");
  const btnFuture = document.getElementById("btnLoadFuture");
  
  if (btnPast) {
    if (_scheduleLoadedPast >= 30) {
      btnPast.style.display = "none";
    } else {
      btnPast.style.display = "";
      btnPast.textContent = "â† Load History";
    }
  }
  if (btnFuture) {
    if (_scheduleLoadedFuture >= 60) {
      btnFuture.style.display = "none";
    } else {
      btnFuture.style.display = "";
      btnFuture.textContent = "Load Future â†’";
    }
  }
}
// Load extended future schedule (up to 60 days)
async function loadExtendedFuture() {
  if (_isLoadingMore) return;
  if (_scheduleLoadedFuture >= 60) {
    toast("60 days future already loaded");
    return;
  }
  
  _isLoadingMore = true;
  const btn = document.getElementById("btnLoadFuture");
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Generating...";
  }
  toast("Loading & generating future schedule...", "info");
  
  try {
    // Start from where we left off
    const today = new Date();
    const startFrom = new Date(today);
    startFrom.setDate(startFrom.getDate() + _scheduleLoadedFuture);
    const startISO = startFrom.toISOString().split("T")[0];
    
    const daysToLoad = 60 - _scheduleLoadedFuture;
    
    const res = await fetch('./?action=schedule/future', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        daysForward: daysToLoad,
        startFrom: startISO,
        isManager: window._isManager,
        agentName: window._myName
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.results) {
      // Process and merge future data into _allData
      const futureShifts = [];
      data.results.forEach(day => {
        if (day.assignments) {
          day.assignments.forEach(a => {
            const docId = String(day.id || "");
            const teamName = (docId.includes("__") ? docId.split("__")[1] : "") || day.team || "General";
            const assignmentId = a.assignmentId ?? a.id ?? "";
            
            // Extract date from docId (format: "2025-01-01__TeamName")
            const dateFromId = docId.includes("__") ? docId.split("__")[0] : "";
            const dateValue = day.date || dateFromId || "";
            const dayKey = dayKeyPST(dateValue) || dateValue;
            
            // Check if this shift already exists
            const exists = _allData.some(x => 
              x.docId === docId && x.assignmentId === assignmentId
            );
            
            if (!exists && dayKey) {
              futureShifts.push({
                ...a,
                docId,
                assignmentId,
                date: dateValue,
                dateISO: dayKey,
                dateLabel: displayDayLabel(dayKey),
                team: teamName,
                startLabel: toAmPm(a.start) || a.start,
                endLabel: toAmPm(a.end) || a.end
              });
            }
          });
        }
      });
      
      // Merge with existing data
      _allData = [..._allData, ...futureShifts];
      
      // Sort by date
      _allData.sort((a, b) => (a.dateISO || "").localeCompare(b.dateISO || ""));
      
      _scheduleLoadedFuture = 60;
      updateLoadedRangeLabel();
      
      // Re-apply filters and render
      applyLocalFilters();
      renderView();
      
      // Show detailed toast with generated count
      const generated = data.meta?.generatedDays || 0;
      if (generated > 0) {
        toast(`âœ… Loaded ${futureShifts.length} shifts (${generated} new days generated)`, "success");
      } else {
        toast(`âœ… Loaded ${futureShifts.length} future shifts`, "success");
      }
    }
    
  } catch (err) {
    console.error("Error loading future schedule:", err);
    toast("Failed to load future schedule", "error");
  } finally {
    _isLoadingMore = false;
    if (btn) {
      btn.disabled = false;
      btn.textContent = "Load Future â†’";
    }
  }
}

// Agent-specific schedule loader (simplified - loads 30 days total)
async function agentLoadMoreSchedule() {
  if (_isLoadingMore) return;
  if (_agentScheduleDays >= 30) {
    toast("30 days already loaded");
    return;
  }
  
  _isLoadingMore = true;
  const btn = document.getElementById("btnAgentLoadMore");
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = "â³ Loading...";
  }
  
  toast("Loading more schedule...", "info");
  
  try {
    // Load from day 15 to day 30
    const today = new Date();
    const startFrom = new Date(today);
    startFrom.setDate(startFrom.getDate() + _agentScheduleDays);
    const startISO = startFrom.toISOString().split("T")[0];
    
    const daysToLoad = 30 - _agentScheduleDays;
    
    const res = await fetch('./?action=schedule/future', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        daysForward: daysToLoad,
        startFrom: startISO,
        isManager: false,
        agentName: window._myName
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.results) {
      const newShifts = [];
      data.results.forEach(day => {
        if (day.assignments) {
          day.assignments.forEach(a => {
            const docId = String(day.id || "");
            const teamName = (docId.includes("__") ? docId.split("__")[1] : "") || day.team || "General";
            const assignmentId = a.assignmentId ?? a.id ?? "";
            const dateFromId = docId.includes("__") ? docId.split("__")[0] : "";
            const dateValue = day.date || dateFromId || "";
            const dayKey = dayKeyPST(dateValue) || dateValue;
            
            const exists = _allData.some(x => 
              x.docId === docId && x.assignmentId === assignmentId
            );
            
            if (!exists && dayKey) {
              newShifts.push({
                ...a,
                docId,
                assignmentId,
                date: dateValue,
                dateISO: dayKey,
                dateLabel: displayDayLabel(dayKey),
                team: teamName,
                startLabel: toAmPm(a.start) || a.start,
                endLabel: toAmPm(a.end) || a.end
              });
            }
          });
        }
      });
      
      _allData = [..._allData, ...newShifts];
      _allData.sort((a, b) => (a.dateISO || "").localeCompare(b.dateISO || ""));
      
      _agentScheduleDays = 30;
      updateAgentRangeLabel();
      
      // Clear cache since we have new data
      clearScheduleCache();
      
      applyLocalFilters();
      renderView();
      
      toast(`âœ… Loaded ${newShifts.length} more shifts`, "success");
    }
  } catch (err) {
    console.error("Error loading agent schedule:", err);
    toast("Failed to load schedule", "error");
  } finally {
    _isLoadingMore = false;
    if (btn) {
      btn.disabled = _agentScheduleDays >= 30;
      btn.innerHTML = _agentScheduleDays >= 30 ? "âœ… 30 Days Loaded" : "ðŸ“† Load 30 Days";
      if (_agentScheduleDays >= 30) {
        btn.style.background = "#f0fdf4";
        btn.style.borderColor = "#86efac";
        btn.style.color = "#15803d";
      }
    }
  }
}
function updateAgentRangeLabel() {
  const label = document.getElementById("agentRangeLabel");
  if (label) {
    label.textContent = `Today â†’ ${_agentScheduleDays} days`;
  }
}

function updateAgentScheduleBanner() {
  const banner = $("agentScheduleBanner");
  if (!banner) return;
  if (window._isManager || !window._myName) {
    banner.style.display = "none";
    return;
  }
  if (!_allData || _allData.length === 0) {
    banner.style.display = "none";
    return;
  }
  banner.style.display = "grid";

  const currentStatus = $("agentCurrentShiftStatus");
  const currentTime = $("agentCurrentShiftTime");
  const currentTeam = $("agentCurrentShiftTeam");
  const currentRole = $("agentCurrentShiftRole");
  const currentProgressWrap = $("agentCurrentShiftProgressWrap");
  const currentProgress = $("agentCurrentShiftProgress");
  const nextStatus = $("agentNextShiftStatus");
  const nextTime = $("agentNextShiftTime");
  const nextTeam = $("agentNextShiftTeam");
  const nextRole = $("agentNextShiftRole");
  const nextDate = $("agentNextShiftDate");

  const setStatus = (el, text, type) => {
    if (!el) return;
    el.textContent = text;
    el.className = `agent-schedule-pill${type ? ` ${type}` : ""}`;
  };

  const nowParts = pstParts(new Date());
  if (!nowParts) return;
  const todayKey = `${nowParts.year}-${nowParts.month}-${nowParts.day}`;
  const nowDec = parseTimeDecimal(`${nowParts.hour}:${nowParts.minute}`);

  const shifts = _allData
    .filter(s => s.person === window._myName && !String(s.notes || "").toUpperCase().includes("[OFF]"))
    .map(s => {
      const dayKey = s.dayKey || s.dateISO || dayKeyPST(s.date);
      const startDec = parseTimeDecimal(s.start);
      const endDec = parseTimeDecimal(s.end);
      return { ...s, dayKey, startDec, endDec };
    })
    .filter(s => s.dayKey && !isNaN(s.startDec) && !isNaN(s.endDec))
    .sort((a, b) => {
      if (a.dayKey !== b.dayKey) return a.dayKey.localeCompare(b.dayKey);
      return a.startDec - b.startDec;
    });

  if (shifts.length === 0) {
    setStatus(currentStatus, "Off", "off");
    if (currentTime) currentTime.textContent = "No active shift";
    if (currentTeam) currentTeam.textContent = "--";
    if (currentRole) currentRole.textContent = "";
    if (currentProgressWrap) currentProgressWrap.style.display = "none";

    setStatus(nextStatus, "None");
    if (nextTime) nextTime.textContent = "No upcoming shift";
    if (nextTeam) nextTeam.textContent = "--";
    if (nextRole) nextRole.textContent = "";
    if (nextDate) nextDate.textContent = "";
    return;
  }

  const currentShift = shifts.find(s =>
    s.dayKey === todayKey && s.startDec <= nowDec && s.endDec > nowDec
  );

  if (currentShift) {
    setStatus(currentStatus, "On shift", "active");
    if (currentTime) currentTime.textContent = `${toAmPm(currentShift.start)} - ${toAmPm(currentShift.end)}`;
    if (currentTeam) currentTeam.textContent = currentShift.team || "General";
    if (currentRole) currentRole.textContent = currentShift.role ? `â€¢ ${currentShift.role}` : "";
    if (currentProgressWrap) currentProgressWrap.style.display = "block";
    if (currentProgress) {
      const duration = Math.max(currentShift.endDec - currentShift.startDec, 0.01);
      const elapsed = Math.min(Math.max(nowDec - currentShift.startDec, 0), duration);
      const pct = Math.min(Math.max((elapsed / duration) * 100, 0), 100);
      currentProgress.style.width = `${pct.toFixed(0)}%`;
    }
  } else {
    setStatus(currentStatus, "Off", "off");
    if (currentTime) currentTime.textContent = "No active shift";
    if (currentTeam) currentTeam.textContent = "--";
    if (currentRole) currentRole.textContent = "";
    if (currentProgressWrap) currentProgressWrap.style.display = "none";
    if (currentProgress) currentProgress.style.width = "0%";
  }

  const upcomingShift = shifts.find(s =>
    s.dayKey > todayKey || (s.dayKey === todayKey && s.startDec > nowDec)
  );

  if (upcomingShift) {
    setStatus(nextStatus, "Upcoming");
    if (nextTime) nextTime.textContent = `${toAmPm(upcomingShift.start)} - ${toAmPm(upcomingShift.end)}`;
    if (nextTeam) nextTeam.textContent = upcomingShift.team || "General";
    if (nextRole) nextRole.textContent = upcomingShift.role ? `â€¢ ${upcomingShift.role}` : "";
    if (nextDate) {
      nextDate.textContent = upcomingShift.dayKey === todayKey ? "Today" : displayDayLabel(upcomingShift.dayKey);
    }
  } else {
    setStatus(nextStatus, "None");
    if (nextTime) nextTime.textContent = "No upcoming shift";
    if (nextTeam) nextTeam.textContent = "--";
    if (nextRole) nextRole.textContent = "";
    if (nextDate) nextDate.textContent = "";
  }
}
  async function runUndo() { 
    if (!_lastUndo) return;
    try {
      const res = await fetch('./?action=assignment/replace', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          docId: _lastUndo.docId,
          assignmentId: _lastUndo.id, 
          newPerson: _lastUndo.oldP, 
          notes: _lastUndo.notes || "",
          notifyMode: "defer"
        })
      });
      const data = await res.json();
      if (data.ok) {
        _lastUndo = null;
        loadSystemData();
        toast("âœ… Undo successful", "success");
      } else {
        toast("Undo failed: " + (data.error || "Unknown error"), "error");
      }
    } catch (err) {
      console.error("Undo error:", err);
      toast("Undo failed", "error");
    }
  }
  function closeModal() {
    // Hide the Master Schedule Edit modal
    const editModal = document.getElementById("editShiftModal");
    if (editModal) editModal.style.display = "none";
    // Hide the Replace Coverage modal
    const replaceModal = document.getElementById("modalOverlay");
    if (replaceModal) replaceModal.style.display = "none";
    
    // Clear the editing reference
    _editing = null;
    
    // âœ… Re-enable auto-refresh
    setEditingMode(false);
  }
  // --- 8. PROFILES & METRICS ---
  function openProfile(name) {
     _activeProfileRequest = name;
     $("profileOverlay").style.display = "flex"; 
     $("profContent").style.display = "none"; 
     $("profLoader").style.display = "block";
     $("pName").innerText = name; 
     $("profLoader").innerHTML = '<div style="color:#64748b;">ðŸ”„ Loading Zendesk metrics...</div>';
     
     // Check cache first
     const cached = _zendeskMetricsByName.get(String(name));
     if(cached) { renderProfileCached(cached); }
     
     // Use fetch instead of google.script.run
     fetch('./?action=agent-profile', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ name: name })
     })
     .then(res => {
       if (!res.ok) throw new Error(`Server error: ${res.status}`);
       return res.json();
     })
     .then(data => {
       if(data.name !== _activeProfileRequest) return;
       if(data.error) {
         // Show graceful error with fallback info
         $("profLoader").innerHTML = `
           <div style="text-align:center; padding:20px;">
             <div style="font-size:40px; margin-bottom:10px;">ðŸ‘¤</div>
             <div style="font-weight:700; color:#0f172a; font-size:16px; margin-bottom:5px;">${escapeHtml(name)}</div>
             <div style="color:#94a3b8; font-size:12px; margin-bottom:15px;">Zendesk data unavailable</div>
             <div style="background:#fef3c7; border:1px solid #fcd34d; padding:10px; border-radius:8px; font-size:11px; color:#92400e;">
               ${escapeHtml(data.error)}
             </div>
           </div>
         `;
         return;
       }
       renderProfileData(data);
     })
     .catch(err => {
       console.error("Profile fetch error:", err);
       $("profLoader").innerHTML = `
         <div style="text-align:center; padding:20px;">
           <div style="font-size:40px; margin-bottom:10px;">ðŸ‘¤</div>
           <div style="font-weight:700; color:#0f172a; font-size:16px; margin-bottom:5px;">${escapeHtml(name)}</div>
           <div style="color:#94a3b8; font-size:12px; margin-bottom:15px;">Could not load profile</div>
           <div style="background:#fee2e2; border:1px solid #fecaca; padding:10px; border-radius:8px; font-size:11px; color:#dc2626;">
             ${escapeHtml(err.message || 'Connection error')}
           </div>
         </div>
       `;
     });
  }

// Load agent dashboard assignments (meeting rotation and weekly assignments)
async function loadAgentDashboardAssignments() {
  if (!window._myName) return;
  
  try {
    // Load both in parallel
    await Promise.all([
      loadAgentWeeklyAssignments(),
      loadAgentRotationInfo()
    ]);
    
    // Check if banner should be hidden (no assignments found)
    const banner = $("agentAssignmentsBanner");
    const meetingCard = $("agentMeetingRoleCard");
    const assignCard = $("agentWeeklyAssignCard");
    
    if (banner) {
      const hasMeetingRole = meetingCard && meetingCard.style.display !== "none";
      const hasAssignments = assignCard && assignCard.style.display !== "none";
      banner.style.display = (hasMeetingRole || hasAssignments) ? "block" : "none";
    }
  } catch (err) {
    console.error("Error loading dashboard assignments:", err);
  }
}

  // Switch day by offset (-1 or +1)
function changeDay(offset) {
    if (!_selectedDateISO) return;
    
    const current = new Date(_selectedDateISO + "T12:00:00");
    current.setDate(current.getDate() + offset);
    
    // Convert back to YYYY-MM-DD
    const newDateISO = current.toLocaleDateString("en-CA", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
    });
    
    // Update and render
    _selectedDateISO = newDateISO;
    renderScheduleView();
    
    // Scroll the tab into view
    setTimeout(() => {
        const activeTab = document.querySelector('.day-tab.active');
        if(activeTab) activeTab.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}
// Jump to specific date from picker
function handleDateJump(val) {
    if (!val) return;
    _selectedDateISO = val;
    renderScheduleView();
    toast(`Jumped to ${val}`);
}
  function renderProfileData(data) {
     $("profLoader").style.display = "none";
     if(data.error) { $("profLoader").style.display = "block"; $("profLoader").innerText = data.error; return; }
     $("profContent").style.display = "block";
     
     $("pName").innerText = data.name; 
     $("pEmail").innerText = data.email; 
     if($("pRole")) $("pRole").innerText = data.role || "--";
     
     const q = "type:ticket status<solved assignee:\"" + data.name + "\"";
     const url = "https://musely.zendesk.com/agent/search/1?query=" + encodeURIComponent(q);
     const el = $("pTickets"); el.innerHTML = "";
     const a = document.createElement("a"); a.href = url; a.target = "_blank"; a.innerText = (data.openTickets ?? "--") + " ðŸ”—";
     a.style.color = "#0284c7"; a.style.textDecoration = "none";
     el.appendChild(a);
     
     $("pAvatar").src = data.avatar || "https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y";
     
     // Format last login with more detail
     if (data.lastLogin) {
       const loginDate = new Date(data.lastLogin);
       const now = new Date();
       const diffMs = now - loginDate;
       const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
       let loginText;
       if (diffDays === 0) {
         loginText = "Today at " + loginDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
       } else if (diffDays === 1) {
         loginText = "Yesterday";
       } else if (diffDays < 7) {
         loginText = diffDays + " days ago";
       } else {
         loginText = loginDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       }
       $("pLogin").innerText = loginText;
     } else {
       $("pLogin").innerText = "Never";
     }
  }
  function renderProfileCached(c) {
     $("profContent").style.display = "block";
     $("pName").innerText = c.agentName; $("pEmail").innerText = c.email; 
     if($("pRole")) $("pRole").innerText = c.role || "--";
     
     $("pTickets").innerText = c.openTickets ?? "--";
     $("pLogin").innerText = "Cached";
     if(c.zendeskUserId) {
        const url = "https://musely.zendesk.com/agent/search/1?query=" + encodeURIComponent("assignee_id:"+c.zendeskUserId);
        const el = $("pTickets"); el.innerHTML = "";
        const a = document.createElement("a"); a.href = url; a.target = "_blank"; a.innerText = (c.openTickets ?? "--") + " ðŸ”—";
        a.style.color = "#0284c7"; a.style.textDecoration = "none";
        el.appendChild(a);
     }
  }
  function renderMetricsList() {
     const host = $("metricsList"); host.innerHTML = "";
     const q = ($("metricsSearch").value || "").toLowerCase();
     _people.filter(p => !q || p.toLowerCase().includes(q)).forEach(p => {
         const row = mkDiv("metricsRow");
         const meta = _peopleMetaByName.get(p.toLowerCase());
         const email = meta?.email || "";
         row.innerHTML = `<div class="left"><div class="avatar">${p.substring(0,2)}</div><div class="name">${p}</div></div>`;
         row.onclick = () => openMetricsProfile(p, email);
         host.appendChild(row);
     });
  }
  function openMetricsProfile(name, email) {
    _activeMetricsRequest = name;
    _activeMetricsEmail = email || "";
    window._activeMetricsEmail = _activeMetricsEmail;
    
    const d = document.getElementById("metricsDrawer"); 
    d.classList.add("open");
    
    const loader = document.getElementById("mProfLoader");
    const content = document.getElementById("mProfContent");
    
    loader.style.display = "block";
    loader.innerHTML = `<div style="text-align:center; padding:20px;">
                          <div class="spinner-border" style="width:20px; height:20px; border:3px solid #cbd5e1; border-top:3px solid #b37e78; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px;"></div>
                          <div>Fetching data for <b>${name}</b>...</div>
                          <div style="font-size:10px; color:#94a3b8; margin-top:5px;">This may take a moment...</div>
                        </div>`;
    
    content.style.display = "none";
    
    // Use fetch instead of google.script.run
    fetch('./?action=agent-profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name, email: email })
    })
    .then(res => res.json())
    .then(data => renderMetricsProfileData(data))
    .catch(err => {
      loader.innerHTML = `<div style="color:red;">System Error: ${err.message || err}</div>`;
    });
    
    setTimeout(() => {
        if (loader.style.display !== "none" && !loader.innerHTML.includes("Error") && !loader.innerHTML.includes("System Error")) {
             loader.innerHTML = `<div style="color:#f59e0b; background:#fffbeb; padding:10px; border-radius:8px; border:1px solid #fcd34d;">
                                  <strong>Taking longer than usual...</strong><br>
                                  The server is still processing. Please wait or try again.<br>
                                  <button class="btn ghost" style="margin-top:8px; font-size:11px;" onclick="openMetricsProfile('${name}', window._activeMetricsEmail || '')">Retry</button>
                                </div>`;
        }
    }, 30000);
  }
  function renderMetricsProfileData(data) {
    const loader = document.getElementById("mProfLoader");
    const content = document.getElementById("mProfContent");
    const ticketsListEl = document.getElementById("mTicketsList");
    const ticketsEmptyEl = document.getElementById("mTicketsEmpty");
    
    if (!data || data.error) {
        const errorMsg = data ? data.error : "Unknown error from server";
        loader.style.display = "block";
        loader.innerHTML = `<div style="color:#ef4444; background:#fef2f2; padding:10px; border-radius:8px; border:1px solid #fecaca;">
                              <strong>Error:</strong> ${errorMsg}
                            </div>`;
        content.style.display = "none";
        return;
    }
    loader.style.display = "none";
    content.style.display = "block";
    if(document.getElementById("mName")) document.getElementById("mName").innerText = data.name || "--";
    if(document.getElementById("mEmail")) document.getElementById("mEmail").innerText = data.email || "--";
    if(document.getElementById("mRole")) document.getElementById("mRole").innerText = data.role || "--";
    
    if(document.getElementById("mOpen")) document.getElementById("mOpen").innerText = data.openTickets ?? "--";
    
    // Render clickable ticket list for managers
    if (ticketsListEl) {
      if (data.openTicketsList && data.openTicketsList.length > 0) {
        ticketsListEl.innerHTML = data.openTicketsList.map(ticket => {
          const priorityClass = ticket.priority ? `ticket-priority ${ticket.priority}` : '';
          const priorityBadge = ticket.priority ? 
            `<span class="${priorityClass}">${ticket.priority}</span>` : '';
          
          return `
            <a href="${ticket.url}" target="_blank" rel="noopener" class="ticket-list-item">
              <span class="ticket-id-badge">#${ticket.id}</span>
              <span class="ticket-subject" title="${(ticket.subject || '').replace(/"/g, '&quot;')}">${ticket.subject || '(No subject)'}</span>
              ${priorityBadge}
              <span class="ticket-arrow">â†’</span>
            </a>
          `;
        }).join('');
        ticketsListEl.style.display = "block";
        if (ticketsEmptyEl) ticketsEmptyEl.style.display = "none";
      } else {
        ticketsListEl.style.display = "none";
        if (ticketsEmptyEl) ticketsEmptyEl.style.display = "block";
      }
    }
    
    if(document.getElementById("mAvatar")) {
        document.getElementById("mAvatar").src = data.avatar || "https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y";
    }
    if(document.getElementById("mLogin")) {
        if (data.lastLogin) {
            const dateObj = new Date(data.lastLogin);
            const nice = dateObj.toLocaleDateString('en-US', { month:'short', day:'numeric' }) + ", " + dateObj.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
            document.getElementById("mLogin").innerText = nice;
        } else {
            document.getElementById("mLogin").innerText = "Never";
        }
    }
  }
  
  // Browser-side helper: fetch people from the server (uses server-side getCachedMetadata)
async function fetchPeopleCached() {
  // optional: cache in memory so we don't refetch repeatedly
  if (window.__peopleCache && Array.isArray(window.__peopleCache)) return window.__peopleCache;

  const res = await fetch("/people");
  if (!res.ok) throw new Error("Failed to load people metadata");
  const data = await res.json();

  window.__peopleCache = data.people || [];
  return window.__peopleCache;
}
  
  // Force refresh - clears DATA cache only, preserves auth session
function forceRefresh() {
  console.log("ðŸ”„ Force refresh triggered");
  
  // âœ… CRITICAL FIX: Do NOT clear auth session on refresh!
  // Only clear schedule/metadata caches, keep user logged in
  
  if (typeof clearScheduleCache === 'function') {
    clearScheduleCache();
  } else {
    // Fallback: manually clear cache keys (but NOT auth!)
    localStorage.removeItem('musely_schedule_cache');
    localStorage.removeItem('musely_metadata_cache');
    try {
      // Clear any agent-specific cache
      const myName = window._myName || '';
      if (myName) {
        localStorage.removeItem(`musely_schedule_cache_${myName}`);
      }
    } catch(e) {}
  }
  
  // âœ… Refresh session timestamp on user activity
  if (window._myEmail && window._myName) {
    refreshSessionTimestamp();
  }
  
  // Show feedback
  toast("ðŸ”„ Refreshing data...", "info");
  
  // Reload data
  if (typeof load === 'function') {
    load(true); // true = force refresh
  } else if (typeof loadSystemData === 'function') {
    loadSystemData();
  } else {
    // Fallback: reload the page
    window.location.reload();
  }
}
// Make it globally accessible
window.forceRefresh = forceRefresh;
  function closeMetricsDrawer() { $("metricsDrawer").classList.remove("open"); }
  function closeProfile() { $("profileOverlay").style.display = "none"; }
  // --- 9. AUDIT & MASTER MODES ---
  function openAuditLog() {
  $("auditOverlay").style.display = "flex";
  $("auditList").innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">Fetching logs from server...</td></tr>`;
  
  fetch("/?action=audit/logs")
    .then(res => res.json())
    .then(data => {
      if (data.ok && data.logs) {
        renderAuditLog(data.logs);
      } else {
        $("auditList").innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#ef4444;">Failed to load audit logs</td></tr>`;
      }
    })
    .catch(err => {
      console.error("Audit fetch error:", err);
      $("auditList").innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#ef4444;">Error: ${err.message}</td></tr>`;
    });
}
  function closeAuditModal() { $("auditOverlay").style.display = "none"; }
  
  // Clear audit history with confirmation
  async function clearAuditHistory() {
    const result = await Swal.fire({
      title: 'Clear Audit History',
      text: 'What would you like to clear?',
      icon: 'warning',
      showCancelButton: true,
      showDenyButton: true,
      confirmButtonText: 'Clear All',
      denyButtonText: 'Older than 30 days',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#ef4444',
      denyButtonColor: '#f59e0b'
    });
    
    if (result.isDismissed) return;
    
    const mode = result.isConfirmed ? 'all' : 'older';
    const payload = { mode };
    if (mode === 'older') payload.olderThanDays = 30;
    
    try {
      const res = await fetch("/?action=audit/clear", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      
      const data = await res.json();
      if (data.ok) {
        toast(`Cleared ${data.deleted} audit entries`, "success");
        // Refresh the audit list
        openAuditLog();
      } else {
        toast("Failed to clear: " + (data.error || "Unknown error"), "error");
      }
    } catch (err) {
      toast("Error clearing audit history: " + err.message, "error");
    }
  }
  
  function renderAuditLog(logs) {
  const list = $("auditList");
  list.innerHTML = "";
  
  if (!logs || logs.length === 0) {
    list.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">No history found.</td></tr>`;
    return;
  }
  
  logs.forEach(row => {
    const tr = document.createElement("tr");
    let badgeClass = "ab-blue";
    if (String(row.action || "").includes("OFF") || String(row.action || "").includes("DELETE")) {
      badgeClass = "ab-red";
    }
    
    let niceTime = row.timestamp;
    try {
      const d = new Date(row.timestamp);
      niceTime = d.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    } catch (e) {}
    
    tr.innerHTML = `
      <td>${niceTime}</td>
      <td style="font-weight:600;">${row.manager || row.user || "System"}</td>
      <td><span class="audit-badge ${badgeClass}">${row.action || "CHANGE"}</span></td>
      <td>${row.target || row.person || "â€”"}<br><span style="font-size:9px;color:#94a3b8;">${row.date || ""}</span></td>
      <td>${row.details || row.message || "â€”"}</td>
    `;
    list.appendChild(tr);
  });
}
  function toggleMasterMode() {
    _isMasterMode = !_isMasterMode;
    const btn = document.getElementById("btnMasterMode");
    const title = document.querySelector(".hTitle");
    const contextPill = document.getElementById("managerContextPill");
    // Toggle Views
    if (_isMasterMode) {
        // UI Updates - Clean glass style
        if(btn) { 
          btn.innerText = "â† Exit Editor"; 
          btn.style.backgroundColor = "rgba(255,255,255,0.15)"; 
          btn.style.color = "rgba(255,255,255,0.9)"; 
          btn.style.border = "none";
        }
        if(title) title.innerText = "Master Template";
        if(contextPill) { 
          contextPill.style.display="flex"; 
          contextPill.innerText="âœï¸ Editing"; 
          contextPill.style.backgroundColor="rgba(255,255,255,0.15)"; 
          contextPill.style.color="rgba(255,255,255,0.9)";
          contextPill.style.border="none";
        }
        // HIDE Schedule, SHOW Master
        $("scheduleView").style.display = "none";
        $("metricsView").style.display = "none";
        $("masterView").style.display = "block"; 
        
        $("masterView").innerHTML = "<div style='padding:20px; text-align:center;'><div class='spinner-border text-primary'></div><br>Loading Master Template...</div>";
        
        // Fetch Data using fetch API
        fetch('./?action=base-schedule')
          .then(res => res.json())
          .then(data => {
  if (data.error) {
    $("masterView").innerHTML = `<div style="color:red;padding:20px;">Error loading template: ${data.error}</div>`;
    return;
  }

  // âœ… Initialize draft workflow
  _masterOriginalData = deepClone(data);
  _masterDraftData = deepClone(data);
  _masterRawData = _masterDraftData;
  _masterEditEnabled = false;

  renderMasterView(_masterRawData);
})
          .catch(err => {
            $("masterView").innerHTML = `<div style="color:red;padding:20px;">Error loading template: ${err.message || err}</div>`;
          });
    } else {
        exitMasterMode();
        // Return to default view
        setView('schedule');
    }
}
  function formatDate(iso) {
  return dayKeyPST(iso);
}
  // --- 10. UTILS ---
  function mkDiv(cls) { const d = document.createElement("div"); d.className = cls; return d; }
function groupShifts(data) {
  const m = new Map();
  if (!data) return m;
  data.forEach(d => {
    // Use dateISO (YYYY-MM-DD format) for grouping, NOT dateLabel
    const key = d.dateISO || d.dayKey || d.date || "";
    if (!key) return; // Skip if no valid date key
    if (!m.has(key)) m.set(key, []);
    m.get(key).push(d);
  });
  return m;
}
  
  // âœ… Format role names for display (Backup1 â†’ "Backup 1", Backup2 â†’ "Backup 2")
  function formatRoleDisplay(roleId) {
    if (!roleId) return roleId;
    // Handle "Backup1" â†’ "Backup 1", "Backup2" â†’ "Backup 2"
    return roleId
      .replace(/Backup(\d+)/i, 'Backup $1')
      .replace(/Captain(\d+)/i, 'Captain $1');
  }
  
  function fillSelect(id, list, bl=true, includeCustom=false) { 
    const s=$(id); 
    if(!s)return; 
    s.innerHTML=""; 
    if(bl)s.appendChild(new Option("- Select -","")); 
    // âœ… Special handling for role selects - show formatted display name
    const isRoleSelect = id === "mstRole" || id === "modalRole";
    list.forEach(x => {
      const displayName = isRoleSelect ? formatRoleDisplay(x) : x;
      s.appendChild(new Option(displayName, x));
    }); 
    if(includeCustom) s.appendChild(new Option("âœï¸ Custom...", "__custom__"));
  }
  
  function toggleCustomChannel(selectEl) {
    const wrapper = document.getElementById("customChannelWrapper");
    if (wrapper) {
      wrapper.style.display = selectEl.value === "__custom__" ? "block" : "none";
    }
  }
  
  function getSelectedChannel() {
    const select = document.getElementById("modalTeam");
    if (select && select.value === "__custom__") {
      return document.getElementById("modalCustomChannel")?.value?.trim() || "";
    }
    return select?.value || "";
  }
  
  function toggleTeamSelect(it, cardElement) {
    const id = String(it.assignmentId);
    if (_teamSelected.has(id)) {
      _teamSelected.delete(id);
      if (cardElement) cardElement.classList.remove("selected");
    } else {
      _teamSelected.add(id);
      if (cardElement) cardElement.classList.add("selected");
      _lastSelectedPerson = it.person; 
    }
    updateSelectionBar();
  }
  function updateSelectionBar() {
    const bar = document.getElementById("selectionBar");
    const countSpan = document.getElementById("sbCount");
    const similarBtn = document.getElementById("btnSelectSimilar");
    
    const count = _teamSelected.size;
    countSpan.innerText = count;
    
    if (count > 0) {
      bar.classList.add("visible");
      if (_lastSelectedPerson) {
        similarBtn.style.display = "inline-block";
        similarBtn.innerText = `Select All "${_lastSelectedPerson}"`;
      } else {
        similarBtn.style.display = "none";
      }
    } else {
      bar.classList.remove("visible");
    }
    if(document.getElementById("tpCount")) document.getElementById("tpCount").innerText = count;
  }
  function selectSimilarVisible() {
    if (!_lastSelectedPerson) return;
    _filteredData.forEach(item => {
      if (item.person === _lastSelectedPerson) {
        _teamSelected.add(String(item.assignmentId));
      }
    });
    document.querySelectorAll('.shift').forEach(card => {
      const nameDiv = card.querySelector('.sName');
      if (nameDiv && nameDiv.innerText === _lastSelectedPerson) {
        card.classList.add('selected');
      }
    });
    updateSelectionBar();
    toast(`Selected all shifts for ${_lastSelectedPerson}`);
  }
  async function batchMarkOff() {
  const ids = Array.from(_teamSelected);
  if (ids.length === 0) return toast("No shifts selected.");
  const result = await Swal.fire({
    title: `Mark ${ids.length} shifts as OFF?`,
    text: "This will highlight them red.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, Mark OFF",
    confirmButtonColor: "#ef4444",
    cancelButtonColor: "#cbd5e1"
  });
  if (!result.isConfirmed) return;
  
  toast(`Processing ${ids.length} cancellations...`);
  let successCount = 0;
  let errorCount = 0;
  
  for (const id of ids) {
    const item = _allData.find(x => String(x.assignmentId) === String(id));
    if (!item) {
      errorCount++;
      continue;
    }
    
    // Validate required fields
    if (!item.docId || !item.assignmentId) {
      console.warn("Batch OFF skipped - missing docId/assignmentId:", item);
      errorCount++;
      continue;
    }
    
    // optimistic UI
    _timeOff.add(`${item.person}|${item.dateISO}`);
    item.notes = ((item.notes || "").replace(/\s*\[OFF\]\s*/g, " ").trim() + " [OFF]").trim();
    
    // Use fetch instead of google.script.run
    try {
      await fetch('./?action=assignment/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          docId: item.docId,
          assignmentId: item.assignmentId,
          markOff: true
        })
      });
      successCount++;
    } catch (e) {
      console.error("Batch OFF failed:", e, item);
      errorCount++;
    }
  }
  
  logAuditEntry({
    action: "BATCH OFF",
    manager: window._myName || window._myEmail,
    target: `${successCount} shifts`,
    date: "Multiple",
    details: `Marked ${successCount} shifts as OFF in batch operation`
  });
  
  clearTeamSelection();
  renderView();
  
  if (errorCount > 0) {
    toast(`Completed: ${successCount} success, ${errorCount} errors`, "warning");
  } else {
    toast(`Success: ${successCount} shifts marked OFF.`);
  }
}
  function clearTeamSelection() {
    _teamSelected.clear();
    _lastSelectedPerson = null;
    document.querySelectorAll('.shift.selected').forEach(el => el.classList.remove('selected'));
    updateSelectionBar();
  }
  
  async function applyBatch() {
    const newPerson = document.getElementById("tpPerson").value;
    const ids = Array.from(_teamSelected);
    if (!newPerson) return toast("Please select a person first.");
    if (ids.length === 0) return toast("No shifts selected.");
    const result = await Swal.fire({
        title: `Assign ${ids.length} shifts to ${newPerson}?`,
        text: "Choose how to notify the team.",
        icon: 'question',
        showCancelButton: true,
        showDenyButton: true,
        confirmButtonText: 'âš¡ Send Bot Now',
        denyButtonText: 'â³ Add to Pending',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#1e293b', 
        denyButtonColor: '#f59e0b',    
    });
    if (!result.isConfirmed && !result.isDenied) return; 
    const notifyMode = result.isConfirmed ? 'send' : 'defer';
    toast("Processing batch...");
    // Loop through every selected ID and update locally + server-side
    for (const id of ids) {
        const item = _allData.find(x => String(x.assignmentId) === String(id));
        if (item) {
            // Validate required fields
            if (!item.docId || !item.assignmentId) {
              console.warn("Batch skipped - missing docId/assignmentId:", item);
              continue;
            }
            
            const oldPerson = item.person;
            
            // 1. Update the local data immediately
            item.person = newPerson;
            
            // 2. For deferred notifications, store undo data separately
            // (DON'T add to _notifQueue - backend already tracks these)
            if (notifyMode === 'defer') {
                const undoKey = `undo_${item.docId}_${item.assignmentId}`;
                localStorage.setItem(undoKey, JSON.stringify({
                    docId: item.docId,
                    assignmentId: item.assignmentId,
                    originalPerson: oldPerson,
                    originalNotes: item.notes
                }));
            }
            
            // 3. Send the save request to the server using fetch
            fetch('./?action=assignment/replace', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                docId: item.docId,
                assignmentId: item.assignmentId,
                newPerson: newPerson,
                notes: item.notes || "Batch Update",
                notifyMode: notifyMode
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.ok) console.log(`Saved shift ${id}`);
            })
            .catch(err => console.error(`Failed to save shift ${id}:`, err));
        }
    }
    // Handle notifications
    if (notifyMode === 'defer') {
        playNotificationSound(); 
        // Refresh from backend (don't use local queue)
        setTimeout(() => {
          loadPendingNotifications();
          updateNotifBadge();
        }, 500); // Small delay to let backend process
        toast(`${ids.length} shifts added to Pending Queue`);
    } else {
        playSendSound(); 
        toast(`Success! ${ids.length} shifts updated.`);
    }
if (!window._isManager && window._myName) {
  clearScheduleCache();
}
    clearTeamSelection(); 
    renderView(); // Refresh the UI to show new names       
  }
  
  // Load time off count for badge
  function loadTimeOffCount() {
    fetch('./?action=timeoff/count')
      .then(r => r.json())
      .then(data => {
        // 1. Badge on Main Header Button
        c// 1. Badge on Notifications (btnNotif)
const notifCountEl = document.getElementById("notifCount");
if (notifCountEl) {
  if (data.count > 0) {
    notifCountEl.classList.remove("hidden");
  } else {
    notifCountEl.classList.add("hidden");
  }
}


        
        // 2. Badge on Modal Button
        const btnQueue = document.getElementById("btnReviewQueue");
        if(btnQueue) {
          if(data.count > 0) {
            btnQueue.innerHTML = `Queue <span style="background:white; color:#c2410c; padding:2px 6px; border-radius:10px; font-size:11px; font-weight:800; margin-left:4px;">${data.count}</span>`;
          } else {
            btnQueue.innerHTML = `Queue`; 
          }
        }
      })
      .catch(e => console.log("Silent error checking queue"));
  }
  
  // Admin & Context
  function promptMasterSelection(list) { $("masterContextOverlay").style.display="flex"; const s=$("masterManagerDropdown"); s.innerHTML=""; list.forEach(m=>s.appendChild(new Option(m.name,m.email))); }
  function confirmManagerSelection() { _selectedManagerEmail=$("masterManagerDropdown").value; $("masterContextOverlay").style.display="none"; load(true, _selectedManagerEmail); }
  // ============================================
  // [SECTION 16] ADMIN FUNCTIONS
  // ============================================
  function openAdminModal() { 
    // Show modal immediately
    $("adminOverlay").style.display="flex"; 
    // Load rules asynchronously (don't block UI)
    requestAnimationFrame(() => {
      loadRules();
      // Update time off count badge
      loadTimeOffCount();
    });
  }
  function closeAdminModal() { $("adminOverlay").style.display="none"; }
  
  // Cache for rules to avoid unnecessary fetches
  let _rulesLoaded = false;
  let _lastRulesLoad = 0;
  const RULES_CACHE_MS = 30000; // 30 second cache
  
  function loadRules(forceRefresh = false) {
    const now = Date.now();
    const list = $("ruleList");
    
    // Skip if recently loaded and not forcing refresh
    if (!forceRefresh && _rulesLoaded && (now - _lastRulesLoad) < RULES_CACHE_MS) {
      return;
    }
    
    list.innerHTML = '<div style="padding:10px; color:#94a3b8; text-align:center;"><span style="display:inline-block; animation:spin 1s linear infinite;">â³</span> Loading...</div>';
  // âœ… Use fetch instead of google.script.run
  fetch('./?action=staffing/rules')
    .then(res => res.json())
    .then(rules => {
      list.innerHTML = "";
      if (!rules || rules.length === 0) {
        list.innerHTML = '<div style="padding:10px; color:#94a3b8; text-align:center;">No rules set yet.</div>';
        return;
      }
      rules.forEach(r => {
        // Format hours for display
        const formatHour = (h) => {
          if (h === 0 || h === 24) return '12am';
          if (h === 12) return '12pm';
          return h > 12 ? `${h-12}pm` : `${h}am`;
        };
        
        // Build time display
        let timeDisplay = 'All Hours';
        if (r.timeBlock && r.timeBlock !== 'all') {
          if (r.timeBlock === 'morning') timeDisplay = '6am-12pm';
          else if (r.timeBlock === 'afternoon') timeDisplay = '12pm-6pm';
          else if (r.timeBlock === 'evening') timeDisplay = '6pm-10pm';
          else if (r.timeBlock === 'custom' && r.startHour !== undefined) {
            timeDisplay = `${formatHour(r.startHour)}-${formatHour(r.endHour)}`;
          }
        } else if (r.startHour !== undefined && r.endHour !== undefined && (r.startHour !== 0 || r.endHour !== 24)) {
          timeDisplay = `${formatHour(r.startHour)}-${formatHour(r.endHour)}`;
        }
        
        // Format day display
        let dayDisplay = r.day;
        if (r.day === 'All') dayDisplay = 'Every Day';
        else if (r.day === 'Weekday') dayDisplay = 'Mon-Fri';
        else if (r.day === 'Weekend') dayDisplay = 'Sat-Sun';
        
        const row = document.createElement("div");
        row.className = "rule-item";
        row.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--card-bg, #fff); border:1px solid var(--border-color, #e2e8f0); border-radius:10px;";
        row.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:4px;">
            <div style="font-weight:700; color:var(--text-primary, #1e3a8a); font-size:14px;">${r.team}</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <span style="font-size:10px; background:#dbeafe; padding:2px 8px; border-radius:6px; color:#8f5f5a; font-weight:600;">${dayDisplay}</span>
              <span style="font-size:10px; background:#f0fdf4; padding:2px 8px; border-radius:6px; color:#15803d; font-weight:600;">â° ${timeDisplay}</span>
            </div>
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <div style="font-weight:800; font-size:14px; color:var(--text-primary, #1e293b);">Min: ${r.min}</div>
            <button onclick="deleteRule('${r.id}')" style="color:#ef4444; background:none; border:none; cursor:pointer; font-size:16px;" title="Delete rule">ðŸ—‘ï¸</button>
          </div>
        `;
        list.appendChild(row);
      });
      
      // Update cache
      _rulesLoaded = true;
      _lastRulesLoad = Date.now();
    })
    .catch(err => {
      console.error(err);
      list.innerHTML = '<div style="color:red; padding:10px;">Error loading rules</div>';
    });
}
async function addRule() {
  const team = $("ruleTeam").value;
  const day = $("ruleDay").value;
  const min = $("ruleMin").value;
  const timeBlock = $("ruleTimeBlock")?.value || "all";
  
  if (!team || !min) return toast("Please select Team and Minimum count", "error");
  
  // Calculate hours based on time block
  let startHour = 0, endHour = 24;
  if (timeBlock === "morning") { startHour = 6; endHour = 12; }
  else if (timeBlock === "afternoon") { startHour = 12; endHour = 18; }
  else if (timeBlock === "evening") { startHour = 18; endHour = 22; }
  else if (timeBlock === "custom") {
    startHour = parseInt($("ruleStartHour")?.value) || 0;
    endHour = parseInt($("ruleEndHour")?.value) || 24;
  }
  
  $("ruleList").innerHTML = "Saving...";
  try {
    await fetch('./?action=staffing/rules', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ team, day, min, startHour, endHour, timeBlock })
    });
    
    toast("Rule Saved", "success");
    $("ruleMin").value = "";
    loadRules(true); // Force refresh after add
  } catch (err) {
    console.error(err);
    toast("Error saving rule", "error");
  }
}

async function addQuickRule(team, min, timeBlock) {
  let startHour = 0, endHour = 24;
  if (timeBlock === "morning") { startHour = 6; endHour = 12; }
  else if (timeBlock === "afternoon") { startHour = 12; endHour = 18; }
  
  try {
    await fetch('./?action=staffing/rules', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ team, day: "Weekday", min, startHour, endHour, timeBlock })
    });
    toast(`Added: ${team} min ${min}`, "success");
    loadRules();
  } catch (err) {
    toast("Error adding rule", "error");
  }
}

// Toggle custom hour inputs
document.addEventListener('DOMContentLoaded', () => {
  const timeBlockSelect = $("ruleTimeBlock");
  if (timeBlockSelect) {
    timeBlockSelect.addEventListener('change', (e) => {
      const isCustom = e.target.value === "custom";
      if ($("ruleStartHour")) $("ruleStartHour").style.display = isCustom ? "block" : "none";
      if ($("ruleEndHour")) $("ruleEndHour").style.display = isCustom ? "block" : "none";
    });
  }
});
async function deleteRule(id) {
  if (!confirm("Delete this rule?")) return;
  try {
    await fetch('./?action=staffing/rules/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ idx: id })
    });
    toast("Rule Deleted", "success");
    loadRules(true); // Force refresh after delete
  } catch (err) {
    console.error(err);
    toast("Error deleting rule", "error");
  }
}
// Track active toasts to prevent duplicates
const _activeToasts = new Map();

function toast(msg, type = "info", options = {}) {
  const host = document.getElementById("toastHost");
  if (!host) {
    console.log("Toast:", msg);
    return;
  }
  
  // Prevent duplicate toasts with same message
  const toastKey = msg.replace(/[^a-zA-Z]/g, '').toLowerCase();
  if (_activeToasts.has(toastKey)) {
    return; // Don't show duplicate
  }
  
  // Limit max toasts on screen
  const existingToasts = host.querySelectorAll('.toast');
  if (existingToasts.length >= 3) {
    existingToasts[0].remove(); // Remove oldest
  }
  
  const t = document.createElement("div");
  t.className = "toast";
  t.dataset.toastKey = toastKey;
  
  // Color based on type
  if (type === "success") t.style.background = "#16a34a";
  else if (type === "error") t.style.background = "#dc2626";
  else if (type === "warning") t.style.background = "#d97706";
  
  t.innerHTML = `
    <span>${msg}</span>
    <button onclick="this.parentElement.remove()" style="background: rgba(255,255,255,0.2); border:none; color:#fff; padding:4px 8px; border-radius:4px; cursor:pointer;">âœ•</button>
  `;
  
  // Track this toast
  _activeToasts.set(toastKey, true);
  
  host.appendChild(t);
  
  const duration = options.duration || 3000;
  setTimeout(() => {
    t.remove();
    _activeToasts.delete(toastKey);
  }, duration);
}
// Make it globally available
window.toast = toast;

  // ============================================
  // [SECTION 17] FILTERS
  // ============================================
  function applyLocalFilters() { _filteredData = _allData.filter(x => (!_activeTeam || x.team===_activeTeam) && (!_selectedPeople.size || _selectedPeople.has(x.person))); window._allData = _allData; window._filteredData = _filteredData; renderView(); }
  function renderTeamChips() { const c=$("teamChips"); if(c) { c.innerHTML=""; _teams.forEach(t=>{ const d=mkDiv("chip"); d.innerText=t; d.onclick=()=>filterTeam(t); c.appendChild(d); }); } }
  function filterTeam(t) { _activeTeam=t; applyLocalFilters(); }
  function showActiveFilterIndicator(channelName) {
  // Remove existing indicator
  const existing = document.getElementById('activeFilterIndicator');
  if (existing) existing.remove();
  
  if (! channelName) return;
  
  const indicator = document.createElement('div');
  indicator.id = 'activeFilterIndicator';
  indicator.style.cssText = `
    position: fixed;
    top: 74px;
    left: 50%;
    transform:  translateX(-50%);
    background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size:  13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
    z-index: 500;
    animation: slideDown 0.3s ease;
  `;
  
  indicator.innerHTML = `
    <span>ðŸ“º Viewing: ${channelName}</span>
    <button onclick="resetAllFilters()" style="
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius:  50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    ">âœ•</button>
  `;
  
  document.body.appendChild(indicator);
  
  // Also add class to calendar grid for CSS
  const calGrid = document.getElementById('calView');
  if (calGrid) calGrid.classList.add('channel-filtered');
}
  function initFilters() { fillSelect("teamDropdown", _teams); }
  function renderQuickRail() { 
    const list = $("qrList");
    list.innerHTML = ""; 
    const q = ($("qrSearch").value || "").toLowerCase();
    _people.filter(p => !q || p.toLowerCase().includes(q)).forEach(p => { 
        const d = mkDiv("qrItem"); 
        d.innerText = p; 
        d.draggable = true; 
        d.ondragstart = (e) => { 
           _dragPerson = p; 
           e.dataTransfer.effectAllowed = "copy";
           e.dataTransfer.setData("text/plain", p); // Required for Firefox
           d.style.opacity = "0.5";
        };
        d.ondragend = (e) => {
           d.style.opacity = "1";
           // Clear drag person after a short delay (allows drop to complete first)
           setTimeout(() => { _dragPerson = null; }, 100);
        };
        d.onclick = () => {
           _selectedPeople.clear();
           _selectedPeople.add(p);
           applyLocalFilters();
        };
        list.appendChild(d); 
    }); 
  }
  
  // Master Template Logic
  // ============================================
  // [SECTION 13] MASTER SCHEDULE
  // ============================================
  function renderMasterView(data) {
  if(!data || data.error) { 
    $("masterView").innerHTML = "<div style='color:red;padding:20px;'>Failed to load master template</div>"; 
    return; 
  }

  const list = document.getElementById("masterView");
  list.innerHTML = "";              // âœ… clear first
  ensureMasterControls(); 
    
    // Inject styles
    let style = document.getElementById("mstStyles");
if (!style) {
  style = document.createElement("style");
  style.id = "mstStyles";
  style.innerHTML = `
    .mst-person-row:hover { background-color: #f8fafc !important; transition: background 0.2s; }
    .mst-shift-chip:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .mst-day-cell:hover { background-color: rgba(0,0,0,0.02); }
    .add-btn { opacity: 0; transition: opacity 0.2s; }
    .mst-day-cell:hover .add-btn { opacity: 1; }
  `;
  list.appendChild(style);
}

    // 1.  Pivot Data
    const roster = {};
    const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    
    // First, initialize roster with ALL people from _people list
    // This ensures new agents appear even without shifts
    if (Array.isArray(_people)) {
      _people.forEach(personName => {
        if (personName && !roster[personName]) {
          roster[personName] = {};
        }
      });
    }
    
    // Then add shifts from the data
    days.forEach(day => {
        const dayItems = data[day] || [];
        dayItems.forEach(item => {
            const pName = item.person;
            if (!roster[pName]) roster[pName] = {};
            if (!roster[pName][day]) roster[pName][day] = [];
            roster[pName][day].push(item);
        });
    });
    list.style.display = "block"; 
    list.style.overflowX = "auto";
    list.style.fontFamily = "sans-serif"; 
    // 2. The Header
    const headerRow = mkDiv("mst-header-row");
    headerRow.style.display = "grid";
    headerRow.style.gridTemplateColumns = "180px repeat(7, 1fr)"; 
    headerRow.style.backgroundColor = "#1e293b"; 
    headerRow.style.color = "#ffffff";
    headerRow.style.fontWeight = "bold";
    headerRow.style.borderBottom = "2px solid #ddd";
    headerRow.style.position = "sticky";
    headerRow.style.top = "52px";   // adjust if your bar is taller/shorter
    headerRow.style.zIndex = "10";
    let headerHtml = `<div style="padding:12px; border-right:1px solid #4a6278;">Employee</div>`;
    days.forEach((d, i) => { 
        const borderStyle = i < 6 ? "border-right:1px solid #4a6278;" : ""; 
        headerHtml += `<div style="padding:12px; text-align:center; ${borderStyle}">${d}</div>`; 
    });
    headerRow.innerHTML = headerHtml;
    list.appendChild(headerRow);
    // 3. The Body
    const sortedPersons = Object.keys(roster).sort();
    
    // âœ… Helper function to calculate weekly hours for a person
    function calculateWeeklyHours(personRoster) {
      let totalHours = 0;
      const shouldSkipTeam = (teamName) => {
        const team = String(teamName || "").toLowerCase();
        return team.includes("lunch") || team.includes("break") || team.includes("1:1");
      };

      days.forEach(day => {
        const shifts = personRoster[day] || [];
        const intervals = [];

        shifts.forEach(shift => {
          if (!shift.start || !shift.end) return;
          if (shouldSkipTeam(shift.team)) return;

          const startH = parseTimeDecimal(shift.start);
          const endH = parseTimeDecimal(shift.end);
          if (!isNaN(startH) && !isNaN(endH) && endH > startH) {
            intervals.push([startH, endH]);
          }
        });

        if (!intervals.length) return;

        intervals.sort((a, b) => a[0] - b[0]);
        let [currentStart, currentEnd] = intervals[0];
        let dayHours = 0;

        for (let i = 1; i < intervals.length; i++) {
          const [start, end] = intervals[i];
          if (start <= currentEnd) {
            currentEnd = Math.max(currentEnd, end);
          } else {
            dayHours += (currentEnd - currentStart);
            currentStart = start;
            currentEnd = end;
          }
        }

        dayHours += (currentEnd - currentStart);
        totalHours += dayHours;
      });

      return totalHours;
    }
    
    sortedPersons.forEach((person, index) => {
        const row = mkDiv("mst-person-row");
        const bg = index % 2 === 0 ? "#ffffff" : "#f8f9fa"; 
        row.style.backgroundColor = bg;
        row.style.display = "grid";
        row.style.gridTemplateColumns = "180px repeat(7, 1fr)";
        row.style.borderBottom = "1px solid #e0e0e0";
        row.style.alignItems = "stretch"; 
        
        // âœ… Calculate weekly hours for this person
        const weeklyHours = calculateWeeklyHours(roster[person]);
        const hoursDisplay = weeklyHours > 0 ? `<span style="font-size:10px; color:#64748b; font-weight:500; display:block; margin-top:2px;">${weeklyHours.toFixed(1)}h/week</span>` : '';
        
        // Name Column with weekly hours
        let html = `
            <div class="mst-person-info" style="
                padding:12px; font-weight:600; color:#333; 
                border-right:2px solid #e0e0e0; display:flex; flex-direction:column; justify-content:center;">
                <span>${person}</span>
                ${hoursDisplay}
            </div>`;
        // Day Columns
        days.forEach((day, i) => {
            const shifts = roster[person][day] || [];
            // âœ… Sort shifts by start time
            shifts.sort((a, b) => {
              const timeA = parseTimeDecimal(a.start);
              const timeB = parseTimeDecimal(b.start);
              return timeA - timeB;
            });
            const borderStyle = i < 6 ?  "border-right:1px solid #eee;" : "";
            html += `<div class="mst-day-cell" 
                        onclick="handleCellClick('${person}', '${day}')"
                        style="padding:8px; display:flex; flex-direction:column; gap:4px; align-items:center; justify-content:flex-start; cursor:pointer; position:relative; ${borderStyle}">`;
            
            if (shifts.length === 0) {
                html += `<span class="add-btn" style="color:#ccc; font-size:20px; font-weight:bold;">+</span>`;
            } else {
                shifts.forEach(shift => {
                    const rawStart = shift.start; 
                    const rawEnd = shift.end;
                    const displayStart = toAmPm(rawStart);
                    const displayEnd = toAmPm(rawEnd);
                    
                    // âœ… Get channel config for color coding
                    const channelName = shift.team || "Other";
                    const config = getChannelConfig(channelName) || { abbrev:"â€”", color:"#f8fafc", border:"#e2e8f0", text:"#475569" };
                    const abbrev = config.abbrev || "â€”";
                    
                    // âœ… Format role display (Backup1 â†’ "B1", Captain â†’ "Capt")
                    const rawRole = shift.role || "";
                    let roleDisplay = "";
                    if (rawRole && rawRole !== "Agent") {
                      // Shorten role names for chip display
                      if (rawRole.match(/Backup\s*1/i)) roleDisplay = "B1";
                      else if (rawRole.match(/Backup\s*2/i)) roleDisplay = "B2";
                      else if (rawRole.match(/Backup/i)) roleDisplay = "BU";
                      else if (rawRole.match(/Captain/i)) roleDisplay = "Capt";
                      else roleDisplay = rawRole.substring(0, 4);
                    }
                    
                    // âœ… Use openMasterModal for master mode editing
                    html += `<div class="mst-shift-chip" 
                                onclick="event.stopPropagation(); openMasterModal('${person}', '${day}', '${rawStart}', '${rawEnd}', '${shift.team || ''}', '${rawRole}')"
                                style="
                                font-size:10px; padding:4px 8px; 
                                background:${config.color}; 
                                color:${config.text}; 
                                border:  1px solid ${config.border};
                                border-radius: 8px; 
                                font-weight:600;
                                white-space:nowrap; 
                                cursor:pointer;
                                transition:  all 0.2s;
                                display:flex;
                                flex-direction:column;
                                align-items:center;
                                gap:2px;
                                min-width:70px;
                                box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                <span style="font-weight:700;">${abbrev}${roleDisplay ? ' <span style="font-size:8px; opacity:0.7;">(' + roleDisplay + ')</span>' : ''}</span>
                                <span style="font-size:9px; opacity:0.8;">${displayStart}-${displayEnd}</span>
                             </div>`;
                });
            }
            html += `</div>`;
        });
        row.innerHTML = html;
        list.appendChild(row);
    });
}
// Triggered when clicking an existing blue chip
function handleShiftEdit(person, day, start, end, team, docId, assignmentId, role) {
  openMasterModal(person, day, start, end, team, role);
}
function handleCellClick(person, day) {
  openMasterModal(person, day);
}
  function toggleMasterPerson(key, dayName) {
    if (_masterSelected.has(key)) {
        _masterSelected.delete(key);
    } else {
        _masterSelected.add(key);
    }
    renderMasterView(_masterRawData);
    updateMasterSelectionBar(); 
  }
  function openMasterModal(p,d,s,e,t,r) { 
    // âœ… Mark as editing to prevent auto-refresh disruption
    setEditingMode(true);
    
    // âœ… Check if editing is enabled in master mode
    if (_isMasterMode && !_masterEditEnabled) {
      toast("Click Edit to start making draft changes.", "info");
      setEditingMode(false);
      return;
    }
    
    const isAdding = !s || !e;
    const docEl = document.getElementById("modalDocId");
    const asgEl = document.getElementById("modalAssignmentId");
    if (docEl) docEl.value = "";
    if (asgEl) asgEl.value = "";
    
    // Populate the inputs
    document.getElementById("modalEmployee").value = p;
    document.getElementById("modalDay").value = d;
    
    const startInput = document.getElementById("modalStart");
    const endInput = document.getElementById("modalEnd");
    
    if (isAdding) {
      startInput.value = "08:00";
      endInput.value = "17:00";
      document.getElementById("modalOrigStart").value = "NEW";
      document.getElementById("modalOrigEnd").value = "NEW";
      document.getElementById("modalOrigTeam").value = "NEW";
      document.getElementById("modalOrigRole").value = "NEW";
    } else {
      startInput.value = formatTimeHHMM(s) || "";
      endInput.value = formatTimeHHMM(e) || "";
      document.getElementById("modalOrigStart").value = s || "";
      document.getElementById("modalOrigEnd").value = e || "";
      document.getElementById("modalOrigTeam").value = t || "";
      document.getElementById("modalOrigRole").value = r || "";
    }
    
    // Populate Channel + Role dropdowns
    fillSelect("modalTeam", _teams, isAdding, true);
    fillSelect("modalRole", _roles, true);
    
    const teamSelect = document.getElementById("modalTeam");
    const customWrapper = document.getElementById("customChannelWrapper");
    const customInput = document.getElementById("modalCustomChannel");
    
    if (!isAdding && t) {
      const teamInList = _teams.includes(t);
      if (teamInList) {
        teamSelect.value = t;
        if (customWrapper) customWrapper.style.display = "none";
        if (customInput) customInput.value = "";
      } else {
        teamSelect.value = "__custom__";
        if (customWrapper) customWrapper.style.display = "block";
        if (customInput) customInput.value = t;
      }
    } else {
      if (teamSelect) teamSelect.value = "";
      if (customWrapper) customWrapper.style.display = "none";
      if (customInput) customInput.value = "";
    }
    
    const roleSelect = document.getElementById("modalRole");
    if (roleSelect) {
      if (r && !_roles.includes(r)) {
        roleSelect.appendChild(new Option(formatRoleDisplay(r), r));
      }
      roleSelect.value = r || "";
    }
    
    const deleteBtn = document.getElementById("modalDeleteBtn");
    if (deleteBtn) {
      deleteBtn.style.visibility = isAdding ? "hidden" : "visible";
      deleteBtn.style.pointerEvents = isAdding ? "none" : "auto";
    }
    
    // Update modal title
    const modalTitle = document.querySelector("#editShiftModal h3");
    if (modalTitle) modalTitle.innerText = isAdding ? "Add New Shift" : "Edit Shift";
    
    // Show the modal
    document.getElementById("editShiftModal").style.display = "flex";
  }
  
  function updateMasterSelectionBar() {
    const count = _masterSelected.size;
    const bar = document.getElementById("selectionBar");
    const countSpan = document.getElementById("sbCount");
    
    if (count > 0) {
        bar.classList.add("visible");
        countSpan.innerText = count;
    } else {
        bar.classList.remove("visible");
    }
  }
// ============================================
// NOTIFICATION SYSTEM
// ============================================
let pendingNotifications = [];
// Toggle notification panel open/closed
// ============================================
// [SECTION 12] NOTIFICATIONS
// ============================================
function toggleNotifPanel(forceClose) {
  const panel = $("notifPanel");
  if (!panel) {
    console.error("notifPanel element not found!");
    return;
  }
  
  // If forceClose is true, just close it
  if (forceClose === true) {
  panel.style.display = "none";
  panel.classList.remove("open");
  return;
}
  
  // Toggle visibility
  const isCurrentlyOpen = panel.style.display === "block" || panel.classList.contains("open");
  
  if (isCurrentlyOpen) {
    panel.style.display = "none";
    panel.classList.remove("open");
  } else {
    panel.style.display = "block";
    panel.classList.add("open");
    loadPendingNotifications();
  }
}
// Load pending notifications from backend
async function loadPendingNotifications() {
  const listEl = $("notifList");
  
  if (!listEl) return;
  
  listEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">Loading... </div>';
  
  try {
    // Fetch shift change notifications
    const shiftRes = await fetch("./?action=notifications/pending");
    const shiftData = await shiftRes.json();
    
    if (!shiftData.ok) throw new Error(shiftData.error || "Failed to load shift notifications");
    
    // Mark shift notifications with their type
    const shiftNotifications = (shiftData.notifications || []).map(n => ({
      ...n,
      notificationType: 'shift_change'
    }));
    
    // If manager, also fetch manager notifications (time-off requests)
    let managerNotifications = [];
    if (window._isManager) {
      try {
        const mgrRes = await fetch("./?action=manager/notifications", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ managerName: window._myName })
        });
        const mgrData = await mgrRes.json();
        
        if (mgrData.ok) {
          // Include time-off requests that haven't been resolved yet
          managerNotifications = (mgrData.notifications || [])
            .filter(n => !n.resolvedAt && n.status !== "approved" && n.status !== "denied")
            .map(n => ({
              ...n,
              notificationType: 'timeoff_request'
            }));
        }
      } catch (mgrErr) {
        console.warn("Failed to fetch manager notifications:", mgrErr);
      }
    }
    
    // Combine both types of notifications
    pendingNotifications = [...managerNotifications, ...shiftNotifications];
    
    renderNotifications();
    updateNotifBadge();
    
  } catch (err) {
    console.error("Load notifications error:", err);
    listEl.innerHTML = `<div style="text-align: center; color:#ef4444; padding:20px;">Error:  ${err.message}</div>`;
  }
}
// Render notifications in the panel
function renderNotifications() {
  const listEl = $("notifList");
  
  if (!listEl) return;
  
  // Only show backend notifications (we no longer use local queue for deferred)
  const allNotifications = pendingNotifications.map((n, idx) => {
    // Check if we have undo data stored for this notification
    const undoKey = `undo_${n.docId}_${n.assignmentId}`;
    let undoData = null;
    try {
      const stored = localStorage.getItem(undoKey);
      if (stored) undoData = JSON.parse(stored);
    } catch (e) {}
    
    return { ...n, source: 'backend', idx, undoData };
  });
  
  if (allNotifications.length === 0) {
    listEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">No pending notifications ðŸŽ‰</div>';
    return;
  }
  
  let html = "";
  
  allNotifications.forEach((n, displayIdx) => {
    const originalIdx = n.idx;
    
    // Check if this is a time-off request notification
    if (n.notificationType === 'timeoff_request') {
      // Render time-off request notification with approve/deny buttons
      const agentName = n.agentName || 'Unknown';
      const requestDate = n.date || '';
      const timeOffType = n.timeOffType || 'PTO';
      const reason = n.reason || '';
      const message = n.message || '';
      const requestId = n.requestId || '';
      const notifId = n.id || '';
      const createdAt = n.createdAt ? new Date(n.createdAt).toLocaleString() : '';
      
      html += `
        <div class="notif-item timeoff-request" data-idx="${displayIdx}" style="
          background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
          border: 1px solid #fcd34d;
          border-radius: 10px;
          padding: 12px;
          margin-bottom: 10px;
        ">
          <div style="display: flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
            <div>
              <div style="font-weight:700; color:#92400e; font-size: 14px;">ðŸ–ï¸ Time Off Request</div>
              <div style="font-size:12px; color:#b45309; font-weight:600; margin-top:2px;">${escapeHtml(agentName)}</div>
            </div>
            <span style="background:#fbbf24; color:#78350f; font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px;">
              ${escapeHtml(timeOffType)}
            </span>
          </div>
          
          <div style="font-size: 12px; color:#78350f; margin-bottom:8px;">
            ðŸ“… ${escapeHtml(requestDate)}
          </div>
          
          ${message ? `<div style="font-size:11px; color:#92400e; margin-bottom:8px; padding:8px; background:rgba(0,0,0,0.05); border-radius:6px;">${escapeHtml(message)}</div>` : ''}
          
          ${reason ? `<div style="font-size:11px; color:#78350f; font-style:italic; margin-bottom:10px;">Reason: "${escapeHtml(reason)}"</div>` : ''}
          
          ${createdAt ? `<div style="font-size:10px; color:#a16207; margin-bottom:10px;">Submitted: ${createdAt}</div>` : ''}
          
          <div style="display: flex; gap:6px; flex-wrap:wrap;">
            <button onclick="approveTimeOff('${escapeHtml(requestId)}', '${escapeHtml(notifId)}')" style="
              flex:1; min-width:80px; background:#16a34a; color:#fff; border: none; padding:8px 10px; 
              border-radius:6px; font-size: 11px; font-weight:600; cursor:pointer;
            ">âœ“ Approve</button>
            
            <button onclick="denyTimeOff('${escapeHtml(requestId)}', '${escapeHtml(notifId)}')" style="
              flex:1; min-width:80px; background:#dc2626; color:#fff; border:none; padding:8px 10px; 
              border-radius:6px; font-size:11px; font-weight:600; cursor:pointer;
            ">âœ• Deny</button>
          </div>
        </div>
      `;
    } else {
      // Render shift change notification (original logic)
      const hasUndo = n.undoData && n.undoData.originalPerson;
      const hasError = n.notifyError || n.error;

      // Determine what info to show
      const personName = n.person || 'Unknown';
      const dateStr = n.date || n.dateLabel || '';
      const teamStr = n.team || '';
      const startStr = n.start || n.startLabel || '';
      const endStr = n.end || n.endLabel || '';
      const notesStr = n.notes || n.message || '';
      
      // Get channel styling
      const channelDisplay = getChannelDisplayName(teamStr);
      const channelConfig = getChannelConfig(teamStr);

      html += `
        <div class="notif-item" data-idx="${displayIdx}" style="
          background: ${hasError ? '#fef2f2' : '#f8fafc'};
          border: 1px solid ${hasError ? '#fca5a5' : '#e2e8f0'};
          border-radius: 10px;
          padding: 12px;
          margin-bottom:  10px;
        ">
          <div style="display: flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
            <div>
              <div style="font-weight:700; color:#0f172a; font-size: 14px;">${escapeHtml(personName)}</div>
              <div style="font-size:11px; color:#64748b;">
                ${escapeHtml(dateStr)}
                ${teamStr ? `<span style="background: ${channelConfig.color}; color: ${channelConfig.text}; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600; margin-left:4px;">${escapeHtml(channelDisplay)}</span>` : ''}
              </div>
            </div>
            <span style="background:${hasError ? '#fee2e2' : '#dbeafe'}; color: ${hasError ? '#dc2626' : '#1e40af'}; font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px;">
              ${hasError ? 'FAILED' : 'PENDING'}
            </span>
          </div>
          
          ${startStr ?  `
          <div style="font-size: 12px; color:#334155; margin-bottom:8px;">
            ðŸ• ${escapeHtml(startStr)}${endStr ? ' â€“ ' + escapeHtml(endStr) : ''}
          </div>
          ` : ''}
          
          ${notesStr ? `<div style="font-size:11px; color:#64748b; font-style:italic; margin-bottom:10px; padding:8px; background:rgba(0,0,0,0.03); border-radius:6px;">"${escapeHtml(notesStr)}"</div>` : ''}
          
          ${hasError ? `
          <div style="font-size:11px; color:#dc2626; background:#fee2e2; padding:8px; border-radius:6px; margin-bottom:10px; font-weight:500;">
            âš ï¸ Error: ${escapeHtml(hasError)}
          </div>
          ` : ''}
          
          <div style="display: flex; gap:6px; flex-wrap:wrap;">
            ${hasError ? `
            <button onclick="sendSingleNotification(${originalIdx})" style="
              flex:1; min-width:80px; background:#f59e0b; color:#fff; border: none; padding:8px 10px; 
              border-radius:6px; font-size: 11px; font-weight:600; cursor:pointer;
            ">ðŸ”„ Retry</button>
            ` : `
            <button onclick="sendSingleNotification(${originalIdx})" style="
              flex:1; min-width:80px; background:#b37e78; color:#fff; border: none; padding:8px 10px; 
              border-radius:6px; font-size: 11px; font-weight:600; cursor:pointer;
            ">ðŸ“¤ Send</button>
            `}
            
            ${hasUndo ? `
            <button onclick="undoBackendNotification(${originalIdx})" style="
              flex:1; min-width:70px; background:#f59e0b; color:#fff; border:none; padding:8px 10px; 
              border-radius:6px; font-size:11px; font-weight:600; cursor:pointer;
            ">â†©ï¸ Undo</button>
            ` : ''}
            
            <button onclick="dismissNotification(${originalIdx})" style="
              flex:1; min-width:60px; background:#fff; color:#64748b; border:1px solid #e2e8f0; padding:8px 10px; 
              border-radius:6px; font-size:11px; font-weight:600; cursor:pointer;
            ">âœ•</button>
          </div>
        </div>
      `;
    }
  });
  
  listEl.innerHTML = html;
}
// Update the red badge count
function updateNotifBadge() {
  const badge = $("notifCount");
  if (!badge) return;
  
  // Count only backend pending notifications
  const totalCount = pendingNotifications?.length || 0;
  
  if (totalCount > 0) {
    badge.textContent = totalCount > 99 ? "99+" : totalCount;
    badge.classList.remove("hidden");
  } else {
    badge.textContent = "0";
    badge.classList.add("hidden");
  }
}

// Approve time off request
async function approveTimeOff(requestId, notifId) {
  if (!requestId) {
    toast("âŒ Error: Missing request ID", "error");
    return;
  }
  
  try {
    const res = await fetch("./?action=timeoff/approve", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        requestId: requestId,
        notifId: notifId,
        managerName: window._myName || "Manager"
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast("âœ… Time off request approved!", "success");
      // Remove from pendingNotifications and re-render
      pendingNotifications = pendingNotifications.filter(n => 
        !(n.notificationType === 'timeoff_request' && n.id === notifId)
      );
      renderNotifications();
      updateNotifBadge();
    } else {
      toast(`âŒ Error: ${data.error || "Failed to approve"}`, "error");
    }
    
  } catch (err) {
    console.error("Approve time off error:", err);
    toast(`âŒ Error: ${err.message}`, "error");
  }
}

// Deny time off request
async function denyTimeOff(requestId, notifId) {
  if (!requestId) {
    toast("âŒ Error: Missing request ID", "error");
    return;
  }
  
  // Ask for denial reason
  const { value: reason, isConfirmed } = await Swal.fire({
    title: 'Deny Time Off Request',
    input: 'text',
    inputLabel: 'Reason for denial (optional)',
    inputPlaceholder: 'Enter reason...',
    showCancelButton: true,
    confirmButtonText: 'Deny Request',
    confirmButtonColor: '#dc2626',
    cancelButtonText: 'Cancel'
  });
  
  if (!isConfirmed) return;
  
  try {
    const res = await fetch("./?action=timeoff/deny", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        requestId: requestId,
        notifId: notifId,
        managerName: window._myName || "Manager",
        reason: reason || ""
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast("Time off request denied", "info");
      // Remove from pendingNotifications and re-render
      pendingNotifications = pendingNotifications.filter(n => 
        !(n.notificationType === 'timeoff_request' && n.id === notifId)
      );
      renderNotifications();
      updateNotifBadge();
    } else {
      toast(`âŒ Error: ${data.error || "Failed to deny"}`, "error");
    }
    
  } catch (err) {
    console.error("Deny time off error:", err);
    toast(`âŒ Error: ${err.message}`, "error");
  }
}

// Send a single notification
async function sendSingleNotification(idx) {
  const n = pendingNotifications[idx];
  if (!n) return;
  
  try {
    const res = await fetch("./?action=notifications/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        notifications: [{ docId: n.docId, assignmentId: n.assignmentId }]
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.sent > 0) {
      toast(`âœ… Notification sent to ${n.person}!`, "success");
      pendingNotifications.splice(idx, 1);
      renderNotifications();
      updateNotifBadge();
    } else {
      const errMsg = data.results?.[0]?.error || "Failed to send";
      toast(`âŒ Failed:  ${errMsg}`, "error");
    }
    
  } catch (err) {
    console.error("Send notification error:", err);
    toast(`âŒ Error: ${err.message}`, "error");
  }
}
// Dismiss a notification (don't send, just clear it)
async function dismissNotification(idx) {
  const n = pendingNotifications[idx];
  if (!n) return;
  
  try {
    const res = await fetch("./?action=notifications/dismiss", {
      method: "POST",
      headers:  { "Content-Type": "application/json" },
      body:  JSON.stringify({
        docId: n.docId,
        assignmentId: n.assignmentId
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`Notification dismissed`, "info");
      pendingNotifications.splice(idx, 1);
      renderNotifications();
      updateNotifBadge();
    } else {
      toast(`âŒ Failed to dismiss`, "error");
    }
    
  } catch (err) {
    console.error("Dismiss error:", err);
    toast(`âŒ Error: ${err.message}`, "error");
  }
}
// Send ALL pending notifications
async function sendAllPending() {
  if (pendingNotifications.length === 0) {
    toast("No pending notifications to send", "info");
    return;
  }
  
  const confirmed = await Swal.fire({
    title: "Send All Notifications?",
    text: `This will send ${pendingNotifications.length} notification(s) via Google Chat. `,
    icon: "question",
    showCancelButton:  true,
    confirmButtonText:  "Yes, Send All",
    cancelButtonText: "Cancel"
  });
  
  if (!confirmed.isConfirmed) return;
  
  try {
    const payload = pendingNotifications.map(n => ({
      docId: n.docId,
      assignmentId: n.assignmentId
    }));
    
    const res = await fetch("./?action=notifications/send", {
      method:  "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ notifications: payload })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`âœ… Sent ${data.sent} of ${data.total} notifications`, "success");
      await loadPendingNotifications(); // Refresh the list
    } else {
      toast(`âŒ Error sending notifications`, "error");
    }
    
  } catch (err) {
    console.error("Send all error:", err);
    toast(`âŒ Error: ${err.message}`, "error");
  }
}

// ============================================
// OPEN SHIFTS MANAGEMENT
// ============================================

let _currentOpenShifts = [];
let _currentFillShiftData = null;

// Open the Open Shifts modal
async function openOpenShiftsModal() {
  const modal = document.getElementById("openShiftsModal");
  if (!modal) return;
  modal.style.display = "flex";
  await loadOpenShifts();
}

// Close the Open Shifts modal
function closeOpenShiftsModal() {
  const modal = document.getElementById("openShiftsModal");
  if (modal) modal.style.display = "none";
}

// Load open shifts from backend
async function loadOpenShifts() {
  const listEl = document.getElementById("openShiftsList");
  if (!listEl) return;
  
  listEl.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">Loading open shifts...</div>';
  
  try {
    const res = await fetch("./?action=open-shifts");
    const data = await res.json();
    
    if (!data.ok) throw new Error(data.error || "Failed to load");
    
    _currentOpenShifts = data.openShifts || [];
    
    if (_currentOpenShifts.length === 0) {
      listEl.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:40px;">ðŸŽ‰ No open shifts - all shifts are covered!</div>';
      return;
    }
    
    let html = '';
    _currentOpenShifts.forEach((shift, idx) => {
      const dateStr = shift.date || '';
      const dateDisplay = dateStr ? new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : 'Unknown Date';
      
      html += `
        <div class="open-shift-card">
          <div class="open-shift-header">
            <div class="open-shift-date">${escapeHtml(dateDisplay)}</div>
            <span class="open-shift-team">${escapeHtml(shift.team || 'Team')}</span>
          </div>
          <div class="open-shift-time">ðŸ• ${escapeHtml(shift.startLabel || shift.start || '')} - ${escapeHtml(shift.endLabel || shift.end || '')}</div>
          ${shift.openReason ? `<div class="open-shift-reason">${escapeHtml(shift.openReason)}</div>` : ''}
          ${shift.originalPerson ? `<div style="font-size:11px; color:var(--text-tertiary); margin-bottom:10px;">Originally: ${escapeHtml(shift.originalPerson)}</div>` : ''}
          <button class="open-shift-btn" onclick="openFillShiftModal(${idx})">ðŸ‘¤ Assign Agent</button>
        </div>
      `;
    });
    
    listEl.innerHTML = html;
    
  } catch (err) {
    console.error("Load open shifts error:", err);
    listEl.innerHTML = `<div style="text-align:center; color:#ef4444; padding:20px;">Error: ${err.message}</div>`;
  }
}

// Open the Fill Shift modal
function openFillShiftModal(idx) {
  const shift = _currentOpenShifts[idx];
  if (!shift) return;
  
  _currentFillShiftData = shift;
  
  const modal = document.getElementById("fillShiftModal");
  const infoEl = document.getElementById("fillShiftInfo");
  const agentSelect = document.getElementById("fillShiftAgent");
  
  if (!modal || !infoEl || !agentSelect) return;
  
  // Populate shift info
  const dateStr = shift.date || '';
  const dateDisplay = dateStr ? new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) : 'Unknown Date';
  
  infoEl.innerHTML = `
    <div style="font-weight:700; font-size:14px; color:var(--text-primary); margin-bottom:6px;">ðŸ“… ${escapeHtml(dateDisplay)}</div>
    <div style="font-size:12px; color:var(--text-secondary);">
      <span style="background:var(--accent-primary); color:white; padding:2px 8px; border-radius:4px; font-weight:600; font-size:11px;">${escapeHtml(shift.team || 'Team')}</span>
      &nbsp;ðŸ• ${escapeHtml(shift.startLabel || shift.start || '')} - ${escapeHtml(shift.endLabel || shift.end || '')}
    </div>
    ${shift.openReason ? `<div style="font-size:11px; color:var(--text-tertiary); margin-top:8px; font-style:italic;">${escapeHtml(shift.openReason)}</div>` : ''}
  `;
  
  // Populate agent dropdown
  agentSelect.innerHTML = '<option value="">-- Select an agent --</option>';
  
  if (window._peopleList && window._peopleList.length > 0) {
    window._peopleList.forEach(p => {
      const name = p.name || p.id || '';
      if (name && name.toLowerCase() !== 'open') {
        agentSelect.innerHTML += `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
      }
    });
  } else {
    // Fallback: try to get from global state
    const peopleFromState = window._people || [];
    peopleFromState.forEach(p => {
      const name = p.name || p.id || '';
      if (name && name.toLowerCase() !== 'open') {
        agentSelect.innerHTML += `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
      }
    });
  }
  
  modal.style.display = "flex";
}

// Close the Fill Shift modal
function closeFillShiftModal() {
  const modal = document.getElementById("fillShiftModal");
  if (modal) modal.style.display = "none";
  _currentFillShiftData = null;
}

// Submit fill shift
async function submitFillShift() {
  if (!_currentFillShiftData) {
    toast("No shift selected", "error");
    return;
  }
  
  const agentSelect = document.getElementById("fillShiftAgent");
  const notifyCheckbox = document.getElementById("fillShiftNotify");
  
  const agentName = agentSelect?.value;
  const notifyAgent = notifyCheckbox?.checked ?? true;
  
  if (!agentName) {
    toast("Please select an agent", "error");
    return;
  }
  
  try {
    const res = await fetch("./?action=open-shifts/fill", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        docId: _currentFillShiftData.docId,
        assignmentId: _currentFillShiftData.assignmentId,
        agentName: agentName,
        notifyAgent: notifyAgent
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`âœ… Shift assigned to ${agentName}!`, "success");
      closeFillShiftModal();
      await loadOpenShifts(); // Refresh the list
      
      // Also refresh the main schedule view
      if (typeof forceRefresh === 'function') {
        forceRefresh();
      }
    } else {
      toast(`âŒ Error: ${data.error || "Failed to assign"}`, "error");
    }
    
  } catch (err) {
    console.error("Fill shift error:", err);
    toast(`âŒ Error: ${err.message}`, "error");
  }
}

// Update coverage dashboard to show open shifts
async function updateCoverageOpenShifts() {
  if (!window._isManager) return;
  
  try {
    const res = await fetch("./?action=open-shifts");
    const data = await res.json();
    
    if (!data.ok) return;
    
    const openShifts = data.openShifts || [];
    const todayOpenShifts = openShifts.filter(s => {
      const today = new Date().toISOString().split('T')[0];
      return s.date === today;
    });
    
    // Find or create the open shifts section in coverage panel
    const covContent = document.getElementById("covContent");
    if (!covContent) return;
    
    // Remove existing open shifts section if any
    const existingSection = covContent.querySelector('.cov-open-shifts-section');
    if (existingSection) existingSection.remove();
    
    if (todayOpenShifts.length === 0) return;
    
    // Create new section
    const section = document.createElement('div');
    section.className = 'cov-open-shifts-section';
    
    let html = `
      <div class="cov-open-shifts-header">
        <div class="cov-open-shifts-title">
          âš ï¸ Open Shifts Today
          <span class="cov-open-shifts-badge">${todayOpenShifts.length}</span>
        </div>
        <button onclick="openOpenShiftsModal()" style="font-size:11px; padding:4px 10px; background:var(--accent-primary); color:white; border:none; border-radius:6px; cursor:pointer;">View All</button>
      </div>
    `;
    
    todayOpenShifts.slice(0, 3).forEach((shift, idx) => {
      html += `
        <div class="cov-open-shift-item">
          <div class="cov-open-shift-info">
            <div class="cov-open-shift-team">${escapeHtml(shift.team || 'Team')}</div>
            <div class="cov-open-shift-time">${escapeHtml(shift.startLabel || shift.start || '')} - ${escapeHtml(shift.endLabel || shift.end || '')}</div>
          </div>
          <button class="cov-open-shift-fill-btn" onclick="openFillShiftModal(${idx}); _currentOpenShifts = ${JSON.stringify(todayOpenShifts).replace(/"/g, '&quot;')};">Fill</button>
        </div>
      `;
    });
    
    if (todayOpenShifts.length > 3) {
      html += `<div style="text-align:center; margin-top:8px;"><a href="#" onclick="openOpenShiftsModal(); return false;" style="font-size:11px; color:var(--accent-primary);">View ${todayOpenShifts.length - 3} more open shifts â†’</a></div>`;
    }
    
    section.innerHTML = html;
    covContent.appendChild(section);
    
  } catch (err) {
    console.error("Update coverage open shifts error:", err);
  }
}

// ============================================
// END OPEN SHIFTS MANAGEMENT
// ============================================

// Undo a backend notification using localStorage undo data
async function undoBackendNotification(idx) {
  const notif = pendingNotifications[idx];
  if (!notif) {
    toast("Notification not found", "error");
    return;
  }
  
  // Get undo data from localStorage
  const undoKey = `undo_${notif.docId}_${notif.assignmentId}`;
  let undoData = null;
  try {
    const stored = localStorage.getItem(undoKey);
    if (stored) undoData = JSON.parse(stored);
  } catch (e) {}
  
  if (!undoData || !undoData.originalPerson) {
    toast("Cannot undo - no undo data available", "error");
    return;
  }
  
  const result = await Swal.fire({
    title: 'â†©ï¸ Undo This Change?',
    html: `
      <div style="text-align:left; padding:10px; background:#fef3c7; border-radius:8px; border:1px solid #fcd34d;">
        <p style="margin:0 0 10px 0; color:#92400e;">This will revert the schedule change:</p>
        <div style="font-size:13px; color:#78350f;">
          <strong>Restore:</strong> ${escapeHtml(undoData.originalPerson)}<br>
          <strong>Shift:</strong> ${escapeHtml(notif.date || 'Unknown date')}
        </div>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#f59e0b',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'â†©ï¸ Yes, Undo',
    cancelButtonText: 'Cancel'
  });
  
  if (!result.isConfirmed) return;
  
  toast("Reverting change...");
  
  try {
    const response = await fetch('./?action=assignment/replace', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        docId: undoData.docId,
        assignmentId: undoData.assignmentId,
        newPerson: undoData.originalPerson,
        notes: undoData.originalNotes || '',
        notifyMode: "silent"
      })
    });
    
    const res = await response.json();
    
    if (res.ok || res.status === "success") {
      // Update local data
      const local = _allData.find(x => x.assignmentId === undoData.assignmentId);
      if(local) { 
        local.person = undoData.originalPerson; 
        local.notes = undoData.originalNotes || ''; 
      }
      
      // Remove undo data from localStorage
      localStorage.removeItem(undoKey);
      
      // Refresh UI
      renderView();
      loadPendingNotifications();
      
      Swal.fire({
        title: 'âœ… Reverted!',
        text: 'The schedule change has been undone.',
        icon: 'success',
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      throw new Error(res.error || res.message || "Unknown error");
    }
  } catch (err) {
    toast(`Undo failed: ${err.message || err}`, "error");
  }
}

  function toggleDrawer() {
    const drawer = document.getElementById("rightDrawer");
    const notifPanel = document.getElementById("notifPanel");
    if (notifPanel && notifPanel.style.display === "block") {
        notifPanel.style.display = "none";
    }
    if (drawer) {
        drawer.classList.toggle("open");
    }
  }
  function setMode(mode) {
    _mode = mode; 
    document.getElementById("btnModeQuick").className = mode === "quick" ? "segBtn active" : "segBtn";
    document.getElementById("btnModeTeam").className = mode === "team" ? "segBtn active" : "segBtn";
    const quickDiv = document.getElementById("drawerQuick");
    const teamDiv = document.getElementById("drawerTeam");
    if (mode === "quick") {
      quickDiv.classList.remove("hidden");
      teamDiv.classList.add("hidden");
    } else {
      quickDiv.classList.add("hidden");
      teamDiv.classList.remove("hidden");
    }
  }
  // Clear all notifications (dismiss all)
async function clearNotifications() {
  if (pendingNotifications.length === 0) {
    toast("No notifications to clear", "info");
    return;
  }
  
  const confirmed = await Swal.fire({
    title: "Clear All Notifications?",
    text: "This will dismiss all pending notifications without sending them.",
    icon: "warning",
    showCancelButton:  true,
    confirmButtonText:  "Yes, Clear All",
    confirmButtonColor: "#ef4444",
    cancelButtonText: "Cancel"
  });
  
  if (!confirmed.isConfirmed) return;
  
  // Dismiss each one
  for (const n of pendingNotifications) {
    try {
      await fetch("./?action=notifications/dismiss", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ docId: n.docId, assignmentId: n.assignmentId })
      });
    } catch (e) {
      console.error("Clear error:", e);
    }
  }
  
  pendingNotifications = [];
  renderNotifications();
  updateNotifBadge();
  toast("All notifications cleared", "info");
}
  // Master helper stubs
  
  

  function ensureMasterControls() {
  const host = document.getElementById("masterView");
  if (!host) return;

  let bar = document.getElementById("mstControlsBar");
  if (!bar) {
    bar = document.createElement("div");
    bar.id = "mstControlsBar";
    bar.style.display = "flex";
    bar.style.gap = "8px";
    bar.style.alignItems = "center";
    bar.style.padding = "10px 12px";
    bar.style.borderBottom = "1px solid #e2e8f0";
    bar.style.background = "#ffffff";
    bar.style.position = "sticky";
    bar.style.top = "0";
    bar.style.zIndex = "20";
    host.prepend(bar);
  }

  const status = _masterEditEnabled
    ? `<span style="font-weight:800; color:#c2410c;">EDITING DRAFT</span>`
    : `<span style="font-weight:800; color:#475569;">VIEW ONLY</span>`;

  bar.innerHTML = `
    <div style="margin-right:8px;">${status}</div>

    <button id="btnMasterEdit"
      onclick="masterStartEdit()"
      style="padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; font-weight:700;">
      âœï¸ Edit
    </button>

    <button id="btnMasterPreview"
      onclick="masterPreviewChanges()"
      style="padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; font-weight:700;">
      ðŸ‘€ Preview
    </button>

    <button id="btnMasterCancel"
      onclick="masterCancelDraft()"
      style="padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; font-weight:700;">
      â†©ï¸ Cancel
    </button>

    <div style="margin-left:auto; display:flex; gap:8px;">
      <button id="btnMasterManageAgents"
        onclick="openManageAgentsModal()"
        style="padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; font-weight:700;">
        ðŸ‘¥ Manage Agents
      </button>
      <button id="btnMasterAddAgent"
        onclick="openAddAgentModal()"
        style="padding:8px 10px; border-radius:8px; border:1px solid #D8636B; background:#D8636B; color:black; cursor:pointer; font-weight:700;">
        âž• Add Agent
      </button>
    </div>
  `;

  // button states
  const bEdit = document.getElementById("btnMasterEdit");
  const bPrev = document.getElementById("btnMasterPreview");
  const bCan = document.getElementById("btnMasterCancel");
  if (bEdit) bEdit.disabled = _masterEditEnabled;
  if (bPrev) bPrev.disabled = !_masterEditEnabled;
  if (bCan) bCan.disabled = !_masterEditEnabled;
  [bEdit,bPrev,bCan].forEach(b => {
    if (!b) return;
    b.style.opacity = b.disabled ? "0.5" : "1";
    b.style.cursor = b.disabled ? "not-allowed" : "pointer";
  });
}

function masterStartEdit() {
  if (!_masterOriginalData) _masterOriginalData = deepClone(_masterRawData || {});
  if (!_masterDraftData) _masterDraftData = deepClone(_masterRawData || {});
  _masterEditEnabled = true;
  _masterRawData = _masterDraftData;
  renderMasterView(_masterRawData);
}

function masterCancelDraft() {
  _masterDraftData = deepClone(_masterOriginalData || {});
  _masterRawData = _masterDraftData;
  _masterEditEnabled = false;
  renderMasterView(_masterRawData);
  toast("Draft cancelled. No changes were applied.", "info");
}

function diffMaster(orig, draft) {
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  const key = (x) => `${x.person}|${x.start}|${x.end}|${x.team || ""}|${x.role || ""}`;

  const out = [];
  days.forEach(day => {
    const o = Array.isArray(orig?.[day]) ? orig[day] : [];
    const d = Array.isArray(draft?.[day]) ? draft[day] : [];

    const oMap = new Map();
    o.forEach(x => oMap.set(key(x), (oMap.get(key(x)) || 0) + 1));

    const dMap = new Map();
    d.forEach(x => dMap.set(key(x), (dMap.get(key(x)) || 0) + 1));

    const adds = [];
    const removes = [];

    for (const [k, cnt] of dMap.entries()) {
      const prev = oMap.get(k) || 0;
      if (cnt > prev) adds.push({ k, n: cnt - prev });
    }
    for (const [k, cnt] of oMap.entries()) {
      const now = dMap.get(k) || 0;
      if (cnt > now) removes.push({ k, n: cnt - now });
    }

    if (adds.length || removes.length) out.push({ day, adds, removes });
  });

  return out;
}

async function masterApplyDraft() {
  try {
    Swal.fire({
      title: "Applying template...",
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => Swal.showLoading()
    });

    const res = await fetch("./?action=base-schedule/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ days: _masterDraftData || {} })
    });

    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Failed to apply template");

    // âœ… commit: original = draft, then reset draft to a fresh clone
    _masterOriginalData = deepClone(_masterDraftData);
    _masterDraftData = deepClone(_masterOriginalData);
    _masterRawData = _masterDraftData;
    _masterEditEnabled = false;

    renderMasterView(_masterRawData);

    // Offer to propagate changes to live schedule
    const propagate = await Swal.fire({
      icon: "success",
      title: "Template Saved!",
      html: `
        <div style="text-align:left; padding:10px;">
          <p style="margin-bottom:15px;">Master Schedule template has been updated.</p>
          <div style="background:#fef3c7; border:1px solid #fcd34d; border-radius:8px; padding:12px;">
            <p style="margin:0; font-size:13px; color:#92400e;">
              <strong>âš ï¸ Note:</strong> Changes only affect <strong>future</strong> schedules when generated.
            </p>
            <p style="margin:8px 0 0 0; font-size:12px; color:#a16207;">
              Want to apply these changes to existing future schedules?
            </p>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonColor: "#b37e78",
      cancelButtonColor: "#64748b",
      confirmButtonText: "ðŸ”„ Regenerate Now",
      cancelButtonText: "Done"
    });
    
    if (propagate.isConfirmed) {
      // Call regenerate with 14 days by default
      regenerateAllSchedule();
    }
  } catch (e) {
    console.error(e);
    Swal.fire({
      icon: "error",
      title: "Apply failed",
      text: e.message,
      confirmButtonColor: "#ef4444"
    });
  }
}

function masterPreviewChanges() {
  // âœ… ensure baseline/draft exist BEFORE diff
  if (!_masterOriginalData) _masterOriginalData = deepClone(_masterRawData || {});
  if (!_masterDraftData) _masterDraftData = deepClone(_masterRawData || {});

  const diff = diffMaster(_masterOriginalData, _masterDraftData);

  if (!diff.length) {
    Swal.fire({
      icon: "info",
      title: "No changes",
      text: "Your draft matches the current template.",
      confirmButtonColor: "#b37e78"
    });
    return;
  }

  // Build modern preview HTML
  let totalAdds = 0, totalRemoves = 0;
  diff.forEach(block => {
    totalAdds += block.adds.length;
    totalRemoves += block.removes.length;
  });

  let html = `
    <div style="text-align:left;">
      <!-- Summary Stats -->
      <div style="display:flex; gap:12px; margin-bottom:16px;">
        <div style="flex:1; background:linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding:12px 16px; border-radius:12px; border:1px solid #86efac;">
          <div style="font-size:24px; font-weight:800; color:#166534;">${totalAdds}</div>
          <div style="font-size:11px; font-weight:600; color:#15803d; text-transform:uppercase;">Changes Added</div>
        </div>
        <div style="flex:1; background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding:12px 16px; border-radius:12px; border:1px solid #fca5a5;">
          <div style="font-size:24px; font-weight:800; color:#991b1b;">${totalRemoves}</div>
          <div style="font-size:11px; font-weight:600; color:#dc2626; text-transform:uppercase;">Changes Removed</div>
        </div>
      </div>
      
      <!-- Changes List -->
      <div style="max-height:300px; overflow:auto; border:1px solid var(--border-color, #e2e8f0); border-radius:12px;">`;
  
  diff.forEach((block, idx) => {
    const borderTop = idx > 0 ? "border-top:1px solid #e2e8f0;" : "";
    html += `
      <div style="padding:14px; ${borderTop} background:var(--card-bg, #fff);">
        <div style="font-weight:800; font-size:14px; color:var(--text-primary, #1e293b); margin-bottom:10px; display:flex; align-items:center; gap:8px;">
          <span style="background:#b37e78; color:white; padding:2px 8px; border-radius:6px; font-size:11px;">${block.day}</span>
          <span style="color:#64748b; font-size:12px; font-weight:500;">${block.adds.length + block.removes.length} change${block.adds.length + block.removes.length !== 1 ? 's' : ''}</span>
        </div>`;

    if (block.adds.length) {
      html += `<div style="margin-bottom:8px;">`;
      block.adds.forEach(a => {
        const parts = a.k.split('|');
        const name = parts[0] || '';
        const time = parts[1] && parts[2] ? `${formatTimeDisplay(parts[1])} - ${formatTimeDisplay(parts[2])}` : '';
        const channel = parts[3] || '';
        html += `
          <div style="display:flex; align-items:center; gap:8px; padding:8px 10px; background:#f0fdf4; border-radius:8px; margin-bottom:4px; border-left:3px solid #22c55e;">
            <span style="color:#22c55e; font-size:14px;">âž•</span>
            <div style="flex:1;">
              <span style="font-weight:600; color:#166534;">${name}</span>
              ${time ? `<span style="color:#15803d; font-size:12px; margin-left:8px;">${time}</span>` : ''}
              ${channel ? `<span style="background:#bbf7d0; color:#166534; padding:1px 6px; border-radius:4px; font-size:10px; margin-left:6px;">${channel}</span>` : ''}
            </div>
          </div>`;
      });
      html += `</div>`;
    }
    
    if (block.removes.length) {
      html += `<div>`;
      block.removes.forEach(r => {
        const parts = r.k.split('|');
        const name = parts[0] || '';
        const time = parts[1] && parts[2] ? `${formatTimeDisplay(parts[1])} - ${formatTimeDisplay(parts[2])}` : '';
        const channel = parts[3] || '';
        html += `
          <div style="display:flex; align-items:center; gap:8px; padding:8px 10px; background:#fef2f2; border-radius:8px; margin-bottom:4px; border-left:3px solid #ef4444;">
            <span style="color:#ef4444; font-size:14px;">âž–</span>
            <div style="flex:1;">
              <span style="font-weight:600; color:#991b1b; text-decoration:line-through;">${name}</span>
              ${time ? `<span style="color:#dc2626; font-size:12px; margin-left:8px;">${time}</span>` : ''}
              ${channel ? `<span style="background:#fecaca; color:#991b1b; padding:1px 6px; border-radius:4px; font-size:10px; margin-left:6px;">${channel}</span>` : ''}
            </div>
          </div>`;
      });
      html += `</div>`;
    }

    html += `</div>`;
  });
  
  html += `</div></div>`;

  Swal.fire({
    title: "ðŸ“‹ Review Changes",
    html,
    width: 500,
    showCancelButton: true,
    confirmButtonText: "âœ“ Apply Changes",
    cancelButtonText: "â† Keep Editing",
    confirmButtonColor: "#16a34a",
    cancelButtonColor: "#64748b"
  }).then((r) => {
    if (r.isConfirmed) masterApplyDraft();
  });
}

// Helper to format time for preview
function formatTimeDisplay(time) {
  if (!time) return '';
  const [h, m] = time.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const hour = h % 12 || 12;
  return `${hour}:${String(m || 0).padStart(2, '0')} ${ampm}`;
}

function closeMasterModal() {
  $("masterOverlay").style.display = "none";
}

// ============================================
// SAVE MASTER SCHEDULE EDIT
// ============================================
async function saveMasterEdit() {
  const person = $("mstPerson").value;
  const day = $("mstDay").value;
  const newStart = $("mstStart").value.trim();
  const newEnd = $("mstEnd").value.trim();
  const newTeam = $("mstTeam").value;
  const newRole = $("mstRole").value;
  const syncToLive = $("mstSync").checked;
  
  // Validation
  if (!person || !day) {
    toast("Missing person or day information", "error");
    return;
  }
  
  if (!newStart || !newEnd) {
    toast("Please enter both start and end times", "error");
    return;
  }
  
  // Parse times to validate
  const startDec = parseTimeDecimal(newStart);
  const endDec = parseTimeDecimal(newEnd);
  
  if (startDec >= endDec) {
    toast("End time must be after start time", "error");
    return;
  }
  
  // Find the original shift data from master template
  const originalShift = _masterRawData?.find(item => 
    item.person === person && 
    item.day === day
  );
  
  const oldStart = originalShift?.start || "";
  const oldEnd = originalShift?.end || "";
  
  // Determine action (EDIT if original exists, ADD if new)
  const action = originalShift ? "EDIT" : "ADD";
  
  // Convert times to HH:MM format
  const formattedNewStart = formatTimeHHMM(newStart);
  const formattedNewEnd = formatTimeHHMM(newEnd);
  const formattedOldStart = formatTimeHHMM(oldStart);
  const formattedOldEnd = formatTimeHHMM(oldEnd);
  
  try {
    // Show loading state
    toast("Saving changes...", "info");
    
    // 1. Update the master template (base_schedule)
    const masterRes = await fetch('/update-master-schedule', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action,
        person,
        day,
        oldStart: formattedOldStart,
        oldEnd: formattedOldEnd,
        newStart: formattedNewStart,
        newEnd: formattedNewEnd,
        newTeam,
        newRole
      })
    });
    
    const masterData = await masterRes.json();
    
    if (masterData.status !== "success") {
      throw new Error(masterData.message || "Failed to update master template");
    }
    
    // 2. If sync checkbox is checked, trigger regeneration for affected future dates
    if (syncToLive) {
      toast("Syncing to live schedule...", "info");
      
      // Trigger a regeneration for the next 14 days
      // This will apply the updated master template to future schedules
      try {
        const genRes = await fetch('./?action=admin/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            days: 14,
            teamKey: newTeam || "ALL",
            startDate: new Date(Date.now() + 86400000).toISOString().split('T')[0] // Tomorrow
          })
        });
        const genData = await genRes.json();
        
        if (genData.ok) {
          toast(`âœ… Master template updated & synced to future schedule`, "success");
        } else {
          toast(`âš ï¸ Master updated but sync may be incomplete: ${genData.error || 'Unknown error'}`, "warning");
        }
      } catch (syncErr) {
        console.warn("Sync to live failed:", syncErr);
        toast(`âš ï¸ Master updated but live sync failed`, "warning");
      }
    } else {
      toast("âœ… Master template updated", "success");
    }
    
    // Close modal and refresh view
    closeMasterModal();
    
    // Refresh master view if currently viewing it
    if (typeof loadMasterTemplateData === 'function') {
      loadMasterTemplateData();
    }
    
    // Also refresh main schedule data
    if (typeof loadSystemData === 'function') {
      setTimeout(() => loadSystemData(), 500);
    }
    
  } catch (err) {
    console.error("Save Master Edit Error:", err);
    toast("âŒ " + (err.message || "Failed to save changes"), "error");
  }
}

// Helper to convert time to HH:MM format (handles AM/PM)
function formatTimeHHMM(t) {
  if (!t) return "";
  const s = String(t).trim();
  
  // Handle AM/PM format (e.g., "8:00 AM", "2:30 PM")
  const ampmMatch = s.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
  if (ampmMatch) {
    let h = parseInt(ampmMatch[1], 10);
    const m = ampmMatch[2];
    const ampm = ampmMatch[3]?.toUpperCase();
    
    if (ampm === "PM" && h < 12) h += 12;
    if (ampm === "AM" && h === 12) h = 0;
    
    return `${String(h).padStart(2, '0')}:${m}`;
  }
  
  // Handle HH:MM or HH:MM:SS format
  const match = s.match(/^(\d{1,2}):(\d{2})(:\d{2})?$/);
  if (match) {
    return `${String(match[1]).padStart(2, '0')}:${match[2]}`;
  }
  
  return s;
}

  // ============================================
// AGENT NOTIFICATIONS SYSTEM
// ============================================
let _agentNotifications = [];
let _agentNotifUnreadCount = 0;
// ============================================
// [SECTION 15] AGENT MODE
// ============================================
async function loadAgentNotifications() {
  if (!window._myName) return;
  
  try {
    const res = await fetch('./?action=agent/notifications', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentName: window._myName })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      const prevUnreadCount = _agentNotifUnreadCount || 0;
      _agentNotifications = data.notifications || [];
      _agentNotifUnreadCount = data.unreadCount || 0;
      
      // Play sound and show visual indicator if NEW notifications arrived
      if (_agentNotifUnreadCount > prevUnreadCount && prevUnreadCount >= 0) {
        playNotificationSound();
        // Flash the bell icon
        const bellBtn = document.querySelector('[onclick="openAgentNotifications()"]');
        if (bellBtn) {
          bellBtn.style.animation = "pulse-bell 0.5s ease 3";
          setTimeout(() => bellBtn.style.animation = "", 1500);
        }
      }
      
      updateAgentNotifBadge();
    }
  } catch (err) {
    console.error("Load agent notifications error:", err);
  }
}
function updateAgentNotifBadge() {
  const badge = $("agentNotifBadge");
  if (!badge) return;
  
  if (_agentNotifUnreadCount > 0) {
    badge.textContent = _agentNotifUnreadCount > 9 ? "9+" : _agentNotifUnreadCount;
    badge.style.display = "flex";
    // Add pulsing animation for unread notifications
    badge.style.animation = "pulse-badge 2s infinite";
  } else {
    badge.style.display = "none";
    badge.style.animation = "";
  }
}
// ============================================
// FUTURE TIME OFF REQUEST (Calendar-based)
// ============================================
// Future Time Off - Multiple Make Up Dates
let _futureMakeUpDates = [];

function addFutureMakeUpDate() {
  const dateInput = $("futureToMakeUpDate");
  if (!dateInput || !dateInput.value) {
    toast("Please select a date first", "error");
    return;
  }
  
  const date = dateInput.value;
  if (_futureMakeUpDates.includes(date)) {
    toast("This date is already added", "error");
    return;
  }
  
  _futureMakeUpDates.push(date);
  dateInput.value = "";
  renderFutureMakeUpDates();
}

function removeFutureMakeUpDate(date) {
  _futureMakeUpDates = _futureMakeUpDates.filter(d => d !== date);
  renderFutureMakeUpDates();
}

function renderFutureMakeUpDates() {
  const container = $("futureMakeUpDatesList");
  if (!container) return;
  
  if (_futureMakeUpDates.length === 0) {
    container.innerHTML = '<span style="font-size:12px; color:#94a3b8; font-style:italic;">No dates added yet</span>';
    return;
  }
  
  container.innerHTML = _futureMakeUpDates.map(date => {
    const d = new Date(date + 'T12:00:00');
    const formatted = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    return `
      <span style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border:1px solid #93c5fd; border-radius:20px; font-size:12px; font-weight:600; color:#1e40af;">
        ðŸ“… ${formatted}
        <button type="button" onclick="removeFutureMakeUpDate('${date}')" style="background:none; border:none; color:#3b82f6; cursor:pointer; font-size:14px; padding:0; line-height:1;">&times;</button>
      </span>
    `;
  }).join('');
}

function openFutureTimeOffModal() {
  const modal = $("futureTimeOffModal");
  if (!modal) return;
  
  // Reset make-up dates array
  _futureMakeUpDates = [];
  renderFutureMakeUpDates();
  
  // Set default dates
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowISO = tomorrow.toISOString().split("T")[0];
  
  const startInput = $("futureToDateStart");
  const endInput = $("futureToDateEnd");
  const makeUpInput = $("futureToMakeUpDate");
  
  if (startInput) {
    startInput.value = tomorrowISO;
    startInput.min = tomorrowISO;
    startInput.onchange = updateFutureTimeOffDaysCount;
  }
  if (endInput) {
    endInput.value = tomorrowISO;
    endInput.min = tomorrowISO;
    endInput.onchange = updateFutureTimeOffDaysCount;
  }
  if (makeUpInput) {
    makeUpInput.value = "";
    makeUpInput.min = tomorrowISO;
  }
  
  // Clear reason
  if ($("futureToReason")) $("futureToReason").value = "";
  
  // Reset type selection to Make Up
  selectFutureTimeOffType('makeup');
  
  // Update PTO balance display
  const ptoEl = $("futureTimeOffPtoAmount");
  if (ptoEl && _balanceData) {
    const balance = _balanceData.get(window._myName) || { pto: 0 };
    ptoEl.textContent = balance.pto || 0;
  }
  
  // Update days count
  updateFutureTimeOffDaysCount();
  
  modal.style.display = "flex";
}

function updateFutureTimeOffDaysCount() {
  const startInput = $("futureToDateStart");
  const endInput = $("futureToDateEnd");
  const countEl = $("futureTimeOffDaysCount");
  
  if (!startInput || !endInput || !countEl) return;
  
  const start = new Date(startInput.value);
  const end = new Date(endInput.value);
  
  if (start && end && !isNaN(start) && !isNaN(end)) {
    // Ensure end is not before start
    if (end < start) {
      endInput.value = startInput.value;
      countEl.innerHTML = '<span style="color:#16a34a; font-weight:600;">ðŸ“… 1 day selected</span>';
      return;
    }
    
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    
    if (diffDays === 1) {
      countEl.innerHTML = '<span style="color:#16a34a; font-weight:600;">ðŸ“… 1 day selected</span>';
    } else {
      countEl.innerHTML = `<span style="color:#b37e78; font-weight:600;">ðŸ“… ${diffDays} days selected</span>`;
    }
  }
}

function selectFutureTimeOffType(type) {
  const makeUpLabel = $("futureTypeMakeUp");
  const ptoLabel = $("futureTypePTO");
  const makeUpWrap = $("futureToMakeUpWrap");
  
  if (type === 'makeup') {
    if (makeUpLabel) {
      makeUpLabel.style.borderColor = '#b37e78';
      makeUpLabel.style.background = '#eff6ff';
      makeUpLabel.querySelector('input').checked = true;
    }
    if (ptoLabel) {
      ptoLabel.style.borderColor = '#e2e8f0';
      ptoLabel.style.background = 'white';
    }
    if (makeUpWrap) makeUpWrap.style.display = 'block';
  } else {
    if (ptoLabel) {
      ptoLabel.style.borderColor = '#16a34a';
      ptoLabel.style.background = '#f0fdf4';
      ptoLabel.querySelector('input').checked = true;
    }
    if (makeUpLabel) {
      makeUpLabel.style.borderColor = '#e2e8f0';
      makeUpLabel.style.background = 'white';
    }
    if (makeUpWrap) makeUpWrap.style.display = 'none';
  }
}

function closeFutureTimeOffModal() {
  const modal = $("futureTimeOffModal");
  if (modal) modal.style.display = "none";
}

async function submitFutureTimeOff() {
  const startDate = $("futureToDateStart")?.value;
  const endDate = $("futureToDateEnd")?.value;
  const typeRadio = document.querySelector('input[name="futureToType"]:checked');
  const type = typeRadio ? typeRadio.value : "Make Up";
  const reason = $("futureToReason")?.value || "";
  
  if (!startDate) {
    toast("Please select a start date", "error");
    return;
  }
  
  if (!reason.trim()) {
    toast("Please provide a reason", "error");
    return;
  }
  
  // If Make Up type, require at least one make up date
  if (type === "Make Up" && _futureMakeUpDates.length === 0) {
    // Check if there's a single date in the input as fallback
    const singleDate = $("futureToMakeUpDate")?.value;
    if (!singleDate) {
      toast("Please add at least one make up date", "error");
      return;
    }
    _futureMakeUpDates.push(singleDate);
  }
  
  // Calculate dates in range
  const start = new Date(startDate);
  const end = new Date(endDate || startDate);
  const dates = [];
  
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    dates.push(d.toISOString().split("T")[0]);
  }
  
  // Format make up dates string
  const makeUpDatesStr = _futureMakeUpDates.join(', ');
  
  try {
    Swal.fire({
      title: 'Submitting...',
      text: `Requesting ${dates.length} day${dates.length > 1 ? 's' : ''} off`,
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => Swal.showLoading()
    });
    
    // Submit each date as a separate request
    let successCount = 0;
    let errors = [];
    
    for (const date of dates) {
      try {
        const res = await fetch('./?action=timeoff/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            person: window._myName,
            date: date,
            typeKey: type.toLowerCase().replace(" ", "_"),
            duration: "full_day",
            reason: reason,
            makeUpDate: type === "Make Up" ? makeUpDatesStr : null,
            makeUpDates: type === "Make Up" ? _futureMakeUpDates : [],
            shiftStart: null,
            shiftEnd: null,
            team: null
          })
        });
        
        const data = await res.json();
        if (data.ok) {
          successCount++;
        } else {
          errors.push(`${date}: ${data.error || 'Unknown error'}`);
        }
      } catch (err) {
        errors.push(`${date}: ${err.message}`);
      }
    }
    
    closeFutureTimeOffModal();
    
    if (successCount === dates.length) {
      Swal.fire({
        icon: 'success',
        title: 'Request Submitted!',
        html: `<div style="text-align:center;">
          <p>âœ… ${successCount} day${successCount > 1 ? 's' : ''} requested</p>
          ${type === "Make Up" ? `<p style="font-size:12px; color:#64748b; margin-top:4px;">Make up dates: ${makeUpDatesStr}</p>` : ''}
          <p style="font-size:12px; color:#64748b; margin-top:8px;">Your manager will review your request.</p>
        </div>`,
        confirmButtonColor: '#16a34a'
      });
    } else if (successCount > 0) {
      Swal.fire({
        icon: 'warning',
        title: 'Partially Submitted',
        html: `<div style="text-align:left;">
          <p>âœ… ${successCount} day${successCount > 1 ? 's' : ''} submitted</p>
          <p>âŒ ${errors.length} failed:</p>
          <ul style="font-size:12px; color:#dc2626;">${errors.map(e => `<li>${e}</li>`).join('')}</ul>
        </div>`,
        confirmButtonColor: '#f59e0b'
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Submission Failed',
        text: errors[0] || 'Unknown error',
        confirmButtonColor: '#ef4444'
      });
    }
  } catch (err) {
    console.error("Submit future time off error:", err);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Failed to submit request: ' + err.message,
      confirmButtonColor: '#ef4444'
    });
  }
}
function openAgentNotifications() {
  const panel = $("agentNotifPanel");
  if (!panel) return;
  
  renderAgentNotifications();
  panel.style.display = "flex";
}
function closeAgentNotifications() {
  const panel = $("agentNotifPanel");
  if (panel) panel.style.display = "none";
}

// Clear all agent notifications
async function clearAgentNotifications() {
  if (_agentNotifications.length === 0) {
    toast("No notifications to clear");
    return;
  }
  
  const confirmed = await Swal.fire({
    title: 'Clear All Notifications?',
    text: `This will remove all ${_agentNotifications.length} notification(s).`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#dc2626',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Yes, clear all',
    cancelButtonText: 'Cancel'
  });
  
  if (!confirmed.isConfirmed) return;
  
  try {
    const res = await fetch("./?action=agent/notifications/clear", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ agentName: window._myName })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      _agentNotifications = [];
      _agentNotifUnreadCount = 0; // âœ… FIX: Reset unread count to clear badge
      renderAgentNotifications();
      updateAgentNotifBadge();
      toast("âœ… Notifications cleared");
    } else {
      toast("Failed to clear notifications", "error");
    }
  } catch (err) {
    console.error("Clear notifications error:", err);
    toast("Error clearing notifications", "error");
  }
}

function renderAgentNotifications() {
  const list = $("agentNotifList");
  if (!list) return;
  
  if (_agentNotifications.length === 0) {
    list.innerHTML = `<div style="text-align:center; color:var(--text-secondary, #94a3b8); padding:40px;">
      <div style="font-size:48px; margin-bottom:12px;">ðŸŽ‰</div>
      <div>No notifications</div>
    </div>`;
    return;
  }
  
  list.innerHTML = _agentNotifications.map(n => {
    const isUnread = !n.read;
    const icon = getNotifIcon(n.type, n.decision);
    const timeAgo = getTimeAgo(n.createdAt);
    
    return `
      <div class="agent-notif-item ${isUnread ? 'unread' : ''}" onclick="markNotifRead('${n.id}')">
        <div class="agent-notif-icon">${icon}</div>
        <div class="agent-notif-content">
          <div class="agent-notif-message">${escapeHtml(n.message)}</div>
          <div class="agent-notif-time">${timeAgo}</div>
        </div>
        ${isUnread ? '<div class="agent-notif-dot"></div>' : ''}
      </div>
    `;
  }).join("");
}
function getNotifIcon(type, decision) {
  if (type === "timeoff_decision") {
    return decision === "approved" ? "âœ…" : "âŒ";
  }
  if (type === "timeoff_approved") return "âœ…";
  if (type === "timeoff_denied") return "âŒ";
  if (type === "shift_assigned") return "ðŸ“‹";
  if (type === "swap_request") return "ðŸ”„";
  if (type === "swap_response") {
    return decision === "accepted" ? "âœ…" : "âŒ";
  }
  if (type === "shift_change") return "ðŸ“…";
  return "ðŸ””";
}
function getTimeAgo(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return "Just now";
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
async function markNotifRead(notifId) {
  try {
    await fetch('./?action=agent/notifications/read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ notifId })
    });
    
    // Update local state
    const notif = _agentNotifications.find(n => n.id === notifId);
    if (notif && !notif.read) {
      notif.read = true;
      _agentNotifUnreadCount = Math.max(0, _agentNotifUnreadCount - 1);
      updateAgentNotifBadge();
      renderAgentNotifications();
    }
  } catch (err) {
    console.error("Mark notif read error:", err);
  }
}
// Load pending swap requests
async function loadPendingSwaps() {
  if (!window._myName) return;
  
  try {
    const res = await fetch('./?action=swap/pending', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentName: window._myName })
    });
    
    const data = await res.json();
    
    if (data.ok && data.incoming && data.incoming.length > 0) {
      // Show swap requests in notifications
      data.incoming.forEach(swap => {
        toast(`ðŸ”„ ${swap.fromPerson} wants to swap a shift with you`, "info");
      });
    }
  } catch (err) {
    console.error("Load pending swaps error:", err);
  }
}

// Helper: Check for scheduling conflicts
async function checkSchedulingConflicts(personName, date, startTime, endTime, excludeAssignmentId = null) {
  try {
    const res = await fetch('./?action=schedule/check-conflict', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        personName,
        date,
        startTime,
        endTime,
        excludeAssignmentId
      })
    });

    const data = await res.json();

    if (data.ok) {
      return {
        hasConflict: data.hasConflict,
        conflicts: data.conflicts || []
      };
    }

    return { hasConflict: false, conflicts: [] };
  } catch (err) {
    console.error('Conflict check error:', err);
    return { hasConflict: false, conflicts: [] };
  }
}

async function respondToSwap(swapId, response) {
  if (response === 'accepted') {
    // Show confirmation with swap details
    const swapRequest = _agentNotifications?.find(n => n.swapRequestId === swapId);

    if (swapRequest) {
      // Check for conflicts before accepting
      try {
        const conflictRes = await fetch('./?action=schedule/check-conflict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            personName: window._myName,
            date: swapRequest.shiftDate || swapRequest.date,
            startTime: swapRequest.shiftStart || swapRequest.start,
            endTime: swapRequest.shiftEnd || swapRequest.end
          })
        });

        const conflictData = await conflictRes.json();

        if (conflictData.ok && conflictData.hasConflict && conflictData.conflicts.length > 0) {
          // Show conflicts and block acceptance
          const conflictsList = conflictData.conflicts.map(c => 
            `â€¢ ${escapeHtml(c.team)}: ${escapeHtml(c.start)} - ${escapeHtml(c.end)}`
          ).join('<br>');

          Swal.fire({
            title: 'âš ï¸ Scheduling Conflict Detected',
            html: `
              <div style="text-align: left; font-size: 14px; line-height: 1.6;">
                <p style="color: #dc2626; font-weight: 600; margin-bottom: 12px;">
                  You are already scheduled during this time:
                </p>
                <div style="padding: 12px; background: #fee2e2; border-left: 3px solid #dc2626; border-radius: 4px; margin-bottom: 12px;">
                  ${conflictsList}
                </div>
                <p>You cannot accept this swap request due to the conflict.</p>
              </div>
            `,
            icon: 'error',
            confirmButtonColor: '#dc2626',
            confirmButtonText: 'OK'
          });
          return; // Block the acceptance
        }
      } catch (err) {
        console.error('Conflict check error:', err);
        // Continue with acceptance if conflict check fails
      }

      // Confirm acceptance
      const result = await Swal.fire({
        title: 'ðŸ”„ Accept Swap Request?',
        html: `
          <div style="text-align: left; font-size: 14px;">
            <p><strong>From:</strong> ${swapRequest.fromPerson || 'Unknown'}</p>
            <p><strong>Date:</strong> ${swapRequest.shiftDate || swapRequest.date}</p>
            <p><strong>Time:</strong> ${swapRequest.shiftStart || swapRequest.start} - ${swapRequest.shiftEnd || swapRequest.end}</p>
            ${swapRequest.team ? `<p><strong>Team:</strong> ${swapRequest.team}</p>` : ''}
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Accept',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#16a34a'
      });

      if (!result.isConfirmed) return;
    }
  }

  try {
    const res = await fetch('./?action=swap/respond', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        swapId, 
        response, 
        responderName: window._myName 
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      toast(`âœ… Swap ${response}`, "success");
      loadAgentNotifications();
      loadSystemData(); // Refresh schedule
    } else {
      toast("Failed to respond: " + (data.error || "Unknown error"), "error");
    }
  } catch (err) {
    console.error("Swap respond error:", err);
    toast("Failed to respond to swap", "error");
  }
}
  // ============================================
// ACCRUED HOURS SYSTEM
// ============================================
let _balanceData = new Map(); // person -> {pto, sick}
async function loadBalances() {
  try {
    const res = await fetch('/?action=balances/list');
    const data = await res.json();
    
    if (data.ok) {
      _balanceData.clear();
      (data.balances || []).forEach(b => {
        _balanceData.set(b.person, {
          pto: b.pto || 0,
          sick: b.sick || 0
        });
      });
      
      updateBalancePill();
    }
  } catch (err) {
    console.error("Load balances error:", err);
  }
}
function updateBalancePill() {
  const agentPill = $("balancePill");
  const managerSignOutPill = $("managerSignOutPill");
  
  if (window._isManager) {
    // âœ… MANAGERS: Hide agent profile pill, show simple sign out pill
    if (agentPill) agentPill.style.display = "none";
    if (managerSignOutPill) managerSignOutPill.style.display = "inline-flex";
  } else if (window._myName) {
    // âœ… AGENTS: Show profile pill with PTO, hide manager sign out pill
    if (managerSignOutPill) managerSignOutPill.style.display = "none";
    
    if (agentPill) {
      const balance = _balanceData.get(window._myName);
      if (balance) {
        const badge = $("ptoBadge");
        if (badge) {
          badge.textContent = `${balance.pto}h PTO`;
        }
        const text = $("balanceText");
        if (text) text.textContent = "My Profile";
        agentPill.style.display = "inline-flex";
      }
    }
  }
}
function openBalanceModal() {
  const agentView = $("agentBalanceView");
  const managerView = $("managerBalanceView");
  const modalTitle = $("balanceModalTitle");
  
  if (window._isManager) {
    // Manager view - PTO Balance management
    agentView.style.display = "none";
    managerView.style.display = "block";
    if (modalTitle) modalTitle.innerHTML = "ðŸ“Š Team PTO Balances";
    renderBalanceList();
  } else {
    // Agent view - Personal profile
    managerView.style.display = "none";
    agentView.style.display = "block";
    if (modalTitle) modalTitle.innerHTML = "ðŸ‘¤ My Profile";
    
    const balance = _balanceData.get(window._myName) || {pto: 0, sick: 0, holiday_bank: 0};
    const ptoHours = parseFloat(balance.pto) || 0;
    $("agentPtoBalance").textContent = ptoHours;
    
    // Update PTO ring visualization (max 80 hours for full ring)
    const ringFill = $("ptoRingFill");
    if (ringFill) {
      const maxHours = 80;
      const percentage = Math.min(ptoHours / maxHours, 1);
      const circumference = 283; // 2 * PI * 45
      const offset = circumference * (1 - percentage);
      ringFill.style.strokeDashoffset = offset;
      
      // Change ring color based on PTO level
      if (ptoHours <= 0) {
        ringFill.style.stroke = '#ef4444';
      } else if (ptoHours < 16) {
        ringFill.style.stroke = '#f59e0b';
      } else {
        ringFill.style.stroke = '#22c55e';
      }
    }
    
    // Find next shift
    if ($("agentNextShift")) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const nowHour = today.getHours();
      
      const futureShifts = _allData.filter(s => {
        const shiftDate = s.dayKey || s.dateISO || dayKeyPST(s.date);
        if (s.person !== window._myName) return false;
        if (String(s.notes || "").toUpperCase().includes("[OFF]")) return false;
        
        // Include today if shift hasn't ended yet
        if (shiftDate === todayStr) {
          const endHour = parseTimeDecimal(s.end);
          return endHour > nowHour;
        }
        return shiftDate > todayStr;
      }).sort((a, b) => {
        const dateA = a.dayKey || a.dateISO || "";
        const dateB = b.dayKey || b.dateISO || "";
        if (dateA !== dateB) return dateA.localeCompare(dateB);
        return (a.start || "").localeCompare(b.start || "");
      });
      
      if (futureShifts.length > 0) {
        const next = futureShifts[0];
        const nextDate = next.dayKey || next.dateISO || "";
        if (nextDate === todayStr) {
          $("agentNextShift").textContent = "Today";
        } else {
          const d = new Date(nextDate + "T12:00:00");
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);
          if (nextDate === tomorrow.toISOString().split('T')[0]) {
            $("agentNextShift").textContent = "Tomorrow";
          } else {
            $("agentNextShift").textContent = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          }
        }
      } else {
        $("agentNextShift").textContent = "None";
      }
    }
    
    // Calculate upcoming shifts this week
    if ($("agentUpcomingShifts")) {
      const today = new Date();
      const endOfWeek = new Date(today);
      endOfWeek.setDate(today.getDate() + 7);
      const todayStr = today.toISOString().split('T')[0];
      const endStr = endOfWeek.toISOString().split('T')[0];
      
      const myShifts = _allData.filter(s => {
        const shiftDate = s.dayKey || s.dateISO || dayKeyPST(s.date);
        return s.person === window._myName && 
               shiftDate >= todayStr && 
               shiftDate <= endStr &&
               !String(s.notes || "").toUpperCase().includes("[OFF]");
      });
      $("agentUpcomingShifts").textContent = myShifts.length;
    }
    
    // Fetch Zendesk stats for agent
    fetchAgentZendeskStats();
    
    // Load agent's weekly assignments
    loadAgentWeeklyAssignments();
    
    // Load rotation info (if they're covering Thursday)
    loadAgentRotationInfo();
  }
  
  $("balanceModal").style.display = "flex";
}

// Fetch Zendesk stats for agent profile
async function fetchAgentZendeskStats() {
  const opensEl = $("agentZendeskOpens");
  const ticketsListEl = $("agentTicketsList");
  const ticketsLoadingEl = $("agentTicketsLoading");
  const ticketsEmptyEl = $("agentTicketsEmpty");
  
  if (!opensEl) return;
  
  // Set loading state
  opensEl.textContent = "...";
  if (ticketsLoadingEl) ticketsLoadingEl.style.display = "block";
  if (ticketsListEl) ticketsListEl.style.display = "none";
  if (ticketsEmptyEl) ticketsEmptyEl.style.display = "none";
  
  try {
    // Fetch from agent-profile API
    const res = await fetch('./?action=agent-profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: window._myName })
    });
    
    const data = await res.json();
    console.log("[Profile] Zendesk data:", data);
    
    if (data && !data.error && data.found) {
      // Display open tickets count
      const openCount = data.openTickets || 0;
      opensEl.textContent = openCount;
      
      // Hide loading
      if (ticketsLoadingEl) ticketsLoadingEl.style.display = "none";
      
      // Render clickable ticket list
      if (ticketsListEl) {
        if (data.openTicketsList && data.openTicketsList.length > 0) {
          ticketsListEl.innerHTML = data.openTicketsList.map(ticket => {
            const priorityClass = ticket.priority ? `ticket-priority ${ticket.priority}` : '';
            const priorityBadge = ticket.priority ? 
              `<span class="${priorityClass}">${ticket.priority}</span>` : '';
            
            return `
              <a href="${ticket.url}" target="_blank" rel="noopener" class="ticket-list-item">
                <span class="ticket-id-badge">#${ticket.id}</span>
                <span class="ticket-subject" title="${(ticket.subject || '').replace(/"/g, '&quot;')}">${ticket.subject || '(No subject)'}</span>
                ${priorityBadge}
                <span class="ticket-arrow">â†’</span>
              </a>
            `;
          }).join('');
          ticketsListEl.style.display = "block";
        } else {
          // No open tickets
          if (ticketsEmptyEl) ticketsEmptyEl.style.display = "block";
        }
      }
    } else {
      // If API fails, show N/A
      console.error("[Profile] Zendesk error:", data?.error);
      opensEl.textContent = "N/A";
      if (ticketsLoadingEl) ticketsLoadingEl.style.display = "none";
    }
  } catch (err) {
    console.error("[Profile] Error fetching Zendesk stats:", err);
    opensEl.textContent = "N/A";
    if (ticketsLoadingEl) ticketsLoadingEl.style.display = "none";
  }
}

// Load agent's weekly assignments for their profile
async function loadAgentWeeklyAssignments() {
  const sectionEl = $("agentWeeklyAssignmentsSection");
  const containerEl = $("agentWeeklyAssignments");
  
  // Also update dashboard banner
  const dashboardCard = $("agentWeeklyAssignCard");
  const dashboardList = $("agentWeeklyAssignList");
  const dashboardWeek = $("agentWeeklyAssignWeek");
  const dashboardBanner = $("agentAssignmentsBanner");
  
  try {
    const res = await fetch(`/weekly-assignments/my?name=${encodeURIComponent(window._myName)}`);
    const data = await res.json();
    
    if (data.ok && data.assignments && data.assignments.length > 0) {
      // Update profile modal section (if exists)
      if (sectionEl && containerEl) {
        sectionEl.style.display = "block";
        containerEl.innerHTML = data.assignments.map(a => {
          const rolesList = a.roles.join(', ');
          const eventsNote = a.events && a.events.length > 0 ? 
            `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">ðŸ“† ${a.events.join(', ')}</div>` : '';
          
          return `
            <div style="padding: 10px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #3b82f6;">
              <div style="font-weight: 600; color: #1e40af;">Week of ${a.weekOf}</div>
              <div style="color: #1e3a8a; margin-top: 4px;">ðŸŽ¯ ${rolesList}</div>
              ${eventsNote}
            </div>
          `;
        }).join('');
      }
      
      // Update dashboard banner
      if (dashboardCard && dashboardList && dashboardBanner) {
        dashboardBanner.style.display = "block";
        dashboardCard.style.display = "block";
        
        const firstAssign = data.assignments[0];
        dashboardWeek.textContent = `Week of ${firstAssign.weekOf}`;
        
        // Create assignment chips
        const allRoles = data.assignments.flatMap(a => a.roles);
        dashboardList.innerHTML = allRoles.map(role => `
          <span style="display: inline-flex; align-items: center; padding: 4px 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 12px; font-size: 11px; font-weight: 500;">
            ${role}
          </span>
        `).join('');
      }
    } else {
      if (sectionEl) sectionEl.style.display = "none";
      if (dashboardCard) dashboardCard.style.display = "none";
    }
  } catch (err) {
    console.error("Error loading agent weekly assignments:", err);
    if (sectionEl) sectionEl.style.display = "none";
    if (dashboardCard) dashboardCard.style.display = "none";
  }
}

// Load rotation info if agent has a role in upcoming meeting
async function loadAgentRotationInfo() {
  const sectionEl = $("agentRotationSection");
  const containerEl = $("agentRotationInfo");
  
  // Dashboard banner elements
  const dashboardCard = $("agentMeetingRoleCard");
  const dashboardIcon = $("agentMeetingRoleIcon");
  const dashboardLabel = $("agentMeetingRoleLabel");
  const dashboardDate = $("agentMeetingRoleDate");
  const dashboardDesc = $("agentMeetingRoleDesc");
  const dashboardBanner = $("agentAssignmentsBanner");
  
  try {
    // Get upcoming meetings (next 7 days)
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(nextWeek.getDate() + 7);
    const todayStr = today.toISOString().split('T')[0];
    const nextWeekStr = nextWeek.toISOString().split('T')[0];
    
    const res = await fetch(`/meeting-rotation/list?start=${todayStr}&end=${nextWeekStr}`);
    const data = await res.json();
    
    if (data.ok && data.rotations && data.rotations.length > 0) {
      const agentNameLower = window._myName.toLowerCase().trim();
      
      // Find first meeting where this agent has a role
      let foundRole = null;
      let foundRotation = null;
      
      for (const rotation of data.rotations) {
        // Check Captain
        if ((rotation.captain || "").toLowerCase().trim() === agentNameLower) {
          foundRole = {
            type: "captain",
            label: "Captain (Primary)",
            color: "#92400e",
            bg: "#fef3c7",
            description: "You're the primary LC coordinator - you ATTEND the meeting and coordinate coverage.",
            icon: "ðŸ‘¤"
          };
          foundRotation = rotation;
          break;
        }
        
        // Check Backups
        if ((rotation.backup1 || "").toLowerCase().trim() === agentNameLower) {
          foundRole = {
            type: "backup",
            label: "Backup #1",
            color: "#065f46",
            bg: "#d1fae5",
            description: "You ATTEND the meeting but set as 'Away' in Zendesk. Jump in if queue busy.",
            icon: "ðŸ”„"
          };
          foundRotation = rotation;
          break;
        }
        if ((rotation.backup2 || "").toLowerCase().trim() === agentNameLower) {
          foundRole = {
            type: "backup",
            label: "Backup #2",
            color: "#065f46",
            bg: "#d1fae5",
            description: "You ATTEND the meeting but set as 'Away' in Zendesk. Jump in if queue busy.",
            icon: "ðŸ”„"
          };
          foundRotation = rotation;
          break;
        }
        
        // Check LC Agents
        const lcAgents = (rotation.lcAgents || []).map(a => a.toLowerCase().trim());
        if (lcAgents.includes(agentNameLower)) {
          foundRole = {
            type: "lcagent",
            label: "Live Chat Agent",
            color: "#1e40af",
            bg: "#dbeafe",
            description: "You cover Live Chat during the meeting - you will MISS the meeting this week.",
            icon: "ðŸ’¬"
          };
          foundRotation = rotation;
          break;
        }
      }
      
      if (foundRole && foundRotation) {
        const meetingTypeLabel = foundRotation.meetingType === "allhands" ? "All Hands" : 
                                  foundRotation.meetingType === "wednesday" ? "Wednesday Meeting" : "Thursday Meeting";
        
        // Format date as American style (MM/DD/YYYY)
        const formatDateUS = (dateStr) => {
          if (!dateStr) return '';
          const parts = dateStr.split('-');
          if (parts.length === 3) {
            return `${parts[1]}/${parts[2]}/${parts[0]}`;
          }
          return dateStr;
        };
        const formattedDate = formatDateUS(foundRotation.date);
        
        // Update profile modal section (if exists)
        if (sectionEl && containerEl) {
          sectionEl.style.display = "block";
          containerEl.style.background = `linear-gradient(135deg, ${foundRole.bg} 0%, ${foundRole.bg} 100%)`;
          containerEl.style.color = foundRole.color;
          containerEl.innerHTML = `
            <div style="font-weight: 700; font-size: 15px;">${foundRole.icon} You're assigned: ${foundRole.label}</div>
            <div style="margin-top: 8px;">
              <strong>Meeting:</strong> ${meetingTypeLabel}<br>
              <strong>Date:</strong> ${formattedDate}<br>
              <strong>Time:</strong> ${foundRotation.meetingTimePST || foundRotation.meetingTimeEST || 'TBD'} PST
            </div>
            <div style="margin-top: 10px; font-size: 12px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 6px;">
              ${foundRole.description}
            </div>
            ${foundRotation.notes ? `<div style="margin-top: 8px; font-size: 12px;">ðŸ“ ${foundRotation.notes}</div>` : ''}
          `;
        }
        
        // Update dashboard banner
        if (dashboardCard && dashboardBanner) {
          dashboardBanner.style.display = "block";
          dashboardCard.style.display = "block";
          dashboardCard.style.borderLeft = `3px solid ${foundRole.color}`;
          dashboardCard.style.background = foundRole.bg;
          
          if (dashboardIcon) dashboardIcon.textContent = foundRole.icon;
          if (dashboardLabel) {
            dashboardLabel.textContent = foundRole.label;
            dashboardLabel.style.color = foundRole.color;
          }
          if (dashboardDate) {
            dashboardDate.textContent = `${meetingTypeLabel} â€¢ ${formattedDate}`;
            dashboardDate.style.color = foundRole.color;
          }
          if (dashboardDesc) {
            dashboardDesc.textContent = foundRole.description;
            dashboardDesc.style.color = foundRole.color;
          }
        }
      } else {
        if (sectionEl) sectionEl.style.display = "none";
        if (dashboardCard) dashboardCard.style.display = "none";
      }
    } else {
      if (sectionEl) sectionEl.style.display = "none";
      if (dashboardCard) dashboardCard.style.display = "none";
    }
  } catch (err) {
    console.error("Error loading agent rotation info:", err);
    if (sectionEl) sectionEl.style.display = "none";
    if (dashboardCard) dashboardCard.style.display = "none";
  }
}

function closeBalanceModal() {
  $("balanceModal").style.display = "none";
}
function renderBalanceList() {
  const list = $("balanceList");
  const search = ($("balanceSearch").value || "").toLowerCase();
  
  list.innerHTML = "";
  
  _people
    .filter(p => !search || p.toLowerCase().includes(search))
    .forEach(person => {
      const balance = _balanceData.get(person) || {pto: 0};
      const ptoHours = parseFloat(balance.pto) || 0;
      
      // Color coding based on PTO amount
      let ptoColor = '#16a34a'; // Green
      let ptoBg = '#f0fdf4';
      let ptoBorder = '#86efac';
      if (ptoHours <= 0) {
        ptoColor = '#dc2626';
        ptoBg = '#fef2f2';
        ptoBorder = '#fecaca';
      } else if (ptoHours < 8) {
        ptoColor = '#f59e0b';
        ptoBg = '#fef3c7';
        ptoBorder = '#fcd34d';
      }
      
      const item = document.createElement("div");
      item.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--card-bg, #fff); border: 1px solid var(--border-color, #e2e8f0); border-radius: 12px; transition: all 0.2s;";
      item.onmouseover = () => { item.style.borderColor = '#b37e78'; item.style.boxShadow = '0 2px 8px rgba(179,126,120,0.1)'; };
      item.onmouseout = () => { item.style.borderColor = 'var(--border-color, #e2e8f0)'; item.style.boxShadow = 'none'; };
      
      item.innerHTML = `
        <div style="flex: 1;">
          <div style="font-weight: 700; color: var(--text-primary, #1e293b); margin-bottom: 4px; font-size: 14px;">${person}</div>
          <div style="font-size: 12px; color: ${ptoColor}; font-weight: 600;">
            ${ptoHours}h PTO available
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 11px; color: var(--text-secondary, #64748b);">PTO:</span>
          <input type="number" value="${ptoHours}" min="0" step="0.5" 
                 onchange="updateBalance('${person}', 'pto', this.value)"
                 style="width: 70px; padding: 8px 10px; border: 2px solid ${ptoBorder}; border-radius: 8px; text-align: center; font-size: 14px; font-weight: 600; background: ${ptoBg}; color: ${ptoColor};"
                 title="PTO Hours">
          <span style="font-size: 12px; color: var(--text-secondary, #64748b);">hrs</span>
        </div>
      `;
      
      list.appendChild(item);
    });
}
function filterBalanceList() {
  renderBalanceList();
}
async function updateBalance(person, type, value) {
  try {
    const hours = parseFloat(value) || 0;
    
    const res = await fetch('/?action=balances/update', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        person: person,
        type: type,
        hours: hours
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      // Update local cache
      if (!_balanceData.has(person)) {
        _balanceData.set(person, {pto: 0, sick: 0});
      }
      _balanceData.get(person)[type] = hours;
      
      toast(`Updated ${person}'s ${type.toUpperCase()} to ${hours} hours`, "success");
    } else {
      toast(`Failed to update balance`, "error");
    }
  } catch (err) {
    console.error("Update balance error:", err);
    toast(`Error: ${err.message}`, "error");
  }
}
// Load balances when page loads
window.addEventListener('DOMContentLoaded', () => {
  loadBalances();
});

// Bulk PTO Modal Functions
function openBulkPtoModal() {
  const modal = $("bulkPtoModal");
  if (!modal) return;

  // Reset form
  if ($("bulkPtoHours")) $("bulkPtoHours").value = "1";
  if ($("bulkPtoReason")) $("bulkPtoReason").value = "";

  // Update agent count
  const activeAgents = (_people || []).filter(p => p && String(p).trim());
  if ($("bulkPtoAgentCount")) $("bulkPtoAgentCount").textContent = String(activeAgents.length);

  // Show (stacked above Admin/PTO)
  modal.style.display = "flex";
  modal.style.zIndex = "10060";
}


function closeBulkPtoModal() {
  const modal = $("bulkPtoModal");
  if (modal) modal.style.display = "none";
}

async function applyBulkPto() {
  const hours = parseFloat($("bulkPtoHours")?.value) || 0;
  const reason = $("bulkPtoReason")?.value || "Bulk PTO addition";
  
  if (hours <= 0) {
    toast("Please enter a valid number of hours", "error");
    return;
  }
  
  const activeAgents = _people.filter(p => p && p.trim());
  
  if (activeAgents.length === 0) {
    toast("No agents found", "error");
    return;
  }
  
  const confirmed = await Swal.fire({
    title: 'Confirm Bulk PTO',
    html: `<div style="text-align:center;">
      <p>Add <strong>${hours} hours</strong> to <strong>${activeAgents.length} agents</strong>?</p>
      <p style="font-size:12px; color:#64748b; margin-top:8px;">${reason}</p>
    </div>`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#22c55e',
    cancelButtonColor: '#94a3b8',
    confirmButtonText: 'Yes, Add Hours',
    cancelButtonText: 'Cancel'
  });
  
  if (!confirmed.isConfirmed) return;
  
  Swal.fire({
    title: 'Applying...',
    text: `Adding ${hours} hours to all agents`,
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => Swal.showLoading()
  });
  
  let successCount = 0;
  let errors = [];
  
  for (const person of activeAgents) {
    try {
      const currentBalance = _balanceData.get(person) || { pto: 0 };
      const newPto = parseFloat(currentBalance.pto || 0) + hours;
      
      const res = await fetch('/?action=balances/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          person: person,
          type: 'pto',
          hours: newPto
        })
      });
      
      const data = await res.json();
      
      if (data.ok) {
        // Update local cache
        if (!_balanceData.has(person)) {
          _balanceData.set(person, { pto: 0 });
        }
        _balanceData.get(person).pto = newPto;
        successCount++;
      } else {
        errors.push(person);
      }
    } catch (err) {
      errors.push(person);
    }
  }
  
  // Log to audit
  try {
    await fetch('/?action=audit/log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'BULK_PTO_ADD',
        manager: window._myName || 'Unknown',
        target: `All Agents (${successCount})`,
        details: `Added ${hours} hours PTO. Reason: ${reason}`,
        date: new Date().toISOString().split('T')[0]
      })
    });
  } catch (err) {
    console.error("Failed to log audit:", err);
  }
  
  closeBulkPtoModal();
  
  if (errors.length === 0) {
    Swal.fire({
      icon: 'success',
      title: 'PTO Added!',
      html: `<p>Added ${hours} hours to ${successCount} agents</p>`,
      confirmButtonColor: '#22c55e'
    });
  } else {
    Swal.fire({
      icon: 'warning',
      title: 'Partially Complete',
      html: `<p>Added to ${successCount} agents</p><p>Failed for: ${errors.join(', ')}</p>`,
      confirmButtonColor: '#f59e0b'
    });
  }
}
  
  function updateTeamAgentList() { 
  const t = $("teamDropdown").value; 
  const agentList = $("teamAgentList");
  agentList.innerHTML = ""; 
  // Update global active team
  _activeTeam = t;
  _selectedPeople.clear();
  
  // Apply the filters to the data
  applyLocalFilters(); 
  // Create the "Quick Filter" chips in the sidebar
  if (t) {
    const agentsInChannel = [... new Set(
      _allData.filter(x => x.team === t).map(x => x.person)
    )].sort();
    
    agentsInChannel.forEach(p => { 
      const b = document.createElement("button"); 
      b.className = "btn-pill"; 
      b.innerText = p; 
      b.onclick = () => {
        _selectedPeople.clear();
        _selectedPeople.add(p);
        applyLocalFilters();
        showToast(`Filtered to ${p}`);
      };
      agentList.appendChild(b); 
    }); 
  }
  
  // Re-render the view
  renderView();
}
  // Helper:  escape HTML to prevent XSS
function escapeHtml(str) {
  if (!str) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}
function rgbaFromHex(hex, alpha) {
  try {
    const h = String(hex || "").trim().replace("#", "");
    const full = h.length === 3 ? h.split("").map(c => c + c).join("") : h;
    const n = parseInt(full, 16);
    if (!isFinite(n) || full.length !== 6) throw new Error("bad hex");
    const r = (n >> 16) & 255, g = (n >> 8) & 255, b = n & 255;
    const a = Math.max(0, Math.min(1, Number(alpha)));
    return `rgba(${r}, ${g}, ${b}, ${a})`;
  } catch {
    return `rgba(148, 163, 184, ${alpha || 0.2})`;
  }
}

  function filterToday() {
    const today = pstISODate();
    _filteredData = _allData.filter(x => x.dateISO === today);
    if (_activeTeam) {
        _filteredData = _filteredData.filter(x => x.team === _activeTeam);
    }
    if (_selectedPeople.size > 0) {
        _filteredData = _filteredData.filter(x => _selectedPeople.has(x.person));
    }
    renderView();
    toast("Showing Today Only");
    if (_view === 'calendar') {
        setView('list');
    }
  }
  function setView(v) {
  // 1. ðŸš¨ AUTO-EXIT MASTER MODE
  // If we are currently editing the template, force an exit before switching views
  if (typeof _isMasterMode !== 'undefined' && _isMasterMode) {
    exitMasterMode();
  }
  _view = v;
  
  // Toggle Buttons
  const btnSched = document.getElementById("btnSchedule");
  const btnGoals = document.getElementById("btnGoals");
  const btnMet = document.getElementById("btnMetrics");
  if(btnSched) btnSched.className = v === "schedule" ? "segBtn active" : "segBtn";
  if(btnGoals) btnGoals.className = v === "goals" ? "segBtn active" : "segBtn";
  if(btnMet) btnMet.className = v === "metrics" ? "segBtn active" : "segBtn";
  
  // Toggle Views
  const schedView = document.getElementById("scheduleView");
  const goalsView = document.getElementById("goalsView");
  const metView = document.getElementById("metricsView");
  const masterView = document.getElementById("masterView");
  const agentGoalsView = document.getElementById("agentGoalsView");
  
  if(schedView) schedView.style.display = v === "schedule" ? "flex" : "none";
  if(goalsView) goalsView.style.display = v === "goals" ? "flex" : "none";
  if(metView) metView.style.display = v === "metrics" ? "block" : "none";
  if(agentGoalsView) agentGoalsView.style.display = v === "mygoals" ? "block" : "none";
  
  // Ensure Master View is hidden
  if(masterView) masterView.style.display = "none";
  
  if (v === "schedule") {
    renderScheduleView();
  } else if (v === "metrics") {
    renderMetricsList();
  } else if (v === "goals") {
    renderGoalsAgentList();
  } else if (v === "mygoals") {
    loadMyGoals();
  }
}

// Cache for meeting rotations
let _meetingRotationsCache = {};
let _meetingRotationsCacheTime = 0;
window._meetingRotationsCache = _meetingRotationsCache;

// Check and display meeting banner for a specific date
async function checkAndDisplayMeetingBanner(dateKey, container) {
  // Check cache (refresh every 5 minutes)
  const now = Date.now();
  if (now - _meetingRotationsCacheTime > 300000 || Object.keys(_meetingRotationsCache).length === 0) {
    try {
      const res = await fetch('/meeting-rotation/list');
      const data = await res.json();
      if (data.rotations) {
        _meetingRotationsCache = {};
        data.rotations.forEach(r => {
          _meetingRotationsCache[r.date] = r;
        });
        _meetingRotationsCacheTime = now;
        // Update global reference
        window._meetingRotationsCache = _meetingRotationsCache;
        
        // Check if agent needs to acknowledge meeting rotation
        if (typeof window.checkMeetingRotationAcknowledgment === 'function' && !window._isManager) {
          setTimeout(() => window.checkMeetingRotationAcknowledgment(), 500);
        }
      }
    } catch (e) {
      console.error("Failed to fetch meeting rotations:", e);
    }
  }
  
  const meeting = _meetingRotationsCache[dateKey];
  const isManager = window._isManager;
  
  // Check if this is a meeting day (Thursday/Wednesday/All Hands day)
  const d = new Date(dateKey + "T12:00:00");
  const dayOfWeek = d.getDay(); // 0=Sun, 1=Mon... 4=Thu
  const isMeetingDay = dayOfWeek === 4; // Thursday
  
  // If no meeting rotation exists but it's a meeting day, show a warning banner for managers
  if (!meeting && isManager && isMeetingDay) {
    const warningBanner = document.createElement("div");
    warningBanner.className = "meeting-day-banner meeting-unconfigured";
    warningBanner.style.cssText = `
      background: linear-gradient(135deg, rgba(239,68,68,0.15) 0%, rgba(239,68,68,0.08) 100%);
      border: 2px dashed #ef4444;
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 16px;
      animation: pulse 2s infinite;
      cursor: pointer;
    `;
    warningBanner.onclick = () => openMeetingRotationModal();
    warningBanner.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 24px;">âš ï¸</span>
          <div>
            <div style="font-weight: 700; font-size: 14px; color: #dc2626;">Meeting Rotation Not Configured</div>
            <div style="font-size: 12px; color: #ef4444;">Thursday meeting needs LC coverage setup</div>
          </div>
        </div>
        <button style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
          âš™ï¸ Configure Now
        </button>
      </div>
    `;
    container.insertBefore(warningBanner, container.firstChild);
    return;
  }
  
  if (!meeting) return;
  
  const myName = window._myName || "";
  const myNameLower = myName.toLowerCase().trim();
  
  // Determine user's role in this meeting
  let myRole = null;
  let roleColor = isManager ? "#f59e0b" : "#6366f1"; // Manager gets yellow, default blue
  let roleEmoji = "ðŸ“…";
  
  if ((meeting.captain || "").toLowerCase().trim() === myNameLower) {
    myRole = "Captain (Attends Meeting - Last Resort)";
    roleColor = "#f59e0b";
    roleEmoji = "ðŸ‘¤";
  } else if ((meeting.backup1 || "").toLowerCase().trim() === myNameLower) {
    myRole = "Backup #1 (Attends Meeting - Away in Zendesk)";
    roleColor = "#10b981";
    roleEmoji = "ðŸ”„";
  } else if ((meeting.backup2 || "").toLowerCase().trim() === myNameLower) {
    myRole = "Backup #2 (Attends Meeting - Away in Zendesk)";
    roleColor = "#10b981";
    roleEmoji = "ðŸ”„";
  } else if ((meeting.lcAgents || []).map(a => a.toLowerCase().trim()).includes(myNameLower)) {
    myRole = "LC Agent (Misses Meeting - LC Coverage)";
    roleColor = "#3b82f6";
    roleEmoji = "ðŸ’¬";
  }
  
  const meetingTypeLabel = meeting.meetingType === "allhands" ? "All Hands" : 
                           meeting.meetingType === "wednesday" ? "Wednesday Meeting" : "Thursday Meeting";
  const meetingEmoji = meeting.meetingType === "allhands" ? "ðŸŽ‰" : "ðŸ“…";
  
  // Create meeting banner - make it more prominent for managers
  const banner = document.createElement("div");
  banner.className = "meeting-day-banner";
  
  if (isManager) {
    // Manager view: More prominent, clickable, shows full details
    banner.style.cssText = `
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-left: 5px solid #f59e0b;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
      cursor: pointer;
      transition: all 0.2s ease;
    `;
    banner.onclick = () => { 
      $("rotationDate").value = dateKey;
      openMeetingRotationModal();
    };
    banner.onmouseenter = function() { this.style.transform = 'translateY(-2px)'; this.style.boxShadow = '0 6px 16px rgba(245, 158, 11, 0.3)'; };
    banner.onmouseleave = function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 4px 12px rgba(245, 158, 11, 0.2)'; };
  } else {
    // Agent view: Simpler display
    banner.style.cssText = `
      background: linear-gradient(135deg, ${roleColor}15 0%, ${roleColor}08 100%);
      border: 1px solid ${roleColor}40;
      border-left: 4px solid ${roleColor};
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
    `;
  }
  
  // Build banner content
  let bannerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">${meetingEmoji}</span>
        <div>
          <div style="font-weight: 700; font-size: 14px; color: ${isManager ? '#92400e' : 'var(--text-primary)'};">${meetingTypeLabel}</div>
          <div style="font-size: 12px; color: ${isManager ? '#b45309' : 'var(--text-secondary)'};">${meeting.meetingTimePST || "12:00 PM - 1:15 PM"} PST</div>
        </div>
      </div>`;
  
  // Show user's role badge or edit button for managers
  if (isManager) {
    bannerHTML += `
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600;">âœ“ Configured</span>
        <span style="background: #f59e0b; color: white; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600;">âœï¸ Edit</span>
      </div>`;
  } else if (myRole) {
    bannerHTML += `
      <div style="background: ${roleColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
        ${roleEmoji} ${myRole.split('(')[0].trim()}
      </div>`;
  }
  
  bannerHTML += `</div>`;
  
  // Show coverage team (for managers or if user wants details)
  if (isManager) {
    const lcCount = (meeting.lcAgents || []).length;
    const lcNames = (meeting.lcAgents || []).slice(0, 3).join(', ') + (lcCount > 3 ? ` +${lcCount - 3} more` : '');
    bannerHTML += `
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(245, 158, 11, 0.3); font-size: 12px; color: #78350f;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
          <div><span style="opacity: 0.7;">ðŸ‘¤ Captain:</span> <strong>${meeting.captain || '-'}</strong></div>
          <div><span style="opacity: 0.7;">ðŸ”„ Backup 1:</span> <strong>${meeting.backup1 || '-'}</strong></div>
          <div><span style="opacity: 0.7;">ðŸ”„ Backup 2:</span> <strong>${meeting.backup2 || '-'}</strong></div>
          <div><span style="opacity: 0.7;">ðŸ’¬ LC (${lcCount}):</span> <strong>${lcNames || '-'}</strong></div>
        </div>
        ${meeting.notes ? `<div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 6px;"><span style="opacity: 0.7;">ðŸ“ Notes:</span> ${meeting.notes}</div>` : ''}
      </div>`;
  } else if (myRole) {
    // For agents with a role, show brief coverage info
    bannerHTML += `
      <div style="margin-top: 8px; font-size: 10px; color: var(--text-tertiary);">
        Coverage team: ${meeting.captain || '-'}, ${meeting.backup1 || '-'}, ${meeting.backup2 || '-'}${(meeting.lcAgents || []).length > 0 ? ` + ${meeting.lcAgents.length} LC agents` : ''}
      </div>`;
  }
  
  banner.innerHTML = bannerHTML;
  container.insertBefore(banner, container.firstChild);
}

let _selectedDateISO = null;
function renderScheduleView() {
  // Hide loading placeholder since we're rendering
  if ($("loadingPlaceholder")) $("loadingPlaceholder").style.display = "none";
  
  // 1. Get unique days from data
  const groups = groupShifts(_filteredData); // Reuse your existing grouper
  const sortedDates = Array.from(groups.keys()).sort(); // ["2025-01-06", "2025-01-07"...]
  if (sortedDates.length === 0) {
    document.getElementById("dayTabs").innerHTML = "";
    document.getElementById("viewDayTitle").textContent = "No Schedule";
    document.getElementById("viewDayStats").textContent = "";
    document.getElementById("dayContentBody").innerHTML = `
      <div style="text-align:center; color:#94a3b8; margin-top:50px;">
        <svg style="width:48px; height:48px; margin-bottom:12px; opacity:0.5;" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/>
        </svg>
        <div style="font-size:15px; font-weight:600;">No shifts found</div>
        <div style="font-size:13px; margin-top:4px;">Try adjusting your filters or loading more days</div>
      </div>`;
    return;
  }
  // Default to first day if none selected
  if (!_selectedDateISO || !groups.has(_selectedDateISO)) {
    _selectedDateISO = sortedDates[0];
  }
  // 2. Render Tabs (Left Sidebar)
  const tabsContainer = document.getElementById("dayTabs");
  tabsContainer.innerHTML = sortedDates.map(dateKey => {
    const d = new Date(dateKey + "T12:00:00"); // Safe parsing
    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
    const dayDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const isActive = dateKey === _selectedDateISO ? 'active' : '';
    return `
      <div class="day-tab ${isActive}" onclick="_selectedDateISO = '${dateKey}'; renderScheduleView();">
        <div class="day-name">${dayName}</div>
        <div class="day-date">${dayDate}</div>
      </div>
    `;
  }).join("");
  // 3. Render Main Content (Right Side)
  renderDayDetail(_selectedDateISO, groups.get(_selectedDateISO));
}
function renderDayDetail(dateKey, shifts) {
  // 1. Setup Date & Holiday Logic
  const d = new Date(dateKey + "T12:00:00");
  const dayOfWeek = d.toLocaleDateString("en-US", { weekday: 'short' });
  const holiday = getHoliday(dateKey); 
  
  // Holiday theme configurations
  const holidayThemes = {
    christmas: { bg: 'linear-gradient(135deg, #166534 0%, #15803d 50%, #dc2626 100%)', badge: '#dcfce7', badgeText: '#166534', emoji: 'ðŸŽ„' },
    newyear: { bg: 'linear-gradient(135deg, #1e40af 0%, #7c3aed 100%)', badge: '#e0e7ff', badgeText: '#4338ca', emoji: 'ðŸŽ†' },
    thanksgiving: { bg: 'linear-gradient(135deg, #c2410c 0%, #ea580c 100%)', badge: '#ffedd5', badgeText: '#c2410c', emoji: 'ðŸ¦ƒ' },
    halloween: { bg: 'linear-gradient(135deg, #1e1e1e 0%, #f97316 100%)', badge: '#fff7ed', badgeText: '#c2410c', emoji: 'ðŸŽƒ' },
    july4th: { bg: 'linear-gradient(135deg, #1e40af 0%, #dc2626 50%, #1e40af 100%)', badge: '#dbeafe', badgeText: '#1e40af', emoji: 'ðŸ‡ºðŸ‡¸' },
    valentines: { bg: 'linear-gradient(135deg, #be185d 0%, #ec4899 100%)', badge: '#fce7f3', badgeText: '#be185d', emoji: 'ðŸ’•' },
    stpatricks: { bg: 'linear-gradient(135deg, #166534 0%, #22c55e 100%)', badge: '#dcfce7', badgeText: '#166534', emoji: 'â˜˜ï¸' },
    easter: { bg: 'linear-gradient(135deg, #a855f7 0%, #ec4899 50%, #fbbf24 100%)', badge: '#faf5ff', badgeText: '#7e22ce', emoji: 'ðŸ°' },
    default: { bg: 'linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%)', badge: '#e0e7ff', badgeText: '#4338ca', emoji: 'ðŸŽ‰' }
  };
  
  // Get header element to update background
  const dayHeader = document.querySelector('.day-content-header');
  
  // Title
  let titleHtml = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  
  if (holiday) {
    const theme = holidayThemes[holiday.theme] || holidayThemes.default;
    titleHtml += ` <span style="font-size:13px; background:${theme.badge}; color:${theme.badgeText}; padding:4px 12px; border-radius:20px; border:1px solid rgba(0,0,0,0.1); margin-left:10px; animation:pulse 2s infinite;">${holiday.emoji} ${holiday.name}</span>`;
    
    // Update header background for holiday
    if (dayHeader) {
      dayHeader.style.background = theme.bg;
      dayHeader.style.color = 'white';
      dayHeader.style.transition = 'all 0.5s ease';
    }
  } else {
    // Reset to default
    if (dayHeader) {
      dayHeader.style.background = 'var(--header-gradient, linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%))';
      dayHeader.style.color = 'white';
    }
  }
  
  document.getElementById("viewDayTitle").innerHTML = titleHtml;
  document.getElementById("viewDayStats").textContent = `${shifts.length} shifts scheduled`;
  const container = document.getElementById("dayContentBody");
  container.innerHTML = "";
  
  // Check for meeting on this day and add banner
  checkAndDisplayMeetingBanner(dateKey, container);
  
  // 2. Group by Channel (normalize team names to group variations together)
  const byTeam = {};
  const teamDisplayNames = {};
  shifts.forEach(s => {
    const rawTeam = s.team || "Other";
    // Normalize to group variations together (Email/Floater, EmailFloater, Email-Floater all become "emailfloater")
    const normalizedKey = normalizeChannelName(rawTeam);
    if (!byTeam[normalizedKey]) {
      byTeam[normalizedKey] = [];
      // Store the best display name (prefer proper capitalization)
      teamDisplayNames[normalizedKey] = getCanonicalDisplayName(rawTeam);
    }
    byTeam[normalizedKey].push(s);
  });
  
  // Helper to get proper display name
  function getCanonicalDisplayName(team) {
    const key = normalizeChannelName(team);
    const displayMap = {
      'livechat': 'Live Chat',
      'phone': 'Phone Support',
      'phonesupport': 'Phone Support',
      'emailfloater': 'Email/Floater',
      'floater': 'Email/Floater',
      'socials': 'Socials',
      'disputes': 'Disputes',
      'mdsupport': 'MD Support',
      'projects': 'Projects',
      'lunch': 'Lunch',
      '1:1meetings': '1:1 Meetings',
      'meeting': 'Meeting',
      'defcon': 'Defcon',
      'custom': 'Custom',
      'other': 'Other'
    };
    return displayMap[key] || team;
  }
  
  // 3. Render Sections
  Object.keys(byTeam).sort().forEach(teamKey => {
    const teamShifts = byTeam[teamKey];
    const team = teamDisplayNames[teamKey]; // Use display name for UI
    const count = teamShifts.length;
    
    // Alert Logic - Check if any rule applies to this day
    const isWeekday = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].includes(dayOfWeek);
    const isWeekend = ['Sat', 'Sun'].includes(dayOfWeek);
    const rule = _staffingRules.find(r => {
      if (r.team !== team) return false;
      return r.day === "All" || 
             r.day === dayOfWeek ||
             (r.day === 'Weekday' && isWeekday) ||
             (r.day === 'Weekend' && isWeekend);
    });
    const config = getChannelConfig(team);
const accent = (config.border || "#cbd5e1");
const accentBg = rgbaFromHex(accent, document.body.classList.contains("dark-mode") ? 0.18 : 0.28);
    let countBadge = "";
    
    // Only show staffing count badge to managers
    if (window._isManager) {
      if (rule) {
        const min = parseInt(rule.min);
        countBadge = (count < min)
  ? `<span class="countBadge warn">âš ï¸ ${count}/${min}</span>`
  : `<span class="countBadge ok">âœ“ ${count}/${min}</span>`;
      } else {
        countBadge = `<span class="countBadge neutral">${count} Agents</span>`;
      }
    } else {
      // For agents, just show simple count
      countBadge = `<span class="countBadge agent">${count} scheduled</span>`;
    }
    // Sort shifts
    teamShifts.sort((a, b) => (a.start || "").localeCompare(b.start || ""));
    const section = document.createElement("div");
    section.className = "channel-section";
    
    // Apply view preference
    const prefs = typeof getUserPrefs === 'function' ? getUserPrefs() : { shiftView: 'grid' };
    const viewClass = prefs.shiftView === 'list' ? 'shifts-grid view-list' : 'shifts-grid';
    
    section.innerHTML = `
  <div class="channel-header" style="--ch-accent:${accent}; --ch-accent-bg:${accentBg};">
    <span class="channel-title">${team}</span>
    ${countBadge}
  </div>
  <div class="${viewClass}"></div>
`;
    const grid = section.querySelector(".shifts-grid");
    
    teamShifts.forEach(shift => {
  const notesStr = String(shift.notes || "");
  const isOff = notesStr.toLowerCase().includes("[off]");
  const isOpen = String(shift.person || "").trim().toUpperCase() === "OPEN"
             || notesStr.toUpperCase().includes("[OPEN]");

  const displayName = isOpen ? "Open" : (shift.person || "");
  const displayRole = isOpen ? "Open Shift" : (shift.role || "");

  const card = document.createElement("div");
  card.className = "shift-card-b";

  if (isOff) card.classList.add("is-off");
if (isOpen) card.classList.add("is-open");
      
      // Check if selected (for bulk actions)
      if (_teamSelected.has(String(shift.assignmentId))) {
    card.style.outline = "2px solid #b37e78";
    card.style.zIndex = "10";
  }
      // Styling
      if (isOff) {
    card.style.borderLeftColor = "#ef4444";
    card.style.background = "#fef2f2";
    card.style.opacity = "0.8";
  } else if (isOpen) {
    card.style.borderLeftColor = "#f59e0b";
  } else {
    card.style.borderLeftColor = (config.border || "#cbd5e1");
  }
      card.innerHTML = `
    <div class="sc-time">
      <span>${shift.startLabel} - ${shift.endLabel}</span>
      ${
        isOff
          ? '<span style="color:#ef4444; font-weight:800; font-size:10px;">OFF</span>'
          : isOpen
            ? '<span style="color:#f59e0b; font-weight:900; font-size:10px;">OPEN</span>'
            : ''
      }
    </div>

    <div class="sc-name">${displayName}</div>

    ${displayRole ? `<div class="sc-role">${displayRole}</div>` : ''}

    ${notesStr && !isOff ? `<div style="font-size:11px; color:var(--text-secondary); margin-top:6px; font-style:italic;">${notesStr}</div>` : ''}
  `;

      // --- ðŸš¨ RESTORED INTERACTIONS ---
      
      // 1. Click Handler (Smart switching between Edit vs. Select)
      card.onclick = (e) => {
        if (window._isManager) {
          // If in "Channel" mode OR holding Shift key OR already selecting items -> Toggle Selection
          if (_mode === "team" || _teamSelected.size > 0 || e.shiftKey) {
            // We reuse your existing toggle logic, but adapt UI manually since 'selected' class works differently here
            const id = String(shift.assignmentId);
            if (_teamSelected.has(id)) {
                _teamSelected.delete(id);
                card.style.outline = "none";
            } else {
                _teamSelected.add(id);
                card.style.outline = "2px solid #b37e78";
                _lastSelectedPerson = shift.person;
            }
            updateSelectionBar();
          } else {
            // Otherwise -> Open Edit Modal
            openReplaceModal(shift);
          }
        } else if (shift.person === window._myName) {
          openAgentActionModal(shift);
        }
      };
      // 2. Drag and Drop (Managers Only)
      if (window._isManager) {
          card.draggable = true;
          
          card.ondragstart = (e) => { 
             // Prevent dragging purely for visual noise, we only want drag *into* cards usually
             // But if you want to drag shifts, keep this. 
             e.preventDefault(); 
          }; 
          
          // Allow dropping names from the Quick Sidebar onto this card
          card.ondragover = (e) => { 
             if(_mode === "quick" && _dragPerson) { 
                 e.preventDefault(); 
                 card.style.background = "#eff6ff"; // Highlight on hover
                 card.style.borderColor = "#b37e78";
             } 
          };
          
          card.ondragleave = () => { 
             // Reset styles on leave
             card.style.background = isOff ? "#fef2f2" : "white";
             card.style.borderColor = "#e2e8f0";
             card.style.borderLeftColor = isOff ? "#ef4444" : (config.border || "#cbd5e1");
          };
          
          card.ondrop = (e) => { 
             e.preventDefault(); 
             // Reset styles
             card.style.background = isOff ? "#fef2f2" : "white";
             card.style.borderColor = "#e2e8f0";
             card.style.borderLeftColor = isOff ? "#ef4444" : (config.border || "#cbd5e1");
             if(_dragPerson && _dragPerson !== shift.person) { 
                 // Open modal pre-filled with dragged name
                 _editing = shift; 
                 openReplaceModal(shift); 
                 setTimeout(() => {
                     const select = document.getElementById("mNewPerson");
                     if(select) select.value = _dragPerson;
                 }, 50); 
             } 
          };
      }
      // --------------------------------
      grid.appendChild(card);
    });
    container.appendChild(section);
  });
}
function exitMasterMode() {
  _isMasterMode = false;
  const btn = document.getElementById("btnMasterMode");
  const title = document.querySelector(".hTitle");
  const contextPill = document.getElementById("managerContextPill");

  if (btn) {
    btn.innerText = "Edit Master Schedule";
    btn.style.backgroundColor = "";
    btn.style.color = "";
  }
  if (title) title.innerText = "Scheduling Manager";
  if (contextPill) {
    if (_currentManagerName) {
      contextPill.innerText = "Viewing: " + _currentManagerName;
      contextPill.style.backgroundColor = "#a45953";
      contextPill.style.borderColor = "#6b21a8";
    } else {
      contextPill.style.display = "none";
    }
  }

  // âœ… Reset master draft/edit state
  _masterOriginalData = null;
  _masterDraftData = null;
  _masterRawData = null;
  _masterEditEnabled = false;

  if (typeof _masterSelected !== "undefined" && _masterSelected && _masterSelected.clear) {
    _masterSelected.clear();
  }
  updateMasterSelectionBar?.();

  const mv = document.getElementById("masterView");
  if (mv) mv.innerHTML = "";
}

  function resetAllFilters() {
    _activeTeam = '';
    _selectedPeople.clear();
    const teamDropdown = document.getElementById('teamDropdown');
    if (teamDropdown) teamDropdown.value = '';
    
    const calWrapper = document.getElementById('calViewWrapper');
    if (calWrapper) {
        const calGrid = $("calView");
        if (calGrid) calGrid.classList.remove('channel-filtered');
    }
    
    applyLocalFilters();
}
  function scrollCal(px) { const el=$("calView"); if(el) el.scrollBy({left:px,behavior:"smooth"}); }
  // --- NOTIFICATION SOUND ---
  function playNotificationSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const osc1 = audioCtx.createOscillator();
    const gain1 = audioCtx.createGain();
    osc1.connect(gain1);
    gain1.connect(audioCtx.destination);
    osc1.type = "sine";
    osc1.frequency.setValueAtTime(800, now); 
    gain1.gain.setValueAtTime(0.1, now);
    gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
    osc1.start(now);
    osc1.stop(now + 0.3);
    const osc2 = audioCtx.createOscillator();
    const gain2 = audioCtx.createGain();
    osc2.connect(gain2);
    gain2.connect(audioCtx.destination);
    osc2.type = "sine";
    osc2.frequency.setValueAtTime(600, now + 0.1); 
    gain2.gain.setValueAtTime(0.1, now + 0.1);
    gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.6); 
    osc2.start(now + 0.1);
    osc2.stop(now + 0.6);
  }
  function playSendSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const playTone = (freq, delay) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = "triangle"; 
        osc.frequency.setValueAtTime(freq, now + delay);
        osc.frequency.exponentialRampToValueAtTime(freq * 1.5, now + delay + 0.4);
        gain.gain.setValueAtTime(0, now + delay);
        gain.gain.linearRampToValueAtTime(0.15, now + delay + 0.05); 
        gain.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.4); 
        osc.start(now + delay);
        osc.stop(now + delay + 0.5);
    };
    playTone(440, 0);   
    playTone(659, 0.05); 
  }
  // ============================================
// INITIALIZATION - Runs when page loads
// ============================================
document.addEventListener("DOMContentLoaded", function() {
  console.log("Musely Scheduler: Loaded");
  // 1. Initialize notification badge as hidden
  const badge = document.getElementById("notifCount");
  if (badge) {
    badge.classList.add("hidden");
    badge.textContent = "0";
  }
  // 2. Setup notification button
  const btn = document.getElementById("btnNotif");
  const panel = document.getElementById("notifPanel");
  if (!btn) {
    console.warn("btnNotif not found");
    return;
  }
  if (!panel) {
    console.warn("notifPanel not found");
    return;
  }
  // Move panel to body to prevent z-index issues
  if (panel.parentElement !== document.body) {
    document.body.appendChild(panel);
  }
  // Ensure hidden by default
  panel.style.display = "none";
  // Style the button to be clickable
  btn.style.pointerEvents = "auto";
  btn.style.cursor = "pointer";
  // Single click handler for notification button
  btn.addEventListener("click", function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log("Notification button clicked!");
    toggleNotifPanel();
  }, true);
  // Click-away to close panel
  document.addEventListener("click", function(e) {
    if (panel.style.display !== "block") return;
    if (e.target.closest("#btnNotif") || e.target.closest("#notifPanel")) return;
    toggleNotifPanel(true);
  }, true);

});

/* ============================================================ */
/* GOALS WORKSPACE â€” MODERNIZED FRONTEND JS                     */
/* Replaces original goals JS block (~lines 18725-19350+)       */
/* ============================================================ */

// â”€â”€ State â”€â”€
let _currentGoalsAgent = null;
let _currentGoalsData = null;
let _goalsUnsavedChanges = false;
let _editingGoalIndex = null;  // null = new, number = editing
let _editingTaskIndex = null;
let _editingCsatIndex = null;

// â”€â”€ Zendesk Ticket Linking â”€â”€
const ZENDESK_BASE_URL = 'https://musely.zendesk.com/agent/tickets/';

function formatTicketLink(ticketNumber, text) {
  if (!ticketNumber) return text || 'â€”';
  const num = ticketNumber.toString().replace(/[^0-9]/g, '');
  if (!num) return escapeHtml(ticketNumber);
  return `<a href="${ZENDESK_BASE_URL}${num}" target="_blank" rel="noopener" class="ticket-link" onclick="event.stopPropagation();">#${num}</a>`;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// B1 â€” DATA MODEL MIGRATION
// Transforms old fixed Goal #1/#2 â†’ array model
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function migrateGoalsData(data) {
  // Already migrated if goals have `id` fields
  if (data.smartGoals && data.smartGoals.length > 0 && data.smartGoals[0].id) {
    return data;
  }

  // Migrate old smartGoals (array of {specific, measurable, ...}) â†’ new shape
  if (data.smartGoals && Array.isArray(data.smartGoals)) {
    data.smartGoals = data.smartGoals
      .filter(g => g.specific || g.measurable || g.attainable || g.relevant || g.timeBound)
      .map((g, i) => ({
        id: 'goal_' + Date.now() + '_' + i,
        title: g.specific ? g.specific.substring(0, 80) : `Goal #${i + 1}`,
        status: 'active',
        dueDate: '',
        reviewCadence: '',
        nextCheckInDate: '',
        specific: g.specific || '',
        measurable: g.measurable || '',
        attainable: g.attainable || '',
        relevant: g.relevant || '',
        timeBound: g.timeBound || '',
        createdAt: data.updatedAt || new Date().toISOString(),
        updatedAt: data.updatedAt || new Date().toISOString()
      }));
  }

  // Migrate tasks â†’ add id, status normalization
  if (data.tasks && Array.isArray(data.tasks)) {
    data.tasks = data.tasks.map((t, i) => ({
      id: t.id || 'task_' + Date.now() + '_' + i,
      title: t.task || t.title || '',
      priority: t.priority || '',
      dueDate: t.dueDate || '',
      status: t.status || 'open',
      notes: t.notes || '',
      createdAt: t.createdAt || new Date().toISOString(),
      updatedAt: t.updatedAt || new Date().toISOString()
    }));
  }

  // Initialize CSAT follow-ups if absent
  if (!data.csatFollowups) {
    data.csatFollowups = [];
  }

  // Initialize meeting follow-ups if absent
  if (!data.meetingFollowups) {
    data.meetingFollowups = [];
  }

  return data;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR â€” Agent List
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function renderGoalsAgentList() {
  const container = document.getElementById('goalsAgentList');
  if (!container) return;

  container.innerHTML = '<div class="timeline-loading">Loading agents...</div>';

  try {
    const attRes = await fetch('/attendance/all?days=90');
    const attData = await attRes.json();
    const attendanceMap = new Map();
    if (attData.ok && attData.attendance) {
      attData.attendance.forEach(a => attendanceMap.set(a.agentName, a));
    }

    const people = _people || [];
    let html = '';

    people.forEach(name => {
      const attendance = attendanceMap.get(name) || {};
      const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      let badge = '';
      if (attendance.concernLevel === 'critical') {
        badge = '<span class="goals-agent-badge critical">Critical</span>';
      } else if (attendance.concernLevel === 'serious') {
        badge = '<span class="goals-agent-badge serious">Serious</span>';
      } else if (attendance.concernLevel === 'concern') {
        badge = '<span class="goals-agent-badge concern">Concern</span>';
      } else if (attendance.concernLevel === 'watch') {
        badge = '<span class="goals-agent-badge watch">Watch</span>';
      }

      html += `
        <div class="goals-agent-item" data-agent="${escapeHtml(name)}" onclick="selectGoalsAgent('${escapeHtml(name)}')">
          <div class="goals-agent-avatar">${initials}</div>
          <div class="goals-agent-item-info">
            <div class="goals-agent-item-name">${escapeHtml(name)}</div>
            <div class="goals-agent-item-meta">Bradford: ${attendance.bradfordFactor || 0}</div>
          </div>
          ${badge}
        </div>
      `;
    });

    container.innerHTML = html || '<div class="timeline-loading">No agents found</div>';
  } catch (err) {
    console.error('Error loading goals agent list:', err);
    container.innerHTML = '<div class="timeline-loading">Error loading agents</div>';
  }
}

function filterGoalsAgentList() {
  const search = document.getElementById('goalsAgentSearch')?.value?.toLowerCase() || '';
  const items = document.querySelectorAll('.goals-agent-item');
  items.forEach(item => {
    const name = item.dataset.agent?.toLowerCase() || '';
    item.style.display = name.includes(search) ? 'flex' : 'none';
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENT SELECTION + LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function selectGoalsAgent(agentName) {
  if (_goalsUnsavedChanges) {
    const result = await Swal.fire({
      title: 'Unsaved Changes',
      text: 'You have unsaved changes. Do you want to save them before switching?',
      icon: 'warning',
      showCancelButton: true,
      showDenyButton: true,
      confirmButtonText: 'Save',
      denyButtonText: "Don't Save",
      cancelButtonText: 'Cancel'
    });

    if (result.isConfirmed) {
      await saveAgentGoals();
    } else if (result.isDismissed) {
      return;
    }
  }

  _currentGoalsAgent = agentName;
  _goalsUnsavedChanges = false;

  document.querySelectorAll('.goals-agent-item').forEach(item => {
    item.classList.toggle('active', item.dataset.agent === agentName);
  });

  document.getElementById('goalsPlaceholder').style.display = 'none';
  document.getElementById('goalsContent').style.display = 'flex';
  document.getElementById('goalsAgentName').textContent = agentName;

  // Reset to overview tab
  switchGoalsTab('overview');

  await loadAgentGoals(agentName);
  await loadAgentAttendance();
}

async function loadAgentGoals(agentName) {
  try {
    const res = await fetch('./?action=goals/get', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentName })
    });

    const data = await res.json();
    if (data.ok) {
      // B1: Migrate data model
      _currentGoalsData = migrateGoalsData(data.goals);

      // Update last-updated meta
      if (_currentGoalsData.updatedAt) {
        const date = new Date(_currentGoalsData.updatedAt);
        document.getElementById('goalsAgentMeta').textContent =
          `Last updated: ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} by ${_currentGoalsData.updatedBy || 'Unknown'}`;
      } else {
        document.getElementById('goalsAgentMeta').textContent = 'Last updated: Never';
      }

      // Render all tabs
      renderGoalCards();
      renderTaskList();
      renderCsatFollowups();
      renderPerformanceSummary();
      updateOverviewTab();
      updateQaBadge();

      // Populate table-based tabs (QA reviews, Topics, 1:1 Notes)
      populateTable('metricsTableBody', _currentGoalsData.performanceMetrics || [], createMetricsRow);
      populateTable('qaTableBody', _currentGoalsData.qaTickets || [], createQaRow);
      populateTable('topicsTableBody', _currentGoalsData.topicsDiscussed || [], createTopicRow);
      populateTable('notesTableBody', _currentGoalsData.oneOnOneNotes || [], createNoteRow);
    }
  } catch (err) {
    console.error('Error loading goals:', err);
    toast('Failed to load goals', 'error');
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING (updated for new tab IDs)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchGoalsTab(tabId) {
  // Map tab IDs to pane IDs
  const tabToPaneMap = {
    'overview': 'tabOverview',
    'smart': 'tabSmart',
    'tasks': 'tabTasks',
    'attendance': 'tabAttendance',
    'metrics': 'tabMetrics',
    'qa': 'tabQa',
    'topics': 'tabTopics',
    'notes': 'tabNotes'
  };

  document.querySelectorAll('.goals-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.tab === tabId);
  });

  document.querySelectorAll('.goals-tab-pane').forEach(pane => {
    pane.classList.toggle('active', pane.id === tabToPaneMap[tabId]);
  });

  if (tabId === 'attendance') {
    loadAgentAttendance();
  }
  if (tabId === 'overview') {
    updateOverviewTab();
  }
  if (tabId === 'metrics') {
    renderPerformanceSummary();
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// A3 â€” OVERVIEW TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateOverviewTab() {
  if (!_currentGoalsData) return;
  const d = _currentGoalsData;
  const now = new Date();
  const today = now.toISOString().split('T')[0];

  // Goals
  const activeGoals = (d.smartGoals || []).filter(g => g.status === 'active' || g.status === 'at_risk');
  document.getElementById('ovGoalsActive').textContent = activeGoals.length;
  const dueSoon = activeGoals.filter(g => g.dueDate && g.dueDate <= new Date(now.getTime() + 14 * 86400000).toISOString().split('T')[0]);
  document.getElementById('ovGoalsDue').textContent = dueSoon.length > 0 ? `${dueSoon.length} due within 2 weeks` : 'No goals due soon';

  // Tasks
  const tasks = d.tasks || [];
  const openTasks = tasks.filter(t => t.status !== 'done' && t.status !== 'completed');
  const overdueTasks = openTasks.filter(t => t.dueDate && t.dueDate < today);
  document.getElementById('ovTasksOpen').textContent = openTasks.length;
  document.getElementById('ovTasksOverdue').textContent = overdueTasks.length > 0 ? `${overdueTasks.length} overdue` : 'None overdue';

  // QA
  const qaTickets = d.qaTickets || [];
  const pendingQa = qaTickets.filter(q => q.goneOver === 'pending' || q.goneOver === '');
  document.getElementById('ovQaCount').textContent = qaTickets.length;
  document.getElementById('ovQaPending').textContent = `${pendingQa.length} pending review`;

  // CSAT follow-ups
  const csatFollowups = d.csatFollowups || [];
  const pendingCsat = csatFollowups.filter(c => !c.followUpCompleted);
  document.getElementById('ovCsatPending').textContent = pendingCsat.length;
  document.getElementById('ovCsatSub').textContent = pendingCsat.length === 1 ? 'needing follow-up' : 'needing follow-up';

  // Performance
  const metrics = d.performanceMetrics || [];
  document.getElementById('ovPerfWeeks').textContent = metrics.length;
  document.getElementById('ovPerfSub').textContent = metrics.length === 1 ? 'week tracked' : 'weeks tracked';

  // Bradford (will be updated when attendance loads)
  // (handled by loadAgentAttendance)

  // Build action items
  const actionsContainer = document.getElementById('overviewActions');
  let actionsHtml = '';

  if (overdueTasks.length > 0) {
    actionsHtml += `<div class="overview-action-item urgent" onclick="switchGoalsTab('tasks'); filterTasks('overdue');">
      <div class="overview-action-icon">ðŸ”´</div>
      <div class="overview-action-text">${overdueTasks.length} overdue task${overdueTasks.length > 1 ? 's' : ''} need attention</div>
      <div class="overview-action-meta">View Tasks â†’</div>
    </div>`;
  }

  if (pendingCsat.length > 0) {
    actionsHtml += `<div class="overview-action-item urgent" onclick="switchGoalsTab('qa'); filterCsatFollowups('pending');">
      <div class="overview-action-icon">âš ï¸</div>
      <div class="overview-action-text">${pendingCsat.length} low CSAT follow-up${pendingCsat.length > 1 ? 's' : ''} incomplete</div>
      <div class="overview-action-meta">View CSAT â†’</div>
    </div>`;
  }

  if (pendingQa.length > 0) {
    actionsHtml += `<div class="overview-action-item warning" onclick="switchGoalsTab('qa');">
      <div class="overview-action-icon">âœ…</div>
      <div class="overview-action-text">${pendingQa.length} QA review${pendingQa.length > 1 ? 's' : ''} pending</div>
      <div class="overview-action-meta">View QA â†’</div>
    </div>`;
  }

  const goalsNeedingReview = activeGoals.filter(g => g.nextCheckInDate && g.nextCheckInDate <= today);
  if (goalsNeedingReview.length > 0) {
    actionsHtml += `<div class="overview-action-item info" onclick="switchGoalsTab('smart');">
      <div class="overview-action-icon">ðŸŽ¯</div>
      <div class="overview-action-text">${goalsNeedingReview.length} goal${goalsNeedingReview.length > 1 ? 's' : ''} due for review check-in</div>
      <div class="overview-action-meta">View Goals â†’</div>
    </div>`;
  }

  if (!actionsHtml) {
    actionsHtml = `<div class="overview-action-item info">
      <div class="overview-action-icon">âœ¨</div>
      <div class="overview-action-text">All caught up! No urgent items.</div>
    </div>`;
  }

  actionsContainer.innerHTML = actionsHtml;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// B2 â€” SMART GOALS CARDS + EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderGoalCards() {
  const container = document.getElementById('smartGoalsList');
  if (!container) return;
  const goals = _currentGoalsData?.smartGoals || [];

  if (goals.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ðŸŽ¯</div>
        <div class="empty-state-title">No Goals Yet</div>
        <div class="empty-state-text">Add your first SMART goal to get started with performance tracking.</div>
        <button class="btn-modern primary-sm" onclick="openGoalEditor()">+ Add First Goal</button>
      </div>`;
    return;
  }

  let html = '';
  goals.forEach((goal, index) => {
    const statusLabel = { draft: 'ðŸ“ Draft', active: 'ðŸŸ¢ Active', at_risk: 'ðŸŸ¡ At Risk', complete: 'âœ… Complete', archived: 'ðŸ“¦ Archived' };
    const dueDateStr = goal.dueDate ? new Date(goal.dueDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';

    html += `
      <div class="smart-goal-card-v2" onclick="openGoalEditor(${index})">
        <div class="smart-goal-card-header">
          <div class="smart-goal-card-title">${escapeHtml(goal.title || 'Untitled Goal')}</div>
          <span class="status-pill ${goal.status || 'draft'}">${statusLabel[goal.status] || 'ðŸ“ Draft'}</span>
        </div>
        <div class="smart-goal-card-meta">
          ${dueDateStr ? `<span class="smart-goal-card-meta-item">ðŸ“… Due: ${dueDateStr}</span>` : ''}
          ${goal.reviewCadence ? `<span class="smart-goal-card-meta-item">ðŸ”„ ${goal.reviewCadence}</span>` : ''}
          ${goal.nextCheckInDate ? `<span class="smart-goal-card-meta-item">ðŸ“Œ Next check-in: ${new Date(goal.nextCheckInDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>` : ''}
        </div>
        <div class="smart-goal-card-preview">
          <div class="smart-goal-preview-field">
            <div class="smart-goal-preview-label">Specific</div>
            <div class="smart-goal-preview-value">${escapeHtml(goal.specific || 'â€”')}</div>
          </div>
          <div class="smart-goal-preview-field">
            <div class="smart-goal-preview-label">Measurable</div>
            <div class="smart-goal-preview-value">${escapeHtml(goal.measurable || 'â€”')}</div>
          </div>
          <div class="smart-goal-preview-field">
            <div class="smart-goal-preview-label">Attainable</div>
            <div class="smart-goal-preview-value">${escapeHtml(goal.attainable || 'â€”')}</div>
          </div>
          <div class="smart-goal-preview-field">
            <div class="smart-goal-preview-label">Relevant</div>
            <div class="smart-goal-preview-value">${escapeHtml(goal.relevant || 'â€”')}</div>
          </div>
          <div class="smart-goal-preview-field">
            <div class="smart-goal-preview-label">Time Bound</div>
            <div class="smart-goal-preview-value">${escapeHtml(goal.timeBound || 'â€”')}</div>
          </div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

function openGoalEditor(index = null) {
  _editingGoalIndex = index;
  const drawer = document.getElementById('goalEditorDrawer');
  const deleteBtn = document.getElementById('goalEditorDeleteBtn');

  if (index !== null && _currentGoalsData?.smartGoals?.[index]) {
    // Editing existing
    const goal = _currentGoalsData.smartGoals[index];
    document.getElementById('goalEditorTitle').textContent = 'Edit Goal';
    document.getElementById('goalEditorId').value = goal.id || '';
    document.getElementById('goalEditorTitleInput').value = goal.title || '';
    document.getElementById('goalEditorStatus').value = goal.status || 'active';
    document.getElementById('goalEditorDue').value = goal.dueDate || '';
    document.getElementById('goalEditorCadence').value = goal.reviewCadence || '';
    document.getElementById('goalEditorNextCheckin').value = goal.nextCheckInDate || '';
    document.getElementById('goalEditorSpecific').value = goal.specific || '';
    document.getElementById('goalEditorMeasurable').value = goal.measurable || '';
    document.getElementById('goalEditorAttainable').value = goal.attainable || '';
    document.getElementById('goalEditorRelevant').value = goal.relevant || '';
    document.getElementById('goalEditorTimeBound').value = goal.timeBound || '';
    deleteBtn.style.display = 'inline-flex';
  } else {
    // New goal
    document.getElementById('goalEditorTitle').textContent = 'New Goal';
    document.getElementById('goalEditorId').value = '';
    document.getElementById('goalEditorTitleInput').value = '';
    document.getElementById('goalEditorStatus').value = 'active';
    document.getElementById('goalEditorDue').value = '';
    document.getElementById('goalEditorCadence').value = '';
    document.getElementById('goalEditorNextCheckin').value = '';
    document.getElementById('goalEditorSpecific').value = '';
    document.getElementById('goalEditorMeasurable').value = '';
    document.getElementById('goalEditorAttainable').value = '';
    document.getElementById('goalEditorRelevant').value = '';
    document.getElementById('goalEditorTimeBound').value = '';
    deleteBtn.style.display = 'none';
  }

  drawer.style.display = 'block';
  drawer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function closeGoalEditor() {
  document.getElementById('goalEditorDrawer').style.display = 'none';
  _editingGoalIndex = null;
}

function saveGoalFromEditor() {
  if (!_currentGoalsData) return;
  if (!_currentGoalsData.smartGoals) _currentGoalsData.smartGoals = [];

  const goalData = {
    id: document.getElementById('goalEditorId').value || 'goal_' + Date.now(),
    title: document.getElementById('goalEditorTitleInput').value || 'Untitled Goal',
    status: document.getElementById('goalEditorStatus').value || 'active',
    dueDate: document.getElementById('goalEditorDue').value || '',
    reviewCadence: document.getElementById('goalEditorCadence').value || '',
    nextCheckInDate: document.getElementById('goalEditorNextCheckin').value || '',
    specific: document.getElementById('goalEditorSpecific').value || '',
    measurable: document.getElementById('goalEditorMeasurable').value || '',
    attainable: document.getElementById('goalEditorAttainable').value || '',
    relevant: document.getElementById('goalEditorRelevant').value || '',
    timeBound: document.getElementById('goalEditorTimeBound').value || '',
    updatedAt: new Date().toISOString()
  };

  if (_editingGoalIndex !== null && _currentGoalsData.smartGoals[_editingGoalIndex]) {
    goalData.createdAt = _currentGoalsData.smartGoals[_editingGoalIndex].createdAt;
    _currentGoalsData.smartGoals[_editingGoalIndex] = goalData;
  } else {
    goalData.createdAt = new Date().toISOString();
    _currentGoalsData.smartGoals.push(goalData);
  }

  _goalsUnsavedChanges = true;
  closeGoalEditor();
  renderGoalCards();
  updateOverviewTab();
}

function deleteCurrentGoal() {
  if (_editingGoalIndex === null || !_currentGoalsData?.smartGoals) return;

  Swal.fire({
    title: 'Archive Goal?',
    text: 'This will archive the goal. You can restore it later.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Archive',
    cancelButtonText: 'Cancel'
  }).then(result => {
    if (result.isConfirmed) {
      _currentGoalsData.smartGoals[_editingGoalIndex].status = 'archived';
      _goalsUnsavedChanges = true;
      closeGoalEditor();
      renderGoalCards();
      updateOverviewTab();
    }
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// C2 â€” TASKS LIST + FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderTaskList(filter = 'all') {
  const container = document.getElementById('tasksList');
  if (!container) return;
  const tasks = _currentGoalsData?.tasks || [];
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const soonDate = new Date(now.getTime() + 7 * 86400000).toISOString().split('T')[0];

  // Apply filter
  let filtered = tasks;
  if (filter === 'overdue') {
    filtered = tasks.filter(t => t.dueDate && t.dueDate < today && t.status !== 'done' && t.status !== 'completed');
  } else if (filter === 'due_soon') {
    filtered = tasks.filter(t => t.dueDate && t.dueDate >= today && t.dueDate <= soonDate && t.status !== 'done' && t.status !== 'completed');
  } else if (filter === 'in_progress') {
    filtered = tasks.filter(t => t.status === 'in_progress');
  } else if (filter === 'done') {
    filtered = tasks.filter(t => t.status === 'done' || t.status === 'completed');
  }

  if (filtered.length === 0 && tasks.length === 0) {
    container.innerHTML = '';
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“Œ</div><div class="empty-state-title">No Tasks Yet</div><div class="empty-state-text">Add tasks and projects to track deliverables.</div><button class="btn-modern primary-sm" onclick="openTaskEditor()">+ Add First Task</button></div>';
    return;
  }

  let html = '';
  if (filtered.length === 0) {
    html = `<div style="text-align:center; padding:24px; color:var(--text-secondary); font-size:13px;">No tasks match this filter.</div>`;
  }

  filtered.forEach((task, index) => {
    const originalIndex = tasks.indexOf(task);
    const isOverdue = task.dueDate && task.dueDate < today && task.status !== 'done' && task.status !== 'completed';
    const isDone = task.status === 'done' || task.status === 'completed';
    const dueDateStr = task.dueDate ? new Date(task.dueDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
    const statusLabels = { open: 'Open', in_progress: 'In Progress', done: 'Completed', blocked: 'Blocked', completed: 'Completed', not_started: 'Not Started' };

    html += `
      <div class="task-card ${isOverdue ? 'overdue' : ''} ${isDone ? 'done' : ''}" onclick="openTaskEditor(${originalIndex})">
        <div class="task-card-priority ${task.priority || ''}"></div>
        <div class="task-card-body">
          <div class="task-card-title">${escapeHtml(task.title || 'Untitled Task')}</div>
          <div class="task-card-subtitle">
            ${dueDateStr ? `<span>${isOverdue ? 'ðŸ”´' : 'ðŸ“…'} ${dueDateStr}</span>` : ''}
            ${task.notes ? `<span>ðŸ“ ${escapeHtml(task.notes.substring(0, 50))}${task.notes.length > 50 ? '...' : ''}</span>` : ''}
          </div>
        </div>
        <div class="task-card-actions">
          <span class="status-pill ${task.status || 'open'}">${statusLabels[task.status] || 'Open'}</span>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

function filterTasks(filter) {
  document.querySelectorAll('#taskFilterChips .filter-chip').forEach(chip => {
    chip.classList.toggle('active', chip.dataset.filter === filter);
  });
  renderTaskList(filter);
}

function openTaskEditor(index = null) {
  _editingTaskIndex = index;
  const panel = document.getElementById('taskEditorPanel');
  const deleteBtn = document.getElementById('taskEditorDeleteBtn');

  if (index !== null && _currentGoalsData?.tasks?.[index]) {
    const task = _currentGoalsData.tasks[index];
    document.getElementById('taskEditorId').value = task.id || '';
    document.getElementById('taskEditorTitle').value = task.title || '';
    document.getElementById('taskEditorPriority').value = task.priority || '';
    document.getElementById('taskEditorDue').value = task.dueDate || '';
    document.getElementById('taskEditorStatus').value = task.status || 'open';
    document.getElementById('taskEditorNotes').value = task.notes || '';
    deleteBtn.style.display = 'inline-flex';
  } else {
    document.getElementById('taskEditorId').value = '';
    document.getElementById('taskEditorTitle').value = '';
    document.getElementById('taskEditorPriority').value = '';
    document.getElementById('taskEditorDue').value = '';
    document.getElementById('taskEditorStatus').value = 'open';
    document.getElementById('taskEditorNotes').value = '';
    deleteBtn.style.display = 'none';
  }

  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function closeTaskEditor() {
  document.getElementById('taskEditorPanel').style.display = 'none';
  _editingTaskIndex = null;
}

function saveTaskFromEditor() {
  if (!_currentGoalsData) return;
  if (!_currentGoalsData.tasks) _currentGoalsData.tasks = [];

  const taskData = {
    id: document.getElementById('taskEditorId').value || 'task_' + Date.now(),
    title: document.getElementById('taskEditorTitle').value || 'Untitled Task',
    priority: document.getElementById('taskEditorPriority').value || '',
    dueDate: document.getElementById('taskEditorDue').value || '',
    status: document.getElementById('taskEditorStatus').value || 'open',
    notes: document.getElementById('taskEditorNotes').value || '',
    updatedAt: new Date().toISOString()
  };

  if (_editingTaskIndex !== null && _currentGoalsData.tasks[_editingTaskIndex]) {
    taskData.createdAt = _currentGoalsData.tasks[_editingTaskIndex].createdAt;
    _currentGoalsData.tasks[_editingTaskIndex] = taskData;
  } else {
    taskData.createdAt = new Date().toISOString();
    _currentGoalsData.tasks.push(taskData);
  }

  _goalsUnsavedChanges = true;
  closeTaskEditor();
  renderTaskList();
  updateOverviewTab();
}

function deleteCurrentTask() {
  if (_editingTaskIndex === null || !_currentGoalsData?.tasks) return;
  _currentGoalsData.tasks.splice(_editingTaskIndex, 1);
  _goalsUnsavedChanges = true;
  closeTaskEditor();
  renderTaskList();
  updateOverviewTab();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// D1/D2 â€” CSAT FOLLOW-UPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCsatFollowups(filter = 'all') {
  const container = document.getElementById('csatFollowupsList');
  const emptyState = document.getElementById('csatEmpty');
  const followups = _currentGoalsData?.csatFollowups || [];

  let filtered = followups;
  if (filter === 'pending') {
    filtered = followups.filter(c => !c.followUpCompleted);
  } else if (filter === 'completed') {
    filtered = followups.filter(c => c.followUpCompleted);
  }

  if (filtered.length === 0 && followups.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ‘</div>
        <div class="empty-state-title">No Low CSAT Follow-ups</div>
        <div class="empty-state-text">Add follow-up entries when agents receive low satisfaction ratings (1â€“3 stars).</div>
      </div>`;
    return;
  }

  let html = '';
  if (filtered.length === 0) {
    html = `<div style="text-align:center; padding:24px; color:var(--text-secondary); font-size:13px;">No follow-ups match this filter.</div>`;
  }

  filtered.forEach((fu, i) => {
    const originalIndex = followups.indexOf(fu);
    const ratingStars = 'â­'.repeat(parseInt(fu.rating) || 1);
    const dateStr = fu.dateReceived ? new Date(fu.dateReceived + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
    const methodIcons = { email: 'ðŸ“§', chat: 'ðŸ’¬', phone: 'ðŸ“ž' };

    html += `
      <div class="csat-followup-card ${fu.followUpCompleted ? 'completed' : 'pending'}" onclick="openCsatFollowupEditor(${originalIndex})">
        <div class="csat-followup-rating">${ratingStars}</div>
        <div class="csat-followup-body">
          <div class="csat-followup-title">Ticket ${formatTicketLink(fu.ticketNumber)} Â· ${escapeHtml(fu.channel || 'â€”')}</div>
          <div class="csat-followup-subtitle">
            ${dateStr ? `<span>ðŸ“… ${dateStr}</span>` : ''}
            ${fu.issueSummary ? `<span>${escapeHtml(fu.issueSummary.substring(0, 60))}${fu.issueSummary.length > 60 ? '...' : ''}</span>` : ''}
          </div>
        </div>
        <div class="csat-followup-actions">
          ${fu.followUpCompleted
            ? `<span class="status-pill completed">${methodIcons[fu.followUpMethod] || 'âœ…'} Completed</span>`
            : `<span class="status-pill pending">â³ Needs Follow-up</span>`
          }
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

function filterCsatFollowups(filter) {
  document.querySelectorAll('#csatFilterChips .filter-chip').forEach(chip => {
    chip.classList.toggle('active', chip.dataset.filter === filter);
  });
  renderCsatFollowups(filter);
}

function openCsatFollowupEditor(index = null) {
  _editingCsatIndex = index;
  const panel = document.getElementById('csatEditorPanel');
  const deleteBtn = document.getElementById('csatEditorDeleteBtn');

  if (index !== null && _currentGoalsData?.csatFollowups?.[index]) {
    const fu = _currentGoalsData.csatFollowups[index];
    document.getElementById('csatEditorId').value = fu.id || '';
    document.getElementById('csatEditorDate').value = fu.dateReceived || '';
    document.getElementById('csatEditorTicket').value = fu.ticketNumber || '';
    document.getElementById('csatEditorChannel').value = fu.channel || '';
    document.getElementById('csatEditorRating').value = fu.rating || '';
    document.getElementById('csatEditorSummary').value = fu.issueSummary || '';
    document.getElementById('csatEditorMethod').value = fu.followUpMethod || '';
    document.getElementById('csatEditorCompleted').checked = !!fu.followUpCompleted;
    document.getElementById('csatEditorCompletedAt').value = fu.followUpCompletedAt || '';
    document.getElementById('csatEditorCompletedAt').style.display = fu.followUpCompleted ? 'block' : 'none';
    document.getElementById('csatEditorNotes').value = fu.notes || '';
    deleteBtn.style.display = 'inline-flex';
  } else {
    document.getElementById('csatEditorId').value = '';
    document.getElementById('csatEditorDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('csatEditorTicket').value = '';
    document.getElementById('csatEditorChannel').value = '';
    document.getElementById('csatEditorRating').value = '';
    document.getElementById('csatEditorSummary').value = '';
    document.getElementById('csatEditorMethod').value = '';
    document.getElementById('csatEditorCompleted').checked = false;
    document.getElementById('csatEditorCompletedAt').value = '';
    document.getElementById('csatEditorCompletedAt').style.display = 'none';
    document.getElementById('csatEditorNotes').value = '';
    deleteBtn.style.display = 'none';
  }

  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function closeCsatEditor() {
  document.getElementById('csatEditorPanel').style.display = 'none';
  _editingCsatIndex = null;
}

function toggleCsatCompletedDate() {
  const checked = document.getElementById('csatEditorCompleted').checked;
  const dateInput = document.getElementById('csatEditorCompletedAt');
  dateInput.style.display = checked ? 'block' : 'none';
  if (checked && !dateInput.value) {
    dateInput.value = new Date().toISOString().split('T')[0];
  }
}

function saveCsatFollowupFromEditor() {
  if (!_currentGoalsData) return;
  if (!_currentGoalsData.csatFollowups) _currentGoalsData.csatFollowups = [];

  const isCompleted = document.getElementById('csatEditorCompleted').checked;
  const method = document.getElementById('csatEditorMethod').value;

  // D0: Validation â€” cannot mark complete without method
  if (isCompleted && !method) {
    toast('Please select a follow-up method before marking as complete.', 'error');
    return;
  }

  const fuData = {
    id: document.getElementById('csatEditorId').value || 'csat_' + Date.now(),
    dateReceived: document.getElementById('csatEditorDate').value || '',
    ticketNumber: document.getElementById('csatEditorTicket').value || '',
    channel: document.getElementById('csatEditorChannel').value || '',
    rating: document.getElementById('csatEditorRating').value || '',
    issueSummary: document.getElementById('csatEditorSummary').value || '',
    followUpRequired: true,
    followUpCompleted: isCompleted,
    followUpMethod: method,
    followUpCompletedAt: isCompleted ? (document.getElementById('csatEditorCompletedAt').value || new Date().toISOString().split('T')[0]) : '',
    notes: document.getElementById('csatEditorNotes').value || '',
    updatedAt: new Date().toISOString()
  };

  if (_editingCsatIndex !== null && _currentGoalsData.csatFollowups[_editingCsatIndex]) {
    fuData.createdAt = _currentGoalsData.csatFollowups[_editingCsatIndex].createdAt;
    _currentGoalsData.csatFollowups[_editingCsatIndex] = fuData;
  } else {
    fuData.createdAt = new Date().toISOString();
    _currentGoalsData.csatFollowups.push(fuData);
  }

  _goalsUnsavedChanges = true;
  closeCsatEditor();
  renderCsatFollowups();
  updateQaBadge();
  updateOverviewTab();
}

function deleteCurrentCsatFollowup() {
  if (_editingCsatIndex === null || !_currentGoalsData?.csatFollowups) return;
  _currentGoalsData.csatFollowups.splice(_editingCsatIndex, 1);
  _goalsUnsavedChanges = true;
  closeCsatEditor();
  renderCsatFollowups();
  updateQaBadge();
  updateOverviewTab();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// D3 â€” QA TAB BADGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateQaBadge() {
  const badge = document.getElementById('qaTabBadge');
  if (!badge) return;

  const pending = (_currentGoalsData?.csatFollowups || []).filter(c => !c.followUpCompleted).length;
  if (pending > 0) {
    badge.textContent = pending;
    badge.style.display = 'inline-flex';
  } else {
    badge.style.display = 'none';
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// F2 â€” PERFORMANCE SUMMARY BAND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderPerformanceSummary() {
  const metrics = _currentGoalsData?.performanceMetrics || [];
  if (metrics.length === 0) {
    document.getElementById('perfAvgTickets').textContent = '--';
    document.getElementById('perfAvgCsat').textContent = '--';
    document.getElementById('perfTrend').textContent = '--';
    document.getElementById('perfTotalCallOuts').textContent = '--';
    return;
  }

  const validTickets = metrics.filter(m => m.ticketsSolved);
  const avgTickets = validTickets.length > 0
    ? Math.round(validTickets.reduce((s, m) => s + (parseInt(m.ticketsSolved) || 0), 0) / validTickets.length)
    : '--';

  const validCsat = metrics.filter(m => m.csat);
  const avgCsat = validCsat.length > 0
    ? (validCsat.reduce((s, m) => s + (parseFloat(m.csat) || 0), 0) / validCsat.length).toFixed(1) + '%'
    : '--';

  const totalCallOuts = metrics.reduce((s, m) => s + (parseInt(m.callOuts) || 0), 0);

  // Trend: compare last 2 weeks
  let trend = '--';
  if (metrics.length >= 2) {
    const sorted = [...metrics].sort((a, b) => (b.weekStarting || '').localeCompare(a.weekStarting || ''));
    const latest = parseInt(sorted[0]?.ticketsSolved) || 0;
    const prior = parseInt(sorted[1]?.ticketsSolved) || 0;
    if (prior > 0) {
      const pct = Math.round(((latest - prior) / prior) * 100);
      trend = pct >= 0 ? `â†‘ ${pct}%` : `â†“ ${Math.abs(pct)}%`;
    }
  }

  document.getElementById('perfAvgTickets').textContent = avgTickets;
  document.getElementById('perfAvgCsat').textContent = avgCsat;
  document.getElementById('perfTrend').textContent = trend;
  document.getElementById('perfTotalCallOuts').textContent = totalCallOuts;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// E1/E2 â€” ATTENDANCE TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadAgentAttendance() {
  if (!_currentGoalsAgent) return;

  const days = document.getElementById('attendancePeriod')?.value || 90;
  const timelineContainer = document.getElementById('attendanceTimeline');
  timelineContainer.innerHTML = '<div class="timeline-loading">Loading attendance data...</div>';

  try {
    const res = await fetch('/attendance/summary', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentName: _currentGoalsAgent, days: parseInt(days) })
    });

    const data = await res.json();
    if (data.ok && data.summary) {
      const s = data.summary;

      // Update summary cards
      document.getElementById('attBradford').textContent = s.bradfordFactor;
      const statusEl = document.getElementById('attBradfordStatus');
      statusEl.textContent = s.concernLevel.charAt(0).toUpperCase() + s.concernLevel.slice(1);
      statusEl.className = 'summary-card-status ' + s.concernLevel;

      document.getElementById('attCallOuts').textContent = s.stats.callOuts;
      document.getElementById('attPTO').textContent = s.stats.ptoRequests;
      document.getElementById('attSwapsInit').textContent = s.stats.swapsInitiated;
      document.getElementById('attReplaced').textContent = s.stats.timesReplaced;
      document.getElementById('attCovered').textContent = s.stats.coveredForOthers;

      // Update overview Bradford
      if (document.getElementById('ovBradford')) {
        document.getElementById('ovBradford').textContent = s.bradfordFactor;
        const ovLabel = document.getElementById('ovBradfordLabel');
        if (ovLabel) {
          ovLabel.textContent = `Bradford Factor Â· ${s.concernLevel.charAt(0).toUpperCase() + s.concernLevel.slice(1)}`;
        }
      }

      // Render timeline (E1 + E2)
      renderAttendanceTimeline(s.events || []);
    }
  } catch (err) {
    console.error('Error loading attendance:', err);
    timelineContainer.innerHTML = '<div class="timeline-loading">Error loading attendance data</div>';
  }
}

function renderAttendanceTimeline(events, filter = 'all') {
  const container = document.getElementById('attendanceTimeline');

  // Filter
  let filtered = events;
  if (filter === 'timeoff') {
    filtered = events.filter(e => e.type === 'timeoff' && !e.isCallOut);
  } else if (filter === 'callout') {
    filtered = events.filter(e => e.isCallOut || (e.type === 'timeoff' && e.isCallOut));
  } else if (filter === 'swap') {
    filtered = events.filter(e => e.type === 'swap_initiated' || e.type === 'swap_received');
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="timeline-loading">No attendance events found</div>';
    return;
  }

  // E2: Group by date
  const groups = {};
  const today = new Date().toISOString().split('T')[0];
  const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

  filtered.forEach(e => {
    const eventDate = e.date || (e.createdAt ? e.createdAt.split('T')[0] : '');
    let groupLabel = eventDate;
    if (eventDate === today) groupLabel = 'Today';
    else if (eventDate === yesterday) groupLabel = 'Yesterday';
    else if (eventDate) groupLabel = new Date(eventDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    else groupLabel = 'Unknown Date';

    if (!groups[groupLabel]) groups[groupLabel] = [];
    groups[groupLabel].push(e);
  });

  let html = '';
  Object.entries(groups).forEach(([dateLabel, groupEvents]) => {
    html += `<div class="timeline-date-group">${dateLabel}</div>`;

    groupEvents.forEach(e => {
      let icon = 'ðŸ“…';
      let iconClass = 'timeoff';
      let title = '';
      let subtitle = '';

      if (e.type === 'timeoff') {
        icon = e.isCallOut ? 'ðŸ¤’' : 'ðŸ–ï¸';
        iconClass = e.isCallOut ? 'callout' : 'timeoff';
        title = e.isCallOut ? 'Call Out / Sick Day' : 'PTO Request';
        subtitle = e.reason || '';
      } else if (e.type === 'swap_initiated') {
        icon = 'ðŸ”„';
        iconClass = 'swap';
        title = `Swap requested with ${e.withPerson || 'Unknown'}`;
      } else if (e.type === 'swap_received') {
        icon = 'ðŸ”„';
        iconClass = 'swap';
        title = `Swap received from ${e.withPerson || 'Unknown'}`;
      } else if (e.type === 'replaced') {
        icon = 'ðŸ”';
        iconClass = 'replaced';
        title = `Replaced by ${e.newPerson || 'Unknown'}`;
      } else if (e.type === 'replacement_took') {
        icon = 'âœ‹';
        iconClass = 'covered';
        title = `Covered for ${e.originalPerson || 'Unknown'}`;
      }

      const statusPill = e.status ? `<span class="status-pill ${e.status}">${e.status.charAt(0).toUpperCase() + e.status.slice(1)}</span>` : '';

      html += `
        <div class="timeline-item" data-type="${e.type || ''}" data-callout="${e.isCallOut ? 'true' : 'false'}">
          <div class="timeline-item-icon ${iconClass}">${icon}</div>
          <div class="timeline-item-body">
            <div class="timeline-item-title">${title}</div>
            ${subtitle ? `<div class="timeline-item-subtitle">${escapeHtml(subtitle)}</div>` : ''}
          </div>
          <div class="timeline-item-right">
            ${statusPill}
          </div>
        </div>
      `;
    });
  });

  container.innerHTML = html;

  // Store events for filtering
  container._allEvents = events;
}

function filterTimeline(filter, context) {
  if (context === 'attendance') {
    const container = document.getElementById('attendanceTimeline');
    const events = container._allEvents || [];

    // Update chips
    const chipsContainer = container.previousElementSibling?.querySelector('.filter-chips') ||
      document.querySelector('#tabAttendance .filter-chips');
    if (chipsContainer) {
      chipsContainer.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
      });
    }

    renderAttendanceTimeline(events, filter);
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// F1 â€” MEETING FOLLOW-UPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function addMeetingFollowup() {
  Swal.fire({
    title: 'Log Meeting Follow-up',
    html: `
      <div style="text-align: left; padding: 0 8px;">
        <div style="margin-bottom: 16px;">
          <label style="display:block; font-size:11px; font-weight:700; margin-bottom:6px; text-transform:uppercase; color:#64748b;">Type</label>
          <select id="swal-meeting-type" style="width:100%; padding:12px; border:2px solid var(--border-color, #e2e8f0); border-radius:10px; font-size:14px; background:var(--input-bg, white); color:var(--text-primary, #1e293b);">
            <option value="meeting_missed">Meeting Missed</option>
            <option value="video_watched">Training Video Watched</option>
            <option value="coaching">Coaching Session</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display:block; font-size:11px; font-weight:700; margin-bottom:6px; text-transform:uppercase; color:#64748b;">Date</label>
          <input type="date" id="swal-meeting-date" value="${new Date().toISOString().split('T')[0]}" style="width:100%; padding:12px; border:2px solid var(--border-color, #e2e8f0); border-radius:10px; font-size:14px; background:var(--input-bg, white); color:var(--text-primary, #1e293b); box-sizing:border-box;">
        </div>
        <div style="margin-bottom: 8px;">
          <label style="display:block; font-size:11px; font-weight:700; margin-bottom:6px; text-transform:uppercase; color:#64748b;">Notes</label>
          <textarea id="swal-meeting-notes" placeholder="Details..." style="width:100%; padding:12px; border:2px solid var(--border-color, #e2e8f0); border-radius:10px; font-size:14px; background:var(--input-bg, white); color:var(--text-primary, #1e293b); min-height:100px; resize:vertical; box-sizing:border-box;"></textarea>
        </div>
      </div>
    `,
    width: 420,
    confirmButtonText: 'Save',
    confirmButtonColor: '#b37e78',
    showCancelButton: true,
    cancelButtonColor: '#64748b',
    customClass: {
      popup: 'swal-dark-mode',
      htmlContainer: 'swal-no-overflow'
    },
    preConfirm: () => {
      return {
        type: document.getElementById('swal-meeting-type').value,
        date: document.getElementById('swal-meeting-date').value,
        notes: document.getElementById('swal-meeting-notes').value
      };
    }
  }).then(result => {
    if (result.isConfirmed && result.value) {
      if (!_currentGoalsData.meetingFollowups) _currentGoalsData.meetingFollowups = [];
      _currentGoalsData.meetingFollowups.push({
        id: 'mfu_' + Date.now(),
        ...result.value,
        createdAt: new Date().toISOString()
      });
      _goalsUnsavedChanges = true;
      renderMeetingFollowups();
    }
  });
}

function renderMeetingFollowups() {
  const container = document.getElementById('meetingFollowups');
  const followups = _currentGoalsData?.meetingFollowups || [];

  if (followups.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:16px; color:var(--text-secondary); font-size:13px; border:1px dashed var(--border-color); border-radius:10px;">No meeting follow-ups logged yet.</div>`;
    return;
  }

  const typeLabels = { meeting_missed: 'âŒ Meeting Missed', video_watched: 'ðŸŽ¥ Video Watched', coaching: 'ðŸ—£ï¸ Coaching Session', other: 'ðŸ“‹ Other' };
  let html = '';

  followups.forEach(fu => {
    const dateStr = fu.date ? new Date(fu.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
    html += `
      <div class="timeline-item">
        <div class="timeline-item-icon meeting">${fu.type === 'meeting_missed' ? 'âŒ' : fu.type === 'video_watched' ? 'ðŸŽ¥' : 'ðŸ—£ï¸'}</div>
        <div class="timeline-item-body">
          <div class="timeline-item-title">${typeLabels[fu.type] || fu.type}</div>
          ${fu.notes ? `<div class="timeline-item-subtitle">${escapeHtml(fu.notes)}</div>` : ''}
        </div>
        <div class="timeline-item-right">
          <div class="timeline-item-date">${dateStr}</div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE-BASED TABS (QA Reviews, Metrics, Topics, 1:1)
// (Kept mostly as-is, minor cleanups)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function populateTable(tableBodyId, data, createRowFn) {
  const tbody = document.getElementById(tableBodyId);
  if (!tbody) return;

  tbody.innerHTML = '';
  data.forEach((item, index) => {
    tbody.appendChild(createRowFn(item, index));
  });

  if (data.length === 0) {
    const row = createRowFn({}, 0);
    tbody.appendChild(row);
  }
}

function createMetricsRow(data = {}, index) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="date" value="${data.weekStarting || ''}" data-field="weekStarting" onchange="_goalsUnsavedChanges=true"></td>
    <td><input type="number" value="${data.ticketsSolved || ''}" data-field="ticketsSolved" placeholder="0" onchange="_goalsUnsavedChanges=true"></td>
    <td><input type="text" value="${escapeHtml(data.csat || '')}" data-field="csat" placeholder="%" onchange="_goalsUnsavedChanges=true"></td>
    <td><textarea data-field="winsChallenges" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.winsChallenges || '')}</textarea></td>
    <td><input type="number" value="${data.callOuts || ''}" data-field="callOuts" placeholder="0" onchange="_goalsUnsavedChanges=true"></td>
    <td><input type="text" value="${escapeHtml(data.makeUpHours || '')}" data-field="makeUpHours" placeholder="0" onchange="_goalsUnsavedChanges=true"></td>
    <td><textarea data-field="notes" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.notes || '')}</textarea></td>
    <td><button class="btn-delete" onclick="this.closest('tr').remove(); _goalsUnsavedChanges=true;">âœ•</button></td>
  `;
  return tr;
}

function createQaRow(data = {}, index) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="date" value="${data.date || ''}" data-field="date" onchange="_goalsUnsavedChanges=true"></td>
    <td>
      <select data-field="channel" onchange="_goalsUnsavedChanges=true">
        <option value="">Select</option>
        <option value="Live Chat" ${data.channel === 'Live Chat' ? 'selected' : ''}>Live Chat</option>
        <option value="Phone" ${data.channel === 'Phone' ? 'selected' : ''}>Phone</option>
        <option value="Email" ${data.channel === 'Email' ? 'selected' : ''}>Email</option>
        <option value="Socials" ${data.channel === 'Socials' ? 'selected' : ''}>Socials</option>
      </select>
    </td>
    <td>
      <div style="display:flex; align-items:center; gap:4px;">
        <input type="text" value="${escapeHtml(data.ticketNumber || '')}" data-field="ticketNumber" placeholder="#" onchange="_goalsUnsavedChanges=true" style="flex:1;">
        ${data.ticketNumber ? `<a href="${ZENDESK_BASE_URL}${data.ticketNumber.toString().replace(/[^0-9]/g, '')}" target="_blank" rel="noopener" class="ticket-link-icon" title="Open in Zendesk">ðŸ”—</a>` : ''}
      </div>
    </td>
    <td><textarea data-field="notes" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.notes || '')}</textarea></td>
    <td>
      <select data-field="goneOver" onchange="_goalsUnsavedChanges=true">
        <option value="">Select</option>
        <option value="yes" ${data.goneOver === 'yes' ? 'selected' : ''}>Yes</option>
        <option value="no" ${data.goneOver === 'no' ? 'selected' : ''}>No</option>
        <option value="pending" ${data.goneOver === 'pending' ? 'selected' : ''}>Pending</option>
      </select>
    </td>
    <td><textarea data-field="followUpNotes" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.followUpNotes || '')}</textarea></td>
    <td><button class="btn-delete" onclick="this.closest('tr').remove(); _goalsUnsavedChanges=true;">âœ•</button></td>
  `;
  return tr;
}

function createTopicRow(data = {}, index) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="date" value="${data.date || ''}" data-field="date" onchange="_goalsUnsavedChanges=true"></td>
    <td><textarea data-field="topic" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.topic || '')}</textarea></td>
    <td><textarea data-field="theirThoughts" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.theirThoughts || '')}</textarea></td>
    <td>
      <select data-field="followUpNeeded" onchange="_goalsUnsavedChanges=true">
        <option value="">Select</option>
        <option value="yes" ${data.followUpNeeded === 'yes' ? 'selected' : ''}>Yes</option>
        <option value="no" ${data.followUpNeeded === 'no' ? 'selected' : ''}>No</option>
      </select>
    </td>
    <td><textarea data-field="notes" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.notes || '')}</textarea></td>
    <td><button class="btn-delete" onclick="this.closest('tr').remove(); _goalsUnsavedChanges=true;">âœ•</button></td>
  `;
  return tr;
}

function createNoteRow(data = {}, index) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="date" value="${data.date || ''}" data-field="date" onchange="_goalsUnsavedChanges=true"></td>
    <td><textarea data-field="question" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.question || '')}</textarea></td>
    <td><textarea data-field="answer" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.answer || '')}</textarea></td>
    <td>
      <select data-field="followUpNeeded" onchange="_goalsUnsavedChanges=true">
        <option value="">Select</option>
        <option value="yes" ${data.followUpNeeded === 'yes' ? 'selected' : ''}>Yes</option>
        <option value="no" ${data.followUpNeeded === 'no' ? 'selected' : ''}>No</option>
      </select>
    </td>
    <td><textarea data-field="notes" onchange="_goalsUnsavedChanges=true">${escapeHtml(data.notes || '')}</textarea></td>
    <td><button class="btn-delete" onclick="this.closest('tr').remove(); _goalsUnsavedChanges=true;">âœ•</button></td>
  `;
  return tr;
}

// Add row functions
function addMetricsRow() {
  document.getElementById('metricsTableBody').appendChild(createMetricsRow({}, 0));
  _goalsUnsavedChanges = true;
}

function addQaRow() {
  document.getElementById('qaTableBody').appendChild(createQaRow({}, 0));
  _goalsUnsavedChanges = true;
}

function addTopicRow() {
  document.getElementById('topicsTableBody').appendChild(createTopicRow({}, 0));
  _goalsUnsavedChanges = true;
}

function addNoteRow() {
  document.getElementById('notesTableBody').appendChild(createNoteRow({}, 0));
  _goalsUnsavedChanges = true;
}

// Legacy compatibility aliases
function addTaskRow() { openTaskEditor(); }


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE â€” Updated for new data model
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function saveAgentGoals() {
  if (!_currentGoalsAgent) {
    toast('No agent selected', 'error');
    return;
  }

  try {
    // Collect table data (for table-based tabs)
    const collectTableData = (tableBodyId) => {
      const rows = [];
      document.querySelectorAll(`#${tableBodyId} tr`).forEach(tr => {
        const row = {};
        tr.querySelectorAll('input, select, textarea').forEach(el => {
          if (el.dataset.field) {
            row[el.dataset.field] = el.value;
          }
        });
        if (Object.values(row).some(v => v)) {
          rows.push(row);
        }
      });
      return rows;
    };

    const goals = {
      // B1: New goal model (already in _currentGoalsData.smartGoals)
      smartGoals: _currentGoalsData?.smartGoals || [],
      // C1: Tasks (already in _currentGoalsData.tasks)
      tasks: _currentGoalsData?.tasks || [],
      // D1: CSAT follow-ups
      csatFollowups: _currentGoalsData?.csatFollowups || [],
      // F1: Meeting follow-ups
      meetingFollowups: _currentGoalsData?.meetingFollowups || [],
      // Table-based data
      performanceMetrics: collectTableData('metricsTableBody'),
      qaTickets: collectTableData('qaTableBody'),
      topicsDiscussed: collectTableData('topicsTableBody'),
      oneOnOneNotes: collectTableData('notesTableBody')
    };

    const res = await fetch('./?action=goals/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        agentName: _currentGoalsAgent,
        goals,
        updatedBy: window._myName || 'Manager'
      })
    });

    const data = await res.json();
    if (data.ok) {
      _goalsUnsavedChanges = false;
      toast('Goals saved successfully!', 'success');

      document.getElementById('goalsAgentMeta').textContent =
        `Last updated: ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} by ${window._myName || 'Manager'}`;

      // Update the in-memory data with what was just saved
      _currentGoalsData.performanceMetrics = goals.performanceMetrics;
      _currentGoalsData.qaTickets = goals.qaTickets;
      _currentGoalsData.topicsDiscussed = goals.topicsDiscussed;
      _currentGoalsData.oneOnOneNotes = goals.oneOnOneNotes;

      // Refresh summaries
      renderPerformanceSummary();
      updateOverviewTab();
    } else {
      toast('Failed to save goals: ' + (data.error || 'Unknown error'), 'error');
    }
  } catch (err) {
    console.error('Error saving goals:', err);
    toast('Failed to save goals', 'error');
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENT VIEW (read-only, for agents)
// Updated to support new data model
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadMyGoals() {
  const container = document.getElementById('agentGoalsContent');
  if (!container) return;

  if (!window._myName) {
    container.innerHTML = '<div class="timeline-loading">Please log in to view your goals</div>';
    return;
  }

  container.innerHTML = '<div class="timeline-loading">Loading your goals...</div>';

  try {
    const res = await fetch('./?action=goals/get', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentName: window._myName })
    });

    if (!res.ok) {
      container.innerHTML = '<div class="timeline-loading" style="color: #f87171;">Unable to load goals.</div>';
      return;
    }

    const data = await res.json();
    if (!data.ok) {
      container.innerHTML = '<div class="timeline-loading" style="color: #f87171;">Unable to load goals.</div>';
      return;
    }

    const g = migrateGoalsData(data.goals);

    // Update meta
    const metaEl = document.getElementById('agentGoalsMeta');
    if (metaEl && g.updatedAt) {
      metaEl.textContent = `Last updated: ${new Date(g.updatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} by ${g.updatedBy || 'Manager'}`;
    }

    let html = '';
    let hasContent = false;

    // â”€â”€ Tab bar for agent view â”€â”€
    html += `<div class="agent-view-tabs" style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:12px;">
      <button class="agent-view-tab active" onclick="switchAgentViewTab(this, 'agentTabGoals')">ðŸŽ¯ Goals</button>
      <button class="agent-view-tab" onclick="switchAgentViewTab(this, 'agentTabTasks')">ðŸ“Œ Tasks</button>
      <button class="agent-view-tab" onclick="switchAgentViewTab(this, 'agentTabPerf')">ðŸ“Š Performance</button>
      <button class="agent-view-tab" onclick="switchAgentViewTab(this, 'agentTabQa')">âœ… QA & CSAT</button>
      <button class="agent-view-tab" onclick="switchAgentViewTab(this, 'agentTabAttendance')">ðŸ“… Attendance</button>
    </div>`;

    // â”€â”€ GOALS SECTION â”€â”€
    const activeGoals = (g.smartGoals || []).filter(goal => goal.status !== 'archived' && (goal.specific || goal.title));
    html += '<div id="agentTabGoals" class="agent-view-pane">';
    if (activeGoals.length > 0) {
      hasContent = true;
      html += '<div class="agent-goals-section"><div class="agent-goals-section-title">ðŸŽ¯ My Goals</div>';
      activeGoals.forEach((goal, i) => {
        const statusLabels = { draft: 'ðŸ“ Draft', active: 'ðŸŸ¢ Active', at_risk: 'ðŸŸ¡ At Risk', complete: 'âœ… Complete' };
        html += `<div class="agent-goal-item">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <strong style="font-size:14px;">${escapeHtml(goal.title || 'Goal #' + (i+1))}</strong>
            <span class="status-pill ${goal.status || 'active'}">${statusLabels[goal.status] || 'ðŸŸ¢ Active'}</span>
          </div>
          ${goal.dueDate ? `<div style="font-size:11px; color:var(--text-tertiary); margin-bottom:8px;">ðŸ“… Due: ${new Date(goal.dueDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>` : ''}
          ${goal.reviewCadence ? `<div style="font-size:11px; color:var(--text-tertiary); margin-bottom:8px;">ðŸ”„ Review: ${goal.reviewCadence}</div>` : ''}
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:10px;">
            ${goal.specific ? `<div><span class="agent-goal-label">Specific</span><div class="agent-goal-value">${escapeHtml(goal.specific)}</div></div>` : ''}
            ${goal.measurable ? `<div><span class="agent-goal-label">Measurable</span><div class="agent-goal-value">${escapeHtml(goal.measurable)}</div></div>` : ''}
            ${goal.attainable ? `<div><span class="agent-goal-label">Attainable</span><div class="agent-goal-value">${escapeHtml(goal.attainable)}</div></div>` : ''}
            ${goal.relevant ? `<div><span class="agent-goal-label">Relevant</span><div class="agent-goal-value">${escapeHtml(goal.relevant)}</div></div>` : ''}
            ${goal.timeBound ? `<div><span class="agent-goal-label">Time Bound</span><div class="agent-goal-value">${escapeHtml(goal.timeBound)}</div></div>` : ''}
          </div>
        </div>`;
      });
      html += '</div>';
    } else {
      html += `<div class="empty-state" style="padding:30px;"><div class="empty-state-icon">ðŸŽ¯</div><div class="empty-state-title">No Goals Set Yet</div><div class="empty-state-text">Your manager will set up your goals during your next 1:1.</div></div>`;
    }
    html += '</div>';

    // â”€â”€ TASKS SECTION â”€â”€
    const visibleTasks = (g.tasks || []).filter(t => t.title || t.task);
    html += '<div id="agentTabTasks" class="agent-view-pane" style="display:none;">';
    if (visibleTasks.length > 0) {
      hasContent = true;
      html += '<div class="agent-goals-section"><div class="agent-goals-section-title">ðŸ“Œ My Tasks</div>';
      visibleTasks.forEach(task => {
        const statusIcons = { done: 'âœ…', completed: 'âœ…', in_progress: 'ðŸ”„', blocked: 'ðŸš«', open: 'â³', not_started: 'â³' };
        const priorityDots = { high: 'ðŸ”´', medium: 'ðŸŸ¡', low: 'ðŸŸ¢' };
        const isOverdue = task.dueDate && task.dueDate < new Date().toISOString().split('T')[0] && task.status !== 'done' && task.status !== 'completed';
        html += `<div class="agent-goal-item" style="${isOverdue ? 'border-left: 3px solid #ef4444;' : ''}">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
            <div style="display:flex; align-items:center; gap:6px;">
              ${task.priority ? `<span>${priorityDots[task.priority] || ''}</span>` : ''}
              <strong style="${task.status === 'done' || task.status === 'completed' ? 'text-decoration:line-through; opacity:0.6;' : ''}">${escapeHtml(task.title || task.task)}</strong>
            </div>
            <span class="status-pill ${task.status || 'open'}">${statusIcons[task.status] || 'â³'} ${(task.status || 'open').replace('_', ' ')}</span>
          </div>
          ${task.dueDate ? `<div style="font-size:11px; color:${isOverdue ? '#ef4444' : 'var(--text-tertiary)'}; font-weight:${isOverdue ? '600' : '400'};">${isOverdue ? 'âš ï¸ Overdue â€” ' : ''}Due: ${new Date(task.dueDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>` : ''}
          ${task.notes ? `<div style="font-size:12px; margin-top:6px; color:var(--text-secondary);">${escapeHtml(task.notes)}</div>` : ''}
        </div>`;
      });
      html += '</div>';
    } else {
      html += `<div class="empty-state" style="padding:30px;"><div class="empty-state-icon">ðŸ“Œ</div><div class="empty-state-title">No Tasks Assigned</div><div class="empty-state-text">Your manager will assign tasks as needed.</div></div>`;
    }
    html += '</div>';

    // â”€â”€ PERFORMANCE SECTION â”€â”€
    html += '<div id="agentTabPerf" class="agent-view-pane" style="display:none;">';
    if (g.performanceMetrics?.length > 0 && g.performanceMetrics.some(m => m.weekStarting)) {
      hasContent = true;

      // Summary band
      const validMetrics = g.performanceMetrics.filter(m => m.weekStarting);
      const avgTickets = validMetrics.length > 0 ? Math.round(validMetrics.reduce((s, m) => s + (parseInt(m.ticketsSolved) || 0), 0) / validMetrics.length) : 0;
      const csatValues = validMetrics.filter(m => m.csat).map(m => parseFloat(m.csat));
      const avgCsat = csatValues.length > 0 ? (csatValues.reduce((s, v) => s + v, 0) / csatValues.length).toFixed(1) : 'â€”';

      html += `<div class="summary-band" style="grid-template-columns: repeat(3, 1fr); margin-bottom:20px;">
        <div class="summary-card"><div class="summary-card-label">Avg Tickets/Week</div><div class="summary-card-value">${avgTickets}</div></div>
        <div class="summary-card"><div class="summary-card-label">Avg CSAT</div><div class="summary-card-value">${avgCsat}%</div></div>
        <div class="summary-card"><div class="summary-card-label">Weeks Tracked</div><div class="summary-card-value">${validMetrics.length}</div></div>
      </div>`;

      html += '<div class="agent-goals-section"><div class="agent-goals-section-title">ðŸ“Š Weekly Performance</div>';
      html += '<div class="goals-table-wrap"><table class="goals-table"><thead><tr><th>Week</th><th>Tickets</th><th>CSAT</th><th>Wins / Challenges</th><th>Notes</th></tr></thead><tbody>';
      validMetrics.slice().reverse().forEach(m => {
        const csatColor = (parseFloat(m.csat) >= 90) ? '#dcfce7' : (parseFloat(m.csat) >= 70) ? '#fef3c7' : '#fecaca';
        const csatText = (parseFloat(m.csat) >= 90) ? '#166534' : (parseFloat(m.csat) >= 70) ? '#92400e' : '#b91c1c';
        html += `<tr>
          <td>${new Date(m.weekStarting + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
          <td style="font-weight:600;">${m.ticketsSolved || 'â€”'}</td>
          <td>${m.csat ? `<span style="padding:2px 8px; border-radius:4px; background:${csatColor}; color:${csatText}; font-weight:600;">${m.csat}%</span>` : 'â€”'}</td>
          <td style="font-size:12px;">${escapeHtml(m.winsChallenges || 'â€”')}</td>
          <td style="font-size:12px;">${escapeHtml(m.notes || 'â€”')}</td>
        </tr>`;
      });
      html += '</tbody></table></div></div>';
    } else {
      html += `<div class="empty-state" style="padding:30px;"><div class="empty-state-icon">ðŸ“Š</div><div class="empty-state-title">No Performance Data</div><div class="empty-state-text">Performance metrics will appear here once your manager starts tracking.</div></div>`;
    }
    html += '</div>';

    // â”€â”€ QA & CSAT SECTION â”€â”€
    html += '<div id="agentTabQa" class="agent-view-pane" style="display:none;">';
    const qaTickets = g.qaTickets || [];
    const csatFollowups = g.csatFollowups || [];
    
    if (qaTickets.length > 0 && qaTickets.some(t => t.ticketNumber)) {
      hasContent = true;
      html += '<div class="agent-goals-section"><div class="agent-goals-section-title">âœ… QA Reviews</div>';
      html += '<div class="goals-table-wrap"><table class="goals-table"><thead><tr><th>Date</th><th>Channel</th><th>Ticket</th><th>Reviewed?</th><th>Notes</th></tr></thead><tbody>';
      qaTickets.filter(t => t.ticketNumber).slice().reverse().forEach(t => {
        const reviewed = t.goneOver === 'yes';
        const num = t.ticketNumber.toString().replace(/[^0-9]/g, '');
        html += `<tr>
          <td>${t.date ? new Date(t.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'â€”'}</td>
          <td>${escapeHtml(t.channel || 'â€”')}</td>
          <td>${num ? `<a href="${ZENDESK_BASE_URL}${num}" target="_blank" class="ticket-link">#${num}</a>` : escapeHtml(t.ticketNumber)}</td>
          <td><span class="status-pill ${reviewed ? 'complete' : 'pending'}">${reviewed ? 'âœ… Yes' : 'â³ Pending'}</span></td>
          <td style="font-size:12px;">${escapeHtml(t.notes || 'â€”')}</td>
        </tr>`;
      });
      html += '</tbody></table></div></div>';
    }

    if (csatFollowups.length > 0) {
      hasContent = true;
      const pending = csatFollowups.filter(c => !c.followUpCompleted);
      html += `<div class="agent-goals-section"><div class="agent-goals-section-title">âš ï¸ Low CSAT Follow-ups ${pending.length > 0 ? `<span style="color:#ef4444; font-size:12px; font-weight:600; margin-left:8px;">(${pending.length} pending)</span>` : ''}</div>`;
      csatFollowups.forEach(fu => {
        const ratingStars = 'â­'.repeat(parseInt(fu.rating) || 1);
        const num = (fu.ticketNumber || '').toString().replace(/[^0-9]/g, '');
        html += `<div class="agent-goal-item" style="border-left: 3px solid ${fu.followUpCompleted ? '#22c55e' : '#ef4444'};">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span>${ratingStars}</span>
              <strong>${num ? `<a href="${ZENDESK_BASE_URL}${num}" target="_blank" class="ticket-link">Ticket #${num}</a>` : 'Ticket ' + escapeHtml(fu.ticketNumber || 'â€”')}</strong>
              <span style="font-size:11px; color:var(--text-tertiary);">Â· ${escapeHtml(fu.channel || '')}</span>
            </div>
            <span class="status-pill ${fu.followUpCompleted ? 'complete' : 'pending'}">${fu.followUpCompleted ? 'âœ… Resolved' : 'â³ Pending'}</span>
          </div>
          ${fu.issueSummary ? `<div style="font-size:12px; color:var(--text-secondary); margin-bottom:4px;">${escapeHtml(fu.issueSummary)}</div>` : ''}
          ${fu.dateReceived ? `<div style="font-size:11px; color:var(--text-tertiary);">ðŸ“… ${new Date(fu.dateReceived + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>` : ''}
        </div>`;
      });
      html += '</div>';
    }

    if (qaTickets.length === 0 && csatFollowups.length === 0) {
      html += `<div class="empty-state" style="padding:30px;"><div class="empty-state-icon">âœ…</div><div class="empty-state-title">No QA Data</div><div class="empty-state-text">QA reviews and CSAT follow-ups will appear here.</div></div>`;
    }
    html += '</div>';

    // â”€â”€ ATTENDANCE SECTION â”€â”€
    html += '<div id="agentTabAttendance" class="agent-view-pane" style="display:none;">';
    html += `<div id="agentAttendanceContent"><div class="timeline-loading">Loading attendance...</div></div>`;
    html += '</div>';

    container.innerHTML = html;

    // Load attendance data for agent view
    loadAgentAttendanceForAgentView();

  } catch (err) {
    console.error('Error loading my goals:', err);
    container.innerHTML = `
      <div style="text-align:center; padding:40px 20px;">
        <div style="font-size:48px; margin-bottom:16px;">âš ï¸</div>
        <div style="font-size:16px; font-weight:600; color:var(--text-primary);">Unable to Load Goals</div>
        <div style="font-size:13px; color:var(--text-secondary);">Please check your connection and try again.</div>
      </div>`;
  }
}

// Agent view tab switching (read-only)
function switchAgentViewTab(btn, paneId) {
  const parent = btn.closest('.modal') || btn.closest('#agentGoalsView') || document.getElementById('agentGoalsContent')?.parentElement;
  if (!parent) return;

  parent.querySelectorAll('.agent-view-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');

  parent.querySelectorAll('.agent-view-pane').forEach(p => p.style.display = 'none');
  const target = document.getElementById(paneId);
  if (target) target.style.display = 'block';
}

// Load attendance for agent's own view
async function loadAgentAttendanceForAgentView() {
  const container = document.getElementById('agentAttendanceContent');
  if (!container || !window._myName) return;

  try {
    const res = await fetch('/attendance/summary', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentName: window._myName, days: 90 })
    });

    const data = await res.json();
    if (data.ok && data.summary) {
      const s = data.summary;
      let html = '';

      // Summary cards
      html += `<div class="summary-band" style="grid-template-columns: repeat(3, 1fr); margin-bottom:20px;">
        <div class="summary-card bradford">
          <div class="summary-card-label">Bradford Factor</div>
          <div class="summary-card-value">${s.bradfordFactor}</div>
          <div class="summary-card-status ${s.concernLevel}">${s.concernLevel.charAt(0).toUpperCase() + s.concernLevel.slice(1)}</div>
        </div>
        <div class="summary-card"><div class="summary-card-label">Call Outs</div><div class="summary-card-value">${s.stats.callOuts}</div></div>
        <div class="summary-card"><div class="summary-card-label">PTO Requests</div><div class="summary-card-value">${s.stats.ptoRequests}</div></div>
      </div>`;

      // Events list
      if (s.events && s.events.length > 0) {
        html += '<div class="agent-goals-section"><div class="agent-goals-section-title">ðŸ“œ Recent Events</div>';
        s.events.slice(0, 10).forEach(e => {
          let icon = 'ðŸ“…', title = '';
          if (e.type === 'timeoff') {
            icon = e.isCallOut ? 'ðŸ¤’' : 'ðŸ–ï¸';
            title = e.isCallOut ? 'Call Out / Sick Day' : 'PTO Request';
          } else if (e.type === 'swap_initiated') {
            icon = 'ðŸ”„'; title = `Swap with ${e.withPerson || 'Unknown'}`;
          } else if (e.type === 'swap_received') {
            icon = 'ðŸ”„'; title = `Swap from ${e.withPerson || 'Unknown'}`;
          } else if (e.type === 'replaced') {
            icon = 'ðŸ”'; title = `Replaced by ${e.newPerson || 'Unknown'}`;
          } else if (e.type === 'replacement_took') {
            icon = 'âœ‹'; title = `Covered for ${e.originalPerson || 'Unknown'}`;
          }
          const dateStr = e.date ? new Date(e.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
          html += `<div style="display:flex; align-items:center; gap:12px; padding:10px; border-bottom:1px solid var(--border-color);">
            <span style="font-size:20px;">${icon}</span>
            <div style="flex:1;"><div style="font-weight:600; font-size:13px;">${title}</div>${e.reason ? `<div style="font-size:11px; color:var(--text-tertiary);">${escapeHtml(e.reason)}</div>` : ''}</div>
            <div style="font-size:11px; color:var(--text-secondary); white-space:nowrap;">${dateStr}</div>
          </div>`;
        });
        html += '</div>';
      } else {
        html += `<div class="empty-state" style="padding:30px;"><div class="empty-state-icon">ðŸ“…</div><div class="empty-state-title">No Recent Events</div><div class="empty-state-text">Your attendance history will appear here.</div></div>`;
      }

      container.innerHTML = html;
    } else {
      container.innerHTML = '<div class="empty-state" style="padding:30px;"><div class="empty-state-icon">ðŸ“…</div><div class="empty-state-title">Attendance Data Unavailable</div></div>';
    }
  } catch (err) {
    console.error('Error loading agent attendance:', err);
    container.innerHTML = '<div class="timeline-loading" style="color: #f87171;">Unable to load attendance data.</div>';
  }
}


</script>

<!-- Future Time Off Request Modal (for agents) -->
<div id="futureTimeOffModal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 15000;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: white;
    border-radius: 20px;
    width: 480px;
    max-width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 80px rgba(0,0,0,0.35);
  ">
    <!-- Header -->
    <div style="
      padding:20px 24px; 
      background: linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
      border-radius: 20px 20px 0 0;
      display:flex; 
      justify-content:space-between; 
      align-items:center;
    ">
      <div style="font-weight:700; font-size:18px; color:white;">ðŸ“… Request Time Off</div>
      <button onclick="closeFutureTimeOffModal()" style="background:rgba(255,255,255,0.2); border:none; font-size:18px; cursor:pointer; color:white; width:32px; height:32px; border-radius:8px;">&times;</button>
    </div>
    
    <div style="padding:24px;">
      <!-- PTO Balance Display -->
      <div id="futureTimeOffPtoDisplay" style="
        display:flex; 
        justify-content:center; 
        margin-bottom:20px;
        padding:16px;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius:12px;
        border:2px solid #86efac;
      ">
        <div style="text-align:center;">
          <div style="font-size:11px; font-weight:700; color:#15803d; text-transform:uppercase; letter-spacing:0.5px;">Your PTO Balance</div>
          <div id="futureTimeOffPtoAmount" style="font-size:32px; font-weight:900; color:#16a34a;">--</div>
          <div style="font-size:11px; color:#22c55e;">hours available</div>
        </div>
      </div>
      
      <!-- Date Range Selection -->
      <div style="margin-bottom:20px;">
        <label style="display:block; font-size:12px; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">Date Range</label>
        <div style="display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center;">
          <div>
            <label style="font-size:10px; color:#94a3b8; display:block; margin-bottom:4px;">Start Date</label>
            <input type="date" id="futureToDateStart" style="
              width:100%; 
              padding:12px; 
              border:2px solid #e2e8f0; 
              border-radius:10px; 
              font-size:14px;
              box-sizing:border-box;
            ">
          </div>
          <div style="color:#94a3b8; font-weight:600; padding-top:20px;">â†’</div>
          <div>
            <label style="font-size:10px; color:#94a3b8; display:block; margin-bottom:4px;">End Date</label>
            <input type="date" id="futureToDateEnd" style="
              width:100%; 
              padding:12px; 
              border:2px solid #e2e8f0; 
              border-radius:10px; 
              font-size:14px;
              box-sizing:border-box;
            ">
          </div>
        </div>
        <div id="futureTimeOffDaysCount" style="text-align:center; margin-top:8px; font-size:12px; color:#64748b;"></div>
      </div>
      
      <!-- Type Selection -->
      <div style="margin-bottom:20px;">
        <label style="display:block; font-size:12px; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">Type</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <label id="futureTypeMakeUp" onclick="selectFutureTimeOffType('makeup')" style="
            display:flex; 
            align-items:center; 
            gap:10px; 
            padding:14px; 
            border:2px solid #b37e78; 
            border-radius:12px; 
            cursor:pointer;
            background:#fbf6f5;
            transition: all 0.2s;
          ">
            <input type="radio" name="futureToType" value="Make Up" checked style="width:16px; height:16px; accent-color:#b37e78;">
            <div>
              <div style="font-size:14px; font-weight:700; color:#8f5f5a;">ðŸ”„ MAKE UP</div>
              <div style="font-size:10px; color:#b37e78;">Work another time</div>
            </div>
          </label>
          <label id="futureTypePTO" onclick="selectFutureTimeOffType('pto')" style="
            display:flex; 
            align-items:center; 
            gap:10px; 
            padding:14px; 
            border:2px solid #e2e8f0; 
            border-radius:12px; 
            cursor:pointer;
            background:white;
            transition: all 0.2s;
          ">
            <input type="radio" name="futureToType" value="PTO" style="width:16px; height:16px; accent-color:#16a34a;">
            <div>
              <div style="font-size:14px; font-weight:700; color:#1e293b;">ðŸ”¥ USE PTO</div>
              <div style="font-size:10px; color:#64748b;">Deduct hours</div>
            </div>
          </label>
        </div>
      </div>
      
      <!-- Make Up Date(s) (conditional) - supports multiple dates -->
      <div id="futureToMakeUpWrap" style="margin-bottom:20px;">
        <label style="display:block; font-size:12px; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">Make Up Date(s)</label>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input type="date" id="futureToMakeUpDate" style="
            flex:1; 
            padding:12px; 
            border:2px solid #e2e8f0; 
            border-radius:10px; 
            font-size:14px;
            box-sizing:border-box;
          ">
          <button type="button" onclick="addFutureMakeUpDate()" style="
            padding:12px 16px;
            background:linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
            color:white;
            border:none;
            border-radius:10px;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
            white-space:nowrap;
          ">+ Add Date</button>
        </div>
        <div id="futureMakeUpDatesList" style="display:flex; flex-wrap:wrap; gap:6px; min-height:24px;"></div>
        <div style="font-size:11px; color:#64748b; margin-top:6px;">ðŸ“ Add one or more dates when you'll make up these hours</div>
      </div>
      
      <!-- Reason -->
      <div style="margin-bottom:24px;">
        <label style="display:block; font-size:12px; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">Reason</label>
        <input type="text" id="futureToReason" placeholder="e.g., Vacation, Doctor's appointment, Family event..." style="
          width:100%; 
          padding:14px; 
          border:2px solid #e2e8f0; 
          border-radius:10px; 
          font-size:14px;
          box-sizing:border-box;
        ">
      </div>
      
      <!-- Submit -->
      <button onclick="submitFutureTimeOff()" style="
        width:100%;
        padding:16px;
        background:linear-gradient(135deg, #b37e78 0%, #8f5f5a 100%);
        color:white;
        border:none;
        border-radius:12px;
        font-size:15px;
        font-weight:700;
        cursor:pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(179,126,120,0.3);
      " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px rgba(179,126,120,0.4)';"
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(179,126,120,0.3)';">
        Submit Request â†’
      </button>
    </div>
  </div>
</div>
<!-- Agent Notification Panel -->
<div id="agentNotifPanel" style="
  display: none;
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: 380px;
  max-width: 100%;
  background: var(--bg-secondary, white);
  box-shadow: -4px 0 20px rgba(0,0,0,0.15);
  z-index: 10000;
  flex-direction: column;
">
  <div style="display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid var(--border-color, #e2e8f0); background: var(--bg-primary);">
    <div style="font-weight:700; font-size:18px; color:var(--text-primary, #0f172a);">My Notifications</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button onclick="clearAgentNotifications()" style="background:var(--bg-tertiary); border:1px solid var(--border-color); padding:6px 12px; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; color:var(--text-secondary);">Clear All</button>
      <button onclick="closeAgentNotifications()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary);">&times;</button>
    </div>
  </div>
  <div id="agentNotifList" style="flex:1; overflow-y:auto; padding:12px; background: var(--bg-primary);"></div>
</div>
<style>
/* Agent Notification Panel Dark Mode */
body.dark-mode #agentNotifPanel {
  background: var(--bg-secondary);
  box-shadow: -4px 0 30px rgba(0,0,0,0.4);
}
body.dark-mode #agentNotifPanel > div:first-child {
  background: var(--bg-secondary);
  border-color: var(--border-color);
}
body.dark-mode #agentNotifList {
  background: var(--bg-primary);
}
.agent-notif-item {
  display: flex;
  gap: 12px;
  padding: 14px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s;
  position: relative;
  margin-bottom: 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
}
.agent-notif-item:hover {
  background: var(--bg-tertiary);
}
.agent-notif-item.unread {
  background: var(--bg-secondary);
  border-color: var(--accent-primary, #b37e78);
  border-width: 2px;
}
body.dark-mode .agent-notif-item {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
}
body.dark-mode .agent-notif-item:hover {
  background: var(--bg-secondary);
}
body.dark-mode .agent-notif-item.unread {
  background: rgba(179, 126, 120, 0.15);
  border-color: var(--accent-primary);
}
.agent-notif-icon {
  font-size: 20px;
  flex-shrink: 0;
}
.agent-notif-content {
  flex: 1;
  min-width: 0;
}
.agent-notif-message {
  font-size: 13px;
  color: var(--text-primary);
  line-height: 1.4;
  transition: color 0.2s;
}
.agent-notif-time {
  font-size: 11px;
  color: var(--text-tertiary);
  margin-top: 4px;
  transition: color 0.2s;
}
.agent-notif-dot {
  position: absolute;
  top: 14px;
  right: 14px;
  width: 8px;
  height: 8px;
  background: #b37e78;
  border-radius: 50%;
}

/* Agent Goals Panel */
#agentGoalsPanel {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-primary, #f8fafc);
  z-index: 12000;
  flex-direction: column;
  overflow: hidden;
}
#agentGoalsPanel.active {
  display: flex;
}
body.dark-mode #agentGoalsPanel {
  background: var(--bg-primary);
}
.agent-goals-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 32px;
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}
.agent-goals-title {
  font-size: 22px;
  font-weight: 800;
  color: white;
  display: flex;
  align-items: center;
  gap: 12px;
}
.agent-goals-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 10px;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.2s;
}
.agent-goals-close:hover {
  background: rgba(255,255,255,0.3);
}
.agent-goals-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px 32px;
}
.agent-goals-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}
.agent-goals-tab {
  padding: 10px 18px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}
.agent-goals-tab:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}
.agent-goals-tab.active {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  border-color: #f59e0b;
}
.agent-goals-section {
  display: none;
}
.agent-goals-section.active {
  display: block;
}
.agent-goals-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.agent-stat-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 14px;
  padding: 20px;
  text-align: center;
  transition: all 0.2s;
}
.agent-stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}
.agent-stat-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 12px;
  font-size: 22px;
}
.agent-stat-value {
  font-size: 28px;
  font-weight: 900;
  color: var(--text-primary);
  line-height: 1.2;
}
.agent-stat-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 4px;
}
.agent-stat-sub {
  font-size: 11px;
  color: var(--text-tertiary);
  margin-top: 4px;
}
.agent-goals-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.agent-goal-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 18px;
  transition: all 0.2s;
}
.agent-goal-card:hover {
  border-color: var(--accent-primary);
}
.agent-goal-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}
.agent-goal-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
}
.agent-goal-status {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
}
.agent-goal-status.active {
  background: #dcfce7;
  color: #16a34a;
}
.agent-goal-status.at_risk {
  background: #fef3c7;
  color: #d97706;
}
.agent-goal-status.completed {
  background: #dbeafe;
  color: #2563eb;
}
.agent-goal-progress {
  height: 8px;
  background: var(--bg-tertiary);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 12px;
}
.agent-goal-progress-bar {
  height: 100%;
  border-radius: 10px;
  transition: width 0.3s;
}
.agent-goal-meta {
  display: flex;
  gap: 16px;
  margin-top: 10px;
  font-size: 12px;
  color: var(--text-secondary);
}
</style>

<!-- Agent Goals Panel -->
<div id="agentGoalsPanel">
  <div class="agent-goals-header">
    <div class="agent-goals-title">ðŸŽ¯ My Goals & Performance</div>
    <button class="agent-goals-close" onclick="toggleAgentGoalsPanel()">&times;</button>
  </div>
  <div class="agent-goals-content">
    <div class="agent-goals-tabs">
      <button class="agent-goals-tab active" data-tab="overview" onclick="switchAgentGoalsTab('overview')">ðŸ“‹ Overview</button>
      <button class="agent-goals-tab" data-tab="goals" onclick="switchAgentGoalsTab('goals')">ðŸŽ¯ My Goals</button>
      <button class="agent-goals-tab" data-tab="metrics" onclick="switchAgentGoalsTab('metrics')">ðŸ“Š My Metrics</button>
      <button class="agent-goals-tab" data-tab="tasks" onclick="switchAgentGoalsTab('tasks')">ðŸ“ My Tasks</button>
    </div>
    
    <!-- Overview Section -->
    <div id="agentGoalsOverview" class="agent-goals-section active">
      <div class="agent-goals-cards">
        <div class="agent-stat-card">
          <div class="agent-stat-icon" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">ðŸŽ¯</div>
          <div class="agent-stat-value" id="agentActiveGoals">0</div>
          <div class="agent-stat-label">Active Goals</div>
          <div class="agent-stat-sub" id="agentGoalsDueSub">No goals due soon</div>
        </div>
        <div class="agent-stat-card">
          <div class="agent-stat-icon" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">ðŸ“</div>
          <div class="agent-stat-value" id="agentOpenTasks">0</div>
          <div class="agent-stat-label">Open Tasks</div>
          <div class="agent-stat-sub" id="agentTasksSub">None overdue</div>
        </div>
        <div class="agent-stat-card">
          <div class="agent-stat-icon" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);">ðŸ“ˆ</div>
          <div class="agent-stat-value" id="agentOpenTickets">--</div>
          <div class="agent-stat-label">Open Tickets</div>
          <div class="agent-stat-sub">Current workload</div>
        </div>
        <div class="agent-stat-card">
          <div class="agent-stat-icon" style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);">â­</div>
          <div class="agent-stat-value" id="agentWeeksTracked">0</div>
          <div class="agent-stat-label">Weeks Tracked</div>
          <div class="agent-stat-sub">Performance data</div>
        </div>
      </div>
      
      <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 18px; margin-bottom: 16px;">
        <div style="font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px;">ðŸ“¢ Action Items</div>
        <div id="agentActionItems">
          <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 13px;">
            <span>âœ¨</span> All caught up! No urgent items.
          </div>
        </div>
      </div>
    </div>
    
    <!-- Goals Section -->
    <div id="agentGoalsGoals" class="agent-goals-section">
      <div id="agentGoalsList" class="agent-goals-list">
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <div style="font-size: 48px; margin-bottom: 12px;">ðŸŽ¯</div>
          <div style="font-size: 14px;">No active goals yet.</div>
          <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Check with your manager about your development goals.</div>
        </div>
      </div>
    </div>
    
    <!-- Metrics Section -->
    <div id="agentGoalsMetrics" class="agent-goals-section">
      <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
        <div style="font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">ðŸ“Š Recent Performance Metrics</div>
        <div id="agentMetricsTable" style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: var(--bg-tertiary);">
                <th style="padding: 10px; text-align: left; font-weight: 700; border-bottom: 2px solid var(--border-color);">Week</th>
                <th style="padding: 10px; text-align: center; font-weight: 700; border-bottom: 2px solid var(--border-color);">Tickets</th>
                <th style="padding: 10px; text-align: center; font-weight: 700; border-bottom: 2px solid var(--border-color);">Handle Time</th>
                <th style="padding: 10px; text-align: center; font-weight: 700; border-bottom: 2px solid var(--border-color);">CSAT</th>
                <th style="padding: 10px; text-align: center; font-weight: 700; border-bottom: 2px solid var(--border-color);">LC CSAT</th>
              </tr>
            </thead>
            <tbody id="agentMetricsTableBody">
              <tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--text-tertiary);">No metrics data available</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div style="padding: 16px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; border: 1px solid #93c5fd;">
        <div style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: #1e40af;">
          <span>ðŸ’¡</span>
          <span>For detailed CSAT analytics, visit <a href="https://musely.zendesk.com/explore" target="_blank" style="color: #2563eb; font-weight: 600;">Zendesk Explore</a></span>
        </div>
      </div>
    </div>
    
    <!-- Tasks Section -->
    <div id="agentGoalsTasks" class="agent-goals-section">
      <div id="agentTasksList" class="agent-goals-list">
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“</div>
          <div style="font-size: 14px;">No tasks assigned.</div>
          <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Tasks from your manager will appear here.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Meeting Rotation Acknowledgment Modal -->
<div id="meetingRotationAckModal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 20000;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(4px);
">
  <div style="
    background: white;
    border-radius: 20px;
    width: 440px;
    max-width: 95%;
    box-shadow: 0 25px 80px rgba(0,0,0,0.4);
    overflow: hidden;
    animation: slideIn 0.3s ease;
  ">
    <div style="
      padding: 24px;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      text-align: center;
    ">
      <div style="font-size: 48px; margin-bottom: 8px;">ðŸ“…</div>
      <div style="font-size: 20px; font-weight: 800; color: white;">Meeting Rotation Alert!</div>
    </div>
    <div style="padding: 24px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 15px; color: #334155; line-height: 1.6;" id="meetingAckMessage">
          You are assigned to an upcoming Thursday meeting rotation.
        </div>
      </div>
      <div id="meetingAckDetails" style="
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
      ">
        <!-- Details populated by JS -->
      </div>
      <div style="font-size: 12px; color: #64748b; text-align: center; margin-bottom: 20px;">
        âš ï¸ Please acknowledge this notification. It will appear each time you open the schedule until acknowledged.
      </div>
      <button onclick="acknowledgeMeetingRotation()" style="
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      ">
        âœ“ I Acknowledge
      </button>
    </div>
  </div>
</div>
<style>
@keyframes slideIn {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
body.dark-mode #meetingRotationAckModal > div {
  background: var(--bg-secondary);
}
body.dark-mode #meetingRotationAckModal #meetingAckDetails {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.1) 100%);
  border-color: rgba(245, 158, 11, 0.5);
}
body.dark-mode #meetingRotationAckModal div[style*="color: #334155"] {
  color: var(--text-primary) !important;
}
</style>

<style>
/* ============================================
   AGENT COMPACT SUMMARY BAR
   ============================================ */
#agentCompactBar {
  display: none;
  flex-direction: column;
  gap: 16px;
  padding: 20px 24px;
  background: linear-gradient(135deg, #fef7f6 0%, #fff 100%);
  border-bottom: 2px solid var(--border-color);
}

body.agent-mode #agentCompactBar {
  display: flex !important;
}

/* Hide old agent sections */
body.agent-mode #agentQuickActions,
body.agent-mode #agentScheduleBanner,
body.agent-mode #agentAssignmentsBanner {
  display: none !important;
}

.compact-summary {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.summary-card {
  display: flex;
  align-items: flex-start;
  gap: 14px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 16px 20px;
  min-width: 200px;
  flex: 1;
  max-width: 300px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.summary-card.now {
  border-left: 4px solid #22c55e;
}

.summary-card.next {
  border-left: 4px solid #3b82f6;
}

.summary-card.role {
  border-left: 4px solid #8b5cf6;
}

.summary-card.meeting {
  border-left: 4px solid #f59e0b;
  background: linear-gradient(135deg, #fffbeb 0%, var(--card-bg) 100%);
}

.summary-card.openshift {
  border-left: 4px solid #dc2626;
  background: linear-gradient(135deg, #fef2f2 0%, var(--card-bg) 100%);
  animation: subtle-pulse 2s ease-in-out infinite;
}

@keyframes subtle-pulse {
  0%, 100% { box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1); }
  50% { box-shadow: 0 4px 16px rgba(220, 38, 38, 0.2); }
}

.summary-icon {
  font-size: 24px;
  line-height: 1;
}

.summary-content {
  flex: 1;
}

.summary-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.summary-value {
  font-size: 18px;
  font-weight: 800;
  color: var(--text-primary);
  line-height: 1.2;
}

.summary-sub {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.compact-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.compact-tz-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
}

.compact-tz-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
}

.compact-tz-select {
  background: transparent;
  border: none;
  font-size: 14px;
  font-weight: 700;
  color: var(--text-primary);
  cursor: pointer;
  outline: none;
  padding: 0;
}

.compact-btn {
  padding: 12px 20px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.15s ease;
  border: none;
}

.compact-btn.primary {
  background: var(--accent-header);
  color: white;
}

.compact-btn.primary:hover {
  filter: brightness(1.1);
}

.compact-btn.secondary {
  background: white;
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.compact-btn.secondary:hover {
  background: var(--bg-tertiary);
}

/* ============================================
   BIGGER SHIFT CARDS
   ============================================ */
.shift-card-b,
.shiftCard {
  padding: 16px 18px !important;
  border-radius: 12px !important;
  margin-bottom: 10px !important;
}

.sc-time {
  font-size: 14px !important;
  font-weight: 700 !important;
  color: var(--text-secondary) !important;
  margin-bottom: 6px !important;
}

.sc-name {
  font-size: 18px !important;
  font-weight: 800 !important;
  color: var(--text-primary) !important;
}

.sc-role {
  font-size: 12px !important;
  padding: 5px 12px !important;
  margin-top: 8px !important;
  border-radius: 6px !important;
}

/* Channel headers bigger */
.channel-section {
  margin-bottom: 24px !important;
}

.channel-title {
  font-size: 13px !important;
  padding: 6px 14px !important;
  font-weight: 700 !important;
}

/* Day content header */
.day-content-header h2 {
  font-size: 22px !important;
}

.day-content-header #viewDayStats {
  font-size: 13px !important;
}

/* Day tabs bigger */
.day-tab {
  padding: 12px 14px !important;
}

.day-tab .day-name {
  font-size: 15px !important;
  font-weight: 700 !important;
}

.day-tab .day-date {
  font-size: 11px !important;
}

/* Hide dots on day tabs */
.day-tab .dot {
  display: none !important;
}

/* ============================================
   TIMEZONE DROPDOWN - CLEANER
   ============================================ */
#timezoneDropdown {
  min-width: 160px !important;
  padding: 8px !important;
}

#timezoneDropdown > div:first-child {
  font-size: 11px !important;
  padding: 6px 12px 8px !important;
}

#timezoneDropdown label {
  padding: 10px 12px !important;
  font-size: 14px !important;
}

/* Hide the emoji spans */
#timezoneDropdown label span {
  font-size: 14px !important;
}

/* Hide footer note */
#timezoneDropdown > div:last-child:not(label) {
  display: none !important;
}

/* ============================================
   SCROLLING FIXES
   ============================================ */
.day-content-body,
#dayContentBody {
  flex: 1;
  min-height: 0 !important;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch;
}

/* Ensure schedule container fills available space */
#scheduleView {
  flex: 1;
  min-height: 0;
}

/* Ensure day-tabs can scroll */
.day-tabs {
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch;
}

/* ============================================
   NOTIFICATION FIXES
   ============================================ */
body:not(.agent-mode) #btnAgentNotif {
  display: none !important;
}

body.agent-mode #btnNotif {
  display: none !important;
}

body.agent-mode #btnAgentNotif {
  display: flex !important;
}

/* Hide manager buttons in agent mode */
body.agent-mode #btnAdmin,
body.agent-mode #btnMasterMode,
body.agent-mode #drawerToggle {
  display: none !important;
}

/* ============================================
   DARK MODE
   ============================================ */
body.dark-mode #agentCompactBar {
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--card-bg) 100%);
}

body.dark-mode .summary-card {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
}

body.dark-mode .compact-tz-wrapper {
  background: var(--bg-secondary);
}

body.dark-mode .compact-btn.secondary {
  background: var(--bg-secondary);
  border-color: var(--border-color);
}

body.dark-mode .summary-card.meeting {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, var(--bg-tertiary) 100%);
}

body.dark-mode .summary-card.openshift {
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.15) 0%, var(--bg-tertiary) 100%);
}
</style>

<!-- Open Shifts Modal -->
<div id="openShiftsModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeOpenShiftsModal()">
  <div class="modal" style="width:520px; max-width:95%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
    <div class="mHead" style="background:linear-gradient(135deg, var(--modal-gradient-start) 0%, var(--modal-gradient-end) 100%); border-bottom:none; flex-shrink:0;">
      <span class="mTitle" style="color:white;">ðŸ“‹ Open Shifts</span>
      <button type="button" class="btn ghost" style="padding:6px 12px; color:white; background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.25);" onclick="closeOpenShiftsModal()">âœ•</button>
    </div>
    <div class="mBody" style="flex:1; overflow-y:auto; padding:20px;">
      <div id="openShiftsList" style="min-height:100px;">
        <div style="text-align:center; color:var(--text-secondary); padding:20px;">Loading open shifts...</div>
      </div>
    </div>
  </div>
</div>

<!-- Fill Open Shift Modal -->
<div id="fillShiftModal" class="overlay" style="display:none;" onclick="if(event.target===this) closeFillShiftModal()">
  <div class="modal" style="width:400px; max-width:95%;">
    <div class="mHead" style="background:linear-gradient(135deg, var(--modal-gradient-start) 0%, var(--modal-gradient-end) 100%); border-bottom:none;">
      <span class="mTitle" style="color:white;">ðŸ‘¤ Assign Agent</span>
      <button type="button" class="btn ghost" style="padding:6px 12px; color:white; background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.25);" onclick="closeFillShiftModal()">âœ•</button>
    </div>
    <div class="mBody" style="padding:20px;">
      <div id="fillShiftInfo" style="background:var(--bg-tertiary); border-radius:10px; padding:14px; margin-bottom:16px;">
        <!-- Shift info populated dynamically -->
      </div>
      
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:8px; text-transform:uppercase;">Select Agent</label>
        <select id="fillShiftAgent" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; font-size:14px; background:var(--input-bg); color:var(--text-primary);">
          <option value="">-- Select an agent --</option>
        </select>
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="checkbox" id="fillShiftNotify" checked style="width:18px; height:18px; accent-color:var(--accent-primary);">
          <span style="font-size:13px; color:var(--text-primary);">Notify agent via Google Chat</span>
        </label>
      </div>
      
      <button onclick="submitFillShift()" style="
        width:100%;
        padding:14px;
        background:linear-gradient(135deg, var(--modal-gradient-start) 0%, var(--modal-gradient-end) 100%);
        color:white;
        border:none;
        border-radius:10px;
        font-size:14px;
        font-weight:700;
        cursor:pointer;
        box-shadow:0 4px 12px var(--modal-btn-shadow);
        transition:all 0.2s;
      " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px var(--modal-btn-hover-shadow)';"
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px var(--modal-btn-shadow)';">
        Assign Agent â†’
      </button>
    </div>
  </div>
</div>

<style>
/* Open Shifts Styles */
.open-shift-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 10px;
  transition: all 0.2s;
}

/* ============================================
   MOBILE RESPONSIVE STYLES
   ============================================ */

/* Mobile breakpoints */
@media (max-width: 768px) {
  /* Header adjustments */
  .header {
    padding: 0 12px;
    height: 56px;
    flex: 0 0 56px;
  }
  .hTitle {
    font-size: 14px;
  }
  .hLeft img {
    width: 28px !important;
    height: 28px !important;
  }
  .metaGroup {
    display: none; /* Hide pills on mobile */
  }
  .seg {
    display: none; /* Hide Schedule/Metrics toggle on mobile */
  }
  .iconBtn {
    width: 34px;
    height: 34px;
  }
  .action-btn {
    padding: 6px 10px;
    font-size: 10px;
  }
  #btnMasterMode {
    display: none; /* Hide master mode on mobile */
  }
  
  /* Navigation */
  .navGroup {
    margin-right: 8px;
    padding-right: 8px;
  }
  .navBtn {
    width: 28px;
    height: 28px;
  }
  
  /* Load controls */
  #loadMoreControls {
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px;
  }
  #loadMoreControls button {
    font-size: 11px;
    padding: 6px 10px;
  }
  
  /* Calendar grid - stack vertically on mobile */
  .calGrid {
    flex-direction: column;
    gap: 12px;
    overflow-x: hidden;
    overflow-y: auto;
    padding: 0 4px 8px 4px;
  }
  .dayCol {
    min-width: 100%;
    max-width: 100%;
    flex-shrink: 0;
  }
  .dayHead {
    padding: 12px;
    font-size: 14px;
  }
  .dayBody {
    padding: 8px;
    gap: 8px;
  }
  
  /* Shift cards */
  .shift {
    min-width: 100%;
    padding: 10px 12px;
  }
  .shift-card-b {
    padding: 12px;
  }
  .sc-name {
    font-size: 14px;
  }
  .sc-time {
    font-size: 11px;
  }
  .sc-role {
    font-size: 10px;
  }
  
  /* Schedule view (day tabs + content) */
  .schedule-container {
    flex-direction: column;
    gap: 12px;
  }
  .day-tabs {
    flex-direction: row;
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    padding-bottom: 8px;
    gap: 6px;
  }
  .day-tab {
    min-width: 80px;
    padding: 10px 8px;
    flex-shrink: 0;
  }
  .day-tab .day-name {
    font-size: 12px;
  }
  .day-tab .day-date {
    font-size: 9px;
  }
  .day-content-header {
    padding: 14px 16px;
  }
  .day-content-body {
    padding: 12px;
  }
  
  /* Shifts grid */
  .shifts-grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  /* Channel sections */
  .channel-section {
    margin-bottom: 20px;
  }
  .channel-header {
    flex-wrap: wrap;
    gap: 8px;
  }
  .channel-title {
    font-size: 11px;
    padding: 5px 8px;
  }
  
  /* Coverage dashboard */
  .cov-panel {
    border-radius: 12px;
  }
  .cov-header {
    padding: 12px 14px;
    flex-wrap: wrap;
    gap: 10px;
  }
  .cov-icon {
    width: 36px;
    height: 36px;
  }
  .cov-title {
    font-size: 14px;
  }
  .cov-stats {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  .cov-stat {
    padding: 10px 8px;
  }
  .cov-stat-num {
    font-size: 20px;
  }
  .cov-stat-label {
    font-size: 9px;
  }
  
  /* Drawer */
  .drawer {
    width: 100%;
    right: -100%;
  }
  
  /* Modals */
  .modal {
    width: 95% !important;
    max-width: 95% !important;
    margin: 10px;
    max-height: 90vh;
  }
  .mHead, .mHeader {
    padding: 14px 16px !important;
  }
  .mTitle {
    font-size: 15px !important;
  }
  .mBody {
    padding: 16px !important;
  }
  
  /* Agent toolbar */
  .agent-toolbar {
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px;
  }
  .agent-toolbar-btn {
    font-size: 11px;
    padding: 8px 12px;
  }
  .agent-toolbar-item {
    padding: 8px 10px;
  }
  
  /* Agent schedule banner */
  .agent-schedule-banner {
    flex-direction: column;
    gap: 10px;
  }
  .agent-schedule-card {
    flex: none;
    width: 100%;
  }
  
  /* Filter card */
  .filter-card {
    padding: 10px;
    margin-bottom: 10px;
  }
  
  /* Coverage banner */
  .coverage-banner {
    padding: 10px 14px;
  }
  .coverage-chips {
    gap: 8px;
    flex-wrap: wrap;
  }
  .coverage-chip {
    padding: 6px 10px;
    font-size: 11px;
  }
  
  /* Tool grid in admin */
  .tool-grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  /* Profile sections */
  .profile-section {
    padding: 14px;
  }
  .agent-stats-grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  .agent-stat-card {
    padding: 12px;
  }
  
  /* PTO ring sizing */
  .pto-ring {
    width: 80px !important;
    height: 80px !important;
  }
  .pto-value {
    font-size: 20px !important;
  }
  
  /* Notification panels */
  #notifPanel {
    width: 95% !important;
    right: 2.5% !important;
    max-height: 80vh;
  }
  #agentNotifPanel {
    width: 95% !important;
    right: 2.5% !important;
    max-height: 80vh;
  }
  
  /* Balance list items */
  .balance-agent-row {
    flex-direction: column;
    gap: 10px;
    align-items: stretch !important;
  }
  .balance-agent-row input {
    width: 100% !important;
  }
  
  /* Hide certain elements on mobile */
  .manager-presence-pill {
    display: none;
  }
}

/* Small mobile (< 480px) */
@media (max-width: 480px) {
  .header {
    padding: 0 8px;
  }
  .hTitle {
    font-size: 12px;
  }
  .hRight {
    gap: 8px;
  }
  .iconBtn {
    width: 32px;
    height: 32px;
  }
  .iconBtn svg {
    width: 16px;
    height: 16px;
  }
  
  /* Even tighter on very small screens */
  .dayHead {
    padding: 10px;
    font-size: 13px;
  }
  .shift-card-b {
    padding: 10px;
  }
  .modal {
    margin: 5px;
    max-height: 95vh;
  }
  .cov-stats {
    grid-template-columns: 1fr 1fr 1fr;
  }
  
  /* Simplify day tabs */
  .day-tab {
    min-width: 60px;
    padding: 8px 6px;
  }
  .day-tab .day-name {
    font-size: 11px;
  }
}

/* Tablet (768px - 1024px) */
@media (min-width: 769px) and (max-width: 1024px) {
  .calGrid .dayCol {
    min-width: 280px;
    max-width: 280px;
  }
  .shifts-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  }
  .drawer {
    width: 300px;
    right: -300px;
  }
}
.open-shift-card:hover {
  border-color: var(--accent-primary);
  box-shadow: 0 2px 8px var(--shadow-sm);
}
.open-shift-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 8px;
}
.open-shift-date {
  font-weight: 700;
  font-size: 14px;
  color: var(--text-primary);
}
.open-shift-team {
  font-size: 11px;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 6px;
  background: var(--accent-primary);
  color: white;
}
.open-shift-time {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 6px;
}
.open-shift-reason {
  font-size: 11px;
  color: var(--text-tertiary);
  font-style: italic;
  padding: 8px;
  background: var(--bg-tertiary);
  border-radius: 6px;
  margin-bottom: 10px;
}
.open-shift-btn {
  width: 100%;
  padding: 10px;
  background: linear-gradient(135deg, var(--modal-gradient-start) 0%, var(--modal-gradient-end) 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.open-shift-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px var(--modal-btn-shadow);
}

/* Coverage Dashboard Open Shifts Section */
.cov-open-shifts-section {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-color);
}
.cov-open-shifts-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.cov-open-shifts-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 6px;
}
.cov-open-shifts-badge {
  background: #dc2626;
  color: white;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 10px;
}
.cov-open-shift-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: var(--bg-tertiary);
  border-radius: 8px;
  margin-bottom: 6px;
  font-size: 12px;
}
.cov-open-shift-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.cov-open-shift-team {
  font-weight: 600;
  color: var(--text-primary);
}
.cov-open-shift-time {
  color: var(--text-secondary);
  font-size: 11px;
}
.cov-open-shift-fill-btn {
  padding: 6px 12px;
  background: var(--accent-primary);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
}
</style>

<script>
/* ============================================
   COMPACT SUMMARY BAR INITIALIZATION
   ============================================ */
(function() {
  // Initialize when DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCompactBar);
  } else {
    setTimeout(initCompactBar, 300);
  }
  
  function initCompactBar() {
    // Set timezone dropdown to current preference
    const tzSelect = document.getElementById('compactTzSelect');
    if (tzSelect) {
      try {
        const prefs = getUserPrefs();
        tzSelect.value = prefs.timezone || 'PST';
      } catch(e) {}
    }
    
    // Update summary bar periodically
    setInterval(updateCompactBar, 5000);
    setTimeout(updateCompactBar, 1000);
    
    // Watch for agent mode changes
    const observer = new MutationObserver(() => {
      if (document.body.classList.contains('agent-mode')) {
        setTimeout(updateCompactBar, 100);
      }
    });
    observer.observe(document.body, { attributes: true });
  }
  
  window.updateCompactBar = function() {
    if (!document.body.classList.contains('agent-mode')) return;
    
    const myName = window._myName || '';
    if (!myName) return;
    
    const allData = window._filteredData || window._data || [];
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentHour = now.getHours() + now.getMinutes() / 60;
    
    // Get my shifts sorted
    const myShifts = allData
      .filter(s => s.person && s.person.toLowerCase().trim() === myName.toLowerCase().trim())
      .sort((a, b) => {
        if (a.date !== b.date) return (a.date || '').localeCompare(b.date || '');
        return (a.start || '').localeCompare(b.start || '');
      });
    
    // Find current shift
    let currentShift = null;
    for (const shift of myShifts) {
      if (shift.date !== today) continue;
      const startH = parseTimeHour(shift.start);
      const endH = parseTimeHour(shift.end);
      if (currentHour >= startH && currentHour < endH) {
        currentShift = shift;
        break;
      }
    }
    
    // Find next shift
    let nextShift = null;
    for (const shift of myShifts) {
      if (shift.date < today) continue;
      if (shift.date === today) {
        const startH = parseTimeHour(shift.start);
        if (startH <= currentHour) continue;
      }
      nextShift = shift;
      break;
    }
    
    // Update NOW card
    const nowValue = document.getElementById('summaryNowValue');
    const nowTeam = document.getElementById('summaryNowTeam');
    if (nowValue) {
      if (currentShift) {
        nowValue.textContent = `${toAmPm(currentShift.start)} - ${toAmPm(currentShift.end)}`;
        if (nowTeam) nowTeam.textContent = currentShift.team || '';
      } else {
        nowValue.textContent = 'Off Shift';
        if (nowTeam) nowTeam.textContent = 'No active shift right now';
      }
    }
    
    // Update NEXT card
    const nextValue = document.getElementById('summaryNextValue');
    const nextDate = document.getElementById('summaryNextDate');
    if (nextValue) {
      if (nextShift) {
        nextValue.textContent = `${toAmPm(nextShift.start)} - ${toAmPm(nextShift.end)}`;
        if (nextDate) {
          const d = new Date(nextShift.date + 'T12:00:00');
          const dateStr = nextShift.date === today ? 'Today' : 
            d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          nextDate.textContent = `${dateStr} â€¢ ${nextShift.team || ''}`;
        }
      } else {
        nextValue.textContent = 'No upcoming shifts';
        if (nextDate) nextDate.textContent = '';
      }
    }
    
    // Update ROLE card
    const roleCard = document.getElementById('summaryRoleCard');
    const roleValue = document.getElementById('summaryRoleValue');
    const roleDate = document.getElementById('summaryRoleDate');
    const meetingLabel = document.getElementById('agentMeetingRoleLabel');
    
    if (roleCard && meetingLabel) {
      const roleText = meetingLabel.textContent;
      if (roleText && roleText !== 'Meeting Role' && roleText !== '--') {
        roleCard.style.display = 'flex';
        if (roleValue) roleValue.textContent = roleText;
        const meetingDateEl = document.getElementById('agentMeetingRoleDate');
        if (roleDate && meetingDateEl) roleDate.textContent = meetingDateEl.textContent || '';
      } else {
        roleCard.style.display = 'none';
      }
    }
    
    // Update Meeting Role Card (check meeting rotations)
    updateAgentMeetingRole(myName);
    
    // Update Open Shifts Card
    updateAgentOpenShifts();
  };
  
  // Check meeting rotations for agent's role
  async function updateAgentMeetingRole(myName) {
    const meetingCard = document.getElementById('summaryMeetingCard');
    const meetingRole = document.getElementById('summaryMeetingRole');
    const meetingDate = document.getElementById('summaryMeetingDate');
    const meetingIcon = document.getElementById('summaryMeetingIcon');
    
    if (!meetingCard || !myName) return;
    
    try {
      // Check for upcoming meetings in the next 7 days
      const rotations = window._meetingRotationsCache || {};
      const myNameLower = myName.toLowerCase().trim();
      let foundRole = null;
      let foundDate = null;
      
      const today = new Date();
      for (let i = 0; i < 7; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() + i);
        const dateKey = checkDate.toISOString().split('T')[0];
        const meeting = rotations[dateKey];
        
        if (!meeting) continue;
        
        if ((meeting.captain || '').toLowerCase().trim() === myNameLower) {
          foundRole = 'Captain';
          foundDate = dateKey;
          meetingIcon.textContent = 'ðŸ‘¤';
          break;
        } else if ((meeting.backup1 || '').toLowerCase().trim() === myNameLower || 
                   (meeting.backup2 || '').toLowerCase().trim() === myNameLower) {
          foundRole = 'Backup';
          foundDate = dateKey;
          meetingIcon.textContent = 'ðŸ”„';
          break;
        } else if ((meeting.lcAgents || []).map(a => a.toLowerCase().trim()).includes(myNameLower)) {
          foundRole = 'LC Agent';
          foundDate = dateKey;
          meetingIcon.textContent = 'ðŸ’¬';
          break;
        }
      }
      
      if (foundRole && foundDate) {
        meetingCard.style.display = 'flex';
        meetingRole.textContent = foundRole;
        const d = new Date(foundDate + 'T12:00:00');
        meetingDate.textContent = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      } else {
        meetingCard.style.display = 'none';
      }
    } catch (e) {
      console.error('Error updating meeting role:', e);
      meetingCard.style.display = 'none';
    }
  }
  
  // Check for open shifts
  async function updateAgentOpenShifts() {
    const openShiftsCard = document.getElementById('summaryOpenShiftsCard');
    const openShiftsCount = document.getElementById('summaryOpenShiftsCount');
    
    if (!openShiftsCard) return;
    
    try {
      const res = await fetch('/open-shifts');
      const data = await res.json();
      
      if (data.ok && data.openShifts && data.openShifts.length > 0) {
        openShiftsCard.style.display = 'flex';
        openShiftsCount.textContent = `${data.openShifts.length} Available`;
      } else {
        openShiftsCard.style.display = 'none';
      }
    } catch (e) {
      openShiftsCard.style.display = 'none';
    }
  }
  
  function parseTimeHour(timeStr) {
    if (!timeStr) return 0;
    const parts = String(timeStr).split(':');
    return parseInt(parts[0], 10) + (parseInt(parts[1], 10) || 0) / 60;
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AGENT GOALS PANEL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  window.toggleAgentGoalsPanel = function() {
    const panel = document.getElementById('agentGoalsPanel');
    if (!panel) return;
    
    if (panel.classList.contains('active')) {
      panel.classList.remove('active');
    } else {
      panel.classList.add('active');
      loadAgentGoalsData();
    }
  };
  
  window.switchAgentGoalsTab = function(tab) {
    // Update tab buttons
    document.querySelectorAll('.agent-goals-tab').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    
    // Show/hide sections
    document.querySelectorAll('.agent-goals-section').forEach(section => {
      section.classList.remove('active');
    });
    
    const sectionMap = {
      'overview': 'agentGoalsOverview',
      'goals': 'agentGoalsGoals',
      'metrics': 'agentGoalsMetrics',
      'tasks': 'agentGoalsTasks'
    };
    
    const activeSection = document.getElementById(sectionMap[tab]);
    if (activeSection) activeSection.classList.add('active');
  };
  
  async function loadAgentGoalsData() {
    const myName = window._myName;
    if (!myName) return;
    
    try {
      // Load goals data for this agent using POST endpoint
      const res = await fetch('./?action=goals/get', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agentName: myName })
      });
      
      // Check response before parsing
      if (!res.ok) {
        console.warn('Goals endpoint returned status:', res.status);
        return;
      }
      
      const text = await res.text();
      if (!text || text.startsWith('<!DOCTYPE') || text.startsWith('<html')) {
        console.warn('Goals endpoint returned HTML instead of JSON');
        return;
      }
      
      const data = JSON.parse(text);
      
      if (data.ok && data.goals) {
        const goals = data.goals;
        
        // Overview Stats
        const activeGoals = (goals.smartGoals || []).filter(g => g.status === 'active' || g.status === 'at_risk');
        document.getElementById('agentActiveGoals').textContent = activeGoals.length;
        
        const today = new Date().toISOString().split('T')[0];
        const twoWeeks = new Date(Date.now() + 14 * 86400000).toISOString().split('T')[0];
        const dueSoon = activeGoals.filter(g => g.dueDate && g.dueDate <= twoWeeks);
        document.getElementById('agentGoalsDueSub').textContent = dueSoon.length > 0 
          ? `${dueSoon.length} due within 2 weeks` 
          : 'No goals due soon';
        
        // Tasks
        const tasks = goals.tasks || [];
        const openTasks = tasks.filter(t => t.status !== 'done' && t.status !== 'completed');
        const overdueTasks = openTasks.filter(t => t.dueDate && t.dueDate < today);
        document.getElementById('agentOpenTasks').textContent = openTasks.length;
        document.getElementById('agentTasksSub').textContent = overdueTasks.length > 0 
          ? `${overdueTasks.length} overdue` 
          : 'None overdue';
        
        // Metrics weeks
        const metrics = goals.performanceMetrics || [];
        document.getElementById('agentWeeksTracked').textContent = metrics.length;
        
        // Render Goals List
        renderAgentGoalsList(goals.smartGoals || []);
        
        // Render Metrics Table
        renderAgentMetricsTable(metrics);
        
        // Render Tasks List
        renderAgentTasksList(tasks);
        
        // Build action items
        buildAgentActionItems(goals, overdueTasks, dueSoon);
      }
      
      // Load open tickets count
      const metricsRes = await fetch('./?action=roster/get');
      const metricsData = await metricsRes.json();
      if (metricsData.ok && metricsData.members) {
        const me = metricsData.members.find(m => m.name === myName);
        if (me && me.opens !== undefined) {
          document.getElementById('agentOpenTickets').textContent = me.opens || 0;
        }
      }
      
    } catch (e) {
      console.error('Error loading agent goals:', e);
    }
  }
  
  function renderAgentGoalsList(goals) {
    const container = document.getElementById('agentGoalsList');
    if (!container) return;
    
    if (!goals || goals.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <div style="font-size: 48px; margin-bottom: 12px;">ðŸŽ¯</div>
          <div style="font-size: 14px;">No active goals yet.</div>
          <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Check with your manager about your development goals.</div>
        </div>`;
      return;
    }
    
    container.innerHTML = goals.map(goal => {
      const progress = goal.progress || 0;
      const statusColors = {
        'active': { bg: '#dcfce7', color: '#16a34a', bar: '#22c55e' },
        'at_risk': { bg: '#fef3c7', color: '#d97706', bar: '#f59e0b' },
        'completed': { bg: '#dbeafe', color: '#2563eb', bar: '#3b82f6' },
        'on_hold': { bg: '#f1f5f9', color: '#64748b', bar: '#94a3b8' }
      };
      const colors = statusColors[goal.status] || statusColors['active'];
      const dueDate = goal.dueDate ? new Date(goal.dueDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'No due date';
      
      return `
        <div class="agent-goal-card">
          <div class="agent-goal-header">
            <div class="agent-goal-title">${escapeHtml(goal.title || 'Untitled Goal')}</div>
            <span class="agent-goal-status ${goal.status}" style="background: ${colors.bg}; color: ${colors.color};">
              ${goal.status === 'at_risk' ? 'At Risk' : (goal.status || 'active').charAt(0).toUpperCase() + (goal.status || 'active').slice(1)}
            </span>
          </div>
          ${goal.specific ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(goal.specific)}</div>` : ''}
          <div class="agent-goal-progress">
            <div class="agent-goal-progress-bar" style="width: ${progress}%; background: ${colors.bar};"></div>
          </div>
          <div class="agent-goal-meta">
            <span>ðŸ“… Due: ${dueDate}</span>
            <span>ðŸ“Š ${progress}% complete</span>
          </div>
        </div>
      `;
    }).join('');
  }
  
  function renderAgentMetricsTable(metrics) {
    const tbody = document.getElementById('agentMetricsTableBody');
    if (!tbody) return;
    
    if (!metrics || metrics.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--text-tertiary);">No metrics data available</td></tr>';
      return;
    }
    
    // Sort by week date descending
    const sorted = [...metrics].sort((a, b) => (b.weekStartDate || '').localeCompare(a.weekStartDate || ''));
    
    tbody.innerHTML = sorted.slice(0, 8).map(m => {
      const weekDate = m.weekStartDate ? new Date(m.weekStartDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '--';
      return `
        <tr>
          <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">${weekDate}</td>
          <td style="padding: 10px; border-bottom: 1px solid var(--border-color); text-align: center;">${m.ticketsSolved || '--'}</td>
          <td style="padding: 10px; border-bottom: 1px solid var(--border-color); text-align: center;">${m.avgHandleTime || '--'}</td>
          <td style="padding: 10px; border-bottom: 1px solid var(--border-color); text-align: center;">${m.csat ? m.csat + '%' : '--'}</td>
          <td style="padding: 10px; border-bottom: 1px solid var(--border-color); text-align: center;">${m.lcCsat ? m.lcCsat + '%' : '--'}</td>
        </tr>
      `;
    }).join('');
  }
  
  function renderAgentTasksList(tasks) {
    const container = document.getElementById('agentTasksList');
    if (!container) return;
    
    const openTasks = (tasks || []).filter(t => t.status !== 'done' && t.status !== 'completed');
    
    if (openTasks.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“</div>
          <div style="font-size: 14px;">No open tasks!</div>
          <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">You're all caught up.</div>
        </div>`;
      return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    container.innerHTML = openTasks.map(task => {
      const isOverdue = task.dueDate && task.dueDate < today;
      const dueDate = task.dueDate ? new Date(task.dueDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'No due date';
      const priorityColors = {
        'high': '#dc2626',
        'medium': '#f59e0b',
        'low': '#22c55e'
      };
      
      return `
        <div class="agent-goal-card" style="${isOverdue ? 'border-color: #dc2626; background: rgba(220, 38, 38, 0.05);' : ''}">
          <div class="agent-goal-header">
            <div class="agent-goal-title">${escapeHtml(task.title || 'Untitled Task')}</div>
            <span style="padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; background: ${priorityColors[task.priority] || '#64748b'}20; color: ${priorityColors[task.priority] || '#64748b'};">
              ${(task.priority || 'normal').toUpperCase()}
            </span>
          </div>
          ${task.notes ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(task.notes)}</div>` : ''}
          <div class="agent-goal-meta">
            <span style="${isOverdue ? 'color: #dc2626; font-weight: 600;' : ''}">${isOverdue ? 'âš ï¸ OVERDUE: ' : 'ðŸ“… Due: '}${dueDate}</span>
            <span>Status: ${(task.status || 'pending').replace('_', ' ')}</span>
          </div>
        </div>
      `;
    }).join('');
  }
  
  function buildAgentActionItems(goals, overdueTasks, dueSoonGoals) {
    const container = document.getElementById('agentActionItems');
    if (!container) return;
    
    let html = '';
    
    if (overdueTasks && overdueTasks.length > 0) {
      html += `
        <div onclick="switchAgentGoalsTab('tasks')" style="padding: 12px; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 1px solid #fca5a5; border-radius: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 8px;">
          <span style="font-size: 18px;">ðŸ”´</span>
          <div style="flex: 1;">
            <div style="font-size: 13px; font-weight: 600; color: #dc2626;">${overdueTasks.length} overdue task${overdueTasks.length > 1 ? 's' : ''} need attention</div>
          </div>
          <span style="color: #dc2626; font-size: 12px;">View â†’</span>
        </div>
      `;
    }
    
    if (dueSoonGoals && dueSoonGoals.length > 0) {
      html += `
        <div onclick="switchAgentGoalsTab('goals')" style="padding: 12px; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 1px solid #fcd34d; border-radius: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 8px;">
          <span style="font-size: 18px;">ðŸŽ¯</span>
          <div style="flex: 1;">
            <div style="font-size: 13px; font-weight: 600; color: #d97706;">${dueSoonGoals.length} goal${dueSoonGoals.length > 1 ? 's' : ''} due within 2 weeks</div>
          </div>
          <span style="color: #d97706; font-size: 12px;">View â†’</span>
        </div>
      `;
    }
    
    if (!html) {
      html = `
        <div style="padding: 12px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #86efac; border-radius: 8px; display: flex; align-items: center; gap: 10px; color: #16a34a; font-size: 13px;">
          <span>âœ¨</span> All caught up! No urgent items.
        </div>
      `;
    }
    
    container.innerHTML = html;
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MEETING ROTATION ACKNOWLEDGMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  window.checkMeetingRotationAcknowledgment = async function() {
    const myName = window._myName;
    if (!myName || window._isManager) return;
    
    try {
      const rotations = window._meetingRotationsCache || {};
      const myNameLower = myName.toLowerCase().trim();
      let foundRole = null;
      let foundDate = null;
      let meetingTime = null;
      
      const today = new Date();
      for (let i = 0; i < 7; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() + i);
        const dateKey = checkDate.toISOString().split('T')[0];
        const meeting = rotations[dateKey];
        
        if (!meeting) continue;
        
        if ((meeting.captain || '').toLowerCase().trim() === myNameLower) {
          foundRole = 'Captain';
          foundDate = dateKey;
          meetingTime = meeting.time || '12:00 PM - 1:15 PM PST';
          break;
        } else if ((meeting.backup1 || '').toLowerCase().trim() === myNameLower) {
          foundRole = 'Backup 1';
          foundDate = dateKey;
          meetingTime = meeting.time || '12:00 PM - 1:15 PM PST';
          break;
        } else if ((meeting.backup2 || '').toLowerCase().trim() === myNameLower) {
          foundRole = 'Backup 2';
          foundDate = dateKey;
          meetingTime = meeting.time || '12:00 PM - 1:15 PM PST';
          break;
        } else if ((meeting.lcAgents || []).map(a => a.toLowerCase().trim()).includes(myNameLower)) {
          foundRole = 'LC Agent';
          foundDate = dateKey;
          meetingTime = meeting.time || '12:00 PM - 1:15 PM PST';
          break;
        }
      }
      
      if (foundRole && foundDate) {
        // Check if already acknowledged
        const ackKey = `meeting_ack_${myName}_${foundDate}`;
        const acknowledged = localStorage.getItem(ackKey);
        
        if (!acknowledged) {
          showMeetingAcknowledgmentModal(foundRole, foundDate, meetingTime);
        }
      }
    } catch (e) {
      console.error('Error checking meeting acknowledgment:', e);
    }
  };
  
  function showMeetingAcknowledgmentModal(role, date, time) {
    const modal = document.getElementById('meetingRotationAckModal');
    const details = document.getElementById('meetingAckDetails');
    const message = document.getElementById('meetingAckMessage');
    
    if (!modal || !details) return;
    
    const dateObj = new Date(date + 'T12:00:00');
    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    
    message.innerHTML = `You have been assigned to the <strong>Thursday Meeting Rotation</strong> with an important role.`;
    
    const roleIcons = {
      'Captain': 'ðŸ‘¤',
      'Backup 1': 'ðŸ”„',
      'Backup 2': 'ðŸ”„',
      'LC Agent': 'ðŸ’¬'
    };
    
    const roleDescriptions = {
      'Captain': 'You will be leading the meeting and facilitating discussion.',
      'Backup 1': 'You are the primary backup if the Captain is unavailable.',
      'Backup 2': 'You are the secondary backup for this meeting.',
      'LC Agent': 'You will be participating in the Live Chat portion of the meeting.'
    };
    
    details.innerHTML = `
      <div style="text-align: center;">
        <div style="font-size: 32px; margin-bottom: 8px;">${roleIcons[role] || 'ðŸ“…'}</div>
        <div style="font-size: 18px; font-weight: 800; color: #92400e; margin-bottom: 4px;">${role}</div>
        <div style="font-size: 14px; color: #78350f; margin-bottom: 12px;">${dateStr}</div>
        <div style="font-size: 13px; color: #92400e; background: rgba(255,255,255,0.5); padding: 8px 12px; border-radius: 8px; margin-bottom: 8px;">
          ðŸ• ${time}
        </div>
        <div style="font-size: 12px; color: #78350f; font-style: italic;">
          ${roleDescriptions[role] || 'Please be prepared for your role.'}
        </div>
      </div>
    `;
    
    // Store the date for acknowledgment
    modal.dataset.ackDate = date;
    modal.style.display = 'flex';
  }
  
  window.acknowledgeMeetingRotation = function() {
    const modal = document.getElementById('meetingRotationAckModal');
    if (!modal) return;
    
    const date = modal.dataset.ackDate;
    const myName = window._myName;
    
    if (date && myName) {
      const ackKey = `meeting_ack_${myName}_${date}`;
      localStorage.setItem(ackKey, new Date().toISOString());
    }
    
    modal.style.display = 'none';
    
    // Show confirmation toast
    if (typeof toast === 'function') {
      toast('Meeting rotation acknowledged! âœ“', 'success');
    }
  };
  
  // Call check on schedule load (delay to ensure rotations are loaded)
  setTimeout(() => {
    if (window._meetingRotationsCache && Object.keys(window._meetingRotationsCache).length > 0) {
      checkMeetingRotationAcknowledgment();
    }
  }, 2000);
  
})();
</script>

</body>
</html>
