const functions=require("@google-cloud/functions-framework"),{Firestore:Firestore}=require("@google-cloud/firestore"),pathMod=require("path"),fs=require("fs"),{OAuth2Client:OAuth2Client}=require("google-auth-library"),CLIENT_ID=process.env.CLIENT_ID;CLIENT_ID||console.error("‚ö†Ô∏è  CLIENT_ID environment variable is not set. Google authentication will not work.");const client=new OAuth2Client(CLIENT_ID),CHAT_BOT_URL=process.env.CHAT_BOT_URL||"https://musely-chat-bot-63798769550.us-central1.run.app";async function sendShiftNotification(e,t){try{const s=await db.collection("people").where("email","==",e).limit(1).get();if(s.empty)return console.warn(`sendShiftNotification: No person found with email: ${e}`),{success:!1,error:"Agent not found in system"};const a=s.docs[0].data().chatUserId;if(!a)return console.warn(`sendShiftNotification: Agent ${e} has no chatUserId`),{success:!1,error:"Agent has no Chat ID configured"};console.log(`Sending notification to ${e} (${a})...`);const n=await fetch(CHAT_BOT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"SEND_NOTIFICATION",chatUserId:a,cardData:{date:t.date||"N/A",start:t.start||"N/A",end:t.end||"N/A",role:t.role||"Agent",team:t.team||"Support",notes:t.notes||"Your shift has been updated."}})});if(!n.ok){const e=await n.text();return console.error("Chat bot error response:",e),{success:!1,error:e}}const o=await n.json();return console.log(`‚úÖ Notification sent successfully to ${e}:`,o),{success:!0}}catch(e){return console.error("sendShiftNotification error:",e),{success:!1,error:e.message}}}async function getAgentEmailByName(e){if(!e)return null;const t=await db.collection("people").get(),s=String(e).toLowerCase().trim();for(const e of t.docs){const t=e.data(),a=String(t.name||"").toLowerCase().trim();if(a===s||a.split(" ")[0]===s.split(" ")[0])return t.email||null}return console.warn(`getAgentEmailByName: No email found for "${e}"`),null}const db=new Firestore,metadataCache={people:null,teams:null,lastFetch:0,TTL:3e5},agentProfileCache=new Map,AGENT_PROFILE_TTL=3e5;function invalidateMetadataCache(){console.log("üóëÔ∏è  Invalidating metadata cache"),metadataCache.people=null,metadataCache.teams=null,metadataCache.lastFetch=0}function invalidateAgentProfileCache(e=null){if(e){const t=e.toLowerCase().trim();agentProfileCache.delete(t),console.log(`üóëÔ∏è  Invalidated profile cache for ${e}`)}else agentProfileCache.clear(),console.log("üóëÔ∏è  Invalidated all agent profile caches")}async function getCachedMetadata(){const e=Date.now();if(metadataCache.people&&metadataCache.teams&&e-metadataCache.lastFetch<metadataCache.TTL)return console.log("üì¶ Serving metadata from cache"),{people:metadataCache.people,teams:metadataCache.teams};console.log("üîÑ Fetching fresh metadata from Firestore");const[t,s]=await Promise.all([db.collection("people").get(),db.collection("teams").orderBy("sort","asc").get()]);return metadataCache.people=t.docs.map(e=>({id:e.id,...e.data()})),metadataCache.teams=s.docs.map(e=>({id:e.id,...e.data()})),metadataCache.lastFetch=e,{people:metadataCache.people,teams:metadataCache.teams}}const ZD_CONFIG={subdomain:process.env.ZENDESK_SUBDOMAIN||"musely",adminEmail:process.env.ZENDESK_ADMIN_EMAIL||"genaro.barrera@trusper.com",apiToken:process.env.ZENDESK_API_TOKEN};ZD_CONFIG.apiToken||console.warn("‚ö†Ô∏è  ZENDESK_API_TOKEN not set. Zendesk integration will be disabled.");const zdFetch=async(e,t=3,s=1e4)=>{if(!ZD_CONFIG.apiToken){const e=new Error("Zendesk API token not configured");throw e.status=500,e}const a=Buffer.from(`${ZD_CONFIG.adminEmail}/token:${ZD_CONFIG.apiToken}`).toString("base64");let n;for(let o=0;o<=t;o++)try{const n=new AbortController,r=setTimeout(()=>n.abort(),s),i=await fetch(e,{headers:{Authorization:`Basic ${a}`},signal:n.signal});if(clearTimeout(r),429===i.status){const e=parseInt(i.headers.get("Retry-After")||"60",10);if(o<t){const s=Math.min(Math.pow(2,o)*e*1e3,3e5);console.warn(`‚è±Ô∏è  Zendesk rate limit hit. Retrying in ${s/1e3}s (attempt ${o+1}/${t})`),await new Promise(e=>setTimeout(e,s));continue}const s=new Error("Zendesk rate limit exceeded. Please try again later.");throw s.status=429,s}if(!i.ok){let e=`Zendesk API Error: ${i.statusText}`;401===i.status?e="Zendesk authentication failed. Please check credentials.":403===i.status?e="Access denied to Zendesk resource. Please check permissions.":404===i.status?e="Zendesk resource not found.":i.status>=500&&(e="Zendesk server error. Please try again later.");const t=new Error(e);throw t.status=i.status,t}return i.json()}catch(e){if(n=e,"AbortError"===e.name){const e=new Error(`Zendesk request timeout after ${s}ms`);if(e.status=408,n=e,o<t){const e=1e3*Math.pow(2,o);console.warn(`‚è±Ô∏è  Request timeout. Retrying in ${e/1e3}s (attempt ${o+1}/${t})`),await new Promise(t=>setTimeout(t,e));continue}}if(e.status>=500&&o<t){const e=1e3*Math.pow(2,o);console.warn(`üîÑ Server error. Retrying in ${e/1e3}s (attempt ${o+1}/${t})`),await new Promise(t=>setTimeout(t,e));continue}throw e}throw n};function timeRangesOverlap(e,t,s,a){const n=parseTimeDecimal(e),o=parseTimeDecimal(t),r=parseTimeDecimal(s),i=parseTimeDecimal(a);return(0!==n||0!==o)&&((0!==r||0!==i)&&(n<i&&r<o))}function csvEscape(e){if(null==e)return"";const t=String(e);return t.search(/("|,|\n|\r)/g)>=0?`"${t.replace(/"/g,'""')}"`:t}async function checkDoubleBooking(e,t,s,a,n,o=null){try{const r=s.split("T")[0],i=await e.collection("scheduleDays").where("date","==",r).get(),d=[];let c=!1;return i.forEach(e=>{const s=e.data(),r=s.assignments||[],i=(s.team||e.id.split("__")[1]||"").toLowerCase();r.forEach(r=>{if((!o||String(r.id)!==String(o)&&String(r.assignmentId)!==String(o))&&String(r.person||"").toLowerCase().trim()===String(t||"").toLowerCase().trim()&&timeRangesOverlap(a,n,r.start,r.end)){const t=i.includes("lunch")||(r.role||"").toLowerCase().includes("lunch");d.push({docId:e.id,team:s.team||e.id.split("__")[1]||"",start:toAmPm(r.start),end:toAmPm(r.end),assignmentId:r.id||r.assignmentId,isLunchConflict:t}),t&&(c=!0)}})}),d.hasLunchConflict=c,d}catch(e){return console.error("Double booking check error:",e),[]}}function parseTimeDecimal(e){if(!e)return 0;try{const t=e.match(/(\d+):(\d+)\s?(AM|PM)?/i);if(!t)return 0;let s=parseInt(t[1]),a=parseInt(t[2]),n=t[3]?t[3].toUpperCase():null;return"PM"===n&&s<12&&(s+=12),"AM"===n&&12===s&&(s=0),s+a/60}catch(e){return 0}}function normalizeTimeOffType(e){const t=String(e||"").trim().toLowerCase();return t.includes("make")?"make_up":(t.includes("pto"),"pto")}function readJsonBody(e){if(!e.body)return{};if("object"==typeof e.body)return e.body;try{return JSON.parse(String(e.body))}catch{return{}}}function requirePreviewKey(e,t){const s=process.env.PREVIEW_KEY;if(!s)return!0;return(e.get("x-preview-key")||String(e.query.key||""))===s||(t.status(403).send("Forbidden"),!1)}function normalizeValue(e){if(e&&"object"==typeof e&&"function"==typeof e.toDate)return e.toDate().toISOString();if(Array.isArray(e))return e.map(normalizeValue);if(e&&"object"==typeof e){const t={};for(const[s,a]of Object.entries(e))t[s]=normalizeValue(a);return t}return e}function toIsoNow(){return(new Date).toISOString()}function logWithTrace(e,t,s,a,n={}){const o={timestamp:(new Date).toISOString(),traceId:e,level:t,operation:s,message:a,...n};console.log(JSON.stringify(o))}function sanitizeZendeskEmail(e){return e?String(e).replace(/\\/g,"\\\\").replace(/"/g,'\\"'):""}function validateDaysParam(e,t=30){const s=parseInt(e||t,10);return Math.max(1,Math.min(s,90))}function sanitizePatch(e={}){const t={},s=["person","status","notifyStatus","notes","start","end","role"];for(const a of s)void 0!==e[a]&&(t[a]=e[a]);return t}function hhmm(e){const t=String(e||"").trim();if(!t)return"";const s=t.match(/^(\d{1,2}:\d{2})(:\d{2})?$/);return s?s[1].padStart(5,"0"):t}function normalizeAssignment(e={}){const t=String(e.person??e.agentName??e.name??e.personName??e.assignee??"").trim()||"Unassigned",s=String(e.role??e.queue??e.work??"").trim(),a=e.start??e.startTime??e.from??e.shiftStart??"",n=e.end??e.endTime??e.to??e.shiftEnd??"",o=a?hhmm(a):"",r=n?hhmm(n):"",i=o?toAmPm(o):"",d=r?toAmPm(r):"";return{...e,person:t,role:s,start:o,end:r,startLabel:i,endLabel:d,name:t,agentName:t,personName:t,startTime:o,endTime:r,from:o,to:r}}function toAmPm(e){const t=hhmm(e),s=t.match(/^(\d{2}):(\d{2})$/);if(!s)return t;let a=parseInt(s[1],10);const n=a>=12?"PM":"AM";return a%=12,0===a&&(a=12),`${a}:${s[2]} ${n}`}function clampDays(e,t=60){const s=parseInt(e||"14",10)||14;return Math.min(Math.max(s,1),t)}function buildScheduleDocIds(e,t,s){const a=new Date(`${t}T00:00:00Z`);if(isNaN(a.getTime()))throw new Error("Invalid start date");const n=[];for(let t=0;t<s;t++){const s=new Date(a);s.setUTCDate(s.getUTCDate()+t);const o=s.getUTCFullYear(),r=String(s.getUTCMonth()+1).padStart(2,"0"),i=String(s.getUTCDate()).padStart(2,"0");n.push(`${o}-${r}-${i}__${e}`)}return n}async function fetchSchedule(e,t,s){const a=buildScheduleDocIds(e,t,s).map(e=>db.collection("scheduleDays").doc(e));let n=(await db.getAll(...a)).filter(e=>e.exists).map(e=>({id:e.id,...normalizeValue(e.data())}));return n=n.map(e=>({...e,assignments:(e.assignments||[]).map(normalizeAssignment)})),n}function contentTypeFor(e){const t=pathMod.extname(e).toLowerCase();return".html"===t?"text/html; charset=utf-8":".js"===t?"application/javascript; charset=utf-8":".css"===t?"text/css; charset=utf-8":".json"===t?"application/json; charset=utf-8":".png"===t?"image/png":".jpg"===t||".jpeg"===t?"image/jpeg":".svg"===t?"image/svg+xml":".csv"===t?"text/csv; charset=utf-8":"application/octet-stream"}function servePublicFile(e,t){const s=pathMod.join(__dirname,"public"),a="/"===e||""===e?"/index.html":e,n=pathMod.join(s,a);if(!n.startsWith(s))return t.status(403).send("Forbidden"),!0;if(!fs.existsSync(n)||fs.statSync(n).isDirectory())return!1;const o=fs.readFileSync(n);return t.status(200).set("Content-Type",contentTypeFor(n)).send(o),!0}functions.http("helloHttp",async(e,t)=>{const s=Date.now();let a="",n="";try{if(a=e.get("X-Trace-Id")||`trace-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.set("Access-Control-Allow-Origin","*"),t.set("Access-Control-Allow-Methods","GET,POST,OPTIONS"),t.set("Access-Control-Allow-Headers","Content-Type,Authorization,x-preview-key,X-Trace-Id"),t.set("X-Trace-Id",a),"OPTIONS"===e.method)return logWithTrace(a,"info","OPTIONS","CORS preflight handled"),t.status(204).send("");n=String(e.path||"/").toLowerCase(),n.length>1&&n.endsWith("/")&&(n=n.slice(0,-1));const o=(e.query.action||e.body&&e.body.action||"").toLowerCase();if(o&&(n="/"+o),logWithTrace(a,"info","request",`${e.method} ${n}`,{ip:e.ip,userAgent:e.get("user-agent")}),"/health"!==n&&!requirePreviewKey(e,t))return void logWithTrace(a,"warn","auth","Preview key validation failed");if(!["/health","/people","/teams","/roles","/schedule","/initdashboard","/assignment/replace","/assignment/status","/assignment/notify","/assignment/notes","/assignment/update","/base-schedule","/assignment/add","/assignment/delete","/admin/generate","/admin/archive","/admin/seed-base","/update-master-schedule","/agent-profile","/config","/getmetadata","/notifications/send","/notifications/pending","/notifications/dismiss","/holidays/list","/holidays/add","/holidays/delete","/holiday/accrue","/holiday/history","/agent/schedule","/balances/list","/balances/update","/audit/logs","/timeoff/request","/audit/log","/timeoff/list","/staffing/rules","/staffing/rules/delete","/timeoff/count","/timeoff/resolve","/admin/wipe-future","/admin/regenerate-all","/schedule/extended","/schedule/past","/agents/add","/schedule/future","/agent/notifications","/agent/notifications/read","/swap/request","/swap/pending","/swap/respond","/schedule/export","/schedule/check-conflict","/manager/heartbeat","/manager/presence","/zendesk/agent/open","/zendesk/agent/badcsat"].includes(n)&&"GET"===e.method&&!o&&servePublicFile(e.path||"/",t))return;if("/health"===n)return t.status(200).json({ok:!0,service:"scheduler-api"});if("/agent/schedule"===n&&"POST"===e.method){const s=readJsonBody(e),a=String(s.agentName||"").trim(),n=s.start||(new Date).toISOString().split("T")[0],o=clampDays(s.days||14);if(!a)return t.status(400).json({error:"agentName is required"});console.log(`üì± Agent schedule request: ${a}, ${o} days from ${n}`);const r=new Date(`${n}T00:00:00Z`),i=new Date(r);i.setUTCDate(i.getUTCDate()+o);const d=i.toISOString().split("T")[0],c=await db.collection("scheduleDays").where("date",">=",n).where("date","<=",d).get();console.log(`üìä Found ${c.size} schedule day docs`);const l=[];let u=0,m=0;return c.forEach(e=>{const t=e.data();u+=(t.assignments||[]).length;const s=(t.assignments||[]).filter(e=>String(e.person||"").toLowerCase().trim()===a.toLowerCase().trim());m+=s.length,s.length>0&&l.push({id:e.id,date:t.date,team:t.team||e.id.split("__")[1]||"",assignments:s.map(e=>{const t=e.start?hhmm(e.start):"",s=e.end?hhmm(e.end):"";return{...e,start:t,end:s,startLabel:t?toAmPm(t):"",endLabel:s?toAmPm(s):"",person:e.person||"Unassigned"}})})}),console.log(`‚úÖ Agent ${a}: ${m} of ${u} assignments returned`),t.set("Cache-Control","private, max-age=300"),t.set("X-Agent-Cache","enabled"),t.status(200).json({success:!0,agentName:a,schedule:{results:l},meta:{docsScanned:c.size,totalAssignments:u,agentAssignments:m,cacheHint:"5min"}})}if("/people"===n&&"GET"===e.method){const{people:e}=await getCachedMetadata();return t.status(200).json({count:e.length,people:e})}if("/admin/wipe-future"===n&&"POST"===e.method){const s=readJsonBody(e);if(!(!0===s.confirm))return t.status(400).json({error:"Safety check failed",message:"You must pass confirm: true to wipe future days"});try{const e=(new Date).toISOString().split("T")[0];console.log(`üóëÔ∏è WIPE REQUEST: Deleting all scheduleDays from ${e} onwards...`);const s=await db.collection("scheduleDays").where("date",">=",e).get();if(s.empty)return t.status(200).json({ok:!0,deleted:0,message:"No future schedule days found to delete."});const a=450;let n=0,o=db.batch(),r=0;for(const e of s.docs)o.delete(e.ref),r++,n++,r>=a&&(await o.commit(),o=db.batch(),r=0,console.log(`  Deleted ${n} docs so far...`));return r>0&&await o.commit(),console.log(`‚úÖ WIPE COMPLETE: Deleted ${n} future schedule days`),t.status(200).json({ok:!0,deleted:n,fromDate:e,message:`Successfully deleted ${n} future schedule days.`})}catch(e){return console.error("Wipe Future Error:",e),t.status(500).json({error:e.message})}}if("/admin/regenerate-all"===n&&"POST"===e.method){const s=readJsonBody(e),a=!0===s.confirm,n=Math.min(Math.max(parseInt(s.days||"14",10),1),60);if(!a)return t.status(400).json({error:"Safety check failed",message:"You must pass confirm: true to regenerate"});try{const e=(new Date).toISOString().split("T")[0],s=[];console.log(`üîÑ REGENERATE: Step 1 - Wiping future days from ${e}...`),s.push(`Starting wipe from ${e}`);const a=await db.collection("scheduleDays").where("date",">=",e).get();let o=0;if(!a.empty){const e=450;let t=db.batch(),s=0;for(const n of a.docs)t.delete(n.ref),s++,o++,s>=e&&(await t.commit(),t=db.batch(),s=0);s>0&&await t.commit()}s.push(`Deleted ${o} existing schedule days`),console.log(`  ‚úì Deleted ${o} days`),console.log("üîÑ REGENERATE: Step 2 - Loading base_schedule templates...");const r=await db.collection("base_schedule").get(),i={},d=new Set;r.forEach(e=>{const t=e.data().items||[];i[e.id]=t,t.forEach(e=>{e.team&&d.add(e.team)})});const c=Array.from(d);s.push(`Found ${c.length} teams: ${c.join(", ")}`),console.log(`  ‚úì Loaded templates for teams: ${c.join(", ")}`),console.log(`üîÑ REGENERATE: Step 3 - Generating ${n} days...`);const l=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],u=new Date;let m=0;for(let e=0;e<n;e++){const t=new Date(u);t.setDate(u.getDate()+e);const s=t.toISOString().split("T")[0],a=l[t.getDay()],n=i[a]||[];if(0!==n.length)for(const e of c){const t=n.filter(t=>t.team===e);if(0===t.length)continue;const a=`${s}__${e}`,o=db.collection("scheduleDays").doc(a),r=toIsoNow(),i=t.map(e=>({id:"gen_"+Math.random().toString(36).substr(2,9),start:e.start,end:e.end,role:e.role||"Agent",person:e.person,status:"Active",notifyStatus:"Generated",notes:e.focus||"",updatedAt:r}));await o.set({id:a,date:s,team:e,assignments:i,createdAt:r,updatedAt:r}),m++}}return s.push(`Generated ${m} new schedule day documents`),console.log(`‚úÖ REGENERATE COMPLETE: Created ${m} new schedule days`),t.status(200).json({ok:!0,deleted:o,generated:m,daysForward:n,teams:c,log:s,message:`Wiped ${o} old days and generated ${m} new days for ${n} days forward.`})}catch(e){return console.error("Regenerate All Error:",e),t.status(500).json({error:e.message})}}if("/timeoff/count"===n&&"GET"===e.method)try{const e=await db.collection("time_off_requests").where("status","==","pending").get();return t.status(200).json({ok:!0,count:e.size})}catch(e){return t.status(500).json({error:e.message})}if("getMetadata"===o||"/getmetadata"===n)try{const s=!1!==readJsonBody(e).isManager,{people:a,teams:n}=await getCachedMetadata(),o=s?a:a.map(e=>({id:e.id,name:e.name}));return t.status(200).json({people:o,teams:n,zendeskMetrics:[],success:!0})}catch(e){return console.error("Metadata Error:",e),t.status(500).json({error:e.message})}if("/teams"===n&&"GET"===e.method){const{teams:e}=await getCachedMetadata();return t.status(200).json({count:e.length,teams:e})}if("/timeoff/request"===n&&"POST"===e.method)try{const s=readJsonBody(e),{person:a,reason:n,type:o,date:r,shiftStart:i,shiftEnd:d,duration:c,team:l,makeUpDate:u}=s,m=normalizeTimeOffType(o);if("make_up"===m&&!String(u||"").trim())return t.status(400).json({error:"Make Up Time requires a make-up date."});if(!a||!n)return t.status(400).json({error:"Missing fields"});const g=db.collection("time_off_requests").doc();return await g.set({id:g.id,person:a,reason:n,type:o||"pto",status:"pending",date:r||(new Date).toISOString().split("T")[0],shiftStart:i||"",shiftEnd:d||"",duration:c||"shift",team:l||"",typeKey:m,makeUpDate:u||"",createdAt:(new Date).toISOString()}),t.status(200).json({ok:!0,id:g.id})}catch(e){return t.status(500).json({error:e.message})}if("/audit/log"===n&&"POST"===e.method)try{const s=readJsonBody(e),{action:a,manager:n,target:o,details:r,date:i}=s;return await db.collection("audit_log").add({action:a||"UNKNOWN",manager:n||"System",target:o||"",details:r||"",date:i||"",timestamp:(new Date).toISOString()}),t.status(200).json({ok:!0})}catch(e){return console.error("Audit Log Error:",e),t.status(500).json({error:e.message})}if("/audit/logs"===n&&"GET"===e.method)try{const e=await db.collection("audit_log").orderBy("timestamp","desc").limit(100).get(),s=[];return e.forEach(e=>{s.push({id:e.id,...e.data()})}),t.status(200).json({ok:!0,logs:s})}catch(e){return console.error("Audit log error:",e),t.status(500).json({error:e.message})}if(("/config"===n||"config"===o)&&"POST"===e.method)try{const s=await client.verifyIdToken({idToken:e.body.credential,audience:CLIENT_ID}),a=s.getPayload().email,n=await db.collection("people").where("email","==",a).get();if(n.empty)return t.status(403).json({error:"Access Denied: User not in system."});const o=n.docs[0].data();return t.status(200).json({userEmail:a,matchedPerson:o.name,isManager:"admin"===o.role||"MASTER"===o.role,role:o.role})}catch(e){return console.error("Auth Failure:",e.message),t.status(401).json({error:"Unauthorized"})}if("/notifications/pending"===n&&"GET"===e.method)try{const e=(new Date).toISOString().split("T")[0],s=await db.collection("scheduleDays").where("date",">=",e).orderBy("date","asc").get(),a=[];return s.forEach(e=>{const t=e.data();(t.assignments||[]).forEach(s=>{"Pending"===s.notifyStatus&&a.push({docId:e.id,assignmentId:s.id,date:t.date||e.id.split("__")[0],team:t.team||e.id.split("__")[1]||"",person:s.person,start:toAmPm(s.start||""),end:toAmPm(s.end||""),role:s.role||"",notes:s.notes||"",updatedAt:s.updatedAt||""})})}),t.status(200).json({ok:!0,count:a.length,notifications:a})}catch(e){return console.error("Pending notifications error:",e),t.status(500).json({error:e.message})}if("/notifications/dismiss"===n&&"POST"===e.method){const s=readJsonBody(e),a=String(s.docId||"").trim(),n=String(s.assignmentId||"").trim();if(!a||!n)return t.status(400).json({error:"Missing docId or assignmentId"});try{const e=db.collection("scheduleDays").doc(a);return await db.runTransaction(async t=>{const s=await t.get(e);if(!s.exists)throw new Error("Doc not found");const a=s.data().assignments||[],o=a.findIndex(e=>String(e.id||"").trim()===n);if(-1===o)throw new Error("Assignment not found");a[o].notifyStatus="Dismissed",a[o].updatedAt=toIsoNow(),t.update(e,{assignments:a,updatedAt:toIsoNow()})}),t.status(200).json({ok:!0,docId:a,assignmentId:n,status:"Dismissed"})}catch(e){return t.status(500).json({error:e.message})}}if("/staffing/rules"===n&&"GET"===e.method)try{const e=await db.collection("staffing_rules").get(),s=[];return e.forEach(e=>s.push({id:e.id,...e.data()})),t.status(200).json(s)}catch(e){return t.status(500).json({error:e.message})}if("/staffing/rules"===n&&"POST"===e.method)try{const s=readJsonBody(e);return await db.collection("staffing_rules").add(s),t.status(200).json({ok:!0})}catch(e){return t.status(500).json({error:e.message})}if("/staffing/rules/delete"===n&&"POST"===e.method)try{const s=readJsonBody(e);return await db.collection("staffing_rules").doc(s.idx).delete(),t.status(200).json({ok:!0})}catch(e){return t.status(500).json({error:e.message})}if("/roles"===n&&"GET"===e.method){const e=(await db.collection("roles").orderBy("sort","asc").get()).docs.map(e=>({id:e.id,...normalizeValue(e.data())}));return t.status(200).json({count:e.length,roles:e})}if("/initdashboard"===n&&"POST"===e.method)try{const s=readJsonBody(e),{isManager:a,agentName:n}=s,o=(new Date).toLocaleDateString("en-CA",{timeZone:"America/Los_Angeles"}),r=e.query.start||o,i=parseInt(e.query.days||"14"),d=e.query.teamKey||"",[c,l,u]=(r||o).split("-").map(Number),m=new Date(c,l-1,u),g=new Date(m);g.setDate(g.getDate()+i);const h=r,f=g.toISOString().split("T")[0];let p=db.collection("scheduleDays").where("date",">=",h).where("date","<=",f);const y=await p.get(),w=[];return console.log(`üìä initDashboard: isManager=${a}, agentName=${n}, docs=${y.size}`),y.forEach(e=>{const t=e.data();d&&t.team!==d||(t.assignments&&Array.isArray(t.assignments)&&(t.assignments=t.assignments.filter(e=>{if(!a&&n){return String(e.person||"").toLowerCase().trim()===String(n).toLowerCase().trim()}return!0}).map(e=>{const t=e.start?hhmm(e.start):"",s=e.end?hhmm(e.end):"";return{...e,start:t,end:s,startLabel:t?toAmPm(t):"",endLabel:s?toAmPm(s):"",person:e.person||"Unassigned"}})),t.assignments&&(t.assignments.length>0||a)&&(t.id=e.id,w.push(t)))}),a?(t.set("Cache-Control","no-cache"),t.set("X-Cache-Type","manager")):(t.set("Cache-Control","private, max-age=300"),t.set("X-Cache-Type","agent")),t.status(200).json({success:!0,schedule:{results:w}})}catch(e){return console.error("Dashboard Error:",e),t.status(500).json({error:e.message})}if("/assignment/replace"===n&&"POST"===e.method){logWithTrace(a,"info","assignment/replace","Processing assignment replacement");const s=readJsonBody(e),n=String(s.docId||"").trim(),o=String(s.assignmentId||"").trim(),r=String(s.newPerson||"").trim(),i=String(s.notes||"").trim(),d=String(s.notifyMode||"defer").trim();if(!n||!o||!r)return logWithTrace(a,"error","assignment/replace","Missing required fields",{docId:n,assignmentId:o,newPerson:r}),t.status(400).json({error:"Missing docId, assignmentId, or newPerson"});if(!["defer","send"].includes(d))return logWithTrace(a,"error","assignment/replace","Invalid notifyMode",{notifyMode:d}),t.status(400).json({error:"notifyMode must be 'defer' or 'send'"});const c=db.collection("scheduleDays").doc(n);try{let e="",s={};const l=await db.runTransaction(async t=>{const a=await t.get(c);if(!a.exists)throw new Error(`scheduleDays doc not found: ${n}`);const l=a.data()||{},u=Array.isArray(l.assignments)?l.assignments:[],m=u.findIndex(e=>String(e.id||"").trim()===o);if(-1===m)throw new Error(`Assignment not found: ${o}`);const g=u[m]||{};e=g.person||"",s={date:l.date||n.split("__")[0],start:toAmPm(g.start||""),end:toAmPm(g.end||""),role:g.role||"",team:l.team||n.split("__")[1]||"",notes:i||`Shift reassigned from ${e}`};let h="Pending";"send"===d&&(h="Sent");const f=toIsoNow(),p=u.slice();return p[m]={...g,person:r,notes:i,notifyStatus:h,notifyError:null,updatedAt:f},t.update(c,{assignments:p,updatedAt:f}),p[m]});logWithTrace(a,"info","assignment/replace","Assignment replaced",{docId:n,assignmentId:o,oldPerson:e,newPerson:r,notifyMode:d});let u={sent:!1};if("send"===d){const t=await getAgentEmailByName(r);if(t){const d=await sendShiftNotification(t,{...s,notes:i||`You have been assigned this shift (previously: ${e})`});if(u={sent:d.success,recipient:r,error:d.error},!d.success){const e=await c.get(),t=(e.data()||{}).assignments||[],s=t.findIndex(e=>String(e.id||"").trim()===o);-1!==s&&(t[s].notifyStatus="Pending",t[s].notifyError=d.error,await c.update({assignments:t,updatedAt:toIsoNow()})),logWithTrace(a,"warn","assignment/replace","Notification send failed",{docId:n,assignmentId:o,recipient:r,error:d.error})}}else{const e=`Could not find email for ${r}`;u={sent:!1,recipient:r,error:e};const t=await c.get(),s=(t.data()||{}).assignments||[],i=s.findIndex(e=>String(e.id||"").trim()===o);-1!==i&&(s[i].notifyStatus="Pending",s[i].notifyError=e,await c.update({assignments:s,updatedAt:toIsoNow()})),logWithTrace(a,"warn","assignment/replace","Could not find agent email",{docId:n,assignmentId:o,recipient:r})}}return t.status(200).json({ok:!0,docId:n,assignmentId:o,updated:normalizeValue(l),notification:u})}catch(e){return logWithTrace(a,"error","assignment/replace","Error replacing assignment",{error:e.message,stack:e.stack}),t.status(500).json({error:e.message||"Replace failed"})}}if("/notifications/send"===n&&"POST"===e.method){logWithTrace(a,"info","notifications/send","Processing notification send request");const s=readJsonBody(e).notifications||[];if(!Array.isArray(s)||0===s.length)return logWithTrace(a,"error","notifications/send","Invalid notifications array"),t.status(400).json({error:"Invalid notifications array"});const n=[];for(const e of s)try{const t=String(e.docId||"").trim(),s=String(e.assignmentId||"").trim();if(!t||!s){n.push({docId:t,assignmentId:s,success:!1,error:"Missing IDs"});continue}const o=db.collection("scheduleDays").doc(t),r=await o.get();if(!r.exists){n.push({docId:t,assignmentId:s,success:!1,error:"Doc not found"});continue}const i=r.data()||{},d=i.assignments||[],c=d.find(e=>String(e.id||"").trim()===s);if(!c){n.push({docId:t,assignmentId:s,success:!1,error:"Assignment not found"});continue}const l=await getAgentEmailByName(c.person);if(!l){const e=`No email for ${c.person}`;n.push({docId:t,assignmentId:s,success:!1,error:e});const a=d.findIndex(e=>String(e.id||"").trim()===s);-1!==a&&(d[a].notifyStatus="Pending",d[a].notifyError=e,d[a].updatedAt=toIsoNow(),await o.update({assignments:d,updatedAt:toIsoNow()}));continue}const u={date:i.date||t.split("__")[0],start:toAmPm(c.start||""),end:toAmPm(c.end||""),role:c.role||"",team:i.team||t.split("__")[1]||"",notes:c.notes||"You have a scheduled shift."},m=await sendShiftNotification(l,u),g=d.findIndex(e=>String(e.id||"").trim()===s);-1!==g&&(m.success?(d[g].notifyStatus="Sent",d[g].notifyError=null,d[g].updatedAt=toIsoNow(),logWithTrace(a,"info","notifications/send","Notification sent successfully",{docId:t,assignmentId:s,person:c.person})):(d[g].notifyStatus="Pending",d[g].notifyError=m.error||"Unknown error",d[g].updatedAt=toIsoNow(),logWithTrace(a,"warn","notifications/send","Notification send failed",{docId:t,assignmentId:s,person:c.person,error:m.error})),await o.update({assignments:d,updatedAt:toIsoNow()})),n.push({docId:t,assignmentId:s,person:c.person,success:m.success,error:m.error,retryable:!m.success})}catch(t){logWithTrace(a,"error","notifications/send","Exception during notification send",{docId:e.docId,assignmentId:e.assignmentId,error:t.message}),n.push({docId:e.docId,assignmentId:e.assignmentId,success:!1,error:t.message,retryable:!0})}const o=n.filter(e=>e.success).length,r=n.filter(e=>!e.success).length;return logWithTrace(a,"info","notifications/send","Notification send completed",{total:n.length,success:o,failed:r}),t.status(200).json({ok:!0,sent:o,failed:r,total:n.length,results:n})}if("/assignment/status"===n&&"POST"===e.method){const s=readJsonBody(e),a=String(s.docId||"").trim(),n=String(s.assignmentId||"").trim(),o=String(s.status||"").trim();if(!a||!n||!o)return t.status(400).json({error:"Missing docId, assignmentId, or status"});const r=db.collection("scheduleDays").doc(a);try{const e=await db.runTransaction(async e=>{const t=await e.get(r);if(!t.exists)throw new Error(`scheduleDays doc not found: ${a}`);const s=t.data()||{},i=Array.isArray(s.assignments)?s.assignments:[],d=i.findIndex(e=>String(e.id||"").trim()===n);if(-1===d)throw new Error(`Assignment not found: ${n}`);const c=toIsoNow(),l=i.slice();return l[d]={...l[d],status:o,updatedAt:c},e.update(r,{assignments:l,updatedAt:c}),l[d]});return t.status(200).json({ok:!0,docId:a,assignmentId:n,updated:normalizeValue(e)})}catch(e){return console.error("status error:",e),t.status(500).json({error:e.message||"Status update failed"})}}if("/agents/add"===n&&"POST"===e.method)try{const s=readJsonBody(e),a=String(s.name||"").trim(),n=String(s.email||"").trim(),o=!1!==s.active,r=s.chatUserId?String(s.chatUserId).trim():"",i=Array.isArray(s.roles)?s.roles:[],d=Array.isArray(s.teams)?s.teams:[];if(!a||!n)return t.status(400).json({error:"name and email are required"});const c=a.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""),l={name:a,email:n,active:o,chatUserId:r||null,roles:i,teams:d,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};return await db.collection("people").doc(c).set(l,{merge:!0}),invalidateMetadataCache(),invalidateAgentProfileCache(a),console.log(`‚úÖ Agent added:  ${a} (${c})`),t.status(200).json({ok:!0,id:c})}catch(e){return console.error("Add agent error:",e),t.status(500).json({error:e.message})}if("/schedule/extended"===n&&"POST"===e.method){const s=e.body||{},{daysBack:a=30,daysForward:n=60,targetEmail:o}=s,r=Math.min(Math.max(parseInt(a,10)||30,0),30),i=Math.min(Math.max(parseInt(n,10)||60,1),60),d=new Date,c=new Date(d);c.setDate(c.getDate()-r);const l=c.toISOString().split("T")[0],u=r+i,m=(await db.collection("teams").get()).docs.map(e=>e.id),g=[];for(const e of m){const t=await fetchSchedule(e,l,u);g.push(...t)}const h=d.toISOString().split("T")[0];return t.status(200).json({ok:!0,results:g,meta:{startDate:l,endDate:new Date(c.getTime()+24*(u-1)*60*60*1e3).toISOString().split("T")[0],today:h,daysBack:r,daysForward:i,totalDays:u}})}if("/schedule/past"===n&&"POST"===e.method){const s=e.body||{},{daysBack:a=30,agentName:n,isManager:o=!0}=s,r=Math.min(Math.max(parseInt(a,10)||30,1),30),i=new Date,d=new Date(i);d.setDate(d.getDate()-r);const c=d.toISOString().split("T")[0],l=new Date(i);l.setDate(l.getDate()-1);const u=(await db.collection("teams").get()).docs.map(e=>e.id),m=[];for(const e of u){const t=await fetchSchedule(e,c,r);!o&&n&&t.forEach(e=>{e.assignments&&(e.assignments=e.assignments.filter(e=>String(e.person||"").toLowerCase().trim()===String(n).toLowerCase().trim()))}),m.push(...t.filter(e=>o||e.assignments&&e.assignments.length>0))}return t.status(200).json({ok:!0,results:m,meta:{startDate:c,daysBack:r,filteredFor:n||null}})}if("/schedule/future"===n&&"POST"===e.method){const s=e.body||{},{daysForward:a=60,startFrom:n,agentName:o,isManager:r=!0}=s,i=Math.min(Math.max(parseInt(a,10)||60,1),60),d=new Date,c=(d.toISOString().split("T")[0],n?new Date(n+"T00:00:00Z"):d),l=c.toISOString().split("T")[0];try{const e=(await db.collection("teams").get()).docs.map(e=>e.id),s=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],a=[];for(let t=0;t<i;t++){const n=new Date(c);n.setDate(c.getDate()+t);const o=n.toISOString().split("T")[0],r=s[n.getDay()];e.forEach(e=>{a.push({docId:`${o}__${e}`,date:o,dow:r,team:e})})}const n=a.map(e=>db.collection("scheduleDays").doc(e.docId)),d=await db.getAll(...n),u=new Set,m=[];d.forEach((e,t)=>{if(e.exists){u.add(a[t].docId);const s=e.data();let n=(s.assignments||[]).map(normalizeAssignment);!r&&o&&(n=n.filter(e=>String(e.person||"").toLowerCase().trim()===String(o).toLowerCase().trim())),(r||n.length>0)&&m.push({id:e.id,...normalizeValue(s),assignments:n})}});const g=await db.collection("base_schedule").get(),h={};g.forEach(e=>{h[e.id]=e.data().items||[]});const f=a.filter(e=>!u.has(e.docId));let p=0;const y=[];if(f.length>0){const e=450;let t=db.batch(),s=0;for(const a of f){const n=(h[a.dow]||[]).filter(e=>e.team===a.team);if(0===n.length)continue;const i=db.collection("scheduleDays").doc(a.docId),d=toIsoNow(),c=n.map(e=>({id:"gen_"+Math.random().toString(36).substr(2,9),start:e.start,end:e.end,role:e.role||"Agent",person:e.person,status:"Active",notifyStatus:"Generated",notes:e.focus||"",updatedAt:d})),l={id:a.docId,date:a.date,team:a.team,assignments:c,createdAt:d,updatedAt:d};t.set(i,l),s++,p++;let u=c.map(normalizeAssignment);!r&&o&&(u=u.filter(e=>String(e.person||"").toLowerCase().trim()===String(o).toLowerCase().trim())),(r||u.length>0)&&y.push({id:a.docId,...l,assignments:u}),s>=e&&(await t.commit(),t=db.batch(),s=0)}s>0&&await t.commit(),console.log(`üìÖ Generated ${p} missing future schedule days`)}const w=[...m,...y];return t.status(200).json({ok:!0,results:w,meta:{startDate:l,daysForward:i,existingDays:m.length,generatedDays:p}})}catch(e){return console.error("Schedule Future Error:",e),t.status(500).json({error:e.message})}}if("/agent/notifications"===n&&"POST"===e.method)try{const s=readJsonBody(e),a=String(s.agentName||"").trim();if(!a)return t.status(400).json({error:"Missing agentName"});const n=await db.collection("agent_notifications").where("recipientName","==",a).orderBy("createdAt","desc").limit(50).get(),o=[];n.forEach(e=>{o.push({id:e.id,...e.data()})});const r=o.filter(e=>!e.read).length;return t.status(200).json({ok:!0,notifications:o,unreadCount:r})}catch(e){return console.error("Agent notifications error:",e),t.status(500).json({error:e.message})}if("/agent/notifications/read"===n&&"POST"===e.method)try{const s=readJsonBody(e),a=String(s.notifId||"").trim();return a?(await db.collection("agent_notifications").doc(a).update({read:!0,readAt:(new Date).toISOString()}),t.status(200).json({ok:!0})):t.status(400).json({error:"Missing notifId"})}catch(e){return console.error("Mark notification read error:",e),t.status(500).json({error:e.message})}if("/swap/request"===n&&"POST"===e.method)try{const s=readJsonBody(e),{fromPerson:a,toPerson:n,shiftDate:o,shiftStart:r,shiftEnd:i,team:d,docId:c,assignmentId:l,note:u}=s;if(!a||!n||!o)return t.status(400).json({error:"Missing required fields"});const m={fromPerson:a,toPerson:n,shiftDate:o,shiftStart:r||"",shiftEnd:i||"",team:d||"",docId:c||"",assignmentId:l||"",note:u||"",status:"pending",createdAt:(new Date).toISOString()},g=await db.collection("swap_requests").add(m);return await db.collection("agent_notifications").add({recipientName:n,type:"swap_request",message:`${a} wants to swap their ${o} shift with you`,swapRequestId:g.id,fromPerson:a,shiftDate:o,shiftStart:r,shiftEnd:i,createdAt:(new Date).toISOString(),read:!1}),console.log(`üîÑ Swap request created: ${a} -> ${n} for ${o}`),t.status(200).json({ok:!0,swapId:g.id})}catch(e){return console.error("Swap request error:",e),t.status(500).json({error:e.message})}if("/swap/pending"===n&&"POST"===e.method)try{const s=readJsonBody(e),a=String(s.agentName||"").trim();if(!a)return t.status(400).json({error:"Missing agentName"});const n=await db.collection("swap_requests").where("toPerson","==",a).where("status","==","pending").get(),o=await db.collection("swap_requests").where("fromPerson","==",a).where("status","==","pending").get(),r=[];n.forEach(e=>r.push({id:e.id,...e.data()}));const i=[];return o.forEach(e=>i.push({id:e.id,...e.data()})),t.status(200).json({ok:!0,incoming:r,outgoing:i})}catch(e){return console.error("Pending swaps error:",e),t.status(500).json({error:e.message})}if("/swap/respond"===n&&"POST"===e.method)try{logWithTrace(a,"info","swap/respond","Processing swap response");const s=readJsonBody(e),{swapId:n,response:o,responderName:r}=s;if(!n||!o)return logWithTrace(a,"error","swap/respond","Missing required fields",{swapId:n,response:o}),t.status(400).json({error:"Missing swapId or response"});const i=db.collection("swap_requests").doc(n),d=await i.get();if(!d.exists)return logWithTrace(a,"error","swap/respond","Swap request not found",{swapId:n}),t.status(404).json({error:"Swap request not found"});const c=d.data();if(await i.update({status:o,respondedAt:(new Date).toISOString(),respondedBy:r||c.toPerson}),"accepted"===o&&c.docId&&c.assignmentId){const e=db.collection("scheduleDays").doc(c.docId),t=await e.get();if(t.exists){const s=t.data().assignments||[],o=s.findIndex(e=>String(e.id)===String(c.assignmentId)||String(e.assignmentId)===String(c.assignmentId));if(-1!==o){const t=[...s];t[o]={...t[o],person:c.toPerson,notes:(t[o].notes||"")+` [Swapped from ${c.fromPerson}]`,updatedAt:(new Date).toISOString()},await e.update({assignments:t,updatedAt:(new Date).toISOString()}),logWithTrace(a,"info","swap/respond","Swap executed in schedule",{swapId:n,docId:c.docId,fromPerson:c.fromPerson,toPerson:c.toPerson})}}}return await db.collection("agent_notifications").add({recipientName:c.fromPerson,type:"swap_response",message:"accepted"===o?`${c.toPerson} accepted your swap request for ${c.shiftDate}`:`${c.toPerson} declined your swap request for ${c.shiftDate}`,swapRequestId:n,decision:o,createdAt:(new Date).toISOString(),read:!1}),logWithTrace(a,"info","swap/respond","Swap response processed",{swapId:n,response:o,fromPerson:c.fromPerson,toPerson:c.toPerson}),t.status(200).json({ok:!0})}catch(e){return logWithTrace(a,"error","swap/respond","Error processing swap response",{error:e.message,stack:e.stack}),t.status(500).json({error:e.message})}if("/manager/heartbeat"===n&&"POST"===e.method)try{logWithTrace(a,"info","manager/heartbeat","Recording manager heartbeat");const s=readJsonBody(e),{managerName:n,view:o,area:r}=s;if(!n)return t.status(400).json({error:"Missing managerName"});const i=(new Date).toISOString(),d=n.replace(/\s+/g,"_").toLowerCase();return await db.collection("manager_presence").doc(d).set({managerName:n,view:o||"Unknown",area:r||"",lastHeartbeat:i,updatedAt:i},{merge:!0}),logWithTrace(a,"info","manager/heartbeat","Heartbeat recorded",{managerName:n,view:o,area:r}),t.status(200).json({ok:!0})}catch(e){return logWithTrace(a,"error","manager/heartbeat","Error recording heartbeat",{error:e.message}),t.status(500).json({error:e.message})}if("/manager/presence"===n&&"GET"===e.method)try{const e=new Date(Date.now()-12e4).toISOString(),s=await db.collection("manager_presence").where("lastHeartbeat",">=",e).get(),a=[];return s.forEach(e=>{const t=e.data();a.push({managerName:t.managerName,view:t.view,area:t.area,lastHeartbeat:t.lastHeartbeat})}),t.status(200).json({ok:!0,activeManagers:a})}catch(e){return logWithTrace(a,"error","manager/presence","Error fetching manager presence",{error:e.message}),t.status(500).json({error:e.message})}if("/schedule/check-conflict"===n&&"POST"===e.method)try{logWithTrace(a,"info","schedule/check-conflict","Checking for scheduling conflicts");const s=readJsonBody(e),{personName:n,date:o,startTime:r,endTime:i,excludeAssignmentId:d}=s;if(!(n&&o&&r&&i))return logWithTrace(a,"error","schedule/check-conflict","Missing required fields"),t.status(400).json({error:"Missing required fields"});const c=await checkDoubleBooking(db,n,o,r,i,d);return logWithTrace(a,"info","schedule/check-conflict","Conflict check completed",{personName:n,date:o,hasConflict:c.length>0,conflictCount:c.length}),t.status(200).json({ok:!0,hasConflict:c.length>0,conflicts:c})}catch(e){return logWithTrace(a,"error","schedule/check-conflict","Error checking conflicts",{error:e.message,stack:e.stack}),t.status(500).json({error:e.message})}if("/holidays/list"===n&&"GET"===e.method)try{const e=await db.collection("holidays").orderBy("date","asc").get(),s=[];return e.forEach(e=>{s.push({id:e.id,...e.data()})}),t.status(200).json({ok:!0,holidays:s})}catch(e){return t.status(500).json({error:e.message})}if("/holidays/add"===n&&"POST"===e.method)try{const s=readJsonBody(e),{date:a,name:n,theme:o,emoji:r}=s;if(!a||!n)return t.status(400).json({error:"Date and name are required"});const i=db.collection("holidays").doc(a);return(await i.get()).exists?t.status(400).json({error:"A holiday already exists on this date"}):(await i.set({date:a,name:n,theme:o||"default",emoji:r||"‚≠ê",createdAt:(new Date).toISOString()}),t.status(200).json({ok:!0,message:"Holiday added"}))}catch(e){return t.status(500).json({error:e.message})}if("/holidays/delete"===n&&"POST"===e.method)try{const s=readJsonBody(e),{date:a}=s;return a?(await db.collection("holidays").doc(a).delete(),t.status(200).json({ok:!0,message:"Holiday deleted"})):t.status(400).json({error:"Date is required"})}catch(e){return t.status(500).json({error:e.message})}if("/timeoff/list"===n&&"GET"===e.method)try{const e=await db.collection("time_off_requests").where("status","==","pending").orderBy("createdAt","desc").get(),s=[],a=new Set;e.forEach(e=>{const t=e.data();s.push({id:e.id,...t}),t.person&&a.add(t.person)});const n={};if(a.size>0){const e=Array.from(a).map(e=>db.collection("accrued_hours").doc(e));(await db.getAll(...e)).forEach(e=>{e.exists&&(n[e.id]=e.data().pto||0)})}const o=s.map(e=>({...e,currentBalance:void 0!==n[e.person]?n[e.person]:0}));return t.status(200).json({ok:!0,requests:o})}catch(e){return console.error("List Error:",e),t.status(500).json({error:e.message})}if("/timeoff/resolve"===n&&"POST"===e.method)try{logWithTrace(a,"info","timeoff/resolve","Processing time-off resolution request");const s=readJsonBody(e),{id:n,decision:o,manager:r}=s;if(!n||!o)return logWithTrace(a,"error","timeoff/resolve","Missing required fields",{id:n,decision:o}),t.status(400).json({error:"Missing fields"});const i=db.collection("time_off_requests").doc(n);await db.runTransaction(async e=>{const t=await e.get(i);if(!t.exists)throw logWithTrace(a,"error","timeoff/resolve","Request not found",{id:n}),new Error("Request not found");const s=t.data(),d="make_up"===(s.typeKey||normalizeTimeOffType(s.type||"pto")),c=s.requestedHours||s.hours||null;let l=null,u=0,m=!1,g=null,h=null;if("approved"===o&&!d&&s.person){l=db.collection("accrued_hours").doc(s.person);const t=await e.get(l);t.exists&&(u=parseFloat(t.data().pto||0),m=!0)}if("approved"===o&&s.date&&s.person&&s.team){const t=`${s.date}__${s.team}`;g=db.collection("scheduleDays").doc(t);const a=await e.get(g);a.exists&&(h=a.data())}if(e.update(i,{status:o,resolvedBy:r||"Admin",resolvedAt:(new Date).toISOString()}),m&&l){let t=0;if(null==c||Number.isNaN(c))if("full_day"===s.duration)t=8;else if(s.shiftStart&&s.shiftEnd){const e=parseTimeDecimal(s.shiftStart),a=parseTimeDecimal(s.shiftEnd);e>0&&a>0?(t=a-e,t<0&&(t+=24)):t=4}else t=4;else t=parseFloat(c);t=Math.round(100*t)/100;const n=Math.max(0,(u||0)-t);logWithTrace(a,"info","timeoff/resolve","Deducting PTO hours",{person:s.person,currentPto:u,deduction:t,nextPto:n}),e.update(l,{pto:n,lastUpdated:(new Date).toISOString()})}if("approved"===o&&g&&h){const t=h.assignments||[],n=String(s.person||"").trim().toLowerCase(),o=t.findIndex(e=>{if(String(e.person||"").trim().toLowerCase()!==n)return!1;if(s.shiftStart&&s.shiftEnd){const t=toAmPm(e.start||""),a=toAmPm(e.end||"");return t===s.shiftStart&&a===s.shiftEnd}return!0});if(-1!==o){const n=t[o];if(!n.notes||!n.notes.includes("[OFF]")){const i=d?"Make Up Approved":"PTO Approved",c=r?` by ${r}`:"",l=(n.notes?n.notes+" ":"")+`[OFF] - ${i}${c}`,u=[...t];u[o]={...n,notes:l,updatedAt:(new Date).toISOString()},e.update(g,{assignments:u,updatedAt:(new Date).toISOString()}),logWithTrace(a,"info","timeoff/resolve","Marked shift as OFF",{person:s.person,date:s.date,team:s.team})}}}});const d=(await i.get()).data(),c={recipientName:d.person,type:"timeoff_decision",decision:o,requestType:d.typeKey||"pto",requestDate:d.date,message:"approved"===o?`Your ${"make_up"===d.typeKey?"make-up":"time-off"} request for ${d.date} was approved`:`Your time-off request for ${d.date} was denied`,resolvedBy:r||"Admin",createdAt:(new Date).toISOString(),read:!1};return await db.collection("agent_notifications").add(c),logWithTrace(a,"info","timeoff/resolve","Created agent notification",{person:d.person,decision:o}),t.status(200).json({ok:!0})}catch(e){return logWithTrace(a,"error","timeoff/resolve","Error resolving time-off request",{error:e.message,stack:e.stack}),t.status(500).json({error:e.message})}if("/assignment/notify"===n&&"POST"===e.method){const s=readJsonBody(e),a=String(s.docId||"").trim(),n=String(s.assignmentId||"").trim(),o=String(s.notifyStatus||"").trim();if(!a||!n||!o)return t.status(400).json({error:"Missing docId, assignmentId, or notifyStatus"});const r=db.collection("scheduleDays").doc(a);try{const e=await db.runTransaction(async e=>{const t=await e.get(r);if(!t.exists)throw new Error(`scheduleDays doc not found: ${a}`);const s=t.data()||{},i=Array.isArray(s.assignments)?s.assignments:[],d=i.findIndex(e=>String(e.id||"").trim()===n);if(-1===d)throw new Error(`Assignment not found: ${n}`);const c=toIsoNow(),l=i.slice();return l[d]={...l[d],notifyStatus:o,updatedAt:c},e.update(r,{assignments:l,updatedAt:c}),l[d]});return t.status(200).json({ok:!0,docId:a,assignmentId:n,updated:normalizeValue(e)})}catch(e){return console.error("notify error:",e),t.status(500).json({error:e.message||"Notify update failed"})}}if("/schedule"===n&&"GET"===e.method){const s=String(e.query.teamKey||"").trim(),a=String(e.query.start||(new Date).toISOString().split("T")[0]),n=clampDays(e.query.days||14),o=await fetchSchedule(s,a,n);return t.status(200).json({ok:!0,results:o,schedule:{results:o}})}if("/assignment/notes"===n&&"POST"===e.method){const s=readJsonBody(e),a=String(s.docId||"").trim(),n=String(s.assignmentId||"").trim(),o=String(s.notes||"").trim();if(!a||!n)return t.status(400).json({error:"Missing docId or assignmentId"});const r=db.collection("scheduleDays").doc(a);try{const e=await db.runTransaction(async e=>{const t=await e.get(r);if(!t.exists)throw new Error(`scheduleDays doc not found: ${a}`);const s=t.data()||{},i=Array.isArray(s.assignments)?s.assignments:[],d=i.findIndex(e=>String(e.id||"").trim()===n);if(-1===d)throw new Error(`Assignment not found: ${n}`);const c=toIsoNow(),l=i.slice();return l[d]={...l[d],notes:o,updatedAt:c},e.update(r,{assignments:l,updatedAt:c}),l[d]});return t.status(200).json({ok:!0,docId:a,assignmentId:n,updated:normalizeValue(e)})}catch(e){return console.error("notes error:",e),t.status(500).json({error:e.message||"Notes update failed"})}}if("/assignment/update"===n&&"POST"===e.method)try{const s=readJsonBody(e),a=String(s.docId||"").trim(),n=String(s.assignmentId||"").trim();let o=s.patch&&"object"==typeof s.patch?s.patch:null;if(!o){const e=void 0!==s.newPerson?String(s.newPerson||"").trim():void 0,t=void 0!==s.notes?String(s.notes||""):void 0,a=String(s.notifyMode||"defer").trim();o={},void 0!==e&&(o.person=e),void 0!==t&&(o.notes=t),o.notifyStatus="send"===a?"Sent":"Pending"}if(o=sanitizePatch(o),!a||!n)return t.status(400).json({error:"Missing docId or assignmentId"});const r=db.collection("scheduleDays").doc(a),i=await db.runTransaction(async e=>{const t=await e.get(r);if(!t.exists)throw new Error(`Day not found: ${a}`);const s=t.data()||{},i=Array.isArray(s.assignments)?s.assignments:[],d=i.findIndex(e=>String(e.id||"").trim()===n);if(-1===d)throw new Error(`Assignment not found: ${n}`);const c=toIsoNow(),l=i.slice();return l[d]={...l[d],...o,updatedAt:c},e.update(r,{assignments:l,updatedAt:c}),l[d]});return t.status(200).json({ok:!0,docId:a,assignmentId:n,updated:normalizeValue(i)})}catch(e){return console.error("Update Error:",e),t.status(500).json({error:e.message||"Update failed"})}if("/assignment/add"===n&&"POST"===e.method){const s=readJsonBody(e),a=String(s.docId||"").trim(),n=s.assignment||{},o=String(n.id||"").trim(),r=String(n.start||"").trim(),i=String(n.end||"").trim(),d=String(n.role||"").trim(),c=String(n.person||"").trim();if(!(a&&o&&r&&i&&d))return t.status(400).json({error:"Missing docId or assignment fields (id,start,end,role)"});const l=db.collection("scheduleDays").doc(a);try{const e=await db.runTransaction(async e=>{const t=await e.get(l),s=toIsoNow();if(!t.exists)return e.set(l,{id:a,assignments:[{id:o,start:r,end:i,role:d,person:c,status:"Active",notifyStatus:"Pending",notes:"",updatedAt:s}],createdAt:s,updatedAt:s},{merge:!0}),{id:o,start:r,end:i,role:d,person:c,status:"Active",notifyStatus:"Pending",notes:"",updatedAt:s};const n=t.data()||{},u=Array.isArray(n.assignments)?n.assignments:[];if(u.some(e=>String(e.id||"").trim()===o))throw new Error(`Assignment id already exists: ${o}`);const m=u.concat([{id:o,start:r,end:i,role:d,person:c,status:"Active",notifyStatus:"Pending",notes:"",updatedAt:s}]);return e.update(l,{assignments:m,updatedAt:s}),m[m.length-1]});return t.status(200).json({ok:!0,docId:a,created:normalizeValue(e)})}catch(e){return console.error("add error:",e),t.status(500).json({error:e.message||"Add failed"})}}if("/assignment/delete"===n&&"POST"===e.method){const s=readJsonBody(e),a=String(s.docId||"").trim(),n=String(s.assignmentId||"").trim();if(!a||!n)return t.status(400).json({error:"Missing docId or assignmentId"});const o=db.collection("scheduleDays").doc(a);try{const e=await db.runTransaction(async e=>{const t=await e.get(o);if(!t.exists)throw new Error(`scheduleDays doc not found: ${a}`);const s=t.data()||{},r=Array.isArray(s.assignments)?s.assignments:[],i=r.findIndex(e=>String(e.id||"").trim()===n);if(-1===i)throw new Error(`Assignment not found: ${n}`);const d=toIsoNow(),c=r.slice(),[l]=c.splice(i,1);return e.update(o,{assignments:c,updatedAt:d}),l});return t.status(200).json({ok:!0,docId:a,assignmentId:n,removed:normalizeValue(e)})}catch(e){return console.error("delete error:",e),t.status(500).json({error:e.message||"Delete failed"})}}if("/balances/list"===n&&"GET"===e.method)try{const e=await db.collection("accrued_hours").get(),s=[];return e.forEach(e=>{const t=e.data();s.push({person:e.id,pto:t.pto||0,holiday_hours:t.holiday_hours||0,lastUpdated:t.lastUpdated})}),t.status(200).json({ok:!0,balances:s})}catch(e){return t.status(500).json({error:e.message})}if("/balances/update"===n&&"POST"===e.method)try{const s=readJsonBody(e),{person:a,type:n,hours:o}=s;if(!a||void 0===o)return t.status(400).json({error:"Missing person or hours"});const r=n||"pto";if(!["pto","holiday_hours"].includes(r))return t.status(400).json({error:"Type must be 'pto' or 'holiday_hours'"});const i=db.collection("accrued_hours").doc(a),d=await i.get(),c=d.exists?d.data():{pto:0,holiday_hours:0};return c[r]=parseFloat(o)||0,c.lastUpdated=toIsoNow(),await i.set(c,{merge:!0}),t.status(200).json({ok:!0,person:a,type:r,hours:c[r]})}catch(e){return t.status(500).json({error:e.message})}if("/holiday/accrue"===n&&"POST"===e.method)try{const s=readJsonBody(e),{person:a,date:n,hoursWorked:o}=s;if(!a||!n)return t.status(400).json({error:"Missing person or date"});const r=await db.collection("holidays").doc(n).get();if(!r.exists)return t.status(400).json({error:"This date is not a registered holiday"});const i=db.collection("accrued_hours").doc(a),d=await i.get(),c=d.exists?d.data():{pto:0},l=parseFloat(o)||8,u=.5*l;return c.pto=(c.pto||0)+u,c.lastUpdated=toIsoNow(),await i.set(c,{merge:!0}),await db.collection("holiday_accruals").add({person:a,date:n,hoursWorked:l,hoursAccrued:u,holidayName:r.data().name||"Holiday",addedToPto:!0,createdAt:toIsoNow()}),t.status(200).json({ok:!0,person:a,hoursAccrued:u,newPtoBalance:c.pto,message:`Added ${u}h to PTO for working on ${r.data().name}`})}catch(e){return t.status(500).json({error:e.message})}if("/holiday/history"===n&&"POST"===e.method)try{const s=readJsonBody(e),{person:a}=s;if(!a)return t.status(400).json({error:"Missing person"});const n=await db.collection("holiday_accruals").where("person","==",a).orderBy("createdAt","desc").limit(50).get(),o=[];return n.forEach(e=>{o.push({id:e.id,...e.data()})}),t.status(200).json({ok:!0,history:o})}catch(e){return t.status(500).json({error:e.message})}if("/admin/generate"===n&&"POST"===e.method){const s=readJsonBody(e),a=clampDays(s.days||14),n=String(s.teamKey||"ALL").trim(),o=await db.collection("base_schedule").get(),r={},i=new Set;o.forEach(e=>{const t=e.data().items||[];r[e.id.substring(0,3)]=t,t.forEach(e=>{e.team&&i.add(e.team)})});const d="ALL"!==n&&""!==n?[n]:Array.from(i),c=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],l=[],u=new Date;for(let e=0;e<a;e++){const t=new Date(u);t.setDate(u.getDate()+e);const s=t.toISOString().split("T")[0],a=c[t.getDay()],n=r[a]||[];if(0!==n.length)for(const e of d){const t=n.filter(t=>t.team===e);if(0===t.length)continue;const a=`${s}__${e}`,o=db.collection("scheduleDays").doc(a);await db.runTransaction(async n=>{const r=await n.get(o),i=toIsoNow();let d=[];r.exists&&(d=r.data().assignments||[]);let c=0;t.forEach(e=>{d.some(t=>t.person===e.person&&t.start===e.start)||(d.push({id:"gen_"+Math.random().toString(36).substr(2,9),start:e.start,end:e.end,role:e.role,person:e.person,status:"Active",notifyStatus:"Generated",notes:e.focus||"",updatedAt:i}),c++)}),c>0&&n.set(o,{id:a,date:s,team:e,assignments:d,updatedAt:i},{merge:!0})}),l.push(`Checked ${s} for ${e}`)}}return t.status(200).json({ok:!0,daysGenerated:a,details:l})}if("/admin/archive"===n&&"POST"===e.method){const s=readJsonBody(e),a=parseInt(s.daysAgo||"30",10),n=new Date;n.setDate(n.getDate()-a);const o=n.toISOString().split("T")[0],r=await db.collection("scheduleDays").where("date","<",o).get();if(r.empty)return t.status(200).json({ok:!0,archived:0,message:"No old docs found."});const i=db.batch();let d=0;return r.forEach(e=>{const t=e.data(),s=(t.typeKey||normalizeTimeOffType(t.type||""),db.collection("scheduleArchive").doc(e.id));i.set(s,{...t,archivedAt:toIsoNow()}),i.delete(e.ref),d++}),await i.commit(),t.status(200).json({ok:!0,archived:d,cutoff:o})}if("/admin/seed-base"===n&&"POST"===e.method){const s=readJsonBody(e).days||{};if(0===Object.keys(s).length)return t.status(400).json({error:"No data"});const a=db.batch();let n=0;for(const[e,t]of Object.entries(s)){const s=db.collection("base_schedule").doc(e),o=t.map(e=>({person:String(e.person||""),team:String(e.team||""),role:String(e.role||""),start:parseTime(e.start),end:parseTime(e.end),focus:String(e.focus||"")}));a.set(s,{items:o}),n++}return await a.commit(),t.status(200).json({ok:!0,daysImported:n})}if("/base-schedule"===n&&"GET"===e.method)try{const e=await db.collection("base_schedule").get(),s={};return e.forEach(e=>{s[e.id]=e.data().items||[]}),t.status(200).json(s)}catch(e){return t.status(500).json({error:e.message})}if("/update-master-schedule"===n&&"POST"===e.method){const s=readJsonBody(e),{action:a,person:n,day:o,oldStart:r,oldEnd:i,newStart:d,newEnd:c}=s;console.log(`Master Update Request: ${a} for ${n} on ${o} (${r}-${i})`);try{const s=db.collection("base_schedule").doc(o);return await db.runTransaction(async t=>{const l=await t.get(s);if(!l.exists)throw new Error(`Day '${o}' not found in base_schedule`);let u=l.data().items||[];const m=hhmm(r),g=hhmm(i),h=String(n||"").trim(),f=u.findIndex(e=>String(e.person||"").trim()===h&&hhmm(e.start)===m&&hhmm(e.end)===g);if(-1===f&&"ADD"!==a)throw new Error("Original shift not found. Please refresh.");"DELETE"===a?u.splice(f,1):"EDIT"===a?(u[f].start=hhmm(d),u[f].end=hhmm(c),e.body.newTeam&&(u[f].team=String(e.body.newTeam).trim())):"ADD"===a&&u.push({person:h,day:o,start:hhmm(d),end:hhmm(c),team:String(e.body.newTeam||"Other").trim(),role:"Agent"}),"DELETE"===a?u.splice(f,1):"EDIT"===a&&(u[f].start=hhmm(d),u[f].end=hhmm(c),e.body.newTeam&&(u[f].team=String(e.body.newTeam).trim()),e.body.newRole&&(u[f].role=String(e.body.newRole).trim())),t.update(s,{items:u})}),t.status(200).json({status:"success"})}catch(e){return console.error("Update Master Error:",e),t.status(500).json({status:"error",message:e.message})}}if("/zendesk/agent/open"===n&&"GET"===e.method)try{logWithTrace(a,"info","zendesk/agent/open","Fetching open tickets");const s=String(e.query.email||"").trim();if(!s)return logWithTrace(a,"error","zendesk/agent/open","Missing email parameter"),t.status(400).json({error:"Missing email parameter"});const n=validateDaysParam(e.query.days,7),o=sanitizeZendeskEmail(s),r=Math.max(1,parseInt(e.query.page||"1",10)),i=Math.min(100,Math.max(1,parseInt(e.query.per_page||"100",10))),d=new Date;d.setDate(d.getDate()-n);const c=d.toISOString().split("T")[0],l=`type:ticket assignee:"${o}" status<solved created>=${c}`,u=`https://${ZD_CONFIG.subdomain}.zendesk.com/api/v2/search.json?query=${encodeURIComponent(l)}&page=${r}&per_page=${i}`;logWithTrace(a,"info","zendesk/agent/open","Calling Zendesk API",{email:s,days:n,page:r,perPage:i,dateFilter:c});const m=await zdFetch(u),g=(m.results||[]).map(e=>({id:e.id,subject:e.subject,status:e.status,created_at:e.created_at,updated_at:e.updated_at})),h=m.count||0,f=`https://${ZD_CONFIG.subdomain}.zendesk.com/agent/search/1?query=${encodeURIComponent(l)}`;return logWithTrace(a,"info","zendesk/agent/open","Open tickets found",{email:s,count:h,days:n,page:r,returned:g.length}),t.status(200).json({ok:!0,count:h,tickets:g,ticketIds:g.map(e=>e.id),searchUrl:f,query:l,days:n,email:s,page:r,perPage:i,hasMore:null!==m.next_page,nextPage:m.next_page})}catch(e){return logWithTrace(a,"error","zendesk/agent/open","Error fetching open tickets",{error:e.message,status:e.status}),t.status(e.status||500).json({error:e.message||"Failed to fetch open tickets"})}if("/zendesk/agent/badcsat"===n&&"GET"===e.method)try{logWithTrace(a,"info","zendesk/agent/badcsat","Fetching bad CSAT tickets");const s=String(e.query.email||"").trim();if(!s)return logWithTrace(a,"error","zendesk/agent/badcsat","Missing email parameter"),t.status(400).json({error:"Missing email parameter"});const n=validateDaysParam(e.query.days,60),o=sanitizeZendeskEmail(s),r=Math.max(1,parseInt(e.query.page||"1",10)),i=Math.min(100,Math.max(1,parseInt(e.query.per_page||"100",10))),d=new Date;d.setDate(d.getDate()-n);const c=d.toISOString().split("T")[0],l=`type:ticket assignee:"${o}" satisfaction_rating:bad created>=${c}`,u=`https://${ZD_CONFIG.subdomain}.zendesk.com/api/v2/search.json?query=${encodeURIComponent(l)}&page=${r}&per_page=${i}`;logWithTrace(a,"info","zendesk/agent/badcsat","Calling Zendesk API",{email:s,days:n,page:r,perPage:i,dateFilter:c});const m=await zdFetch(u),g=(m.results||[]).map(e=>({id:e.id,subject:e.subject,status:e.status,created_at:e.created_at,updated_at:e.updated_at,satisfaction_rating:e.satisfaction_rating})),h=m.count||0,f=`https://${ZD_CONFIG.subdomain}.zendesk.com/agent/search/1?query=${encodeURIComponent(l)}`;return logWithTrace(a,"info","zendesk/agent/badcsat","Bad CSAT tickets found",{email:s,count:h,days:n,page:r,returned:g.length}),t.status(200).json({ok:!0,count:h,tickets:g,ticketIds:g.map(e=>e.id),searchUrl:f,query:l,days:n,email:s,page:r,perPage:i,hasMore:null!==m.next_page,nextPage:m.next_page})}catch(e){return logWithTrace(a,"error","zendesk/agent/badcsat","Error fetching bad CSAT tickets",{error:e.message,status:e.status}),t.status(e.status||500).json({error:e.message||"Failed to fetch bad CSAT tickets"})}if("/agent-profile"===n&&"POST"===e.method)try{const{name:o}=readJsonBody(e);if(!o)return t.status(400).json({error:"No name provided"});const r=o.toLowerCase().trim(),i=agentProfileCache.get(r);if(i&&Date.now()-i.timestamp<3e5)return console.log(`üì¶ Agent profile cache hit for ${o}`),t.status(200).json(i.data);const{people:d}=await getCachedMetadata();let c="";const l=o.toLowerCase().trim();for(const e of d){const t=String(e.name||e.id||"").toLowerCase().trim();if(t===l||t.split(" ")[0]===l.split(" ")[0]){c=e.email;break}}if(!c)throw new Error(`Agent ${o} not found or missing email address.`);const u=`https://${ZD_CONFIG.subdomain}.zendesk.com/api/v2/users/search.json?query=${encodeURIComponent(c)}`,m=await zdFetch(u);if(!m.users?.length)throw new Error("Email not found in Zendesk.");const g=m.users[0],h=g.id,f=new Date;f.setDate(f.getDate()-7);const p=f.toISOString().split("T")[0];Math.floor(f.getTime()/1e3);let y=0,w=0;try{const e=`assignee_id:${h} -status:solved -status:closed`,t=`assignee_id:${h} status:solved solved>=${p}`,[s,a]=await Promise.all([zdFetch(`https://${ZD_CONFIG.subdomain}.zendesk.com/api/v2/search.json?query=${encodeURIComponent(e)}`),zdFetch(`https://${ZD_CONFIG.subdomain}.zendesk.com/api/v2/search.json?query=${encodeURIComponent(t)}`)]);y=s.count||0,w=a.count||0}catch(e){console.warn("Ticket count failed:",e.message)}let S="--",I=0,T=0;try{const e=`assignee_id:${h} created>=${p}`,t=`https://${ZD_CONFIG.subdomain}.zendesk.com/api/v2/search.json?query=${encodeURIComponent(e)}&per_page=100`,s=(await zdFetch(t)).results||[];for(const e of s)if(e.satisfaction_rating&&e.satisfaction_rating.score){const t=e.satisfaction_rating.score;"good"===t?I++:"bad"===t&&T++}console.log(`CSAT for ${g.name} (ID: ${h}): Good=${I}, Bad=${T}, Total tickets searched=${s.length}`);const a=I+T;S=a>0?Math.round(I/a*100)+"%":"--"}catch(e){console.warn("CSAT lookup failed:",e.message)}const b={found:!0,id:h,zendeskUserId:h,name:g.name,email:g.email,avatar:g.photo?g.photo.content_url:null,role:g.role,lastLogin:g.last_login_at,openTickets:y,solvedWeek:w,csatScore:S,csatGood:I,csatBad:T};agentProfileCache.set(r,{data:b,timestamp:Date.now()});const D=Date.now()-s;return logWithTrace(a,"info","response",`200 ${n}`,{duration:D}),t.status(200).json(b)}catch(e){const n=Date.now()-s;return logWithTrace(a,"error","agent-profile","Profile fetch error",{error:e.message,duration:n}),t.status(500).json({error:e.message})}if("/schedule/export"===n&&"POST"===e.method)try{logWithTrace(a,"info","schedule/export","Processing CSV export request");const n=readJsonBody(e),o=n.startDate||(new Date).toISOString().split("T")[0],r=clampDays(n.days||14),i=n.teamKey||"";if(!/^\d{4}-\d{2}-\d{2}$/.test(o))return logWithTrace(a,"error","schedule/export","Invalid date format",{startDate:o}),t.status(400).json({error:"Invalid date format.  Use YYYY-MM-DD"});const d=new Date(`${o}T00:00:00Z`);if(isNaN(d.getTime()))return logWithTrace(a,"error","schedule/export","Invalid date",{startDate:o}),t.status(400).json({error:"Invalid start date"});const c=new Date(d);c.setUTCDate(c.getUTCDate()+r);const l=c.toISOString().split("T")[0];let u=db.collection("scheduleDays").where("date",">=",o).where("date","<=",l);i&&(u=u.where("team","==",i));const m=await u.get();logWithTrace(a,"info","schedule/export","Fetched schedule data",{docs:m.size,startDate:o,endStr:l,teamKey:i});const g=[];g.push(["Date","Team","Person","Role","Start Time","End Time","Status","Notes"].map(csvEscape).join(",")),m.forEach(e=>{const t=e.data();(t.assignments||[]).forEach(e=>{const s=[t.date||"",t.team||"",e.person||"Unassigned",e.role||"",toAmPm(e.start||""),toAmPm(e.end||""),e.status||"Active",e.notes||""].map(csvEscape);g.push(s.join(","))})});const h="\ufeff"+g.join("\r\n"),f=`schedule_${o}_to_${l}${i?"_"+i:""}.csv`,p=Date.now()-s;return logWithTrace(a,"info","schedule/export","CSV export completed",{duration:p,rows:g.length-1,filename:f}),t.setHeader("Content-Type","text/csv; charset=utf-8"),t.setHeader("Content-Disposition",`attachment; filename="${f}"`),t.setHeader("Cache-Control","no-cache"),t.status(200).send(h)}catch(e){const n=Date.now()-s;return logWithTrace(a,"error","schedule/export","Export error",{error:e.message,stack:e.stack,duration:n}),t.status(500).json({error:e.message||"Export failed"})}}catch(e){console.error("Unhandled error:",e),t.status(500).send("Internal Server Error")}});